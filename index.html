<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>EPhone</title>
    <!-- â–¼â–¼â–¼ ã€æ¡Œé¢åœ–ç¤ºã€‘ç´”HTMLå–®æª”æ–¹æ¡ˆï¼Œè«‹é»è²¼åˆ° <title> ä¹‹å¾Œ â–¼â–¼â–¼ -->
    <!-- 1. (æ ¸å¿ƒ) ç‚ºè˜‹æœè¨­å‚™è¨­ç½®ä¸»è¢å¹•åœ–ç¤º -->
    <!-- æµè¦½å™¨æœƒè‡ªå‹•é¸æ“‡æœ€åˆé©çš„å°ºå¯¸ -->
    <link rel="apple-touch-icon" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg">

    <link rel="manifest" href="manifest.json">
    <!-- 2. (æ ¸å¿ƒ) å‘Šè¨´è˜‹æœè¨­å‚™ï¼Œé€™æ˜¯ä¸€å€‹Webæ‡‰ç”¨ï¼Œå¯ä»¥å…¨å±é¡¯ç¤º -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- 3. (æ ¸å¿ƒ) è¨­ç½®è˜‹æœè¨­å‚™å…¨å±æ¨¡å¼ä¸‹çš„ç‹€æ…‹åˆ—æ¨£å¼ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 4. (å¯é¸) è¨­ç½®æ‡‰ç”¨åœ¨ä¸»è¢å¹•ä¸Šé¡¯ç¤ºçš„æ¨™é¡Œ -->
    <meta name="apple-mobile-web-app-title" content="EPhone">
    <!-- 5. (ç›¸å®¹) ç‚ºéƒ¨åˆ†å®‰å“æµè¦½å™¨æä¾›æ”¯æ´ -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- 6. (å‚™ç”¨) æ¨™æº–æµè¦½å™¨é ç°½åœ–ç¤º -->
    <link rel="icon" type="image/png" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg">
    <!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://unpkg.com/dexie/dist/dexie.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
     <script src="https://sssayhi07-gif.github.io/phone/pp.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js" defer></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
               /* â–¼â–¼â–¼ Safariéµç›¤é©é…ï¼šè«‹ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ç¾æœ‰çš„ html, body, å’Œ #phone-screen æ¨£å¼ â–¼â–¼â–¼ */
        
        /* --- è«‹ç”¨ä¸‹é¢é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ç¾æœ‰çš„ html, body, å’Œ #phone-screen æ¨£å¼ --- */
        
        /* 1. é‡ç½® html å…ƒç´  */
        html {
            -webkit-text-size-adjust: 100%;
            height: 100%; /* ç¢ºä¿htmlå…ƒç´ ä¹Ÿèƒ½æ’æ»¿ */
        }
        
        /* 2. è¨­ç½® body ç‚ºå…¨å±ç•«å¸ƒ */
        body {
            margin: 0;
            font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: #f0f2f5;
            height: 100%; /* è®“bodyä¹Ÿæ’æ»¿çˆ¶å…ƒç´ (html) */
            overflow: hidden; /* é˜²æ­¢bodyæœ¬èº«å‡ºç¾æ²è»¸ */
        }
        
        /* --- Start of Replacement Code --- */
        
        #phone-screen {
            width: 100%;
            /* Use 100vh to ensure it fills the entire screen height */
            height: 100vh; 
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* Your desired white background */
        }
        
        #chat-input-area {
            flex-shrink: 0;
            padding: 8px;
            /* This is the key: adds padding equal to the height of the "black bar" */
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        /* --- End of Replacement Code --- */
/* --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘é€™æ˜¯æ§åˆ¶ç‹€æ…‹åˆ—é¡¯éš±çš„æ–°æ¨£å¼ --- */

/* 1. é è¨­æƒ…æ³ä¸‹ï¼Œç‹€æ…‹åˆ—ä¾ç„¶æ˜¯éš±è—çš„ */
#status-bar {
    display: none;
    /* (åŸæœ‰çš„å…¶ä»–æ¨£å¼ï¼Œå¦‚é¡è‰²ã€å­—é«”ç­‰ï¼Œä¿æŒä¸è®Šå³å¯) */
    padding: 0 20px;
    height: 40px;
    color: white;
    background-color: transparent; /* èƒŒæ™¯ç”±çˆ¶å…ƒç´ æ§åˆ¶ */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 100;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€ */
}

/* 2. ç•¶ #phone-screen å…ƒç´ æ“æœ‰ .status-bar-visible é€™å€‹ class æ™‚ï¼Œé¡¯ç¤ºç‹€æ…‹åˆ— */
#phone-screen.status-bar-visible #status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
        
        .header, .qzone-header {
            position: relative;
            z-index: 15;
            flex-shrink: 0;
            padding: 15px 20px;
            /* æ ¸å¿ƒï¼šä½¿ç”¨ calc() è‡ªå‹•åŠ ä¸Šé ‚éƒ¨çš„å®‰å…¨è·é›¢ */
            padding-top: calc(15px + env(safe-area-inset-top)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        
        #status-bar { 
            display: none; 
        }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        
        .header .action-btn {
            font-size: 16px; /* å°ˆé–€ç‚ºâ€œä¸Šå‚³â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰éˆ•ç¸®å°å­—å‹å¤§å° */
            font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€é»è®“å®ƒæ›´æ¸…æ™° */
        }
        
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        /* â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šä»£ç¢¼ã€‘ï¼Œå®Œæ•´æ›¿æ›æ‰æ‚¨ç¾æœ‰çš„ #home-screen, #clock-container, å’Œ #app-grid æ¨£å¼ â–¼â–¼â–¼ */
        
        /* --- Start of Replacement Code --- */
        
        #home-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            padding-left: 20px;
            padding-right: 20px;
            /* We remove vertical padding here to rely on margins */
        }
        
        #clock-container {
            text-align: center;
            color: white;
            text-shadow: 0 3px 8px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            flex-shrink: 0;
            /* This is the key: pushes the clock down from the top edge */
            margin-top: calc(60px + env(safe-area-inset-top));
        }
        
        /* --- End of Replacement Code --- */
        
        /* 3. å°‡Appåœ–ç¤ºç¶²æ ¼ä½œç‚ºä¸€å€‹æ•´é«”ï¼Œç”¨ margin å¾è¢å¹•åº•éƒ¨æ¨ä¸Šä¾† */
        #app-grid {
            margin-top: auto; /* è‡ªå‹•è²¼ç·Šåº•éƒ¨ */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
            /* é—œéµï¼šä½¿ç”¨ margin-bottom æŠ¬é«˜åœ–ç¤ºï¼Œé©é…åº•éƒ¨â€œå°é»‘æ¢â€ */
            margin-bottom: calc(30px + env(safe-area-inset-bottom)); 
        }
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        #main-time {
            font-size: 88px; /* æ¨è–¦ï¼šç¨å¾®èª¿å¤§ä¸€é»é»ï¼Œæ›´æ¥è¿‘iOSé–å±çš„æ„Ÿè¦º */
            font-weight: 600; /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°‡å­—é«”å¾â€œçº–ç´°(200)â€æ”¹ç‚ºâ€œç²—é«”(600)â€ï¼Œé€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ */
            letter-spacing: -2px; /* æ¨è–¦ï¼šç¨å¾®æ”¶ç·Šå­—é–“è·ï¼Œè®“æ•¸å­—çœ‹èµ·ä¾†æ›´ç·Šæ¹Š */
            /* æ ¸å¿ƒä¿®æ”¹2ï¼šæŒ‡å®šå­—é«”ï¼Œå„ªå…ˆä½¿ç”¨è˜‹æœç³»çµ±å­—é«” */
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
        }
        #main-date { 
            font-size: 22px; /* ç¨å¾®æ”¾å¤§ä¸€é»æ›´å”èª¿ */
            font-weight: normal; /* è˜‹æœé¢¨æ ¼çš„å¸¸è¦é«”æ—¥æœŸ */
        }
        
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        /* ä¿®æ”¹å¾Œçš„ #world-book-list æ¨£å¼ */
        #world-book-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            padding-top: 80px;
            margin-top: -80px;
        }
        
        /* ä¿®æ”¹å¾Œçš„ #chat-list æ¨£å¼ï¼Œå»æ‰äº† padding å’Œ margin */
        #chat-list {
            flex-grow: 1;
            background-color: var(--secondary-bg);
            padding-top: 80px; 
            padding-bottom: 90px; /* ç‚ºåº•éƒ¨å·¡è¦½åˆ—ç•™å‡ºç©ºé–“ */
            box-sizing: border-box;
        }
        
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        
        /* â–¼â–¼â–¼ ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›æ‰ä½ åŸä¾†çš„ #chat-messages æ¨£å¼ â–¼â–¼â–¼ */
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden; /* æ ¸å¿ƒä¿®æ­£1: å¼·åˆ¶ç¦æ­¢æ°´æº–æ»¾å‹•/æ‹–å‹• */
            padding: 10px 15px; /* æ ¸å¿ƒä¿®æ­£2: å°‡å·¦å³å…§é‚Šè·å¢åŠ åˆ°15pxï¼Œæä¾›æ›´å¤šå‘¼å¸ç©ºé–“ */
            padding-top: 110px;
            margin-top: -80px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·è¨ˆç®—æ­£ç¢º */
        }
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        
        .message-wrapper.ai .sender-name {
            margin-left: 50px; /* ç¨å¾®èª¿æ•´ï¼Œèˆ‡é ­åƒå°é½Š */
            margin-bottom: 3px;
            position: absolute; /* è®“å®ƒè„«é›¢æµï¼Œé¿å…å½±éŸ¿æ°£æ³¡å°é½Š */
            top: -16px;       /* å®šä½åˆ°æ°£æ³¡ä¸Šæ–¹ */
            left: 0;
        }
        
        /* === ã€å…¨æ–°ã€‘æ¶ˆæ¯ä½ˆå±€èˆ‡æ™‚é–“æˆ³è¨˜æ¨£å¼ === */
        
        /* 1. æ¶ˆæ¯å–®å…ƒçš„ç¸½å®¹å™¨ (é‡æ§‹) */
        .message-wrapper {
            display: flex;          /* ä½¿ç”¨Flexä½ˆå±€ */
            gap: 8px;               /* æ°£æ³¡å’Œæ™‚é–“æˆ³è¨˜ä¹‹é–“çš„é–“è· */
            align-items: flex-end;  /* æ ¸å¿ƒï¼šè®“æ°£æ³¡å’Œæ™‚é–“æˆ³è¨˜åº•éƒ¨å°é½Š */
            position: relative;
            max-width: 90%;         /* å¯ä»¥ç¨å¾®æ”¾å¯¬ä¸€é»ï¼Œå› ç‚ºæ™‚é–“æˆ³è¨˜ç¾åœ¨åœ¨å¤–é¢äº† */
        }
        
        /* 2. AIæ¶ˆæ¯å–®å…ƒé å·¦ */
        .message-wrapper.ai {
            align-self: flex-start;
            flex-direction: row; /* é ­åƒã€æ°£æ³¡ã€æ™‚é–“æˆ³è¨˜ï¼Œå¾å·¦åˆ°å³æ’åˆ— */
        }
        
        /* 3. ä½¿ç”¨è€…æ¶ˆæ¯å–®å…ƒé å³ */
        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse; /* æ™‚é–“æˆ³è¨˜ã€æ°£æ³¡ã€é ­åƒï¼Œå¾å³åˆ°å·¦æ’åˆ— */
        }
        
        /* 4. æ°£æ³¡å’Œé ­åƒçš„ç›´æ¥å®¹å™¨ (ä¿æŒä¸è®Š) */
        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
            min-width: 0; /* <-- æ ¸å¿ƒä¿®å¾©ï¼šå…è¨±æ°£æ³¡å®¹å™¨è‡ªèº«æ”¶ç¸® */
        }
        
        .timestamp {
            /* ç§»é™¤èˆŠçš„ position: absolute */
            font-size: 11px;
            color: #999;
            text-shadow: 0 0 3px rgba(255,255,255,0.6);
            white-space: nowrap; /* é˜²æ­¢æ™‚é–“æ›è¡Œ */
            margin-bottom: 5px;  /* è®“å®ƒå’Œæ°£æ³¡åº•éƒ¨æœ‰è¼•å¾®çš„å°é½Šåç§»ï¼Œæ›´ç¾è§€ */
            flex-shrink: 0;      /* é˜²æ­¢è¢«å£“ç¸® */
        }
        
        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        
        
        #chat-list-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 15;
            display: flex;
            border-top: 1px solid var(--border-color);
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* æ ¸å¿ƒï¼šç‚ºåº•éƒ¨å¢åŠ å®‰å…¨è·é›¢ */
            padding-bottom: env(safe-area-inset-bottom);
        }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        /* --- è«‹ç”¨é€™å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ #chat-input æ¨£å¼ --- */
#chat-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    /* æ ¸å¿ƒä¿®æ”¹ 1: è¨­ç½®ä¸€å€‹å›ºå®šçš„é«˜åº¦ï¼Œä¾‹å¦‚ 40px */
    height: 40px; 
    /* æ ¸å¿ƒä¿®æ”¹ 2: ç§»é™¤ max-height å±¬æ€§ */
    /* max-height: 100px; */ 
    resize: none;
    /* æ ¸å¿ƒä¿®æ”¹ 3: ç•¶å…§å®¹è¶…å‡ºé«˜åº¦æ™‚ï¼Œé¡¯ç¤ºæ²è»¸ */
    overflow-y: auto; 
    box-sizing: border-box; /* æ¨è–¦æ·»åŠ ï¼Œç¢ºä¿å…§é‚Šè·è¨ˆç®—æ­£ç¢º */
}
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
        }
        #notification-bar.visible {
            /* é—œéµï¼šåœ¨Yè»¸å›åˆ°åŸä½çš„åŒæ™‚ï¼Œä¿æŒXè»¸çš„å±…ä¸­è®Šæ› */
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        /* â–¼â–¼â–¼ ã€è¡¨æƒ…å«ç¾©é¡¯ç¤ºã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‚¨ç¾æœ‰çš„ .sticker-item æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è¡¨æƒ…é …çš„ç¸½å®¹å™¨ï¼Œç¾åœ¨æ˜¯flexä½ˆå±€ */
.sticker-item {
    position: relative;
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ—åœ–ç‰‡å’Œæ–‡å­— */
    align-items: center;    /* æ°´æº–å±…ä¸­ */
    gap: 6px;               /* åœ–ç‰‡å’Œæ–‡å­—ä¹‹é–“çš„é–“è· */
    cursor: pointer;
}

/* 2. è¡¨æƒ…åœ–ç‰‡å®¹å™¨ (é€™æ˜¯æ–°å¢çš„) */
.sticker-image-container {
    width: 100%;
    aspect-ratio: 1 / 1;    /* ä¿æŒæ­£æ–¹å½¢ */
    background-color: white;
    border-radius: 10px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 3. è¡¨æƒ…å«ç¾©æ–‡æœ¬ (é€™æ˜¯æ–°å¢çš„) */
.sticker-name {
    font-size: 12px;           /* å­—é«”å¤§å° */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰² */
    width: 100%;               /* å¯¬åº¦æ’æ»¿ï¼Œç‚ºçœç•¥è™Ÿåšæº–å‚™ */
    text-align: center;        /* æ–‡å­—å±…ä¸­ */
    
    /* --- é€™å°±æ˜¯å¯¦ç¾â€œè¶…å‡ºçœç•¥è™Ÿâ€çš„æ ¸å¿ƒä»£ç¢¼ --- */
    white-space: nowrap;       /* å¼·åˆ¶ä¸æ›è¡Œ */
    overflow: hidden;          /* éš±è—è¶…å‡ºçš„éƒ¨åˆ† */
    text-overflow: ellipsis;   /* å°‡è¶…å‡ºçš„éƒ¨åˆ†é¡¯ç¤ºç‚ºçœç•¥è™Ÿ */
    /* --- æ ¸å¿ƒä»£ç¢¼çµæŸ --- */
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        /* â–¼â–¼â–¼ Safariå½ˆçª—é˜²æ”¾å¤§ä¿®æ­£ï¼šè«‹ç”¨é€™å¡Šæ–°æ¨£å¼æ›¿æ›èˆŠçš„ .custom-modal-body input æ¨£å¼ â–¼â–¼â–¼ */
        
        .custom-modal-body input {
            width: 100%;
            padding: 8px 12px; /* æ¨è–¦ï¼šç¨å¾®å¢åŠ å…§é‚Šè·ï¼Œè®“è¼¸å…¥æ¡†æ›´å¥½çœ‹ */
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px; /* æ ¸å¿ƒä¿®æ­£ï¼šå¾ 14px æé«˜åˆ° 16px é˜²æ­¢è‡ªå‹•æ”¾å¤§ */
            box-sizing: border-box;
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect {
            position: relative;
            -webkit-user-select: none; /* ç›¸å®¹ Safari */
            user-select: none;
        }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        
        .checkboxes-container {
            display: none;
            position: absolute;
            /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†ä½¿ç”¨ topï¼Œè€Œæ˜¯ç”¨ margin-top ä¾†å‰µé€ é–“è·ï¼Œæ›´ç©©å®š */
            top: 100%; 
            margin-top: 5px; /* <-- æ–°å¢ï¼šå‘ä¸‹æ¨é–‹5åœ–å…ƒçš„è·é›¢ */
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 101;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        
        .checkboxes-container label {
            display: block;
            padding: 12px 15px; /* <-- ä¿®æ”¹ï¼šå¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å…§é‚Šè·ï¼Œè®“æ¯ä¸€è¡Œæ›´é«˜æ›´å¯¬ */
            cursor: pointer;
            font-weight: normal;
            color: var(--text-primary);
            font-size: 15px; /* <-- æ–°å¢ï¼šå°‡å­—é«”å¤§å°å¾é è¨­å€¼æ”¾å¤§åˆ°15px */
        }
        
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration {
            /* --- æ ¸å¿ƒä¿®æ­£ --- */
            font-size: var(--chat-font-size, 13px);
            /* --- ä¿®æ­£çµæŸ --- */
            font-weight: 500;
            color: var(--text-secondary);
        }
        .message-bubble.user .voice-duration { color: #3e6224; }
        
        /* â–¼â–¼â–¼ ç”¨é€™å¡Šä»£ç¢¼æ›¿æ›æ‰ä½ åŸä¾†çš„ .message-bubble .content æ¨£å¼ â–¼â–¼â–¼ */
        /* é€šç”¨å…§å®¹å€æ¨£å¼ï¼Œç‚ºæ™‚é–“æˆ³è¨˜å’Œå­—é«”å¤§å°åšæº–å‚™ */
        .message-bubble .content {
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
            word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼·åˆ¶é•·å–®è©æˆ–URLæ›è¡Œï¼Œé˜²æ­¢æ’ç ´æ°£æ³¡ */
        
        }
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        /* === æ°£æ³¡ä¸»é¡Œæ¨£å¼ === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
              
        .message-bubble::after {
            content: "";
            position: absolute;
            width: 20px;  
            height: 20px; 
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 1; 
            z-index: 1;
        }
              
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        
        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
       .playlist-body {
    flex-grow: 1;
    overflow-y: auto;
    /* æ ¸å¿ƒä¿®å¾©ï¼šå°‡ padding-bottom é¡¯è‘—å¢å¤§ï¼Œç¢ºä¿æœ€å¾Œä¸€æ¢æ­Œæ›²ä¸æœƒè¢«é®æ“‹ */
    /* åŒæ™‚ä½¿ç”¨ box-sizing ç¢ºä¿å…§é‚Šè·è¨ˆç®—æ­£ç¢º */
    padding: 10px 0 80px 0;
    box-sizing: border-box;
}
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }
        
        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }
        
        /* é€™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ¨£å¼ */
        #font-preview {
            transition: font-family 0.3s ease;}
        
        /* === èŠå¤©æ¸…å–®ä»‹é¢æ–°å¢æ¨£å¼ (é€™æ˜¯æ–°æ·»åŠ çš„) === */
        #chat-list-screen {
        }
        
        .chat-list-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1; 
        }
        .chat-list-view.active {
            opacity: 1;
            visibility: visible;
            z-index: 2; 
        }
        
        #messages-view {
            overflow-y: auto; 
        }
        
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        /* === å‹•æ…‹ä»‹é¢ (QZone) æ¨£å¼ (é€™æ˜¯æ–°æ·»åŠ çš„) === */
        #qzone-screen {
            background-color: #f0f2f5;
        }
        
        .qzone-header {
            /* position: absolute;  <-- æŠŠé€™å€‹æ”¹æˆ relative */
            position: relative;
            z-index: 10; /* z-index ä¿æŒï¼Œæˆ–è€…å¯ä»¥æ›´é«˜ */
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
            padding: 15px 20px;
            padding-top: 45px;
            background-color: rgba(247, 247, 247, 0.7); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        
        .qzone-header .back-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--accent-color);
        }
        
        .qzone-header span:nth-child(2) { /* "å¥½å‹å‹•æ…‹"æ–‡å­— */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .qzone-content {
            flex-grow: 1;
            overflow-y: auto;
            /* padding-top: 80px;  <-- åˆªé™¤é€™å€‹ï¼Œå› ç‚ºheaderä¸å†æ˜¯absoluteäº† */
        }
        
        .qzone-profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        
        .qzone-banner-container {
            width: 100%;
            height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
            position: relative;
        }
        
        #qzone-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .qzone-user-info {
            position: absolute;
            bottom: -30px; /* è®“é ­åƒå’Œæ˜µç¨±å€åŸŸå‘ä¸‹åç§»ï¼Œä¸€åŠåœ¨èƒŒæ™¯æ¿å…§ï¼Œä¸€åŠåœ¨å¤– */
            left: 20px;
            display: flex;
            align-items: flex-end; /* è®“æ˜µç¨±å’Œé ­åƒåº•éƒ¨å°é½Š */
            gap: 10px;
        }
        
        .qzone-avatar-container {
            position: relative;
        }
        
        #qzone-avatar-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        
        #qzone-nickname {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            padding-bottom: 5px; /* å¾®èª¿ä½ç½® */
        }
        
        /* ç·¨è¼¯æŒ‰éˆ•çš„é€šç”¨æ¨£å¼ */
        .qzone-edit-btn {
            position: absolute;
            background-color: rgba(0,0,0,0.4);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        #change-qzone-banner-btn {
            bottom: 10px;
            right: 10px;
        }
        
        #change-qzone-avatar-btn {
            bottom: 5px;
            right: 5px;
        }
        
        #change-qzone-nickname-btn {
            font-size: 14px;
            padding: 2px 6px;
            margin-left: 5px; /* èˆ‡æ˜µç¨±çš„é–“è· */
            color: var(--text-primary);
            background-color: rgba(255,255,255,0.7);
            border-radius: 5px;
            position: relative; /* è„«é›¢flexä½ˆå±€çš„å°é½Š */
            bottom: 5px; /* å¾®èª¿å‚ç›´ä½ç½® */
        }
        
        /* === è®“ç·¨è¼¯åŠŸèƒ½æ›´â€œéš±å½¢â€ === */
        #qzone-banner-container,
        #qzone-avatar-container,
        #qzone-nickname {
            cursor: pointer; /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºç‚ºå¯é»æ“Šæ‰‹å‹¢ */
            transition: opacity 0.2s;
        }
        #qzone-banner-container:hover,
        #qzone-avatar-container:hover,
        #qzone-nickname:hover {
            opacity: 0.85; /* æ‡¸åœæ™‚ç¨å¾®è®Šæš—ï¼Œçµ¦ç”¨æˆ¶å›é¥‹ */
        }
        /* éš±è—æ‰èˆŠçš„ã€ç¨ç«‹çš„ç·¨è¼¯æŒ‰éˆ• */
        .qzone-edit-btn {
            display: none;
        }
        
        /* === æ§åˆ¶ Header å’Œ Bottom Nav çš„é¡¯éš± === */
        /* é è¨­éš±è—å‹•æ…‹ä»‹é¢çš„ Header */
        #qzone-screen .qzone-header {
            display: none;
        }
        /* ç•¶å‹•æ…‹è¦–åœ–å•Ÿå‹•æ™‚ï¼Œé¡¯ç¤ºå®ƒçš„Header */
        #qzone-screen.active .qzone-header {
            display: flex;
        }
        
        /* ç•¶é€²å…¥å‹•æ…‹è¦–åœ–æ™‚ï¼Œéš±è—ä¸»Headerå’Œåº•éƒ¨å·¡è¦½åˆ— */
        #chat-list-screen.in-qzone-view > .header,
        #chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
            display: none;
        }
        
        .chat-list-item:first-child,
        .chat-group-container:first-child {
            margin-top: 10px; 
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼æ›¿æ›çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠæ‰€æœ‰é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === å‹•æ…‹åŠŸèƒ½æ¬„æ¨£å¼ === */
        .qzone-actions-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin: 40px 15px 15px 15px; /* ä¸Šé‚Šè·æ›´å¤§ï¼Œç‚ºæµ®å‹•çš„é ­åƒç•™å‡ºç©ºé–“ */
            background-color: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .action-item {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }
        
        /* ç”¨å½å…ƒç´ å‰µå»ºåˆ†éš”ç·š */
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background-color: var(--border-color);
        }
        
        /* === å‹•æ…‹å¸–å­æ¸…å–®æ¨£å¼ === */
        #qzone-posts-list {
            padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºé‚Šè· */
            display: flex;
            flex-direction: column;
            gap: 20px; /* å¸–å­ä¹‹é–“çš„é–“è· */
        }
        
        .qzone-post-item {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .post-header .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .post-info {
            display: flex;
            flex-direction: column;
        }
        
        .post-info .post-nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        
        .post-info .post-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .post-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap; /* è®“åˆ†è¡Œç¬¦è™Ÿç”Ÿæ•ˆ */
            word-break: break-word; /* é˜²æ­¢é•·å–®è©æº¢å‡º */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æ–°æ¨£å¼é»è²¼åˆ°æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ç™¼ä½ˆå‹•æ…‹æ¨¡æ…‹æ¡†æ¨£å¼ === */
        #post-public-text {
            min-height: 80px; /* ç¢ºä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤ çš„é«˜åº¦ */
            resize: vertical;
        }
        
        .post-image-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é è¦½æ¯”ä¾‹ */
            background-color: #f0f2f5;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none; /* é»˜èªéš±è— */
            justify-content: center;
            align-items: center;
        }
        .post-image-preview-container.visible {
            display: flex; /* ä¸Šå‚³å¾Œé¡¯ç¤º */
        }
        
        #post-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        #post-remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff3b30;
            color: white;
            border: 2px solid white;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        .post-image-upload-options {
            display: flex;
            gap: 10px;
        }
        
        .post-image-upload-options button {
            flex: 1;
            margin-top: 0;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æ–°æ¨£å¼ â–¼â–¼â–¼ */
        
        /* === ç™¼ä½ˆå‹•æ…‹æ¨¡æ…‹æ¡† - æ¨¡å¼åˆ‡æ›æ¨£å¼ === */
        .post-mode-switcher {
            display: flex;
            margin-bottom: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        .mode-btn.active {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .post-mode-content {
            display: none; /* é»˜èªéƒ½éš±è— */
        }
        
        .post-mode-content.active {
            display: block; /* å•Ÿå‹•çš„æ‰é¡¯ç¤º */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼çµæŸ â–²â–²â–² */
        
        /* === ç›¸å†Šé é¢èƒŒæ™¯è‰² === */
        #album-screen {
            background-color: #f0f2f5; /* ä½¿ç”¨ä¸€å€‹æŸ”å’Œçš„æ·ºç°è‰²ï¼Œæ¯”ç´”ç™½æ›´è­·çœ¼ */
        }
        
        /* === ç›¸å†Šé é¢ç¶²æ ¼ä½ˆå±€ === */
        #album-grid-page {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œé¡¯ç¤º2å€‹ç›¸å†Š */
            gap: 15px;
        }
        
        /* === ç›¸å†Šå°ˆæ¡ˆæ¨£å¼ (ç¾åŒ–) === */
        .album-item {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px; /* çµ¦æ•´å€‹é …ç›®ä¹ŸåŠ å€‹åœ“è§’ */
        }
        
        .album-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .album-cover {
            aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ç‚ºæ­£æ–¹å½¢ */
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f0f2f5; /* å°é¢è¼‰å…¥å‰çš„å ä½é¡è‰² */
        }
        
        .album-info {
            text-align: center;
        }
        
        .album-name {
            font-weight: 500;
            margin: 0 0 4px 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* é˜²æ­¢é•·åå­—æ›è¡Œ */
        }
        
        .album-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* â–²â–²â–² æ–°çš„ CSS é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ç›¸å†Šç…§ç‰‡è©³æƒ…é  === */
        #album-photos-screen {
            background-color: #f0f2f5;
        }
        
        #photos-grid-page {
            padding: 15px;
            display: grid;
            /* æ¯è¡Œé¡¯ç¤º3å¼µç…§ç‰‡ï¼Œä¸¦ä¿æŒé–“è· */
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .photo-item {
            position: relative; /* ç‚ºäº†å®šä½åˆªé™¤æŒ‰éˆ• */
            aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ç‚ºæ­£æ–¹å½¢ */
            border-radius: 6px;
            overflow: hidden; /* é˜²æ­¢åœ–ç‰‡æº¢å‡ºåœ“è§’ */
            background-color: #e9ecef; /* åœ–ç‰‡è¼‰å…¥å‰çš„é ç•™ä½ç½®é¡è‰² */
        }
        
        .photo-item .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ä¿è­‰åœ–ç‰‡å¡«æ»¿å®¹å™¨ä¸”ä¸è®Šå½¢ */
            cursor: pointer;
        }
        
        /* åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
        .photo-item .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0; /* é»˜èªéš±è— */
            transition: opacity 0.2s ease;
        }
        
        /* æ»‘é¼ æ‡¸åœåœ¨ç…§ç‰‡ä¸Šæ™‚é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
        .photo-item:hover .photo-delete-btn {
            opacity: 1;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* === åœ–ç‰‡æª¢è¦–å™¨æ¨¡æ…‹æ¡†æ¨£å¼ === */
        #photo-viewer-modal {
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1002;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        
        .photo-viewer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        
        #photo-viewer-image {
            max-width: 90vw;  /* åœ–ç‰‡æœ€å¤§å¯¬åº¦ç‚ºè¦–å£çš„90% */
            max-height: 85vh; /* åœ–ç‰‡æœ€å¤§é«˜åº¦ç‚ºè¦–å£çš„85% */
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            /* ç‚ºåœ–ç‰‡çš„åˆ‡æ›æ·»åŠ ä¸€é»å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
            transition: opacity 0.2s ease-in-out;
        }
        
        /* é—œé–‰æŒ‰éˆ• */
        #photo-viewer-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 200;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px black;
        }
        
        /* å·¦å³å°èˆªç®­é ­ */
        #photo-viewer-modal .nav-arrow {
            position: absolute; /* ç¾åœ¨æˆ‘å€‘ç”¨çµ•å°å®šä½ä¾†æ§åˆ¶ç®­é ­ */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 50px; /* åœ¨æ‰‹æ©Ÿè¢å¹•ä¸Šï¼Œå¯ä»¥ç¨å¾®å°ä¸€é» */
            font-weight: 100;
            cursor: pointer;
            padding: 10px; /* èª¿æ•´å…§é‚Šè· */
        -webkit-user-select: none; /* ç›¸å®¹ Safari */
            user-select: none;
            transition: color 0.2s;
            z-index: 1003; /* ç¢ºä¿ç®­é ­åœ¨æœ€ä¸Šå±¤ */
        }
        
        #photo-viewer-prev-btn {
            left: 5px; /* å®šä½å·¦ç®­é ­ */
        }
        
        #photo-viewer-next-btn {
            right: 5px; /* å®šä½å³ç®­é ­ */
        }
        
        #photo-viewer-modal .nav-arrow:hover {
            color: white;
        }
        
        /* ç•¶ç®­é ­è¢«ç¦ç”¨æ™‚ï¼ˆæ¯”å¦‚ç¬¬ä¸€å¼µæˆ–æœ€å¾Œä¸€å¼µï¼‰ */
        #photo-viewer-modal .nav-arrow:disabled {
            color: rgba(255, 255, 255, 0.2);
            cursor: default;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ è«‹ç”¨é€™å¡Šæ–°CSSæ›¿æ›æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’å€CSS â–¼â–¼â–¼ */
        
        /* === å¸–å­å…§å®¹å€ - ç›¸å°å®šä½å®¹å™¨ === */
        /* === å¸–å­å…§å®¹å€ === */
        .post-main-content {
            /* å®ƒç¾åœ¨åªæ˜¯ä¸€å€‹æ™®é€šçš„å…§å®¹å®¹å™¨ï¼Œä¸å†éœ€è¦ç‰¹æ®Šæ¨£å¼äº† */
        }
        
        /* === å¸–å­äº’å‹•åœ–ç¤ºå€ (æ–°æ¨£å¼) === */
        .post-feedback-icons {
            display: flex;
            justify-content: flex-end; /* è®“åœ–ç¤ºé å³å°é½Š */
            align-items: center;
            gap: 12px;
            padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šçµ¦åœ–ç¤ºå€åŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
        }
        
        .action-icon {
            cursor: pointer;
            color: var(--text-secondary); /* é»˜èªç°è‰² */
            transition: all 0.2s ease-in-out;
        }
        
        .action-icon svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* åœ–ç¤ºå•Ÿå‹•(é»è´Š/æ”¶è—å¾Œ)çš„æ¨£å¼ */
        .action-icon.active {
            color: #ff5252; /* å•Ÿå‹•å¾Œè®Šç´…è‰² */
            transform: scale(1.1); /* è¼•å¾®æ”¾å¤§ */
        }
        
        .action-icon.active.favorite {
            color: #ffc107; /* æ”¶è—ç”¨é»ƒè‰² */
        }
        
        .action-icon.active svg {
            fill: currentColor; /* å•Ÿå‹•å¾Œå¡«å……é¡è‰² */
        }
        
        /* é»æ“Šæ™‚çš„å‹•ç•«æ•ˆæœ */
        .animate-like {
            animation: like-bounce 0.4s ease-in-out;
        }
        
        @keyframes like-bounce {
            0%   { transform: scale(1); }
            25%  { transform: scale(0.8); }
            50%  { transform: scale(1.2); }
            75%  { transform: scale(1.05); }
            100% { transform: scale(1.1); }
        }
        
        
        /* === å¸–å­åº•éƒ¨è©•è«–å€æ¨£å¼ (ç¾åœ¨æ˜¯ç¨ç«‹éƒ¨åˆ†) === */
        .post-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0; /* ç”¨ä¸€æ¢æ·ºè‰²ç·šåˆ†éš” */
            display: flex;
            align-items: center;
            gap: 8px; /* èª¿æ•´æ•´é«”é–“è· */
        }
        
        /* è©•è«–å€å®¹å™¨ */
        .comment-section {
            flex-grow: 1; /* ä½”æ“šå¤§éƒ¨åˆ†ç©ºé–“ */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .comment-section .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        /* â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°æ¨£å¼ â–¼â–¼â–¼ */
        .comment-section {
            position: relative; /* æ ¸å¿ƒä¿®æ­£ï¼šç‚ºå½ˆçª—å»ºç«‹å®šä½çš„éŒ¨é» */
        }
        /* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ Safarié˜²æ”¾å¤§ä¿®æ­£ï¼šè«‹ç”¨ä¸‹é¢é€™å…©å¡Šæ–°æ¨£å¼ï¼Œæ›¿æ›èˆŠçš„ .comment-input å’Œ .comment-send-btn æ¨£å¼ â–¼â–¼â–¼ */
        
        .comment-section .comment-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background-color: #f0f2f5;
            border-radius: 14px;
            font-size: 16px; /* æ ¸å¿ƒä¿®æ­£ï¼šå¾ 13px æé«˜åˆ° 16px é˜²æ­¢è‡ªå‹•æ”¾å¤§ */
            outline: none;
        }
        
        /* (æ¨è–¦) åŒæ™‚èª¿æ•´ç™¼é€æŒ‰éˆ•ï¼Œä¿æŒè¦–è¦ºçµ±ä¸€ */
        .comment-send-btn {
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
            padding: 8px 15px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 14px;
            font-size: 16px; /* å¾ 13px èª¿æ•´ç‚º 16px */
            font-weight: 500;
            cursor: pointer;
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === æœªè®€æ¶ˆæ¯å°ç´…é»é€šç”¨æ¨£å¼ === */
        .unread-indicator {
            position: absolute;
            top: -8px;      
            right: -15px;    
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background-color: #ff3b30;
            color: white;
            font-size: 11px;
            font-weight: bold;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: none;
            z-index: 1;
        }
        
        /* èŠå¤©ä»‹é¢è¿”å›æŒ‰éˆ•ä¸Šçš„å°ç´…é» (åªé¡¯ç¤ºé»ï¼Œä¸é¡¯ç¤ºæ•¸ä½) */
        .back-btn-indicator {
            top: 0;
            right: -8px; /* æ”¾åˆ°è¿”å›ç®­é ­å³ä¸Šè§’ */
            width: 10px;
            height: 10px;
            min-width: 10px;
            padding: 0;
            border-radius: 50%;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === è©•è«–åˆ—è¡¨å®¹å™¨ === */
        .post-comments-container {
            padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ */
            display: flex;
            flex-direction: column;
            gap: 8px; /* è©•è«–ä¹‹é–“çš„é–“è· */
            font-size: 13px; /* çµ±ä¸€è©•è«–å€å­—é«”å¤§å° */
        }
        
        /* æ¯ä¸€æ¢è©•è«– */
        .comment-item {
            line-height: 1.5;
        }
        
        /* è©•è«–è€…çš„åå­—ï¼ŒåŠ ç²—ä¸¦ä½¿ç”¨ä¸»é¡Œè‰² */
        .comment-item .commenter-name {
            font-weight: 600;
            color: var(--accent-color);
            cursor: pointer;
            margin-right: 5px; /* å’Œè©•è«–å…§å®¹ä¹‹é–“ç•™é»ç©ºéš™ */
        }
        
        /* è©•è«–å…§å®¹ */
        .comment-item .comment-text {
            color: var(--text-primary);
            word-break: break-word;
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === å¸–å­é»è´Šå€åŸŸæ¨£å¼ === */
        .post-likes-section {
            display: flex;
            align-items: center;
            gap: 6px; /* åœ–ç¤ºå’Œæ–‡å­—çš„é–“è· */
            padding: 8px 10px; /* å…§é‚Šè· */
            font-size: 13px;
            color: var(--accent-color); /* ä½¿ç”¨ä¸»é¡Œè—è‰² */
            background-color: #f0f5fa; /* çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
            border-top: 1px solid #e9eef3;
            border-bottom: 1px solid #e9eef3;
            margin-top: 5px; /* å’Œä¸Šæ–¹çš„åœ–ç¤ºä¿æŒä¸€é»è·é›¢ */
        }
        
        .post-likes-section .like-icon {
            width: 16px;
            height: 16px;
            fill: currentColor; /* è®“SVGåœ–ç¤ºç¹¼æ‰¿çˆ¶å…ƒç´ çš„é¡è‰² */
            flex-shrink: 0; /* é˜²æ­¢åœ–ç¤ºè¢«å£“ç¸® */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === @æåŠ å½ˆå‡ºåŠŸèƒ½è¡¨æ¨£å¼ === */
        .at-mention-popup {
            position: absolute; /* ç›¸å°äºçˆ¶å…ƒç´ å®šä½ */
            bottom: 100%; /* é¡¯ç¤ºåœ¨è¼¸å…¥æ¡†çš„ä¸Šæ–¹ */
            left: 40px; /* å’Œè¼¸å…¥æ¡†å·¦å´å°é½Š (è€ƒæ…®äº†é ­åƒå¯¬åº¦) */
            width: calc(100% - 40px); /* å¯¬åº¦å’Œè¼¸å…¥æ¡†å·®ä¸å¤š */
            max-height: 120px;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 10;
            display: none; /* é»˜èªéš±è— */
        }
        
        .at-mention-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid #f0f0f0;
        }
        
        .at-mention-item:last-child {
            border-bottom: none;
        }
        
        .at-mention-item:hover {
            background-color: #f5f5f5;
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™æ®µã€æ–°æ¨£å¼ã€‘æ›¿æ›æ‰ä½ ç¾æœ‰çš„ #favorites-list æ¨£å¼ â–¼â–¼â–¼ */
        
        /* è®“æ”¶è—è¦–åœ–æˆç‚ºä¸€å€‹flexå®¹å™¨, å¾ä¸Šåˆ°ä¸‹æ’åˆ— */
        #favorites-view {
            display: flex;
            flex-direction: column;
        }
        
        /* ç¢ºä¿æ”¶è—é çš„headeré«˜åº¦å›ºå®šï¼Œä¸è¢«å£“ç¸® */
        #favorites-view > .header {
            flex-shrink: 0;
        }
        
        /* === æ”¶è—æ¸…å–®æ¨£å¼ (ä¿®æ­£å¾Œ) === */
        #favorites-list {
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; /* <-- æ–°å¢é€™è¡Œï¼Œç¦æ­¢æ°´æº–æ»¾å‹• */
            padding: 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        .favorite-item-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            position: relative; /* ç‚ºäº†å®šä½åˆªé™¤æŒ‰éˆ• */
        }
        
        /* å¡ç‰‡é ­éƒ¨ï¼ŒåŒ…å«é ­åƒã€åå­—å’Œä¾†æº */
        .fav-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .fav-card-header .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .fav-card-header .info {
            flex-grow: 1;
        }
        
        .fav-card-header .name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .fav-card-header .source {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* å¡ç‰‡å…§å®¹ */
        .fav-card-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .fav-card-content .chat-image {
            margin-top: 8px; /* åœ–ç‰‡å’Œæ–‡å­—çš„é–“è· */
        }
        
        /* åˆªé™¤æŒ‰éˆ• */
        .fav-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #f0f2f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 28px;
            text-align: center;
        }
        
        .fav-delete-btn:hover {
            background-color: #e9ecef;
            color: #ff3b30;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === æœç´¢æ¬„æ¨£å¼ === */
        .search-bar-container {
            padding: 10px 15px;
            background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
            position: relative; /* ç‚ºäº†å®šä½æ¸…é™¤æŒ‰éˆ• */
            flex-shrink: 0;
        }
        
        #favorites-search-input {
            width: 100%;
            padding: 10px 30px 10px 15px; /* å³å´ç•™å‡ºæ¸…é™¤æŒ‰éˆ•çš„ä½ç½® */
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 18px; /* åœ“è§’çŸ©å½¢ï¼Œæ›´ç¾ä»£åŒ– */
            background-color: var(--secondary-bg);
            box-sizing: border-box;
            outline: none;
        }
        #favorites-search-input:focus {
            border-color: var(--accent-color);
        }
        
        .search-clear-btn {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* === èŠå¤©ä»‹é¢å¤šé¸æ“ä½œæ¬„å„ªåŒ– === */
        #chat-interface-screen .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        #chat-interface-screen .selection-controls .action-btn {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
        }
        
        /* === æ”¶è—é é¢å¤šé¸æ¨¡å¼æ¨£å¼ === */
        #favorites-view.selection-mode .favorite-item-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* é¸æ“‡æ¡†çš„æ¨£å¼ */
        .favorite-item-card::before {
            content: '';
            position: absolute;
            left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦é‚Šå¤–é¢ */
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: white;
            transition: all 0.2s ease;
            opacity: 0; /* é»˜èªéš±è— */
        }
        
        /* é€²å…¥é¸æ“‡æ¨¡å¼æ™‚ï¼Œå¡ç‰‡å‘å³ç§»å‹•ï¼Œéœ²å‡ºé¸æ“‡æ¡† */
        #favorites-view.selection-mode .favorite-item-card {
            transform: translateX(35px);
        }
        #favorites-view.selection-mode .favorite-item-card::before {
            opacity: 1;
        }
        
        /* é¸ä¸­å¾Œçš„æ¨£å¼ */
        #favorites-view.selection-mode .favorite-item-card.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: 'âœ”';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        
        /* åº•éƒ¨æ“ä½œæ¬„ (çµ‚æ¥µä¿®æ­£ç‰ˆ) */
        #favorites-action-bar {
            position: absolute; /* â˜… æ”¹ç‚º absoluteï¼Œç›¸å°æ–¼ #phone-screen å®šä½ */
            bottom: 0;
            left: 0;
            right: 0;           /* â˜… æ–°å¢ right: 0ï¼Œå’Œ left: 0 ä¸€èµ·æ’æ»¿å¯¬åº¦ */
            width: auto;        /* â˜… æ”¹ç‚º autoï¼Œè®“ left/right æ±ºå®šå¯¬åº¦ */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é©é…iPhoneåº•éƒ¨å®‰å…¨å€ */
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none;
            /* max-width å·²ç¶“ä¸éœ€è¦äº†ï¼Œå› ç‚ºçˆ¶å…ƒç´ å·²ç¶“é™åˆ¶äº†å¯¬åº¦ */
        }
        
        #favorites-action-bar .action-bar-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        
        /* === ã€ä¿®æ­£ã€‘èŠå¤©ä»‹é¢é ­éƒ¨æ§åˆ¶é …åˆ‡æ›é‚è¼¯ === */
        
        /* é è¨­ç‹€æ…‹ï¼šéš±è—å¤šé¸æ§åˆ¶é … */
        #chat-interface-screen .header .selection-controls {
            display: none;
        }
        
        /* é è¨­ç‹€æ…‹ï¼šé¡¯ç¤ºé è¨­æ§åˆ¶é …ï¼Œä¸¦è®“å®ƒæ’æ»¿æ•´å€‹é ­éƒ¨ */
        #chat-interface-screen .header .default-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        /* ç•¶é€²å…¥å¤šé¸æ¨¡å¼æ™‚ï¼šéš±è—é è¨­æ§åˆ¶é … */
        #chat-interface-screen.selection-mode .header .default-controls {
            display: none;
        }
        
        /* ç•¶é€²å…¥å¤šé¸æ¨¡å¼æ™‚ï¼šé¡¯ç¤ºå¤šé¸æ§åˆ¶é …ï¼Œä¸¦è®“å®ƒæ’æ»¿æ•´å€‹é ­éƒ¨ */
        #chat-interface-screen.selection-mode .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ä¿®æ­£ï¼šæ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€è™ŸæŒ‰éˆ• === */
        #add-chat-btn,
        #add-world-book-btn,
        #create-album-btn-page {
            font-size: 28px;   /* é¡¯è‘—å¢å¤§å­—é«”å¤§å°ï¼Œä½¿å…¶è¦–è¦ºä¸Šèˆ‡æ—é‚Šçš„åœ–ç¤ºåŒ¹é… */
            font-weight: 300;  /* ä½¿ç”¨æ›´ç´°çš„å­—é‡ï¼Œè®“åŠ è™Ÿçœ‹èµ·ä¾†æ›´æ¸…çˆ½ï¼Œä¸é¡¯ç²—ç¬¨ */
            position: relative;/* å…è¨±é€²è¡Œä½ç½®å¾®èª¿ */
            top: -1px;         /* å­—é«”æ”¾å¤§å¾Œï¼Œé€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»å‹•ä¸€é»ï¼Œä½¿å…¶è¦–è¦ºä¸Šæ›´å±…ä¸­ */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™äº›æ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* é è¦½å€å®¹å™¨æ¨£å¼ */
        #settings-preview-area {
            width: 100%;
            height: 180px; /* çµ¦ä¸€å€‹å›ºå®šçš„é«˜åº¦ */
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
            display: flex;
            flex-direction: column;
            gap: 10px; /* é è¦½æ°£æ³¡ä¹‹é–“çš„é–“è· */
            border: 1px solid var(--border-color);
            position: relative; /* ç‚ºäº†å®šä½èƒŒæ™¯ */
        }
        
        /* é è¦½å€çš„èƒŒæ™¯ï¼Œå¯ä»¥å’ŒçœŸå¯¦èŠå¤©ä»‹é¢åŒæ­¥ */
        #settings-preview-area::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            opacity: 0.8;
        }
        
        /* è®“é è¦½æ°£æ³¡åœ¨èƒŒæ™¯ä¹‹ä¸Š */
        #settings-preview-area .message-wrapper {
            position: relative;
            z-index: 2;
        }
        
        /* é è¦½å€å…§ä½¿ç”¨çš„é ­åƒè¦å°ä¸€é» */
        #settings-preview-area .message-bubble .avatar {
            width: 30px;
            height: 30px;
        }
        
        #settings-preview-area .message-bubble .timestamp {
            display: none; /* é è¦½å€ä¸éœ€è¦é¡¯ç¤ºæ™‚é–“æˆ³è¨˜ */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        .existing-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .existing-group-item .group-name {
            font-weight: 500;
        }
        
        .existing-group-item .delete-group-btn {
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        .chat-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        
        .chat-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        
        .chat-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        
        .chat-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        
        .chat-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .chat-group-content {
            max-height: 1000px; /* ä¸€å€‹è¶³å¤ å¤§çš„å€¼ */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .chat-group-content.collapsed {
            max-height: 0;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* æ ¼å¼åŠ©æ‰‹æŒ‰éˆ•çš„å®¹å™¨ */
        .format-helpers {
            display: flex;
            gap: 10px;
            margin-bottom: 15px; /* èˆ‡ä¸‹æ–¹çš„æ–‡å­—æ–¹å¡Šæ‹‰é–‹è·é›¢ */
            flex-wrap: wrap; /* å¦‚æœæŒ‰éˆ•å¤ªå¤šå¯ä»¥æ›è¡Œ */
        }
        
        /* å–®å€‹æ ¼å¼åŠ©æ‰‹æŒ‰éˆ•çš„æ¨£å¼ */
        .format-btn {
            background-color: #e9ecef;
            color: var(--text-primary);
            border: none;
            padding: 6px 12px;
            border-radius: 16px; /* è† å›Šå½¢ç‹€ï¼Œæ›´å‹å¥½ */
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .format-btn:hover {
            background-color: #dcdfe3;
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* â€œâ€¦â€æŒ‰éˆ•çš„æ¨£å¼ */
        .post-actions-btn {
            margin-left: auto; /* é—œéµï¼šè®“å®ƒè‡ªå‹•é åˆ°æœ€å³é‚Š */
            padding: 5px 10px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            line-height: 1;
        }
        .post-actions-btn:hover {
            background-color: #f0f0f0;
        }
        
        /* å‹•æ…‹ç·¨è¼¯æ¨¡æ…‹æ¡†çš„æ¨£å¼ (å®ƒå°‡è¤‡ç”¨ç¾æœ‰çš„æ“ä½œåŠŸèƒ½è¡¨æ¨£å¼) */
        #post-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            border-bottom: 1px solid #dbdbdb;
            padding: 14px;
            font-size: 18px;
        }
        #post-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }
        #post-actions-modal #cancel-post-action-btn {
            margin-top: 8px;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* çµ±ä¸€é‡ç½®è½‰å¸³å¡ç‰‡å…§æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¡è‰² */
        #chat-messages .transfer-card .transfer-title,
        #chat-messages .transfer-card .transfer-amount,
        #chat-messages .transfer-card .transfer-note {
            text-shadow: none !important; /* å¼·åˆ¶ç§»é™¤ä»»ä½•ç™¼å…‰æˆ–é™°å½±æ•ˆæœ */
            color: white !important;      /* å¼·åˆ¶é–å®šæ–‡å­—é¡è‰²ç‚ºç™½è‰² */
        }
        
        /* åˆ†åˆ¥é–å®šå„è‡ªçš„å­—é«”å¤§å°å’Œå­—é‡ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ */
        #chat-messages .transfer-card .transfer-title {
            font-size: 16px !important;
            font-weight: 600 !important;
        }
        
        #chat-messages .transfer-card .transfer-amount {
            font-size: 28px !important;
            font-weight: bold !important;
        }
        
        #chat-messages .transfer-card .transfer-note {
            font-size: 13px !important;
            opacity: 0.9 !important;
        }
        
        /* â–¼â–¼â–¼ é€™æ˜¯æ–°å¢çš„æ¨£å¼ï¼Œç”¨æ–¼ä¿®æ­£æ‰€æœ‰é ­éƒ¨æ¨™é¡Œçš„å±…ä¸­å•é¡Œ â–¼â–¼â–¼ */
        .header > span:nth-child(2),
        #chat-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¤ä¸Šï¼Œå†å‘å·¦æ¨2åœ–å…ƒ */
            
            /* (å¯é¸ä½†æ¨è–¦) é˜²æ­¢é•·æ¨™é¡Œèˆ‡å…©é‚ŠæŒ‰éˆ•é‡ç–Š */
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–è¦ºåŒ–æ¶ˆæ¯ç·¨è¼¯å™¨æ¨£å¼ â–¼â–¼â–¼ */
        #message-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        
        .message-editor-block textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .message-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; /* è¦†è“‹é»˜èªçš„ margin-bottom */
        }
        
        .message-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€£çµ¡äººé¸æ“‡å™¨æ¨£å¼ â–¼â–¼â–¼ */
        .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: 'âœ”';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .contact-picker-item .name {
            font-weight: 500;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå“¡ç®¡ç†ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
        #member-management-list {
            padding: 0; /* ç§»é™¤é»˜èªpaddingï¼Œè®“åˆ—è¡¨é …æ’æ»¿ */
        }
        
        .member-management-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .member-management-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .member-management-item .name {
            flex-grow: 1;
            font-weight: 500;
        }
        
        .member-management-item .remove-member-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        #member-management-actions {
            flex-shrink: 0;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #member-management-actions button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        #member-management-actions #create-new-member-btn {
            background-color: #4cd964; /* æ–°å»ºç”¨ç¶ è‰²ï¼Œä»¥ç¤ºå€åˆ† */
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£ä»£ä»˜å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
        
        
        .waimai-card {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .waimai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .waimai-header .icon {
            width: 20px;
            height: 20px;
        }
        
        .waimai-header .title-group {
            display: flex;
            align-items: baseline;
            font-size: 14px;
            color: #8a8a8a;
        }
        .waimai-header .title-group .brand {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }
        .waimai-header .title-group .separator {
            margin: 0 5px;
        }
        
        .waimai-catchphrase {
            font-size: 13px;
            color: #1f1f1f;
            padding: 12px;
        }
        
        .waimai-main {
            background-color: #FFD66B; /* æ©™é»ƒè‰²èƒŒæ™¯ */
            padding: 12px;
            text-align: center;
        }
        
        .waimai-main .request-title {
            font-size: 12px;
            color: #856404;
            margin-bottom: 8px;
        }
        
        .waimai-main .payment-box {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px 10px;
        }
        
        .waimai-main .payment-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        
        .waimai-main .amount {
            font-size: 32px;
            font-weight: 700;
            color: #1f1f1f;
            margin: 4px 0 12px 0;
        }
        
        .waimai-main .countdown-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        .waimai-main .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }
        .waimai-main .countdown-timer span {
            background-color: #333;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .waimai-details-btn {
            width: 100%;
            padding: 10px 0;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            background-color: #FFC33A;
            color: #49380a;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£å›æ‡‰ç‹€æ…‹æ¨£å¼ â–¼â–¼â–¼ */
        
        /* === åŒæ„æ”¯ä»˜å¾Œçš„æ¨£å¼ === */
        .message-bubble.status-paid .waimai-card {
            border: 2px solid #28a745; /* ç¶ è‰²é‚Šæ¡† */
        }
        .message-bubble.status-paid .waimai-main .request-title::before {
            content: 'âœ…  ';
        }
        .message-bubble.status-paid .waimai-main .request-title {
            color: #155724;
            font-weight: 600;
            /* é‡å¯« request-title çš„å…§å®¹ */
            content: "æˆ‘å·²ç‚ºæ‚¨è²·å–®ï¼Œè«‹ç›¡æƒ…äº«ç”¨å§ï½" !important;
            display: block;
            margin-bottom: 15px;
        }
        
        .message-bubble.status-paid .payment-box {
            display: none; /* éš±è—æ”¯ä»˜è©³æƒ… */
        }
        .message-bubble.status-paid .waimai-details-btn {
            background-color: #28a745;
            color: white;
        }
        
        /* === æ‹’çµ•æ”¯ä»˜å¾Œçš„æ¨£å¼ === */
        .message-bubble.status-rejected .waimai-card {
            border: 2px solid #dc3545; /* ç´…è‰²é‚Šæ¡† */
            opacity: 0.8;
        }
        .message-bubble.status-rejected .waimai-main {
            background-color: #e9ecef;
        }
        .message-bubble.status-rejected .waimai-main .request-title::before {
            content: 'âŒ ';
        }
        .message-bubble.status-rejected .waimai-main .request-title {
            color: #721c24;
            font-weight: 600;
            /* é‡å¯« request-title çš„å…§å®¹ */
            content: "æˆ‘æ‹’çµ•äº†æ‚¨çš„ä»£ä»˜è«‹æ±‚" !important;
            display: block;
            margin-bottom: 15px;
        }
        .message-bubble.status-rejected .payment-box {
            display: none; /* éš±è—æ”¯ä»˜è©³æƒ… */
        }
         .message-bubble.status-rejected .waimai-details-btn {
            background-color: #6c757d;
            color: white;
        }
        
        /* å¼·åˆ¶é‡å¯« request-title å…§å®¹çš„æŠ€å·§ */
        .message-bubble[class*="status-"] .request-title {
            font-size: 0; /* éš±è—åŸå§‹æ–‡æœ¬ */
        }
        .message-bubble[class*="status-"] .request-title::after {
            font-size: 14px; /* è®“å½å…ƒç´ é¡¯ç¤ºæ–°æ–‡æœ¬ */
        }
        .message-bubble.status-paid .request-title::after {
            content: "æˆ‘å·²ç‚ºæ‚¨è²·å–®ï¼Œè«‹ç›¡æƒ…äº«ç”¨å§ï½";
        }
        .message-bubble.status-rejected .request-title::after {
            content: "æˆ‘æ‹’çµ•äº†æ‚¨çš„ä»£ä»˜è«‹æ±‚";
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚çš„ä½¿ç”¨è€…æ“ä½œæŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
        .waimai-user-actions {
            display: flex;
            gap: 10px;
            padding: 0 12px 12px 12px; /* åœ¨å¡ç‰‡åº•éƒ¨ç•™å‡ºç©ºé–“ */
            background-color: #fff;
        }
        
        .waimai-user-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .waimai-pay-btn {
            background-color: #28a745;
            border-color: #1f7a33;
            color: white;
        }
        .waimai-pay-btn:hover {
            background-color: #218838;
        }
        
        .waimai-decline-btn {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #495057;
        }
        .waimai-decline-btn:hover {
            background-color: #e2e6ea;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* === ã€æ–°å¢ã€‘çµ±ä¸€è¨­ç½®é é¢çš„èƒŒæ™¯è‰² (å·²ä¿®æ­£) === */
        #api-settings-screen,
        #font-settings-screen,
        #wallpaper-screen,
        #memories-view,
        #contact-picker-screen,
        #member-management-screen,
        #world-book-editor-screen {  
            background-color: var(--secondary-bg);
        }
        
        /* ç¢ºä¿é€™äº›é é¢çš„å…§å®¹å€èƒ½æ­£ç¢ºæ»¾å‹• */
        #api-settings-screen .form-container,
        #font-settings-screen .form-container,
        #wallpaper-screen .form-container {
            padding-top: 100px;
            margin-top: -80px;
            background-color: var(--secondary-bg);
        }
        
        /* å£ç´™è¨­ç½®é é¢çš„é è¦½å€æ¯”è¼ƒç‰¹æ®Šï¼Œéœ€è¦é¡å¤–èª¿æ•´ */
        #wallpaper-screen .form-container {
            align-items: center; /* ä¿æŒå…§å®¹å±…ä¸­ */
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¾†é›»è«‹æ±‚èˆ‡è¦–é »é€šè©±ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
        
        /* --- ä¾†é›»è«‹æ±‚æ¨¡æ…‹æ¡† --- */
        #incoming-call-modal .incoming-call-content {
            background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 280px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.5);
        }
        
        .caller-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .caller-text {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }
        
        .incoming-call-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        
        .call-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .call-action-btn:active {
            transform: scale(0.9);
        }
        
        .call-action-btn.decline {
            background-color: #ff3b30;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }
        
        .call-action-btn.accept {
            background-color: #4cd964;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
        }
        
        /* --- è¦–é »é€šè©±ä»‹é¢ --- */
        /* â–¼â–¼â–¼ è«‹ç”¨é€™ä¸€æ•´å¡Šã€æœ€çµ‚ä¿®æ­£ç‰ˆã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰€æœ‰èˆŠçš„ video-call ç›¸é—œCSS â–¼â–¼â–¼ */
        
        /* 1. é€šè©±è¢å¹•ç¸½å®¹å™¨ (ä¿æŒä¸è®Š) */
        #video-call-screen {
            background-color: #1c1c1e;
            color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 2. é ‚éƒ¨æ¬„å’Œåº•éƒ¨æ§åˆ¶æ¬„ (ä¿æŒä¸è®Š) */
        .video-call-top-bar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            padding-top: 50px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
            z-index: 10;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }
        #call-timer {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 1px;
        }
        .video-call-controls {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            padding-bottom: 40px;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            z-index: 10;
            box-sizing: border-box;
        }
        
        /* 3. åƒèˆ‡è€…é ­åƒé¡¯ç¤ºå€ (ä¿æŒä¸è®Š) */
        .video-call-avatar-area {
            flex-grow: 1; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            padding-top: 80px; /* ç¢ºä¿é ‚éƒ¨æœ‰è¶³å¤ ç©ºé–“ */
            box-sizing: border-box;
            overflow-y: auto; /* â˜… æ–°å¢ï¼šå¦‚æœé ­åƒå¤ªå¤šï¼Œå…è¨±æ­¤å€åŸŸæ»¾å‹• */
        }
        
        /* 4. é ­åƒç¶²æ ¼å®¹å™¨ (ä¿æŒä¸è®Š) */
        #participant-avatars-grid {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            align-items: center;
            gap: 15px; /* â˜… ç¨å¾®æ¸›å°é ­åƒé–“è· */
            max-width: 100%;
        }
        
        /* 5. å–®å€‹åƒèˆ‡è€…çš„é ­åƒå®¹å™¨ (é ­åƒç¸®å°) */
        .participant-avatar-wrapper {
            position: relative;
            text-align: center;
            flex-shrink: 0;
        }
        .participant-avatar {
            width: 70px;   /* â˜… å¾ 80px ç¸®å°åˆ° 70px */
            height: 70px;  /* â˜… å¾ 80px ç¸®å°åˆ° 70px */
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .participant-name {
            margin-top: 8px;
            font-size: 12px;
            color: #ccc;
        }
        
        /* 6. ç™¼è¨€è€…é ­åƒé«˜äº®æ•ˆæœ (ä¿æŒä¸è®Š) */
        .participant-avatar.speaking {
            border-color: #4cd964;
            box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
            transform: scale(1.05);
        }
        
        /* 7. ã€æœ€çµ‚ç‰ˆã€‘å°è©±æ–¹å¡Šå€åŸŸ */
        #video-call-main {
            flex-shrink: 0; 
            height: 30%;   /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šé«˜åº¦å¾35%æ¸›å°åˆ°30% */
            margin: 15px 15px 130px 15px; /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåº•éƒ¨é‚Šè·å¾120pxå¢åŠ åˆ°130pxï¼Œå‰µé€ æ˜é¡¯ç©ºéš™ */
            overflow-y: auto;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-sizing: border-box;
        }
        
        /* 8. æ§åˆ¶æŒ‰éˆ•æ¨£å¼ (ä¿æŒä¸è®Š) */
        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        .control-btn:active {
            transform: scale(0.9);
        }
        .control-btn.speak-btn {
            background-color: rgba(255,255,255,0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
        }
        .control-btn.hangup-btn {
            background-color: #ff3b30;
            background-size: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }
        .control-btn.join-btn {
            background-color: #007bff;
            background-size: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
        }
        
        /* â–²â–²â–² æ–°CSSæ›¿æ›çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±å°è©±æ°£æ³¡æ¨£å¼ â–¼â–¼â–¼ */
        .call-message-bubble {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.6;
            word-break: break-word;
            white-space: pre-wrap;
        }
        
        .call-message-bubble.ai-speech {
            background-color: rgba(255, 255, 255, 0.15);
            align-self: flex-start; /* AIç™¼è¨€é å·¦ */
        }
        
        .call-message-bubble.user-speech {
            background-color: #4cd964; /* ç”¨æˆ¶ç™¼è¨€ç”¨ç¶ è‰²ï¼Œé¡ä¼¼å¾®ä¿¡ */
            align-self: flex-end;   /* ç”¨æˆ¶ç™¼è¨€é å³ */
            text-align: left; /* ç¢ºä¿ä½¿ç”¨è€…æ°£æ³¡å…§çš„æ–‡å­—æ˜¯å·¦å°é½Šçš„ */
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ä»‹é¢æ¨£å¼ â–¼â–¼â–¼ */
        #outgoing-call-screen {
            background-color: #1c1c1e;
            color: white;
            justify-content: center; /* å‚ç›´å±…ä¸­ */
            align-items: center;   /* æ°´æº–å±…ä¸­ */
        }
        
        .outgoing-call-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .outgoing-call-actions {
            margin-top: 50px; /* å’Œä¸Šæ–¹æ–‡å­—æ‹‰é–‹è·é›¢ */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        /* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */
        
        /* 1. å‹•æ…‹å¸–å­çš„å¤–å±¤å®¹å™¨ï¼Œæˆ‘å€‘éœ€è¦å®ƒä¾†å®šä½å’Œè£å‰ª */
        .qzone-post-container {
            position: relative; /* è®“å…§éƒ¨çš„åˆªé™¤æŒ‰éˆ•å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
            overflow: hidden;   /* éš±è—æ‰è¶…å‡ºéƒ¨åˆ†çš„åˆªé™¤æŒ‰éˆ• */
            border-radius: 12px;/* å’Œå…§éƒ¨å¡ç‰‡ä¿æŒä¸€è‡´çš„åœ“è§’ */
        }
        
        /* 2. å¯æ»‘å‹•çš„å…§å®¹å¡ç‰‡ï¼Œå¢åŠ ä¸€å€‹å¹³æ»‘çš„éæ¸¡æ•ˆæœ */
        .qzone-post-item {
            transition: transform 0.3s ease;
            background-color: var(--secondary-bg); /* ç¢ºä¿å®ƒæœ‰èƒŒæ™¯è‰²ï¼Œèƒ½è“‹ä½ä¸‹é¢çš„åˆªé™¤æŒ‰éˆ• */
            position: relative; /* ç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ */
            z-index: 2;
        }
        
        /* 3. ã€æ ¸å¿ƒã€‘é€™å°±æ˜¯é‚£å€‹â€œåˆªé™¤â€æŒ‰éˆ•çš„æ¨£å¼ï¼*/
        .qzone-post-delete-action {
            position: absolute; /* çµ•å°å®šä½ï¼Œè„«é›¢æ–‡æª”æµ */
            top: 0;
            right: 0;
            bottom: 0;
            width: 90px; /* åˆªé™¤æŒ‰éˆ•çš„å¯¬åº¦ */
            background-color: #ff3b30; /* æ‚¨æƒ³è¦çš„ç´…è‰²èƒŒæ™¯ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            z-index: 1; /* ç¢ºä¿å®ƒåœ¨å¡ç‰‡ä¸‹é¢ */
        }
        
        /* 4. ç•¶å¡ç‰‡å·¦æ»‘æ™‚ï¼ŒæŠŠå®ƒå‘å·¦ç§»å‹•ï¼Œéœ²å‡ºåˆªé™¤æŒ‰éˆ• */
        .qzone-post-item.swiped {
            transform: translateX(-90px); /* ç§»å‹•çš„è·é›¢å’Œåˆªé™¤æŒ‰éˆ•çš„å¯¬åº¦ä¸€è‡´ */
        }
        
        /* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šã€‘å…¨æ–°çš„â€œæ‹ä¸€æ‹â€æ¨£å¼ï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* 1. â€œæ‹ä¸€æ‹â€çš„è¢å¹•éœ‡å‹•å‹•ç•« */
        @keyframes pat-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        .pat-animation {
            animation: pat-shake 0.4s ease-in-out;
        }
        
        /* 2. â€œæ‹ä¸€æ‹â€ç³»çµ±æç¤ºæ¶ˆæ¯çš„æ¨£å¼ */
        .system-message {
            align-self: center; /* å±…ä¸­é¡¯ç¤º */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* è®“â€œæ‹ä¸€æ‹â€é¡å‹çš„ wrapper å±…ä¸­ */
        .message-wrapper.system-pat {
            justify-content: center;
            align-self: center;
            margin: 5px 0;
            max-width: 80%;
        }
        /* â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯æ°£æ³¡çš„æ¨£å¼ */
        .message-bubble.system-bubble {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 10px;
        }
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°CSSé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ä¿®æ­£ï¼šè®“é ‚éƒ¨æ“ä½œæ¬„å¯ä»¥æ©«å‘æ»¾å‹• === */
        #chat-input-actions-top {
            display: flex;
            gap: 8px;
            padding: 0 5px;
        
            /* --- æ ¸å¿ƒä»£ç¢¼é–‹å§‹ --- */
            overflow-x: auto;      
            flex-wrap: nowrap;     
            -webkit-overflow-scrolling: touch; 
        
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        
        #chat-input-actions-top::-webkit-scrollbar {
            display: none; 
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* === ã€å…¨æ–°ã€‘èŠå¤©ä»‹é¢é ­éƒ¨ç‹€æ…‹åˆ—æ¨£å¼ === */
        
        /* 1. æ¨™é¡Œå’Œç‹€æ…‹çš„ç¸½å®¹å™¨ï¼Œä½¿ç”¨flexä½ˆå±€è®“å®ƒå€‘å‚ç›´æ’åˆ— */
        #chat-header-title-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /* æ°´æº–å±…ä¸­ */
            gap: 2px; /* æ¨™é¡Œå’Œç‹€æ…‹ä¹‹é–“çš„å¾®å°é–“è· */
            
            /* ç‚ºäº†è®“å®ƒèƒ½åœ¨flexä½ˆå±€ä¸­æ­£ç¢ºå±…ä¸­ */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            max-width: 60%;
        }
        
        /* 2. ä¸»æ¨™é¡Œçš„æ¨£å¼å¾®èª¿ */
        #chat-header-title {
            font-size: 16px; /* å¯ä»¥ç¨å¾®ç¸®å°ä¸€é»ï¼Œçµ¦ç‹€æ…‹åˆ—ç•™å‡ºç©ºé–“ */
            font-weight: 600;
            position: static; /* è¦†è“‹æ‰èˆŠçš„absoluteå®šä½ */
            transform: none;  /* è¦†è“‹æ‰èˆŠçš„transform */
            /* ä¿è­‰é•·æ¨™é¡Œä¹Ÿèƒ½æ­£ç¢ºé¡¯ç¤ºçœç•¥è™Ÿ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* 3. ç‹€æ…‹åˆ—å®¹å™¨ */
        #chat-header-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        /* 4. ç‹€æ…‹å°åœ“é» */
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #4cd964; /* é»˜èªç¶ è‰²ï¼Œä»£è¡¨ç·šä¸Š */
            transition: background-color 0.3s ease;
        }
        
        /* ç•¶AIç‹€æ…‹ç‚ºâ€œå¿™ç¢Œâ€æˆ–â€œé›¢é–‹â€æ™‚ï¼Œè®“åœ“é»è®Šç°è‰² */
        #chat-header-status.busy .status-dot {
            background-color: #cccccc;
        }
        
        /* 5. ç‹€æ…‹æ–‡æœ¬ */
        .status-text {
            font-weight: 500;
        }
        
        /* === ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘å›æ†¶å¡ç‰‡æ¨£å¼ === */
        
        /* 1. å¡ç‰‡ç¸½å®¹å™¨ï¼šé€™è£¡è² è²¬å®šç¾©æ•´é«”çš„èƒŒæ™¯è‰²å’Œé‚Šæ¡† */
        .memory-card {
            background-color: #fffaf0; /* çµ±ä¸€çš„ã€æº«æš–çš„ç±³é»ƒè‰²èƒŒæ™¯ */
            border-radius: 12px;
            padding: 15px; /* åœ¨å¡ç‰‡å››å‘¨ç•™å‡ºå…§é‚Šè· */
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            border-left: 5px solid #ffb74d; 
            display: flex; /* è®“å®ƒæˆç‚ºflexå®¹å™¨ï¼Œæ–¹ä¾¿å…§éƒ¨å…ƒç´ æ’åˆ— */
            flex-direction: column; /* è®“é ­éƒ¨å’Œå…§å®¹å‚ç›´å †ç–Š */
            gap: 8px; /* åœ¨é ­éƒ¨å’Œå…§å®¹ä¹‹é–“å‰µé€ ä¸€å€‹è‡ªç„¶çš„é–“è· */
        }
        
        /* 2. é ­éƒ¨å®¹å™¨ï¼šç¾åœ¨åªè² è²¬ä½ˆå±€å’Œåˆ†å‰²ç·š */
        .memory-card .header {
            border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* åˆ†å‰²ç·šé¡è‰²å¯ä»¥ç¨å¾®åŠ æ·±ä¸€é» */
            padding-bottom: 8px; 
        }
        
        /* 3. æ—¥æœŸæ¨£å¼ (ä¿æŒä¸è®Š) */
        .memory-card .header .date {
            font-size: 11px;
            color: #a1887f;
            margin-bottom: 4px; 
        }
        
        /* 4. ä½œè€…æ¨£å¼ (ä¿æŒä¸è®Š) */
        .memory-card .header .author {
            font-weight: 600;
            color: #d98100;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 5. å…§å®¹å€æ¨£å¼ (ä¿æŒä¸è®Š) */
        .memory-card .content {
            font-size: 14px;
            line-height: 1.7;
            color: #5d4037;
            white-space: pre-wrap;
        }
        
        /* === ã€å…¨æ–°ã€‘ç´„å®š/å€’è¨ˆæ™‚å¡ç‰‡æ¨£å¼ === */
        .countdown-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        .countdown-card::before {
            content: 'âœ¨';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 50px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        .countdown-card .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .countdown-card .timer {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        .countdown-card .target-date {
            font-size: 12px;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
        }
        
        /* === ã€å…¨æ–°ã€‘èŠå¤©é–å®šé®ç½©å±¤æ¨£å¼ === */
        #chat-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 150; /* æ¯”è¼¸å…¥æ¡†é«˜ï¼Œæ¯”è²¼ç´™é¢æ¿ä½ */
            display: none; /* é»˜èªéš±è— */
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        #chat-lock-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #chat-lock-content .lock-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        #chat-lock-content .lock-action-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
        }
        #chat-lock-content .lock-action-btn.secondary {
            background-color: transparent;
            color: var(--accent-color);
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
        
        
        .red-packet-card {
            width: 220px;
            border-radius: 8px;
            background: linear-gradient(160deg, #F96259, #E44D44);
            color: #ffd700; /* é‡‘è‰²æ–‡å­— */
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .red-packet-card.opened {
            background: linear-gradient(160deg, #d3c4a0, #c4b693);
            cursor: default;
        }
        
        .red-packet-card::before {
            content: 'ğŸ§§';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(-10deg);
        }
        
        .rp-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .rp-icon {
            width: 20px;
            height: 20px;
        }
        
        .rp-greeting {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rp-type {
            font-size: 11px;
            color: white;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .rp-claimed-info {
            font-size: 13px;
            color: white;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…è©³æƒ…æ¸…å–®æ¨£å¼ â–¼â–¼â–¼ */
        .rp-details-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .rp-details-item:last-child {
            border-bottom: none;
        }
        .rp-details-item .name {
            flex-grow: 1;
            font-weight: 500;
            color: #333;
        }
        .rp-details-item .amount {
            font-weight: 500;
            color: #555;
        }
        .rp-details-item .lucky-king-tag {
            font-size: 10px;
            background-color: #ffd700;
            color: #a67c00;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* æŠ•ç¥¨å¡ç‰‡åœ¨æ¶ˆæ¯æ°£æ³¡ä¸­çš„æ¨£å¼ */
        
        /* æŠ•ç¥¨å¡ç‰‡ä¸»é«” */
        .poll-card {
            width: 250px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .poll-card.closed {
            background-color: #e9ecef; /* çµæŸå¾Œè®Šç° */
        }
        
        /* æŠ•ç¥¨å•é¡Œ */
        .poll-question {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* æŠ•ç¥¨é¸é …æ¸…å–® */
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* å–®å€‹æŠ•ç¥¨é¸é … */
        .poll-option-item {
            background-color: white;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s;
        }
        
        .poll-card:not(.closed) .poll-option-item:hover {
            background-color: #f0f8ff;
        }
        
        /* ä½¿ç”¨è€…å·²æŠ•ç¥¨çš„é¸é …æ¨£å¼ */
        .poll-option-item.voted {
            border-color: var(--accent-color);
            background-color: #e7f3ff;
            font-weight: 500;
        }
        
        /* æŠ•ç¥¨é€²åº¦æ¢ */
        .poll-option-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: rgba(0, 123, 255, 0.1);
            z-index: 1;
            transition: width 0.3s ease-in-out;
        }
        
        /* é¸é …å…§å®¹ï¼ˆæ–‡å­—å’Œç¥¨æ•¸ï¼‰ï¼Œç¢ºä¿åœ¨é€²åº¦æ¢ä¹‹ä¸Š */
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option-text {
            font-size: 14px;
        }
        
        .poll-option-votes {
            font-size: 13px;
            color: #8a8a8a;
            font-weight: 500;
        }
        
        /* æŠ•ç¥¨å¡ç‰‡åº•éƒ¨ */
        .poll-footer {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .poll-total-votes {
            font-weight: 500;
        }
        
        .poll-action-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        .poll-card.closed .poll-action-btn {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        
        /* å‰µå»ºæŠ•ç¥¨æ¨¡æ…‹æ¡†çš„é¸é …è¼¸å…¥ */
        .poll-option-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .poll-option-input-wrapper input {
            flex-grow: 1;
        }
        .poll-option-input-wrapper .remove-option-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #ff3b30;
            border: none;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* === ã€å…¨æ–°ã€‘èŠå¤©é ­éƒ¨â€œæ­£åœ¨è¼¸å…¥â€ç‹€æ…‹æ¨£å¼ === */
        #chat-header-title.typing-status {
            color: var(--text-secondary);
            animation: typing-pulse 1.5s infinite;
            font-style: italic;
        }
        
        @keyframes typing-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        #chat-header-title {
            transition: opacity 0.2s ease-in-out;
        }
        
        @keyframes message-pop-in {
          from {
            opacity: 0;
            transform: translateY(15px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .message-wrapper.animate-in {
          animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
          }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Appåœ–ç¤ºè¨­ç½®æ¨£å¼ â–¼â–¼â–¼ */
#icon-settings-grid,
#cphone-icon-settings-grid { /* <--- æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ç‚ºå…©å€‹å®¹å™¨åŒæ™‚æ‡‰ç”¨æ¨£å¼ */
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}
        
        .icon-setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .change-icon-btn {
            padding: 4px 10px;
            font-size: 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§€è¨­ç½®é é¢é…ç½®ä¿®æ­£ â–¼â–¼â–¼ */
        
        /* 1. ä¿®æ­£æ»¾å‹•å•é¡Œ */
        #wallpaper-screen .form-container {
            /* æ ¸å¿ƒä¿®æ­£1: è§£æ±ºflexä½ˆå±€ä¸‹çš„æ»¾å‹•è¡çªï¼Œè®“æ²è»¸èƒ½æ­£å¸¸å‡ºç¾ */
            min-height: 0; 
        }
        
        /* 2. ä¿®æ­£å£ç´™é è¦½è¢«å£“æ‰çš„å•é¡Œ */
        #wallpaper-preview {
            /* æ ¸å¿ƒä¿®æ­£2: é˜²æ­¢é è¦½æ¡†è¢«éå¤šçš„å…§å®¹æ“ å£“è®Šå½¢ï¼Œè®“å®ƒä¿æŒè‡ªå·±çš„é«˜åº¦ */
            flex-shrink: 0; 
        }
        /* â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é€£çµåŠŸèƒ½æ¨£å¼ (ç„¡åœ–ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. æµè¦½å™¨ä»‹é¢èƒŒæ™¯è‰²å’Œå…§å®¹å€æ¨£å¼ (ä¿æŒä¸è®Š) */
        #browser-screen {
            background-color: #f8f9fa;
        }
        #browser-content {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        #browser-content .article-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        #browser-content .article-meta {
            font-size: 13px;
            color: #8a8a8a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        #browser-content .article-body {
            white-space: pre-wrap;
            word-break: break-word;
        }
        #browser-content .article-body p {
            margin-bottom: 1em;
        }
        
        /* 2. èŠå¤©æ°£æ³¡ä¸­çš„é€£çµå¡ç‰‡æ¨£å¼ (ç„¡åœ–ç‰ˆ) */
        
        
        .link-share-card {
            width: 210px; 
            background-color: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .link-share-card:hover {
            background-color: #f9f9f9;
        }
        
        .link-share-card .title {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
            color: #1f1f1f;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-share-card .description {
            font-size: 13px;
            color: #8a8a8a;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-share-card .footer {
            display: flex; /* è®“åœ–ç¤ºå’Œæ–‡å­—æ°´æº–å°é½Š */
            align-items: center;
            gap: 6px; /* åœ–ç¤ºå’Œæ–‡å­—çš„é–“è· */
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px; /* å’Œä¸Šé¢çš„æè¿°æ‹‰é–‹ä¸€é»è·é›¢ */
        }
        .link-share-card .footer-icon{
            width: 14px;
            height: 14px;
            flex-shrink: 0; /* é˜²æ­¢åœ–ç¤ºè¢«å£“ç¸® */
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* å–®æ¢è©•è«–çš„å®¹å™¨ï¼Œç¾åœ¨éœ€è¦ç›¸å°å®šä½ */
        .comment-item {
            position: relative;
            padding-right: 25px; /* åœ¨å³å´ç•™å‡ºåˆªé™¤æŒ‰éˆ•çš„ç©ºé–“ */
        }
        
        /* è©•è«–åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
        .comment-delete-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0; /* é»˜èªéš±è— */
        }
        
        /* æ»‘é¼ æ‡¸åœåœ¨è©•è«–ä¸Šæ™‚ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
        .comment-item:hover .comment-delete-btn {
            opacity: 1;
        }
        
        .comment-delete-btn:hover {
            background-color: #f0f0f0;
            color: #ff3b30;
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘å¤œé–“æ¨¡å¼æ¨£å¼ === */
        
        /* æ ¸å¿ƒï¼šç•¶ #phone-screen æ“æœ‰ .dark-mode é¡æ™‚ï¼Œå•Ÿå‹•ä»¥ä¸‹æ‰€æœ‰æ¨£å¼ */
        
        /* 1. å…¨åŸŸèƒŒæ™¯å’Œæ–‡æœ¬é¡è‰² */
        #phone-screen.dark-mode {
            --secondary-bg: #1c1c1e; /* ä¸»è¦å¡ç‰‡èƒŒæ™¯è‰² */
            --border-color: #38383a;  /* é‚Šæ¡†é¡è‰² */
            --text-primary: #ffffff;   /* ä¸»è¦æ–‡å­—é¡è‰² */
            --text-secondary: #8d8d92; /* æ¬¡è¦æ–‡å­—/åœ–ç¤ºé¡è‰² */
        }
        
        /* 2. å„å€‹é é¢çš„ä¸»èƒŒæ™¯è‰² */
        #phone-screen.dark-mode #chat-list-screen,
        #phone-screen.dark-mode #qzone-screen .qzone-content,
        #phone-screen.dark-mode #memories-view {
            background-color: #000000;
        }
        
        /* 3. èŠå¤©åˆ—è¡¨ */
        #phone-screen.dark-mode #chat-list {
            background-color: #000000;
        }
        #phone-screen.dark-mode .chat-list-item {
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .chat-group-header {
            background-color: #1c1c1e; /* å¾ç™½è‰²æ”¹ç‚ºæ·±ç°è‰² */
            border-bottom: 1px solid #38383a; /* çµ¦å®ƒä¸€å€‹ç´°å¾®çš„ä¸‹é‚Šæ¡† */
        }
        #phone-screen.dark-mode .chat-list-item .name,
        #phone-screen.dark-mode .chat-group-header .group-name {
            color: #ffffff;
        }
        #phone-screen.dark-mode .chat-list-item:hover {
            background-color: #1c1c1e;
        }
        
        /* 4. é ‚éƒ¨/åº•éƒ¨å·¡è¦½åˆ— */
        #phone-screen.dark-mode .header,
        #phone-screen.dark-mode .qzone-header {
            background-color: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }
        #phone-screen.dark-mode .header .back-btn,
        #phone-screen.dark-mode .header .action-btn,
        #phone-screen.dark-mode .header .save-btn {
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-list-bottom-nav {
            background-color: rgba(25, 25, 25, 0.9);
            border-top-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .nav-item.active {
            color: #ffffff;
        }
        
        /* 5. èŠå¤©ä»‹é¢ */
        #phone-screen.dark-mode #chat-input-area {
            background-color: rgba(5, 5, 5, 0.8);
            border-top: none;
        }
        #phone-screen.dark-mode #chat-input {
            background-color: #3e3e42;
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .chat-action-icon-btn {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
        }
        #phone-screen.dark-mode #send-btn {
            background-color: var(--accent-color);
        }
        
        /* 6. å‹•æ…‹ (QZone) ä»‹é¢ */
        #phone-screen.dark-mode .qzone-actions-bar,
        #phone-screen.dark-mode .qzone-post-item {
            background-color: #1c1c1e;
            border: 1px solid #333;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }
        #phone-screen.dark-mode .action-item:not(:last-child)::after {
            background-color: #333;
        }
        #phone-screen.dark-mode .post-footer,
        #phone-screen.dark-mode .post-likes-section {
            border-top-color: #333;
        }
        #phone-screen.dark-mode .post-likes-section {
            background-color: rgba(0, 123, 255, 0.1);
        }
        #phone-screen.dark-mode .comment-input {
            background-color: #333;
            color: #ffffff;
        }
        #phone-screen.dark-mode .comment-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .post-actions-btn:hover {
            background-color: #333;
        }
        #phone-screen.dark-mode .at-mention-popup {
            background-color: #1c1c1e;
            border-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item {
            border-bottom-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item:hover {
            background-color: #333;
        }
        
        /* 7. å›æ†¶éŒ„ä»‹é¢ */
        #phone-screen.dark-mode .memory-card {
            background-color: #1c1c1e;
            border-left-color: #e6a753;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
        }
        #phone-screen.dark-mode .memory-card .header {
            background-color: #2c2c2e;
            border-bottom-color: #38383a;
            margin: -15px -15px 8px -15px;
            padding: 12px 15px;
            border-radius: 12px 12px 0 0;
        }
        #phone-screen.dark-mode .memory-card .header .date,
        #phone-screen.dark-mode .memory-card .header .author,
        #phone-screen.dark-mode .memory-card .content {
            color: #e0e0e0;
        }
        
        /* 8. å…¶ä»–è¨­ç½®å’Œåˆ—è¡¨é  */
        #phone-screen.dark-mode #api-settings-screen,
        #phone-screen.dark-mode #font-settings-screen,
        #phone-screen.dark-mode #wallpaper-screen,
        #phone-screen.dark-mode #contact-picker-screen,
        #phone-screen.dark-mode #member-management-screen,
        #phone-screen.dark-mode #world-book-editor-screen,
        #phone-screen.dark-mode #world-book-list,
        #phone-screen.dark-mode .list-item:hover,
        #phone-screen.dark-mode .list-container,
        #phone-screen.dark-mode .form-container {
            background-color: #000000;
        }
        #phone-screen.dark-mode .form-group input, 
        #phone-screen.dark-mode .form-group select, 
        #phone-screen.dark-mode .form-group textarea {
            background-color: #1c1c1e;
            color: #ffffff;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .form-button-secondary {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        
        /* â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šã€å…¨æ–°çš„ä¿®æ­£CSSã€‘ï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘å¤œé–“æ¨¡å¼è¦–è¦ºä¿®æ­£ === */
        
        /* 1. ä¿®æ­£å‹•æ…‹å¡ç‰‡å…§çš„æ–‡å­—é¡è‰² */
        #phone-screen.dark-mode .qzone-post-item .post-nickname,
        #phone-screen.dark-mode .qzone-post-item .post-content {
            color: #f0f0f0; /* å¾æ·±ç°è‰²æ”¹ç‚ºæ˜äº®çš„æ·ºç°è‰² */
        }
        
        /* 2. ä¿®æ­£æ”¶è—å¡ç‰‡å…§çš„æ–‡å­—é¡è‰² */
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
        #phone-screen.dark-mode .favorite-item-card .fav-card-content {
            color: #f0f0f0; /* åŒæ¨£æ”¹ç‚ºæ·ºç°è‰² */
        }
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
            color: #8d8d92; /* ä¾†æºæ–‡å­—ç”¨æ¬¡è¦ç°è‰² */
        }
        
        /* 3. ä¿®æ­£æ”¶è—é çš„æœç´¢æ¬„èƒŒæ™¯å’Œè¼¸å…¥æ¡†æ¨£å¼ */
        #phone-screen.dark-mode .search-bar-container {
            background-color: #000000; /* å®¹å™¨èƒŒæ™¯è®Šç‚ºç´”é»‘ */
        }
        #phone-screen.dark-mode #favorites-search-input {
            background-color: #1c1c1e; /* è¼¸å…¥æ¡†èƒŒæ™¯è®Šç‚ºæ·±ç° */
            border-color: #38383a;     /* é‚Šæ¡†é¡è‰²è®Šæš— */
            color: #ffffff;            /* è¼¸å…¥æ–‡å­—è®Šç‚ºç™½è‰² */
        }
        #phone-screen.dark-mode #favorites-search-input::placeholder {
            color: #8d8d92; /* é ç•™ä½ç½®æ–‡å­—é¡è‰²è®Šæš— */
        }
        
        /* â–²â–²â–² ä¿®æ­£CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠé€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œé»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘iOSé¢¨æ ¼çš„Toggle Switché–‹é—œæ¨£å¼ === */
        
        /* 1. é–‹é—œçš„å®¹å™¨ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        
        /* 2. éš±è—æ‰åŸå§‹çš„ checkbox è¼¸å…¥æ¡† */
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        /* 3. é–‹é—œçš„èƒŒæ™¯ï¼ˆé‚£å€‹æ©¢åœ“ï¼‰ */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9eb; /* é—œé–‰æ™‚çš„èƒŒæ™¯è‰² */
            transition: .4s;
            border-radius: 34px;
        }
        
        /* 4. é–‹é—œä¸Šçš„åœ“é» */
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* 5. ã€æ ¸å¿ƒã€‘ç•¶ checkbox è¢«é¸ä¸­æ™‚ï¼ˆå³é–‹å•Ÿç‹€æ…‹ï¼‰ */
        input:checked + .slider {
            background-color: #34c759; /* é–‹å•Ÿæ™‚çš„èƒŒæ™¯è‰²ï¼ˆiOSç¶ è‰²ï¼‰*/
        }
        
        input:checked + .slider:before {
            transform: translateX(20px); /* è®“åœ“é»æ»‘å‹•åˆ°å³é‚Š */
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¾©åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¾©åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* 1. è¼¸å…¥æ¡†ä¸Šæ–¹çš„â€œå›å¾©é è¦½æ¬„â€ */
        #reply-preview-bar {
            display: none; /* é»˜èªéš±è— */
            padding: 8px 12px;
            margin: 0 8px 8px 8px; /* å’Œè¼¸å…¥æ¡†å‘¨åœçš„é‚Šè·ä¿æŒä¸€è‡´ */
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--accent-color);
            border-radius: 6px;
            position: relative;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        #phone-screen.dark-mode #reply-preview-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .reply-preview-content .sender {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .reply-preview-content .text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* ç¢ºä¿çœç•¥è™Ÿç”Ÿæ•ˆ */
            max-width: 95%;
        }
        
        #cancel-reply-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 2. æ¶ˆæ¯æ°£æ³¡å…§éƒ¨çš„â€œå¼•ç”¨æ¶ˆæ¯å¡Šâ€ */
        .quoted-message {
            padding: 6px 10px;
            margin-bottom: 6px;
            background-color: rgba(0, 0, 0, 0.04);
            border-left: 2px solid var(--accent-color);
            border-radius: 4px;
            font-size: 0.9em; /* å­—é«”æ¯”æ­£æ–‡å°ä¸€é» */
            opacity: 0.8;
        }
        
        #phone-screen.dark-mode .quoted-message {
            background-color: rgba(255, 255, 255, 0.08);
            border-left-color: #a0cff1;
        }
        
        .quoted-message .quoted-sender {
            font-weight: 600;
            color: var(--accent-color);
        }
        #phone-screen.dark-mode .quoted-message .quoted-sender {
            color: #a0cff1;
        }
        
        .quoted-message .quoted-content {
            color: var(--text-secondary);
            white-space: normal;     /* æ ¸å¿ƒä¿®æ­£1: å…è¨±æ–‡æœ¬æ­£å¸¸æ›è¡Œ */
            word-break: break-word;  /* æ ¸å¿ƒä¿®æ­£2: å¼·åˆ¶é•·å–®è©æˆ–é€£çºŒå­—å…ƒæ–·é–‹ï¼Œé˜²æ­¢æº¢å‡º */
            display: block;
        }
        
        /* === å­—é«”é è¦½æ¡†æ¨£å¼ (ä¿®æ­£å¾Œ) === */
        
        /* é è¨­ï¼ˆæ—¥é–“æ¨¡å¼ï¼‰çš„æ¨£å¼ */
        #font-preview {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9; /* æ—¥é–“æ¨¡å¼çš„æ·ºç°è‰²èƒŒæ™¯ */
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        /* é è¦½æ¡†è£¡çš„æ–‡å­—é¡è‰²ï¼Œé è¨­æ˜¯é»‘è‰² */
        #font-preview p {
            color: var(--text-primary);
        }
        
        /* å¤œé–“æ¨¡å¼ä¸‹çš„ä¿®æ­£æ¨£å¼ */
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e; /* æ·±ç°è‰²èƒŒæ™¯ */
            border-color: #38383a;     /* æš—è‰²é‚Šæ¡† */
        }
        
        /* å¤œé–“æ¨¡å¼ä¸‹ï¼Œé è¦½æ¡†è£¡çš„æ–‡å­—è®Šç‚ºç™½è‰² */
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾ç·»ç‰ˆè½‰å¸³æ“ä½œå½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */
        .transfer-actions-content {
            background-color: #fff0f5; /* ç²‰å«©çš„èƒŒæ™¯è‰² */
            border-radius: 20px;
            width: 290px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* ç²‰è‰²é™°å½± */
            text-align: center;
            position: relative;
            border: 1px solid #ffcce0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .transfer-actions-header {
            font-size: 20px;
            font-weight: bold;
            color: #a35c7b; /* æ·±ç²‰è‰²æ¨™é¡Œ */
            margin-bottom: 15px;
        }
        
        .transfer-actions-body p {
            font-size: 15px;
            color: #555;
            margin: 0 0 25px 0;
            line-height: 1.5;
        }
        
        .transfer-actions-footer {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        
        .transfer-actions-footer .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }
        
        .transfer-actions-footer .action-btn:active {
            transform: scale(0.95);
        }
        
        .transfer-actions-footer .action-btn.accept {
            background: linear-gradient(135deg, #ff85b3, #ff69b4);
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
        }
        
        .transfer-actions-footer .action-btn.decline {
            background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .transfer-actions-content .cancel-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: #a35c7b;
            font-size: 20px;
            line-height: 28px;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === æœªè®€æ¶ˆæ¯ç´…é»æ¨£å¼ === */
        .unread-count-wrapper {
            flex-shrink: 0;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px; /* è®“ç´…é»å’Œåå­—å·®ä¸å¤šé«˜ */
        }
        
        .unread-count {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background-color: #ff3b30; /* iOS é¢¨æ ¼çš„ç´…è‰² */
            color: white;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            text-align: center;
            border-radius: 10px; /* åœ“è§’çŸ©å½¢ */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            display: none; /* é»˜èªéš±è— */
            justify-content: center;
            align-items: center;
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„é é¢èˆ‡å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
        
        /* ç¢ºä¿é é¢èƒŒæ™¯è‰²çµ±ä¸€ */
        #call-history-screen {
            background-color: #f0f2f5;
        }
        
        /* é€šè©±è¨˜éŒ„å¡ç‰‡æ¨£å¼ */
        .call-record-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 5px solid var(--accent-color);
        }
        .call-record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        /* å¡ç‰‡é ­éƒ¨ï¼šåŒ…å«æ—¥æœŸå’Œæ™‚é•· */
        .call-record-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .call-record-card .card-header .duration {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* å¡ç‰‡ä¸»é«”ï¼šåƒèˆ‡è€…é ­åƒ */
        .call-record-card .card-body {
            display: flex;
            align-items: center;
        }
        .call-record-card .participants-avatars {
            display: flex;
            align-items: center;
        }
        .call-record-card .participant-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* è®“é ­åƒæœ‰ä¸€å€‹æ¼‚äº®çš„å †ç–Šæ•ˆæœ */
        .call-record-card .participant-avatar:not(:first-child) {
            margin-left: -12px;
        }
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        /* --- é€šè©±è©³æƒ…å½ˆçª—æ¨£å¼ --- */
        #transcript-modal-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
        }
        .transcript-entry {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            line-height: 1.5;
            word-break: break-word;
        }
        .transcript-entry.user {
            background-color: #dcf8c6; /* é¡ä¼¼å¾®ä¿¡çš„ç¶ è‰² */
            align-self: flex-end;
        }
        .transcript-entry.assistant {
            background-color: #ffffff;
            align-self: flex-start;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        #chat-list-title {
            cursor: pointer;
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„å¡ç‰‡ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */
        
        .call-record-card .card-body {
            /* å°‡ body æ”¹ç‚º flex ä½ˆå±€ï¼Œè®“æ¨™é¡Œå’Œåƒèˆ‡è€…è³‡è¨Šå‚ç›´æ’åˆ— */
            display: flex;
            flex-direction: column;
            gap: 8px; /* æ¨™é¡Œå’Œåƒèˆ‡è€…è³‡è¨Šä¹‹é–“çš„é–“è· */
        }
        
        .call-record-card .custom-title {
            font-size: 16px;
            font-weight: 600; /* åŠ ç²—ï¼Œè®“å®ƒåƒå€‹æ¨™é¡Œ */
            color: var(--text-primary);
            padding-bottom: 8px; /* æ¨™é¡Œä¸‹çš„ç•™ç™½ */
            border-bottom: 1px solid var(--border-color); /* åœ¨æ¨™é¡Œä¸‹åŠ ä¸€æ¢åˆ†å‰²ç·š */
            margin-bottom: 4px; /* å’Œä¸‹é¢çš„åƒèˆ‡è€…è³‡è¨Šæ‹‰é–‹ä¸€é»è·é›¢ */
        }
        
        .call-record-card .participants-info {
            /* é€™å€‹æ–°å®¹å™¨è®“é ­åƒå’Œâ€œèˆ‡xxâ€èƒ½æ°´æº–å°é½Š */
            display: flex;
            align-items: center;
        }
        
        /* åƒèˆ‡è€…åå­—çš„æ¨£å¼å¾®èª¿ï¼Œè®“å®ƒä¸é‚£éº¼çªå‡º */
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 500; /* ä¸å†åŠ ç²— */
            font-size: 14px; /* ç¨å¾®å°ä¸€é» */
            color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰² */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èªéŸ³è½‰æ–‡å­—åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* 1. èªéŸ³æ–‡å­—å…§å®¹çš„æ¨£å¼ */
        .voice-transcript {
            font-size: 14px;         /* æ–‡å­—å¤§å° */
            line-height: 1.6;        /* è¡Œé«˜ï¼Œè®“å¤šè¡Œæ–‡æœ¬æ›´æ˜“è®€ */
            color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰²ï¼Œèˆ‡èªéŸ³æ¢å€åˆ† */
            padding: 8px 12px;       /* å…§é‚Šè· */
            margin-top: 6px;         /* å’Œä¸Šæ–¹çš„èªéŸ³æ¢æ‹‰é–‹ä¸€é»è·é›¢ */
            background-color: rgba(0, 0, 0, 0.04); /* çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯ï¼Œæ›´æœ‰å±¤æ¬¡æ„Ÿ */
            border-radius: 6px;      /* åœ“è§’ */
            word-break: break-word;  /* ç¢ºä¿é•·æ–‡æœ¬èƒ½æ­£å¸¸æ›è¡Œ */
            display: none;           /* é»˜èªéš±è— */
        }
        
        #phone-screen.dark-mode .voice-transcript {
            background-color: rgba(255, 255, 255, 0.1); /* å¤œé–“æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
        }
        
        /* 2. æ—‹è½‰è¼‰å…¥å‹•ç•«çš„æ¨£å¼ */
        .loading-spinner {
            display: none; /* é»˜èªéš±è— */
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top-color: var(--accent-color); /* æ—‹è½‰éƒ¨åˆ†çš„é¡è‰² */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 8px; /* å’Œæ³¢å½¢åœ–ã€æ™‚é•·ä¿æŒä¸€é»é–“è· */
        }
        
        /* 3. å®šç¾©æ—‹è½‰å‹•ç•« */
        @keyframes spin {
            to {
        transform: rotate(360deg);
            }
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è¨˜éŒ„æª¢è¦–å™¨æ¨£å¼ä¿®æ­£ â–¼â–¼â–¼ */
        #shared-history-viewer-content {
            display: flex;
            flex-direction: column; /* è®“æ°£æ³¡å‚ç›´æ’åˆ— */
            gap: 20px; /* åœ¨æ¯å€‹æ°£æ³¡ä¹‹é–“å¢åŠ 20åœ–å…ƒçš„é–“è· */
            padding: 15px; /* åœ¨å®¹å™¨å››å‘¨ä¹Ÿå¢åŠ ä¸€äº›å…§é‚Šè·ï¼Œé¿å…æ°£æ³¡è²¼é‚Š */
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾æ©Ÿå’Œæ­Œè©æ¨£å¼ â–¼â–¼â–¼ */
        #music-player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
            background-color: rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-50px);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #music-player-overlay.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .music-player-window { 
            width: 70%; 
            min-height: 420px;
            background-color: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-radius: 25px; 
            box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
            border: 1px solid rgba(255, 255, 255, 0.18); 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #1f1f1f; 
            position: relative;
            justify-content: space-between;
            padding-bottom: 15px;
        }
        
        .music-player-top-actions {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            width: calc(100% - 30px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-left-cluster {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #music-return-btn, #music-exit-btn {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: #555;
            padding: 5px;
            line-height: 1;
        }
        #music-exit-btn {
            font-size: 24px;
            font-weight: 400;
        }
        
        .music-progress-bar-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .time-display {
            font-size: 11px;
            color: #888;
            width: 35px;
            text-align: center;
            flex-shrink: 0;
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        .progress-bar {
            flex-grow: 1;
            height: 5px;
            background-color: #e5e5e5;
            border-radius: 2.5px;
            cursor: pointer;
        }
        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background-color: #333;
            border-radius: 2.5px;
        }
        
        #music-lyrics-container {
            width: 100%;
            height: 192px;
            overflow: hidden;
            position: relative;
            -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
            mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
        }
        
        #music-lyrics-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .lyric-line {
            padding: 4px 0;
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 1.5;
            transition: all 0.5s ease;
            opacity: 0.7;
            transform: scale(0.95);
        }
        
        .lyric-line.active {
            font-size: 16px;
            color: #000;
            opacity: 1;
            transform: scale(1);
        }
        
        .music-player-controls-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .music-controls {
            margin-top: 0;
        }
        
        #music-return-btn, #music-exit-btn, #music-playlist-btn {
            position: relative;
        }
        
        #music-return-btn { top: -2px; }
        #music-playlist-btn { top: -3px; }
        
        .playlist-item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .playlist-action-btn {
            font-size: 18px;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .playlist-action-btn:hover { color: #000; }
        .delete-track-btn { font-size: 24px; color: #ff3b30; }
        .delete-track-btn:hover { color: #c00; }
        .lyrics-btn { font-weight: 500; }
        
        /* --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¢ºä¿é ­åƒå°ºå¯¸ --- */
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%;
            object-fit: cover;
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ¨£å¼ â–¼â–¼â–¼ */
        
        /* 1. æ’¤å›æ¶ˆæ¯çš„é ç•™ä½ç½®æ¨£å¼ */
        .recalled-message-placeholder {
            align-self: center; /* å±…ä¸­é¡¯ç¤º */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; /* è®“å®ƒçœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
        }
        
        /* 2. å¤œé–“æ¨¡å¼ä¸‹çš„é©é… */
        #phone-screen.dark-mode .recalled-message-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* 3. AIæ’¤å›æ¶ˆæ¯æ™‚çš„å‹•ç•«æ•ˆæœ */
        @keyframes recall-animation {
          from {
            opacity: 1;
            transform: scale(1);
          }
          to {
            opacity: 0;
            transform: scale(0.8);
          }
        }
        
        .message-wrapper.recalled-animation {
          animation: recall-animation 0.3s ease-out forwards;
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ¨£å¼ä¿®æ­£ â–¼â–¼â–¼ */
        
        /* å¼·åˆ¶æ’¤å›æ¶ˆæ¯çš„é ç•™ä½ç½®ä¸æ›è¡Œï¼Œä¸¦ä¿æŒå…§å®¹å±…ä¸­ */
        .recalled-message-placeholder {
            white-space: nowrap; /* æ ¸å¿ƒï¼šç¦æ­¢æ–‡æœ¬æ›è¡Œ */
            display: inline-block; /* è®“èƒŒæ™¯æ ¹æ“šå…§å®¹è‡ªæˆ‘èª¿æ•´å¯¬åº¦ */
            padding: 4px 12px;
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸åˆ†é¡æ¸…å–®æ¨£å¼ â–¼â–¼â–¼ */
        .world-book-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .world-book-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        .world-book-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        .world-book-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        .world-book-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        .world-book-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        .world-book-group-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .world-book-group-content.collapsed {
            max-height: 0;
        }
        #phone-screen.dark-mode .world-book-group-header {
            background-color: #1c1c1e;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©ç½®é ‚æ¨£å¼ â–¼â–¼â–¼ */
        .chat-list-item.pinned {
            background-color: #f0f2f5; /* çµ¦ä¸€å€‹æ·¡æ·¡çš„ã€ä¸åŒçš„èƒŒæ™¯è‰² */
        }
        
        #phone-screen.dark-mode .chat-list-item.pinned {
            background-color: #2c2c2e; /* å¤œé–“æ¨¡å¼ä¸‹çš„ç½®é ‚èƒŒæ™¯è‰² */
        }
        /* â–¼â–¼â–¼ ä¿®å¾©è¼¸å…¥æ¡†é®æ“‹æŒ‰éˆ•çš„ä½ˆå±€å•é¡Œ â–¼â–¼â–¼ */
        #chat-input-area {
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* é˜²æ­¢æ•´å€‹è¼¸å…¥å€è¢«æ„å¤–å£“ç¸® */
            background-color: var(--secondary-bg); /* ç¢ºä¿èƒŒæ™¯è‰²çµ±ä¸€ï¼Œé¿å…é€æ˜é‡ç–Š */
        }
        
        #chat-input-actions-top {
            flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¡Œè¢«å£“ç¸® */
            padding-bottom: 8px; /* å¢åŠ ä¸€é»å’Œè¼¸å…¥æ¡†çš„é–“è·ï¼Œæ”¹å–„è§€æ„Ÿ */
        }
        
        #chat-input-main-row {
            flex-shrink: 0; /* é˜²æ­¢è¼¸å…¥æ¡†è¡Œè¢«å£“ç¸® */
        }
        /* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤èŠ@åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘è«‹ç”¨é€™æ®µä»£ç¢¼æ›¿æ›æ‚¨ç¾æœ‰çš„ #chat-input-area æ¨£å¼ â–¼â–¼â–¼ */
        #chat-input-area {
            position: relative; /* ä¿æŒç›¸å°å®šä½ï¼Œä½œç‚ºå½ˆçª—çš„â€œéŒ¨é»â€ */
            z-index: 20;      /* ã€é—œéµä¿®å¾©ã€‘æå‡æ•´å€‹è¼¸å…¥å€çš„å±¤ç´š */
            flex-shrink: 0;
            padding: 8px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        /* 2. å®šç¾©èŠå¤©@å½ˆçª—çš„å…·é«”ä½ç½®å’Œæ¨£å¼ */
        #chat-at-mention-popup {
            bottom: 100%; /* é¡¯ç¤ºåœ¨æ•´å€‹è¼¸å…¥å€çš„ä¸Šæ–¹ */
            left: 8px;    /* èˆ‡è¼¸å…¥å€å·¦é‚Šå…§é‚Šè·å°é½Š */
            right: 8px;   /* èˆ‡è¼¸å…¥å€å³é‚Šå…§é‚Šè·å°é½Š */
            width: auto;  /* å¯¬åº¦è‡ªå‹•æ’æ»¿ */
            margin-bottom: 5px; /* å’Œè¼¸å…¥å€æ‹‰é–‹ä¸€é»è·é›¢ */
            /* å…¶ä»–æ¨£å¼å°‡è¤‡ç”¨ .at-mention-popup çš„ç¾æœ‰æ¨£å¼ */
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘Šæ¿å½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */
        #announcement-board-modal .modal-content {
            height: 70%;
            background-color: #f0f2f5;
        }
        #announcement-board-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px; /* å…¬å‘Šä¹‹é–“çš„é–“è· */
        }
        #announcement-board-content .message-wrapper {
            max-width: 100%; /* è®“å…¬å‘Šæ¶ˆæ¯å¯ä»¥æ’æ»¿å¯¬åº¦ */
            align-self: center;
        }
        #announcement-board-content .timestamp {
            display: none; /* å…¬å‘Šæ¿å…§ä¸é¡¯ç¤ºæ™‚é–“æˆ³è¨˜ */
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¬å‘Šæ¿å¡ç‰‡ç®¡ç†æ¨£å¼ â–¼â–¼â–¼ */
        .announcement-item-wrapper {
            position: relative; /* ç‚ºäº†å®šä½æ“ä½œæŒ‰éˆ• */
            padding: 10px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .announcement-item-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            border-radius: 50%;
        }
        .announcement-item-actions:hover {
            background-color: #f0f0f0;
        }
        .pinned-indicator {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 28px;
            height: 28px;
            background-color: #ffc107;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è½‰ç™¼åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* 1. è½‰ç™¼å¾Œçš„å‹•æ…‹ï¼Œå…§åµŒçš„åŸå§‹å…§å®¹å®¹å™¨ */
        .reposted-content-wrapper {
            background-color: #f7f7f8;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        /* åœ¨å¤œé–“æ¨¡å¼ä¸‹ï¼Œç‚ºå…§åµŒå®¹å™¨æä¾›ä¸€å€‹æ·±è‰²èƒŒæ™¯ */
        #phone-screen.dark-mode .reposted-content-wrapper {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        
        /* 2. ç§»é™¤å…§åµŒåŸå§‹å…§å®¹çš„åº•éƒ¨äº’å‹•å€ï¼Œé¿å…æ··æ·† */
        .reposted-content-wrapper .post-footer,
        .reposted-content-wrapper .post-feedback-icons,
        .reposted-content-wrapper .post-likes-section {
            display: none;
        }
        
        /* 3. è®“å…§åµŒå…§å®¹çš„é ­éƒ¨è³‡è¨Šç¨å¾®ç·Šæ¹Šä¸€äº› */
        .reposted-content-wrapper .post-header {
            margin-bottom: 8px;
        }
        .reposted-content-wrapper .post-avatar {
            width: 32px;
            height: 32px;
        }
        .reposted-content-wrapper .post-nickname {
            font-size: 14px;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

             
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…±ç”¨ä½ç½®å¡ç‰‡æ¨£å¼ (å¾®ä¿¡é¢¨æ ¼ V2 - æ”¯æ´åœ–ç‰‡èƒŒæ™¯) â–¼â–¼â–¼ */
        
        /* 1. å¡ç‰‡ç¸½å®¹å™¨ (ä¿æŒä¸è®Š) */
        .location-share-card {
            width: 230px;
            border-radius: 10px;
            overflow: hidden; 
            background-color: #fff;
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            cursor: pointer; /* è®“å¡ç‰‡çœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
        }
        
        /* 2. ä¸ŠåŠéƒ¨åˆ†ï¼šç™½è‰²æ–‡å­—å€ (ä¿æŒä¸è®Š) */
        .card-text-area {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .card-text-primary {
            font-size: 16px;
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-text-secondary {
            font-size: 12px;
            color: #a0a0a0;
        }
        
        /* 3. ä¸‹åŠéƒ¨åˆ†ï¼šã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ°åœ–/åœ–ç‰‡å€ */
        .card-map-area {
            height: 100px; /* å¢åŠ é«˜åº¦ä»¥æ›´å¥½åœ°å±•ç¤ºåœ–ç‰‡ */
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* åœ–ç‰‡èƒŒæ™¯çš„é—œéµæ¨£å¼ */
            background-size: cover;
            background-position: center;
            
            /* é»˜èªçš„ç´”è‰²èƒŒæ™¯ (ç•¶æ²’æœ‰æä¾›åœ–ç‰‡æ™‚ç”Ÿæ•ˆ) */
            background-color: #FFF0F5; /* AIçš„å¡ç‰‡ç”¨æŸ”å’Œç²‰è‰² */
        }
        
        /* 4. ä½¿ç”¨è€…ç™¼é€çš„å¡ç‰‡ï¼Œåœ°åœ–å€é è¨­ç”¨æŸ”å’Œç¶ è‰² */
        .message-bubble.user .location-share-card .card-map-area {
            background-color: #F0FFF8;
        }
        
        /* 5. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¾åŒ–åœ–é‡˜åœ–ç¤ºï¼Œå¢åŠ é™°å½±ä½¿å…¶æ›´çªå‡º */
        .card-pin-icon {
            font-size: 40px;
            color: #FF6B6B; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡é¡è‰²å¾ white æ”¹ç‚ºæ‚¨å–œæ­¡çš„ä»»æ„é¡è‰² */
        
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AI è§’è‰²è¡Œå‹•å‘¼å¸ç‡ˆæ•ˆæœ â–¼â–¼â–¼ */
        @keyframes breathing-light {
            0% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
            50% {
        box-shadow: 0 0 18px 4px rgba(0, 123, 255, 0.8);
            }
            100% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
        }
        
        .chat-list-item .avatar.is-acting {
            /* æ ¸å¿ƒï¼šæ‡‰ç”¨å‘¼å¸ç‡ˆå‹•ç•« */
            animation: breathing-light 2s ease-in-out infinite;
            /* (å¯é¸) åŒæ™‚æ·»åŠ ä¸€å€‹å¸¸äº®çš„é‚Šæ¡†ï¼Œè®“æ•ˆæœæ›´æ˜é¡¯ */
            border: 1.5px solid rgba(0, 123, 255, 0.7);
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‹•æ…‹è©•è«–å€è¡¨æƒ…åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘è©•è«–å€è¡¨æƒ…æŒ‰éˆ•æ¨£å¼ (èˆ‡action-iconé¢¨æ ¼çµ±ä¸€) === */
        .comment-sticker-btn {
            /* 1. é‡æ–°é–‹æ©ŸæŒ‰éˆ•é è¨­æ¨£å¼ */
            background: none;
            border: none;
            padding: 5px; /* å¢åŠ ä¸€é»å¯é»æ“Šå€åŸŸ */
            cursor: pointer;
            
            /* 2. èˆ‡å…¶ä»–åœ–ç¤ºé¡è‰²å’Œéæ¸¡æ•ˆæœå°é½Š */
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        
            /* 3. ä½¿ç”¨Flexä½ˆå±€è®“å…§éƒ¨çš„SVGå®Œç¾å±…ä¸­ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comment-sticker-btn:hover {
            color: var(--text-primary); /* æ»‘é¼ æ‡¸åœæ™‚è®Šè‰²ï¼Œæä¾›å›é¥‹ */
        }
        
        /* 4. å®šç¾©SVGåœ–ç¤ºçš„æ¨£å¼ï¼Œèˆ‡é»è´Š/è½‰ç™¼åœ–ç¤ºå®Œå…¨ä¸€è‡´ */
        .comment-sticker-btn svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* 2. è©•è«–å€è¡¨æƒ…é¢æ¿å®¹å™¨ */
        #qzone-sticker-panel {
            position: absolute; /* ä½¿ç”¨çµ•å°å®šä½ï¼Œç”±JSæ§åˆ¶ä½ç½® */
            width: 280px;
            height: 200px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1010; /* ç¢ºä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            display: none; /* é»˜èªéš±è— */
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 3. é¢æ¿å…§çš„è¡¨æƒ…ç¶²æ ¼ (ä¸è®Š) */
        #qzone-sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }
        
        #qzone-sticker-grid .sticker-item {
            position: relative;
            aspect-ratio: 1 / 1;
            background-color: white;
            border-radius: 8px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        
        /* 4. è©•è«–å€è£¡çš„è¡¨æƒ…åœ–ç‰‡æ¨£å¼ (å°ºå¯¸ä¿®æ­£å¾Œ) */
        .comment-text .comment-sticker {
            max-width: 100px;  /* æ¸›å°æœ€å¤§å¯¬åº¦ */
            max-height: 100px; /* æ¸›å°æœ€å¤§é«˜åº¦ */
            display: block;
            background-color: transparent;
        }
        
        /* 5. ã€æ–°å¢ã€‘å„ªåŒ–ï¼šç•¶è©•è«–å…§å®¹æ˜¯è¡¨æƒ…æ™‚ï¼Œèª¿æ•´é–“è· */
        .comment-item .comment-text:has(.comment-sticker) {
            /* å¦‚æœ .comment-text å…§éƒ¨åªæœ‰è¡¨æƒ…ï¼Œå°±ç§»é™¤æ–‡å­—è¡Œé«˜å¸¶ä¾†çš„é¡å¤–é‚Šè· */
            line-height: 1;
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* === é ­åƒæ¡†é¸æ“‡æ¨¡æ…‹æ¡†æ¨£å¼ === */
        .change-frame-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        #avatar-frame-modal .modal-content {
            height: 70%;
        }
        
        #avatar-frame-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .frame-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .frame-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        
        .frame-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .frame-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }
        
        .frame-item {
            aspect-ratio: 1 / 1;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
            padding: 5px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .frame-item.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        
        .frame-item .preview-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .frame-item .preview-frame {
            position: absolute;
            top: -7px;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        
        /* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©æ–¹æ¡ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼æ›¿æ›æ‰€æœ‰èˆŠçš„é ­åƒç›¸é—œæ¨£å¼ â–¼â–¼â–¼ */
        
        /* 1. é ­åƒæœ€å¤–å±¤å®¹å™¨ï¼Œè² è²¬å ä½å…ƒå’Œå‹•æ…‹è®Šå¯¬ */
        .avatar-group {
            width: 34px;
            flex-shrink: 0; /* ç¢ºä¿åœ¨flexä½ˆå±€ä¸­ä¸è¢«å£“ç¸® */
            position: relative;
            transition: width 0.2s ease;
        }
        /* ç•¶ä½©æˆ´é ­åƒæ¡†æ™‚ï¼Œå¤–å±¤å®¹å™¨è®Šå¯¬ï¼Œç‚ºæ›´å¤§çš„é ­åƒæ¡†å‰µé€ ç©ºé–“ */
        .avatar-group.has-frame {
            width: 42px; 
        }
        
        /* 2. åŸºç¤çš„ã€ç„¡æ¡†çš„é ­åƒæ¨£å¼ */
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%; /* é»˜èªçš„æ–¹åœ“å½¢é ­åƒ */
            object-fit: cover;
        }
        
        /* 3. å¸¶æ¡†é ­åƒçš„â€œå…§éƒ¨å®¹å™¨â€ */
        .avatar-with-frame {
            position: relative; /* é—œéµï¼šç‚ºå…§éƒ¨çš„é ­åƒå’Œæ¡†æä¾›å®šä½éŒ¨é» */
            width: 38px;
            height: 38px;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        /* ã€æ ¸å¿ƒã€‘ç•¶æœ‰æ¡†æ™‚ï¼Œé€™å€‹å…§éƒ¨å®¹å™¨ä¹Ÿè®Šå¤§ï¼Œè®“è£¡é¢çš„åœ–ç‰‡å¯ä»¥æ›´å¤§ */
        .avatar-group.has-frame .avatar-with-frame {
            width: 43px;
            height: 43px;
        }
        
        /* 4. å¸¶æ¡†é ­åƒä¸­çš„â€œé ­åƒåœ–ç‰‡æœ¬èº«â€ */
        .avatar-with-frame .avatar-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* å¯¬åº¦æ’æ»¿å…¶çˆ¶å®¹å™¨ (.avatar-with-frame) */
            height: 100%;/* é«˜åº¦ä¹Ÿæ’æ»¿ */
            border-radius: 50%; /* ä½©æˆ´é ­åƒæ¡†æ™‚ï¼Œåœ–ç‰‡æœ¬èº«è®Šç‚ºåœ“å½¢ä»¥æ›´å¥½åœ°é©é… */
            object-fit: cover;
            z-index: 1; /* ç¢ºä¿åœ¨é ­åƒæ¡†ä¸‹æ–¹ */
        }
        
        /* 5. â€œé ­åƒæ¡†åœ–ç‰‡æœ¬èº«â€ */
        .avatar-with-frame .avatar-frame {
            position: absolute;
            width: 120%;  
            height: 120%; 
        
            /* --- é€™å°±æ˜¯ç¢ºä¿å®Œç¾åŒ…è£¹å’Œå±…ä¸­çš„é—œéµä»£ç¢¼ --- */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* --- é—œéµä»£ç¢¼çµæŸ --- */
            z-index: 2; /* ç¢ºä¿åœ¨é ­åƒåœ–ç‰‡ä¸Šæ–¹ */
            pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶å¯ä»¥ç©¿é€é ­åƒæ¡†ï¼Œé»åˆ°ä¸‹é¢çš„é ­åƒ */
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©æ–¹æ¡ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›æ‰€æœ‰èˆŠçš„é ­åƒå’Œæ°£æ³¡ç›¸é—œæ¨£å¼ â–¼â–¼â–¼ */

/* 1. å¼·åˆ¶å¤–å±¤æ°£æ³¡å®¹å™¨(.message-bubble)æˆç‚ºä¸€å€‹çœŸæ­£çš„â€œå½ˆæ€§â€å°ˆæ¡ˆã€‚*/
.message-bubble {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.message-bubble.user { 
    flex-direction: row-reverse; 
}

/* 2. å¼·åˆ¶å…§å±¤å…§å®¹å€(.content)ä¹Ÿæˆç‚ºä¸€å€‹â€œå½ˆæ€§â€å°ˆæ¡ˆã€‚*/
.message-bubble .content {
    flex: 1;
    min-width: 0;
    
    /* --- æ ¸å¿ƒä¿®å¾©ï¼šä¿®æ”¹é€™è£¡çš„æ›è¡Œè¦å‰‡ --- */
    overflow-wrap: break-word; /* ä½¿ç”¨é€™å€‹æ¨™æº–å±¬æ€§ä¾†ä¿è­‰å–®è©å®Œæ•´æ€§ */
    word-wrap: break-word;     /* ç›¸å®¹èˆŠç‰ˆæµè¦½å™¨ */
    /* --- ä¿®å¾©çµæŸ (å·²æ›¿æ›èˆŠçš„ break-all è¦å‰‡) --- */

    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
}

/* 3. å†æ¬¡ç¢ºä¿é ­åƒå®¹å™¨çµ•å°ä¸æ”¶ç¸® (ä½œç‚ºæœ€çµ‚ä¿éšª) */
.message-bubble .avatar-group {
    flex-shrink: 0 !important;
}

/* â–²â–²â–² ä¿®å¾©æ–¹æ¡ˆçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€çµ‚æ¥µå¼·åˆ¶ä¿®æ­£ã€‘è«‹å°‡é€™æ®µä»£ç¢¼é»è²¼åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */
        
        /* ä½¿ç”¨IDé¸æ“‡å™¨å’Œ!importantï¼Œå¼·åˆ¶æå‡é€™æ¢è¦å‰‡çš„å„ªå…ˆé †åºåˆ°æœ€é«˜ï¼Œ
           ä»¥è¦†è“‹ä»»ä½•å¯èƒ½å­˜åœ¨çš„æœªçŸ¥è¡çªæ¨£å¼ã€‚*/
        
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 43px !important;
            height: 43px !important;
        }
        
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        /* â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¡ç‰‡/ç‰¹æ®Šå…§å®¹å±…ä¸­ä¿®æ­£ â–¼â–¼â–¼ */
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éš±è—èŠå¤©åˆ—è¡¨ä¸­çš„é ­åƒæ¡† (æœ€çµ‚ä¿®æ­£ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. åœ¨èŠå¤©æ¸…å–®è¢å¹•ä¸­ï¼Œç›´æ¥éš±è—é ­åƒæ¡†åœ–ç‰‡ */
        #chat-list-screen .avatar-frame {
            display: none;
        }
        
        /* 2. å¼·åˆ¶æ‰€æœ‰é ­åƒçš„æœ€å¤–å±¤å®¹å™¨ï¼Œåœ¨åˆ—è¡¨é éƒ½ä¿æŒ 45px çš„æ­£ç¢ºå°ºå¯¸ */
        #chat-list-screen .avatar-group {
            width: 45px;
            height: 45px;
        }
        
        /* 3. å¦‚æœä¸€å€‹é ­åƒæ˜¯å¸¶æ¡†çµæ§‹ï¼Œä¹Ÿå¼·åˆ¶å…¶å…§éƒ¨å®¹å™¨å’Œåœ–ç‰‡é©æ‡‰ 45px çš„å°ºå¯¸ */
        #chat-list-screen .avatar-group.has-frame .avatar-with-frame,
        #chat-list-screen .avatar-group.has-frame .avatar-img {
            width: 45px;
            height: 45px;
        }
        
        /* 4. ç¢ºä¿æ‰€æœ‰é ­åƒåœ¨åˆ—è¡¨é éƒ½æ˜¯åœ“å½¢çš„ï¼Œä¿æŒçµ±ä¸€ */
        #chat-list-screen .avatar-img,
        #chat-list-screen .avatar {
            border-radius: 50%;
        }
        
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¢åŠ èŠå¤©æ¸…å–®é ­åƒèˆ‡æ–‡å­—çš„é–“è· â–¼â–¼â–¼ */
        
        /* 1. å¼·åˆ¶ç‚ºèŠå¤©åˆ—è¡¨ä¸­çš„é ­åƒå®¹å™¨è¨­ç½®å³é‚Šè· */
        /*    é€™å°‡è¦†è“‹ä»»ä½•å¯èƒ½å­˜åœ¨çš„èˆŠæ¨£å¼ï¼Œä¸¦ç¢ºä¿é–“è·ç”Ÿæ•ˆ */
        #chat-list .chat-list-item .avatar-group {
            margin-right: 15px !important; /* æ ¸å¿ƒï¼šå¢åŠ å³é‚Šè·ï¼Œå°‡æ–‡å­—æ¨é–‹ */
        }
        
        /* 2. (å¯é¸ä½†æ¨è–¦) ç¢ºä¿èˆŠçš„é ­åƒæ¨£å¼ä¸å†å¹²æ“¾ä½ˆå±€ */
        #chat-list .chat-list-item .avatar {
            margin-right: 0; /* ç§»é™¤èˆŠçš„é‚Šè·ï¼Œé˜²æ­¢é‡è¤‡è¨ˆç®— */
        }
        
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‹•æ…‹è©•è«–å€å›å¾©åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* è®“è©•è«–é …åœ¨æ»‘é¼ æ‡¸åœæ™‚é«˜äº®ï¼Œä¸¦é¡¯ç¤ºæ‰‹å‹æ¸¸æ¨™ */
        .comment-item {
            cursor: pointer;
            transition: background-color 0.2s;
            /* ä½¿ç”¨Flexä½ˆå±€ï¼Œè®“è©•è«–å…§å®¹å’Œåˆªé™¤æŒ‰éˆ•èƒ½æ­£ç¢ºå°é½Š */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px; /* å…§å®¹å’Œåˆªé™¤æŒ‰éˆ•çš„é–“è· */
            padding: 4px 6px; /* å¢åŠ ä¸€é»å…§é‚Šè·ï¼Œæ–¹ä¾¿é»æ“Š */
            margin: 0 -6px; /* æŠµæ¶ˆå…§é‚Šè·ï¼Œä¿æŒè¦–è¦ºå°é½Š */
            border-radius: 4px;
        }
        
        .comment-item:hover {
            background-color: #f0f2f5;
        }
        
        /* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœæ•ˆæœ */
        #phone-screen.dark-mode .comment-item:hover {
            background-color: #2c2c2e;
        }
        
        /* è©•è«–å…§å®¹æ–‡æœ¬çš„å®¹å™¨ */
        .comment-item .comment-text {
            flex-grow: 1; /* ä½”æ“šä¸»è¦ç©ºé–“ */
            word-break: break-word; /* ç¢ºä¿é•·å…§å®¹èƒ½æ›è¡Œ */
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æ–¼ç›¸å®¹èˆŠæ ¼å¼è©•è«–çš„æ¨£å¼ â–¼â–¼â–¼ */
        .legacy-comment-item {
            line-height: 1.5;
            padding: 4px 6px; /* å’Œæ–°æ¨£å¼ä¿æŒä¸€è‡´çš„å…§é‚Šè· */
            color: var(--text-secondary); /* ç”¨æ¬¡è¦é¡è‰²é¡¯ç¤ºï¼Œä»¥ç¤ºå€åˆ¥ */
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¡ç‰‡/ç‰¹æ®Šå…§å®¹å±…ä¸­ä¿®æ­£ â–¼â–¼â–¼ */
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€çµ‚æ¥µå¼·åˆ¶ä¿®æ­£ã€‘è«‹å°‡é€™æ®µä»£ç¢¼é»è²¼åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */
        
        /* ä½¿ç”¨IDé¸æ“‡å™¨å’Œ!importantï¼Œå¼·åˆ¶æå‡é€™æ¢è¦å‰‡çš„å„ªå…ˆé †åºåˆ°æœ€é«˜ï¼Œ
           ä»¥è¦†è“‹ä»»ä½•å¯èƒ½å­˜åœ¨çš„æœªçŸ¥è¡çªæ¨£å¼ã€‚*/
        
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 43px !important;
            height: 43px !important;
        }
        
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        /* â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€Safari/iOS æœ€çµ‚å¡ç‰‡ä½ˆå±€ä¿®å¾©ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ â–¼â–¼â–¼ */
        
        /* 
          ç¬¬ä¸€æ­¥ï¼šã€æ ¸å¿ƒä¿®å¾©ã€‘
          é€™å€‹é¸æ“‡å™¨æœƒä¸€æ¬¡æ€§é¸ä¸­æ‰€æœ‰åŒ…å«ç‰¹æ®Šå¡ç‰‡çš„æ¶ˆæ¯æ°£æ³¡å®¹å™¨(.message-bubble)ã€‚
          æˆ‘å€‘å‘Šè¨´å®ƒä¸è¦å†å¼·åˆ¶æ‹‰ä¼¸ï¼Œè€Œæ˜¯æ ¹æ“šå…§éƒ¨å¡ç‰‡çš„å¤§å°è‡ªæˆ‘èª¿æ•´å¯¬åº¦ã€‚
        */
        .message-bubble.is-sticker,
        .message-bubble.is-voice-message,
        .message-bubble.is-transfer,
        .message-bubble.is-ai-image,
        .message-bubble.is-waimai-request,
        .message-bubble.is-red-packet,
        .message-bubble.is-poll,
        .message-bubble.is-link-share,
        .message-bubble.is-location-share {
            flex: initial; /* è¦†è“‹æ‰é€šç”¨çš„ flex: 1ï¼Œé€™æ˜¯è§£æ±ºå•é¡Œçš„é—œéµï¼Œè®“æ°£æ³¡æœ¬èº«ä¸å†æ‹‰ä¼¸ */
            min-width: auto; /* åŒæ¨£é‡ç½® min-widthï¼Œå…è¨±å…¶è‡ªç”±æ”¶ç¸® */
        }
        
        /* 
          ç¬¬äºŒæ­¥ï¼šä¿æŒå°å¡ç‰‡å…§éƒ¨ .content å€åŸŸçš„æ¨£å¼é‡ç½®ã€‚
          æˆ‘å€‘ç§»é™¤å®ƒçš„èƒŒæ™¯å’Œå…§é‚Šè·ï¼Œè®“å¡ç‰‡è‡ªå·±è² è²¬å¤–è§€ã€‚
        */
        .message-bubble.is-sticker .content,
        .message-bubble.is-voice-message .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-ai-image .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-link-share .content,
        .message-bubble.is-location-share .content {
            /* ä¿æŒé€™å€‹å¥½ç¿’æ…£ï¼Œç¢ºä¿å…§å®¹å€ä¹Ÿä¸æ‹‰ä¼¸ */
            flex: initial; 
            
            /* ç§»é™¤æ‰€æœ‰å¯èƒ½å¹²æ“¾å¡ç‰‡é¡¯ç¤ºçš„æ¨£å¼ */
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        /* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€çµ‚æ¥µç‰ˆã€‘ç¾¤å…¬å‘Šå°é½Šä¿®å¾© (å¼·åˆ¶æ‰€æœ‰å…§å®¹é å·¦) â–¼â–¼â–¼ */
        
        /* 
          ç¬¬ä¸€æ­¥ï¼šå¼·åˆ¶æ‰€æœ‰æ¶ˆæ¯å¡Šï¼ˆç„¡è«–æ˜¯AIé‚„æ˜¯ç”¨æˆ¶ï¼‰éƒ½åœ¨å…¬å‘Šæ¿å…§é å·¦å°é½Šã€‚
          é€™ç¢ºä¿äº†AIå’Œä½¿ç”¨è€…çš„æ¶ˆæ¯å¡Šåœ¨å‚ç›´æ–¹å‘ä¸Šæ˜¯å°é½Šçš„ã€‚
        */
        #announcement-board-content .message-wrapper {
            align-self: flex-start !important;
        }
        
        /* 
          ç¬¬äºŒæ­¥ï¼šé€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ï¼
          æˆ‘å€‘å°ˆé–€é‡å°ä½¿ç”¨è€…çš„æ¶ˆæ¯æ°£æ³¡ï¼Œå¼·åˆ¶å°‡å…¶å…§éƒ¨çš„å…ƒç´ é †åºï¼ˆé ­åƒå’Œå…§å®¹ï¼‰
          å¾â€œåå‘â€æ¢å¾©ç‚ºâ€œæ­£å‘â€ï¼Œä½¿å…¶èˆ‡AIçš„æ¶ˆæ¯æ°£æ³¡ä½ˆå±€å®Œå…¨ä¸€è‡´ã€‚
        */
        #announcement-board-content .message-bubble.user {
            flex-direction: row !important;
        }
        
        /* 
          ç¬¬ä¸‰æ­¥ (å¯é¸ä½†æ¨è–¦): 
          åŒæ™‚ï¼Œæˆ‘å€‘ä¹Ÿå¼·åˆ¶å°‡ä½¿ç”¨è€…æ¶ˆæ¯å¡Šå¤–éƒ¨çš„æ™‚é–“æˆ³è¨˜å’Œæ°£æ³¡é †åºæ¢å¾©æ­£å¸¸ï¼Œ
          ä»¥é˜²æœªä¾†å¯èƒ½å‡ºç¾çš„ä½ˆå±€å•é¡Œã€‚
        */
        #announcement-board-content .message-wrapper.user {
            flex-direction: row !important;
        }
        
        /* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€çµ‚æ¥µä¿®å¾©ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ä¸Šä¸€æ¬¡é»è²¼çš„ä»£ç¢¼ â–¼â–¼â–¼ */
        
        /* === èŠå¤©ä»‹é¢é ­éƒ¨æµ®å‹•èˆ‡å±¤ç´šçµ‚æ¥µä¿®å¾© === */
        
        /* 
          é€™æ¬¡çš„ä¿®å¾©æœ‰å…©å€‹é—œéµé»ï¼š
          1. ä¾ç„¶ä½¿ç”¨ absolute å®šä½è®“é ­éƒ¨æµ®å‹•èµ·ä¾†ã€‚
          2. é¡å¤–çµ¦å®ƒä¸€å€‹éå¸¸é«˜çš„ z-index ä¸¦ç”¨ !important æ¨™è¨˜ï¼Œ
             è³¦äºˆå®ƒâ€œè‡³é«˜ç„¡ä¸Šâ€çš„æ¬ŠåŠ›ï¼Œå¼·åˆ¶å®ƒå£“åˆ¶é é¢ä¸Šä»»ä½•å…¶ä»–å…ƒç´ ã€‚
        */
        
        /* 1. å¼·åˆ¶èŠå¤©ä»‹é¢çš„é ­éƒ¨è®Šç‚ºçµ•å°å®šä½ï¼Œä¸¦è³¦äºˆä¸€å€‹æ¥µé«˜çš„å±¤ç´š */
        #chat-interface-screen > .header {
            position: absolute !important; /* æ ¸å¿ƒä¿®æ­£1: è„«é›¢æ–‡æª”æµï¼Œæµ®å‹•èµ·ä¾† */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100 !important; /* æ ¸å¿ƒä¿®æ­£2: è³¦äºˆä¸€å€‹éå¸¸é«˜çš„ z-indexï¼Œå£“åˆ¶ä¸€åˆ‡ */
        }
        
        /* 2. ä¿®æ­£èŠå¤©å…§å®¹å€çš„ä½ˆå±€ï¼Œç§»é™¤ä¸å†éœ€è¦çš„è² å¤–é‚Šè·ï¼Œè®“ç‚ºé ­éƒ¨é ç•™çš„ padding ç”Ÿæ•ˆ */
        #chat-interface-screen #chat-messages {
            margin-top: 0 !important; /* æ ¸å¿ƒä¿®æ­£3: ç§»é™¤ç”¨æ–¼â€œä¸Šæ‹‰â€çš„è² å¤–é‚Šè· */
        }
        
        /* â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æœ€çµ‚è§£æ±ºæ–¹æ¡ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‰€æœ‰èˆŠçš„ä¿®å¾©ä»£ç¢¼ â–¼â–¼â–¼ */
        
        /* === èŠå¤©ä»‹é¢ä½ˆå±€èˆ‡å±¤ç´šçµ‚æ¥µä¿®å¾© === */
        
        /* 
          ç¬¬ä¸€éƒ¨åˆ†ï¼šä¿®å¾©éŸ³æ¨‚æ’­æ”¾æ©Ÿè¢«é®æ“‹çš„å•é¡Œ
          æˆ‘å€‘çµ¦æ’­æ”¾æ©Ÿä¸€å€‹æ¯”é ­éƒ¨æ›´é«˜çš„ z-indexï¼Œè®“å®ƒèƒ½æ­£ç¢ºåœ°è¦†è“‹æ‰€æœ‰å…§å®¹ã€‚
        */
        #music-player-overlay {
            z-index: 200 !important;
        }
        
        /* 
          ç¬¬äºŒéƒ¨åˆ†ï¼šå¾¹åº•é‡æ§‹èŠå¤©é é¢çš„ä½ˆå±€ï¼Œè§£æ±ºå¯¬åº¦å’Œé®æ“‹å•é¡Œ
          æˆ‘å€‘å°‡æ¡ç”¨æœ€ç©©å®šã€æœ€ç¾ä»£çš„ä½ˆå±€æ–¹å¼ï¼š
          - é ­éƒ¨å’Œè¼¸å…¥æ¡†éƒ½ä½¿ç”¨çµ•å°å®šä½ï¼Œåˆ†åˆ¥â€œé‡˜â€åœ¨è¢å¹•çš„é ‚éƒ¨å’Œåº•éƒ¨ã€‚
          - èŠå¤©å…§å®¹å€å‰‡ä½”æ“šæ•´å€‹è¢å¹•çš„é«˜åº¦ï¼Œä¸¦é€šéå…§é‚Šè·ï¼ˆpaddingï¼‰ç‚ºé ­éƒ¨å’Œè¼¸å…¥æ¡†ç•™å‡ºç©ºé–“ã€‚
          é€™æ¨£å¯ä»¥å®Œç¾å¯¦ç¾å…§å®¹åœ¨é€æ˜é ‚/åº•éƒ¨ä¹‹ä¸‹æ»¾å‹•çš„ç¾è§€æ•ˆæœï¼Œä¸”ä¸æœƒå†å‡ºç¾å¯¬åº¦è¨ˆç®—éŒ¯èª¤ã€‚
        */
        
        /* â–¼â–¼â–¼ è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰€æœ‰èˆŠçš„èŠå¤©ä»‹é¢ä½ˆå±€CSS â–¼â–¼â–¼ */
        
        /* 1. ç¢ºä¿èŠå¤©ä»‹é¢å®¹å™¨æ˜¯å¯é çš„å®šä½éŒ¨é» */
        #chat-interface-screen {
            position: relative !important;
            height: 100%;
            width: 100%;
            overflow: hidden; /* é˜²æ­¢ä»»ä½•æ„å¤–æº¢å‡º */
        }
        
        /* 2. å¼·åˆ¶ã€é ­éƒ¨ã€‘çµ•å°å®šä½ï¼Œä¸¦â€œé‡˜â€åœ¨è¢å¹•é ‚éƒ¨ */
        #chat-interface-screen > .header {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0; /* ä½¿ç”¨ left/right æ’æ»¿å¯¬åº¦ï¼Œæ¯” width:100% æ›´å¯é  */
            width: auto !important; 
            z-index: 100 !important; /* è³¦äºˆä¸€å€‹éå¸¸é«˜çš„å±¤ç´šï¼Œç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ */
        }
        
        /* 3. å¼·åˆ¶ã€è¼¸å…¥æ¡†ã€‘ä¹Ÿçµ•å°å®šä½ï¼Œä¸¦â€œé‡˜â€åœ¨è¢å¹•åº•éƒ¨ */
        #chat-interface-screen #chat-input-area {
            position: absolute !important;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto !important;
            z-index: 100 !important;
            /* æ ¸å¿ƒï¼šç‚ºè¼¸å…¥æ¡†æœ¬èº«æ·»åŠ é©é…â€œå°é»‘æ¢â€çš„åº•éƒ¨å…§é‚Šè· */
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
        }
        
        /* 4. ã€æ ¸å¿ƒã€‘é‡æ–°å®šç¾©ã€èŠå¤©å…§å®¹å€ã€‘çš„ä½ˆå±€ */
        #chat-interface-screen #chat-messages {
            /* è®“å®ƒå¡«æ»¿æ•´å€‹è¢å¹• */
            height: 100% !important; 
            width: 100% !important;
            
            /* å…è¨±å…¶å…§å®¹å‚ç›´æ²å‹• */
            overflow-y: auto !important; 
            
            /* ç¢ºä¿ padding çš„è¨ˆç®—æ–¹å¼æ­£ç¢º */
            box-sizing: border-box !important; 
            
            /* ç§»é™¤æ‰€æœ‰å¯èƒ½å¹²æ“¾ä½ˆå±€çš„ margin */
            margin-top: 0 !important; 
        
            /* é—œéµï¼šä½¿ç”¨å…§é‚Šè·ç‚ºé ‚éƒ¨çš„â€œé ­éƒ¨â€å’Œåº•éƒ¨çš„â€œè¼¸å…¥æ¡†â€ç•™å‡ºç©ºé–“ */
            /* é€™æ¨£å…§å®¹å°±æœƒåœ¨åŠé€æ˜çš„é ‚/åº•éƒ¨ä¹‹ä¸‹æ»¾å‹•ï¼Œæ•ˆæœç¾è§€ä¸”ç²¾å‡† */
            padding-top: 150px !important;  /* ç‚ºé ­éƒ¨é ç•™ç´„110pxç©ºé–“ */
            padding-bottom: 150px !important; /* ç‚ºè¼¸å…¥æ¡†é ç•™ç´„120pxç©ºé–“ */
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        /* â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œå‹•æ…‹å·²åˆªé™¤â€æç¤ºæ¨£å¼ â–¼â–¼â–¼ */
        .post-deleted-placeholder {
            align-self: center;
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; /* é—œéµï¼šè®“å®ƒçœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
        }
        
        #phone-screen.dark-mode .post-deleted-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå¡—é»‘ï¼ˆåŠ‡é€ï¼‰åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */
        .spoiler {
            background-color: #333; /* å¡—é»‘çš„èƒŒæ™¯è‰² */
            color: #333;           /* å¡—é»‘çš„æ–‡å­—é¡è‰²ï¼Œä½¿å…¶èˆ‡èƒŒæ™¯èç‚ºä¸€é«” */
            padding: 0 4px;         /* è¼•å¾®çš„å·¦å³å…§é‚Šè·ï¼Œä½¿å…¶æ›´ç¾è§€ */
            border-radius: 4px;     /* åœ“è§’ */
            cursor: pointer;        /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºç‚ºå¯é»æ“Šçš„æ‰‹å‹ */
            transition: all 0.2s ease-in-out; /* è®“é¡¯ç¤º/éš±è—æ•ˆæœæ›´å¹³æ»‘ */
        }
        
        /* æ»‘é¼ æ‡¸åœæˆ–é»æ“Šæ™‚ï¼Œæ¢å¾©èƒŒæ™¯å’Œæ–‡å­—é¡è‰²ä»¥é¡¯ç¤ºå…§å®¹ */
        .spoiler:hover, .spoiler:active {
            background-color: #e0e0e0; /* é¡¯ç¤ºæ™‚çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
            color: inherit;           /* æ¢å¾©ç‚ºæ­£å¸¸çš„æ–‡å­—é¡è‰² */
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é•·æœŸè¨˜æ†¶ç®¡ç†æŒ‰éˆ•ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */
        .memory-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px; /* å¢åŠ ä¸€é»å¯é»æ“Šå€åŸŸï¼Œæ–¹ä¾¿ä½¿ç”¨è€…æ“ä½œ */
            border-radius: 50%; /* åœ“å½¢èƒŒæ™¯ */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .memory-action-btn svg {
            width: 18px;  /* è®“åœ–ç¤ºæ¯”é ‚éƒ¨çš„ç¨å°ä¸€é»ï¼Œæ›´é¡¯ç²¾ç·» */
            height: 18px;
            stroke: var(--text-secondary); /* é è¨­ä½¿ç”¨æ¬¡è¦æ–‡å­—çš„ç°è‰² */
            transition: stroke 0.2s;
        }
        
        .memory-action-btn:hover {
            background-color: #e9ecef; /* æ»‘é¼ æ‡¸åœæ™‚çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰² */
        }
        
        /* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœæ•ˆæœ */
        #phone-screen.dark-mode .memory-action-btn:hover {
            background-color: #38383a;
        }
        
        /* ç·¨è¼¯æŒ‰éˆ•æ‡¸åœæ™‚ï¼Œåœ–ç¤ºè®Šç‚ºè—è‰² */
        .memory-action-btn.edit-memory-btn:hover svg {
            stroke: var(--accent-color);
        }
        
        /* åˆªé™¤æŒ‰éˆ•æ‡¸åœæ™‚ï¼Œåœ–ç¤ºè®Šç‚ºå±éšªçš„ç´…è‰² */
        .memory-action-btn.delete-memory-btn:hover svg {
            stroke: #ff3b30;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆªé™¤åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç‚ºè¡¨æƒ…é …æ·»åŠ ä¸€å€‹é¸ä¸­æ¡† */
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œè¢«é¸ä¸­çš„è¡¨æƒ…é …ï¼Œé¡¯ç¤ºè—è‰²é‚Šæ¡† */
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç¸½æ˜¯é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        
        /* åº•éƒ¨æ‰¹é‡åˆªé™¤æ“ä½œæ¬„ */
        #sticker-action-bar {
            display: none; /* é»˜èªéš±è— */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
        }
        
        #sticker-action-bar button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°æ¼”å‰ªè¼¯å®¤æ¨£å¼ â–¼â–¼â–¼ */
        #ai-response-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ai-response-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        
        .ai-response-editor-block textarea {
            width: 100%;
            min-height: 80px; /* é»˜èªçµ¦ä¸€å€‹æ›´å¤§çš„é«˜åº¦ */
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px; /* ä½¿ç”¨å°ä¸€é»çš„å­—é«”ï¼Œæ–¹ä¾¿æŸ¥çœ‹JSON */
            font-family: monospace; /* ä½¿ç”¨ç­‰å¯¬å­—é«”ï¼Œè®“JSONå°é½Šæ›´ç¾è§€ */
            box-sizing: border-box;
        }
        
        .ai-response-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; /* è¦†è“‹é»˜èªçš„ margin-bottom */
        }
        
        .ai-response-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        
        #phone-screen.dark-mode .ai-response-editor-block {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .ai-response-editor-block textarea {
            background-color: #1c1c1e;
            color: #f0f0f0;
            border-color: #4a4a4e;
        }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° | ç·šä¸‹æ¨¡å¼å…§å¿ƒç¨ç™½æ¨£å¼ (å·²ä¿®å¾©æ–œé«”)ã€‘ â–¼â–¼â–¼ */
.offline-dialogue {
    /* å°è©±éƒ¨åˆ†å¯ä»¥ä¿æŒé è¨­æ¨£å¼ï¼Œæˆ–è€…ç¨ä½œå¼·èª¿ */
    font-weight: 500;
}
.offline-description {
    display: block; 
    color: inherit; /* ä¿æŒæ™®é€šæå¯«æ–‡å­—é¡è‰²èˆ‡å°è©±ä¸€è‡´ */
    font-style: normal; 
    margin-top: 4px; 
    white-space: pre-wrap; 
    line-height: 1.6;
}

/* âœ¨ æ ¸å¿ƒæ–°å¢ï¼šå°ˆé–€ç‚ºå…§å¿ƒç¨ç™½ï¼ˆæ–œé«”ï¼‰è¨­ç½®æ¨£å¼ */
.offline-description em {
    color: var(--text-secondary); /* å°‡é¡è‰²è¨­ç½®ç‚ºæ¬¡è¦æ–‡å­—çš„æ·ºç°è‰² */
    /* font-style: normal;  <-- å·²åˆªé™¤æ­¤è¡Œï¼Œæ¢å¾©æ–œé«” */
}

#phone-screen.dark-mode .offline-description {
    color: inherit; /* å¤œé–“æ¨¡å¼ä¸‹ä¹Ÿä¿æŒæ™®é€šæå¯«æ–‡å­—é¡è‰²ä¸€è‡´ */
}
/* â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨è·³è½‰é«˜äº®æ•ˆæœ â–¼â–¼â–¼ */
        
        /* 1. ç‚ºæ¶ˆæ¯æ°£æ³¡çš„å…§å®¹å€æ·»åŠ ä¸€å€‹å¹³æ»‘çš„èƒŒæ™¯è‰²éæ¸¡æ•ˆæœ */
        .message-bubble .content {
            transition: background-color 0.5s ease-out;
        }
        
        /* 2. å®šç¾©é«˜äº®æ™‚çš„èƒŒæ™¯è‰² */
        /*    æˆ‘å€‘ä½¿ç”¨ !important ä¾†ç¢ºä¿å®ƒèƒ½è¦†è“‹æ‰æ‰€æœ‰ä¸»é¡Œçš„é è¨­é¡è‰² */
        .message-bubble.highlighted .content {
            background-color: rgba(0, 123, 255, 0.2) !important;
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€ä½ˆå±€çµ‚æ¥µä¿®å¾©ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œæ›¿æ›æ‰æ‚¨èˆŠçš„æ‰€æœ‰äº”å­æ£‹ç›¸é—œæ¨£å¼ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ ã€é‚Šæ¡†çµ‚æ¥µä¿®å¾©V2ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„CSSï¼Œæ›¿æ›æ‰æ‚¨èˆŠçš„æ‰€æœ‰äº”å­æ£‹ç›¸é—œæ¨£å¼ â–¼â–¼â–¼ */
        
        /* 1. æ£‹ç›¤çš„å¤–éƒ¨å®¹å™¨ (è² è²¬å®šä½å’Œå‹•ç•«è¦–çª—) */
        #gomoku-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 350px;
            z-index: 50;
            pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€ */
            overflow: hidden;     /* ã€æ ¸å¿ƒã€‘éš±è—æ‰æ»‘å‡ºè¢å¹•å¤–çš„å…§å®¹ */
            display: none;        /* é è¨­ä¸é¡¯ç¤ºï¼Œç”±JSæ§åˆ¶ */
        }
        
        /* â–¼â–¼â–¼ ã€é®ç½©çµ‚æ¥µä¿®å¾©ã€‘è«‹ç”¨é€™æ•´å¡Šå…¨æ–°çš„CSSï¼Œæ›¿æ›æ‰æ‚¨èˆŠçš„ #gomoku-content-wrapper æ¨£å¼ â–¼â–¼â–¼ */
        
        /* 2. æ£‹ç›¤çš„å…§éƒ¨åŒ…è£å™¨ (è² è²¬å¤–è§€å’Œå…§å®¹ä½ˆå±€) */
        #gomoku-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ã€æ ¸å¿ƒã€‘ç§»é™¤æ‰€æœ‰èƒŒæ™¯å’Œæ•ˆæœï¼Œä½¿å…¶å®Œå…¨é€æ˜ */
            background-color: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            /* --- å…¶ä»–ä½ˆå±€æ¨£å¼ä¿æŒä¸è®Š --- */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            box-sizing: border-box;
            transition: transform 0.3s ease-out;
            transform: translateY(-100%);
            pointer-events: auto;
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        #phone-screen.dark-mode #gomoku-content-wrapper {
            background-color: rgba(28, 28, 30, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* ç•¶æ£‹ç›¤å¯è¦‹æ™‚ï¼Œå°‡å…§éƒ¨åŒ…è£å™¨æ»‘å…¥è¦–åœ– */
        #gomoku-overlay.visible #gomoku-content-wrapper {
            transform: translateY(0);
        }
        
        /* 3. èŠå¤©æ¶ˆæ¯å€ (ä¿æŒä¸è®Š) */
        #chat-messages {
            transition: padding-top 0.3s ease-out;
        }
        
        /* 4. æ£‹ç›¤ç•«å¸ƒå’Œæ§åˆ¶æŒ‰éˆ• (ä¿æŒä¸è®Š) */
        #gomoku-board {
            background-color: #e4b591;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        
        #gomoku-controls {
            width: 100%;
            text-align: center;
            flex-shrink: 0;
        }
        
        #close-gomoku-btn {
            padding: 6px 15px;
            border-radius: 15px;
            border: 1px solid var(--text-secondary);
            background-color: rgba(255,255,255,0.5);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
        }
        #phone-screen.dark-mode #close-gomoku-btn {
            background-color: rgba(0,0,0,0.2);
            border-color: var(--text-secondary);
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æ£‹ç›¤äº¤äº’çµ‚æ¥µä¿®å¾©ã€‘è«‹å°‡é€™æ•´å¡ŠCSSé»è²¼åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */
        
        /* 
          ç¬¬ä¸€æ­¥ï¼šã€æ ¸å¿ƒã€‘è®“æ£‹ç›¤çš„å·¨å¤§é€æ˜å®¹å™¨â€œç©¿é€â€æ‰€æœ‰æ»‘é¼ /è§¸æ‘¸é»æ“Šã€‚
          é€™æ¨£æ‚¨å°±å¯ä»¥é»æ“Šåˆ°å®ƒä¸‹æ–¹çš„èŠå¤©æ¶ˆæ¯äº†ã€‚
        */
        #gomoku-overlay {
            pointer-events: none;
        }
        
        /* 
          ç¬¬äºŒæ­¥ï¼šç¾åœ¨ï¼Œæˆ‘å€‘å¿…é ˆâ€œæ¢å¾©â€æ£‹ç›¤å’ŒæŒ‰éˆ•æœ¬èº«çš„å¯é»æ“Šæ€§ã€‚
          æˆ‘å€‘å°‡å®ƒå€‘è¨­ç½®ç‚º autoï¼Œé€™æ¨£å®ƒå€‘å°±åˆèƒ½å›æ‡‰æ‚¨çš„æ“ä½œäº†ã€‚
        */
        #gomoku-board,
        #gomoku-controls {
            pointer-events: auto;
        }
        
        /* --- è«‹ç”¨é€™æ•´å¡Šã€æœ€çµ‚ä½ˆå±€ä¿®å¾©ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›å¾ #product-grid åˆ° .product-footer çš„æ‰€æœ‰ç›¸é—œæ¨£å¼ --- */
        
        #product-grid {
            flex-grow: 1; 
            overflow-y: auto; 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            padding-bottom: 80px;
            /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘: ç§»é™¤ align-items: startï¼Œæ¢å¾©Gridé»˜èªçš„æ‹‰ä¼¸å°é½Šï¼Œç¢ºä¿å¡ç‰‡ç­‰é«˜ */
        }
        
        .product-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            display: flex;         /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘: å¿…é ˆæ˜¯Flexå®¹å™¨ï¼Œæ‰èƒ½æ§åˆ¶å…§éƒ¨å…ƒç´  */
            flex-direction: column;
        
            cursor: pointer;
            position: relative;
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }
        
        /* --- è«‹ç”¨é€™æ•´å¡Šã€æœ€çµ‚ç·Šæ¹Šä½ˆå±€ç‰ˆã€‘ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ .product-info, .product-name, å’Œ .product-footer æ¨£å¼ --- */
        
        .product-info {
            padding: 12px 10px;
            flex-grow: 1;      /* ä¿æŒï¼šè®“è³‡è¨Šå€å¡«æ»¿ï¼Œç¢ºä¿æ‰€æœ‰å¡ç‰‡ç­‰é«˜ */
            display: flex;
            flex-direction: column;
        }
        
        .product-name {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
            min-height: 36px;
            /* ç§»é™¤æ‰€æœ‰flex-growå±¬æ€§ï¼Œè®“å®ƒåªä½”æ“šè‡ªå·±éœ€è¦çš„é«˜åº¦ */
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;      /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šä¸å†ä½¿ç”¨ autoï¼Œè€Œæ˜¯è¨­ç½®ä¸€å€‹å›ºå®šçš„ã€è¼ƒå°çš„é ‚éƒ¨é–“è· */
        }
        
        /* --- æ›¿æ›çµæŸ --- */
        
        
        
        
        
        /* --- æ›¿æ›çµæŸ --- */
        
        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #ff5722;
        }
        .product-price::before { content: 'Â¥'; font-size: 12px; }
        
        .add-to-cart-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* --- ç®¡ç†æ¨¡å¼æ¨£å¼ (ä¿æŒä¸è®Š) --- */
        .product-management-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 7;
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        #shopping-screen.management-mode .product-footer {
            display: none;
        }
        
        
        /* --- è³¼ç‰©è»Šé  (å¾®èª¿) --- */
        #cart-title {
            position: static;
            transform: none;
        }
        #cart-items-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .cart-item {
            display: flex; align-items: flex-start; gap: 12px; background-color: white;
            padding: 12px; border-radius: 12px;
        }
        .cart-item-checkbox { margin-top: 28px; }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .cart-item-info { flex-grow: 1; display: flex; flex-direction: column; }
        .cart-item-name { font-weight: 500; font-size: 14px; line-height: 1.4; }
        .cart-item-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px;}
        .cart-item-price { color: #ff5722; font-weight: bold; font-size: 16px; }
        .quantity-control { display: flex; align-items: center; gap: 4px; }
        .quantity-btn {
            width: 26px; height: 26px; border: none; background-color: #f7f8fa;
            border-radius: 4px; font-weight: 500; cursor: pointer; color: #666;
        }
        .quantity-display { font-weight: 500; min-width: 30px; text-align: center; }
        
        #cart-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; display: flex;
            justify-content: space-between; align-items: center; padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: white; border-top: 1px solid var(--border-color); box-sizing: border-box;
        }
        #cart-footer .select-all-label { display: flex; align-items: center; gap: 5px; }
        #cart-footer .cart-summary { text-align: right; }
        #cart-footer .cart-subtext { font-size: 11px; color: #999; }
        #checkout-btn {
            padding: 10px 25px; border: none; border-radius: 20px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white; font-size: 15px; font-weight: 500; cursor: pointer;
        }
        
        /* --- ç¦®ç‰©å¡ç‰‡ & å°ç¥¨ (æ¨£å¼ä¸è®Š) --- */
        .gift-card {
            width: 220px; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡ max-width æ”¹ç‚ºå›ºå®šçš„ width */
            box-sizing: border-box; 
            border-radius: 12px; 
            background-color: #fff; 
            border: 1px solid #eee; 
            padding: 12px;
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        .gift-header { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .gift-header-icon { width: 20px; height: 20px; color: #ff9800; }
        .gift-header-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .gift-items-preview { padding: 12px 0; display: flex; flex-direction: column; gap: 8px; }
        .gift-preview-item { display: flex; align-items: center; gap: 8px; }
        .gift-preview-img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .gift-preview-name { flex-grow: 1; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gift-preview-quantity { font-size: 12px; color: var(--text-secondary); }
        .gift-footer { font-size: 12px; color: var(--text-secondary); text-align: right; }
        #gift-receipt-body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 15px; background-color: #f7f8fa; }
        .receipt-header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .receipt-header h3 { margin: 0 0 5px 0; font-size: 20px; }
        .receipt-header p { margin: 0; font-size: 12px; color: #888; }
        .receipt-items-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .receipt-items-table th, .receipt-items-table td { padding: 10px 5px; font-size: 13px; }
        .receipt-items-table thead th { border-bottom: 1px solid #333; text-align: left; }
        .receipt-items-table .item-name { width: 50%; }
        .receipt-items-table .item-qty { text-align: center; }
        .receipt-items-table .item-price, .receipt-items-table .item-subtotal { text-align: right; }
        .receipt-total { padding-top: 15px; border-top: 1px solid #333; text-align: right; font-size: 16px; font-weight: bold; }
        .receipt-footer { text-align: center; margin-top: 25px; font-size: 12px; color: #888; }
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ (å¯é¸ï¼Œä½†æ¨è–¦) ç‚ºå•†å“ç®¡ç†æ¨¡å¼æ·»åŠ æ–°æ¨£å¼ â–¼â–¼â–¼ */
        .product-item {
            position: relative; /* ç‚ºäº†å®šä½é®ç½©å±¤ */
        }
.product-management-overlay {
    position: absolute;
    bottom: 0; /* å®šä½åˆ°åº•éƒ¨ */
    left: 0;
    width: 100%;
    background-color: rgba(0,0,0,0.6); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
    display: none; /* é»˜èªä¾ç„¶éš±è— */
    justify-content: center; /* æŒ‰éˆ•æ°´æº–å±…ä¸­ */
    align-items: center;
    gap: 15px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
    padding: 10px 0; /* ä¸Šä¸‹ç•™å‡ºä¸€é»ç©ºé–“ */
    border-radius: 0 0 8px 8px; /* åŒ¹é…å¡ç‰‡çš„åº•éƒ¨åœ“è§’ */
    z-index: 5; /* ç¢ºä¿åœ¨åœ–ç‰‡ä¹‹ä¸Šï¼Œä½†åœ¨é¸æ“‡æ¡†ä¹‹ä¸‹ */
    transition: opacity 0.2s;
}
        #shopping-screen.management-mode .product-management-overlay {
            display: flex; /* åœ¨ç®¡ç†æ¨¡å¼ä¸‹é¡¯ç¤º */
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œéš±è—â€œåŠ å…¥è³¼ç‰©è»Šâ€æŒ‰éˆ• */
        #shopping-screen.management-mode .add-to-cart-btn {
            display: none;
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æª¢æŸ¥ä¸¦æ·»åŠ ã€‘å¡ç‰‡/ç‰¹æ®Šå…§å®¹æ°£æ³¡ä½ˆå±€è¦å‰‡ â–¼â–¼â–¼ */
        .message-bubble.is-card-like {
            flex: initial; /* è¦†è“‹é€šç”¨çš„ flex: 1ï¼Œè®“æ°£æ³¡æœ¬èº«ä¸å†æ‹‰ä¼¸ */
            min-width: auto; /* å…è¨±å…¶è‡ªç”±æ”¶ç¸® */
        }
        .message-bubble.is-card-like .content {
            flex: initial; 
            padding: 0;
            background: transparent;
        }
        /* â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®å¾©è³¼ç‰©è»Šåœ–ç¤ºå°é½Šå•é¡Œ â–¼â–¼â–¼ */
        #go-to-cart-btn {
            display: flex;
            align-items: center; /* æ ¸å¿ƒï¼šå‚ç›´å±…ä¸­å°é½Š */
            gap: 4px; /* åœ¨åœ–ç¤ºå’Œæ•¸ä½ä¹‹é–“å¢åŠ ä¸€é»é–“è· */
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºç¦®ç‰©æ¥æ”¶äººæ¸…å–®æ·»åŠ æ¨£å¼ â–¼â–¼â–¼ */
        #gift-recipient-list .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        #gift-recipient-list .contact-picker-item:last-child {
            border-bottom: none;
        }
        #gift-recipient-list .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        #gift-recipient-list .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        #gift-recipient-list .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        #gift-recipient-list .contact-picker-item .name {
            font-weight: 500;
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ­Œè©æ¬„æ›¿æ›å¿ƒç‡é¡¯ç¤ºå™¨æ¨£å¼ (æœ€çµ‚ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. å¾¹åº•éš±è—èˆŠçš„å¿ƒç‡é¡¯ç¤ºå™¨ï¼Œä¸å†éœ€è¦å®ƒäº† */
        #ai-heart-rate-display {
            display: none !important;
        }
        
        /* 2. ç‚ºæ­Œè©æ¬„æ‡‰ç”¨æ–°çš„æ¨£å¼ï¼Œä½¿å…¶å¤–è§€å’Œå®šä½èˆ‡åŸå¿ƒç‡é¡¯ç¤ºå™¨å®Œå…¨ä¸€è‡´ */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ­Œè©æ¬„ä½ç½®æ§åˆ¶æ¨£å¼ â–¼â–¼â–¼ */
        #global-lyrics-bar {
            /* æ ¸å¿ƒå®šä½ï¼šçµ•å°å®šä½ */
            position: absolute;
            z-index: 20;
        
            /* å¤–è§€æ¨£å¼ (ä¿æŒä¸è®Š) */
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.05);
            padding: 4px 12px;
            border-radius: 12px;
            
            /* å‹•ç•«æ•ˆæœ (ä¿æŒä¸è®Š) */
            opacity: 0;
            visibility: hidden;
            /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºä½ç½®å±¬æ€§æ·»åŠ å¹³æ»‘éæ¸¡ */
            transition: opacity 0.4s ease, visibility 0.4s ease, top 0.3s ease, bottom 0.3s ease, left 0.3s ease, right 0.3s ease, transform 0.3s ease;
        
            /* é™„åŠ æ¨£å¼ (ä¿æŒä¸è®Š) */
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 65%;
        }
        
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 3. ç•¶JSæ·»åŠ .visibleé¡æ™‚ï¼Œé¡¯ç¤ºæ­Œè©æ¬„ */
        #global-lyrics-bar.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* 4. é©é…å¤œé–“æ¨¡å¼ */
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸é é¢ç¾åŒ–æ¨£å¼ (V2 - é ç°½åˆ‡æ›ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. ç¢ºä¿ä¸–ç•Œæ›¸é é¢èƒŒæ™¯è‰²çµ±ä¸€ */
        #world-book-screen {
            background-color: #f0f2f5;
            display: flex; /* æ”¹ç‚ºflexä½ˆå±€ï¼Œè®“é ­éƒ¨ã€é ç°½ã€å…§å®¹å€å‚ç›´æ’åˆ— */
            flex-direction: column;
        }
        
        #phone-screen.dark-mode #world-book-screen {
            background-color: #000000;
        }
        
        /* 2. é ç°½æ¬„æ¨£å¼ */
        #world-book-tabs {
            display: flex;
            overflow-x: auto; /* å¦‚æœåˆ†é¡å¤ªå¤šï¼Œå¯ä»¥æ©«å‘æ»¾å‹• */
            padding: 10px 15px 0 15px;
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
        
            /* éš±è—æ²è»¸ */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #world-book-tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        
        
        /* 3. å–®å€‹é ç°½æŒ‰éˆ•æ¨£å¼ */
        .world-book-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* è®“åº•é‚Šæ¡†èˆ‡å®¹å™¨é‚Šæ¡†é‡åˆ */
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* é˜²æ­¢åˆ†é¡åæ›è¡Œ */
        }
        
        /* 4. å•Ÿå‹•çš„é ç°½æ¨£å¼ */
        .world-book-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .world-book-tab.active {
            color: #ffffff;
        }
        
        
        /* 5. å…§å®¹å€ç¸½å®¹å™¨ï¼Œè² è²¬æ»¾å‹• */
        #world-book-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. å–®å€‹åˆ†é¡çš„å…§å®¹é¢æ¿ï¼Œä½¿ç”¨Gridä½ˆå±€ç¾åŒ– */
        .world-book-category-pane {
            display: none; /* é»˜èªéš±è— */
            grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œé¡¯ç¤º2æœ¬æ›¸ */
            gap: 15px;
            padding: 15px;
        }
        
        /* 7. å•Ÿå‹•çš„å…§å®¹é¢æ¿ */
        .world-book-category-pane.active {
            display: grid;
        }
        

/* 8. ç¾åŒ–å¾Œçš„ä¸–ç•Œæ›¸å¡ç‰‡æ¨£å¼ (æœ€çµ‚ä¿®å¾©ç‰ˆ) */
.world-book-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 8px;
    
    /* æ ¸å¿ƒä¿®å¾© 1: å…è¨±å¡ç‰‡åœ¨ç¶²æ ¼ä½ˆå±€ä¸­æ­£ç¢ºåœ°æ”¶ç¸®ï¼Œé€™æ˜¯è§£æ±ºå•é¡Œçš„é—œéµ */
    min-width: 0;

    /* æ ¸å¿ƒä¿®å¾© 2: å¼·åˆ¶å°æ‰€æœ‰å…§å®¹ï¼ˆåŒ…æ‹¬ä¸­è‹±æ–‡ï¼‰é€²è¡Œæ›è¡Œï¼Œä½œç‚ºé›™é‡ä¿éšª */
    word-break: break-all;
}
        
        .world-book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .world-book-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .world-book-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* é˜²æ­¢é•·æ¨™é¡Œæº¢å‡º */
        }
        
        .world-book-card .card-content-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            /* å¤šè¡Œçœç•¥æ•ˆæœ */
            display: -webkit-box;
            -webkit-line-clamp: 3; /* æœ€å¤šé¡¯ç¤º3è¡Œ */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸²æŸ“å™¨é é¢ç¾åŒ–æ¨£å¼ (V2 - é ç°½åˆ‡æ›ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. ç¢ºä¿æ¸²æŸ“å™¨é é¢èƒŒæ™¯è‰²çµ±ä¸€ */
        #rendering-rules-screen {
            background-color: #f0f2f5;
            display: flex; /* æ”¹ç‚ºflexä½ˆå±€ï¼Œè®“å…ƒç´ å‚ç›´æ’åˆ— */
            flex-direction: column;
        }
        
        #phone-screen.dark-mode #rendering-rules-screen {
            background-color: #000000;
        }
        
        /* 2. é ç°½æ¬„æ¨£å¼ (ä»¿ä¸–ç•Œæ›¸) */
        #rules-tabs {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #rules-tabs::-webkit-scrollbar {
            display: none;
        }
        
        /* 3. å–®å€‹é ç°½æŒ‰éˆ•æ¨£å¼ */
        .rules-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        
        /* 4. å•Ÿå‹•çš„é ç°½æ¨£å¼ */
        .rules-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .rules-tab.active {
            color: #ffffff;
        }
        
        /* 5. å…§å®¹å€ç¸½å®¹å™¨ */
        #rules-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. å–®å€‹åˆ†é¡çš„å…§å®¹é¢æ¿ (Gridä½ˆå±€) */
        .rules-category-pane {
            display: none; /* é»˜èªéš±è— */
            grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œé¡¯ç¤º2å€‹ */
            gap: 15px;
            padding: 15px;
        }
        
        .rules-category-pane.active {
            display: grid;
        }
        
        /* 7. ç¾åŒ–å¾Œçš„è¦å‰‡å¡ç‰‡æ¨£å¼ */
        .rule-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px; /* æ¨™é¡Œå’Œå…§å®¹çš„é–“è· */
            border-left: 5px solid #6c757d; /* é»˜èªçµ¦ä¸€å€‹ç°è‰²é‚Šæ¡† */
        }
        .rule-card.enabled {
            border-left-color: #28a745; /* å•Ÿç”¨çš„è¦å‰‡ç”¨ç¶ è‰²é‚Šæ¡† */
        }
        
        .rule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .rule-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .rule-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rule-card .card-content-preview {
            font-size: 12px;
            font-family: monospace; /* ä½¿ç”¨ç­‰å¯¬å­—é«”ï¼Œé¡¯ç¤ºæ­£å‰‡æ›´æ¸…æ™° */
            color: var(--text-secondary);
            background-color: #f0f2f5;
            padding: 5px 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        #phone-screen.dark-mode .rule-card .card-content-preview {
            background-color: #2c2c2e;
        }
        
        /* â–²â–²â–² æ–°CSSé»è²¼çµæŸ â–²â–²â–² */

        /* â–¼â–¼â–¼ ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘é‡æ–°ç”Ÿæˆå›å¾©æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
        .control-btn.regenerate-btn {
            /* æ ¸å¿ƒä¿®æ”¹ï¼šå°‡èƒŒæ™¯è‰²æ”¹ç‚ºèˆ‡å…¶ä»–åŠŸèƒ½æŒ‰éˆ•ä¸€è‡´çš„åŠé€æ˜ç°è‰² */
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%; /* åœ–ç¤ºå¤§å°ä¿æŒä¸è®Š */
            /* SVGåœ–ç¤ºä¿æŒä¸è®Šï¼Œä¾ç„¶æ˜¯æˆ‘å€‘çš„åˆ·æ–°åœ–ç¤º */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>');
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¨é€²åŠ‡æƒ…æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
        .control-btn.propel-btn {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>');
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è§£æ±ºHTMLä»£ç¢¼è¢«æ°£æ³¡æ¨£å¼â€œå£“ç¸®â€çš„æ ¸å¿ƒCSS â–¼â–¼â–¼ */

/* ç•¶ä¸€å€‹æ¶ˆæ¯æ°£æ³¡è¢«æ¨™è¨˜ç‚º is-raw-html æ™‚ */
.message-bubble.is-raw-html .content {
    padding: 0 !important; /* å¼·åˆ¶ç§»é™¤æ‰€æœ‰å…§é‚Šè· */
    background: transparent !important; /* å¼·åˆ¶èƒŒæ™¯é€æ˜ */
    border: none !important; /* å¼·åˆ¶ç§»é™¤é‚Šæ¡† */
    box-shadow: none !important; /* å¼·åˆ¶ç§»é™¤é™°å½± */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é˜²æ­¢é•·æŒ‰æ™‚è§¸ç™¼è—è‰²æ–‡æœ¬é¸ä¸­ â–¼â–¼â–¼ */

#phone-screen {
    /* æ ¸å¿ƒå±¬æ€§ï¼Œé©ç”¨äºå¤§å¤šæ•¸ç¾ä»£æµè¦½å™¨ */
    user-select: none;

    /* ç›¸å®¹èˆŠç‰ˆ Safari, iOS Safari, Chrome */
    -webkit-user-select: none;

    /* ç›¸å®¹èˆŠç‰ˆ Firefox */
    -moz-user-select: none;

    /* ç›¸å®¹ Internet Explorer/Edge */
    -ms-user-select: none;

    /* é˜²æ­¢åœ¨ iOS ä¸Šé•·æŒ‰é€£çµã€åœ–ç‰‡æ™‚å½ˆå‡ºåŠŸèƒ½è¡¨ */
    -webkit-touch-callout: none;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥é©Ÿ 2ï¼šç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‰€æœ‰èˆŠçš„ä¸»è¢å¹•å’Œå€‹äººè³‡æ–™ç›¸é—œCSS â–¼â–¼â–¼ */

/* --- 1. éš±è—æ‰€æœ‰èˆŠçš„ä¸»è¢å¹•å…ƒç´  --- */
#home-screen #clock-container,
#home-screen #app-grid,
#home-screen #home-widgets-container {
    display: none !important;
}

/* --- 2. ã€æœ€çµ‚ä¿®å¾©ã€‘é‡æ–°å®šç¾©ä¸»è¢å¹•ä½ˆå±€ --- */

#home-screen {
    background: linear-gradient(135deg, #6DD5FA, #2980B9);
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šæ·»åŠ ä¸‹é¢é€™å…©è¡Œ â–¼â–¼â–¼ */
    background-size: cover;
    background-position: center;
    /* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center;
    height: 100%;
}

/* --- æ›¿æ›é€™ä¸€æ•´å¡Šä»£ç¢¼ --- */
/* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ #main-content-area æ¨£å¼ â–¼â–¼â–¼ */

#main-content-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°‡å¡ç‰‡å’Œä¸‹æ–¹åœ–ç¤ºçš„é–“è·å¾60pxç¸®å°åˆ°30px */
    gap: 30px; 
    align-items: center;
    /* æ ¸å¿ƒä¿®æ”¹2ï¼šå°‡é ‚éƒ¨çš„å¤–é‚Šè·å¾40pxç¸®å°åˆ°20pxï¼Œçµ¦è¢å¹•é ‚éƒ¨ç•™å‡ºä¸€é»å‘¼å¸ç©ºé–“å³å¯ */
    margin-top: 20px; 
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€çµ‚è§£æ±ºæ–¹æ¡ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰€æœ‰èˆŠçš„å€‹äººè³‡æ–™å¡ç‰‡ç›¸é—œCSS â–¼â–¼â–¼ */

/* 1. å¡ç‰‡å¤–å±¤å®¹å™¨ï¼šé€™æ˜¯æ‰€æœ‰å…§éƒ¨å…ƒç´ å®šä½çš„â€œéŒ¨é»â€ */
#profile-widget {
    position: relative; /* é—œéµï¼šè®“å…§éƒ¨çš„é ­åƒå’Œå½å…ƒç´ å¯ä»¥ç›¸å°æ–¼å®ƒé€²è¡Œçµ•å°å®šä½ */
    width: 100%;
    max-width: 380px;
    flex-shrink: 0;
}

/* 2. èƒŒæ™¯é ­åœ–ï¼šåªçµ¦é ‚éƒ¨è¨­ç½®åœ“è§’ */
#profile-banner-img {
    display: block; 
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 24px 24px 0 0; /* åªçµ¦é ‚éƒ¨è¨­ç½®åœ“è§’ */
    position: relative;
    z-index: 1; /* è®“é ­åœ–åœ¨ä¸‹æ–¹ */
}

/* 3. é ­åƒå®¹å™¨ï¼šç²¾ç¢ºå®šä½ï¼Œä½¿å…¶ä¸­å¿ƒç·šèˆ‡é ­åœ–åº•éƒ¨å°é½Š */
#profile-widget .profile-avatar-container {
    position: absolute;
    top: 80px; 
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: white; 
    padding: 4px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 3; /* é ­åƒå±¤ç´šæœ€é«˜ï¼Œå£“ä½ä¸€åˆ‡ */
}

#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 4. ç™½è‰²è³‡è¨Šå¡ç‰‡ï¼šä½¿ç”¨è² å¤–é‚Šè·å¯¦ç¾ç„¡ç¸«æ‹¼æ¥ */
#profile-widget .profile-info {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    
    /* --- â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜… --- */
    
    /* 1. ä½¿ç”¨è² å¤–é‚Šè·ï¼Œå°‡å¡ç‰‡å‘ä¸Šç§»å‹•24pxï¼ˆç­‰æ–¼å…¶åœ“è§’åŠå¾‘ï¼‰ */
    margin-top: -24px; 
    
    /* 2. ç‚ºé ­åƒçš„ä¸‹åŠéƒ¨åˆ†å’Œä¸Šæ–¹çš„è² é‚Šè·ï¼Œå…±åŒç•™å‡ºç²¾ç¢ºçš„ç©ºé–“ */
    /* 40px (é ­åƒåŠå¾‘) + 10px (é¡å¤–é–“è·) + 24px (æŠµæ¶ˆè² é‚Šè·) = 74px */
    padding-top: 44px; 
    
    /* --- â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜… --- */
    
    min-height: 120px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 15px;
    padding-right: 15px;
    padding-bottom: 15px;
    text-align: center;
    color: #1c1c1e;
    position: relative;
    z-index: 2; /* è®“è³‡è¨Šå¡åœ¨é ­åœ–ä¹‹ä¸Šï¼Œä½†åœ¨é ­åƒä¹‹ä¸‹ */
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 5. å¼·åˆ¶ç¦ç”¨ä»»ä½•å¯èƒ½æ®˜ç•™çš„èˆŠå½å…ƒç´ æ¨£å¼ */
#profile-widget::before {
    display: none !important;
}

/* (é€™å€‹æ˜¯é ­åƒåœ–ç‰‡æœ¬èº«çš„æ¨£å¼ï¼Œä¿æŒä¸è®Š) */
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 5. å¼·åˆ¶ç¦ç”¨ä»»ä½•å¯èƒ½æ®˜ç•™çš„èˆŠå½å…ƒç´ æ¨£å¼ */
#profile-widget::before {
    display: none !important;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* (é€™å€‹æ˜¯é ­åƒåœ–ç‰‡æœ¬èº«çš„æ¨£å¼ï¼Œä¿æŒä¸è®Š) */
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */



/* (ä»¥ä¸‹ç‚ºå€‹äººè³‡æ–™å…§éƒ¨æ–‡å­—æ¨£å¼ï¼Œä¿æŒä¸è®Š) */
#profile-username { font-size: 18px; font-weight: 600; margin: 0 0 2px 0; }
#profile-sub-username { font-size: 13px; color: #8a8a8a; margin: 0 0 10px 0; }
#profile-bio { font-size: 14px; margin: 0 0 12px 0; color: #333; }
#profile-location {
    font-size: 12px; color: #8a8a8a; margin: 0 auto; display: inline-flex;
    align-items: center; gap: 4px; background-color: rgba(0,0,0,0.05);
    padding: 3px 9px; border-radius: 10px;
}

/* --- (å¾é€™è£¡é–‹å§‹ï¼Œå¾Œé¢çš„æ‰€æœ‰æ¨£å¼éƒ½ä¿æŒä¸è®Šå³å¯) --- */
#desktop-layout {
    display: grid;
    grid-template-columns: 1fr 1.1fr;
    gap: 20px;
    width: 100%;
    align-items: start;
}
#desktop-widget-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.widget-header {
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 5px 5px;
}
.desktop-widget {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 18px;
    padding: 12px 15px;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå°‡é¡è‰²å¾ white æ”¹ç‚ºæ¥è¿‘é»‘è‰²çš„æ·±ç°è‰² */
    color: #1f1f1f; 
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç§»é™¤ç¬¬ä¸€å€‹å°å…ƒä»¶èƒŒæ™¯æ¡†çš„æ¨£å¼ â–¼â–¼â–¼ */

.desktop-widget.text-only {
    background-color: transparent; /* å°‡èƒŒæ™¯è‰²è¨­ç‚ºé€æ˜ */
    border: none;                  /* ç§»é™¤é‚Šæ¡† */
    padding: 0;                    /* ç§»é™¤å…§é‚Šè·ï¼Œé¿å…å¤šé¤˜çš„ç©ºç™½ */
    box-shadow: none;              /* ç¢ºä¿æ²’æœ‰é™°å½± */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
.desktop-widget.icon-left { justify-content: flex-start; gap: 10px; }
/* This is the NEW code */
.desktop-widget.icon-right {
    justify-content: flex-end; /* Pushes both items to the right */
    gap: 10px;                 /* Adds a nice space between the text and the avatar */
}
.desktop-widget img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.desktop-widget p, .desktop-widget span { margin: 0; }
#desktop-app-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    align-content: start;
}
#desktop-dock {
    background-color: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: center;
    gap: 30px;
    width: fit-content;
    flex-shrink: 0;
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼ */
    /* æˆ‘å€‘ç‚ºDockæ¬„å¢åŠ ä¸€å€‹åº•éƒ¨å¤–é‚Šè·ï¼Œ
       é€™å€‹é‚Šè·ç”±20pxçš„åŸºç¤é–“è·å’Œåº•éƒ¨çš„å®‰å…¨è·é›¢çµ„æˆï¼Œ
       èƒ½å°‡å®ƒå¾è¢å¹•åº•éƒ¨å®Œç¾åœ°æŠ¬èµ·ã€‚ */
    margin-bottom: calc(20px + env(safe-area-inset-bottom));
}
.desktop-app-icon {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center;
}
.icon-bg-desktop {
    width: 55px; height: 55px; border-radius: 14px; background-color: #f0f2f5; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; overflow: hidden;
}
.icon-bg-desktop img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 0;
}
.desktop-app-icon .label {
    color: #333; font-size: 13px; font-weight: 500;
}
.desktop-app-icon:active .icon-bg-desktop {
    transform: scale(0.9);
}
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    cursor: pointer;
    opacity: 0.9;
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºå°å…ƒä»¶ç·¨è¼¯åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

/* ç‚ºå¯ç·¨è¼¯çš„å…ƒç´ æ·»åŠ å¯é»æ“Šçš„æ¸¸æ¨™å’Œéæ¸¡æ•ˆæœ */
.editable-text, .editable-image {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

/* æ»‘é¼ æ‡¸åœæ™‚ï¼Œé¡¯ç¤ºä¸€å€‹åŠé€æ˜çš„è™›ç·šå¤–æ¡†ï¼Œä¸¦è¼•å¾®è®Šæš—ï¼Œæä¾›è¦–è¦ºå›é¥‹ */
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    opacity: 0.9;
    border-radius: 4px; /* è®“å¤–æ¡†ä¹Ÿæœ‰ä¸€é»åœ“è§’ */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æ–¹æ¡ˆAï¼šåƒ…èƒŒæ™¯æ¼¸è®Šï¼Œæ–‡å­—ä¿æŒå¯¦é«”ã€‘(å¯èƒ½å°è‡´åº•éƒ¨æ–‡å­—å¯è®€æ€§ä¸‹é™) â–¼â–¼â–¼ */

#profile-widget .profile-info {
    /* 1. å°‡å¡ç‰‡æœ¬èº«çš„èƒŒæ™¯è¨­ç‚ºé€æ˜ */
    background: transparent !important;
    /* 2. å»ºç«‹å®šä½ä¸Šä¸‹æ–‡ï¼Œè®“å½å…ƒç´ å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
    position: relative;
    z-index: 1; /* ç¢ºä¿æ–‡å­—å…§å®¹åœ¨èƒŒæ™¯ä¹‹ä¸Š */
}

#profile-widget .profile-info::before {
    /* 3. å‰µå»ºä¸€å€‹å½å…ƒç´ ä½œç‚ºæ–°çš„èƒŒæ™¯å±¤ */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* 4. å°‡åŸæœ¬çš„ç™½è‰²èƒŒæ™¯å’Œåœ“è§’æ‡‰ç”¨åˆ°é€™å€‹èƒŒæ™¯å±¤ä¸Š */
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    
    /* 5. ã€æ ¸å¿ƒã€‘åªå°é€™å€‹èƒŒæ™¯å±¤æ‡‰ç”¨æ¼¸è®Šæ¶ˆå¤±æ•ˆæœ */
    mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    
    /* 6. å°‡èƒŒæ™¯å±¤æ”¾åˆ°æ–‡å­—å…§å®¹çš„å¾Œé¢ */
    z-index: -1;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è¨­ç½®é é¢æ¨£å¼ â–¼â–¼â–¼ */
#chat-settings-screen {
    /* ç¢ºä¿é é¢æ˜¯ Flex å®¹å™¨ï¼Œè®“å…§å®¹å€å¯ä»¥æ­£ç¢ºåœ°æ‹‰ä¼¸ */
    display: flex;
    flex-direction: column;
    background-color: #f0f2f5; /* èˆ‡å…¶ä»–è¨­ç½®é ä¿æŒä¸€è‡´çš„èƒŒæ™¯è‰² */
}

#phone-screen.dark-mode #chat-settings-screen {
     background-color: #000000; /* å¤œé–“æ¨¡å¼èƒŒæ™¯ */
}

#chat-settings-screen .form-container {
    flex-grow: 1;      /* æ ¸å¿ƒï¼šè®“å…§å®¹å€ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
    overflow-y: auto;  /* æ ¸å¿ƒï¼šç¢ºä¿å…§å®¹éé•·æ™‚å¯ä»¥æ»¾å‹• */
    padding-top: 100px;  /* ç‚ºæµ®å‹•çš„ Header ç•™å‡ºè¶³å¤ çš„é ‚éƒ¨ç©ºé–“ */
    margin-top: -80px;   /* å°‡å…§å®¹å€å‘ä¸Šæ‹‰ï¼Œä½¿å…¶å¯ä»¥æ»¾å‹•åˆ° Header ä¸‹æ–¹ */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢çµæœå½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.search-result-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
}

.search-result-item .artist {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.search-result-item .source {
    font-size: 10px;
    color: var(--accent-color);
    background-color: rgba(0, 123, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éŸ³æ¨‚æ’­æ”¾æ©Ÿå°ˆè¼¯å°é¢æ¨£å¼ â–¼â–¼â–¼ */
#music-player-cover {
    width: 180px;
    height: 180px;
    border-radius: 15px;
    object-fit: cover;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    margin-bottom: 25px; /* åœ¨å°é¢å’Œæ¨™é¡Œä¹‹é–“å¢åŠ é–“è· */
    transition: opacity 0.5s ease-in-out; /* è®“åœ–ç‰‡åˆ‡æ›æ™‚æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä»¿ç¶²æ˜“é›²å”±ç‰‡/æ­Œè©åˆ‡æ›æ¨£å¼ â–¼â–¼â–¼ */

/* 1. åˆ‡æ›çš„ç¸½å®¹å™¨ï¼Œè² è²¬å®šä½å’Œå¤§å° */
#music-visual-container {
    position: relative;
    width: 220px;
    height: 220px;
    margin-bottom: 25px;
    cursor: pointer;
}

/* 2. å”±ç‰‡å’Œæ­Œè©è¦–åœ–çš„é€šç”¨æ¨£å¼ï¼Œè®“å®ƒå€‘é‡ç–Šåœ¨ä¸€èµ· */
#vinyl-view, #inline-lyrics-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    /* æ ¸å¿ƒï¼šç‚ºåˆ‡æ›æ•ˆæœæ·»åŠ å¹³æ»‘çš„éæ¸¡å‹•ç•« */
    transition: opacity 0.5s ease, transform 0.5s ease;
}

/* 3. é»‘è† å”±ç‰‡è¦–åœ–çš„å°ˆå±¬æ¨£å¼ */
#vinyl-view {
    background-color: #222;
    border-radius: 50%;
    padding: 18px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
}
#vinyl-view #music-player-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    margin: 0; /* ç§»é™¤èˆŠçš„å¤–é‚Šè· */
}

/* 4. å…§è¯æ­Œè©è¦–åœ–çš„å°ˆå±¬æ¨£å¼ */
#inline-lyrics-view {
    /* é è¨­ç‹€æ…‹ï¼šå®Œå…¨é€æ˜ï¼Œè¼•å¾®æ”¾å¤§ï¼Œä¸”ä¸å¯é»æ“Š */
    opacity: 0;
    transform: scale(1.1);
    pointer-events: none;
    padding: 10px;
    box-sizing: border-box;
}

/* 5. ã€æ ¸å¿ƒã€‘åˆ‡æ›é‚è¼¯ */
/* ç•¶å®¹å™¨æ“æœ‰ .lyrics-active é¡æ™‚... */
#music-visual-container.lyrics-active #vinyl-view {
    /* ...å”±ç‰‡è¦–åœ–æ¶ˆå¤± */
    opacity: 0;
    transform: scale(0.9);
}
#music-visual-container.lyrics-active #inline-lyrics-view {
    /* ...æ­Œè©è¦–åœ–å‡ºç¾ */
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}

/* 6. æ­Œè©å®¹å™¨çš„æ¨£å¼ (èˆ‡ä¹‹å‰é¡ä¼¼ï¼Œä½†æœ‰å¾®èª¿) */
#inline-lyrics-view #music-lyrics-container {
    width: 100%;
    height: 100%;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é ‚éƒ¨æ­Œæ›²è³‡è¨Šå€åŸŸæ¨£å¼ â–¼â–¼â–¼ */

/* 1. æ–°çš„é ‚éƒ¨è³‡è¨Šå®¹å™¨ */
#music-info-top {
    text-align: center; /* è®“æ‰€æœ‰æ–‡å­—å±…ä¸­ */
    flex-shrink: 0;
    margin-bottom: 20px; /* åœ¨è³‡è¨Šå’Œå”±ç‰‡ä¹‹é–“å¢åŠ ä¸€äº›é–“è· */
}

/* 2. ç§»é™¤èˆŠçš„ã€å¤šé¤˜çš„é‚Šè·ï¼Œé¿å…é›™é‡é–“è· */
#music-player-song-title,
#music-player-artist,
#music-time-counter {
    margin-bottom: 5px; /* çµ±ä¸€è¨­ç½®ä¸€å€‹è¼ƒå°çš„è¡Œé–“è· */
}

/* 3. èª¿æ•´å”±ç‰‡å®¹å™¨çš„å¤–é‚Šè· */
#music-visual-container {
    margin-bottom: 15px; /* é©ç•¶æ¸›å°å”±ç‰‡å’Œé€²åº¦æ¢çš„è·é›¢ */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»‘è† å”±ç‰‡æ—‹è½‰å‹•ç•« â–¼â–¼â–¼ */

/* 1. å®šç¾©ä¸€å€‹åç‚º "spin-vinyl" çš„æ—‹è½‰å‹•ç•« */
@keyframes spin-vinyl {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* 2. å‰µå»ºä¸€å€‹ .spinning é¡ï¼Œæ‡‰ç”¨é€™å€‹å‹•ç•« */
/*    æˆ‘å€‘å¸Œæœ›å®ƒç„¡é™ã€å‹»é€Ÿåœ°æ—‹è½‰ */
#vinyl-view.spinning {
  animation: spin-vinyl 12s linear infinite;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å–®è¡Œæ­Œè©é¡¯ç¤ºæ¨£å¼ â–¼â–¼â–¼ */

#single-lyric-display {
    /* 1. å°ºå¯¸èˆ‡å®šä½ */
    height: 40px;          /* çµ¦ä¸€å€‹å›ºå®šçš„é«˜åº¦ï¼Œé˜²æ­¢æ–‡å­—æ›è¡Œæ™‚ä½ˆå±€è·³å‹• */
    line-height: 40px;     /* å‚ç›´å±…ä¸­ */
    width: 100%;           /* å¯¬åº¦æ’æ»¿ */
    margin-top: 15px;      /* å’Œä¸Šæ–¹çš„å”±ç‰‡æ‹‰é–‹ä¸€äº›è·é›¢ */
    
    /* 2. æ–‡å­—å¤–è§€ */
    text-align: center;    /* æ–‡å­—å±…ä¸­ */
    font-size: 14px;       /* å­—é«”å¤§å° */
    color: #333;           /* å­—é«”é¡è‰² */
    font-weight: 500;      /* å­—é«”ç¨å¾®åŠ ç²—ä¸€é» */

    /* 3. æ•ˆæœèˆ‡å‹•ç•« */
    transition: opacity 0.3s ease; /* è®“æ–‡å­—åˆ‡æ›æ™‚æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    white-space: nowrap;           /* å¼·åˆ¶ä¸æ›è¡Œ */
    overflow: hidden;              /* è¶…å‡ºéƒ¨åˆ†éš±è— */
    text-overflow: ellipsis;       /* è¶…å‡ºéƒ¨åˆ†é¡¯ç¤ºçœç•¥è™Ÿ */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ‡æ›åˆ°å…¨å±æ­Œè©æ™‚ï¼Œéš±è—å–®è¡Œæ­Œè©é è¦½ â–¼â–¼â–¼ */

#music-visual-container.lyrics-active + #single-lyric-display {
    /* æ ¸å¿ƒï¼šä½¿ç”¨ display: none; å°‡å…¶å¾¹åº•éš±è—ï¼Œä¸å ç©ºé–“ */
    display: none;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* 1. å½ˆçª—èƒŒæ™¯ */
#character-profile-modal {
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

/* 2. å¡ç‰‡ä¸»é«”å…§å®¹å€ */
.character-profile-content {
    width: 320px;
    height: 75vh;
    max-height: 580px;
    background-color: #f0f2f5;
    border-radius: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    position: relative;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
     overflow: visible; /* <--- CHANGE TO THIS */
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å¢åŠ é ‚éƒ¨çš„å…§é‚Šè·ï¼Œè®“é ­éƒ¨è³‡è¨Šæ›´èˆ’å±• */
    padding-top: 40px; 
}

/* 3. å³ä¸Šè§’â€œæŸ¥çœ‹æ­·å²â€åœ–ç¤ºæŒ‰éˆ• (ä¿æŒä¸è®Š) */
#profile-history-icon-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 36px;
    height: 36px;
    background: none;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    padding: 0;
    z-index: 10;
}
#profile-history-icon-btn:hover { background-color: rgba(0,0,0,0.05); }
#profile-history-icon-btn svg { width: 20px; height: 20px; stroke: #b0b0b0; stroke-width: 2; }

/* 4. ä¸»è³‡æ–™é èˆ‡æ­·å²è¨˜éŒ„é çš„å®¹å™¨ */
#profile-main-content, #profile-thoughts-history-view {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}

/* 5. ä¸»è³‡æ–™é ç¨æœ‰çš„æ¨£å¼ */
#profile-main-content {
    padding: 0 25px 25px 25px; /* ç§»é™¤äº†é ‚éƒ¨paddingï¼Œå› ç‚ºå®ƒå·²åœ¨çˆ¶å…ƒç´ ä¸­å®šç¾© */
    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘é¡¯è‘—å¢åŠ å¡ç‰‡ä¹‹é–“çš„å‚ç›´é–“è·ï¼Œè§£æ±ºâ€œæ“ â€çš„å•é¡Œ */
    gap: 20px; 
    flex-grow: 1;
    overflow-y: auto;
}

/* 6. é ­éƒ¨ä¿¡æ¯å€ */
.profile-header {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
    /* ã€æ ¸å¿ƒä¿®æ”¹3ã€‘ç‚ºé ­éƒ¨ä¸‹æ–¹å¢åŠ æ˜ç¢ºçš„é‚Šè· */
    margin-bottom: 10px; 
}
#profile-avatar { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
.profile-info { display: flex; flex-direction: column; }
#profile-name { font-size: 20px; font-weight: 600; color: #1f1f1f; }
#profile-id { font-size: 14px; color: #8a8a8a; }
        
/* â–¼â–¼â–¼ ã€å…¨æ–°V2ç‰ˆã€‘å¿ƒè²èˆ‡æ•£è¨˜å¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */

/* 1. å¡ç‰‡é€šç”¨å®¹å™¨æ¨£å¼ */
.profile-section {
    background-color: #ffffff; /* ä¹¾æ·¨çš„ç™½è‰²èƒŒæ™¯ */
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06); /* æŸ”å’Œçš„å¡ç‰‡é™°å½± */
    display: flex;
    flex-direction: column;
    gap: 12px; /* é ­éƒ¨å’Œå…§å®¹å€çš„é–“è· */
    flex-shrink: 0;
}

/* 2. å¡ç‰‡é ­éƒ¨å®¹å™¨ */
.profile-section-header {
    display: flex;
    align-items: center;
    gap: 10px; /* åœ–ç¤ºå’Œæ–‡å­—çš„é–“è· */
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0; /* ä¸€æ¢ç²¾ç·»çš„åˆ†å‰²ç·š */
}

/* 3. å¡ç‰‡é ­éƒ¨åœ–ç¤ºæ¨£å¼ */
.profile-section-icon {
    font-size: 20px;
    opacity: 0.5;
}

/* 4. å¡ç‰‡é ­éƒ¨æ¨™é¡Œæ–‡å­— ("å¿ƒè²", "æ•£è¨˜") */
.profile-section label {
    font-size: 15px;
    font-weight: 600;
    color: #555; /* æ¯”ä¹‹å‰æ›´æ·±çš„é¡è‰²ï¼Œæ›´æœ‰è³ªæ„Ÿ */
    margin: 0; /* ç§»é™¤èˆŠçš„é‚Šè· */
}

/* 5. å¡ç‰‡å…§å®¹å€æ–‡å­— (ä¿æŒä¸è®Š) */
.profile-section p {
    font-size: 15px;
    color: #333;
    line-height: 1.7;
    margin: 0;
    white-space: pre-wrap;
}

/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–² */
        
/* 10. æ­·å²è¨˜éŒ„é é¢ç‰¹å®šæ¨£å¼ (ä¿æŒä¸è®Š) */
#profile-thoughts-history-view { display: none; padding: 0 25px 25px 25px; }
#profile-thoughts-history-view .profile-header { justify-content: space-between; padding-bottom: 15px; }
#profile-thoughts-history-view .profile-header span { font-size: 18px; font-weight: 600; }
#history-back-btn { width: 36px; height: 36px; background: none; border: none; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; padding: 0; }
#history-back-btn:hover { background-color: rgba(0,0,0,0.05); }
#history-back-btn svg { width: 22px; height: 22px; stroke: #a0a0a0; stroke-width: 2.5; }

/* 11. æ­·å²è¨˜éŒ„æ¸…å–® (ä¿æŒä¸è®Š) */
#thoughts-history-list {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 5px;
    margin-right: -10px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.thought-card { background-color: #ffffff; border-radius: 16px; padding: 15px 20px; border: 1px solid #eee; }
.thought-header { font-size: 12px; color: #b0b0b0; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
.thought-content .label { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #a0a0a0; font-size: 13px; margin-bottom: 6px; }
.thought-content .label svg { width: 16px; height: 16px; }
.thought-content .text { font-size: 14px; color: #555; line-height: 1.7; white-space: pre-wrap; padding-left: 22px; }
.thought-content .jottings { margin-top: 15px; }

/* 12. éš±è—æ²è»¸ (ä¿æŒä¸è®Š) */
#profile-main-content::-webkit-scrollbar,
#thoughts-history-list::-webkit-scrollbar { display: none; }
#profile-main-content, #thoughts-history-list { -ms-overflow-style: none; scrollbar-width: none; }
/* â–¼â–¼â–¼ ã€æœ€çµ‚ç‰ˆã€‘å¿ƒè²é é¢èˆ‡æ­·å²è¨˜éŒ„ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

/* 1. å°‡è§’è‰²è©³æƒ…é ï¼ˆå¿ƒè²é é¢ï¼‰çš„èƒŒæ™¯ä¿®æ”¹ç‚ºç´”ç™½è‰² */
.character-profile-content {
    background-color: #ffffff !important;
}

/* 2. åƒ…éš±è—â€œæ•£è¨˜â€æ¨™ç±¤ (åœ¨ä¸»é å’Œæ­·å²è¨˜éŒ„ä¸­éƒ½ç”Ÿæ•ˆ) */
#character-profile-modal .jottings .label {
    display: none;
}

/* 3. ã€å°é½Šä¿®æ­£ã€‘ç§»é™¤å¿ƒè²å’Œæ•£è¨˜å…§å®¹çš„å·¦é‚Šè·ï¼Œè®“å®ƒå€‘èˆ‡æ¨™é¡Œå°é½Š */
#character-profile-modal .thought-content .text {
    padding-left: 0;
}

/* â–²â–²â–² æ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥é©Ÿ 2ï¼šå°‡é€™æ®µå…¨æ–°çš„CSSä»£ç¢¼ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* ç‚ºå‹•æ…‹é é¢çš„â€œä¸‰é»â€æŒ‰éˆ•è¨­ç½®å°ˆå±¬æ¨£å¼ */
#qzone-more-actions-btn {
    font-size: 24px;      /* å¢å¤§å­—é«”ï¼Œè®“â€œâ€¦â€æ›´æ¸…æ™° */
    font-weight: bold;    /* åŠ ç²— */
    padding: 0 10px;      /* å¢åŠ æ°´æº–å¯é»æ“Šå€åŸŸ */
    border-radius: 50%;   /* æ·»åŠ ä¸€å€‹åœ“å½¢èƒŒæ™¯ï¼ˆæ‡¸åœæ™‚å¯è¦‹ï¼‰ */
    line-height: 1;       /* ç¢ºä¿å‚ç›´å±…ä¸­ */
    position: relative;
    top: -2px;            /* ä½ç½®å¾®èª¿ */
    transition: background-color 0.2s;
}
#qzone-more-actions-btn:hover {
    background-color: rgba(0,0,0,0.05); /* æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºä¸€å€‹æ·¡æ·¡çš„ç°è‰²åœ“å½¢èƒŒæ™¯ */
}

/* å¤œé–“æ¨¡å¼ä¸‹çš„æ‡¸åœæ•ˆæœ */
#phone-screen.dark-mode #qzone-more-actions-btn:hover {
    background-color: rgba(255,255,255,0.1);
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥é©Ÿ 2ï¼šå°‡é€™æ®µã€å…¨æ–°çš„CSSä»£ç¢¼ã€‘ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* æ¸…ç©ºå‹•æ…‹é¸æ“‡æ¸…å–®çš„æ¨£å¼ */
#clear-posts-list {
    overflow-y: auto; /* å…§å®¹éé•·æ™‚å¯ä»¥æ»¾å‹• */
    flex-grow: 1;
}

/* æ¯ä¸€å€‹å¯å‹¾é¸çš„é …ç›® */
.clear-posts-item {
    display: flex;
    align-items: center;
    padding: 12px 18px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s;
}
.clear-posts-item:hover {
    background-color: #f5f5f5;
}

/* æ¨¡æ“¬çš„å‹¾é¸æ¡† */
.clear-posts-item .checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
/* é¸ä¸­å¾Œçš„æ¨£å¼ */
.clear-posts-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}
/* ç‚ºå‹¾é¸æ¡†æ·»åŠ ä¸€å€‹â€œâœ”â€è™Ÿ */
.clear-posts-item.selected .checkbox::after {
    content: 'âœ”';
    font-size: 14px;
    font-weight: bold;
}

/* é …ç›®åç¨± */
.clear-posts-item .name {
    font-weight: 500;
}

/* ç‚ºå±éšªé¸é …ï¼ˆå¦‚â€œæ¸…ç©ºæ‰€æœ‰â€ï¼‰æ·»åŠ ç´…è‰²è­¦å‘Šæ¨£å¼ */
.clear-posts-item.danger-option .name {
    color: #ff3b30;
    font-weight: 600;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥é©Ÿ 2ï¼šå°‡é€™æ®µã€å…¨æ–°çš„CSSä»£ç¢¼ã€‘ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®“å¿ƒè²å¡ç‰‡æˆç‚ºåˆªé™¤æŒ‰éˆ•çš„å®šä½éŒ¨é» */
.thought-card {
    position: relative; /* é—œéµï¼ */
}

/* 2. åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
.thought-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0,0,0,0.05);
    color: var(--text-secondary);
    font-size: 20px;
    line-height: 26px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜èªéš±è— */
    transition: all 0.2s ease-in-out;
}

/* 3. æ»‘é¼ æ‡¸åœåœ¨å¡ç‰‡ä¸Šæ™‚ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
.thought-card:hover .thought-delete-btn {
    opacity: 1;
}

/* 4. æ»‘é¼ æ‡¸åœåœ¨åˆªé™¤æŒ‰éˆ•ä¸Šæ™‚ï¼Œè®Šç‚ºç´…è‰²è­¦å‘Š */
.thought-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢çµæœå½ˆçª—ç¾åŒ– (å¤šé¸æ”¯æŒç‰ˆ) â–¼â–¼â–¼ */



/* 2. è®“åˆ—è¡¨é …æ”¯æ´Flexä½ˆå±€ï¼Œç‚ºæ ¸å–æ–¹å¡Šç•™å‡ºç©ºé–“ */
.search-result-item {
    display: flex;       /* æ”¹ç‚ºFlexä½ˆå±€ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}
.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

/* 3. è®“æ­Œæ›²è³‡è¨Šéƒ¨åˆ†ä½”æ“šå‰©é¤˜ç©ºé–“ */
.search-result-item .search-result-info {
    flex-grow: 1;
    pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°çˆ¶å…ƒç´  */
}

/* 4. æ ¸å–æ–¹å¡Šæ¨£å¼ */
.search-result-item .music-search-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    flex-shrink: 0;
}

/* 5. èª¿æ•´å½ˆçª—é ­éƒ¨ï¼Œç‚ºâ€œå…¨é¸â€ç•™å‡ºç©ºé–“ */
#music-search-results-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 6. èª¿æ•´å½ˆçª—é è…³ï¼Œå®¹ç´å…©å€‹æŒ‰éˆ• */
#music-search-results-modal .modal-footer {
    display: flex;
    justify-content: space-around;
}
#music-search-results-modal .modal-footer button {
    width: 45%; /* è®“æ¯å€‹æŒ‰éˆ•ä½”æ“šè¿‘ä¸€åŠå¯¬åº¦ */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾åŒ–å¤–è§€è¨­ç½®é é¢çš„æ¬¡è¦æŒ‰éˆ• â–¼â–¼â–¼ */
.bg-upload-container {
    /* ç¢ºä¿å®¹å™¨å…§çš„æŒ‰éˆ•èƒ½æ­£ç¢ºå°é½Š */
    width: 100%;
    justify-content: center;
    gap: 15px; /* å¢åŠ æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
}

.bg-upload-container .form-button-secondary {
    flex-grow: 1; /* è®“æŒ‰éˆ•è‡ªå‹•å¡«å……ç©ºé–“ */
    flex-basis: 0; /* ç¢ºä¿flex-growç”Ÿæ•ˆ */
    max-width: 180px; /* çµ¦ä¸€å€‹æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨å¯¬å±ä¸Šæ‹‰ä¼¸éåº¦ */
    margin-top: 0;
    padding: 12px; /* é©ä¸­çš„å…§é‚Šè·ï¼Œè®“æŒ‰éˆ•æ›´é£½æ»¿ */
    font-size: 15px;
    font-weight: 600; /* èˆ‡ä¸»æŒ‰éˆ•ä¸€è‡´çš„å­—é‡ */
    border-radius: 8px; /* èˆ‡ä¸»æŒ‰éˆ•ä¸€è‡´çš„åœ“è§’ */
    border: none; /* ç§»é™¤é‚Šæ¡†ï¼Œæ›´åƒiOSé¢¨æ ¼ */
    background-color: #e9e9eb; /* iOSé¢¨æ ¼çš„æ·ºç°è‰² */
    color: #1c1c1e; /* æ·±è‰²æ–‡å­— */
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}

.bg-upload-container .form-button-secondary:active {
    transform: scale(0.98); /* æ·»åŠ é»æ“Šå›é¥‹ */
}

/* ç‚ºâ€œç§»é™¤â€æŒ‰éˆ•è¨­ç½®ç‰¹æ®Šçš„è­¦å‘Šè‰² */
#remove-global-bg-btn {
    background-color: #ffebee;
    color: #c62828;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒè²/æ•£è¨˜å¡ç‰‡ç¥¨æ ¹æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ç‚ºå¡ç‰‡ä¸»é«”è¨­ç½®ç›¸å°å®šä½å’Œæº¢å‡ºéš±è—ï¼Œé€™æ˜¯å¯¦ç¾æ•ˆæœçš„åŸºç¤ */
#character-profile-modal .character-profile-content {
    position: relative; /* è®“å½å…ƒç´ å¯ä»¥ç›¸å°æ–¼å®ƒå®šä½ */
    overflow: visible;  /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å…è¨±å½å…ƒç´ â€œæº¢å‡ºâ€åˆ°å¤–é¢ä¸€é»ï¼Œå½¢æˆæ‰“å­”æ•ˆæœ */
    padding-bottom: 35px; /* å¢åŠ åº•éƒ¨å…§é‚Šè·ï¼Œé˜²æ­¢å…§å®¹èˆ‡åº•éƒ¨æ‰“å­”é‡ç–Š */
}

/* 2. å‰µå»ºé ‚éƒ¨çš„æ‰“å­”æ•ˆæœ */
#character-profile-modal .character-profile-content::before {
    content: '';
    position: absolute;
    top: -10px; /* å‘ä¸Šç§»å‹•ï¼Œéœ²å‡ºä¸€åŠ */
    left: 0;
    right: 0;
    height: 20px; /* æ‰“å­”æ¢çš„é«˜åº¦ */
    /* æ ¸å¿ƒï¼šä½¿ç”¨å¾‘å‘æ¼¸è®Šå‰µå»ºé‡è¤‡çš„åŠåœ“å½¢â€œå­”â€ */
    background-image: radial-gradient(circle at 50% 0, transparent 8px, #f0f2f5 8px);
    background-size: 25px 20px; /* æ§åˆ¶æ¯å€‹å­”çš„å¤§å°å’Œé–“è· */
    background-repeat: repeat-x;
}

/* 3. å‰µå»ºåº•éƒ¨çš„æ‰“å­”æ•ˆæœ */
#character-profile-modal .character-profile-content::after {
    content: '';
    position: absolute;
    bottom: -10px; /* å‘ä¸‹ç§»å‹•ï¼Œéœ²å‡ºä¸€åŠ */
    left: 0;
    right: 0;
    height: 20px; /* æ‰“å­”æ¢çš„é«˜åº¦ */
    /* æ ¸å¿ƒï¼šèˆ‡é ‚éƒ¨é¡ä¼¼ï¼Œä½†åœ“å¿ƒä½ç½®ç›¸å */
    background-image: radial-gradient(circle at 50% 100%, transparent 8px, #f0f2f5 8px);
    background-size: 25px 20px; /* æ§åˆ¶æ¯å€‹å­”çš„å¤§å°å’Œé–“è· */
    background-repeat: repeat-x;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¥¨æ ¹æ¨£å¼ç¾åŒ– (ç›´è§’ + ç´”ç™½èƒŒæ™¯) â–¼â–¼â–¼ */

/* 1. è¦†è“‹ä¸»å®¹å™¨æ¨£å¼ï¼Œæ”¹ç‚ºç›´è§’å’Œç™½è‰²èƒŒæ™¯ */
#character-profile-modal .character-profile-content {
    border-radius: 0;         /* æ ¸å¿ƒä¿®æ”¹1: ç§»é™¤åœ“è§’ï¼Œè®Šç‚ºç›´è§’ */
    background-color: #ffffff; /* æ ¸å¿ƒä¿®æ”¹2: å°‡èƒŒæ™¯è‰²æ”¹ç‚ºç´”ç™½è‰² */
}

/* 2. è¦†è“‹é ‚éƒ¨æ‰“å­”æ¢çš„é¡è‰²ï¼Œèˆ‡æ–°çš„ç™½è‰²èƒŒæ™¯çµ±ä¸€ */
#character-profile-modal .character-profile-content::before {
    /* æ ¸å¿ƒä¿®æ”¹3: å°‡æ‰“å­”æ¢çš„é¡è‰²å¾ç°è‰²æ”¹ç‚ºç´”ç™½è‰² */
    background-image: radial-gradient(circle at 50% 0, transparent 8px, #ffffff 8px);
}

/* 3. è¦†è“‹åº•éƒ¨æ‰“å­”æ¢çš„é¡è‰²ï¼Œèˆ‡æ–°çš„ç™½è‰²èƒŒæ™¯çµ±ä¸€ */
#character-profile-modal .character-profile-content::after {
    /* æ ¸å¿ƒä¿®æ”¹4: å°‡æ‰“å­”æ¢çš„é¡è‰²ä¹Ÿæ”¹ç‚ºç´”ç™½è‰² */
    background-image: radial-gradient(circle at 50% 100%, transparent 8px, #ffffff 8px);
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå¿ƒè²/æ•£è¨˜å¡ç‰‡æ·»åŠ ç¥¨æ ¹åˆ†å‰²ç·š â–¼â–¼â–¼ */

/* 1. ç‚ºé ­éƒ¨å€åŸŸï¼ˆæ™‚é–“æˆ³è¨˜ï¼‰æ·»åŠ ç›¸å°å®šä½å’Œç©ºé–“ï¼Œä½œç‚ºåˆ†å‰²ç·šçš„â€œéŒ¨é»â€ */
#character-profile-modal .thought-header {
    position: relative;
    width: 100%;
    /* å¢åŠ åº•éƒ¨å…§é‚Šè·ï¼Œç‚ºåˆ†å‰²ç·šå‰µé€ ç©ºé–“ */
    padding-bottom: 15px; 
    /* å¢åŠ åº•éƒ¨å¤–é‚Šè·ï¼Œå°‡ä¸‹æ–¹çš„â€œå¿ƒè²â€å…§å®¹æ¨é–‹ */
    margin-bottom: 25px; 
    /* é€™å°±æ˜¯ä¸­é–“çš„ç°è‰²è™›ç·š */
    border-bottom: 2px dashed #e0e0e0; 
}

/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ã€‘ç¥¨æ ¹åˆ†å‰²ç·šæ‰“å­”é€æ˜æ•ˆæœ â–¼â–¼â–¼ */


/* 2. é‡æ–°å‰µå»ºå·¦å´çš„â€œæ‰“å­”â€ï¼Œä½¿å…¶é¡è‰²èˆ‡é é¢èƒŒæ™¯ä¸€è‡´ */
#character-profile-modal .thought-header::before {
    content: '';
    position: absolute;
    bottom: -11px;
    left: -35px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    /* æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨é é¢çš„èƒŒæ™¯è‰² (#f0f2f5) ä¾†â€œå½è£â€é€æ˜æ•ˆæœ */
    background-color:  rgba(0, 0, 0, 0.3);
}

/* 3. é‡æ–°å‰µå»ºå³å´çš„â€œæ‰“å­”â€ */
#character-profile-modal .thought-header::after {
    content: '';
    position: absolute;
    bottom: -11px;
    right: -35px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    /* æ ¸å¿ƒä¿®å¾©ï¼šé¡è‰²èˆ‡é é¢èƒŒæ™¯ä¿æŒä¸€è‡´ */
    background-color:  rgba(0, 0, 0, 0.3);
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ç‰ˆã€‘è§’è‰²è³‡æ–™å¡å›ºå®šèƒŒæ™¯åœ–æ¨£å¼ (ç›´è§’) â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€æœ€çµ‚åœ–ç‰‡é¡¯ç¤ºä¿®å¾©ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ .thought-header æ¨£å¼ â–¼â–¼â–¼ */
#character-profile-modal .thought-header {
    height: 140px;         /* ä¿æŒå›ºå®šçš„ã€é˜²å£“ç¸®çš„é«˜åº¦ */
    flex-shrink: 0;
    padding: 10px;         /* åœ¨åœ–ç‰‡å››å‘¨ç•™å‡ºâ€œç•«æ¡†â€é‚Šè· */
    padding-bottom: 25px;  /* åŠ å¤§åº•éƒ¨é‚Šè·ï¼Œå°‡åœ–ç‰‡èˆ‡è™›ç·šåˆ†é–‹ */
    box-sizing: border-box;
    border-bottom: 2px dashed #e0e0e0; /* æ¢å¾©è™›ç·šåˆ†å‰²ç·š */
    margin-bottom: 25px;
    position: relative;     /* ä¿æŒï¼Œç‚ºäº†è®“æ‰“å­”èƒ½æ­£ç¢ºå®šä½ */

    /* --- æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡é‡æ–°æ·»åŠ èƒŒæ™¯åœ–ç‰‡ --- */
    background-image: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758340625111_qdqqd_zqr2cl.jpeg'); /* <-- è«‹åœ¨é€™è£¡æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„åœ–ç‰‡URL */
    background-size: cover;
    background-position: center top;
    border-radius: 0;      /* ç¢ºä¿åœ–ç‰‡å®¹å™¨æ˜¯ç›´è§’çš„ */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */

/* 2. ç§»é™¤ä¹‹å‰ç‚ºJSå‹•æ…‹åœ–ç‰‡æº–å‚™çš„æ¨£å¼ï¼ˆå¯é¸ï¼Œä½†æ¨è–¦ï¼‰ */
#profile-photo-slot {
    display: none; /* éš±è—æ‰JSå¯èƒ½å‰µå»ºçš„<img>æ¨™ç±¤ */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ã€‘éš”é›¢è³‡æ–™å¡æ¨£å¼ï¼Œé˜²æ­¢æ´©éœ²åˆ°æ­·å²è¨˜éŒ„ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ã€‘éš”é›¢è³‡æ–™å¡æ¨£å¼ï¼Œé˜²æ­¢æ´©éœ²åˆ°æ­·å²è¨˜éŒ„ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘ä½¿ç”¨æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨ï¼Œç¢ºä¿ç…§ç‰‡å€åŸŸåªå‡ºç¾åœ¨ä¸»è³‡æ–™é ä¸Š */
#character-profile-modal #profile-main-content .thought-header {
   // height: 120px;
    //padding-bottom: 15px; /* æ­¥é©Ÿ1ï¼šä¿ç•™è¶³å¤ çš„ç©ºé–“ï¼Œå°‡è™›ç·šå‘ä¸‹æ¨ */
    box-sizing: border-box;
    background-image: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758340625111_qdqqd_zqr2cl.jpeg');
    background-size: cover;
    background-position: center top;
    border-bottom: 2px dashed #e0e0e0;
    margin-bottom: 15px;
    
    /* â–¼â–¼â–¼ æ­¥é©Ÿ2ï¼šé€™å°±æ˜¯è§£æ±ºå•é¡Œçš„é—œéµï¼â–¼â–¼â–¼ */
    /* å¼·åˆ¶èƒŒæ™¯åœ–åªåœ¨å…§å®¹å€ç¹ªè£½ï¼Œä¸è¦é€²å…¥æˆ‘å€‘ç”¨paddingæ’é–‹çš„ç©ºç™½å€åŸŸ */
    background-clip: content-box; 
    -webkit-background-clip: content-box; /* ç›¸å®¹èˆŠç‰ˆæµè¦½å™¨ */
    /* â–²â–²â–² é—œéµä»£ç¢¼çµæŸ â–²â–²â–² */
}

/* 2. ã€æ ¸å¿ƒã€‘ç¢ºä¿æ‰“å­”æ•ˆæœä¹Ÿåªå‡ºç¾åœ¨ä¸»è³‡æ–™é ä¸Š */
#character-profile-modal #profile-main-content .thought-header::before,
#character-profile-modal #profile-main-content .thought-header::after {
    content: '';
    position: absolute;
    bottom: -11px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.3);
}
#character-profile-modal #profile-main-content .thought-header::before {
    left: -35px;
}
#character-profile-modal #profile-main-content .thought-header::after {
    right: -35px;
}

/* 3. ã€é‡è¦ã€‘å°‡æ­·å²è¨˜éŒ„é è£¡çš„å°å¡ç‰‡é ­éƒ¨æ¨£å¼ï¼Œå¼·åˆ¶æ¢å¾©ç‚ºåŸå§‹çš„ç°¡æ½”æ¨£å¼ */
#character-profile-modal #thoughts-history-list .thought-card .thought-header {
    height: auto;
    padding: 0;
    padding-bottom: 8px; /* æ¢å¾©åº•éƒ¨çš„å°é–“è· */
    margin-bottom: 12px;
    background-image: none; /* ç§»é™¤èƒŒæ™¯åœ– */
    border: none; /* ç§»é™¤æ‰€æœ‰é‚Šæ¡† */
    border-bottom: 1px solid #f0f0f0; /* åªä¿ç•™åº•éƒ¨çš„ç´°åˆ†å‰²ç·š */
}

/* 4. ã€é‡è¦ã€‘åœ¨æ­·å²è¨˜éŒ„çš„å°å¡ç‰‡ä¸Šï¼Œå¼·åˆ¶éš±è—æ‰æ‰“å­”çš„å½å…ƒç´  */
#character-profile-modal #thoughts-history-list .thought-card .thought-header::before,
#character-profile-modal #thoughts-history-list .thought-card .thought-header::after {
    display: none !important; /* å¼·åˆ¶ä¸é¡¯ç¤º */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒè²/æ•£è¨˜ç¾åŒ–èˆ‡å­—é«”ä¿®å¾© â–¼â–¼â–¼ */

/* 
  ç¬¬ä¸€æ­¥ï¼šå¼·åˆ¶é¡¯ç¤ºâ€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€çš„æ¨™ç±¤ã€‚
  æˆ‘å€‘ä½¿ç”¨ !important ä¾†ç¢ºä¿é€™æ¢è¦å‰‡çš„å„ªå…ˆé †åºæœ€é«˜ï¼Œ
  å¯ä»¥è¦†è“‹æ‰ä»»ä½•ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ display: none; éš±è—è¦å‰‡ã€‚
*/
#character-profile-modal #profile-main-content .label {
    display: flex !important;
}

/* 
  ç¬¬äºŒæ­¥ï¼šç‚ºâ€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€çš„æ­£æ–‡å…§å®¹æ›´æ›å­—é«”ã€‚
  é€™è£¡ä»¥å¸¸è¦‹çš„å®‹é«”(SimSun)ç‚ºä¾‹ï¼Œæ‚¨å¯ä»¥æ›¿æ›æˆä»»ä½•æ‚¨å–œæ­¡çš„å­—é«”åç¨±ã€‚
*/
#character-profile-modal #profile-main-content .text {
    font-family: "SimSun", "Songti SC", serif; /* ç¤ºä¾‹ï¼šæ›´æ›ç‚ºå®‹é«” */
    font-size: 16px; /* (å¯é¸) ç¨å¾®æ”¾å¤§å­—é«”ï¼Œè®“å®‹é«”æ›´æ¸…æ™° */
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ã€‘å¼·åˆ¶å°‡å¿ƒè²/æ•£è¨˜å…§å®¹è®Šç‚ºç´”é»‘è‰² â–¼â–¼â–¼ */

/* 1. å°‡â€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€çš„æ¨™é¡Œæ–‡å­—å’Œåœ–ç¤ºè®Šç‚ºé»‘è‰² */
#character-profile-modal .thought-content .label {
    color: #000000 !important;
}

/* 2. å°‡â€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€çš„æ­£æ–‡æ®µè½æ–‡å­—è®Šç‚ºé»‘è‰² */
#character-profile-modal .thought-content .text {
    color: #000000 !important;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®å¾©å¿ƒè²/è³‡æ–™å¡é é¢å·¦å³æ»‘å‹•å•é¡Œ â–¼â–¼â–¼ */
#character-profile-modal #profile-main-content {
    overflow-x: hidden;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…åŒ…åˆ†é¡åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

        /* 1. åˆ†é¡é ç°½å®¹å™¨æ¨£å¼ */
        #sticker-category-tabs {
            display: flex;
            overflow-x: auto;
            padding: 0 15px; /* å·¦å³ç•™ç™½ */
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            /* éš±è—æ²è»¸ */
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #sticker-category-tabs::-webkit-scrollbar {
            display: none;
        }

        /* 2. å–®å€‹é ç°½æŒ‰éˆ•æ¨£å¼ */
        .sticker-category-tab {
            padding: 10px 16px; /* å¢åŠ ä¸Šä¸‹å…§é‚Šè·ï¼Œè®“é ç°½æ›´é«˜ä¸€äº› */
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* è®“åº•é‚Šæ¡†èˆ‡å®¹å™¨é‚Šæ¡†é‡åˆ */
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* é˜²æ­¢åˆ†é¡åæ›è¡Œ */
        }

        /* 3. å•Ÿå‹•çš„é ç°½æ¨£å¼ */
        .sticker-category-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }

        #phone-screen.dark-mode .sticker-category-tab.active {
            color: #ffffff;
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆªé™¤èˆ‡å…¨é¸åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç‚ºè¡¨æƒ…é …æ·»åŠ ä¸€å€‹é¸ä¸­æ¡† */
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            pointer-events: none; /* ç¢ºä¿ä¸å½±éŸ¿é»æ“Š */
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œè¢«é¸ä¸­çš„è¡¨æƒ…é …ï¼Œé¡¯ç¤ºè—è‰²é‚Šæ¡† */
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç¸½æ˜¯é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        
        /* ã€å…¨æ–°ã€‘åº•éƒ¨æ‰¹é‡åˆªé™¤æ“ä½œæ¬„ */
        #sticker-action-bar {
            display: none; /* é»˜èªéš±è— */
            flex-shrink: 0;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            justify-content: space-between; /* è®“â€œå…¨é¸â€å’Œâ€œåˆªé™¤â€å…©ç«¯å°é½Š */
            align-items: center;
        }
        
        #sticker-action-bar .select-all-label {
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
        }

        #sticker-action-bar button {
            padding: 10px 25px;
            border-radius: 20px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° V2.0ã€‘CphoneåŠŸèƒ½çš„æ‰€æœ‰CSSæ¨£å¼ â–¼â–¼â–¼ */

/* --- 1. è§’è‰²é¸æ“‡ä»‹é¢ (ä¿æŒä¸è®Š) --- */
#character-selection-screen { background-color: #f0f2f5; }
#phone-screen.dark-mode #character-selection-screen { background-color: #000; }
/* --- è«‹ç”¨é€™ä¸€æ•´å¡Šã€å…¨æ–°ã€‘çš„CSSï¼Œæ›¿æ›èˆŠçš„ #character-grid å’Œ .character-select-item ç›¸é—œçš„æ‰€æœ‰æ¨£å¼ --- */

/* 1. å°‡ç¶²æ ¼å®¹å™¨è®Šç‚ºåˆ—è¡¨å®¹å™¨ */
#character-grid {
    /* ç§»é™¤äº† display: grid å’Œç›¸é—œå±¬æ€§ */
    padding: 0; /* ç§»é™¤å…§é‚Šè·ï¼Œç”±åˆ—è¡¨é …è‡ªå·±æ§åˆ¶ */
    overflow-y: auto; /* ç¢ºä¿å…§å®¹è¶…å‡ºæ™‚å¯ä»¥æ»¾å‹• */
    flex-grow: 1;
}

/* 2. ä¿®æ”¹æ¯å€‹åˆ—è¡¨é …çš„ä½ˆå±€ï¼Œå¾å‚ç›´è®Šç‚ºæ°´æº– */
.character-select-item {
    display: flex;
    flex-direction: row;     /* æ ¸å¿ƒä¿®æ”¹ï¼šå¾ column è®Šç‚º row */
    align-items: center;     /* ä¿æŒå‚ç›´å±…ä¸­ */
    cursor: pointer;
    padding: 12px 20px;      /* å¢åŠ å…§é‚Šè·ï¼Œå½¢æˆåˆ—è¡¨é …å¤–è§€ */
    border-bottom: 1px solid var(--border-color); /* æ·»åŠ åˆ†å‰²ç·š */
    gap: 15px;               /* åœ¨é ­åƒå’Œåå­—ä¹‹é–“å¢åŠ é–“è· */
    transition: background-color 0.2s; /* æ·»åŠ æ‡¸åœæ•ˆæœ */
    /* ç§»é™¤äº† text-align: center */
}
.character-select-item:hover {
    background-color: #f5f5f5; /* æ»‘é¼ æ‡¸åœæ™‚é«˜äº® */
}


/* 3. èª¿æ•´é ­åƒå¤§å°å’Œæ¨£å¼ */
.character-select-item .avatar {
    width: 45px;             /* æ ¸å¿ƒä¿®æ”¹ï¼šç¸®å°é ­åƒå°ºå¯¸ */
    height: 45px;
    border-radius: 50%;      /* æ”¹ç‚ºåœ“å½¢ï¼Œæ›´é©åˆåˆ—è¡¨è¦–åœ– */
    object-fit: cover;
    margin-bottom: 0;        /* ç§»é™¤åº•éƒ¨å¤–é‚Šè· */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
    flex-shrink: 0;          /* é˜²æ­¢é ­åƒè¢«å£“ç¸® */
}

/* 4. èª¿æ•´åå­—æ¨£å¼ */
.character-select-item .name {
    font-weight: 500;
    font-size: 16px;         /* ç¨å¾®å¢å¤§å­—é«”ï¼Œæé«˜å¯è®€æ€§ */
    color: var(--text-primary);
}
/* --- æ›¿æ›çµæŸ --- */

/* --- 2. Cphoneä¸»å®¹å™¨èˆ‡è¢å¹•åˆ‡æ› (ä¿æŒä¸è®Š) --- */
#character-phone-screen { background-size: cover; background-position: center; }
.char-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
.char-screen.active { opacity: 1; visibility: visible; z-index: 2; }

/* --- 3. Cphoneä¸»è¢å¹• (ä¿æŒä¸è®Š) --- */
#char-home-screen { justify-content: flex-start; align-items: center; box-sizing: border-box; padding: 0 20px; }
#char-clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-top: calc(60px + env(safe-area-inset-top)); flex-shrink: 0; margin-bottom: 100px; }
#char-main-time { font-size: 88px; font-weight: 600; letter-spacing: -2px; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; }
#char-main-date { font-size: 22px; font-weight: normal; }
#char-app-grid { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }

/* --- 4. Cphoneå…§çš„Appé€šç”¨èƒŒæ™¯è‰² (å·²æ“´å±•) --- */
#char-qq-screen, #char-memo-screen, #char-diary-screen, #char-usage-screen, 
#char-album-screen, #char-browser-screen, #char-taobao-screen {
     background-color: var(--secondary-bg);
}

/* --- 5. å‚™å¿˜éŒ„ã€æ—¥è¨˜ã€ä½¿ç”¨è¨˜éŒ„æ¸…å–®æ¨£å¼ (ä¿æŒä¸è®Š) --- */
.memo-item, .diary-item, .usage-item { padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
.memo-item .content, .diary-item .content { font-size: 16px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.diary-item .date, .usage-item .timestamp { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
.usage-item .action { font-size: 15px; color: var(--text-primary); }

/* --- 6. ã€å…¨æ–°ã€‘è§’è‰²ç›¸å†Šæ¨£å¼ --- */
#char-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* æ¯è¡Œ3å¼µåœ– */
    gap: 5px;
    padding: 5px;
}
.char-photo-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    background-color: #e9ecef;
}

/* --- 7. ã€å…¨æ–°ã€‘è§’è‰²æµè¦½å™¨æ­·å²æ¨£å¼ --- */
.char-browser-item {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-color);
}
.char-browser-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
    margin-bottom: 4px;
}
.char-browser-item .url {
    font-size: 12px;
    color: var(--accent-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- 8. ã€å…¨æ–°ã€‘è§’è‰²æ·˜å¯¶é é¢æ¨£å¼ (è¤‡ç”¨ä¸»è³¼ç‰©é æ¨£å¼) --- */
#char-product-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 10px;
}
.char-product-item {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
}
.char-product-item .product-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
}
.char-product-item .product-info {
    padding: 12px 10px;
    flex-grow: 1;
}
.char-product-item .product-name {
    font-size: 13px;
    color: #333;
    line-height: 1.4;
    min-height: 36px;
}
.char-product-item .product-price {
    font-size: 16px;
    font-weight: 700;
    color: #ff5722;
    margin-top: 8px;
}
.char-product-item .product-price::before { content: 'Â¥'; font-size: 12px; }

/* â–²â–²â–² å…¨æ–°CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0ã€‘CphoneQQé¡æ¯”åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
#char-qq-screen .list-container {
    padding: 0; /* ç§»é™¤å®¹å™¨çš„å…§é‚Šè· */
}
/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneQQé¡æ¯”èŠå¤©è¨˜éŒ„å½ˆçª—æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“å½ˆçª—å…§å®¹å€æ“æœ‰å’Œä¸»èŠå¤©ä»‹é¢ä¸€æ¨£çš„ä½ˆå±€ */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 20px; /* æ¶ˆæ¯æ°£æ³¡ä¹‹é–“çš„é–“è· */
    padding: 15px; /* å…§é‚Šè· */
    background-color: #f0f2f5;
}

/* 2. å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #transcript-modal-body {
    background-color: #000000;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€çµ‚ä½ˆå±€ä¿®å¾©ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰æ‚¨ä¸Šä¸€æ¬¡é»è²¼çš„ #char-chat-list ç›¸é—œçš„CSS â–¼â–¼â–¼ */

/* 1. ç‚ºå…©å€‹åˆ—è¡¨çš„åˆ—è¡¨é …ï¼ˆä¸»QQåˆ—è¡¨å’Œè§’è‰²QQåˆ—è¡¨ï¼‰è¨­ç½®çµ±ä¸€çš„ Flexbox ä½ˆå±€ */
#chat-list .chat-list-item,
#char-chat-list .chat-list-item {
    display: flex;
    align-items: center;
    gap: 15px; /* ã€æ ¸å¿ƒä¿®å¾©1ã€‘ä½¿ç”¨ gap å±¬æ€§åœ¨é ­åƒå’Œæ–‡å­—ä¹‹é–“å‰µå»ºé–“è·ï¼Œé€™æ¯” margin æ›´ç¾ä»£ã€æ›´å¯é  */
}

/* 2. ç¢ºä¿é ­åƒå®¹å™¨ï¼ˆç„¡è«–åœ¨å“ªä¸€å€‹åˆ—è¡¨ä¸­ï¼‰éƒ½çµ•å°ä¸æœƒè¢«å£“ç¸® */
#chat-list .chat-list-item .avatar-group,
#char-chat-list .chat-list-item .avatar-group {
    flex-shrink: 0;
    /* ç§»é™¤äº†èˆŠçš„ margin-rightï¼Œå› ç‚ºç¾åœ¨ç”±çˆ¶å…ƒç´ çš„ gap å±¬æ€§çµ±ä¸€æ§åˆ¶é–“è· */
}

/* 3. ç¢ºä¿æ–‡å­—è³‡è¨Šå€åŸŸï¼ˆç„¡è«–åœ¨å“ªä¸€å€‹åˆ—è¡¨ä¸­ï¼‰éƒ½èƒ½å¤ æ­£ç¢ºåœ°ä¼¸ç¸® */
#chat-list .chat-list-item .info,
#char-chat-list .chat-list-item .info {
    flex-grow: 1;
    min-width: 0; /* é—œéµï¼å…è¨±å®¹å™¨æ”¶ç¸®ï¼Œå¾è€Œé˜²æ­¢å…§éƒ¨çš„é•·æ–‡å­—æ’ç ´ä½ˆå±€å°è‡´é‡ç–Š */
}
/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneQQé¡æ¯”å°è©±é é¢ç¾åŒ–æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“å½ˆçª—å…§å®¹å€æ“æœ‰å’Œä¸»èŠå¤©ä»‹é¢ä¸€æ¨£çš„ä½ˆå±€ */
#char-qq-conversation-screen .list-container {
    display: flex;
    flex-direction: column;
    gap: 20px; /* <-- æ ¸å¿ƒï¼šæ·»åŠ 20pxçš„é–“è· */
    padding: 15px; /* <-- æ–°å¢ï¼šåœ¨å››å‘¨å¢åŠ å…§é‚Šè·ï¼Œé¿å…æ°£æ³¡è²¼é‚Š */
    background-color: #f0f2f5;
}

/* 2. å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #char-qq-conversation-screen .list-container {
    background-color: #000000;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneAppé€šç”¨èƒŒæ™¯è‰² (å·²ä¿®å¾©) â–¼â–¼â–¼ */
#char-qq-screen, 
#char-memo-screen, 
#char-diary-screen, 
#char-usage-screen, 
#char-album-screen, 
#char-browser-screen, 
#char-taobao-screen,
/* --- ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡æ–°çš„æ–‡ç« é é¢ä¹ŸåŠ å…¥é€™å€‹è¦å‰‡ï¼Œç¢ºä¿å®ƒæœ‰æ­£ç¢ºçš„èƒŒæ™¯è‰² --- */
#char-browser-article-screen {
     background-color: var(--secondary-bg);
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneAppé€šç”¨èƒŒæ™¯è‰² (å·²ä¿®å¾©éŒ¢åŒ…é é¢) â–¼â–¼â–¼ */
#char-qq-screen, 
#char-memo-screen, 
#char-diary-screen, 
#char-usage-screen, 
#char-album-screen, 
#char-browser-screen, 
#char-taobao-screen,
#char-browser-article-screen,
/* --- ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡æ–°çš„éŒ¢åŒ…é é¢ä¹ŸåŠ å…¥é€™å€‹è¦å‰‡ï¼Œç¢ºä¿å®ƒæœ‰æ­£ç¢ºçš„èƒŒæ™¯è‰² --- */
#char-wallet-screen {
     background-color: var(--secondary-bg);
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Cphoneå‚™å¿˜éŒ„è©³æƒ…é æ¨£å¼ â–¼â–¼â–¼ */

#char-memo-detail-content {
    width: 100%;
    height: 100%;
    border: none;
    background-color: transparent;
    font-size: 16px;
    line-height: 1.7; /* å¢åŠ è¡Œé«˜ï¼Œæ›´æ˜“è®€ */
    padding: 15px 20px; /* å¢åŠ å·¦å³å…§é‚Šè· */
    box-sizing: border-box;
    resize: none; /* ç¦æ­¢ç”¨æˆ¶æ‹–å‹•èª¿æ•´å¤§å° */
    outline: none; /* ç§»é™¤é¸ä¸­æ™‚çš„è—è‰²é‚Šæ¡† */
    font-family: inherit; /* ç¹¼æ‰¿é é¢å­—é«” */
    color: var(--text-primary); /* ç¢ºä¿æ–‡å­—é¡è‰²èƒ½é©é…å¤œé–“æ¨¡å¼ */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Cphoneå‚™å¿˜éŒ„è©³æƒ…é ç¾åŒ– (ä»¿iOS Notes App) â–¼â–¼â–¼ */

/* 1. è®“è©³æƒ…é æ“æœ‰è‡ªå·±çš„ã€èƒ½é©é…å¤œé–“æ¨¡å¼çš„èƒŒæ™¯è‰² */
#char-memo-detail-screen {
    background-color: var(--secondary-bg);
}

/* 2. ç¾åŒ–é ­éƒ¨ï¼Œæ·»åŠ åˆ†å‰²ç·šï¼Œä¸¦èª¿æ•´å…§é‚Šè· */
#char-memo-detail-screen .header {
    background-color: var(--secondary-bg); /* èˆ‡é é¢èƒŒæ™¯è‰²çµ±ä¸€ */
    border-bottom: 1px solid var(--border-color); /* æ·»åŠ ç²¾ç·»çš„åˆ†å‰²ç·š */
    
    padding-bottom: 10px;
}

/* 3. ã€æ ¸å¿ƒã€‘å¼·åˆ¶æ¨™é¡Œå±…ä¸­é¡¯ç¤º */
#char-memo-detail-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-weight: 600; /* æ¨™é¡ŒåŠ ç²— */
}

/* 4. ç§»é™¤å…§å®¹å®¹å™¨çš„é è¨­å…§é‚Šè·ï¼Œè®“æ–‡æœ¬å€èƒ½æ’æ»¿ */
#char-memo-detail-screen .form-container {
    padding: 0;
}

/* 5. ç¾åŒ–æ–‡æœ¬å€åŸŸï¼Œä½¿å…¶çœ‹èµ·ä¾†åƒä¸€å€‹çœŸæ­£çš„ç­†è¨˜é é¢ */
#char-memo-detail-content {
    background-color: var(--secondary-bg); /* èƒŒæ™¯è‰²èˆ‡é ­éƒ¨çµ±ä¸€ï¼Œå½¢æˆæ•´é«”æ„Ÿ */
    padding: 15px 20px; /* å¢åŠ é ‚éƒ¨å’Œå·¦å³çš„å…§é‚Šè·ï¼Œè®“æ–‡å­—æœ‰å‘¼å¸ç©ºé–“ */
    font-size: 17px; /* ä»¿iOSå‚™å¿˜éŒ„çš„å­—é«”å¤§å° */
    line-height: 1.7; /* æ›´å¯¬é¬†çš„è¡Œé«˜ï¼Œæå‡é–±è®€é«”é©— */
    color: var(--text-primary);
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Cphoneæ—¥è¨˜è©³æƒ…é â€œä¿¡ç´™â€æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è©³æƒ…é ä¸»è¢å¹•ï¼Œä½¿ç”¨æŸ”å’Œçš„ç±³ç™½è‰²èƒŒæ™¯ */
#char-diary-detail-screen {
    background-color: #FDFBF5; /* æŸ”å’Œçš„ä¿¡ç´™åº•è‰² */
}

/* å¤œé–“æ¨¡å¼ä¸‹çš„é©é… */
#phone-screen.dark-mode #char-diary-detail-screen {
    background-color: #2c2c2e; /* æ·±è‰²èƒŒæ™¯ */
}

/* 2. ç§»é™¤å…§å®¹å€çš„é è¨­å…§é‚Šè·ï¼Œè®“æˆ‘å€‘çš„â€œä¿¡ç´™â€èƒ½æ’æ»¿ */
#char-diary-detail-content-wrapper {
    padding: 0;
    overflow-y: auto; /* ç¢ºä¿é•·æ—¥è¨˜å¯ä»¥æ»¾å‹• */
}

/* 3. â€œä¿¡ç´™â€æœ¬èº«çš„æ ¸å¿ƒæ¨£å¼ */
#char-diary-detail-content {
    padding: 25px 20px; /* åœ¨ä¿¡ç´™å››å‘¨ç•™å‡ºèˆ’é©çš„é‚Šè· */
    font-family: Georgia, 'Times New Roman', Times, serif; /* ä½¿ç”¨æ›´å…¸é›…çš„è¥¯ç·šå­—é«” */
    font-size: 16px;
    line-height: 1.8; /* æ›´å¤§çš„è¡Œé«˜ï¼Œæå‡é–±è®€æ„Ÿ */
    color: #383838; /* ä½¿ç”¨æ·±ç°è‰²æ–‡å­—ï¼Œæ¯”ç´”é»‘æ›´æŸ”å’Œ */
}

/* å¤œé–“æ¨¡å¼ä¸‹çš„æ–‡å­—é¡è‰² */
#phone-screen.dark-mode #char-diary-detail-content {
    color: #e0e0e0;
}

/* 4. ç‚ºæ—¥è¨˜çš„ç¬¬ä¸€è¡Œï¼ˆé€šå¸¸æ˜¯æ¨™é¡Œï¼‰è¨­ç½®ç‰¹æ®Šæ¨£å¼ */
#char-diary-detail-content > p:first-of-type {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}

/* 5. ç¢ºä¿Markdownè½‰æ›å¾Œçš„æ¨™ç±¤æ¨£å¼æ­£ç¢º */
#char-diary-detail-content strong {
    font-weight: 600; /* åŠ ç²— */
}
#char-diary-detail-content .spoiler {
    /* é€™è£¡çš„æ¨£å¼èˆ‡ä¸»èŠå¤©ä»‹é¢ä¿æŒä¸€è‡´ */
    background-color: #333;
    color: #333;
    padding: 0 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
#char-diary-detail-content .spoiler:hover {
    background-color: #e0e0e0;
    color: inherit;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ—¥è¨˜è©³æƒ…é è‡ªè¨‚Markdownæ¨£å¼ â–¼â–¼â–¼ */

/* 0. å¼•å…¥å¤–éƒ¨æ‰‹å¯«å­—é«” (Google Fonts) */
@import url('https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap');

/* 1. é»ƒè‰²èƒŒæ™¯é«˜äº® */
#char-diary-detail-content .diary-highlight {
    background-color: #FFFACD; /* æª¸æª¬ç¶¢è‰²ï¼Œä¸€ç¨®æŸ”å’Œçš„é»ƒè‰² */
    padding: 1px 4px;
    border-radius: 3px;
    margin: 0 2px;
}

/* 2. ç²‰è‰²è™›ç·šåº•ç·š */
#char-diary-detail-content .diary-underline {
    border-bottom: 2px dotted #FFB6C1; /* æ·ºç²‰è‰² */
    text-decoration: none; /* ç§»é™¤é»˜èªçš„å¯¦ç·šåº•ç·š */
    padding-bottom: 1px;
}

/* 3. ç²‰ç´…è‰²åŠ ç²—æ–‡å­— */
#char-diary-detail-content .diary-emphasis {
    color: #DB7093; /* ç°ç´«è‰² */
    font-weight: bold;
}

/* 4. æ‰‹å¯«é«”é»‘è‰²æ–‡å­— */
#char-diary-detail-content .diary-handwritten {
    font-family: 'Zhi Mang Xing', cursive; /* æ‡‰ç”¨æ‰‹å¯«å­—é«” */
    font-size: 1.1em; /* æ‰‹å¯«é«”ç¨å¾®å¤§ä¸€é»æ›´å¥½çœ‹ */
    color: #1a1a1a; /* æ¯”ç´”é»‘æ›´æŸ”å’Œçš„æ·±ç°è‰² */
}

/* 5. ç¨å¾®å‚¾æ–œçš„æ‰‹å¯«é«”æ–‡å­— */
#char-diary-detail-content .diary-messy {
    font-family: 'Zhi Mang Xing', cursive;
    font-size: 1.1em;
    color: #1a1a1a;
    transform: rotate(-2deg); /* è¼•å¾®æ—‹è½‰ */
    display: inline-block; /* æ—‹è½‰éœ€è¦ display å±¬æ€§é…åˆ */
    margin: 0 2px;
}

/* 6. è¢«å¡—é»‘çš„å…§å®¹ */
#char-diary-detail-content .diary-censored {
    background-color: #222;
    color: #222; /* è®“æ–‡å­—é¡è‰²å’ŒèƒŒæ™¯è‰²ä¸€æ¨£ï¼Œå¯¦ç¾å¡—é»‘æ•ˆæœ */
    user-select: none; /* é˜²æ­¢ä½¿ç”¨è€…é€šéé¸ä¸­ä¾†æŸ¥çœ‹å…§å®¹ */
    padding: 0 3px;
    border-radius: 2px;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
.diary-censored:hover, .diary-censored:active {
  background-color: #E0E0E0; /* æ»‘é¼ æ‡¸åœæ™‚è®Šæˆæ·ºç°è‰²èƒŒæ™¯ */
  color: inherit; /* æ¢å¾©ç‚ºæ­£å¸¸çš„æ–‡å­—é¡è‰² */
  cursor: pointer; /* æ»‘é¼ è®Šç‚ºå¯é»æ“Šçš„æ‰‹å‹ */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²é«˜å¾·åœ°åœ–åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ä¸»è¢å¹•èƒŒæ™¯è‰² */
#char-amap-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-amap-screen {
    background-color: #000000;
}

/* 2. è¶³è·¡åˆ—è¡¨å®¹å™¨ */
#char-amap-list {
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 18px; /* å¢åŠ è¶³è·¡ä¹‹é–“çš„é–“è· */
}

/* 3. å–®å€‹è¶³è·¡å¡ç‰‡ */
.char-amap-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column; /* è®“å…§å®¹å‚ç›´æ’åˆ— */
}

/* 4. å¡ç‰‡é ­éƒ¨ (åœ–ç¤º + åœ°é»è³‡è¨Š) */
.amap-item-header {
    display: flex;
    align-items: flex-start; /* åœ–ç¤ºå’Œæ–‡å­—é ‚éƒ¨å°é½Š */
    gap: 12px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 12px;
    margin-bottom: 12px;
}

/* 5. åœ°é»åœ–ç¤º */
.amap-item-icon {
    font-size: 24px;
    color: var(--accent-color);
    margin-top: 2px;
}

/* 6. åœ°é»è³‡è¨Š (æ¨™é¡Œ + ä½å€) */
.amap-item-info {
    flex-grow: 1;
}
.amap-item-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}
.amap-item-address {
    font-size: 13px;
    color: var(--text-secondary);
}

/* 7. å¡ç‰‡ä¸»é«” (è©•è«– + åœ–ç‰‡) */
.amap-item-body {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.amap-item-comment {
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap; /* æ”¯æŒæ›è¡Œ */
}

/* 8. è¶³è·¡é™„å¸¶çš„åœ–ç‰‡ */
.amap-item-photo {
    width: 100%;
    height: 150px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    cursor: pointer;
}

/* 9. å¡ç‰‡åº•éƒ¨ (æ™‚é–“æˆ³è¨˜) */
.amap-item-footer {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 10px;
    text-align: right;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²Appä½¿ç”¨è¨˜éŒ„åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. åˆ—è¡¨å®¹å™¨ */
#char-usage-list {
    padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ï¼Œå·¦å³ç”±åˆ—è¡¨é …æ§åˆ¶ */
}

/* 2. å–®å€‹Appè¨˜éŒ„é … */
.char-usage-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 20px;
    transition: background-color 0.2s;
}
.char-usage-item:hover {
    background-color: rgba(0,0,0,0.03);
}

/* 3. Appåœ–ç¤º */
.usage-item-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px; /* iOSé¢¨æ ¼çš„åœ“è§’çŸ©å½¢ */
    object-fit: cover;
    flex-shrink: 0;
    background-color: #e9ecef;
}

/* 4. ä¸­é–“è³‡è¨Šå€ (Appå + åˆ†é¡) */
.usage-item-info {
    flex-grow: 1; /* ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
}
.usage-item-name {
    font-weight: 500;
    font-size: 16px;
}
.usage-item-category {
    font-size: 12px;
    color: var(--text-secondary);
}

/* 5. å³å´æ™‚é•·é¡¯ç¤º */
.usage-item-time {
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 500;
    flex-shrink: 0;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²ç¶²æ˜“é›²éŸ³æ¨‚åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ä¸»è¢å¹•èƒŒæ™¯è‰² */
#char-music-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-music-screen {
    background-color: #000000;
}

/* 2. æ­Œæ›²åˆ—è¡¨å®¹å™¨ */
#char-music-list {
    padding: 0;
}

/* 3. å–®å€‹æ­Œæ›²åˆ—è¡¨é … (ä»¿ç¶²æ˜“é›²é¢¨æ ¼) */
.char-music-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.char-music-item:hover {
    background-color: rgba(0,0,0,0.03);
}

/* 4. æ­Œæ›²å°é¢ */
.music-item-cover {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

/* 5. æ­Œæ›²ä¿¡æ¯ (æ­Œå + æ­Œæ‰‹) */
.music-item-info {
    flex-grow: 1;
    overflow: hidden; /* é˜²æ­¢é•·æ–‡æœ¬æº¢å‡º */
}
.music-item-name {
    font-weight: 500;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.music-item-artist {
    font-size: 12px;
    color: var(--text-secondary);
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ä½ è¦ã€æ·»åŠ ã€‘åˆ° <style> æ¨™ç±¤æœ«å°¾çš„ã€å…¨æ–°æ’­æ”¾æ©ŸCSSä»£ç¢¼ã€‘ â–¼â–¼â–¼ */

/* 1. æ’­æ”¾æ©Ÿä¸»è¦–çª—æ¨£å¼ */
#char-music-player-modal .modal-content {
    width: 400px !important; /* å›ºå®šå¯¬åº¦ */
    height: auto !important; /* é«˜åº¦è‡ªæˆ‘èª¿æ•´ */
    max-height: 90vh;
    background-color: #f7f8fa !important; /* æ·ºç°è‰²èƒŒæ™¯ */
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
}

/* 2. é ­éƒ¨æ¨™é¡Œåˆ— */
#char-music-player-modal .char-player-header {
    flex-shrink: 0;
    padding: 12px 15px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
}
#char-music-player-modal .char-player-close-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #aaa;
    cursor: pointer;
}
#char-music-player-modal .char-player-close-btn:hover {
    color: #333;
}


/* 3. ä¸»å…§å®¹å€ï¼ˆå°é¢ã€é€²åº¦æ¢ã€æŒ‰éˆ•ï¼‰ */
#char-music-player-modal .char-player-body {
    padding: 30px 35px 20px 35px;
    text-align: center;
}
#char-music-player-modal #char-music-cover {
    width: 220px;
    height: 220px;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    margin-bottom: 20px;
    object-fit: cover;
}

/* 4. é€²åº¦æ¢æ¨£å¼ */
#char-music-player-modal .char-player-progress-bar-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1;
    height: 4px;
    background-color: #e0e0e0;
    border-radius: 2px;
    cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%;
    height: 100%;
    background-color: #555;
    border-radius: 2px;
}

/* 5. æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
#char-music-player-modal .char-player-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none;
    border: none;
    color: #555;
    cursor: pointer;
    transition: color 0.2s;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover {
    color: #000;
}
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px;
    height: 50px;
    background-color: #f0f1f3;
    border-radius: 50%;
    color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px;
    font-weight: 500;
    width: 50px;
}

/* 6. æ­Œè©å€åŸŸæ¨£å¼ */
#char-music-player-modal #char-music-lyrics {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 35px 25px 35px;
    font-size: 14px;
    line-height: 2;
    color: #888;
    text-align: center;
}
#char-music-player-modal #char-music-lyrics p.active {
    color: #000;
    font-weight: 600;
}

/* éš±è—æ²è»¸ */
#char-music-player-modal #char-music-lyrics::-webkit-scrollbar {
    display: none;
}
#char-music-player-modal #char-music-lyrics {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ä½ è¦ã€æ·»åŠ ã€‘åˆ° <style> æ¨™ç±¤æœ«å°¾çš„ã€å…¨æ–°æ’­æ”¾æ©ŸCSS V3.0ã€‘ â–¼â–¼â–¼ */

/* 1. å®šç¾©å”±ç‰‡æ—‹è½‰å‹•ç•« */
@keyframes spin-vinyl {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* 2. æ’­æ”¾æ©Ÿä¸»è¦–çª—æ¨£å¼ */
#char-music-player-modal .modal-content {
    width: 340px !important; /* å¯¬åº¦é©ä¸­ */
    height: auto !important;
    background-color: #f0f1f3 !important; /* è¼•æŸ”çš„ç°è‰²èƒŒæ™¯ */
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
    padding: 20px; /* çµ±ä¸€å…§é‚Šè· */
    position: relative;
}

/* 3. ç§»é™¤èˆŠçš„é ­éƒ¨ï¼Œå› ç‚ºé—œé–‰æŒ‰éˆ•å·²ç¨ç«‹ */
#char-music-player-modal .modal-header {
    display: none !important;
}

/* 4. å³ä¸Šè§’é—œé–‰æŒ‰éˆ• */
#char-music-player-modal .char-player-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: 300;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
}

/* 5. ä¸»å…§å®¹å€ */
#char-music-player-modal .char-player-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
}

/* 6. æ­Œæ›²ä¿¡æ¯ */
#char-music-player-modal .char-player-song-info {
    text-align: center;
    margin-bottom: 25px;
}
#char-music-player-modal #char-music-player-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 5px 0;
}
#char-music-player-modal #char-music-artist {
    font-size: 14px;
    color: #888;
    margin: 0;
}

/* 7. é»‘è† å”±ç‰‡æ•ˆæœ */
#char-music-player-modal #char-vinyl-container {
    width: 210px;
    height: 210px;
    border-radius: 50%;
    background-color: #222;
    padding: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
    margin-bottom: 25px;
}
#char-music-player-modal #char-vinyl-container.spinning {
    animation: spin-vinyl 12s linear infinite;
}
#char-music-player-modal #char-music-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 8. æ­Œè©é ç•™ä½ç½® (éŸ³ç¬¦) */
#char-music-player-modal #char-lyric-placeholder {
    color: #aaa;
    font-size: 18px;
    letter-spacing: 5px;
    margin-bottom: 25px;
}

/* 9. åº•éƒ¨æ§åˆ¶æ¬„ */
#char-music-player-modal .char-player-footer {
    width: 100%;
    margin-top: auto; /* å°‡å…¶æ¨åˆ°åº•éƒ¨ */
}

/* 10. é€²åº¦æ¢å’Œæ§åˆ¶æŒ‰éˆ• (èˆ‡ä¸Šä¸€ç‰ˆé¡ä¼¼ï¼Œä½†classå·²æ›´æ–°) */
#char-music-player-modal .char-player-progress-bar-container {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1; height: 4px; background-color: #e0e0e0; border-radius: 2px; cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%; height: 100%; background-color: #555; border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none; border: none; color: #555; cursor: pointer; transition: color 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover { color: #000; }
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px; height: 50px; background-color: #e0e1e3; border-radius: 50%; color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px; font-weight: 500; width: 50px;
}
#char-music-player-modal #char-music-lyrics {
    display: none; /* åœ¨é€™å€‹ç‰ˆæœ¬ä¸­ï¼Œæˆ‘å€‘å¾¹åº•éš±è—æ­Œè©å€åŸŸ */
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ é€™æ˜¯ä½ è¦ã€æ·»åŠ ã€‘åˆ° <style> æ¨™ç±¤æœ«å°¾çš„ã€å…¨æ–°æ’­æ”¾æ©ŸCSS V3.0ã€‘ â–¼â–¼â–¼ */

/* 1. å®šç¾©å”±ç‰‡æ—‹è½‰å‹•ç•« */
@keyframes spin-vinyl {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* 2. æ’­æ”¾æ©Ÿä¸»è¦–çª—æ¨£å¼ */
#char-music-player-modal .modal-content {
    width: 340px !important; /* å¯¬åº¦é©ä¸­ */
    height: auto !important;
    background-color: #f0f1f3 !important; /* è¼•æŸ”çš„ç°è‰²èƒŒæ™¯ */
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
    padding: 20px; /* çµ±ä¸€å…§é‚Šè· */
    position: relative;
}

/* 3. ç§»é™¤èˆŠçš„é ­éƒ¨ï¼Œå› ç‚ºé—œé–‰æŒ‰éˆ•å·²ç¨ç«‹ */
#char-music-player-modal .modal-header {
    display: none !important;
}

/* 4. å³ä¸Šè§’é—œé–‰æŒ‰éˆ• */
#char-music-player-modal .char-player-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: 300;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
}

/* 5. ä¸»å…§å®¹å€ */
#char-music-player-modal .char-player-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
}

/* 6. æ­Œæ›²ä¿¡æ¯ */
#char-music-player-modal .char-player-song-info {
    text-align: center;
    margin-bottom: 25px;
}
#char-music-player-modal #char-music-player-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 5px 0;
}
#char-music-player-modal #char-music-artist {
    font-size: 14px;
    color: #888;
    margin: 0;
}

/* 7. é»‘è† å”±ç‰‡æ•ˆæœ */
#char-music-player-modal #char-vinyl-container {
    width: 210px;
    height: 210px;
    border-radius: 50%;
    background-color: #222;
    padding: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
    margin-bottom: 25px;
}
#char-music-player-modal #char-vinyl-container.spinning {
    animation: spin-vinyl 12s linear infinite;
}
#char-music-player-modal #char-music-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 8. ã€æ ¸å¿ƒæ–°å¢ã€‘æ­Œè©å€åŸŸæ¨£å¼ */
#char-music-player-modal #char-music-lyrics {
    width: 100%;
    height: 50px; /* è¨­å®šä¸€å€‹å›ºå®šé«˜åº¦ï¼Œç”¨æ–¼é¡¯ç¤ºç´„å…©è¡Œæ­Œè© */
    overflow: hidden; /* éš±è—è¶…å‡ºéƒ¨åˆ†çš„æ­Œè© */
    position: relative;
    margin-bottom: 25px;
    font-size: 14px;
    line-height: 25px; /* è¨­ç½®è¡Œé«˜ */
    color: #888;
    text-align: center;
    transition: all 0.3s ease;
}

#char-music-player-modal #char-music-lyrics p {
    margin: 0;
    transition: all 0.3s ease;
}

#char-music-player-modal #char-music-lyrics p.active {
    color: #000;
    font-weight: 600;
    font-size: 16px; /* ç•¶å‰è¡Œæ­Œè©æ”¾å¤§ä¸€é» */
}


/* 9. åº•éƒ¨æ§åˆ¶æ¬„ */
#char-music-player-modal .char-player-footer {
    width: 100%;
    margin-top: auto; /* å°‡å…¶æ¨åˆ°åº•éƒ¨ */
}

/* 10. é€²åº¦æ¢å’Œæ§åˆ¶æŒ‰éˆ• */
#char-music-player-modal .char-player-progress-bar-container {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1; height: 4px; background-color: #e0e0e0; border-radius: 2px; cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%; height: 100%; background-color: #555; border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none; border: none; color: #555; cursor: pointer; transition: color 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover { color: #000; }
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px; height: 50px; background-color: #e0e1e3; border-radius: 50%; color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px; font-weight: 500; width: 50px;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
#chat-list .chat-list-item {
    /* æ ¸å¿ƒ1ï¼šå¼·åˆ¶ä½¿ç”¨ gap å±¬æ€§ä¾†æ§åˆ¶é–“è·ï¼Œä¸¦è¦†è“‹èˆŠæœ‰è¡çª */
    gap: 15px !important;
    /* ç¢ºä¿æ²’æœ‰å…¶ä»–å°é½Šæ–¹å¼å¹²æ“¾ */
    justify-content: flex-start !important;
}

#chat-list .chat-list-item .avatar-group {
    /* æ ¸å¿ƒ2ï¼šå¼·åˆ¶ç§»é™¤ä¹‹å‰ç”¨æ–¼é–“è·çš„ marginï¼Œç¾åœ¨å®Œå…¨ç”± gap æ§åˆ¶ */
    margin-right: 0 !important;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | ä»¿è±†ç“£UIã€‘è±†ç“£å°çµ„åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è±†ç“£ä¸»é¡Œè‰²èˆ‡é é¢èƒŒæ™¯ */
#douban-screen {
    background-color: #F6F6F1; /* è±†ç“£ç¶“å…¸çš„ç±³è‰²èƒŒæ™¯ */
}
#phone-screen.dark-mode #douban-screen {
    background-color: #1a1a1a;
}
#douban-posts-list {
    padding: 0; /* æ¸…å–®æœ¬èº«ä¸éœ€è¦å…§é‚Šè· */
    display: flex;
    flex-direction: column;
}

/* 2. å¸–å­å¡ç‰‡ç¾åŒ– (V2.0) */
.douban-post-item {
    background-color: var(--secondary-bg);
    padding: 12px 15px;
    border: none;
    box-shadow: none;
    border-bottom: 1px solid var(--border-color); /* ç”¨åˆ†å‰²ç·šä»£æ›¿é‚Šæ¡† */
    cursor: pointer;
    transition: background-color 0.2s;
}
.douban-post-item:hover {
    background-color: #f9f9f9;
}
#phone-screen.dark-mode .douban-post-item:hover {
    background-color: #2c2c2e;
}

/* 3. å¸–å­é ­éƒ¨ (é ­åƒã€æ˜µç¨±ã€å°çµ„å) */
.douban-post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}
.douban-post-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}
.douban-author-info {
    flex-grow: 1;
}
.douban-author-name {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 14px;
}
.douban-group-name {
    font-size: 12px;
    color: #007722; /* è±†ç“£æ¨™èªŒæ€§çš„ç¶ è‰² */
    font-weight: 500;
}

/* 4. å¸–å­æ¨™é¡Œå’Œå…§å®¹é è¦½ */
.douban-post-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}
.douban-post-content {
    font-size: 14px;
    color: #555;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
#phone-screen.dark-mode .douban-post-content {
    color: #dcdcdc;
}

/* 5. å¸–å­åº•éƒ¨ (çµ±è¨ˆè³‡æ–™) */
.douban-post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
}
.douban-post-actions {
    display: flex;
    gap: 20px;
}
.douban-post-actions span {
    display: flex;
    align-items: center;
    gap: 6px; /* å¢åŠ åœ–ç¤ºå’Œæ•¸ä½ä¹‹é–“çš„é–“è· */
    color: var(--text-secondary); /* ç¢ºä¿é¡è‰²çµ±ä¸€ */
}
/* ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºSVGåœ–ç¤ºè¨­ç½®çµ±ä¸€æ¨£å¼ */
.douban-post-actions svg {
    width: 18px;
    height: 18px;
    fill: currentColor; /* è®“åœ–ç¤ºé¡è‰²è·Ÿéš¨çˆ¶å…ƒç´ çš„æ–‡å­—é¡è‰² */
    position: relative;
    top: -1px; /* ä½ç½®å¾®èª¿ï¼Œä½¿å…¶èˆ‡æ•¸å­—æ›´å°é½Š */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾½æ¯›ç­†åœ–ç¤ºæŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
.douban-feather-btn {
    /* 1. åŸºç¤æ¨£å¼ (è¤‡ç”¨ä¸»èŠå¤©ä»‹é¢çš„åœ“å½¢æŒ‰éˆ•) */
    font-size: 24px;
    padding: 0;
    width: 38px;
    height: 38px;
    line-height: 38px;
    text-align: center;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
    margin-right: 8px; /* å’Œç™¼é€æŒ‰éˆ•æ‹‰é–‹è·é›¢ */

    /* 2. å¤–è§€ (ä»¿iOSé¢¨æ ¼çš„æ·ºç°è‰²) */
    background-color: #f0f2f5;
    color: #555;
    transition: background-color 0.2s;
}
.douban-feather-btn:hover {
    background-color: #e2e6ea;
}
.douban-feather-btn svg {
    width: 20px;
    height: 20px;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* 6. ã€V2.2 | æœ€çµ‚ä½ˆå±€ä¿®å¾©ç‰ˆã€‘å¸–å­è©³æƒ…é  */

#douban-post-detail-screen {
    background-color: #F6F6F1; /* å¤–éƒ¨ç±³è‰²èƒŒæ™¯ */
}
#phone-screen.dark-mode #douban-post-detail-screen {
    background-color: #1a1a1a;
}

/* ã€æ ¸å¿ƒä¿®å¾©1ã€‘é‡ç½®å¤–éƒ¨å®¹å™¨çš„å…§é‚Šè·ï¼Œè®“ç™½è‰²èƒŒæ™¯èƒ½æ’æ»¿å…¨å± */
#douban-detail-content-wrapper {
    background-color: var(--secondary-bg);
    padding: 0; /* ç§»é™¤å°è‡´å…©å´ç©ºç™½çš„å…§é‚Šè· */
    padding-bottom: 80px; /* åªä¿ç•™åº•éƒ¨çš„ç©ºé–“çµ¦è¼¸å…¥æ¡† */
}

/* ã€æ ¸å¿ƒä¿®å¾©2ã€‘å°‡é‚Šè·æ‡‰ç”¨åˆ°å…§éƒ¨çš„æ­£æ–‡å€åŸŸ */
#douban-post-detail-body {
    padding: 20px 18px 25px 18px; /* åœ¨å…§å®¹å››å‘¨ç•™å‡ºå‘¼å¸ç©ºé–“ */
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode #douban-post-detail-body {
    border-bottom-color: #38383a;
}

/* ç¾åŒ–å¸–å­æ¨™é¡Œ */
.douban-post-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    line-height: 1.5;
}

/* å„ªåŒ–æ­£æ–‡é–±è®€é«”é©— */
.douban-detail-content {
    white-space: pre-wrap;
    line-height: 1.8;
    font-size: 15px;
    color: #333;
}
#phone-screen.dark-mode .douban-detail-content {
    color: #dcdcdc;
}

/* ã€æ ¸å¿ƒä¿®å¾©3ã€‘å°‡é‚Šè·ä¹Ÿæ‡‰ç”¨åˆ°è©•è«–å€ï¼Œä¸¦ç§»é™¤èˆ‡æ­£æ–‡çš„é–“è· */
.douban-comments-section {
    margin-top: 0;
    padding: 15px 18px;
}

/* ç‚ºâ€œå›æ‡‰â€å¢åŠ æ¨™é¡Œæ¨£å¼ */
.douban-comments-section h4 {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .douban-comments-section h4 {
    border-bottom-color: #38383a;
}

/* ç¾åŒ–å–®æ¢è©•è«– */
.douban-comment-item {
    display: flex;
    gap: 12px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}
.douban-comment-item:last-child {
    border-bottom: none;
}
#phone-screen.dark-mode .douban-comment-item {
    border-bottom-color: #38383a;
}

.douban-comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
}
.douban-comment-body {
    flex-grow: 1;
}
.douban-comment-author {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
}
.douban-comment-text {
    font-size: 14px;
    color: #555;
    margin-top: 6px;
    line-height: 1.7;
    word-break: break-word;
}
#phone-screen.dark-mode .douban-comment-text {
    color: #b0b0b0;
}

/* 7. ã€V2.2 | æœ€çµ‚ä½ˆå±€ä¿®å¾©ç‰ˆã€‘è©³æƒ…é åº•éƒ¨è©•è«–è¼¸å…¥æ¬„ */
#douban-comment-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    
    /* ã€æ ¸å¿ƒä¿®å¾©1ã€‘å¢åŠ ä¸Šä¸‹å·¦å³çš„å…§é‚Šè·ï¼Œè§£æ±ºè²¼é‚Šå•é¡Œ */
    padding: 10px 18px; 
    
    /* ã€æ ¸å¿ƒä¿®å¾©2ã€‘ä¿ç•™å°iPhoneåº•éƒ¨å®‰å…¨å€åŸŸçš„é©é… */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    
    /* ã€æ ¸å¿ƒä¿®å¾©3ã€‘ç¢ºä¿ padding ä¸æœƒæ’ç ´ä½ˆå±€ */
    box-sizing: border-box; 
    
    /* (å…¶ä»–æ¨£å¼ä¿æŒä¸è®Š) */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color); /* åœ¨é ‚éƒ¨ä¹ŸåŠ ä¸€æ¢åˆ†å‰²ç·šï¼Œæ›´ç²¾ç·» */
}
#douban-send-comment-btn {
    background-color: #007722; /* è±†ç“£ç¶  */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾© | V3.0ã€‘è±†ç“£é ­éƒ¨æŒ‰éˆ•é¡¯ç¤ºçµ‚æ¥µè§£æ±ºæ–¹æ¡ˆ â–¼â–¼â–¼ */

/* 1. ç¢ºä¿å³å´çš„æŒ‰éˆ•å®¹å™¨æœ¬èº«ä¸æœƒè¢«æ„å¤–å£“ç¸® */
#douban-screen .header .header-actions {
    flex-shrink: 0;
    display: flex;       /* ç¢ºä¿å®ƒæ˜¯ä¸€å€‹flexå®¹å™¨ */
    align-items: center; /* å‚ç›´å±…ä¸­å…§éƒ¨çš„åœ–ç¤º */
}

/* 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘ç‚ºæ‰€æœ‰é ­éƒ¨æ“ä½œæŒ‰éˆ•å…§çš„SVGåœ–ç¤ºè¨­ç½®ä¸€å€‹å›ºå®šçš„ã€çµ±ä¸€çš„å°ºå¯¸ */
.header .action-btn svg {
    width: 24px;   /* ç¢ºä¿å°ºå¯¸çµ±ä¸€ */
    height: 24px;
    display: block; /* ç§»é™¤SVGå¯èƒ½å¸¶æœ‰çš„é¡å¤–åº•éƒ¨ç©ºé–“ */
}

/* 3. ç‚ºæ‰€æœ‰æ“ä½œæŒ‰éˆ•è¨­ç½®ä¸€å€‹æœ€å°å¯¬åº¦ï¼Œä¿è­‰å®ƒå€‘ä¸æœƒè¢«æ“ å£“å¾—éå° */
.header .action-btn {
    min-width: 30px; /* çµ¦äºˆæ¯å€‹æŒ‰éˆ•è¶³å¤ çš„é»æ“Šå€åŸŸ */
    display: flex;
    align-items: center;
    justify-content: center;
}
/* â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç”¨æ–¼å°é½Šé ­éƒ¨å·¦å´æŒ‰éˆ•çš„æ¨£å¼ â–¼â–¼â–¼ */
.header .header-left-actions {
    display: flex;
    align-items: center;
    gap: 15px; /* (å¯é¸) åœ¨è¿”å›ã€å°å…¥ã€åŒ¯å‡ºæŒ‰éˆ•ä¹‹é–“å¢åŠ ä¸€äº›é–“è· */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œè§’è‰²ç›¸å†Šç”Ÿåœ–é—œé–‰â€åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

        /* 1. è®“ç›¸å†Šæ ¼å­æˆç‚º Flex å®¹å™¨ï¼Œé€™æ¨£æˆ‘å€‘æ‰èƒ½æ–¹ä¾¿åœ°å±…ä¸­å…§éƒ¨çš„æ–‡å­— */
        .char-photo-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px; /* åœ¨æ–‡å­—å‘¨åœç•™å‡ºä¸€é»å…§é‚Šè·ï¼Œé¿å…è²¼é‚Š */
            box-sizing: border-box;
        }
        
        /* 2. ç…§ç‰‡æè¿°æ–‡å­—æœ¬èº«çš„æ¨£å¼ */
        .char-photo-description {
            font-size: 13px;
            color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¡è‰²ï¼Œçœ‹èµ·ä¾†æ›´æŸ”å’Œ */
            text-align: center;
            line-height: 1.5;
        
            /* æ ¸å¿ƒï¼šé€™æ˜¯ä¸€å€‹å¯¦ç¾â€œå¤šè¡Œçœç•¥è™Ÿâ€çš„æŠ€å·§ï¼Œé˜²æ­¢éé•·çš„æè¿°æ’ç ´ä½ˆå±€ */
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 5; /* æœ€å¤šé¡¯ç¤º5è¡Œ */
            overflow: hidden;
            word-break: break-all; /* ç¢ºä¿é•·å–®è©æˆ–URLä¹Ÿèƒ½è¢«æˆªæ–· */
        }
        
        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºæ·˜å¯¶/æµè¦½å™¨ç”Ÿåœ–é—œé–‰åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

        /* 1. ç‚ºæ·˜å¯¶å•†å“å¡ç‰‡ä¸Šçš„æ–‡å­—æè¿°å‰µå»ºä¸€å€‹å®¹å™¨ */
        .char-product-description-overlay {
            width: 100%;
            aspect-ratio: 1 / 1; /* èˆ‡åœ–ç‰‡ä¿æŒç›¸åŒçš„æ­£æ–¹å½¢æ¯”ä¾‹ï¼Œç¢ºä¿ç¶²æ ¼ä½ˆå±€ä¸äº‚ */
            background-color: #f7f8fa; /* æŸ”å’Œçš„èƒŒæ™¯è‰² */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px; /* å…§é‚Šè· */
            box-sizing: border-box;
            border-bottom: 1px solid #eee; /* åœ¨æè¿°å’Œå•†å“è³‡è¨Šä¹‹é–“åŠ ä¸€æ¢åˆ†å‰²ç·š */
            border-radius: 8px 8px 0 0; /* åŒ¹é…åœ–ç‰‡çš„é ‚éƒ¨åœ“è§’ */
        }

        /* 2. æè¿°æ–‡å­—æœ¬èº«çš„æ¨£å¼ (è¤‡ç”¨ç›¸å†Šçš„æ¨£å¼ï¼Œä¸¦è®“æµè¦½å™¨ä¹Ÿä½¿ç”¨) */
        .char-product-description-overlay .char-photo-description,
        .char-browser-image-description { 
            font-size: 14px; /* å­—é«”å¯ä»¥ç¨å¾®å¤§ä¸€é» */
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 6; /* æœ€å¤šé¡¯ç¤º6è¡Œ */
            overflow: hidden;
            word-break: break-all;
        }

        /* 3. ç‚ºæµè¦½å™¨ä¸­çš„åœ–ç‰‡æè¿°å‰µå»ºä¸€å€‹å®¹å™¨ */
        .char-browser-image-description {
            padding: 40px 20px; /* ä¸Šä¸‹ç•™å‡ºæ›´å¤šç©ºé–“ */
        }

        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºè§’è‰²æ·˜å¯¶è¨‚å–®ç‹€æ…‹æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */
.char-product-status {
    font-size: 12px;
    color: #8a8a8a; /* ä½¿ç”¨æŸ”å’Œçš„ç°è‰² */
    background-color: #f0f2f5; /* çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯ */
    padding: 3px 8px;
    border-radius: 10px;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² *
/* 1. æœç´¢è¢å¹•çš„èƒŒæ™¯è‰² */
#search-history-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #search-history-screen {
    background-color: #000000;
}

/* 2. æœç´¢çµæœåˆ—è¡¨ï¼Œç¢ºä¿å¯ä»¥æ»¾å‹• */
#search-results-list {
    flex-grow: 1;
    overflow-y: auto;
}

/* 3. æ—¥æœŸåˆ†éš”ç¬¦è™Ÿçš„æ¨£å¼ */
.date-separator {
    text-align: center;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 10px 0;
    font-weight: 500;
}

/* 4. å¤œé–“æ¨¡å¼ä¸‹çš„è¼¸å…¥æ¡†é©é… */
#phone-screen.dark-mode #search-bar input {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸»è¢å¹•åˆ†é åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

        /* 1. è®“ä¸»è¢å¹•æˆç‚ºFlexå®¹å™¨ï¼Œä½†æ–¹å‘æ”¹ç‚ºæ°´æº–ï¼Œç‚ºç¿»é åšæº–å‚™ */
        #home-screen {
            flex-direction: column;
            padding: 0; /* ç§»é™¤èˆŠçš„å…§é‚Šè·ï¼Œç”±å…§éƒ¨é é¢è‡ªå·±æ§åˆ¶ */
        }

        /* 2. é é¢å®¹å™¨ï¼Œè² è²¬æ©«å‘æ’åˆ—æ‰€æœ‰é é¢ */
        #home-screen-pages-container {
            flex-grow: 1; /* ä½”æ“šé™¤äº†Dockæ¬„å¤–çš„æ‰€æœ‰ç©ºé–“ */
            width: 100%;
            overflow: hidden; /* éš±è—æ©«å‘æ²è»¸ */
            position: relative;
        }

        #home-screen-pages {
            display: flex;
            width: 200%; /* å‡è¨­æœ‰å…©é ï¼Œå¯¬åº¦è¨­ç‚º200% */
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* å¹³æ»‘çš„ç¿»é å‹•ç•« */
        }

        /* 3. å–®å€‹é é¢çš„æ¨£å¼ */
        .home-screen-page {
            width: 50%; /* æ¯é ä½”æ“šä¸€åŠå¯¬åº¦ */
            height: 100%;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: 0; /* åº•éƒ¨ç”±åˆ†é æŒ‡ç¤ºå™¨æ§åˆ¶ */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 4. åˆ†é æŒ‡ç¤ºå™¨ (å°åœ“é») */
        #home-screen-pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 0;
             /* é©é…iPhoneåº•éƒ¨å®‰å…¨å€ */
            padding-bottom: calc(10px + env(safe-area-inset-bottom) / 2);
            flex-shrink: 0;
        }

        .pagination-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }

        .pagination-dot.active {
            background-color: white;
            transform: scale(1.1);
        }
        
        /* 5. ç¬¬äºŒé çš„Appç¶²æ ¼å®¹å™¨ */

        /* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©å·¥å…·åˆ—æŒ‰éˆ•æ’åºåŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
.draggable-button-item {
    padding: 8px 12px;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: grab;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s, box-shadow 0.2s;
    user-select: none;
}
.draggable-button-item:active {
    cursor: grabbing;
}
.draggable-button-item svg {
    width: 18px;
    height: 18px;
    stroke-width: 2;
}
/* ç•¶ä¸€å€‹å…ƒç´ æ­£åœ¨è¢«æ‹–å‹•æ™‚æ‡‰ç”¨çš„æ¨£å¼ */
.draggable-button-item.dragging {
    opacity: 0.5;
    background-color: #e0e0e0;
}
/* ç•¶æ‹–å‹•çš„å…ƒç´ æ‡¸åœåœ¨å¦ä¸€å€‹å…ƒç´ ä¸Šæ–¹æ™‚ï¼Œç‚ºé‚£å€‹å…ƒç´ æ‡‰ç”¨çš„æ¨£å¼ */
.draggable-button-item.drag-over {
    background-color: #d0eaff;
    box-shadow: 0 0 0 2px var(--accent-color);
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° | ç§»å‹•ç«¯ç›¸å®¹ã€‘ç‚ºæ‹–å‹•éç¨‹æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

/* ç•¶ä¸€å€‹å…ƒç´ æ­£åœ¨è¢«æ‹–å‹•æ™‚æ‡‰ç”¨çš„æ¨£å¼ */
.draggable-button-item.dragging {
    opacity: 0.5;
    background-color: #e0e0e0;
    /* æ ¸å¿ƒï¼šè®“è¢«æ‹–å‹•çš„å…ƒç´ â€œæµ®â€èµ·ä¾†ï¼Œä¸æœƒå½±éŸ¿å…¶ä»–å…ƒç´ çš„ä½ˆå±€ */
    position: relative; 
    z-index: 10;
}

/* é˜²æ­¢åœ¨æ‰‹æ©Ÿä¸Šæ‹–å‹•æ™‚ï¼Œæ„å¤–é¸ä¸­é é¢ä¸Šçš„æ–‡å­— */
#button-order-editor {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºå½ˆçª—å…§å¯æ»¾å‹•é•·æ–‡æœ¬æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */
.scrollable-content-preview {
    /* æ ¸å¿ƒ1ï¼šè¨­ç½®ä¸€å€‹æœ€å¤§é«˜åº¦ã€‚å…§å®¹è¶…å‡ºé€™å€‹é«˜åº¦å°±æœƒè§¸ç™¼æ»¾å‹•ã€‚
       35vh è¡¨ç¤ºè¦–çª—é«˜åº¦çš„35%ï¼Œé€™æ˜¯ä¸€å€‹éˆæ´»çš„é«˜åº¦ï¼Œèƒ½é©æ‡‰ä¸åŒè¢å¹•ã€‚*/
    max-height: 35vh;
    
    /* æ ¸å¿ƒ2ï¼šç•¶å…§å®¹å‚ç›´æ–¹å‘æº¢å‡ºæ™‚ï¼Œè‡ªå‹•é¡¯ç¤ºæ²è»¸ã€‚ */
    overflow-y: auto;
    
    /* (å¯é¸) ç¾åŒ–æ¨£å¼ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ›´åƒä¸€å€‹ä»£ç¢¼/å¼•ç”¨å¡Š */
    background-color: #f0f2f5;
    padding: 10px 15px;
    border-radius: 8px;
    text-align: left;
    white-space: pre-wrap; /* ä¿æŒæ–‡æœ¬ä¸­çš„æ›è¡Œ */
    border: 1px solid var(--border-color);
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é«˜ç´šè³‡æ–™æ¸…ç†åš®å°æ¨£å¼ â–¼â–¼â–¼ */
.wizard-step {
    display: none; /* é è¨­éš±è—æ‰€æœ‰æ­¥é©Ÿ */
    flex-direction: column;
    width: 100%;
    height: 100%;
}

.wizard-step.active {
    display: flex; /* åªé¡¯ç¤ºå•Ÿå‹•çš„æ­¥é©Ÿ */
}

/* è¤‡ç”¨ç¾æœ‰çš„æ¸…å–®é …æ¨£å¼ï¼Œç‚ºå…¶æ·»åŠ ä¸€é»å…§é‚Šè· */
#data-clear-char-list .clear-posts-item,
#data-clear-type-list .clear-posts-item {
    padding: 12px 18px;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºæ¸…ç†åš®å°æ·»åŠ â€œå…¨é¸â€æ¨£å¼ â–¼â–¼â–¼ */
#data-clear-wizard-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#data-clear-wizard-modal .modal-header label {
    font-size: 14px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ•™ç¨‹é é¢æ¨£å¼ â–¼â–¼â–¼ */
#tutorial-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #tutorial-screen {
    background-color: #000000;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é è¨­ç·¨è¼¯å™¨å…§å®¹æŠ˜ç–ŠåŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */
.entry-content-container {
    display: none; /* é è¨­éš±è—å…§å®¹å€åŸŸ */
    margin-top: 8px; /* å’Œä¸Šæ–¹çš„æ¨™ç±¤æ‹‰é–‹ä¸€é»è·é›¢ */
}
.toggle-content-btn {
    background: none;
    border: 1px solid #ccc;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ›´æ–°é€šçŸ¥å½ˆçª—çš„æ¨£å¼ â–¼â–¼â–¼ */
#update-notice-modal {
    position: fixed; /* å›ºå®šå®šä½ï¼Œè¦†è“‹åœ¨æ‰€æœ‰å…§å®¹ä¹‹ä¸Š */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    display: none; /* é»˜èªéš±è— */
    align-items: center;
    justify-content: center;
    z-index: 2000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    opacity: 0;
    transition: opacity 0.3s ease;
}
#update-notice-modal.visible {
    display: flex;
    opacity: 1;
}
.update-notice-content {
    background-color: #fff;
    width: 300px;
    border-radius: 14px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
#update-notice-modal.visible .update-notice-content {
    transform: scale(1);
}
.update-notice-body {
    padding: 20px;
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    
    /* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼ --- */

    /* 1. è¨­ç½®ä¸€å€‹æœ€å¤§é«˜åº¦ã€‚æˆ‘å€‘ä½¿ç”¨ vh (è¦–çª—é«˜åº¦) å–®ä½ï¼Œ
       è®“å½ˆçª—æœ€å¤§ä¸è¶…éè¢å¹•é«˜åº¦çš„60%ï¼Œä»¥é©æ‡‰ä¸åŒå°ºå¯¸çš„æ‰‹æ©Ÿã€‚ */
    max-height: 60vh; 
    
    /* 2. ç•¶å…§å®¹è¶…å‡ºé€™å€‹æœ€å¤§é«˜åº¦æ™‚ï¼Œè‡ªå‹•é¡¯ç¤ºå‚ç›´æ²å‹•æ¢ã€‚ */
    overflow-y: auto; 

    /* --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² --- */
}
.update-notice-footer {
    border-top: 1px solid #dbdbdb;
    display: flex;
}
.update-notice-footer button {
    flex: 1;
    background: none;
    border: none;
    padding: 14px;
    font-size: 17px;
    cursor: pointer;
    color: var(--accent-color);
}
.update-notice-footer button:first-child {
    border-right: 1px solid #dbdbdb;
    font-weight: 600;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° | ä¿æŒæ©«å‘ä½ˆå±€ã€‘é€™æ˜¯ä¿®å¾©é•·æŒ‰åŠŸèƒ½è¡¨æˆªæ–·å•é¡Œçš„æœ€çµ‚ç‰ˆæ¨£å¼ â–¼â–¼â–¼ */

/* 1. æ ¸å¿ƒä¿®æ”¹ï¼šè®“æŒ‰éˆ•å®¹å™¨æ”¯æ´æ›è¡Œ */
#message-actions-modal .custom-modal-footer {
    flex-wrap: wrap; /* å…è¨±é …ç›®æ›è¡Œ */
    padding: 10px;   /* åœ¨å®¹å™¨å‘¨åœå¢åŠ ä¸€äº›å…§é‚Šè·ï¼Œè®“ä½ˆå±€æ›´èˆ’å±• */
    gap: 10px;       /* åœ¨æŒ‰éˆ•ä¹‹é–“å¢åŠ é–“è· */
    justify-content: flex-start; /* è®“æŒ‰éˆ•å¾å·¦å´é–‹å§‹æ’åˆ— */
}

/* 2. ç‚ºæ¯ä¸€å€‹æ“ä½œæŒ‰éˆ•ï¼ˆé™¤äº†å–æ¶ˆæŒ‰éˆ•ï¼‰è¨­ç½®å°ºå¯¸å’Œæ¨£å¼ */
#message-actions-modal .custom-modal-footer button:not(#cancel-message-action-btn) {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†å¹³åˆ†å¯¬åº¦ï¼Œè€Œæ˜¯å…è¨±å®ƒå€‘æ ¹æ“šå…§å®¹ç”Ÿé•·ï¼Œä¸¦è¨­ç½®ä¸€å€‹åŸºç¤å¯¬åº¦ */
    flex-grow: 1;
    flex-basis: 75px; /* æ¯å€‹æŒ‰éˆ•çš„åŸºç¤å¯¬åº¦ï¼Œç¢ºä¿è‡³å°‘èƒ½å®¹ç´4å€‹å­— */
    
    /* (å¯é¸ä½†æ¨è–¦) çµ±ä¸€æŒ‰éˆ•å¤–è§€ï¼Œä½¿å…¶æ›´åƒä¸€å€‹ç¶²æ ¼ */
    border: none;
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 12px 5px; /* èª¿æ•´å…§é‚Šè·ï¼Œè®“æ–‡å­—å±…ä¸­ */
    font-size: 16px;
    font-weight: 500;
}

/* 3. è®“â€œå–æ¶ˆâ€æŒ‰éˆ•å–®ç¨ä½”æ“šä¸€æ•´è¡Œï¼Œä¸¦æ¢å¾©å…¶ç¨ç«‹æ¨£å¼ */
#message-actions-modal #cancel-message-action-btn {
    width: 100%; /* å¼·åˆ¶å¯¬åº¦ç‚º100% */
    flex-basis: 100%; /* åœ¨flexä½ˆå±€ä¸­ä¹Ÿç¢ºä¿å®ƒå æ»¿ä¸€è¡Œ */
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f2f5;
    font-weight: 600;
}
/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* ä¿®å¾©iOSè¼¸å…¥æ¡†è‡ªå‹•æ”¾å¤§å•é¡Œ (å¼·è£½ç‰ˆ) */
input, textarea, select {
    font-size: 16px !important;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºæ—¥è¨˜æ”¶è—åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

/* æ”¶è—æŒ‰éˆ•å•Ÿå‹•æ™‚çš„æ¨£å¼ï¼ˆå¡«å……é»ƒè‰²ï¼‰ */
#favorite-diary-btn.active svg {
    fill: #ffc107; /* æ‚¨å¯ä»¥æ›æˆä»»ä½•æ‚¨å–œæ­¡çš„é¡è‰² */
    color: #ffc107;
}

/* æ”¶è—å¡ç‰‡ä¸­æ—¥è¨˜æ¨™é¡Œçš„æ¨£å¼ */
.favorite-item-card .diary-title {
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    font-size: 15px;
}

/* æ”¶è—å¡ç‰‡ä¸­æ—¥è¨˜å…§å®¹é è¦½çš„æ¨£å¼ */
.favorite-item-card .diary-content-preview {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.6;
    
    /* å¤šè¡Œçœç•¥è™Ÿæ•ˆæœ */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* æœ€å¤šé¡¯ç¤º3è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}
/* â–¼â–¼â–¼ æŠŠé€™æ®µCSSä»£ç¢¼ã€å®Œå…¨åˆªé™¤ã€‘â–¼â–¼â–¼ */
.favorite-item-card .diary-content-preview {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.6;
    
    /* å¤šè¡Œçœç•¥è™Ÿæ•ˆæœ */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* æœ€å¤šé¡¯ç¤º3è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}
/* â–²â–²â–² åˆªé™¤åˆ°é€™è£¡çµæŸ â–²â–²â–² */
#npc-list-view {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #npc-list-view {
    background-color: #000;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œåœè§€ç¾¤èŠâ€æ“ä½œæŒ‰éˆ•æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“â€œåœè§€ä¸­â€æ–‡å­—å’ŒæŒ‰éˆ•å®¹å™¨å‚ç›´æ’åˆ— */
#chat-lock-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px; /* åœ¨æ–‡å­—å’ŒæŒ‰éˆ•ä¹‹é–“å¢åŠ é–“è· */
}

/* 2. æŒ‰éˆ•çš„å®¹å™¨ï¼Œä½¿ç”¨Flexä½ˆå±€è®“å®ƒå€‘æ°´æº–æ’åˆ— */
.spectator-actions-container {
    display: flex;
    gap: 12px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
    align-items: center;
}

/* 3. ç‚ºæ¬¡è¦æŒ‰éˆ•ï¼ˆé‡Roll/å‰ªè¼¯ï¼‰å‰µå»ºä¸€å€‹æ–°æ¨£å¼ */
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent; /* é€æ˜èƒŒæ™¯ */
    color: var(--accent-color);   /* ä½¿ç”¨ä¸»é¡Œè‰²æ–‡å­— */
    border: 1px solid var(--accent-color); /* åŒæ¨£é¡è‰²çš„é‚Šæ¡† */
    padding: 8px 18px; /* èª¿æ•´å…§é‚Šè·ï¼Œè®“å®ƒæ¯”ä¸»æŒ‰éˆ•å°ä¸€é» */
    font-size: 14px;
}
/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œåœè§€ç¾¤èŠâ€SVGåœ–ç¤ºæŒ‰éˆ•æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

.spectator-actions-container .lock-action-btn.secondary svg {
    width: 20px;  /* è¨­ç½®åœ–ç¤ºå¯¬åº¦ */
    height: 20px; /* è¨­ç½®åœ–ç¤ºé«˜åº¦ */
    stroke: currentColor; /* é—œéµï¼šè®“åœ–ç¤ºé¡è‰²è‡ªå‹•ç¹¼æ‰¿æŒ‰éˆ•çš„æ–‡å­—é¡è‰² */
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éŸ³æ¨‚æ’­æ”¾æ©ŸèƒŒæ™¯æ¨£å¼ â–¼â–¼â–¼ */

/* 1. è®“æ’­æ”¾æ©Ÿè¦–çª—æˆç‚ºç›¸å°å®šä½çš„å®¹å™¨ï¼Œä»¥ä¾¿å½å…ƒç´ å®šä½ */
.music-player-window {
    position: relative;
    /* (å¯é¸) å¢åŠ ä¸€å€‹è¼•å¾®çš„èƒŒæ™¯è’™ç‰ˆï¼Œè®“æ–‡å­—åœ¨äº®è‰²èƒŒæ™¯ä¸‹æ›´æ¸…æ™° */
    background-color: rgba(255, 255, 255, 0.75);
}

/* 2. é€™å°±æ˜¯æˆ‘å€‘çš„èƒŒæ™¯å±¤æ ¸å¿ƒæ¨£å¼ */
.music-player-window::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    /* 3. ä½¿ç”¨CSSè®Šæ•¸ä¾†å‹•æ…‹è¨­ç½®èƒŒæ™¯åœ–ç‰‡ */
    background-image: var(--music-bg-image);
    background-size: cover;
    background-position: center;
    
    /* 4. æ·»åŠ è¦–è¦ºæ•ˆæœï¼šé«˜æ–¯æ¨¡ç³Šå’Œé™ä½äº®åº¦ï¼Œç‡Ÿé€ æ°›åœæ„Ÿ */
    filter: blur(15px) brightness(0.8);
    
    /* 5. ç¢ºä¿èƒŒæ™¯åœ¨æœ€åº•å±¤ï¼Œä¸é®æ“‹å…§å®¹ */
    z-index: -1;
    
    /* 6. è®“èƒŒæ™¯å±¤çš„åœ“è§’å’Œæ’­æ”¾æ©Ÿçª—å£ä¿æŒä¸€è‡´ */
    border-radius: inherit; 
    
    /* 7. ç‚ºèƒŒæ™¯åˆ‡æ›å¢åŠ å¹³æ»‘çš„éæ¸¡å‹•ç•« */
    transition: background-image 0.5s ease-in-out;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘èƒŒæ™¯æ¸…æ™°åº¦åˆ‡æ›åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ç•¶æ’­æ”¾æ©Ÿçª—å£æ“æœ‰ .bg-clear é€™å€‹ class æ™‚ï¼Œè®“èƒŒæ™¯è®Šå¾—æ¸…æ™° (æ­¤è¦å‰‡ä¸è®Š) */
.music-player-window.bg-clear::before {
    filter: none;
}

/* 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºâ€œæ¸…â€å­—æŒ‰éˆ•è¨­ç½®æ–°çš„ã€èˆ‡å…¶å®ƒæ§åˆ¶æŒ‰éˆ•ä¸€è‡´çš„æ¨£å¼ */
#toggle-blur-btn {
    /* ç§»é™¤æ‰€æœ‰å®šä½å±¬æ€§ */
    /* position: absolute; bottom: 95px; right: 20px; z-index: 55; */

    /* è¤‡ç”¨å…¶ä»–æŒ‰éˆ•çš„æ¨£å¼ */
    background: none;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    color: #333;
    width: 44px;
    height: 44px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
    border-radius: 50%;
    
    /* çµ¦ä¸€å€‹å’Œå…¶ä»–æŒ‰éˆ•ç›¸ä¼¼çš„æ·¡æ·¡èƒŒæ™¯ */
    background-color: rgba(0, 0, 0, 0.05);
}

/* 3. æŒ‰éˆ•å•Ÿå‹•æ™‚çš„æ¨£å¼ï¼ˆè¡¨ç¤ºç•¶å‰æ˜¯æ¸…æ™°æ¨¡å¼ï¼‰ */
#toggle-blur-btn.active {
    background-color: var(--accent-color); /* ä¾‹å¦‚ï¼Œå•Ÿå‹•æ™‚è®Šç‚ºä¸»é¡Œè‰² */
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾æ©Ÿå…¨å±åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ç•¶æ’­æ”¾æ©Ÿçª—å£æ“æœ‰ .fullscreen é€™å€‹ class æ™‚ï¼Œè®“å®ƒæ’æ»¿æ•´å€‹è¢å¹• */
.music-player-window.fullscreen {
    width: 100%;
    height: 100%;
    max-height: 100%; /* è¦†è“‹å¯èƒ½å­˜åœ¨çš„ max-height é™åˆ¶ */
    border-radius: 0; /* å…¨å±æ™‚ç§»é™¤åœ“è§’ */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* è®“æ”¾å¤§ç¸®å°çš„å‹•ç•«æ›´æµæš¢ */
}

/* 2. ç•¶æ’­æ”¾æ©Ÿå…¨å±æ™‚ï¼Œç§»é™¤å¤–éƒ¨å®¹å™¨çš„å…§é‚Šè·ï¼Œè®“æ’­æ”¾æ©Ÿèƒ½çœŸæ­£è²¼åˆè¢å¹•é‚Šç·£ */
#music-player-overlay.fullscreen-active {
    padding-top: 0;
    align-items: stretch; /* è®“æ’­æ”¾æ©Ÿåœ¨å‚ç›´æ–¹å‘ä¸Šä¹Ÿèƒ½æ’æ»¿ */
}

/* 3. ã€æ ¸å¿ƒã€‘ç‚ºæ–°çš„å…¨å±åˆ‡æ›æŒ‰éˆ•å®šç¾©æ¨£å¼ */
#toggle-fullscreen-btn {
    background: none;
    border: none;
    font-size: 22px; /* è¨­ç½®ä¸€å€‹åˆé©çš„åœ–ç¤ºå¤§å° */
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}
#toggle-fullscreen-btn:hover {
    color: #000;
}

/* 4. ã€æ ¸å¿ƒã€‘é€šé CSS æ§åˆ¶æ”¾å¤§/ç¸®å°åœ–ç¤ºçš„é¡¯ç¤ºå’Œéš±è— */
/* é è¨­æƒ…æ³ä¸‹ï¼Œåªé¡¯ç¤ºâ€œæ”¾å¤§â€åœ–ç¤º */
#toggle-fullscreen-btn .icon-minimize {
    display: none;
}
/* ç•¶æ’­æ”¾æ©Ÿè™•æ–¼å…¨å±ç‹€æ…‹æ™‚ï¼Œéš±è—â€œæ”¾å¤§â€åœ–ç¤ºï¼Œé¡¯ç¤ºâ€œç¸®å°â€åœ–ç¤º */
.music-player-window.fullscreen #toggle-fullscreen-btn .icon-maximize {
    display: none;
}
.music-player-window.fullscreen #toggle-fullscreen-btn .icon-minimize {
    display: block;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾æ©Ÿå…¨å±é ­åƒé¡¯ç¤ºåŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. é ­åƒé¡¯ç¤ºå®¹å™¨çš„æ¨£å¼ */
#music-player-avatar-display {
    display: none; /* é»˜èªéš±è— */
    width: 100%;
    padding: 15px 20px;
    box-sizing: border-box;
    justify-content: space-between; /* è®“å…©å€‹é ­åƒåˆ†ä½ˆåœ¨å…©ç«¯ */
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* æ·»åŠ ä¸€æ¢åˆ†å‰²ç·š */
    margin-bottom: 10px;
}

/* 2. åªæœ‰ç•¶æ’­æ”¾æ©Ÿå…¨å±ï¼Œä¸¦ä¸”è©²å®¹å™¨æœ‰ .visible é¡æ™‚ï¼Œæ‰é¡¯ç¤ºå®ƒ */
.music-player-window.fullscreen #music-player-avatar-display.visible {
    display: flex;
}

/* 3. é ­åƒæœ¬èº«çš„æ¨£å¼ */
.participant-display-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* 4. æ–°çš„â€œé¡¯ç¤ºé ­åƒâ€æŒ‰éˆ•çš„æ¨£å¼ */
#show-avatars-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    display: none; /* é è¨­åœ¨éå…¨å±æ¨¡å¼ä¸‹éš±è— */
    align-items: center;
    justify-content: center;
    opacity: 0.6;
    transition: opacity 0.2s;
}

/* 5. åªæœ‰åœ¨å…¨å±æ¨¡å¼ä¸‹æ‰é¡¯ç¤ºé€™å€‹æŒ‰éˆ• */
.music-player-window.fullscreen #show-avatars-btn {
    display: flex;
}

#show-avatars-btn:hover {
    opacity: 1;
}

/* 6. ç•¶é ­åƒæ­£åœ¨é¡¯ç¤ºæ™‚ï¼Œè®“æŒ‰éˆ•ä¹Ÿé«˜äº® */
#show-avatars-btn.active {
    opacity: 1;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºè±†ç“£è¨­ç½®å½ˆçª—æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */
.douban-settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.douban-settings-item label {
    margin-bottom: 0;
    flex-grow: 1; /* è®“æ¨™ç±¤ä½”æ“šæ›´å¤šç©ºé–“ */
}
.douban-settings-controls {
    display: flex;
    align-items: center;
    gap: 8px; /* åœ¨è¼¸å…¥æ¡†å’Œæ–‡å­—ä¹‹é–“å¢åŠ é–“è· */
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
}
.douban-settings-controls input {
    width: 60px;
    text-align: center;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºæ™‚å€æœç´¢æ¡†æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */
#time-zone-search-input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 8px; /* å’Œä¸‹æ–¹çš„ä¸‹æ‹‰æ¸…å–®æ‹‰é–‹ä¸€é»è·é›¢ */
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 16px; /* é¿å…åœ¨iOSä¸Šè¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§é é¢ */
}
/* å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #time-zone-search-input {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºéŠæˆ²åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* éŠæˆ²ä¸»è¢å¹•ä½ˆå±€ */
#werewolf-game-screen {
    background-color: #2c2c2e; /* æ·±é‚ƒçš„èƒŒæ™¯ï¼Œç‡Ÿé€ æ°›åœ */
    color: white;
}
#werewolf-player-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 15px;
    padding: 15px;
    flex-shrink: 0;
    border-bottom: 1px solid #444;
}
.werewolf-player-avatar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    position: relative;
}
.werewolf-player-avatar img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid #888;
    transition: all 0.3s;
}
.werewolf-player-avatar .player-name {
    font-size: 12px;
    font-weight: 500;
    text-shadow: 0 1px 2px black;
}
/* æ­»äº¡ç©å®¶çš„æ¨£å¼ */
.werewolf-player-avatar.dead img {
    filter: grayscale(100%);
    border-color: #ff3b30;
}
.werewolf-player-avatar.dead .player-name {
    color: #ff3b30;
    text-decoration: line-through;
}

/* éŠæˆ²æ—¥èªŒ/å°è©±å€åŸŸ */
#werewolf-log {
    padding: 15px;
    background: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.werewolf-log-entry {
    background-color: rgba(255, 255, 255, 0.08);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
}
.werewolf-log-entry.system {
    text-align: center;
    color: #ffc107;
    font-style: italic;
    background-color: rgba(255, 193, 7, 0.1);
}
.werewolf-log-entry .speaker {
    font-weight: bold;
}

/* åº•éƒ¨æ“ä½œæ¬„ */
#werewolf-action-bar {
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(0,0,0,0.3);
    flex-shrink: 0;
    text-align: center;
}
#werewolf-next-step-btn {
    width: 100%;
}

/* è§’è‰²æ­ç¤ºå¡ç‰‡æ¨£å¼ */
#werewolf-role-card {
    background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
    border: 1px solid #666;
    border-radius: 12px;
    padding: 20px;
    color: white;
}
#werewolf-role-name {
    font-size: 22px;
    font-weight: bold;
    color: #ffc107;
    margin-bottom: 10px;
}
#werewolf-role-description {
    font-size: 14px;
    line-height: 1.6;
}

/* é¸æ“‡æ¸…å–®çš„é€šç”¨æ¨£å¼ (ç”¨æ–¼æŸ¥äººã€æŠ•ç¥¨ç­‰) */
.werewolf-selection-item {
    display: flex;
    align-items: center;
    padding: 12px 18px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.werewolf-selection-item.selected {
    background-color: var(--accent-color);
    color: white;
}
.werewolf-selection-item img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 15px;
}
.werewolf-selection-item .name {
    font-weight: 500;
}
/* â–²â–²â–² ç‹¼äººæ®ºæ¨£å¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€V3.0 | ç‹¼äººæ®ºUIç¾åŒ–ã€‘è«‹å°‡é€™æ•´å¡Šä»£ç¢¼ï¼Œé»è²¼åˆ° <style> æ¨™ç±¤çš„æœ«å°¾ â–¼â–¼â–¼ */

        /* 1. ç¾åŒ–åº•éƒ¨å¸¸é§è¼¸å…¥æ¬„çš„èƒŒæ™¯ */
        #werewolf-game-screen #werewolf-action-bar {
            background-color: rgba(0, 0, 0, 0.3); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼Œç‡Ÿé€ æ‡¸æµ®æ„Ÿ */
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* é ‚éƒ¨åŠ ä¸€æ¢å¾®å…‰åˆ†å‰²ç·š */
            padding: 10px 15px; /* å¢åŠ å…§é‚Šè· */
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é©é…iPhoneåº•éƒ¨å®‰å…¨å€ */
        }

        /* 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘è®“æ–‡æœ¬è¼¸å…¥æ¡†èƒ½å¤ å‹•æ…‹ä¼¸ç¸® */
        #werewolf-game-screen #werewolf-user-input {
            flex-grow: 1; /* é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ï¼Œè®“è¼¸å…¥æ¡†ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
            border: none;
            padding: 10px 15px;
            border-radius: 20px; /* åœ“è§’ */
            background-color: rgba(255, 255, 255, 0.1); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            color: #f0f0f0; /* æ·ºè‰²æ–‡å­— */
            font-size: 16px; /* é©é…iOSï¼Œé˜²æ­¢è¼¸å…¥æ™‚æ”¾å¤§ */
            resize: none; /* ç¦æ­¢æ‹–å‹• */
            height: 40px; /* èˆ‡ä¸»èŠå¤©æ¡†ä¿æŒä¸€è‡´çš„é«˜åº¦ */
            box-sizing: border-box;
        }

        /* 3. ç¾åŒ–è¼¸å…¥æ¡†çš„é ç•™ä½ç½®æ–‡å­— */
        #werewolf-game-screen #werewolf-user-input::placeholder {
            color: #8d8d92; /* æš—ç°è‰² */
        }

        /* 4. ç¾åŒ–æ“ä½œæŒ‰éˆ•ï¼Œä½¿å…¶èˆ‡ä¸»èŠå¤©ä»‹é¢çš„ç™¼é€æŒ‰éˆ•é¢¨æ ¼ä¸€è‡´ */
        #werewolf-game-screen #input-actions-wrapper button {
            height: 40px;
            padding: 0 15px;
            border-radius: 20px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«æ“ å£“è®Šå½¢ */
        }

        /* 5. ç¾åŒ–â€œç­‰å¾…å›æ‡‰â€å’Œâ€œç¹¼çºŒè¨è«–â€æŒ‰éˆ• (æ¬¡è¦æŒ‰éˆ•) */
        #werewolf-game-screen #werewolf-wait-reply-btn {
            background-color: #555; /* æ·±ç°è‰²èƒŒæ™¯ */
        }

        /* 6. ç¾åŒ–â€œçµæŸç™¼è¨€â€å’Œâ€œé€²å…¥æŠ•ç¥¨â€æŒ‰éˆ• (ä¸»è¦æŒ‰éˆ•) */
        #werewolf-game-screen #werewolf-finish-speech-btn {
            background-color: #c62828; /* æš—ç´…è‰²ï¼Œæ›´æœ‰ç‹¼äººæ®ºæ°›åœ */
        }

        /* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…åŒ…æœç´¢æ¬„æ¨£å¼ â–¼â–¼â–¼ */

#sticker-search-container {
    padding: 10px 15px; /* åœ¨æœç´¢æ¡†å‘¨åœç•™å‡ºä¸€äº›å…§é‚Šè· */
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
    border-bottom: 1px solid var(--border-color); /* åœ¨ä¸‹æ–¹æ·»åŠ åˆ†å‰²ç·š */
    background-color: var(--secondary-bg); /* ç¢ºä¿èƒŒæ™¯è‰²èƒ½é©é…å¤œé–“æ¨¡å¼ */
}

#sticker-search-input {
    width: 100%;
    padding: 10px 15px;
    font-size: 16px; /* é¿å…åœ¨iOSä¸Šè¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§é é¢ */
    border: 1px solid var(--border-color);
    border-radius: 18px; /* åœ“è§’çŸ©å½¢ */
    background-color: #f0f2f5; /* é»˜èªçš„æ·ºç°è‰²èƒŒæ™¯ */
    box-sizing: border-box;
    outline: none; /* ç§»é™¤é¸ä¸­æ™‚çš„å¤–æ¡† */
    -webkit-appearance: none; /* ç§»é™¤iOSä¸Šçš„é è¨­æ¨£å¼ */
}

#sticker-search-input:focus {
    border-color: var(--accent-color); /* é¸ä¸­æ™‚é‚Šæ¡†è®Šç‚ºä¸»é¡Œè‰² */
    background-color: var(--secondary-bg); /* é¸ä¸­æ™‚èƒŒæ™¯è®Šç‚ºç™½è‰² */
}

/* å¤œé–“æ¨¡å¼é©é… */
#phone-screen.dark-mode #sticker-search-input {
    background-color: #2c2c2e;
    color: #f0f0f0;
    border-color: #38383a;
}
#phone-screen.dark-mode #sticker-search-input:focus {
    background-color: #38383a;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨è·³è½‰é«˜äº®æ•ˆæœ â–¼â–¼â–¼ */

/* 1. ç‚ºæ¶ˆæ¯æ°£æ³¡çš„å…§å®¹å€æ·»åŠ ä¸€å€‹å¹³æ»‘çš„èƒŒæ™¯è‰²éæ¸¡æ•ˆæœ */
.message-bubble .content {
    transition: background-color 0.5s ease-out;
}

/* 2. å®šç¾©é«˜äº®æ™‚çš„èƒŒæ™¯è‰² */
/*    æˆ‘å€‘ä½¿ç”¨ !important ä¾†ç¢ºä¿å®ƒèƒ½è¦†è“‹æ‰æ‰€æœ‰ä¸»é¡Œçš„é è¨­é¡è‰² */
.message-bubble.highlighted .content {
    background-color: rgba(0, 123, 255, 0.2) !important;
}
/* â–²â–²â–² æ–°æ¨£å¼é»è²¼çµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç„¡é™æ»¾å‹•è¼‰å…¥å‹•ç•« â–¼â–¼â–¼ */

.loader-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px 0;
    width: 100%;
    height: 44px; /* çµ¦äºˆä¸€å€‹å›ºå®šé«˜åº¦ä¾†é˜²æ­¢è¼‰å…¥æ™‚é é¢è·³å‹• */
    box-sizing: border-box;
}

.spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(0, 0, 0, 0.1); /* æ—‹è½‰è»Œé“çš„æ·ºç°è‰² */
    border-top-color: var(--accent-color); /* æ—‹è½‰éƒ¨åˆ†çš„é¡è‰²ï¼Œæœƒè·Ÿéš¨ä¸»é¡Œè‰²è®ŠåŒ– */
    border-radius: 50%;
    animation: spin 1s linear infinite; /* è¤‡ç”¨æ‚¨å·²æœ‰çš„ spin å‹•ç•« */
}

/* å¤œé–“æ¨¡å¼ä¸‹çš„é©é… */
#phone-screen.dark-mode .spinner {
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top-color: #fff; /* å¤œé–“æ¨¡å¼ä¸‹æ—‹è½‰éƒ¨åˆ†ç‚ºç™½è‰² */
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€V2.1 | äº¤äº’ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›å¾ #reading-overlay åˆ° .reading-footer button:disabled çš„æ‰€æœ‰ç›¸é—œæ¨£å¼ â–¼â–¼â–¼ */

/* 1. å¤–éƒ¨å®¹å™¨ï¼šæå‡ z-indexï¼Œç¢ºä¿å®ƒåœ¨é ‚æ¬„ä¹‹ä¸Š */
#reading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 150; /* é«˜æ–¼é ‚æ¬„çš„ 100 */
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none; /* å…è¨±é»æ“Šç©¿é€èƒŒæ™¯ */
    display: none; /* é»˜èªéš±è— */
}

/* 2. ä¸»è¦–çª—æ¨£å¼ */
#reading-window {
    width: 90%;
    max-width: 340px;
    height: 60vh;
    max-height: 480px;
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.18);
    display: flex;
    flex-direction: column;
    pointer-events: auto; /* è¦–çª—æœ¬èº«å¯ä»¥äº¤äº’ */
    position: absolute; /* æ”¹ç‚º absolute ä»¥æ”¯æŒæ‹–å‹• */
    /* åˆå§‹å±…ä¸­å®šä½ç”±JSæ§åˆ¶ï¼Œé€™è£¡ä¸å†è¨­ç½® */
    transition: transform 0.3s ease, opacity 0.3s ease, visibility 0s 0.3s; /* æ·»åŠ å¹³æ»‘çš„éæ¸¡å‹•ç•« */
}
#phone-screen.dark-mode #reading-window {
    background-color: rgba(40, 40, 42, 0.7);
}

/* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ .reading-header å’Œ #reading-title æ¨£å¼ â–¼â–¼â–¼ */

/* 3. é ­éƒ¨æ¨£å¼ï¼Œä½œç‚ºâ€œæ‹–å‹•æŠŠæ‰‹â€ */

.reading-header {
    cursor: move;
    user-select: none;
    -webkit-user-select: none;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    gap: 10px;
    /* æ–°å¢ï¼šå¼·åˆ¶ä¸æ›è¡Œï¼Œä½œç‚ºé›™é‡ä¿éšª */
    flex-wrap: nowrap;
}

#reading-title {
    font-weight: 600;
    /* æ ¸å¿ƒï¼šè®“æ¨™é¡Œä½”æ“šæ‰€æœ‰å¯ç”¨ç©ºé–“ï¼Œä½†å…è¨±æ”¶ç¸® */
    flex: 1;
    min-width: 0;
    /* ä»¥ä¸‹ä¸‰è¡Œè² è²¬å¯¦ç¾çœç•¥è™Ÿæ•ˆæœ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.reading-controls {
    /* é—œéµï¼šå‘Šè¨´æŒ‰éˆ•å®¹å™¨çµ•å°ä¸è¦è¢«å£“ç¸® */
    flex-shrink: 0;
}

/* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
.reading-controls button {
    background: none; border: none; color: var(--text-secondary); padding: 4px 8px;
    border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s;
}
.reading-controls button:hover {
    background-color: rgba(0,0,0,0.1);
}
#minimize-reading-btn {
    font-weight: bold; font-size: 16px; line-height: 1;
}

/* 4. ã€æ ¸å¿ƒä¿®å¾©ã€‘æœ€å°åŒ–å¾Œçš„ç‹€æ…‹ï¼šä½¿å…¶é€æ˜ã€ç¸®å°ä¸¦ä¸å¯äº¤äº’ */
#reading-window.minimized {
    transform: scale(0.8); /* ç¸®å°æ•ˆæœ */
    opacity: 0;           /* é€æ˜æ•ˆæœ */
    pointer-events: none; /* ç¦æ­¢äº¤äº’ */
    visibility: hidden;   /* å¾¹åº•éš±è— */
}

/* 5. ã€æ ¸å¿ƒä¿®å¾©ã€‘æœ€å°åŒ–å¾Œç”¨æ–¼â€œæ¢å¾©â€çš„å°çƒï¼Œæ”¹ç‚ºè¢å¹•å±…ä¸­ */
#reading-restore-btn {
    position: absolute;
    /* --- æ ¸å¿ƒä¿®æ”¹1ï¼šå¾å±…ä¸­æ”¹ç‚ºé å³ --- */
    top: 50%;
    right: 15px; /* è·é›¢å³å´é‚Šç·£15åœ–å…ƒ */
    /* ã€é—œéµã€‘åªåœ¨Yè»¸ä¸Šå‚ç›´å±…ä¸­ï¼Œä¸å†éœ€è¦Xè»¸çš„å¹³ç§» */
    transform: translateY(-50%); 
    /* --- ä¿®æ”¹çµæŸ --- */
    width: 50px; 
    height: 50px;
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; 
    cursor: move; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    pointer-events: auto; 
    z-index: 160; 
    transition: transform 0.2s; 
}
#reading-restore-btn:active {
    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ä¿®å¾©é»æ“Šæ™‚çš„ä½ç§»å•é¡Œ */
    transform: translateY(-50%) scale(0.95);
}
#phone-screen.dark-mode #reading-restore-btn {
    background-color: rgba(50, 50, 52, 0.8);
}

/* 6. å…§å®¹å’Œé è…³æ¨£å¼ (ä¿æŒä¸è®Š) */
#reading-content {
    flex-grow: 1; 
    overflow-y: auto; 
    padding: 15px;
    font-size: 15px; 
    line-height: 1.8;
    /* â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ â–¼â–¼â–¼ */
    white-space: pre-wrap; /* ä¿æŒåˆ†è¡Œç¬¦è™Ÿï¼ŒåŒæ™‚å…è¨±é•·å–®è©è‡ªå‹•æ›è¡Œ */
    word-break: break-word;  /* å¼·åˆ¶é•·å–®è©æˆ–URLæ–·é–‹ï¼Œé˜²æ­¢æ’ç ´ä½ˆå±€ */
    /* â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² */
}
.reading-footer {
    flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
    padding: 12px 15px; border-top: 1px solid var(--border-color);
}
#page-indicator {
    font-size: 14px; 
    color: var(--text-secondary);
    cursor: pointer; /* æ·»åŠ æ‰‹å‹æ¸¸æ¨™ï¼Œæç¤ºç”¨æˆ¶å¯ä»¥é»æ“Š */
    transition: color 0.2s;
}
#page-indicator:hover {
    color: var(--accent-color); /* æ»‘é¼ æ‡¸åœæ™‚è®Šè‰² */
}
.reading-footer button {
    padding: 6px 15px; border-radius: 15px; border: none;
    background-color: var(--accent-color); color: white; cursor: pointer;
}
.reading-footer button:disabled {
    background-color: #ccc;
}
#phone-screen.dark-mode .reading-footer button:disabled {
    background-color: #555;
}

/* â–²â–²â–² V2.1 CSS æ›¿æ›çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºæ›¸åº«æœç´¢åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */
#reading-library-search-container {
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
}
#reading-library-search-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 16px; /* é¿å…åœ¨iOSä¸Šè¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§é é¢ */
    -webkit-appearance: none; /* ç§»é™¤iOSä¸Šçš„é è¨­æ¨£å¼ */
}
#phone-screen.dark-mode #reading-library-search-input {
    background-color: #2c2c2e;
    color: #f0f0f0;
    border-color: #38383a;
}
/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èªéŸ³è¨Šæ¯å…ƒä»¶æ¨£å¼ â–¼â–¼â–¼ */

.voice-message-body {
    display: flex;
    align-items: center;
    cursor: pointer;
    min-width: 80px;
    max-width: 220px;
    padding: 8px 12px;
}
.message-bubble.user .voice-message-body {
    color: #1a3d00;
    flex-direction: row-reverse;
}
.message-bubble.ai .voice-message-body {
    color: var(--text-primary);
}

.voice-play-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: currentColor;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: background-color 0.2s;
}
.voice-play-btn:hover {
    background-color: rgba(0, 0, 0, 0.2);
}

.voice-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: none; /* é»˜èªéš±è— */
    margin: 4px;
}

.voice-duration {
    font-size: 14px;
    font-weight: 500;
    margin: 0 10px;
    flex-shrink: 0;
}
.message-bubble.user .voice-duration {
    color: #3e6224;
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä»¿æ·˜å¯¶é¢¨æ ¼çš„å•†å“åˆ†é¡é ç°½æ¨£å¼ â–¼â–¼â–¼ */

#product-category-tabs {
    display: flex;
    overflow-x: auto; /* å…è¨±æ©«å‘æ»¾å‹• */
    padding: 10px 15px 0 15px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--secondary-bg);

    /* éš±è—æ²è»¸ï¼Œè®“ä»‹é¢æ›´ä¹¾æ·¨ */
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}
#product-category-tabs::-webkit-scrollbar {
    display: none; /* Chrome, Safari, and Opera */
}

/* å–®å€‹é ç°½æŒ‰éˆ•çš„æ¨£å¼ */
.product-category-tab {
    padding: 8px 16px;
    cursor: pointer;
    border: none;
    background-color: transparent;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent; /* é»˜èªä¸‹æ–¹é‚Šæ¡†æ˜¯é€æ˜çš„ */
    margin-bottom: -1px; /* è®“åº•é‚Šæ¡†èˆ‡å®¹å™¨é‚Šæ¡†é‡åˆ */
    transition: all 0.2s ease-in-out;
    white-space: nowrap; /* é˜²æ­¢åˆ†é¡åæ›è¡Œ */
    flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
}

/* å•Ÿå‹•çš„é ç°½æ¨£å¼ */
.product-category-tab.active {
    color: #FF5722; /* æ·˜å¯¶æ¨™èªŒæ€§çš„æ©™ç´…è‰² */
    border-bottom-color: #FF5722; /* ä¸‹æ–¹é¡¯ç¤ºæ©™ç´…è‰²ç·šæ¢ */
    font-weight: 600; /* å­—é«”åŠ ç²— */
}

#phone-screen.dark-mode .product-category-tab.active {
    color: #FF8A65; /* å¤œé–“æ¨¡å¼ä¸‹ä½¿ç”¨æŸ”å’Œä¸€é»çš„æ©™è‰² */
    border-bottom-color: #FF8A65;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä¿®å¾©è³¼ç‰©ä¸­å¿ƒåˆ†é¡æ¬„æ©«å‘æ»¾å‹•çš„ä»£ç¢¼ â–¼â–¼â–¼ */

#product-category-tabs {
    /* --- æ ¸å¿ƒä»£ç¢¼é–‹å§‹ --- */
    overflow-x: auto;      /* 1. å…è¨±åœ¨æ°´æº–æ–¹å‘ä¸Šæ»¾å‹• */
    white-space: nowrap;   /* 2. å¼·åˆ¶æ‰€æœ‰åˆ†é¡é …ä¸æ›è¡Œï¼Œä¿æŒåœ¨åŒä¸€è¡Œ */
    /* --- æ ¸å¿ƒä»£ç¢¼çµæŸ --- */

    /* (å¯é¸ä½†æ¨è–¦) ä»¥ä¸‹ä»£ç¢¼ç”¨æ–¼ç¾åŒ–ï¼Œå¯ä»¥åœ¨ç§»å‹•è¨­å‚™ä¸Šéš±è—é†œé™‹çš„æ²è»¸ï¼Œä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ */
    -webkit-overflow-scrolling: touch; /* åœ¨iOSä¸Šæä¾›æ›´æµæš¢çš„æ»¾å‹•é«”é©— */
    scrollbar-width: none;             /* éš±è— Firefox çš„æ²è»¸ */
    -ms-overflow-style: none;          /* éš±è— IE/Edge çš„æ²è»¸ */
}

/* éš±è— WebKit æµè¦½å™¨ (Chrome, Safari) çš„æ²è»¸ */
#product-category-tabs::-webkit-scrollbar {
    display: none; 
}

/* (å¯é¸ä½†æ¨è–¦) ç¢ºä¿æ¯å€‹åˆ†é¡æŒ‰éˆ•æœ¬èº«ä¸æœƒè¢«æ„å¤–å£“ç¸®è®Šå½¢ */
.product-category-tab {
    flex-shrink: 0;
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºå•†å“ç®¡ç†æ‰¹é‡åˆªé™¤åŠŸèƒ½æ·»åŠ çš„ã€å…¨éƒ¨CSSæ¨£å¼ã€‘ï¼Œè«‹é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

        /* 1. ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç‚ºå•†å“å¡ç‰‡æ·»åŠ æ‰‹å‹æ¸¸æ¨™ */
        #shopping-screen.management-mode .product-item {
            cursor: pointer;
        }
        
        /* 2. åœ¨ç®¡ç†æ¨¡å¼ä¸‹ï¼Œéš±è—èˆŠçš„â€œç·¨è¼¯/åˆªé™¤â€æµ®å±¤ */
        #shopping-screen.management-mode .product-management-overlay {
            display: none;
        }

        /* 3. é¸æ“‡æ¡†çš„æ¨£å¼ (ä»¿æˆ‘çš„æœ€æ„›) */
        #shopping-screen.management-mode .product-item::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 22px;
            height: 22px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
            z-index: 6; /* ç¢ºä¿åœ¨åœ–ç‰‡ä¹‹ä¸Š */
        }

        /* 4. é¸ä¸­å¾Œçš„æ¨£å¼ */
        #shopping-screen.management-mode .product-item.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: 'âœ”';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 22px;
        }

        /* 5. åœ¨ç®¡ç†æ¨¡å¼ä¸‹ï¼Œè¼•å¾®èª¿æš—æœªé¸ä¸­çš„å¡ç‰‡ï¼Œçªå‡ºå¯é¸ç‹€æ…‹ */
        #shopping-screen.management-mode .product-item:not(.selected) {
            opacity: 0.8;
        }

        /* 6. åº•éƒ¨æ“ä½œæ¬„ (ä»¿æˆ‘çš„æœ€æ„›) */
        #shopping-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none; /* é»˜èªéš±è— */
            justify-content: space-between;
            align-items: center;
        }

        #shopping-action-bar .select-all-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
        }

        #shopping-action-bar .action-bar-btn {
            padding: 10px 25px;
            border-radius: 20px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        /* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºä¸»è¢å¹•ç¬¬äºŒå±æ·»åŠ çš„æ‹ç«‹å¾—å°å…ƒä»¶æ¨£å¼ â–¼â–¼â–¼ */

/* 1. å°çµ„ä»¶ç¸½å®¹å™¨ */
.polaroid-widget-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px; /* å’Œä¸‹æ–¹çš„Appåœ–ç¤ºæ‹‰é–‹è·é›¢ */
    flex-shrink: 0;
    
    /* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼ --- */
    margin-top: 20px; /* æ·»åŠ å’Œç¬¬ä¸€å±åŒæ¨£çš„é ‚éƒ¨å¤–é‚Šè· */
    /* --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² --- */
}

/* 2. ä¸‰å¼µç…§ç‰‡çš„å®¹å™¨ */
.polaroid-photos {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px; /* ç…§ç‰‡ä¹‹é–“çš„è¼•å¾®é–“è· */
}

/* 3. å–®å¼µæ‹ç«‹å¾—ç…§ç‰‡çš„æ¨£å¼ */
.polaroid-photo {
    background-color: white;
    padding: 8px 8px 15px 8px; /* é ‚éƒ¨å’Œå·¦å³8pxï¼Œåº•éƒ¨15pxï¼Œæ¨¡æ“¬æ‹ç«‹å¾—çš„ç™½é‚Š */
    border-radius: 4px;
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2); /* æ›´æŸ”å’Œçš„é™°å½± */
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s;
    width: 80px; /* è¨­ç½®ä¸€å€‹å›ºå®šå¯¬åº¦ */
    flex-shrink: 0;
}
.polaroid-photo:hover {
    transform: scale(1.1) rotate(0deg) !important; /* æ»‘é¼ æ‡¸åœæ™‚æ”¾å¤§ä¸¦æ“ºæ­£ */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    z-index: 10; /* ç¢ºä¿æ‡¸åœçš„ç…§ç‰‡åœ¨æœ€ä¸Šå±¤ */
}

/* 4. æ‹ç«‹å¾—å…§éƒ¨çš„åœ–ç‰‡ */
.polaroid-photo img {
    width: 100%;
    display: block;
    aspect-ratio: 1 / 1; /* ä¿æŒåœ–ç‰‡ç‚ºæ­£æ–¹å½¢ */
    object-fit: cover;
}

/* 5. å°çµ„ä»¶æ¨™é¡Œ */
.polaroid-widget-title {
    margin-top: 15px;
    font-size: 13px;
    font-weight: 500;
    color: white; /* èˆ‡ä¸»è¢å¹•å…¶ä»–æ–‡å­—é¡è‰²çµ±ä¸€ */
    text-shadow: 0 1px 3px rgba(0,0,0,0.4); /* èˆ‡ä¸»è¢å¹•å…¶ä»–æ–‡å­—é™°å½±çµ±ä¸€ */
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°æ¨£å¼é»è²¼åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

#page-2-app-container {
    display: grid;
    /* --- The core change is on this line --- */
    grid-template-columns: 155px 1fr; /* Set a fixed width for the left widget */
    gap: 15px;
    width: 100%;
    padding-top: 20px;
    align-items: start;
}
/* 2. å³å´ 2x2 å°çµ„ä»¶çš„ç¶²æ ¼å®¹å™¨ */
.app-subgrid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* å…§éƒ¨æ˜¯2åˆ—å‡åˆ† */
    gap: 15px; /* å°å…ƒä»¶ä¹‹é–“çš„é–“è· */
}

/* 3. å·¦å´å¤§å…ƒä»¶çš„æ¨£å¼ */
.large-widget {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px; /* åœ–ç‰‡å’Œæ–‡å­—çš„é–“è· */
}
.large-widget-img {
    width: 100%;
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    border-radius: 22px; /* iOSé¢¨æ ¼åœ“è§’ */
    object-fit: cover;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.large-widget-label {
    color: white;
    font-size: 13px;
    font-weight: 500;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}

/* 4. å³å´å°å…ƒä»¶çš„é€šç”¨æ¨£å¼ */
.small-widget {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
/* æ–°å¢ä¸€å€‹åŒ…è£å™¨ï¼Œç”¨æ–¼æ§åˆ¶å°åœ–ç¤ºçš„å¤§å°å’Œå±…ä¸­ */
.small-widget-icon-wrapper {
    width: 55px;
    height: 55px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.small-widget-img {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤ max-width å’Œ max-height */
    width: 100%;     /* è®“åœ–ç‰‡å¯¬åº¦å¡«æ»¿ 55px çš„çˆ¶å®¹å™¨ */
    height: 100%;    /* è®“åœ–ç‰‡é«˜åº¦å¡«æ»¿ 55px çš„çˆ¶å®¹å™¨ */
    object-fit: cover; /* ç¢ºä¿åœ–ç‰‡ä¸è®Šå½¢åœ°å¡«æ»¿ */
    border-radius: 14px; /* æ¨è–¦ï¼šç‚ºåœ–ç¤ºæœ¬èº«ä¹ŸåŠ ä¸Šåœ“è§’ï¼Œèˆ‡Dockæ¬„åœ–ç¤ºé¢¨æ ¼çµ±ä¸€ */
}
.small-widget-label {
    color: white;
    font-size: 13px;
    font-weight: 500;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è®“ä¸»è¢å¹•ç¬¬äºŒå±å°å…ƒä»¶å­—é«”è®Šé»‘çš„æ¨£å¼ â–¼â–¼â–¼ */

#page-2-app-container .small-widget-label {
    color: #000 !important;       /* æ ¸å¿ƒï¼šå¼·åˆ¶å°‡æ–‡å­—é¡è‰²è¨­ç‚ºé»‘è‰² */
    text-shadow: none !important; /* æ¨è–¦ï¼šç§»é™¤æ–‡å­—é™°å½±ï¼Œè®“é»‘è‰²å­—é«”æ›´æ¸…æ™° */
}

/* â–²â–²â–² æ–°å¢CSSçµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®å¾©Cphoneå…§éƒ¨Appæ¸…å–®é …åœ¨å¤œé–“æ¨¡å¼ä¸‹çš„é¡è‰² â–¼â–¼â–¼ */

#phone-screen.dark-mode #char-diary-list .list-item .item-title,
#phone-screen.dark-mode #char-diary-list .list-item .item-content,
#phone-screen.dark-mode #char-memo-list .list-item .item-title,
#phone-screen.dark-mode #char-memo-list .list-item .item-content,
#phone-screen.dark-mode #char-browser-history .char-browser-item .title,
#phone-screen.dark-mode #char-usage-list .usage-item-name,
#phone-screen.dark-mode #char-music-list .music-item-name {
    color: #f0f0f0; /* å°‡ä¸»è¦æ–‡å­—å¼·åˆ¶è¨­ç‚ºäº®ç°è‰² */
}

#phone-screen.dark-mode #char-diary-list .list-item .item-content,
#phone-screen.dark-mode #char-browser-history .char-browser-item .url,
#phone-screen.dark-mode #char-usage-list .usage-item-category,
#phone-screen.dark-mode #char-music-list .music-item-artist {
    color: #a0a0a0; /* å°‡æ¬¡è¦æ–‡å­—ï¼ˆå¦‚æ—¥æœŸã€ç¶²å€ï¼‰è¨­ç‚ºæŸ”å’Œçš„ç°è‰² */
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®å¾©æ—¥è¨˜è©³æƒ…é è‡ªè¨‚Markdownæ¨£å¼åœ¨å¤œé–“æ¨¡å¼ä¸‹çš„å¯è¦‹æ€§ â–¼â–¼â–¼ */

/* 1. é»ƒè‰²é«˜äº® */
#phone-screen.dark-mode #char-diary-detail-content .diary-highlight {
    background-color: rgba(255, 223, 100, 0.2); /* æš—é»ƒè‰²èƒŒæ™¯ */
    color: #FFD700; /* äº®é»ƒè‰²æ–‡å­— */
}

/* 2. ç²‰è‰²è™›ç·šåº•ç·š */
#phone-screen.dark-mode #char-diary-detail-content .diary-underline {
    border-bottom-color: #FF85B3; /* æ›´äº®çš„ç²‰è‰² */
}

/* 3. ç²‰ç´…è‰²åŠ ç²—æ–‡å­— */
#phone-screen.dark-mode #char-diary-detail-content .diary-emphasis {
    color: #FF85B3; /* æ›´äº®çš„ç²‰è‰² */
}

/* 4. æ‰‹å¯«é«” (åŒ…æ‹¬æ·©äº‚æ‰‹å¯«é«”) */
#phone-screen.dark-mode #char-diary-detail-content .diary-handwritten,
#phone-screen.dark-mode #char-diary-detail-content .diary-messy {
    color: #dcdcdc; /* æ·ºç°è‰²ï¼Œç¢ºä¿å¯è¦‹ */
}

/* â–¼â–¼â–¼ ã€å…¨æ–° | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä¿®å¾©èŠå¤©ä»‹é¢â€œå¡—é»‘â€åŠŸèƒ½åœ¨å¤œé–“æ¨¡å¼ä¸‹çš„å¯è¦‹æ€§ â–¼â–¼â–¼ */

/* 1. å¤œé–“æ¨¡å¼ä¸‹ï¼Œâ€œå¡—é»‘â€å€åŸŸçš„é è¨­æ¨£å¼ */
#phone-screen.dark-mode .spoiler {
    background-color: #444; /* å°‡èƒŒæ™¯æ”¹ç‚ºä¸­åº¦ç°è‰²ï¼Œä»¥ä¾¿åœ¨ç´”é»‘èƒŒæ™¯ä¸‹èƒ½è¢«çœ‹åˆ° */
    color: #444;           /* æ–‡å­—ä¹Ÿæ”¹ç‚ºåŒæ¨£çš„ç°è‰²ï¼Œä¿æŒéš±è—æ•ˆæœ */
}

/* 2. å¤œé–“æ¨¡å¼ä¸‹ï¼Œæ»‘é¼ æ‡¸åœæˆ–é»æ“Šæ™‚ï¼Œé¡¯ç¤ºå…§å®¹ */
#phone-screen.dark-mode .spoiler:hover, 
#phone-screen.dark-mode .spoiler:active {
    background-color: #555; /* èƒŒæ™¯è®Šç‚ºæ›´äº®çš„ç°è‰²ï¼Œèˆ‡å‘¨åœæœ‰å€åˆ† */
    color: #fff;           /* æ–‡å­—è®Šç‚ºç™½è‰²ï¼Œæ¸…æ™°å¯è¦‹ */
}

/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é ­åƒæ¡†æ‰¹é‡åˆªé™¤åŠŸèƒ½æ¨£å¼ â–¼â–¼â–¼ */

/* 1. ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç‚ºé ­åƒæ¡†ç¶²æ ¼æ·»åŠ ä¸€å€‹classï¼Œç”¨æ–¼æ¨£å¼æ§åˆ¶ */
#avatar-frame-modal .frame-grid.management-mode .frame-item {
    cursor: pointer;
}

/* 2. ç®¡ç†æ¨¡å¼ä¸‹ï¼Œç‚ºè‡ªè¨‚é ­åƒæ¡†æ·»åŠ ä¸€å€‹é¸ä¸­æ¡†çš„å½å…ƒç´  */
/*    æ³¨æ„ï¼šæˆ‘å€‘åªç‚ºå¸¶æœ‰ .delete-btn çš„è‡ªè¨‚é ­åƒæ¡†æ·»åŠ å¯é¸æ•ˆæœ */
#avatar-frame-modal .frame-grid.management-mode .frame-item:has(.delete-btn)::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    width: calc(100% + 4px);
    height: calc(100% + 4px);
    border: 3px solid transparent;
    border-radius: 12px;
    box-sizing: border-box;
    transition: border-color 0.2s;
    pointer-events: none; /* ç¢ºä¿ä¸å½±éŸ¿é»æ“Š */
}

/* 3. ç®¡ç†æ¨¡å¼ä¸‹ï¼Œè¢«é¸ä¸­çš„è‡ªè¨‚é ­åƒæ¡†ï¼Œé¡¯ç¤ºè—è‰²é‚Šæ¡† */
#avatar-frame-modal .frame-grid.management-mode .frame-item.selected::after {
    border-color: var(--accent-color);
}

/* 4. åº•éƒ¨æ‰¹é‡åˆªé™¤æ“ä½œæ¬„ (è¤‡ç”¨å·²æœ‰æ¨£å¼) */
#frame-action-bar {
    display: none; /* é»˜èªéš±è— */
    flex-shrink: 0;
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    justify-content: space-between;
    align-items: center;
}

#frame-action-bar .select-all-label {
    font-size: 16px;
    color: var(--text-primary);
    cursor: pointer;
}

#frame-action-bar .action-bar-btn {
    padding: 10px 25px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢CSSé»è²¼çµæŸ â–²â–²â–² */
    </style>
</head>
<body>
    <div id="phone-screen">
        <div id="status-bar">
            <span id="status-bar-time">12:00</span>
            <div id="status-bar-battery" class="battery-container">
                <span class="battery-text">--%</span>
                <div class="battery-icon">
                    <div class="battery-level"></div>
                </div>
            </div>
        </div>
        <div id="notification-bar"><img id="notification-avatar" src="">
            <div id="notification-content">
                <div class="name"></div>
                <div class="message"></div>
            </div>
        </div>
<!-- â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰æ‚¨ç¾æœ‰çš„ <div id="home-screen" ...> ... </div> â–¼â–¼â–¼ -->

<div id="home-screen" class="screen active">

    <!-- 1. é é¢æ»‘å‹•å®¹å™¨ -->
    <div id="home-screen-pages-container">
        <div id="home-screen-pages">
            <!-- é é¢ 1: ä¿æŒæ‚¨åŸæœ‰çš„ä½ˆå±€ -->
            <div class="home-screen-page">
                <div id="main-content-area">
                    <div id="profile-widget">
                        <img id="profile-banner-img" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                        <div class="profile-avatar-container">
                            <img id="profile-avatar-img" src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" class="editable-image">
                        </div>
                        <div class="profile-info">
                            <p id="profile-username" class="editable-text">@ insonneve ğŸª¦</p>
                            <p id="profile-sub-username" class="editable-text">@ insonneve</p>
                            <p id="profile-bio" class="editable-text">ä½ å¥½åƒéå¾—å¾ˆå¥½ è¿«ä¸åŠå¾…çš„æŠ¹å»æˆ‘å­˜åœ¨çš„ç—•è·¡</p>
                            <p id="profile-location" class="editable-text">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5-2.5-1.12 2.5-2.5 2.5z"></path></svg>
                                <span>åŒ—æµ·é“</span>
                            </p>
                        </div>
                    </div>
                    <div id="desktop-layout">
                        <div id="desktop-widget-column">
                            <div class="desktop-widget text-only">
                                <p id="widget-text-1" class="editable-text">Be fearless in pursuit of happiness</p>
                            </div>
                            <div class="desktop-widget icon-left">
                                <img id="widget-avatar-1" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                                <span id="widget-text-2" class="editable-text">Dare to be different</span>
                            </div>
                            <div class="desktop-widget icon-right">
                                <span id="widget-text-3" class="editable-text">* Keep your spirit free</span>
                                <img id="widget-avatar-2" src="https://i.imgur.com/5A0tE9a.jpeg" class="editable-image">
                            </div>
                        </div>
                        <div id="desktop-app-container">
                            <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')">
                                <div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div>
                                <span class="label">QQ</span>
                            </div>
                            <div class="desktop-app-icon" onclick="showScreen('world-book-screen')">
                                <div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="ä¸–ç•Œæ›¸"></div>
                                <span class="label">ä¸–ç•Œæ›¸</span>
                            </div>
                            <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
                                <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="å¤–è§€è¨­ç½®"></div>
                                <span class="label">å¤–è§€è¨­ç½®</span>
                            </div>
                            <div class="desktop-app-icon" onclick="openRenderingRulesScreen()">
                                <div class="icon-bg-desktop"><img id="icon-img-renderer" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="æ¸²æŸ“å™¨"></div>
                                <span class="label">æ¸²æŸ“å™¨</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- é é¢ 2: æ”¾ç½®æ–°Appåœ–ç¤ºçš„åœ°æ–¹ -->
<div class="home-screen-page">
 <div class="polaroid-widget-container">
    <div class="polaroid-photos">
        <!-- ç…§ç‰‡1 -->
        <div class="polaroid-photo" style="transform: rotate(-6deg);" onclick="handleWidgetImageChange('polaroid-img-1')">
            <img id="polaroid-img-1" src="https://i.imgur.com/Bv63o3h.jpg" alt="Photo 1">
        </div>
        <!-- ç…§ç‰‡2 -->
        <div class="polaroid-photo" style="transform: rotate(2deg);" onclick="handleWidgetImageChange('polaroid-img-2')">
            <img id="polaroid-img-2" src="https://i.imgur.com/GzPzBfF.jpg" alt="Photo 2">
        </div>
        <!-- ç…§ç‰‡3 -->
        <div class="polaroid-photo" style="transform: rotate(5deg);" onclick="handleWidgetImageChange('polaroid-img-3')">
            <img id="polaroid-img-3" src="https://i.imgur.com/Wp72cEM.jpg" alt="Photo 3">
        </div>
    </div>
</div>
<div id="page-2-app-container">
    <!-- 1. å·¦å´å¤§å…ƒä»¶ (ä¿æŒå¯é»æ“Šæ›´æ›åœ–ç‰‡) -->
    <div class="large-widget" onclick="handleWidgetImageChange('large-widget-img')">
        <img class="large-widget-img" id="large-widget-img" src="https://i.imgur.com/Bv63o3h.jpg" alt="Colorful Widget">
    </div>
    <!-- 2. å³å´ 2x2 å°çµ„ä»¶ç¶²æ ¼ (æ¢å¾©Appé»æ“Šäº‹ä»¶) -->
                <div class="app-subgrid">
                    <div class="small-widget" onclick="openPresetScreen()">
                        <div class="small-widget-icon-wrapper">
                            <img class="small-widget-img" id="icon-img-preset" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg" alt="é è¨­">
                        </div>
                        <span class="small-widget-label">é è¨­</span>
                    </div>
                    <div class="small-widget" onclick="showScreen('tutorial-screen')">
                        <div class="small-widget-icon-wrapper">
                            <img class="small-widget-img" id="icon-img-tutorial" src="https://i.postimg.cc/d10GjC4g/IMG-7302.jpg" alt="æ•™ç¨‹">
                        </div>
                        <span class="small-widget-label">æ•™ç¨‹</span>
                    </div>
                    <div class="small-widget" onclick="openWerewolfLobby('global')">
                        <div class="small-widget-icon-wrapper">
                            <img class="small-widget-img" id="icon-img-werewolf" src="https://i.postimg.cc/k401K5g7/IMG-7304.jpg" alt="ç‹¼äººæ®º">
                        </div>
                        <span class="small-widget-label">ç‹¼äººæ®º</span>
                    </div>
                    <div class="small-widget" onclick="showScreen('x-social-screen')">
                        <div class="small-widget-icon-wrapper">
                            <img class="small-widget-img" id="icon-img-x" src="https://s3plus.meituan.net/opapisdk/op_ticket_1_885190757_1760887395449_qdqqd_nf1k0e.png " alt="X">
                        </div>
                        <span class="small-widget-label">X</span>
                    </div>
                </div>
</div>
        </div>
    </div>
</div>

    <!-- 2. åˆ†é æŒ‡ç¤ºå™¨ -->
    <div id="home-screen-pagination">
        <div class="pagination-dot active"></div>
        <div class="pagination-dot"></div>
    </div>

    <!-- 3. åº•éƒ¨ Dock (å·²ç‚ºæ‚¨è£œå…¨æ‰€æœ‰æ–‡å­—) -->
    <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIè¨­ç½®"></div>
            <span class="label">APIè¨­ç½®</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="å­—é«”"></div>
            <span class="label">å­—é«”</span>
        </div>
        <div class="desktop-app-icon" onclick="openCharacterSelector()">
            <div class="icon-bg-desktop"><img id="icon-img-char-phone" src="https://i.postimg.cc/pXj9h20L/IMG-7275.jpg" alt="Cphone"></div>
            <span class="label">Cphone</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('douban-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-douban" src="https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg" alt="è±†ç“£"></div>
            <span class="label">è±†ç“£</span>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneåŠŸèƒ½çš„æ‰€æœ‰HTMLè¢å¹• â–¼â–¼â–¼ -->

<!-- 1. è§’è‰²é¸æ“‡è¢å¹• -->
<div id="character-selection-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é¸æ“‡ä¸€éƒ¨æ‰‹æ©Ÿ</span>
        <span style="width: 30px;"></span>
    </div>
    <div id="character-grid" class="list-container">
        <!-- è§’è‰²æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€V3.0 å…¨æ–°ç‰ˆæœ¬ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ #character-phone-screen â–¼â–¼â–¼ -->
<div id="character-phone-screen" class="screen">
    
    <!-- 1. Cphone - ä¸»è¢å¹• (é€™æ˜¯å®ƒæ‡‰è©²åœ¨çš„ä½ç½®ï¼Œä½œç‚ºç¨ç«‹çš„é é¢) -->
    <div id="char-home-screen" class="char-screen active">
        <div id="char-clock-container">
            <div id="char-main-time">12:00</div>
            <div id="char-main-date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
        </div>
        <div id="char-app-grid">
            <div class="app-row">
                <div class="app-icon" onclick="openCharApp('qq')"><div class="icon-bg"><img id="cphone-icon-img-qq" src=""></div><span class="label">QQ</span></div>
                <div class="app-icon" onclick="openCharApp('album')"><div class="icon-bg"><img id="cphone-icon-img-album" src=""></div><span class="label">ç›¸å†Š</span></div>
                <div class="app-icon" onclick="openCharApp('browser')"><div class="icon-bg"><img id="cphone-icon-img-browser" src=""></div><span class="label">æµè¦½å™¨</span></div>
                <div class="app-icon" onclick="openCharApp('taobao')"><div class="icon-bg"><img id="cphone-icon-img-taobao" src=""></div><span class="label">æ·˜å¯¶</span></div>
            </div>
            <div class="app-row">
                <div class="app-icon" onclick="openCharApp('memo')"><div class="icon-bg"><img id="cphone-icon-img-memo" src=""></div><span class="label">å‚™å¿˜éŒ„</span></div>
                <div class="app-icon" onclick="openCharApp('diary')"><div class="icon-bg"><img id="cphone-icon-img-diary" src=""></div><span class="label">æ—¥è¨˜</span></div>
                <div class="app-icon" onclick="openCharApp('amap')"><div class="icon-bg"><img id="cphone-icon-img-amap" src=""></div><span class="label">é«˜å¾·åœ°åœ–</span></div>
                <div class="app-icon" onclick="openCharApp('usage')"><div class="icon-bg"><img id="cphone-icon-img-usage" src=""></div><span class="label">Appè¨˜éŒ„</span></div>
            </div>
            <div class="app-row">
                <div class="app-icon" onclick="openCharApp('music')"><div class="icon-bg"><img id="cphone-icon-img-music" src=""></div><span class="label">ç¶²æ˜“é›²</span></div>
                <div class="app-icon" onclick="switchToMyPhone()"><div class="icon-bg"><img id="cphone-icon-img-ephone" src=""></div><span class="label">Ephone</span></div>
            </div>
        </div>
    </div>
<div id="char-amap-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>è¶³è·¡</span>
        <div class="header-actions">
            <span class="action-btn" id="regenerate-char-amap-btn" title="é‡æ–°ç”Ÿæˆè¶³è·¡">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-amap-list" class="list-container">
        <!-- è¶³è·¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
    <!-- 2. Cphone - QQ App åˆ—è¡¨é  -->
    <div id="char-qq-screen" class="char-screen">
        <div class="header">
            <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
            <span>QQ</span>
            <div class="header-actions">
                <span class="action-btn" id="regenerate-char-qq-btn" title="é‡æ–°ç”Ÿæˆ">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                    </svg>
                </span>
            </div>
        </div>
        <div id="char-chat-list" class="list-container"></div>
    </div>
    
    <!-- 3. Cphone - é¡æ¯”å°è©±é é¢ -->
    <div id="char-qq-conversation-screen" class="char-screen">
        <div class="header">
            <span class="back-btn" id="back-to-char-qq-list-btn">â€¹</span>
            <span id="char-conversation-partner-name"></span>
            <span style="width: 30px;"></span>
        </div>
        <div id="char-conversation-messages" class="list-container">
        </div>
        <div id="char-conversation-input-area" style="padding: 8px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; background-color: #f7f7f7;">
            <input type="text" id="char-simulated-input" placeholder="é€™æ˜¯é¡æ¯”å°è©±ï¼Œç„¡æ³•ç™¼é€æ¶ˆæ¯" disabled style="flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; background: #eee;">
            <button id="char-simulated-send-btn" style="padding: 0 20px; border: none; background-color: var(--accent-color); color: white; border-radius: 6px; font-weight: 500;">ç™¼é€</button>
        </div>
    </div>
    
    <!-- 4. Cphone - ç›¸å†Š App é é¢ (é€™æ˜¯å®ƒæ‡‰è©²åœ¨çš„ä½ç½®ï¼Œèˆ‡ä¸»è¢å¹•å¹³ç´š) -->
    <div id="char-album-screen" class="char-screen">
        <div class="header">
            <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
            <span>TAçš„ç›¸å†Š</span>
            <div class="header-actions">
                <span class="action-btn" id="regenerate-char-album-btn" title="é‡æ–°ç”Ÿæˆç›¸å†Šå…§å®¹">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                    </svg>
                </span>
            </div>
        </div>
        <div class="list-container">
            <div id="char-album-grid"></div>
        </div>
    </div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æ”¯æ´æ–‡ç« /åœ–ç‰‡ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ #char-browser-screen â–¼â–¼â–¼ -->
<div id="char-browser-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>TAçš„æµè¦½å™¨æ­·å²</span>
        <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
        <div class="header-actions">
            <span class="action-btn" id="regenerate-char-browser-btn" title="é‡æ–°ç”Ÿæˆæµè¦½è¨˜éŒ„">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-browser-history" class="list-container">
        <!-- æµè¦½è¨˜éŒ„å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>

<!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šå…¨æ–°çš„æ–‡ç« æŸ¥çœ‹é é¢ã€‘ã€‘ã€‘ -->
<div id="char-browser-article-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharScreen('char-browser-screen')">â€¹</span>
        <span id="char-article-title" style="max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">æ–‡ç« </span>
        <span style="width: 30px;"></span>
    </div>
    <div id="char-article-content" class="list-container" style="padding: 20px; font-size: 16px; line-height: 1.8; color: #333; overflow-y: auto;">
        <!-- æ–‡ç« æˆ–åœ–ç‰‡å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æ”¯æŒéŒ¢åŒ…ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ #char-taobao-screen â–¼â–¼â–¼ -->
<div id="char-taobao-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>TAçš„æ·˜å¯¶è¨‚å–®</span>
        <div class="header-actions">
            
            <!-- ã€æ ¸å¿ƒæ–°å¢2ã€‘é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
            <span class="action-btn" id="regenerate-char-taobao-btn" title="é‡æ–°ç”Ÿæˆè³¼è²·è¨˜éŒ„">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <!-- è³¼è²·è¨˜éŒ„æ¸…å–® (è¤‡ç”¨èˆŠçš„gridï¼Œä½†å…§å®¹æœƒæ˜¯å‹•æ…‹çš„) -->
    <div id="char-product-grid" class="list-container"></div>
</div>


<div id="char-memo-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>å‚™å¿˜éŒ„</span>
        <div class="header-actions">
            <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
            <span class="action-btn" id="regenerate-char-memo-btn" title="é‡æ–°ç”Ÿæˆå‚™å¿˜éŒ„">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
            <span class="action-btn" id="add-char-memo-btn">+</span>
        </div>
    </div>
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¢ºä¿åˆ—è¡¨æœ‰å…§é‚Šè·ï¼Œæ›´ç¾è§€ -->
    <div id="char-memo-list" class="list-container" style="padding: 10px;"></div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ #char-memo-screen çš„ div ä¹‹å¾Œï¼Œé»è²¼é€™å€‹å…¨æ–°çš„å‚™å¿˜éŒ„è©³æƒ…è¢å¹• â–¼â–¼â–¼ -->
<div id="char-memo-detail-screen" class="char-screen">
    <div class="header">
        <!-- é€™å€‹è¿”å›æŒ‰éˆ•æœƒå¸¶æˆ‘å€‘å›åˆ°å‚™å¿˜éŒ„åˆ—è¡¨ -->
        <span class="back-btn" id="char-memo-detail-back-btn">â€¹</span>
        <!-- é€™è£¡æœƒå‹•æ…‹é¡¯ç¤ºå‚™å¿˜éŒ„çš„æ¨™é¡Œ -->
        <span id="char-memo-detail-title"></span>
        <!-- å³ä¸Šè§’çš„é ç•™ä½ç½®ï¼Œä¿æŒæ¨™é¡Œå±…ä¸­ -->
        <span style="width: 80px;"></span>
    </div>
    <!-- é€™å€‹å®¹å™¨å°‡ç”¨ä¾†é¡¯ç¤ºå‚™å¿˜éŒ„çš„å®Œæ•´å…§å®¹ -->
    <div class="form-container" style="padding: 0;">
        <textarea id="char-memo-detail-content" readonly></textarea>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ #char-diary-screen â–¼â–¼â–¼ -->
<div id="char-diary-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>æ—¥è¨˜</span>
        <div class="header-actions">
            <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
            <span class="action-btn" id="regenerate-char-diary-btn" title="é‡æ–°ç”Ÿæˆæ—¥è¨˜æœ¬">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘é€™å€‹â€œ+â€è™Ÿç¾åœ¨æœƒè§¸ç™¼AIå¯«ä¸€ç¯‡æ–°æ—¥è¨˜ -->
            <span class="action-btn" id="add-char-diary-btn">+</span>
        </div>
    </div>
    <div id="char-diary-list" class="list-container"></div>
</div>

<!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šå…¨æ–°çš„æ—¥è¨˜è©³æƒ…è¢å¹•ã€‘ã€‘ã€‘ -->
<div id="char-diary-detail-screen" class="char-screen">
<div class="header">
    <span class="back-btn" id="char-diary-detail-back-btn">â€¹ </span>
    <span id="char-diary-detail-title"></span>
    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨é€™è£¡æ·»åŠ æ”¶è—æŒ‰éˆ• -->
    <div class="header-actions">
        <span class="action-btn" id="favorite-diary-btn" title="æ”¶è—">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
        </span>
    </div>
</div>
    <div id="char-diary-detail-content-wrapper" class="list-container">
        <div id="char-diary-detail-content">
            <!-- æ—¥è¨˜å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹V2.0ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ id="char-usage-screen" çš„ div â–¼â–¼â–¼ -->
<div id="char-usage-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>Appä½¿ç”¨è¨˜éŒ„</span>
        <div class="header-actions">
            <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
            <span class="action-btn" id="regenerate-char-usage-btn" title="é‡æ–°ç”Ÿæˆè¨˜éŒ„">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-usage-list" class="list-container">
        <!-- Appä½¿ç”¨è¨˜éŒ„å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

    <!-- é¡æ¯”èŠå¤©è¨˜éŒ„çš„å½ˆçª— (ä¿æŒä¸è®Š) -->
    <div id="char-qq-transcript-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span id="transcript-modal-char-name"></span>
            </div>
            <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5; padding: 15px; display: flex; flex-direction: column; gap: 15px;">
            </div>
            <div class="modal-footer">
                <button class="save" id="close-transcript-modal-btn" style="width:100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
<!-- â–¼â–¼â–¼ æ­¥é©Ÿ 1-2ï¼šå°‡é€™æ•´å¡Šå…¨æ–°çš„â€œç¶²æ˜“é›²éŸ³æ¨‚â€è¢å¹•å’Œæ’­æ”¾æ©Ÿï¼Œå®Œæ•´é»è²¼åˆ° id="character-phone-screen" çš„ div å…§éƒ¨æœ«å°¾ â–¼â–¼â–¼ -->

<!-- 1. ç¶²æ˜“é›²éŸ³æ¨‚Appä¸»è¢å¹• -->
<div id="char-music-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>TAçš„æ­Œå–®</span>
        <div class="header-actions">
            <span class="action-btn" id="regenerate-char-music-btn" title="é‡æ–°ç”Ÿæˆæ­Œå–®">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-music-list" class="list-container">
        <!-- æ­Œæ›²æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>
</div>

<!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€å…¨æ–° V3.0 | ä»¿é»‘è† å”±ç‰‡æ©ŸUIã€‘çš„ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ char-music-player-modal â–¼â–¼â–¼ -->
<div id="char-music-player-modal" class="modal">
    <div class="modal-content">
        <!-- ä¸»å…§å®¹å€ -->
        <div class="char-player-body">
            <!-- æ­Œæ›²ä¿¡æ¯ -->
            <div class="char-player-song-info">
                <p id="char-music-player-title">æ­Œæ›²åç¨±</p>
                <p id="char-music-artist">æ­Œæ‰‹</p>
            </div>

            <!-- å°ˆè¼¯å°é¢ (é»‘è† å”±ç‰‡æ•ˆæœ) -->
            <div id="char-vinyl-container">
                <img id="char-music-cover" src="">
            </div>
            
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡éŸ³ç¬¦é ç•™ä½ç½®æ›¿æ›ç‚ºçœŸæ­£çš„æ­Œè©å®¹å™¨ -->
            <div id="char-music-lyrics">
                <!-- æ­Œè©å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>

            <!-- åº•éƒ¨æ§åˆ¶æ¬„ -->
            <div class="char-player-footer">
                <div class="char-player-progress-bar-container">
                    <span id="char-music-current-time" class="time-display">0:00</span>
                    <div id="char-music-progress-bar" class="char-player-progress-bar">
                        <div id="char-music-progress-fill"></div>
                    </div>
                    <span id="char-music-total-time" class="time-display">0:00</span>
                </div>

                <div class="char-player-controls">
                    <button id="char-music-prev-btn" class="control-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg>
                    </button>
                    <button id="char-music-play-pause-btn" class="control-btn play">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    </button>
                    <button id="char-music-next-btn" class="control-btn">
                         <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"></path></svg>
                    </button>
                     <button id="char-music-mode-btn" class="control-btn mode">é †åº</button>
                </div>
            </div>
        </div>
        <!-- é—œé–‰æŒ‰éˆ•è¢«ç§»åˆ°å³ä¸Šè§’ -->
        <button id="close-char-music-player-btn" class="char-player-close-btn">Ã—</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

        <!-- â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ world-book-screen â–¼â–¼â–¼ -->
        <div id="world-book-screen" class="screen">
            <div class="header">
    <!-- å°‡æ‰€æœ‰éœ€è¦é å·¦çš„æŒ‰éˆ•ï¼Œç”¨ä¸€å€‹æ–°çš„ div åŒ…è£¹èµ·ä¾† -->
    <div class="header-left-actions">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span class="action-btn" id="import-world-book-btn" title="å°å…¥ä¸–ç•Œæ›¸">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        </span>
        <span class="action-btn" id="export-world-book-btn" title="åŒ¯å‡ºä¸–ç•Œæ›¸">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        </span>
    </div>
                <span>ä¸–ç•Œæ›¸</span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å°‡æ–‡å­—æŒ‰éˆ•æ›¿æ›ç‚ºSVGåœ–ç¤º -->
                    <span class="action-btn" id="manage-world-book-categories-btn" title="ç®¡ç†åˆ†é¡">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="action-btn" id="add-world-book-btn">+</span>
                </div>
            </div>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å…¨æ–°çš„é ç°½å’Œå…§å®¹å€çµæ§‹ -->
            <div id="world-book-tabs"></div>
            <div id="world-book-content-container"></div>
        </div>
        <!-- â–¼â–¼â–¼ ã€è«‹å°‡é€™å€‹ç¼ºå¤±çš„ä»£ç¢¼å¡Šã€‘é»è²¼åˆ° id="world-book-screen" çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
        <div id="world-book-editor-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                <span id="world-book-editor-title">ç·¨è¼¯ä¸–ç•Œæ›¸</span>
                <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="world-book-name-input">æ›¸å</label>
                    <input type="text" id="world-book-name-input" placeholder="è«‹è¼¸å…¥ä¸–ç•Œæ›¸çš„åç¨±...">
                </div>
                <div class="form-group">
                    <label for="world-book-category-select">åˆ†é¡</label>
                    <select id="world-book-category-select"></select>
                </div>
                <!-- ç·¨è¼¯å™¨å€åŸŸ -->
                <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <label>å…§å®¹æ¢ç›®</label>
                    <!-- é€™å€‹å®¹å™¨å°‡ç”¨ä¾†å‹•æ…‹è£è¼‰æ‰€æœ‰å¯ç·¨è¼¯çš„æ¢ç›®å¡Š -->
                    <div id="world-book-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;">
                        <!-- JS æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </div>
                </div>
                <!-- æ·»åŠ æ–°æ¢ç›®çš„æŒ‰éˆ• -->
                <button id="add-world-book-entry-btn" class="form-button form-button-secondary"> [+] æ·»åŠ æ–°æ¢ç›® </button>
            </div>
        </div>
        <!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯â€œé è¨­â€Appçš„æ‰€æœ‰HTMLè¢å¹•ï¼Œè«‹é»è²¼åˆ° world-book-editor-screen ä¹‹å¾Œ â–¼â–¼â–¼ -->
<div id="preset-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é è¨­</span>
        <div class="header-actions">
 <span class="action-btn" id="import-preset-btn" title="å°å…¥é è¨­æ–‡ä»¶">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </span>
            <span class="action-btn" id="manage-preset-categories-btn" title="ç®¡ç†åˆ†é¡">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
            </span>
            <span class="action-btn" id="add-preset-btn">+</span>
        </div>
    </div>
    <div id="preset-tabs"></div>
    <div id="preset-content-container"></div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ•™ç¨‹é é¢ï¼Œè«‹é»è²¼åˆ°å…¶ä»– .screen çš„divæ—é‚Š â–¼â–¼â–¼ -->
<div id="tutorial-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ•™ç¨‹</span>
        <span style="width: 30px;"></span> <!-- é ç•™ä½ç½®ï¼Œä¿æŒæ¨™é¡Œå±…ä¸­ -->
    </div>
    <div class="list-container" style="padding: 0; overflow: hidden;">
        <!-- é€™è£¡æœƒåµŒå…¥ä½ çš„æ•™ç¨‹HTMLæª” -->
        <iframe id="tutorial-iframe" src="tutorial.html" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<div id="preset-editor-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('preset-screen')">â€¹</span>
        <span id="preset-editor-title">ç·¨è¼¯é è¨­</span>
        <span class="save-btn" id="save-preset-btn">ä¿å­˜</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="preset-name-input">é è¨­åç¨±</label>
            <input type="text" id="preset-name-input" placeholder="è«‹è¼¸å…¥é è¨­çš„åç¨±...">
        </div>
        <div class="form-group">
            <label for="preset-category-select">åˆ†é¡</label>
            <select id="preset-category-select"></select>
        </div>
        <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
            <label>å…§å®¹æ¢ç›®</label>
            <div id="preset-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;">
            </div>
        </div>
        <button type="button" id="add-preset-entry-btn" class="form-button form-button-secondary"> [+] æ·»åŠ æ–°æ¢ç›® </button>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ åŸä¾†çš„ id="api-settings-screen" çš„ div â–¼â–¼â–¼ -->
        <div id="api-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>API è¨­ç½®</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- ã€ã€ã€å…¨æ–°ï¼šAPIé è¨­ç®¡ç†ã€‘ã€‘ã€‘ -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">API é è¨­ç®¡ç†</h3>
                <div class="form-group">
                    <label for="api-preset-select">é¸æ“‡æˆ–åˆ‡æ›é è¨­</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="api-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                        <button id="delete-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆªé™¤</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <!-- ä¸»APIè¨­ç½® -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">ä¸»APIè¨­ç½® (ç”¨æ–¼èŠå¤©)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> æç¤º: è‹¥è¦ä½¿ç”¨â€œç™¼é€åœ–ç‰‡â€åŠŸèƒ½, è«‹å‹™å¿…é¸æ“‡æ”¯æ´Vision(è¦–è¦º)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code
                        style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚ </p>
                <div class="form-group">
                    <label for="proxy-url">åä»£ä½å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label>
                    <input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com">
                </div>
                <div class="form-group">
                    <label for="api-key">é‡‘é‘° (API Key)</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label for="model-select">æ¨¡å‹</label>
                    <select id="model-select"></select>
                </div>
                <button class="form-button" id="fetch-models-btn">æ‹‰å–ä¸»æ¨¡å‹</button>
                <!-- å‰¯APIè¨­ç½® -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">å‰¯APIè¨­ç½® (ç”¨æ–¼ç¸½çµé•·æœŸè¨˜æ†¶)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> æ‚¨å¯ä»¥åœ¨æ­¤é…ç½®ä¸€å€‹ç¨ç«‹çš„ã€å¯èƒ½æˆæœ¬æ›´ä½çš„APIï¼Œå°ˆé–€ç”¨æ–¼å¾Œè‡ºçš„é•·æœŸè¨˜æ†¶ç¸½çµä»»å‹™ï¼Œä»¥ç¯€çœä¸»APIçš„è²»ç”¨ã€‚å¦‚æœç•™ç©ºï¼Œå°‡é»˜èªä½¿ç”¨ä¸»APIé€²è¡Œç¸½çµã€‚ </p>
                <div class="form-group">
                    <label for="secondary-proxy-url">å‰¯åä»£åœ°å€</label>
                    <input type="text" id="secondary-proxy-url" placeholder="ä¾‹å¦‚: https://api.groq.com/openai">
                </div>
                <div class="form-group">
                    <label for="secondary-api-key">å‰¯é‡‘é‘°</label>
                    <input type="password" id="secondary-api-key" placeholder="gsk_...">
                </div>
                <div class="form-group">
                    <label for="secondary-model-select">å‰¯æ¨¡å‹</label>
                    <select id="secondary-model-select"></select>
                </div>
                <button class="form-button form-button-secondary" id="fetch-secondary-models-btn">æ‹‰å–å‰¯æ¨¡å‹</button>
<div class="form-group">
    <label for="api-temperature-slider">API æº«åº¦ (Temperature) <span id="api-temperature-value">0.8</span></label>
    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
        æ§åˆ¶AIå›å¾©çš„éš¨æ©Ÿæ€§å’Œå‰µé€ æ€§ã€‚å€¼è¶Šé«˜ï¼Œå›å¾©è¶Šéš¨æ©Ÿï¼›å€¼è¶Šä½ï¼Œå›å¾©è¶Šç¢ºå®šã€‚å»ºè­°ç¯„åœ 0.7-1.0ã€‚
    </p>
    <input type="range" id="api-temperature-slider" min="0" max="2" step="0.1" value="0.8" style="width: 100%; margin-top: 8px;">
</div>
                <!-- å¾Œè‡ºæ´»å‹•è¨­ç½® -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">å¾Œè‡ºæ´»å‹•è¨­ç½®</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="background-activity-switch" style="margin-bottom: 0;"> å•Ÿç”¨å¾Œè‡ºè§’è‰²æ´»å‹• <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;"> è­¦å‘Šï¼šæ­¤åŠŸèƒ½æœƒé¡¯è‘—å¢åŠ APIèª¿ç”¨å’Œè²»ç”¨ï¼ </p>
                    </label>
                    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="background-interval-input" style="margin-bottom: 0;"> å¾Œè‡ºæ´»å‹•æª¢æ¸¬é–“éš” (ç§’) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> å»ºè­°å€¼ 60-300ã€‚å€¼è¶Šå¤§ï¼Œè²»ç”¨è¶Šä½ï¼Œä½†è§’è‰²åæ‡‰è¶Šæ…¢ã€‚ </p>
                    </label>
                    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="block-cooldown-input" style="margin-bottom: 0;"> AIè¢«æ‹‰é»‘å¾Œå†·éœæœŸ (å°æ™‚) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> è¢«æ‹‰é»‘è¶…éé€™å€‹æ™‚é–“å¾Œï¼ŒAIæ‰æœ‰å¹¾ç‡é‡æ–°ç”³è«‹å¥½å‹ã€‚ </p>
                    </label>
                    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
                </div>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<hr style="margin: 30px 0; opacity: 0.3;">
<h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">èªéŸ³è¨Šæ¯è¨­ç½® (Minimax TTS)</h3>
<p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">
    åœ¨ AI å›å¾©çš„æ–‡å­—å‰åŠ ä¸Š <code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">[V]</code> é¦–ç¢¼ï¼Œå³å¯è®“è©²æ¢æ¶ˆæ¯è‡ªå‹•æ¸²æŸ“ç‚ºå¯æ’­æ”¾çš„èªéŸ³ã€‚
</p>
<div class="form-group">
    <label for="minimax-group-id">Minimax Group ID</label>
    <input type="text" id="minimax-group-id" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„ Group ID">
</div>
<div class="form-group">
    <label for="minimax-api-key">Minimax API Key</label>
    <input type="password" id="minimax-api-key" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„ API Key">
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="minimax-model-select">èªéŸ³æ¨¡å‹ (Model)</label>
    <select id="minimax-model-select">
        <option value="speech-01">speech-01 (æ¨™æº–)</option>
        <option value="speech-02">speech-02 (é«˜æ¸…)</option>
    </select>
</div>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">æ€§èƒ½èˆ‡é¡¯ç¤ºè¨­å®š</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="chat-list-render-window-input" style="margin-bottom: 0;">
                        èŠå¤©åˆ—è¡¨æ¯æ¬¡è¼‰å…¥æ¢æ•¸
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            æ§åˆ¶ä¸»é èŠå¤©åˆ—è¡¨ä¸‹æ‹‰æ™‚æ¯æ¬¡è¼‰å…¥æœƒè©±çš„æ•¸é‡ã€‚é»˜èª30ã€‚
                        </p>
                    </label>
                    <input type="number" id="chat-list-render-window-input" min="10" value="30" style="width: 80px; text-align: center;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="chat-render-window-input" style="margin-bottom: 0;">
                        èŠå¤©ä»‹é¢åˆå§‹è¼‰å…¥æ¢æ•¸
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            æ‰“é–‹èŠå¤©æ™‚é è¨­é¡¯ç¤ºçš„æœ€è¿‘æ¶ˆæ¯æ•¸é‡ã€‚å€¼è¶Šå¤§ï¼Œåˆæ¬¡è¼‰å…¥è¶Šæ…¢ã€‚
                        </p>
                    </label>
                    <input type="number" id="chat-render-window-input" min="10" value="50" style="width: 80px; text-align: center;">
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">ç”Ÿåœ–åŠŸèƒ½è¨­ç½®</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="enable-ai-drawing-switch" style="margin-bottom: 0;">
                        å•Ÿç”¨AIç”Ÿåœ–åŠŸèƒ½
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            é—œé–‰å¾Œï¼Œæ‰€æœ‰éœ€è¦AIç”Ÿæˆçš„åœ–ç‰‡ï¼ˆå‹•æ…‹ã€é ­åƒç­‰ï¼‰éƒ½å°‡é¡¯ç¤ºç‚ºå é»é™£åœ–ï¼Œä»¥ç¯€çœæµé‡å’ŒAPIè²»ç”¨ã€‚
                        </p>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="enable-ai-drawing-switch">
                        <span class="slider"></span>
                    </label>
                </div>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°æŒ‰éˆ•ä»£ç¢¼ â–¼â–¼â–¼ -->
<hr style="margin: 30px 0; opacity: 0.3;">
<h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">å­˜å„²ç©ºé–“å„ªåŒ–</h3>
<button class="form-button form-button-secondary" id="compress-images-btn" style="background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;">
    ä¸€éµå£“ç¸®æœ¬åœ°åœ–ç‰‡
</button>
<p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;">
    æ­¤åŠŸèƒ½æœƒå°‡æ‚¨æ‰€æœ‰æœ¬åœ°ä¸Šå‚³çš„åœ–ç‰‡ï¼ˆå¦‚é ­åƒã€è¡¨æƒ…åŒ…ã€èŠå¤©åœ–ç‰‡ã€é ­åƒæ¡†ã€å…ƒä»¶åœ–ç­‰ï¼‰å£“ç¸®ç‚ºJPEGæ ¼å¼ï¼Œä»¥å¤§å¹…æ¸›å°è³‡æ–™é«”ç©ã€‚
    <br><strong style="color: #ff3b30;">è­¦å‘Šï¼šé€™æ˜¯ä¸€å€‹å¤±çœŸå£“ç¸®ä¸”ä¸å¯é€†çš„æ“ä½œï¼Œæœƒè¼•å¾®é™ä½åœ–ç‰‡å“è³ªã€‚å»ºè­°æ“ä½œå‰å…ˆå‚™ä»½è³‡æ–™ã€‚</strong>
</p>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
                <!-- ä¿å­˜èˆ‡å°å…¥åŒ¯å‡º -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <button class="form-button" id="save-api-settings-btn" style="margin-top: 20px;">ä¿å­˜æ‰€æœ‰è¨­ç½®</button>
                <button class="form-button" id="export-data-btn">åŒ¯å‡ºæ•¸æ“š</button>
                <button class="form-button" id="import-btn">å°å…¥å‚™ä»½æª”æ¡ˆ</button>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°æŒ‰éˆ•ä»£ç¢¼ â–¼â–¼â–¼ -->
<button class="form-button form-button-secondary" id="cleanup-data-btn" style="background-color: #ffebee; color: #c62828; border-color: #ef9a9a; margin-top: 10px;">æ¸…ç†å†—é¤˜æ•¸æ“š</button>
<button class="form-button form-button-secondary" id="delete-world-books-btn" style="background-color: #ffebee; color: #c62828; border-color: #ef9a9a; margin-top: 10px;">åˆªé™¤ä¸–ç•Œæ›¸</button>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<button class="form-button form-button-secondary" id="clear-specific-data-btn" style="background-color: #ffcdd2; color: #b71c1c; border-color: #ef9a9a; margin-top: 10px;">é«˜ç´šè³‡æ–™æ¸…ç†</button>
<button class="form-button form-button-secondary" id="check-and-fix-data-btn" style="background-color: #e3f2fd; color: #0d47a1; border-color: #bbdefb; margin-top: 10px;">è³‡æ–™æª¢æŸ¥èˆ‡ä¿®å¾©</button>
                <input id="import-data-input" type="file" accept="application/json" hidden>

            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- ã€ã€ã€å…¨æ–° V2.0 | æ”¯æŒå…¨é¸ã€‘ï¼šé«˜ç´šè³‡æ–™æ¸…ç†åš®å°æ¨¡æ…‹æ¡†ã€‘ã€‘ã€‘ -->
<div id="data-clear-wizard-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <!-- æ­¥é©Ÿ 1: é¸æ“‡è§’è‰² -->
        <div id="data-clear-step-1" class="wizard-step">
            <div class="modal-header">
                <span>ç¬¬ä¸€æ­¥ï¼šé¸æ“‡è¦æ¸…ç†çš„è§’è‰²</span>
                <!-- æ ¸å¿ƒæ–°å¢ï¼šå…¨é¸æ ¸å–æ–¹å¡Š -->
                <label>
                    <input type="checkbox" id="select-all-chars-for-clear"> å…¨é¸
                </label>
            </div>
            <div class="modal-body" id="data-clear-char-list" style="padding: 0;">
                <!-- è§’è‰²æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-clear-wizard-btn-step1">å–æ¶ˆ</button>
                <button class="save" id="go-to-clear-step2-btn">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
        <!-- æ­¥é©Ÿ 2: é¸æ“‡è³‡æ–™é¡å‹ -->
        <div id="data-clear-step-2" class="wizard-step" style="display: none;">
            <div class="modal-header">
                <span>ç¬¬äºŒæ­¥ï¼šé¸æ“‡è¦æ¸…ç†çš„è³‡æ–™é¡å‹</span>
                <!-- æ ¸å¿ƒæ–°å¢ï¼šå…¨é¸æ ¸å–æ–¹å¡Š -->
                <label>
                    <input type="checkbox" id="select-all-types-for-clear"> å…¨é¸
                </label>
            </div>
            <div class="modal-body" id="data-clear-type-list" style="padding: 0;">
                <!-- è³‡æ–™é¡å‹æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button class="form-button-secondary" id="back-to-clear-step1-btn" style="width: 30%; margin:0;">ä¸Šä¸€æ­¥</button>
                <button class="cancel" id="cancel-clear-wizard-btn-step2" style="width: 30%; margin:0;">å–æ¶ˆ</button>
                <button class="save btn-danger" id="confirm-final-clear-btn" style="width: 30%; margin:0;">ç¢ºèªæ¸…ç†</button>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ åŸä¾†çš„ chat-list-screen â–¼â–¼â–¼ -->
        <div id="chat-list-screen" class="screen">
            <!-- ä¸»é ­éƒ¨ (åªåœ¨æ¶ˆæ¯æ¸…å–®é¡¯ç¤º) -->
            <div class="header" id="main-chat-list-header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span id="chat-list-title">æ¶ˆæ¯</span>
                <div class="header-actions">
                    <span class="action-btn" id="add-group-chat-btn" title="å‰µå»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg></span>
                    <span class="action-btn" id="add-chat-btn">+</span>
                </div>
            </div>
            <!-- æ¶ˆæ¯æ¸…å–®è¦–åœ– -->
            <div id="messages-view" class="chat-list-view active">
                <div id="chat-list">
                    <!-- JSæœƒåœ¨é€™è£¡ç”ŸæˆèŠå¤©åˆ—è¡¨ -->
                </div>
            </div>
            <!-- å‹•æ…‹ä»‹é¢è¦–åœ– -->
            <div id="qzone-screen" class="chat-list-view">
                <div class="qzone-header">
                    <span class="back-btn" id="qzone-back-btn">â€¹</span> <!-- é€™å€‹æŒ‰éˆ•ç¾åœ¨åªè² è²¬å¾å‹•æ…‹è¿”å› -->
                    <span>å¥½å‹å‹•æ…‹</span>
    <div class="header-actions">
        <span class="action-btn" id="qzone-more-actions-btn" title="æ›´å¤šæ“ä½œ">â€¦</span>
    </div>
                </div>
                <div class="qzone-content">
                    <div class="qzone-profile-header">
                        <div id="qzone-banner-container" class="qzone-banner-container">
                            <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                            <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                        </div>
                        <div class="qzone-user-info">
                            <div id="qzone-avatar-container" class="qzone-avatar-container">
                                <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="é ­åƒ">
                                <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                            </div>
                            <span id="qzone-nickname">{{user}}</span>
                        </div>
                    </div>
                    <div class="qzone-actions-bar">
                        <div class="action-item" id="create-shuoshuo-btn"><span>èªªèªª</span></div>
                        <div class="action-item" id="create-post-btn"><span>å‹•æ…‹</span></div>
                        <div class="action-item" id="open-album-btn"><span>ç›¸å†Š</span></div>
                    </div>
                    <div id="qzone-posts-list"></div>
                </div>
            </div>
            <!-- æ”¶è—ä»‹é¢è¦–åœ– -->
            <div id="favorites-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="favorites-back-btn">â€¹</span>
                    <span>æˆ‘çš„æ”¶è—</span>
                    <!-- æ–°å¢çš„ç·¨è¼¯æŒ‰éˆ• -->
                    <span class="action-btn" id="favorites-edit-btn">ç·¨è¼¯</span>
                </div>
                <!-- ã€æ–°å¢ã€‘æœç´¢æ¬„å®¹å™¨ -->
                <div class="search-bar-container">
                    <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ¨™é¡Œã€å…§å®¹æˆ–ä½œè€…...">
                    <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
                </div>
                <div id="favorites-list" class="list-container">
                    <!-- æ”¶è—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
                <!-- æ–°å¢ï¼šæ”¶è—é åº•éƒ¨æ“ä½œæ¬„ -->
                <div id="favorites-action-bar" style="display: none;">
                    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆªé™¤ (0)</button>
                </div>
            </div>
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å›æ†¶éŒ„ä»‹é¢è¦–åœ– â–¼â–¼â–¼ -->
            <div id="memories-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="memories-back-btn">â€¹</span>
                    <span>æˆ‘å€‘çš„å›æ†¶</span>
                    <span class="action-btn" id="add-countdown-btn">+</span>
                </div>
                <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                    <!-- å›æ†¶å¡ç‰‡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
            <div id="npc-list-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="npc-list-back-btn">â€¹</span>
                    <span>NPC åˆ—è¡¨</span>
                    <div class="header-actions">
                        <span class="action-btn" id="add-npc-btn">+</span>
                    </div>
                </div>
                <div id="npc-list" class="list-container" style="padding: 0;">
                    <!-- NPCæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>
            <!-- åº•éƒ¨å·¡è¦½åˆ— -->
            <div id="chat-list-bottom-nav">
                <div class="nav-item active" data-view="messages-view">
                    <span>æ¶ˆæ¯</span>
                </div>
                <div class="nav-item" data-view="qzone-screen">
                    <span>å‹•æ…‹</span>
                </div>
                <!-- â–¼â–¼â–¼ åœ¨â€œå‹•æ…‹â€å’Œâ€œæ”¶è—â€ä¹‹é–“ï¼ŒåŠ å…¥é€™å€‹æ–°é ç°½ â–¼â–¼â–¼ -->
                <div class="nav-item" data-view="memories-view">
                    <span>å›æ†¶</span>
                </div>
                <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
                <div class="nav-item" data-view="favorites-view">
                    <span>æ”¶è—</span>
                </div>
                <div class="nav-item" data-view="npc-list-view">
                    <span>NPC</span>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ›å€åŸŸçµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°çš„ HTML é»è²¼åˆ° id="chat-list-screen" çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
        <div id="album-screen" class="screen">
            <!-- 1. é é¢é ­éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰éˆ•å’Œæ¨™é¡Œ -->
            <div class="header">
                <span class="back-btn" id="album-back-btn">â€¹</span>
                <span>æˆ‘çš„ç›¸å†Š</span>
                <span class="action-btn" id="create-album-btn-page">+</span>
            </div>
            <!-- 2. é é¢å…§å®¹å®¹å™¨ -->
            <div class="list-container">
                <div id="album-grid-page">
                    <!-- ç›¸ç°¿æ¸…å–®å°‡ç”± JS å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°çš„ HTML é»è²¼çµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°çš„ HTML é»è²¼åˆ° id="album-screen" çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
        <div id="album-photos-screen" class="screen">
            <!-- 1. é é¢é ­éƒ¨ -->
            <div class="header">
                <span class="back-btn" id="album-photos-back-btn">â€¹</span>
                <span id="album-photos-title">ç›¸å†Šåç¨±</span>
                <span class="action-btn" id="album-upload-photo-btn">ä¸Šå‚³</span>
            </div>
            <!-- 2. é é¢å…§å®¹å®¹å™¨ -->
            <div class="list-container">
                <div id="photos-grid-page">
                    <!-- ç…§ç‰‡æ¸…å–®å°‡ç”± JS å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
                <!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°çš„ HTML é»è²¼åˆ°æ‰€æœ‰æ¨¡æ…‹æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
                <div id="photo-viewer-modal" class="modal">
                    <!-- 1. é—œé–‰æŒ‰éˆ• -->
                    <button id="photo-viewer-close-btn">Ã—</button>
                    <!-- 2. ä¸Šä¸€å¼µç…§ç‰‡æŒ‰éˆ• -->
                    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
                    <!-- 3. åœ–ç‰‡å®¹å™¨ -->
                    <div class="photo-viewer-content">
                        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é è¦½">
                    </div>
                    <!-- 4. ä¸‹ä¸€å¼µç…§ç‰‡æŒ‰éˆ• -->
                    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
                </div>
                <!-- â–²â–²â–² æ–°çš„ HTML é»è²¼çµæŸ â–²â–²â–² -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°çš„ HTML é»è²¼çµæŸ â–²â–²â–² -->
<div id="npc-editor-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="npc-editor-title">æ·»åŠ  NPC</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>NPC é ­åƒ</label>
                <div class="avatar-upload">
                    <img id="npc-avatar-preview" src="https://i.postimg.cc/VkQfgzGJ/1.jpg">
                    <button onclick="document.getElementById('npc-avatar-input').click()">ä¸Šå‚³é ­åƒ</button>
                    <input type="file" id="npc-avatar-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="form-group">
                <label for="npc-name-input">NPC æ˜µç¨±</label>
                <input type="text" id="npc-name-input" placeholder="è¼¸å…¥NPCçš„å¸¸ç”¨å">
            </div>
            <div class="form-group">
                <label for="npc-persona-input">NPC äººè¨­</label>
                <textarea id="npc-persona-input" rows="4" placeholder="è©³ç´°æè¿°é€™å€‹NPCçš„æ€§æ ¼ã€èƒŒæ™¯ã€èªªè©±æ–¹å¼ç­‰..."></textarea>
            </div>
<!-- â–¼â–¼â–¼ åœ¨NPCäººè¨­è¼¸å…¥æ¡†ä¹‹å¾Œï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
                <hr style="opacity: 0.2;">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="npc-background-activity-switch" style="margin-bottom: 0;">
                        å•Ÿç”¨ç¨ç«‹å¾Œè‡ºæ´»å‹•
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            å…è¨±è©²NPCåœ¨å¾Œè‡ºç¨ç«‹ç™¼è¡¨å‹•æ…‹è©•è«–ã€‚éœ€åŒæ™‚é–‹å•ŸAPIè¨­ç½®ä¸­çš„ç¸½é–‹é—œã€‚
                        </p>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="npc-background-activity-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group">
                    <label for="npc-action-cooldown-input">
                        ç¨ç«‹è¡Œå‹•å†·å» (åˆ†é˜)
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            è©²NPCåœ¨å¾Œè‡ºä¸»å‹•è¡Œå‹•çš„æœ€å°é–“éš”ã€‚
                        </p>
                    </label>
                    <input type="number" id="npc-action-cooldown-input" min="1" value="15" style="width: 80px; text-align: center;">
                </div>
<!-- â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
            <div class="form-group">
                <label>é—œè¯çš„è§’è‰² (NPCæœƒå»è©•è«–é€™äº›è§’è‰²çš„å‹•æ…‹)</label>
                <div id="npc-association-list" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                    <!-- é—œè¯è§’è‰²å¤šé¸æ¡†å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-npc-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-npc-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šå°‡é€™å€‹ã€å…¨æ–°çš„æ¨¡æ…‹æ¡†ã€‘é»è²¼åˆ° body å…§å…¶ä»–æ¨¡æ…‹æ¡†çš„æ—é‚Š â–¼â–¼â–¼ -->
<div id="clear-posts-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é¸æ“‡æ¸…ç©ºç¯„åœ</span>
        </div>
        <div class="modal-body" id="clear-posts-list" style="padding: 0;">
            <!-- æ¸…ç©ºé¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-clear-posts-btn">å–æ¶ˆ</button>
            <!-- æ·»åŠ äº† btn-danger é¡ï¼Œè®“æŒ‰éˆ•é¡¯ç¤ºç‚ºç´…è‰²ä»¥ç¤ºè­¦å‘Š -->
            <button class="save btn-danger" id="confirm-clear-posts-btn">ç¢ºèªæ¸…ç©º</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ é»è²¼åˆ° #album-photos-screen çš„ div ä¹‹å¾Œ â–¼â–¼â–¼ -->
        <input type="file" id="album-photo-input" accept="image/*" multiple hidden>
        <div id="chat-interface-screen" class="screen">
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹äº”å­æ£‹å®¹å™¨é»è²¼åˆ°èŠå¤©ä»‹é¢(chat-interface-screen)çš„ã€æœ€é ‚éƒ¨ã€‘ â–¼â–¼â–¼ -->
            <div id="gomoku-overlay">
                <div id="gomoku-content-wrapper">
                    <canvas id="gomoku-board"></canvas>
                    <div id="gomoku-controls">
                        <button id="close-gomoku-btn">æ”¶èµ·æ£‹ç›¤</button>
                    </div>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<div id="reading-overlay">
    <!-- é€™æ˜¯å…¨æ–°çš„ã€ç”¨æ–¼æ¢å¾©è¦–çª—çš„å°æŒ‰éˆ• -->
    <div id="reading-restore-btn" style="display: none;">ğŸ“–</div>

    <!-- é€™æ˜¯å¯æ‹–å‹•çš„ä¸»è¦–çª— -->
    <div id="reading-window">
        <div class="reading-header">
            <span id="reading-title">æœªé¸æ“‡æ›¸ç±</span>
<div class="reading-controls">
    <button id="minimize-reading-btn" title="æœ€å°åŒ–" style="font-size: 20px; line-height: 1;">
        <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
    <button id="open-reading-library-btn" title="æ‰“é–‹æ›¸åº«" style="font-size: 22px; line-height: 1;">
    <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</button>
    <button id="close-reading-btn" title="é—œé–‰">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
</div>
        </div>
        <div id="reading-content">
            <p>é»æ“Šâ€œå°å…¥â€æŒ‰éˆ•ï¼Œ<br>å¾æœ¬åœ°.txtæª”æˆ–ç¶²è·¯URLè¼‰å…¥æ›¸ç±å…§å®¹ã€‚</p>
        </div>
        <div class="reading-footer">
            <button id="prev-page-btn">ä¸Šä¸€é </button>
            <span id="page-indicator">0 / 0</span>
            <button id="next-page-btn">ä¸‹ä¸€é </button>
        </div>
    </div>
</div>
<!-- é€™æ˜¯ä¸€å€‹éš±è—çš„æª”è¼¸å…¥æ¡†ï¼Œç”¨æ–¼æœ¬åœ°ä¸Šå‚³ -->
<input type="file" id="book-upload-input" accept=".txt, text/plain" hidden>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
            <div class="header">
                <div class="default-controls">
                    <span class="back-btn" id="back-to-list-btn">â€¹</span>
                    <div id="global-lyrics-bar"></div>

                    <div id="chat-header-title-wrapper">
                        <span id="chat-header-title">èŠå¤©å°è±¡</span>
                        <div id="chat-header-status">
                            <span class="status-dot"></span>
                            <span class="status-text">ç·šä¸Š</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›ä½ ç¾æœ‰çš„ id="open-memory-screen-btn" çš„ span æ¨™ç±¤ â–¼â–¼â–¼ -->
                        <span class="action-btn" id="open-memory-screen-btn" title="é•·æœŸè¨˜æ†¶">
                            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨SVGåœ–ç¤ºæ›¿æ›åŸä¾†çš„åœ–ç‰‡ -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M12 6L9 9L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M21 5V19C21 20.1046 20.1046 21 19 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
                        <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·è½"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·è½"></span>
                        <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è¨­ç½®"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="è¨­ç½®"></span>
                    </div>
                </div>
                <!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›ä½ åŸä¾†çš„ .selection-controls div â–¼â–¼â–¼ -->
                <div class="selection-controls">
                    <span id="selection-cancel-btn">å–æ¶ˆ</span>
                    <span id="selection-count"></span>
                    <div class="header-actions">
                        <span id="selection-screenshot-btn" class="action-btn">é•·æˆªåœ–</span>
                        <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
                        <span id="selection-share-btn" class="action-btn">åˆ†äº«</span>
                        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘èˆŠæŒ‰éˆ•é‡å‘½åï¼ŒåŠŸèƒ½ä¸è®Š -->
                        <span id="selection-soft-delete-btn" class="action-btn">åˆªé™¤(é€šçŸ¥AI)</span>
                        <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–°å¢ä¸€å€‹ç´…è‰²çš„ã€æ›´å¼·åŠ›çš„åˆªé™¤æŒ‰éˆ• -->
                        <span id="selection-erase-btn" class="action-btn" style="color: #ff3b30;">å¾¹åº•åˆªé™¤</span>
                    </div>
                </div>
                <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
            </div>
            <div id="chat-messages">
                <div id="typing-indicator">å°æ–¹æ­£åœ¨è¼¸å…¥...</div>
            </div>
            <div id="chat-input-area">
                <div id="chat-at-mention-popup" class="at-mention-popup"></div>
                <div id="reply-preview-bar">
                    <div class="reply-preview-content">
                        <div class="sender">å›å¾© xxx:</div>
                        <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å…§å®¹...</div>
                    </div>
                    <span id="cancel-reply-btn">Ã—</span>
                </div>
                <div id="chat-input-actions-top">
                    <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿">+</button>
                    <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ç™¼é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg></button>
                    <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šå‚³åœ–ç‰‡">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </button>
                    <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½‰å¸³">ï¿¥</button>
                    <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ç™¼é€èªéŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <path d="M12 19v4"></path>
                            <path d="M8 23h8"></path>
                        </svg></button>
                    <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="ç™¼èµ·å¤–è³£è«‹æ±‚"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg></button>
                    <button id="video-call-btn" class="chat-action-icon-btn action-button" title="è¦–é »é€šè©±"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg></button>
                    <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="ç¾¤è¦–é »é€šè©±"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg></button>
                    <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="ç™¼èµ·æŠ•ç¥¨"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 6h10"></path>
                            <path d="M6 6h.01"></path>
                            <path d="M8 12h10"></path>
                            <path d="M6 12h.01"></path>
                            <path d="M8 18h10"></path>
                            <path d="M6 18h.01"></path>
                        </svg></button>
                    <button id="share-link-btn" class="chat-action-icon-btn action-button" title="åˆ†äº«é€£çµ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
                        </svg></button>
                    <button id="share-location-btn" class="chat-action-icon-btn action-button" title="å…±ç”¨ä½ç½®"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg></button>
                    <!-- â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°æŒ‰éˆ•ï¼Œé»è²¼åˆ° id="chat-input-actions-top" å®¹å™¨çš„æœ«å°¾ â–¼â–¼â–¼ -->
                    <button id="gomoku-btn" class="chat-action-icon-btn action-button" title="äº”å­æ£‹">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="4"></circle>
                            <circle cx="12" cy="12" r="7"></circle>
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
                    <!-- â–¼â–¼â–¼ åœ¨â€œè¡¨æƒ…é¢æ¿â€æŒ‰éˆ•å¾Œï¼Œé»è²¼é€™å€‹æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
                    <button id="open-shopping-btn" class="chat-action-icon-btn action-button" title="è³¼ç‰©">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
                    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å–®èŠå°ˆç”¨çš„â€œæ‹ä¸€-æ‹â€æŒ‰éˆ• (Qå½ˆåœ–ç¤ºç‰ˆ) â–¼â–¼â–¼ -->
                    <button id="pat-btn" class="chat-action-icon-btn action-button" title="æ‹ä¸€-æ‹" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 5.02c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M14.5 11.02c0 .83-.67 1.5-1.5 1.5v0c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5v0c.83 0 1.5.67 1.5 1.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M5.5 14.52l-1.92-1.92c-.34-.34-.34-.89 0-1.23l3.58-3.58c.34-.34.89-.34 1.23 0l1.92 1.92c.34.34.34.89 0 1.23l-3.58 3.58c-.34.34-.89.34-1.23 0Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
                    <!-- â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°æŒ‰éˆ•ï¼Œé»è²¼åˆ° id="chat-input-actions-top" å®¹å™¨çš„æœ«å°¾ â–¼â–¼â–¼ -->
                    <button id="edit-last-response-btn" class="chat-action-icon-btn action-button" title="å°æ¼”æ¨¡å¼ï¼šç·¨è¼¯AIä¸Šä¸€è¼ªçš„å®Œæ•´å›æ‡‰">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
                        <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
                        <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="é‡æ–°ç”Ÿæˆå›å¾©" style="display: flex;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
                        <button id="propel-btn" class="chat-action-icon-btn action-button" title="æ¨é€²åŠ‡æƒ…" style="display: flex;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="13 19 22 12 13 5 13 19"></polygon>
                                <polygon points="2 19 11 12 2 5 2 19"></polygon>
                            </svg>
                        </button>
                        <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
                    <button id="show-announcement-board-btn" class="chat-action-icon-btn action-button" title="ç¾¤å…¬å‘Šæ¿" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21.782 6.132a1 1 0 0 0-1.053-.08l-4.729 2.489a1 1 0 0 0-.5.88v4.158a1 1 0 0 0 .5.88l4.729 2.489a1 1 0 0 0 1.053-.08a1 1 0 0 0 .499-.921V7.052a1 1 0 0 0-.499-.92zm-6 3.207L11 7.05v9.9l4.782-2.281V9.339zM10 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h6V6z" />
                        </svg>
                    </button>
<button id="werewolf-game-btn" class="chat-action-icon-btn action-button" title="ç‹¼äººæ®º" style="display: none;">
    <svg width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M332.6 128.5c-61.1 0-110.5 49.4-110.5 110.5 0 23.4 7.3 45.1 19.9 63.3-19.3 6.3-40.1 9.7-61.9 9.7-88.2 0-160-71.8-160-160s71.8-160 160-160c5.3 0 10.5.3 15.6.8C202.9 44.1 160 0 160 0s-53.3 44.1-45.9 92.5c-48.4 24.3-82.1 73.4-82.1 129.6 0 80.9 65.5 146.4 146.4 146.4 20.2 0 39.4-4.1 56.8-11.5 24.1 33.6 63.3 56.8 107.4 56.8 7.2 0 14.2-0.6 21-1.7 15.2 24.2 41.2 41.1 71.6 41.1 44.7 0 80.9-36.2 80.9-80.9 0-25.2-11.5-47.7-29.6-62.6 11.6-16.1 18.4-35.6 18.4-56.5C443.1 177.9 393.7 128.5 332.6 128.5zM180.1 85.8c-52.1 0-94.4 42.3-94.4 94.4s42.3 94.4 94.4 94.4 94.4-42.3 94.4-94.4S232.2 85.8 180.1 85.8zM332.6 170.9c-37.8 0-68.4 30.6-68.4 68.4s30.6 68.4 68.4 68.4 68.4-30.6 68.4-68.4S370.4 170.9 332.6 170.9z"></path>
    </svg>
</button>
<button id="read-together-btn" class="chat-action-icon-btn action-button" title="ä¸€èµ·è®€æ›¸">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
    </svg>
</button>
                </div>
                <div id="chat-input-main-row">
                    <textarea id="chat-input" rows="1" placeholder="è¼¸å…¥æ¶ˆæ¯..."></textarea>
                    <div id="input-actions-wrapper">
                        <button id="wait-reply-btn" title="ç­‰å¾…å›å¾©"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="ç­‰å¾…å›å¾©"></button>
                        <button id="send-btn" class="action-button">ç™¼é€</button>
                    </div>
                </div>
            </div>
            <div id="chat-lock-overlay">
                <div id="chat-lock-content"></div>
            </div>
        <!-- â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V2.0 ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ id="sticker-panel" çš„ div â–¼â–¼â–¼ -->
        <div id="sticker-panel">
            <div id="sticker-panel-header">
                <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
                <span class="title">æˆ‘çš„è¡¨æƒ…</span>
                <div style="display: flex; gap: 10px;">
                    <span class="panel-btn" id="manage-sticker-categories-btn">åˆ†é¡</span>
                    <span class="panel-btn" id="manage-stickers-btn">ç®¡ç†</span>
                    <span class="panel-btn" id="add-sticker-batch-btn">æ‰¹é‡</span>
                    <span class="panel-btn" id="add-sticker-url-btn">URL</span>
                    <span class="panel-btn" id="upload-sticker-btn">ä¸Šå‚³</span>
                </div>
            </div>
            <div id="sticker-category-tabs"></div>
<div id="sticker-search-container">
    <input type="search" id="sticker-search-input" placeholder="æœç´¢è¡¨æƒ…åç¨±...">
</div>
            <div id="sticker-grid"></div>

            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡èˆŠçš„å–®å€‹åˆªé™¤æŒ‰éˆ•ï¼Œå‡ç´šç‚ºä¸€å€‹åŒ…å«â€œå…¨é¸â€å’Œâ€œåˆªé™¤â€çš„æ“ä½œæ¬„ -->
            <div id="sticker-action-bar">
                <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="select-all-stickers-checkbox"> å…¨é¸
                </label>
                <button id="delete-selected-stickers-btn">åˆªé™¤ (0)</button>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
            <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
            <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
<div id="music-player-overlay">
    <!-- â–¼â–¼â–¼ ã€è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ .music-player-window â–¼â–¼â–¼ -->
    <div class="music-player-window">
        <!-- â–¼â–¼â–¼ ã€è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ .music-player-top-actions â–¼â–¼â–¼ -->
<div class="music-player-top-actions">
    <div class="top-left-cluster">
        <button id="music-return-btn">â€¹</button>
        <button id="music-exit-btn">Ã—</button>
    </div>
    
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å‰µå»ºä¸€å€‹æ–°çš„å®¹å™¨ä¾†åŒ…è£¹å³å´çš„å…©å€‹æŒ‰éˆ• -->
    <div style="display: flex; align-items: center; gap: 15px;">
        <!-- ã€å…¨æ–°ã€‘é€™å°±æ˜¯æˆ‘å€‘çš„å…¨å±åˆ‡æ›æŒ‰éˆ• -->
        <button id="toggle-fullscreen-btn" title="åˆ‡æ›å…¨å±">
            <!-- æ”¾å¤§åœ–ç¤º -->
            <svg class="icon-maximize" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
            <!-- ç¸®å°åœ–ç¤º (é è¨­éš±è—) -->
            <svg class="icon-minimize" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
        </button>

        <!-- æ’­æ”¾æ¸…å–®æŒ‰éˆ•ä¿æŒä¸è®Š -->
        <span id="music-playlist-btn">â˜°</span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯é ­åƒé¡¯ç¤ºå®¹å™¨ï¼Œé è¨­éš±è— â–¼â–¼â–¼ -->
<div id="music-player-avatar-display">
    <!-- é ­åƒå°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- æ ¸å¿ƒä¿®æ”¹ï¼šå°‡æ­Œæ›²è³‡è¨Šç§»å‹•åˆ°å”±ç‰‡ä¸Šæ–¹ï¼Œä¸¦ç”¨ä¸€å€‹å®¹å™¨åŒ…è£¹ -->
<div id="music-info-top">
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡æ™‚é–“å’ŒæŒ‰éˆ•åŒ…è£¹åœ¨ä¸€å€‹flexå®¹å™¨ä¸­ï¼Œä½¿å…¶ä¸¦æ’é¡¯ç¤º -->
    <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
        <div id="music-time-counter">å·²ç¶“ä¸€èµ·è½äº†0.0å°æ™‚</div>
        <!-- ã€å…¨æ–°ã€‘é€™æ˜¯æˆ‘å€‘çš„æ–°æŒ‰éˆ• -->
        <button id="show-avatars-btn" title="é¡¯ç¤º/éš±è—é ­åƒ">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        </button>
    </div>
    <div id="music-player-song-title">è«‹æ·»åŠ æ­Œæ›²</div>
    <div id="music-player-artist">...</div>
</div>

        <!-- å”±ç‰‡/æ­Œè©åˆ‡æ›å®¹å™¨ä¿æŒä¸è®Š -->
        <div id="music-visual-container">
            <div id="vinyl-view">
                <img id="music-player-cover" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg" alt="Album Art">
            </div>
            <div id="inline-lyrics-view">
                <div id="music-lyrics-container">
                    <div id="music-lyrics-list">
                        <!-- JS æœƒåœ¨é€™è£¡å¡«å……æ­Œè© -->
                    </div>
                </div>
            </div>
        </div>
    <div id="single-lyric-display">â™ª â™ª â™ª</div>
        <!-- åº•éƒ¨æ§åˆ¶å€åŸŸä¿æŒä¸è®Š -->
        <div class="music-player-controls-wrapper">
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            <div class="music-controls">
                <button id="music-prev-btn">â—€</button>
                <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
                <button id="music-next-btn">â–¶</button>
                <button id="music-mode-btn">é †åº</button>
                <button id="toggle-blur-btn" title="åˆ‡æ›èƒŒæ™¯æ¸…æ™°åº¦">æ¸…</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
</div>
            <div id="music-playlist-panel">
                <div class="playlist-header">
                    <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
                    <span>æ’­æ”¾æ¸…å–®</span>
                    <div>
                     <span class="panel-btn" id="cleanup-songs-btn">æ¸…ç†</span>
                        <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
                        <span class="panel-btn" id="add-song-url-btn">URL</span>
        <span class="panel-btn" id="add-song-search-btn">æœç´¢</span>
                    </div>
                </div>
                <div class="playlist-body" id="playlist-body"></div>
            </div>
            <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
            <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
        </div>
        <!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€å·²ä¿®å¾©ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ ç¾æœ‰çš„ id="wallpaper-screen" çš„é‚£æ•´å€‹ <div> â–¼â–¼â–¼ -->
<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å¤–è§€è¨­ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <label style="font-weight: 500; color: var(--text-secondary);">EPhone ä¸»è¢å¹•å£ç´™</label>
        <div id="wallpaper-preview">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
        <div class="bg-upload-container">
            <button class="form-button-secondary" onclick="document.getElementById('wallpaper-upload-input').click();">æœ¬åœ°ä¸Šå‚³</button>
            <button id="upload-ephone-bg-url-btn" class="form-button-secondary">ç¶²è·¯URL</button>
            <button id="remove-ephone-bg-btn" class="form-button-secondary">ç§»é™¤å£ç´™</button>
        </div>
        <input type="file" id="wallpaper-upload-input" accept="image/*" hidden>
        
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <label style="font-weight: 500; color: var(--text-secondary);">CPhone æ‰‹æ©Ÿå£ç´™</label>
        <div id="cphone-wallpaper-preview">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
        <div class="bg-upload-container">
            <button class="form-button-secondary" onclick="document.getElementById('cphone-wallpaper-upload-input').click();">æœ¬åœ°ä¸Šå‚³</button>
            <button id="upload-cphone-bg-url-btn" class="form-button-secondary">ç¶²è·¯URL</button>
            <button id="remove-cphone-bg-btn" class="form-button-secondary">ç§»é™¤å£ç´™</button>
        </div>
        <input type="file" id="cphone-wallpaper-upload-input" accept="image/*" hidden>

        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <label style="font-weight: 500; color: var(--text-secondary);">å…¨åŸŸèŠå¤©èƒŒæ™¯ (æ‰€æœ‰èŠå¤©é»˜èª)</label>
        <div id="global-bg-preview" class="wallpaper-preview" style="height: 160px; width: 90px;">é»æ“Šä¸‹æ–¹ä¸Šå‚³</div>
        <div class="bg-upload-container">
            <button class="form-button-secondary" onclick="document.getElementById('global-bg-input').click()">æœ¬åœ°ä¸Šå‚³</button>
            <button id="upload-global-bg-url-btn" class="form-button-secondary">ç¶²è·¯URL</button>
            <button id="remove-global-bg-btn" class="form-button-secondary">ç§»é™¤å…¨åŸŸèƒŒæ™¯</button>
        </div>
        <input type="file" id="global-bg-input" accept="image/*" style="display: none;">
        
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
            <label for="theme-toggle-switch" style="margin-bottom: 0;">å¤œé–“æ¨¡å¼</label>
            <label class="toggle-switch">
                <input type="checkbox" id="theme-toggle-switch">
                <span class="slider"></span>
            </label>
        </div>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
            <label for="status-bar-toggle-switch" style="margin-bottom: 0;">é¡¯ç¤ºé ‚éƒ¨ç‹€æ…‹åˆ—</label>
            <label class="toggle-switch">
                <input type="checkbox" id="status-bar-toggle-switch">
                <span class="slider"></span>
            </label>
        </div>
        
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">æ¶ˆæ¯æç¤ºéŸ³</label>
        </div>
        <div class="form-group" style="width:100%;">
            <label for="notification-sound-url-input">æç¤ºéŸ³æª” URL (.mp3, .wav, .ogg)</label>
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                <input type="text" id="notification-sound-url-input" placeholder="ç•™ç©ºå‰‡ä½¿ç”¨é»˜èªæç¤ºéŸ³" style="flex-grow: 1;">
                <button id="test-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">â–¶</button>
                <button id="reset-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">é‡ç½®</button>
            </div>
        </div>

        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">EPhone App åœ–ç¤ºè¨­ç½®</label>
        </div>
        <div id="icon-settings-grid"></div>

        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div class="form-group" style="width:100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <label>èŠå¤©å·¥å…·åˆ—æŒ‰éˆ•æ’åº</label>
                <button id="reset-button-order-btn" title="æ¢å¾©é è¨­é †åº" class="form-button-secondary" style="margin: 0; padding: 4px 12px; font-size: 13px;">é‡ç½®é †åº</button>
            </div>
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                æŒ‰ä½ä¸‹æ–¹çš„æŒ‰éˆ•ä¸¦æ‹–å‹•å³å¯æ’åºï¼Œè¨­ç½®æœƒè‡ªå‹•ä¿å­˜ã€‚
            </p>
            <div id="button-order-editor" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background-color: #f0f2f5; border-radius: 8px; border: 1px solid var(--border-color);">
            </div>
        </div>

        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">CPhone App åœ–ç¤ºè¨­ç½®</label>
        </div>
        <div id="cphone-icon-settings-grid"></div>
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<h3 style="margin-top:0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; width:100%; text-align: left;">å¤–è§€é è¨­ç®¡ç†</h3>
<p style="font-size: 12px; color: #8a8a8a; margin-top: -5px; line-height: 1.5; width:100%; text-align: left;">
    ä¸€éµä¿å­˜æˆ–è¼‰å…¥å£ç´™ã€åœ–ç¤ºã€æŒ‰éˆ•æ’åºã€ä¸»é¡Œç­‰æ‰€æœ‰éCSSçš„è¦–è¦ºé¢¨æ ¼ã€‚
</p>
<div class="form-group" style="width:100%;">
    <label for="appearance-preset-select">é¸æ“‡æˆ–åˆ‡æ›é è¨­</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <select id="appearance-preset-select" style="flex-grow: 1;"></select>
        <button id="save-appearance-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
        <button id="delete-appearance-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆªé™¤</button>
    </div>
</div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <h3 style="margin-top:0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; width:100%; text-align: left;">CSS é è¨­ç®¡ç†</h3>
        <div class="form-group" style="width:100%;">
            <label for="css-preset-select">é¸æ“‡æˆ–åˆ‡æ›é è¨­</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="css-preset-select" style="flex-grow: 1;"></select>
                <button id="save-css-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                <button id="delete-css-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆªé™¤</button>
            </div>
        </div>
        <div class="form-group" style="width:100%;">
            <label for="global-css-input"> å…¨åŸŸç¾åŒ–æ¨£å¼ (CSS) <button id="reset-global-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
            </label>
            <textarea id="global-css-input" rows="6" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* åœ¨æ­¤è¼¸å…¥è‡ªè¨‚CSS */"></textarea>
        </div>

        <button class="form-button form-button-secondary" id="import-appearance-btn" style="margin-top: 10px;">å°å…¥å¤–è§€ (JSON)</button>
        <input type="file" id="import-appearance-input" accept="application/json" hidden>
                        
        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">ä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®</button>
    </div>
</div>

        <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é€£çµåŠŸèƒ½ HTML â–¼â–¼â–¼ -->
        <div id="browser-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="browser-back-btn">â€¹</span>
                <span id="browser-title"></span>
                <span style="width: 30px;"></span>
            </div>
            <div id="browser-content" class="list-container">
                <!-- æ–‡ç« å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
        <div id="font-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>å­—é«”è¨­ç½®</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
                <!-- ã€ã€ã€å…¨æ–°ï¼šå­—é«”é è¨­ç®¡ç†ã€‘ã€‘ã€‘ -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">å­—é«”é è¨­ç®¡ç†</h3>
                <div class="form-group">
                    <label for="font-preset-select">é¸æ“‡æˆ–åˆ‡æ›é è¨­</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="font-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-font-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                        <button id="delete-font-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆªé™¤</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
                <div class="form-group">
                    <label for="font-url-input">å­—é«”æª”URL (.ttf, .otf, .woffç­‰)</label>
                    <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
                </div>
                <div class="form-group">
                    <label>å³æ™‚é è¦½</label>
                    <div id="font-preview">
                        <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
                        <p style="margin: 0;">é€™æ˜¯å­—é«”é è¦½æ•ˆæœï¼Œ12345ã€‚</p>
                    </div>
                </div>
                <button class="form-button" id="save-font-btn">ä¿å­˜ä¸¦æ‡‰ç”¨</button>
                <button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¾©é è¨­å­—é«”</button>
            </div>
        </div>
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é¸æ“‡é€£çµ¡äººä»¥å‰µå»ºç¾¤èŠçš„è¢å¹• â–¼â–¼â–¼ -->
        <div id="contact-picker-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
                <span>é¸æ“‡é€£çµ¡äºº</span>
                <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
            </div>
            <div class="list-container" id="contact-picker-list">
                <!-- é€£çµ¡äººæ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå“¡ç®¡ç†è¢å¹• â–¼â–¼â–¼ -->
        <div id="member-management-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="back-from-member-management">â€¹</span>
                <span>ç¾¤æˆå“¡ç®¡ç†</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="list-container" id="member-management-list">
                <!-- ç¾æœ‰æˆå“¡æ¸…å–®æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div id="member-management-actions">
                <button id="add-existing-contact-btn">å¾å¥½å‹åˆ—è¡¨æ·»åŠ </button>
                <button id="create-new-member-btn">å‰µå»ºç¾¤å…§æ–°æˆå“¡</button>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å½ˆçª—HTMLé»è²¼åˆ°å…¶ä»–æ‰€æœ‰ modal çš„æ—é‚Š â–¼â–¼â–¼ -->
    <div id="sticker-category-manager-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ç®¡ç†è¡¨æƒ…åˆ†é¡</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å»ºåˆ†é¡</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-sticker-category-name-input" placeholder="è¼¸å…¥åˆ†é¡å..." style="flex-grow: 1;">
                        <button id="add-new-sticker-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-sticker-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- åˆ†é¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-sticker-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¾†é›»è«‹æ±‚æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
        <div id="incoming-call-modal" class="modal">
            <div class="incoming-call-content">
                <img id="caller-avatar" class="caller-avatar" src="">
                <div id="caller-name" class="caller-name"></div>
                <div class="caller-text">é‚€è«‹ä½ è¦–é »é€šè©±</div>
                <div class="incoming-call-actions">
                    <div class="action-button-wrapper">
                        <button id="decline-call-btn" class="call-action-btn decline"></button>
                        <span>æ‹’çµ•</span>
                    </div>
                    <div class="action-button-wrapper">
                        <button id="accept-call-btn" class="call-action-btn accept"></button>
                        <span>æ¥è½</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ®µã€å…¨æ–°ç¾¤èŠç›¸å®¹çµæ§‹ã€‘çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ #video-call-screen â–¼â–¼â–¼ -->
        <div id="video-call-screen" class="screen">
            <!-- 1. é ‚éƒ¨æ¬„ (ä¿æŒä¸è®Š) -->
            <div class="video-call-top-bar">
                <span id="call-timer">00:00</span>
            </div>
            <!-- 2. ã€å‡ç´šã€‘åƒèˆ‡è€…é ­åƒç¶²æ ¼å€åŸŸ -->
            <div class="video-call-avatar-area">
                <div id="participant-avatars-grid">
                    <!-- JSæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆé ­åƒ -->
                </div>
            </div>
            <!-- 3. å°è©±æ–¹å¡Šå€åŸŸ (ä¿æŒä¸è®Š) -->
            <div id="video-call-main" class="video-call-main">
                <!-- å°è©±å…§å®¹æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <!-- 4. ã€å‡ç´šã€‘åº•éƒ¨æ§åˆ¶æ¬„ï¼Œç¾åœ¨åŒ…å«ä¸€å€‹â€œåŠ å…¥â€æŒ‰éˆ• -->
            <div class="video-call-controls">
                <button id="user-speak-btn" class="control-btn speak-btn"></button>

                <button id="hang-up-btn" class="control-btn hangup-btn"></button>
                <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°æŒ‰éˆ• â–¼â–¼â–¼ -->
                <button id="regenerate-call-btn" class="control-btn regenerate-btn"></button>
                <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
                <!-- é€™å€‹æŒ‰éˆ•é è¨­éš±è—ï¼Œåªåœ¨ä½¿ç”¨è€…â€œæ—è§€â€æ™‚é¡¯ç¤º -->
                <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ä»‹é¢ â–¼â–¼â–¼ -->
        <div id="outgoing-call-screen" class="screen">
            <div class="outgoing-call-content">
                <img id="outgoing-call-avatar" class="caller-avatar" src="">
                <div id="outgoing-call-name" class="caller-name"></div>
                <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
                <div class="outgoing-call-actions">
                    <button id="cancel-call-btn" class="call-action-btn decline"></button>
                    <span>å–æ¶ˆ</span>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„é é¢ â–¼â–¼â–¼ -->
        <div id="call-history-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="call-history-back-btn">â€¹</span>
                <span id="call-history-title">é€šè©±è¨˜éŒ„</span>
                <span style="width: 30px;"></span> <!-- é ç•™ä½ç½®ï¼Œä¿æŒæ¨™é¡Œå±…ä¸­ -->
            </div>
            <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                <!-- é€šè©±è¨˜éŒ„å¡ç‰‡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- =================================================================== -->
<!-- â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›æ‰€æœ‰èˆŠçš„è±†ç“£HTML â–¼â–¼â–¼ -->
<!-- =================================================================== -->

<!-- 1. è±†ç“£å°çµ„å¸–å­æ¸…å–®è¢å¹• -->
<div id="douban-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>è±†ç“£å°çµ„</span>
        <div class="header-actions">
        <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é€™å°±æ˜¯æˆ‘å€‘çš„æ–°è¨­ç½®æŒ‰éˆ• -->
        <span class="action-btn" id="douban-settings-btn" title="è±†ç“£è¨­ç½®">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,4.84c-0.59,0.24-1.12,0.56-1.62,0.94L5.11,4.82c-0.22-0.08-0.47,0-0.59,0.22l-1.92,3.32 c-0.12,0.22-0.07,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.82,11.68,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.03 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.03c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
            </svg>
        </span>
            <span class="action-btn" id="douban-cast-select-btn" title="é¸æ“‡åƒèˆ‡è§’è‰²">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </span>
            <span class="action-btn" id="regenerate-douban-btn" title="é‡æ–°ç”Ÿæˆå…§å®¹">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="douban-posts-list" class="list-container">
        <!-- AIç”Ÿæˆçš„å¸–å­å°‡åœ¨é€™è£¡é¡¯ç¤º -->
    </div>
</div>

<!-- 2. è±†ç“£å¸–å­è©³æƒ…é è¢å¹• -->
<div id="douban-post-detail-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="douban-detail-back-btn">â€¹</span>
        <span id="douban-post-detail-title">å¸–å­è©³æƒ…</span>
        <span style="width: 30px;"></span>
    </div>
    <div id="douban-detail-content-wrapper" class="list-container">
        <div id="douban-post-detail-body">
            <div class="douban-post-header">
                <img id="douban-detail-avatar" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div id="douban-detail-author" class="douban-author-name"></div>
                    <div id="douban-detail-group" class="douban-group-name"></div>
                </div>
            </div>
            <h2 id="douban-detail-post-title" class="douban-post-title"></h2>
            <div id="douban-detail-content" class="douban-detail-content"></div>
        </div>
        <div class="douban-comments-section">
            <h4>å›æ‡‰</h4>
            <div id="douban-detail-comments-list"></div>
        </div>
    </div>
    <div id="douban-comment-footer" class="post-footer">
        <div class="comment-section">
            <img id="douban-my-comment-avatar" src="" class="comment-avatar">
            <input type="text" id="douban-comment-input" class="comment-input" placeholder="å¯«å›æ‡‰...">
        </div>
        <button id="douban-wait-reply-btn" class="douban-feather-btn" title="è®“AIç¹¼çºŒè¨è«–">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                <line x1="16" y1="8" x2="2" y2="22"></line>
                <line x1="17.5" y1="15" x2="9" y2="15"></line>
            </svg>
        </button>
        <button id="douban-send-comment-btn" class="comment-send-btn">ç™¼é€</button>
    </div>
</div>
        <div id="werewolf-game-screen" class="screen">
            <div class="header">
                <span id="werewolf-game-title">ç‹¼äººæ®º</span>
                <div class="header-actions">
<span class="action-btn" id="werewolf-retry-btn" title="é‡è©¦ä¸Šä¸€æ­¥AIæ“ä½œ" style="display: none;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
    </svg>
</span>
                    <span class="action-btn" id="exit-werewolf-game-btn">é€€å‡º</span>
                </div>
            </div>
            <!-- ç©å®¶é ­åƒå€ (ä¿æŒä¸è®Š) -->
            <div id="werewolf-player-grid"></div>
            <!-- éŠæˆ²æ—¥èªŒ/å°è©±å€ (ä¿æŒä¸è®Š) -->
            <div id="werewolf-log" class="list-container"></div>
            
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å…¨æ–°çš„ã€å¸¸é§çš„åº•éƒ¨æ“ä½œæ¬„ -->
            <div id="werewolf-action-bar">
                <div id="chat-input-main-row" style="width: 100%;">
                    <textarea id="werewolf-user-input" rows="1" placeholder="è¼ªåˆ°ä½ ç™¼è¨€äº†..."></textarea>
                    <div id="input-actions-wrapper" style="gap: 5px;">
                        <!-- ç™¼è¨€éšæ®µçš„æŒ‰éˆ• -->
                        <button id="werewolf-wait-reply-btn" class="action-button" style="display: none; background-color: #007bff; height: 40px; padding: 0 10px; font-size: 13px;">ç­‰å¾…å›æ‡‰</button>
                        <button id="werewolf-finish-speech-btn" class="action-button" style="display: none; background-color: var(--accent-color); height: 40px; padding: 0 10px; font-size: 13px;">çµæŸç™¼è¨€</button>
                        <!-- éç™¼è¨€éšæ®µçš„æŒ‰éˆ• -->
                        <button id="werewolf-next-step-btn" class="form-button" style="margin-top:0; display: none;">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é•·æœŸè¨˜æ†¶ç®¡ç†å…¨å±é é¢ â–¼â–¼â–¼ -->
    <div id="long-term-memory-screen" class="screen">
        <div class="header">
            <span class="back-btn" id="memory-screen-back-btn">â€¹</span>
            <span>é•·æœŸè¨˜æ†¶</span>
            <div class="header-actions">
                <span class="action-btn" id="refine-memory-btn-header">ç²¾ç…‰</span>
                <span class="action-btn" id="summarize-recent-btn-header">ç¸½çµ</span>
                <span class="action-btn" id="add-manual-memory-btn-header">+</span>
            </div>
        </div>
        <div class="list-container" id="memory-list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #f0f2f5;">
            <!-- é•·æœŸè¨˜æ†¶æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è¨­ç½®é é¢çµæ§‹ â–¼â–¼â–¼ -->
<div id="chat-settings-screen" class="screen">
    <!-- 1. é é¢çš„é ­éƒ¨ï¼ŒåŒ…å«è¿”å›å’Œä¿å­˜æŒ‰éˆ• -->
    <div class="header">
        <span class="back-btn" onclick="showScreen('chat-interface-screen')">â€¹</span>
        <span>èŠå¤©è¨­ç½®</span>
        <span class="save-btn" id="save-chat-settings-btn">ä¿å­˜</span>
    </div>

    <!-- 2. é é¢çš„å…§å®¹å®¹å™¨ï¼Œç¾åœ¨å¯ä»¥æ»¾å‹•äº† -->
    <div class="form-container">
        <!-- 
          é€™è£¡çš„å…§å®¹å°±æ˜¯ä½ åŸä¾† modal-body è£¡çš„æ‰€æœ‰ form-groupã€‚
          æˆ‘å€‘å·²ç¶“å°‡å®ƒå€‘åŸå°ä¸å‹•åœ°ç§»å‹•åˆ°é€™è£¡äº†ã€‚
        -->
        <div class="form-group" id="chat-name-group"><label for="chat-name-input">å‚™è¨»å / ç¾¤å</label><input type="text" id="chat-name-input"></div>
        <div class="form-group" id="my-nickname-group">
            <label for="my-nickname-input">æˆ‘çš„æ˜µç¨±</label>
            <input type="text" id="my-nickname-input">
        </div>
        <div class="form-group" id="assign-group-section" style="display: none;">
            <label for="assign-group-select">å¥½å‹åˆ†çµ„</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <select id="assign-group-select" style="flex-grow: 1;"></select>
                <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†åˆ†çµ„</button>
            </div>
        </div>
        <div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç¨±</label><input type="text" id="my-group-nickname-input"></div>
        <button class="form-button form-button-secondary" id="search-history-btn" style="margin-top: 10px;">æœç´¢èŠå¤©è¨˜éŒ„</button>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<div class="form-group" id="single-char-background-activity-group">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="char-background-activity-switch" style="margin-bottom: 0;">
            å•Ÿç”¨ç¨ç«‹å¾Œè‡ºæ´»å‹•
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å…è¨±è©²è§’è‰²åœ¨å¾Œè‡ºç¨ç«‹ç™¼æ¶ˆæ¯æˆ–å‹•æ…‹ã€‚éœ€åŒæ™‚é–‹å•ŸAPIè¨­ç½®ä¸­çš„ç¸½é–‹é—œã€‚
            </p>
        </label>
        <label class="toggle-switch">
            <input type="checkbox" id="char-background-activity-switch">
            <span class="slider"></span>
        </label>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        <div class="form-group" id="ai-cooldown-group">
            <label for="ai-action-cooldown-input"> ç¨ç«‹è¡Œå‹•å†·å» (åˆ†é˜) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AIåœ¨å¾Œè‡ºä¸»å‹•ç™¼æ¶ˆæ¯æˆ–å‹•æ…‹çš„æœ€å°é–“éš”ã€‚ </p>
            </label>
            <input type="number" id="ai-action-cooldown-input" min="1" value="10" style="width: 80px; text-align: center;">
        </div>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ™‚é–“æ„ŸçŸ¥é–‹é—œ â–¼â–¼â–¼ -->
        <div class="form-group" id="time-perception-group">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label for="time-perception-toggle" style="margin-bottom: 0;">
                    å•Ÿç”¨æ™‚é–“æ„ŸçŸ¥
                    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                        é—œé–‰å¾Œï¼ŒAIå°‡ä¸æœƒæ¥æ”¶åˆ°ç•¶å‰æ™‚é–“è³‡è¨Šï¼Œå°è©±ä¸­ä¸å†é«”ç¾æ™‚é–“è®ŠåŒ–ã€‚
                    </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="time-perception-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<div class="form-group" id="time-zone-group" style="display: none;">
    <label for="time-zone-select">é¸æ“‡æ™‚å€</label>
    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é€™å°±æ˜¯æˆ‘å€‘çš„æœç´¢æ¡† -->
    <input type="search" id="time-zone-search-input" placeholder="æœç´¢æ™‚å€ï¼Œä¾‹å¦‚ Shanghai, New York...">
    <select id="time-zone-select" style="width: 100%;"></select>
</div>
<div class="form-group" id="group-background-activity-group">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="group-background-activity-switch" style="margin-bottom: 0;">
            å•Ÿç”¨ç¾¤å…§å¾Œè‡ºæ´»å‹•
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å…è¨±AIæˆå“¡åœ¨è©²ç¾¤èŠä¸­ç¨ç«‹è¡Œå‹•ã€‚éœ€åŒæ™‚é–‹å•ŸAPIè¨­ç½®ä¸­çš„ç¸½é–‹é—œã€‚
            </p>
        </label>
        <label class="toggle-switch">
            <input type="checkbox" id="group-background-activity-switch">
            <span class="slider"></span>
        </label>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
        <div class="form-group" id="group-cooldown-group">
            <label for="group-action-cooldown-input"> ç¾¤èŠè¡Œå‹•å†·å» (åˆ†é˜) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AIåœ¨å¾Œè‡ºä¸»å‹•åœ¨ç¾¤å…§è¡Œå‹•çš„æœ€å°é–“éš”ã€‚ </p>
            </label>
            <input type="number" id="group-action-cooldown-input" min="1" value="10" style="width: 80px; text-align: center;">
        </div>
        <div class="form-group" id="group-avatar-group">
            <label>ç¾¤é ­åƒ</label>
            <div class="avatar-upload">
                <img id="group-avatar-preview">
                <button onclick="document.getElementById('group-avatar-input').click()">ä¸Šå‚³ç¾¤é ­åƒ</button>
                <button id="manage-group-avatar-library-btn">ç®¡ç†é ­åƒåº«</button>
                <input type="file" id="group-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="world-book-link-group">
            <label>é—œè¯ä¸–ç•Œæ›¸ (å¯å¤šé¸)</label>
            <div class="custom-multiselect">
                <div class="select-box">
                    <span class="selected-options-text">-- é»æ“Šé¸æ“‡ --</span>
                    <span class="arrow-down">â–¼</span>
                </div>
                <div id="world-book-checkboxes-container" class="checkboxes-container">
                </div>
            </div>
        </div>
        <div class="form-group" id="lyrics-position-group" style="display: none;">
            <hr style="opacity: 0.3; margin: 20px 0;">
            <label>æ­Œè©æ¬„ä½ç½®</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                <div>
                    <label for="lyrics-vertical-pos" style="font-size: 0.9em; color: var(--text-secondary);">å‚ç›´ä½ç½®</label>
                    <select id="lyrics-vertical-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="top">é ‚éƒ¨</option>
                        <option value="bottom">åº•éƒ¨</option>
                    </select>
                </div>
                <div>
                    <label for="lyrics-horizontal-pos" style="font-size: 0.9em; color: var(--text-secondary);">æ°´æº–å°é½Š</label>
                    <select id="lyrics-horizontal-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="left">å±…å·¦</option>
                        <option value="center">å±…ä¸­</option>
                        <option value="right">å±…å³</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label for="lyrics-offset-input" style="font-size: 0.9em; color: var(--text-secondary);">å‚ç›´åç§» (px)</label>
                <input type="number" id="lyrics-offset-input" value="10" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
        </div>
        <div class="form-group" id="offline-mode-group">
            <hr style="opacity: 0.3; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label for="offline-mode-toggle" style="margin-bottom: 0;"> å•Ÿç”¨ç·šä¸‹æ¨¡å¼ <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> é–‹å•Ÿå¾Œ, AIçš„å›å¾©å°‡è®Šç‚ºåŒ…å«ã€Œå°è©±ã€å’Œ<i style="color: #666;">å‹•ä½œ/ç’°å¢ƒæå¯«</i>çš„åŠ‡æƒ…æ¨¡å¼ã€‚ </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="offline-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="offline-mode-options" style="display: none; margin-top: 15px;">
                <label for="offline-min-length-input">å›å¾©å­—æ•¸ç¯„åœ</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="number" id="offline-min-length-input" value="100" style="width: 80px; text-align: center;">
                    <span>åˆ°</span>
                    <input type="number" id="offline-max-length-input" value="300" style="width: 80px; text-align: center;">
                    <span>å­—</span>
                </div>
    <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
        <label for="offline-preset-select">æ–‡é¢¨é è¨­ (å°‡å½±éŸ¿AIçš„æå¯«é¢¨æ ¼)</label>
        <select id="offline-preset-select" style="width: 100%; margin-top: 5px;"></select>
    </div>
            </div>
        </div>
        <div class="form-group" id="linked-memory-group">
            <label for="link-memory-toggle">æ›è¼‰å…¶ä»–èŠå¤©è¨˜æ†¶</label>
            <input type="checkbox" id="link-memory-toggle" style="width: auto; height: 20px; vertical-align: middle; margin-left: 10px;">
            <div id="linked-memory-selection" style="display: none; margin-top: 10px;">
                <label>é¸æ“‡è¦æ›è¼‰è¨˜æ†¶çš„èŠå¤© (å¯å¤šé¸):</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- é»æ“Šé¸æ“‡ --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="linked-chats-checkboxes-container" class="checkboxes-container" style="max-height: 120px;">
                    </div>
                </div>
                <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> â€¢ æ›è¼‰çš„è¨˜æ†¶æœƒä»¥â€œåƒè€ƒè¨˜æ†¶â€çš„å½¢å¼æä¾›çµ¦AIï¼Œä¸æœƒç›´æ¥é¡¯ç¤ºåœ¨èŠå¤©ä»‹é¢ã€‚<br> â€¢ å»ºè­°æ¯å€‹èŠå¤©æ›è¼‰3-10è¼ªè¨˜æ†¶ï¼Œé¿å…å½±éŸ¿å›æ‡‰é€Ÿåº¦ã€‚ </p>
            </div>
        </div>
        <div class="form-group" id="ai-original-name-group">
            <label for="ai-original-name-input">å°æ–¹æœ¬å (AIè­˜åˆ¥ç”¨)</label>
            <input type="text" id="ai-original-name-input">
        </div>
        <div class="form-group" id="ai-persona-group"><label for="ai-persona">å°æ–¹äººè¨­ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
        <div class="form-group" id="ai-avatar-group"><label>å°æ–¹é ­åƒ</label>
            <div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šå‚³å°æ–¹é ­åƒ</button><button id="manage-ai-avatar-library-btn">ç®¡ç†é ­åƒåº«</button><button class="change-frame-btn" data-type="ai">æ›´æ›é ­åƒæ¡†</button>
                <input type="file" id="ai-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè¨­ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div>
        <div class="form-group" id="switch-greeting-group" style="display: none;">
            <label>åˆ‡æ›é–‹å ´ (æœƒæ¸…ç©ºç•¶å‰å°è©±)</label>
            <button id="switch-greeting-btn" class="form-button form-button-secondary" style="margin-top: 5px;">é¸æ“‡å…¶ä»–é–‹å ´æ•…äº‹...</button>
        </div>
        <div class="form-group" id="my-avatar-group">
            <label>æˆ‘çš„é ­åƒ</label>
            <div class="avatar-upload">
                <img id="my-avatar-preview">
                <button onclick="document.getElementById('my-avatar-input').click()">ä¸Šå‚³æˆ‘çš„é ­åƒ</button>
                <button id="manage-my-avatar-library-btn">ç®¡ç†é ­åƒåº«</button>
                <button class="change-frame-btn" data-type="my">æ›´æ›é ­åƒæ¡†</button>
                <button id="open-persona-library-btn">é è¨­</button>
                <input type="file" id="my-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="group-members-group"><label>ç¾¤æˆå“¡äººè¨­</label>
            <div id="group-members-settings"></div>
            <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå“¡</button>
        </div>
<div class="form-group" id="tts-enable-group">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="enable-tts-switch" style="margin-bottom: 0;">
            å•Ÿç”¨èªéŸ³åˆæˆ (TTS)
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                é—œé–‰å¾Œï¼Œå³ä½¿AIå›å¾©åŒ…å« [V] é¦–ç¢¼ï¼Œä¹Ÿä¸æœƒç”ŸæˆèªéŸ³è¨Šæ¯ã€‚
            </p>
        </label>
        <label class="toggle-switch">
            <input type="checkbox" id="enable-tts-switch">
            <span class="slider"></span>
        </label>
    </div>
</div>
<div class="form-group" id="ai-voice-id-group">
    <label for="ai-voice-id-input">èªéŸ³ ID (Minimax voice_id)</label>
    <input type="text" id="ai-voice-id-input" placeholder="ä¾‹å¦‚: female-shaonv-jingpin">
</div>
        <div class="form-group">
            <label for="max-memory">çŸ­æœŸè¨˜æ†¶ï¼ˆä¸Šä¸‹æ–‡ï¼‰æ¢æ•¸</label>
            <input type="number" id="max-memory" value="10">
        </div>
        <div class="form-group">
            <label for="linked-memory-count">æ›è¼‰è¨˜æ†¶æ¢æ•¸</label>
            <input type="number" id="linked-memory-count" value="10">
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> â€¢ æ¯æ¬¡èª¿ç”¨æ™‚ï¼Œå¾æ¯å€‹â€œæ›è¼‰çš„èŠå¤©â€ä¸­æå–æœ€å¾Œå¹¾æ¢è¨˜éŒ„ä½œç‚ºåƒè€ƒè¨˜æ†¶ã€‚ <br> â€¢ å»ºè­°å€¼ 5-20ã€‚å€¼è¶Šå¤§è¨˜æ†¶è¶Šå…¨ï¼Œä½†APIè²»ç”¨è¶Šé«˜ã€å›æ‡‰è¶Šæ…¢ã€‚ </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
            <label for="auto-memory-toggle" style="margin-bottom: 0;"> å•Ÿç”¨è‡ªå‹•ç¸½çµé•·æœŸè¨˜æ†¶ <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> é–‹å•Ÿå¾Œï¼ŒAIæœƒåœ¨å°è©±é”åˆ°ä¸€å®šé•·åº¦æ™‚ï¼Œè‡ªå‹•å°‡å…§å®¹æç…‰ç‚ºé•·æœŸè¨˜æ†¶ã€‚ </p>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="auto-memory-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="form-group">
            <label for="auto-memory-interval">è‡ªå‹•ç¸½çµé–“éš”ï¼ˆæ¶ˆæ¯æ¢æ•¸ï¼‰</label>
            <input type="number" id="auto-memory-interval" min="10" value="20" style="width: 80px; text-align: center;">
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px;"> å»ºè­°å€¼ 15-30ã€‚å€¼è¶Šå°ï¼Œç¸½çµè¶Šé »ç¹ï¼Œä½†APIè²»ç”¨ä¹Ÿè¶Šé«˜ã€‚ </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group">
            <label>èŠå¤©æ°£æ³¡ä¸»é¡Œ <button id="reset-theme-btn" type="button">é‡ç½®</button></label>
            <div class="theme-selector">
                <label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜èª</label>
                <label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è—</label>
                <label><input type="radio" name="theme-select" value="blue_white"> è—ç™½</label>
                <label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»ƒ</label>
                <label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label>
                <label><input type="radio" name="theme-select" value="yellow_white"> é»ƒç™½</label>
                <label><input type="radio" name="theme-select" value="red_black"> ç´…é»‘</label>
                <label><input type="radio" name="theme-select" value="blue_yellow"> è—é»ƒ</label>
                <label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»ƒ</label>
                <label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label>
                <label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label>
                <label><input type="radio" name="theme-select" value="blue_green"> è—ç¶ </label>
                <label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label>
                <label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label>
                <label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç¶ </label>
                <label><input type="radio" name="theme-select" value="green_black"> ç¶ é»‘</label>
            </div>
        </div>
        <div class="form-group">
            <label for="font-size-slider">èŠå¤©å­—é«”å¤§å° <span id="font-size-value">13px</span></label>
            <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
        </div>
        <!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
        <!-- ã€ã€ã€å…¨æ–°ï¼šæ°£æ³¡ä¸»é¡Œé è¨­ç®¡ç†ã€‘ã€‘ã€‘ -->
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group">
            <label for="theme-preset-select">ä¸»é¡Œé è¨­ç®¡ç†</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="theme-preset-select" style="flex-grow: 1;"></select>
                <button id="save-theme-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                <button id="delete-theme-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆªé™¤</button>
            </div>
        </div>
        <!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
        <div class="form-group">
            <label for="custom-css-input"> è‡ªè¨‚æ°£æ³¡æ¨£å¼ (CSS) <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
            </label>
            <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* ç¤ºä¾‹ï¼šç‚ºâ€œæˆ‘â€çš„æ°£æ³¡æ·»åŠ æ¼¸è®ŠèƒŒæ™¯å’Œé™°å½± */ .message-bubble.user .content { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 15px 4px 15px 15px; }"></textarea>
        </div>
        <div class="form-group">
            <label>å³æ™‚é è¦½</label>
            <div id="settings-preview-area"></div>
        </div>
        <div class="form-group">
            <label>èŠå¤©èƒŒæ™¯</label>
            <div class="bg-upload-container">
                <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šå‚³èƒŒæ™¯åœ–</button>
                <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
            </div>
            <img id="bg-preview" class="bg-preview-img">
            <input type="file" id="bg-input" accept="image/*" style="display: none;">
        </div>
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
        <button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">æ‹‰é»‘å°æ–¹</button>
<!-- â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼ -->
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="export-single-chat-btn" style="background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;">åŒ¯å‡ºè©²èŠå¤©</button>
<button class="form-button form-button-secondary" id="import-single-chat-btn" style="background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2;">å°å…¥è©²èŠå¤©</button>
<input type="file" id="import-single-chat-input" accept="application/json" hidden>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
        <button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è¨˜éŒ„</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ rendering-rules-screen â–¼â–¼â–¼ -->
    <div id="rendering-rules-screen" class="screen">
        <div class="header">
            <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
            <span>æ¸²æŸ“è¦å‰‡</span>
            <span class="action-btn" id="add-new-rule-btn">+</span>
        </div>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å…¨æ–°çš„é ç°½å’Œå…§å®¹å€çµæ§‹ -->
        <div id="rules-tabs">
            <!-- JS æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆé ç°½ -->
        </div>
        <div id="rules-content-container">
            <!-- JS æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆå…§å®¹é¢æ¿ -->
        </div>
    </div>
    <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
    <!-- 2. è¦å‰‡ç·¨è¼¯å™¨æ¨¡æ…‹æ¡† -->
    <div id="rule-editor-modal" class="modal">
        <div class="modal-content" style="height: 85%;">
            <div class="modal-header">
                <span id="rule-editor-title">å‰µå»ºæ–°è¦å‰‡</span>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group" style="flex-shrink: 0;">
                    <label for="rule-name-input">è¦å‰‡åç¨±</label>
                    <input type="text" id="rule-name-input" placeholder="ä¾‹å¦‚ï¼šç¾åœ˜å¤–è³£å¡ç‰‡">
                </div>
                <div class="form-group" style="flex-shrink: 0;">
                    <label for="rule-chat-id-select">ç¶å®šç¯„åœ</label>
                    <select id="rule-chat-id-select">
                        <option value="global">å…¬ç”¨ (æ‰€æœ‰è§’è‰²)</option>
                        <!-- è§’è‰²æ¸…å–®å°‡ç”±JSå‹•æ…‹å¡«å…… -->
                    </select>
                </div>
                <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <label for="rule-regex-input">è¦å‰‡é‹ç®—å¼ (ä½¿ç”¨gä½œç‚ºæ¨™èªŒ)</label>
                    <textarea id="rule-regex-input" rows="3" style="font-family: monospace; resize: vertical;" placeholder="ä¾‹å¦‚ï¼šMTR\[(.*?)\]\[(.*?)\|(.*?)\]"></textarea>
                </div>
                <div class="form-group" style="flex-grow: 2; display: flex; flex-direction: column;">
                    <label for="rule-template-input">HTML ç¯„æœ¬ (ç”¨ $1, $2 å¼•ç”¨)</label>
                    <textarea id="rule-template-input" rows="6" style="font-family: monospace; resize: vertical;" placeholder="ä¾‹å¦‚ï¼š<div class=`waimai-card`>...<span>$2</span>...</div>"></textarea>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                    <label for="rule-enabled-switch" style="margin-bottom: 0;">å•Ÿç”¨è¦å‰‡</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="rule-enabled-switch" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-rule-editor-btn">å–æ¶ˆ</button>
                <button class="save" id="save-rule-btn">ä¿å­˜è¦å‰‡</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯èŠå¤©è¨˜éŒ„æœç´¢åŠŸèƒ½çš„HTMLä»£ç¢¼ â–¼â–¼â–¼ -->
<div id="search-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="search-history-back-btn">â€¹</span>
        <span>æœç´¢èŠå¤©è¨˜éŒ„</span>
        <span style="width: 30px;"></span>
    </div>
    <!-- æœç´¢æ¢ä»¶è¼¸å…¥å€ -->
    <div id="search-bar" style="padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--secondary-bg); flex-shrink: 0;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="search" id="keyword-search-input" placeholder="è¼¸å…¥é—œéµå­—..." style="flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;">
            <input type="date" id="date-search-input" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;">
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="execute-search-btn" class="form-button" style="margin-top: 0; flex-grow: 1;">æœç´¢</button>
            <button id="clear-search-btn" class="form-button form-button-secondary" style="margin-top: 0; flex-grow: 1;">é‡ç½®</button>
        </div>
    </div>
    <!-- æœç´¢çµæœé¡¯ç¤ºå€ -->
 
    <div id="chat-search-results-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- èŠå¤©è¨˜éŒ„çš„æœç´¢çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- =================================================================== -->
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- =================================================================== -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è³¼ç‰©åŠŸèƒ½ç›¸é—œé é¢èˆ‡å½ˆçª— (V4.0 - ä»¿æ·˜å¯¶çµ‚æ¥µç‰ˆ) â–¼â–¼â–¼ -->
<div id="shopping-screen" class="screen">
<div class="header">
    <div class="header-left-actions">
        <span class="back-btn" id="shopping-back-btn">â€¹</span>
        <span class="action-btn" id="generate-shopping-items-btn" title="AIç”Ÿæˆå•†å“">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg>
        </span>
        <span class="action-btn" id="shopping-settings-btn" title="ç”Ÿæˆè¨­ç½®">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,4.84c-0.59,0.24-1.12,0.56-1.62,0.94L5.11,4.82c-0.22-0.08-0.47,0-0.59,0.22l-1.92,3.32 c-0.12,0.22-0.07,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.82,11.68,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.03 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.03c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07,0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
            </svg>
        </span>
    </div>
    <span>è³¼ç‰©ä¸­å¿ƒ</span>
    <div class="header-actions">
        <span class="action-btn" id="manage-products-btn" title="ç®¡ç†å•†å“">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
        </span>
        <span class="action-btn" id="add-new-product-btn" title="æ·»åŠ æ–°å•†å“">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
        </span>
        <span class="action-btn" id="go-to-cart-btn" title="æŸ¥çœ‹è³¼ç‰©è»Š">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span id="cart-count">0</span>
        </span>
    </div>
</div>
            <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
           <div id="product-category-tabs"></div>
            <div id="product-grid" class="list-container">
                <!-- å•†å“å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        <div id="shopping-action-bar">
            <label class="select-all-label">
                <input type="checkbox" id="select-all-products-checkbox"> å…¨é¸
            </label>
            <button id="delete-selected-products-btn" class="action-bar-btn">åˆªé™¤ (0)</button>
        </div>
        </div>
        <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘å•†å“è©³æƒ…é  -->
        <div id="product-detail-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="product-detail-back-btn">â€¹</span>
                <span>å•†å“è©³æƒ…</span>
                <span style="width: 30px;"></span>
            </div>
            <div id="product-detail-content" class="list-container">
                <!-- è©³æƒ…å…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div id="product-detail-footer">
                <button class="footer-btn add-to-cart-detail-btn">åŠ å…¥è³¼ç‰©è»Š</button>
                <button class="footer-btn buy-now-btn">ç«‹å³è³¼è²·</button>
            </div>
        </div>
        <div id="cart-screen" class="screen">
            <!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ®µæ–°ä»£ç¢¼æ›¿æ›è³¼ç‰©è»Šé é¢çš„Header â–¼â–¼â–¼ -->
            <div class="header">
                <span class="back-btn" id="cart-back-btn">â€¹</span>
                <span id="cart-title">è³¼ç‰©è»Š(0)</span>
                <span class="action-btn" id="clear-cart-btn">æ¸…ç©º</span> <!-- å°‡â€œç®¡ç†â€æ›¿æ›ç‚ºâ€œæ¸…ç©ºâ€åŠŸèƒ½ -->
            </div>
            <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
            <div id="cart-items-list" class="list-container">
                <!-- è³¼ç‰©è»Šå•†å“å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div id="cart-footer">
                <label class="select-all-label"><input type="checkbox" id="select-all-cart-items"> å…¨é¸</label>
                <div class="cart-summary">
                    <div id="cart-total">åˆè¨ˆ: Â¥0.00</div>
                    <span class="cart-subtext">ä¸å«é‹è²»</span>
                </div>
                <button id="checkout-btn">çµç®—(0)</button>
            </div>
        </div>
<div id="product-editor-modal" class="modal">
    <div class="modal-content" style="height: 85%;">
        <div class="modal-header">
            <span id="product-editor-title">æ·»åŠ å•†å“</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å•†å“åœ–ç‰‡</label>
                <div class="avatar-upload">
                    <img id="product-image-preview" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg">
                    <button onclick="document.getElementById('product-image-input').click()">ä¸Šå‚³åœ–ç‰‡</button>
                    <input type="file" id="product-image-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="form-group">
                <label for="product-name-input">å•†å“åç¨±</label>
                <input type="text" id="product-name-input">
            </div>
            <div class="form-group">
                <label for="product-category-select">å•†å“åˆ†é¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="product-category-select" style="flex-grow: 1;"></select>
                    <button id="manage-product-categories-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†</button>
                </div>
            </div>
            <div class="form-group">
                <label for="product-price-input">é»˜èªåƒ¹æ ¼ (å…ƒ)</label>
                <input type="number" id="product-price-input" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="product-description-input">å•†å“æè¿°</label>
                <textarea id="product-description-input" rows="3" placeholder="è©³ç´°ä»‹ç´¹ä¸€ä¸‹é€™å€‹å•†å“..."></textarea>
            </div>
            
            <hr style="opacity: 0.2; margin: 20px 0;">
            <div class="form-group">
                <label>å•†å“æ¬¾å¼</label>
                <p style="font-size: 12px; color: #888; margin-top: -5px; margin-bottom: 10px;">å¦‚æœæ²’æœ‰æ·»åŠ ä»»ä½•æ¬¾å¼ï¼Œå°‡ä½¿ç”¨ä¸Šé¢çš„é»˜èªåƒ¹æ ¼ã€‚</p>
                <div id="product-variations-container" style="display: flex; flex-direction: column; gap: 15px;">
                    </div>
                <button id="add-product-variation-btn" class="form-button form-button-secondary" style="margin-top: 15px;">+ æ·»åŠ æ–°çš„ä¸€æ¬¾</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-product-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-product-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
        <div id="gift-receipt-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>è³¼ç‰©å°ç¥¨</span>
                </div>
                <div class="modal-body" id="gift-receipt-body">
                    <!-- å°ç¥¨å…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <div class="modal-footer">
                    <button class="save" id="close-receipt-btn" style="width:100%;">é—œé–‰</button>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
    </div>

    </div>

    <input type="file" id="import-card-input" accept=".json,.png" style="display: none;">
   <input type="file" id="import-world-book-input" accept=".json" style="display: none;">


    <div id="persona-library-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>æˆ‘çš„äººè¨­åº«</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div>
            <div class="modal-body">
                <div id="persona-library-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">é—œé–‰</button></div>
        </div>
    </div>
    <div id="persona-editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè¨­é è¨­</span></div>
            <div class="modal-body">
                <div class="form-group"><label>é è¨­é ­åƒ</label>
                    <div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šå‚³é ­åƒ</button><input type="file" id="preset-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label for="preset-persona-input">é è¨­äººè¨­</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¼¸å…¥é€™å€‹äººè¨­çš„è©³ç´°è¨­å®š..."></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="member-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ç·¨è¼¯ç¾¤æˆå“¡</span></div>
            <div class="modal-body">
                <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
                <div class="form-group"><label for="member-persona-input">äººè¨­</label><textarea id="member-persona-input" rows="4"></textarea></div>
                <div class="form-group"><label>é ­åƒ</label>
                    <div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šå‚³é ­åƒ</button><button class="change-frame-btn" data-type="member">æ›´æ›é ­åƒæ¡†</button><input type="file" id="member-avatar-input" accept="image/*"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç·¨è¼¯é è¨­</button>
                <button id="preset-action-delete" class="btn-danger">åˆªé™¤é è¨­</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">çµ¦Taä¸€å€‹é©šå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½‰å¸³é‡‘é¡</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="999999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å‚™è¨» (å¯é¸)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¢ºèªè½‰å¸³</button>
            </div>
        </div>
    </div>
    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚æ¨¡æ…‹æ¡† (V2.0 - æ”¯æŒç‚ºTAé»å–®) â–¼â–¼â–¼ -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>ç™¼èµ·å¤–è³£è¨‚å–®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">å•†å“è³‡è¨Š</label>
                <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¥Šæç”˜éœ²">
            </div>
            <div class="form-group">
                <label for="waimai-amount">è¨‚å–®é‡‘é¡ (å…ƒ)</label>
                <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚ï¼š21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åŸä¾†çš„â€œå–æ¶ˆâ€æŒ‰éˆ•ï¼Œç¾åœ¨è®Šæˆäº†â€œç‚ºTAé»å¤–è³£â€ -->
            <button class="save" id="waimai-order-for-ai-btn">ç‚ºTAé»å–®</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åŸä¾†çš„â€œç™¼èµ·è«‹æ±‚â€æŒ‰éˆ•ï¼Œç¾åœ¨æ˜¯å¦ä¸€å€‹é¸é … -->
            <button class="save" id="waimai-confirm-btn">ç™¼èµ·è«‹æ±‚</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°å»ºç´„å®š/å€’è¨ˆæ™‚æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="create-countdown-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>æ–°å»ºç´„å®š</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="countdown-title-input">ç´„å®šæ¨™é¡Œ</label>
                    <input type="text" id="countdown-title-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥">
                </div>
                <div class="form-group">
                    <label for="countdown-date-input">ç´„å®šæ—¥æœŸèˆ‡æ™‚é–“</label>
                    <input type="datetime-local" id="countdown-date-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-create-countdown-btn">ä¿å­˜ç´„å®š</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç™¼ç´…åŒ…æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="red-packet-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ç™¼ç´…åŒ…</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- 1. é ç°½åˆ‡æ› -->
                <div class="frame-tabs">
                    <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°£ç´…åŒ…</div>
                    <div id="rp-tab-direct" class="frame-tab">å°ˆå±¬ç´…åŒ…</div>
                </div>
                <!-- 2. æ‹¼æ‰‹æ°£ç´…åŒ…å…§å®¹å€ -->
                <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                    <div class="form-group">
                        <label>ç¸½é‡‘é¡ (å…ƒ)</label>
                        <input type="number" id="rp-group-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>ç´…åŒ…å€‹æ•¸</label>
                        <input type="number" id="rp-group-count" placeholder="å¡«å¯«ç´…åŒ…å€‹æ•¸">
                    </div>
                    <div class="form-group">
                        <label>ç¥ç¦èª</label>
                        <input type="text" id="rp-group-greeting" placeholder="æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼">
                    </div>
                    <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                    <button id="send-group-packet-btn" class="form-button">å¡éŒ¢é€²ç´…åŒ…</button>
                </div>
                <!-- 3. å°ˆå±¬ç´…åŒ…å…§å®¹å€ -->
                <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                    <div class="form-group">
                        <label>ç™¼é€çµ¦</label>
                        <select id="rp-direct-receiver"></select>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¡ (å…ƒ)</label>
                        <input type="number" id="rp-direct-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>ç¥ç¦èª</label>
                        <input type="text" id="rp-direct-greeting" placeholder="æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼">
                    </div>
                    <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                    <button id="send-direct-packet-btn" class="form-button">å¡éŒ¢é€²ç´…åŒ…</button>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…è©³æƒ…æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="red-packet-details-modal" class="modal">
        <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
            <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
                <div style="text-align: center; width: 100%;">
                    <div id="rp-details-sender" style="font-size: 16px;"></div>
                    <div style="font-size: 13px; opacity: 0.8;">çš„ç´…åŒ…</div>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
                <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                    <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                    <span style="font-size: 18px; color: #E44D44;">å…ƒ</span>
                </div>
                <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
                <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    <!-- é ˜å–è©³æƒ…å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-rp-details-btn" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰µå»ºæŠ•ç¥¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="create-poll-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ç™¼èµ·æŠ•ç¥¨</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="poll-question-input">æŠ•ç¥¨å•é¡Œ</label>
                    <textarea id="poll-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šæˆ‘å€‘çœ‹ä»€éº¼é›»å½±ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label>æŠ•ç¥¨é¸é … (è‡³å°‘2é …)</label>
                    <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- æŠ•ç¥¨é¸é …å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                    </div>
                    <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é¸é …</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-create-poll-btn">ç™¼èµ·æŠ•ç¥¨</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIé ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="ai-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="ai-avatar-library-title">å°æ–¹çš„é ­åƒåº«</span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡ä¸€å€‹æŒ‰éˆ•æ‹†åˆ†ç‚ºå…©å€‹ -->
                    <button id="add-ai-avatar-batch-btn" class="action-button">æ‰¹é‡</button>
                    <button id="add-ai-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-ai-avatar-upload-btn" class="action-button">ä¸Šå‚³</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- é ­åƒåº«å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€é ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="my-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="my-avatar-library-title">æˆ‘çš„é ­åƒåº«</span>
                <div class="header-actions">
                    <button id="add-my-avatar-batch-btn" class="action-button">æ‰¹é‡</button>
                    <button id="add-my-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-my-avatar-upload-btn" class="action-button">ä¸Šå‚³</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="my-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- â€œæˆ‘çš„â€é ­åƒåº«å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-my-avatar-library-btn" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <div id="group-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <!-- â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›ä½ ç¾æœ‰çš„ #group-avatar-library-modal .modal-header â–¼â–¼â–¼ -->
            <div class="modal-header">
                <span id="group-avatar-library-title">ç¾¤é ­åƒåº«</span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡ä¸€å€‹æŒ‰éˆ•æ‹†åˆ†ç‚ºå…©å€‹ -->
                    <button id="add-group-avatar-batch-btn" class="action-button">æ‰¹é‡</button>
                    <button id="add-group-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-group-avatar-upload-btn" class="action-button">ä¸Šå‚³</button>
                </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
            <div class="modal-body" style="padding: 15px;">
                <div id="group-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-avatar-library-btn" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <div id="chat-list-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="chat-list-action-pin"></button> <button id="chat-list-action-delete" class="btn-danger">åˆªé™¤èŠå¤©</button>
                <button id="chat-list-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…åˆ†äº«é€£çµæ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="share-link-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>åˆ†äº«é€£çµ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="link-title-input">æ¨™é¡Œ</label>
                    <input type="text" id="link-title-input" placeholder="è¼¸å…¥æ–‡ç« æˆ–é€£çµçš„æ¨™é¡Œ">
                </div>
                <div class="form-group">
                    <label for="link-description-input">æ‘˜è¦ (å¯é¸)</label>
                    <textarea id="link-description-input" rows="2" placeholder="ç°¡å–®æè¿°ä¸€ä¸‹é€£çµå…§å®¹"></textarea>
                </div>
                <div class="form-group">
                    <label for="link-source-input">ä¾†æºåç¨± (å¯é¸)</label>
                    <input type="text" id="link-source-input" placeholder="ä¾‹å¦‚ï¼šçŸ¥ä¹æ—¥å ±ã€Bç«™">
                </div>
                <div class="form-group">
                    <label for="link-content-input">å®Œæ•´å…§å®¹ (å¯é¸ï¼Œç”¨æ–¼æµè¦½å™¨å…§é¡¯ç¤º)</label>
                    <textarea id="link-content-input" rows="4" placeholder="é»è²¼æˆ–è¼¸å…¥å®Œæ•´çš„æ–‡ç« å…§å®¹"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾ç·»ç‰ˆè½‰å¸³æ“ä½œå½ˆçª— â–¼â–¼â–¼ -->
    <div id="transfer-actions-modal" class="modal">
        <div class="transfer-actions-content">
            <div class="transfer-actions-header">è«‹é¸æ“‡æ“ä½œ</div>
            <div class="transfer-actions-body">
                <p>ä½ æ”¶åˆ°äº†ä¾†è‡ª <strong id="transfer-sender-name"></strong> çš„ä¸€ç­†è½‰å¸³ã€‚</p>
            </div>
            <div class="transfer-actions-footer">
                <button id="transfer-action-decline" class="action-btn decline">æ®˜å¿æ‹’çµ•</button>
                <button id="transfer-action-accept" class="action-btn accept">é–‹å¿ƒæ”¶ä¸‹</button>
            </div>
            <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„è©³æƒ…æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="call-transcript-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="transcript-modal-title">é€šè©±è©³æƒ…</span>
            </div>
            <div class="modal-body" id="call-transcript-modal-body" style="background-color: #f0f2f5;">
                <!-- é€šè©±æ–‡å­—è¨˜éŒ„å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">åˆªé™¤è¨˜éŒ„</button>
                <!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ã€‘ã€‘ã€‘ -->
                <button class="save" id="manual-summarize-btn" style="background-color: #ffc107; border-color: #ffc107;">æ‰‹å‹•ç¸½çµ</button>
                <button class="save" id="close-call-transcript-btn" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«ç›®æ¨™é¸æ“‡å™¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="share-target-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>åˆ†äº«åˆ°...</span>
            </div>
            <div class="modal-body" id="share-target-list" style="padding: 0;">
                <!-- èŠå¤©æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-share-target-btn">ç¢ºèªåˆ†äº«</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è¨˜éŒ„æª¢è¦–å™¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="shared-history-viewer-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span id="shared-history-viewer-title">èŠå¤©è¨˜éŒ„</span>
            </div>
            <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
                <!-- åˆ†äº«çš„èŠå¤©è¨˜éŒ„æ°£æ³¡å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <div class="modal-footer">
                <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œæ›¸åˆ†é¡ç®¡ç†æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="world-book-category-manager-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ç®¡ç†ä¸–ç•Œæ›¸åˆ†é¡</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å»ºåˆ†é¡</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-category-name-input" placeholder="è¼¸å…¥åˆ†é¡å..." style="flex-grow: 1;">
                        <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- åˆ†é¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <div id="announcement-board-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ç¾¤å…¬å‘Šæ¿</span>
            </div>
            <div id="announcement-board-content">
            </div>
            <div class="modal-footer">
                <button class="save" id="close-announcement-board-btn" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <div id="announcement-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="announcement-action-pin">ç½®é ‚å…¬å‘Š</button>
                <button id="announcement-action-delete" class="btn-danger">åˆªé™¤å…¬å‘Š</button>
                <button id="announcement-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°çš„æ¨¡æ…‹æ¡†HTMLé»è²¼åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ…‹æ¡†ä¹‹å¾Œ â–¼â–¼â–¼ -->
    <div id="group-management-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ç®¡ç†å¥½å‹åˆ†çµ„</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å»ºåˆ†çµ„</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-group-name-input" placeholder="è¼¸å…¥åˆ†çµ„å..." style="flex-grow: 1;">
                        <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- åˆ†çµ„æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°HTMLé»è²¼åˆ°æ‰€æœ‰æ¨¡æ…‹æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
    <div id="message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <!-- æ–°çš„æ“ä½œæŒ‰éˆ• -->
                <button id="edit-message-btn">ç·¨è¼¯æ¶ˆæ¯</button>
                <button id="copy-message-btn">è¤‡è£½æ–‡æœ¬</button>
            <button id="copy-timestamp-btn">è¤‡è£½æ™‚é–“æˆ³è¨˜</button>
                <button id="recall-message-btn">æ’¤å›</button>
                <button id="publish-to-announcement-btn" style="display: none;">ç™¼ä½ˆåˆ°å…¬å‘Šæ¿</button>
                <button id="quote-message-btn">å¼•ç”¨</button>
                <button id="select-message-btn">é€²å…¥å¤šé¸</button>
                <!-- å–æ¶ˆæŒ‰éˆ• -->
                <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ è«‹å°‡é€™æ®µæ–°HTMLé»è²¼åˆ°æ‰€æœ‰æ¨¡æ…‹æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
    <div id="post-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-post-btn">ç·¨è¼¯å‹•æ…‹</button>
                <button id="copy-post-btn">è¤‡è£½å…§å®¹</button>
                <button id="cancel-post-action-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–è¦ºåŒ–æ¶ˆæ¯ç·¨è¼¯å™¨æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="message-editor-modal" class="modal">
        <div class="modal-content" style="height: 75%;">
            <div class="modal-header">
                <span>ç·¨è¼¯èˆ‡æ‹†åˆ†æ¶ˆæ¯</span>
            </div>
            <div class="modal-body" id="message-editor-body">
                <!-- ç·¨è¼¯å™¨å®¹å™¨ï¼ŒJSæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆæ–‡å­—æ–¹å¡Š -->
                <div id="message-editor-container"></div>
                <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰éˆ• -->
                <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] æ·»åŠ ä¸‹ä¸€æ¢æ¶ˆæ¯ </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
                <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œå°æ¼”å‰ªè¼¯å®¤â€æ¨¡æ…‹æ¡† â–¼â–¼â–¼ -->
    <div id="ai-response-editor-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span>å°æ¼”å‰ªè¼¯å®¤ (AIä¸Šä¸€è¼ªå›æ‡‰)</span>
            </div>
            <div class="modal-body" id="ai-response-editor-body">
                <!-- å°æ¼”å‰ªè¼¯å™¨å®¹å™¨ï¼ŒJSæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆæ–‡å­—æ–¹å¡Š -->
                <div id="ai-response-editor-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
                <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰éˆ• -->
                <button id="add-ai-response-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] æ·»åŠ ä¸€å€‹æ–°å‹•ä½œ </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-ai-response-editor-btn">å–æ¶ˆ</button>
                <button class="save" id="save-ai-response-editor-btn">æ‡‰ç”¨ä¿®æ”¹</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <div id="repost-modal" class="modal">
        <div id="custom-modal" style="width: 280px;">
            <div class="custom-modal-header">è½‰ç™¼å‹•æ…‹</div>
            <div class="custom-modal-body">
                <textarea id="repost-comment-input" placeholder="è«‹è¼¸å…¥è½‰ç™¼è©•è«– (å¯é¸)" style="width: 100%; min-height: 60px; resize: vertical; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 16px; box-sizing: border-box;"></textarea>
            </div>
            <div class="custom-modal-footer">
                <button id="repost-cancel-btn">å–æ¶ˆ</button>
                <button id="repost-confirm-btn" class="confirm-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±æ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨ â–¼â–¼â–¼ -->
    <div id="call-message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-call-message-btn">ç·¨è¼¯</button>
                <button id="delete-call-message-btn" class="btn-danger">åˆªé™¤</button>
                <button id="cancel-call-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->



    <audio id="audio-player" style="display:none;"></audio>
    <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢é€™æ®µã€å®Œæ•´ã€‘çš„æ¨¡æ…‹æ¡†ä»£ç¢¼ï¼Œæ›¿æ›æ‰ä½ ç¾æœ‰çš„ id="create-post-modal" çš„æ•´å€‹ div â–¼â–¼â–¼ -->
    <div id="create-post-modal" class="modal">
        <div class="modal-content" style="height: auto; max-height: 90%;">
            <div class="modal-header">
                <span>ç™¼ä½ˆå‹•æ…‹</span>
            </div>
            <div class="modal-body">
                <!-- å…¬é–‹æ–‡å­—è¼¸å…¥å€ -->
                <div class="form-group">
                    <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é®®äº‹...ï¼ˆéå¿…å¡«çš„å…¬é–‹æ–‡å­—ï¼‰"></textarea>
                </div>
                <!-- === æ¨¡å¼åˆ‡æ›é–‹é—œ (æ–°å¢) === -->
                <div class="post-mode-switcher">
                    <button id="switch-to-image-mode" class="mode-btn active">ä¸Šå‚³åœ–ç‰‡</button>
                    <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—åœ–</button>
                </div>
                <!-- â–¼â–¼â–¼ ã€ä¿®æ­£å¾Œã€‘çš„å¯è¦‹ç¯„åœè¨­ç½® â–¼â–¼â–¼ -->
                <div class="form-group">
                    <label>å¯è¦‹ç¯„åœ</label>
                    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <label><input type="radio" name="visibility" value="public" checked> å…¬é–‹</label>
                        <label><input type="radio" name="visibility" value="include"> æŒ‡å®šåˆ†çµ„å¯è¦‹</label>
                    </div>
                    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                        <!-- åˆ†çµ„å¤šé¸æ¡†å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <!-- â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² -->
                <!-- === åœ–ç‰‡æ¨¡å¼å€åŸŸ === -->
                <div id="image-mode-content" class="post-mode-content active">
                    <div class="form-group">
                        <div id="post-image-preview-container" class="post-image-preview-container">
                            <img id="post-image-preview" src="" alt="åœ–ç‰‡é è¦½">
                            <button id="post-remove-image-btn">Ã—</button>
                        </div>
                        <div class="post-image-upload-options">
                            <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šå‚³</button>
                            <button id="post-use-url-btn" class="form-button-secondary">ç¶²è·¯URL</button>
                            <input type="file" id="post-local-image-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div id="post-image-desc-group" class="form-group" style="display: none;">
                        <label>åœ–ç‰‡æè¿° (å¿…å¡«ï¼Œçµ¦AIçœ‹)</label>
                        <input type="text" id="post-image-description" placeholder="ç°¡å–®æè¿°åœ–ç‰‡å…§å®¹ï¼Œèª¬æ˜AIç†è§£">
                    </div>
                </div>
                <!-- === æ–‡å­—åœ–æ¨¡å¼å€åŸŸ (æ–°å¢) === -->
                <div id="text-image-mode-content" class="post-mode-content">
                    <div class="form-group">
                        <label>æ–‡å­—åœ– (çµ¦AIç†è§£ç”¨çš„æè¿°ï¼Œé»æ“Šåœ–ç‰‡å¾Œå¯è¦‹)</label>
                        <textarea id="post-hidden-text" rows="4" placeholder="åœ¨é€™è£¡å¯«ä¸‹åœ–ç‰‡æè¿°..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-create-post-btn">ç™¼ä½ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->



    <input type="file" id="ai-avatar-upload-input" accept="image/*" hidden>
    <input type="file" id="group-avatar-upload-input" accept="image/*" hidden>
    <script>
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
if (!Array.prototype.findLastIndex) {
  Object.defineProperty(Array.prototype, 'findLastIndex', {
    value: function(predicate) {
      if (this == null) {
        throw new TypeError('Cannot read property \'findLastIndex\' of null or undefined');
      }
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }
      let o = Object(this);
      let len = o.length >>> 0;
      let thisArg = arguments[1];
      let k = len - 1;
      while (k >= 0) {
        let kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return k;
        }
        k--;
      }
      return -1;
    },
    configurable: true,
    writable: true
  });
}


        // ... å…¶ä»–å…¨åŸŸè®Šæ•¸
        let activeMessageTimestamp = null;
        let activeTransferTimestamp = null; // <-- ç¢ºä¿é€™è¡Œåœ¨é€™è£¡ï¼Œä¸¦ä¸”åªæœ‰ä¸€è¡Œ
        // â–¼â–¼â–¼ åœ¨ä¸‹æ–¹é»è²¼æ–°è®Šæ•¸ â–¼â–¼â–¼
        let lastRawAiResponse = ''; // ç”¨æ–¼å­˜å„²AIä¸Šä¸€è¼ªçš„åŸå§‹å›æ‡‰å­—ä¸²
        let lastResponseTimestamps = []; // ç”¨æ–¼å­˜å„²ä¸Šä¸€è¼ªå›æ‡‰ç”Ÿæˆçš„æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        let currentQzoneReplyContext = null;
        let editingNpcId = null; // <-- æ–°å¢é€™ä¸€è¡Œ
        // ...
                const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
            // geminiå¦‚æœæ˜¯å¤šå€‹é‡‘é‘°, é‚£éº¼éš¨æ©Ÿç²å–ä¸€å€‹
            function getRandomValue(str) {
                // æª¢æŸ¥å­—ä¸²æ˜¯å¦åŒ…å«é€—è™Ÿ
                if (str.includes(',')) {
                    // ç”¨é€—è™Ÿåˆ†éš”å­—ä¸²ä¸¦ç§»é™¤å¤šé¤˜ç©ºæ ¼
                    const arr = str.split(',').map(item => item.trim());
                    // ç”Ÿæˆéš¨æ©Ÿç´¢å¼• (0 åˆ° arr.length-1)
                    const randomIndex = Math.floor(Math.random() * arr.length);
                    // è¿”å›éš¨æ©Ÿå…ƒç´ 
                    return arr[randomIndex];
                }
                // æ²’æœ‰é€—è™Ÿå‰‡ç›´æ¥è¿”å›åŸå­—ä¸²
                return str;
            }
            function isImage(content) {
                if(content.image_url && content.image_url.url){
                    let currentImageData = content.image_url.url
                    // æå–Base64è³‡æ–™ï¼ˆå»æ‰é¦–ç¢¼ï¼‰
                    const base64Data = currentImageData.split(',')[1];
                    // æ ¹æ“šåœ–ç‰‡é¡å‹ç²å–MIMEé¡å‹
                    const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
                    return [
                        {text: 'ä½¿ç”¨è€…å‘ä½ ç™¼é€äº†ä¸€å¼µåœ–ç‰‡'},
                        {
                            inline_data: {
                                mime_type: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }
                return []
            }
        
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚è¨ºæ–·å¢å¼·ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‚¨ç¾æœ‰çš„ getGeminiResponseText â–¼â–¼â–¼
        /**
         * ã€V3.0 | è¨ºæ–·å¢å¼·ç‰ˆã€‘å¾Geminiæˆ–ç›¸å®¹OpenAIçš„APIå›æ‡‰ä¸­å®‰å…¨åœ°æå–æ–‡æœ¬å…§å®¹
         * @param {object} data - å¾ response.json() è§£æå¾Œçš„è³‡æ–™ç‰©ä»¶
         * @returns {string} - æå–åˆ°çš„æ–‡æœ¬å…§å®¹
         * @throws {Error} - å¦‚æœéŸ¿æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–è¢«é®ç½©ï¼Œå‰‡æ‹‹å‡ºä¸€å€‹å¸¶æœ‰è©³ç´°åŸå› çš„éŒ¯èª¤
         */
        function getGeminiResponseText(data) {
            // 1. æª¢æŸ¥æ˜¯å¦æ˜¯ç›¸å®¹OpenAIçš„å›æ‡‰æ ¼å¼
            if (data.choices && Array.isArray(data.choices) && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                return data.choices[0].message.content;
            }
        
            // 2. æª¢æŸ¥æ˜¯å¦æ˜¯æˆåŠŸçš„ã€æ¨™æº–çš„åŸç”ŸGeminiå›æ‡‰æ ¼å¼
            if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            }
        
            // --- ã€ã€ã€æ ¸å¿ƒå‡ç´šï¼šå…¨é¢çš„éŒ¯èª¤è¨ºæ–·ã€‘ã€‘ã€‘ ---
            console.error("Gemini APIè¿”å›äº†éé æœŸçš„æ ¼å¼:", data);
            let errorReason = "AIè¿”å›äº†ç©ºå…§å®¹æˆ–æœªçŸ¥æ ¼å¼ã€‚";
        
            // 3a. è¨ºæ–·æ˜¯å¦æ˜¯å› ç‚ºå…§å®¹å®‰å…¨æ€§åŸå‰‡è¢«é®ç½© (Geminiå®˜æ–¹APIæœ€å¸¸è¦‹çš„å•é¡Œ)
            // é€™ç¨®æƒ…æ³data.candidatesæ˜¯å­˜åœ¨çš„ï¼Œä½†è£¡é¢æ²’æœ‰content
            if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
                const safetyRatings = data.candidates[0].safetyRatings;
                const blockedCategories = safetyRatings
                    .filter(r => r.probability !== 'NEGLIGIBLE' && r.probability !== 'LOW')
                    .map(r => `${r.category} (æ¦‚ç‡: ${r.probability})`)
                    .join(', ');
                errorReason = `å…§å®¹å› å®‰å…¨æ€§åŸå‰‡è¢«é®ç½©ã€‚è§¸ç™¼é¡åˆ¥: ${blockedCategories || 'æœªçŸ¥'}`;
            }
            // 3b. è¨ºæ–·å¦ä¸€ç¨®å…§å®¹å®‰å…¨é®ç½©æ ¼å¼ (promptFeedback)
            else if (data.promptFeedback?.blockReason) {
                const reason = data.promptFeedback.blockReason;
                const details = data.promptFeedback.safetyRatings?.map(r => `${r.category}: ${r.probability}`).join(', ');
                errorReason = `å…§å®¹å› å®‰å…¨æ€§åŸå‰‡è¢«é®ç½© (åŸå› : ${reason})ã€‚è©³æƒ…: ${details || 'ç„¡'}`;
            } 
            // 3c. è¨ºæ–·æ˜¯å¦æ˜¯å…¶ä»–é¡å‹çš„APIéŒ¯èª¤
            else if (data.error) {
                errorReason = `APIéŒ¯èª¤: ${data.error.message}`;
            }
            
            // 4. æ‹‹å‡ºä¸€å€‹å¸¶æœ‰è©³ç´°è³‡è¨Šçš„éŒ¯èª¤
            throw new Error(errorReason);
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        

            document.addEventListener('DOMContentLoaded', () => {
// â–¼â–¼â–¼ ã€æœ€çµ‚è­˜åœ–ä¿®å¾©æ–¹æ¡ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€ç›¸å®¹æ€§æ›´å¼·çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ toGeminiRequestData â–¼â–¼â–¼
function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision) {
    const apiTemperature = state.globalSettings.apiTemperature || 0.8; // <-- æ–°å¢ï¼šç²å–æº«åº¦
    const roleType = {
        user: 'user',
        assistant: 'model',
        system: 'user'
    };

    // --- 1. å°‡ systemInstruction é¡æ¯”æˆç¬¬ä¸€æ¬¡ä½¿ç”¨è€…å°è©±ï¼Œæ¥µå¤§æé«˜ç›¸å®¹æ€§ ---
    const contents = [
        {
            role: 'user',
            parts: [{ text: systemInstruction }]
        },
        {
            role: 'model',
            parts: [{ text: 'å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘æœƒåš´æ ¼éµå®ˆä»¥ä¸Šæ‰€æœ‰è¦å‰‡å’Œè¨­å®šã€‚' }]
        },
        // --- 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘æ™ºæ…§åœ°è™•ç†æ¯ä¸€æ¢æ¶ˆæ¯ï¼Œæ§‹å»ºæ­£ç¢ºçš„ parts é™£åˆ— ---
        ...messagesForDecision.map((item) => {
            const parts = [];
            // a. å¦‚æœ content æ˜¯ä¸€å€‹é™£åˆ—ï¼Œèªªæ˜å¯èƒ½æ˜¯è¤‡é›œæ¶ˆæ¯ï¼ˆæ–‡æœ¬+åœ–ç‰‡ï¼‰
            if (Array.isArray(item.content)) {
                item.content.forEach(part => {
                    if (part.type === 'text') {
                        parts.push({ text: part.text });
                    } else if (part.type === 'image_url' && part.image_url && part.image_url.url) {
                        // b. æ­£ç¢ºåœ°å¾ Base64 URL ä¸­æå–åœ–ç‰‡è³‡æ–™å’Œé¡å‹
                        const currentImageData = part.image_url.url;
                        const base64Data = currentImageData.split(',')[1];
                        const mimeTypeMatch = currentImageData.match(/^data:(.*);base64/);
                        if (mimeTypeMatch && base64Data) {
                            parts.push({
                                inline_data: {
                                    mime_type: mimeTypeMatch[1],
                                    data: base64Data
                                }
                            });
                        }
                    }
                });
            } else {
                // c. å¦‚æœ content æ˜¯æ™®é€šå­—ä¸²ï¼Œç›´æ¥ä½œç‚ºæ–‡æœ¬è™•ç†
                parts.push({ text: String(item.content) });
            }
            return { role: roleType[item.role], parts: parts };
        })
    ];

    // --- 3. è¿”å›æœ€çµ‚æ§‹å»ºå¥½çš„ã€å®Œå…¨ç¬¦åˆ Gemini API è¦ç¯„çš„è«‹æ±‚è³‡æ–™ ---
    return {
        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
        data: {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: contents,
                generationConfig: {
                    temperature: apiTemperature, // <-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘å€‘ç²å–çš„æº«åº¦å€¼
                },
            })
        }
    };
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                // ===================================================================
                // 1. æ‰€æœ‰è®Šæ•¸å’Œå¸¸é‡å®šç¾©
                // ===================================================================
                const db = new Dexie('GeminiChatDB');
        const avatarFrames = [ { id: 'none', url: '', name: 'ç„¡' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
              { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
            { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif', name: '14' },
        
          { id: 'frame_14', url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif', name: '14' },
          
          
        { id: 'frame_14', url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif', name: '14' },
          
          ];
                // --- å·²ä¿®æ­£ ---
               // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨ state ç‰©ä»¶ä¸­åˆå§‹åŒ– cache å±¬æ€§
let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null, cache: { songs: new Map(), lyrics: new Map() }, ttsCache: new Map() };
                // --- ä¿®æ­£çµæŸ ---
// â–¼â–¼â–¼ åœ¨ let state = ... ä¹‹å¾Œï¼Œé»è²¼é€™å€‹æ–°è®Šæ•¸ â–¼â–¼â–¼
let werewolfGameState = {
    isActive: false,
    gameMode: null, // '6p', '9p', '12p'
    chatId: null, // å¦‚æœæ˜¯å¾ç¾¤èŠç™¼èµ·çš„ï¼Œè¨˜éŒ„ç¾¤èŠID
    players: [], // { id, name, avatar, role, isAlive, character_persona }
    currentDay: 1,
    currentPhase: 'setup', // setup, night, discussion, voting, gameover
    nightActions: {}, // å­˜å„²ç•¶æ™šçš„è¡Œå‹•çµæœ
    gameLog: [], // å­˜å„²éŠæˆ²äº‹ä»¶æ—¥èªŒ
    discussionLog: [], // å­˜å„²è¨è«–å°è©±
    voteResults: {},
    electionInfo: {
        candidates: [],
        votes: {}
    },
    sheriffId: null,
    lastFailedAction: null,
};
// â–²â–²â–² æ–°å¢è®Šæ•¸çµæŸ â–²â–²â–²        
        let thoughtsHistoryRenderCount = 0;
        const THOUGHTS_RENDER_WINDOW = 15; // æ¯æ¬¡è¼‰å…¥15æ¢æ­·å²è¨˜éŒ„
        // â–¼â–¼â–¼ åœ¨JSé ‚éƒ¨ï¼Œè®Šæ•¸å®šç¾©å€ï¼Œæ·»åŠ é€™å€‹æ–°è®Šæ•¸ â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå‹•æ…‹åˆ†é è¼‰å…¥æ·»åŠ çš„è®Šæ•¸ â–¼â–¼â–¼
        let qzonePostsRenderCount = 0;
        const QZONE_RENDER_WINDOW = 10; // æ¯æ¬¡è¼‰å…¥10æ¢å‹•æ…‹
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        let qzonePostsCache = []; // ç”¨æ–¼ç·©å­˜å·²è¼‰å…¥çš„å‹•æ…‹å¸–å­è³‡æ–™
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        let musicState = { 
            isActive: false, 
            activeChatId: null, 
            isPlaying: false, 
            playlist: [], 
            currentIndex: -1, 
            playMode: 'order', 
            totalElapsedTime: 0, 
            timerId: null,
            // ã€æ–°å¢ã€‘æ­Œè©ç›¸é—œç‹€æ…‹
            parsedLyrics: [],      // ç•¶å‰æ­Œæ›²è§£æå¾Œçš„æ­Œè©é™£åˆ—
            currentLyricIndex: -1  // ç•¶å‰é«˜äº®çš„æ­Œè©è¡Œç´¢å¼•
        };
        let qzoneStickerPanelState = {
            isOpen: false,
            activePostId: null,
            panelEl: null,
            gridEl: null
        };
                const audioPlayer = document.getElementById('audio-player');
                let newWallpaperBase64 = null;
                let isSelectionMode = false;
let cphoneRenderedCount = 0;
let cphoneActiveConversationType = null; // ç”¨æ–¼è¨˜éŒ„Cphoneä¸­ç•¶å‰æ‰“é–‹çš„å°è©±é¡å‹
let isLoadingMoreCphoneMessages = false;
        let activeStickerCategoryId = 'all'; // ç”¨æ–¼è·Ÿè¹¤ç•¶å‰é¸ä¸­çš„è¡¨æƒ…åˆ†é¡
                let selectedMessages = new Set();
                let editingMemberId = null;
let isAddingNpcToGroup = false; // ç”¨æ–¼è·Ÿè¹¤æ˜¯å¦æ­£åœ¨ç‚ºç¾¤èŠå‰µå»ºæ–°NPC
                let editingWorldBookId = null;
               let editingRuleId = null; // ç”¨æ–¼å­˜å„²æ­£åœ¨ç·¨è¼¯çš„è¦å‰‡ID
let isLoadingMoreChats = false; // é˜²æ­¢åœ¨è¼‰å…¥æ™‚é‡è¤‡è§¸ç™¼
let isLoadingMoreMessages = false; // ã€å…¨æ–°ã€‘ç‚ºèŠå¤©è¨˜éŒ„æ·»åŠ ç¨ç«‹çš„è¼‰å…¥ç‹€æ…‹
let isLoadingMoreThoughts = false; // ã€å…¨æ–°ã€‘ç‚ºå¿ƒè²æ­·å²æ·»åŠ ç¨ç«‹çš„è¼‰å…¥ç‹€æ…‹
let isLoadingMorePosts = false;    // ã€å…¨æ–°ã€‘ç‚ºå‹•æ…‹æ¸…å–®æ·»åŠ ç¨ç«‹çš„è¼‰å…¥ç‹€æ…‹
let sortedChatListItems = [];   // ç”¨æ–¼å­˜å„²å®Œæ•´çš„ã€å·²æ’åºçš„èŠå¤©åˆ—è¡¨é …
                let editingPersonaPresetId = null;
                let currentReplyContext = null;
        let waimaiTimers = {}; // ç”¨æ–¼å­˜å„²å¤–è³£å€’è¨ˆæ™‚
        
        let activeMessageTimestamp = null;
let activeCharacterId = null; // ç”¨æ–¼è·Ÿè¹¤ç•¶å‰æ­£åœ¨æŸ¥çœ‹çš„CphoneID
let editingMemoId = null;
let editingDiaryId = null;
let activeDiaryForViewing = null; // ç”¨æ–¼æš«å­˜ç•¶å‰æ­£åœ¨æŸ¥çœ‹çš„æ—¥è¨˜ç‰©ä»¶
        // â–¼â–¼â–¼ åœ¨ä¸‹æ–¹é»è²¼æ–°è®Šæ•¸ â–¼â–¼â–¼
        let shoppingCart = []; // è³‡æ–™çµæ§‹å°‡è®Šç‚º [{ productId: 123, quantity: 1 }, ...]
        let editingProductId = null; // ç”¨æ–¼å­˜å„²æ­£åœ¨ç·¨è¼¯çš„å•†å“ID
        let activeProductId = null; // ç”¨æ–¼å­˜å„²ç•¶å‰æŸ¥çœ‹çš„å•†å“ID
let selectedProducts = new Set();
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå‹•æ…‹è©•è«–å€å›å¾©åŠŸèƒ½æ·»åŠ çš„ç‹€æ…‹è®Šæ•¸ â–¼â–¼â–¼
        let currentQzoneReplyContext = null; // ç”¨æ–¼å­˜å„²å›å¾©ä¸Šä¸‹æ–‡ { postId, replyToName, replyToDisplayName }
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        let activePostId = null; // <-- æ–°å¢ï¼šç”¨æ–¼å­˜å„²ç•¶å‰æ“ä½œçš„å‹•æ…‹ID
        let activeDoubanPostId = null;
                let photoViewerState = {
                    isOpen: false,
                    photos: [], // å­˜å„²ç•¶å‰ç›¸å†Šçš„æ‰€æœ‰ç…§ç‰‡URL
                    currentIndex: -1, // ç•¶å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
                };
        
                let unreadPostsCount = 0;
        
                let isFavoritesSelectionMode = false;
                let selectedFavorites = new Set()
        
        let simulationIntervalId = null;
        
                const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
                const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
                const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
                const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
                let notificationTimeout;
                let ruleCache = {}; // ç”¨æ–¼ç·©å­˜æ¸²æŸ“è¦å‰‡
// åœ¨ä½ çš„JSé ‚éƒ¨è®Šæ•¸å®šç¾©å€ï¼Œæ·»åŠ é€™å€‹æ–°å¸¸é‡
const DEFAULT_NOTIFICATION_SOUND = 'https://www.myinstants.com/media/sounds/notification-sound-2.mp3'; // é»˜èªçš„å¾®ä¿¡æç¤ºéŸ³
        // â–¼â–¼â–¼ åœ¨JSé ‚éƒ¨ï¼Œè®Šæ•¸å®šç¾©å€ï¼Œæ·»åŠ é€™å€‹æ–°è®Šæ•¸ â–¼â–¼â–¼
        let gomokuState = {}; // ç”¨æ–¼å­˜å„²æ¯å€‹èŠå¤©çš„äº”å­æ£‹ç‹€æ…‹
let readingState = {}; // { chatId: { isActive, isMinimized, title, ... } }
        let originalChatMessagesPaddingTop = null; // ç”¨æ–¼å­˜å„²æ¶ˆæ¯å€çš„åŸå§‹é ‚éƒ¨å…§é‚Šè·
        
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V2 ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ DEFAULT_APP_ICONS å¸¸é‡ â–¼â–¼â–¼
        const DEFAULT_APP_ICONS = {
            'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
            'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
            'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
            'renderer': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg',
            'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
            'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
            // ã€æ ¸å¿ƒæ–°å¢ã€‘å°‡Cphone(Cphone)å’Œè±†ç“£ä¹ŸåŠ å…¥ç®¡ç†åˆ—è¡¨
            'char-phone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg',
            'douban': 'https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg',
    // ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šåœ¨é€™è£¡ç‚ºâ€œé è¨­â€Appè¨»å†Šä¸€å€‹å”¯ä¸€çš„IDå’Œé è¨­åœ–ç¤ºã€‘ã€‘ã€‘
    'preset': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
            // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°çš„ä¸€è¡Œ â–¼â–¼â–¼
            'tutorial': 'https://i.postimg.cc/d10GjC4g/IMG-7302.jpg',
    'werewolf': 'https://i.postimg.cc/k401K5g7/IMG-7304.jpg',
    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°çš„ä¸€è¡Œ â–¼â–¼â–¼
    'x': 'https://i.postimg.cc/Y9d3BztC/1.png'
        };
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºCPhoneåœ–ç¤ºè¨­ç½®æ–°å¢çš„å¸¸é‡ â–¼â–¼â–¼
        const DEFAULT_CPHONE_ICONS = {
            'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
            'album': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
            'browser': 'https://i.postimg.cc/KzC2gTq6/IMG-7276.jpg',
            'taobao': 'https://i.postimg.cc/L6R7x16R/IMG-7278.jpg',
            'memo': 'https://i.postimg.cc/J0b6Nym4/IMG-7279.jpg',
            'diary': 'https://i.postimg.cc/DZ541sbt/IMG-7280.jpg',
            'amap': 'https://i.postimg.cc/Jz2Tz0dw/IMG-7281.jpg',
            'usage': 'https://i.postimg.cc/WbF8kzz9/IMG-7282.jpg',
            'music': 'https://is1-ssl.mzstatic.com/image/thumb/Purple112/v4/64/9d/21/649d21e8-a151-6136-3914-256e54f15d9a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png',
            'ephone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg'
        };
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        let repostTargetId = null; // ç”¨æ–¼å­˜å„²ç•¶å‰è¦è½‰ç™¼çš„å‹•æ…‹ID
                const STICKER_REGEX = /(^https:\/\/i\.postimg\.cc\/.+|^https:\/\/files\.catbox\.moe\/.+|^https?:\/\/sharkpan\.xyz\/.+|^data:image|\.(png|jpg|jpeg|gif|webp)\?.*$|\.(png|jpg|jpeg|gif|webp)$)/i;
                
                let currentRenderedCount = 0;
                let lastKnownBatteryLevel = 1;
                let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
                let batteryAlertTimeout;
                const dynamicFontStyle = document.createElement('style');
                dynamicFontStyle.id = 'dynamic-font-style';
                document.head.appendChild(dynamicFontStyle);
        
                const modalOverlay = document.getElementById('custom-modal-overlay');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalBody = document.getElementById('custom-modal-body');
                const modalConfirmBtn = document.getElementById('custom-modal-confirm');
                const modalCancelBtn = document.getElementById('custom-modal-cancel');
                let modalResolve;
        
                function showCustomModal() { 
                    modalOverlay.classList.add('visible'); 
                }
        
                function hideCustomModal() { 
                    modalOverlay.classList.remove('visible'); 
                    modalConfirmBtn.classList.remove('btn-danger'); 
                    if (modalResolve) modalResolve(null); 
                }
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ“šä¿å­˜çš„è¨­ç½®ï¼Œæ‡‰ç”¨æ­Œè©æ¬„çš„CSSæ¨£å¼
         * @param {object} chat - ç•¶å‰çš„èŠå¤©ç‰©ä»¶
         */
        function applyLyricsBarPosition(chat) {
            const lyricsBar = document.getElementById('global-lyrics-bar');
            // å¦‚æœèŠå¤©æ²’æœ‰è¨­ç½®ï¼Œå‰‡ä½¿ç”¨é è¨­å€¼
            const settings = chat.settings.lyricsPosition || { vertical: 'top', horizontal: 'center', offset: 10 };
            
            // é‡ç½®æ‰€æœ‰å¯èƒ½å½±éŸ¿ä½ç½®çš„å±¬æ€§
            lyricsBar.style.top = 'auto';
            lyricsBar.style.bottom = 'auto';
            lyricsBar.style.left = 'auto';
            lyricsBar.style.right = 'auto';
            lyricsBar.style.transform = 'none';
        
            // 1. è¨­ç½®å‚ç›´ä½ç½®å’Œåç§»é‡
            if (settings.vertical === 'top') {
                lyricsBar.style.top = `${settings.offset}px`;
            } else { // 'bottom'
                lyricsBar.style.bottom = `${settings.offset}px`;
            }
            
            // 2. è¨­ç½®æ°´æº–å°é½Š
            switch (settings.horizontal) {
                case 'left':
                    lyricsBar.style.left = '15px'; // ç•™å‡ºä¸€äº›é‚Šè·
                    break;
                case 'right':
                    lyricsBar.style.right = '15px'; // ç•™å‡ºä¸€äº›é‚Šè·
                    break;
                case 'center':
                default:
                    lyricsBar.style.left = '50%';
                    lyricsBar.style.transform = 'translateX(-50%)';
                    break;
            }
        }
        // â–¼â–¼â–¼ æŠŠé€™å€‹ã€å…¨æ–°çš„å‡½æ•¸ã€‘é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æœ¬åœ°ä¸Šå‚³ç¾¤é ­åƒä¸¦ç”±å‰¯APIè­˜åˆ¥çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶å¾æœ¬åœ°ä¸Šå‚³ç¾¤é ­åƒçš„æµç¨‹
         * @param {Event} event - æª”è¼¸å…¥æ¡†çš„ change äº‹ä»¶ç‰©ä»¶
         */
        async function handleLocalGroupAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // 1. è®€å–æ–‡ä»¶ç‚º Base64
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            // 2. å½ˆå‡ºæç¤ºï¼Œé–‹å§‹è­˜åœ–
            await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIç‚ºæ–°ç¾¤é ­åƒå‘½å...");
        
            try {
                // 3. èª¿ç”¨é€šç”¨çš„APIè­˜åœ–å‡½æ•¸ç²å–æè¿°
                const description = await getAvatarDescriptionFromApi(base64Url);
                
                if (!description) {
                    throw new Error("AIæœªèƒ½æˆåŠŸæè¿°åœ–ç‰‡ã€‚");
                }
        
                // 4. å°‡æè¿°ä½œç‚ºåå­—ï¼Œå’Œåœ–ç‰‡URLä¸€èµ·å­˜å…¥ç¾¤é ­åƒåº«
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.groupAvatarLibrary) {
                    chat.settings.groupAvatarLibrary = [];
                }
                chat.settings.groupAvatarLibrary.push({ name: description, url: base64Url });
                
                // 5. ä¿å­˜ä¸¦åˆ·æ–°
                await db.chats.put(chat);
                renderGroupAvatarLibrary();
                await showCustomAlert("ä¸Šå‚³æˆåŠŸï¼", `AIå·²å°‡æ–°ç¾¤é ­åƒå‘½åç‚ºï¼šâ€œ${description}â€`);
        
            } catch (error) {
                console.error("æœ¬åœ°ç¾¤é ­åƒä¸Šå‚³åŠè­˜åˆ¥å¤±æ•—:", error);
                await showCustomAlert("æ“ä½œå¤±æ•—", `ç„¡æ³•ç‚ºé ­åƒå‘½åï¼Œè«‹æª¢æŸ¥ï¼ˆä¸»/å‰¯ï¼‰APIé…ç½®æ˜¯å¦æ­£ç¢ºä¸¦æ”¯æ´Visionã€‚\néŒ¯èª¤: ${error.message}`);
            } finally {
                // ç„¡è«–æˆåŠŸèˆ‡å¦ï¼Œéƒ½æ¸…ç©ºæª”è¼¸å…¥æ¡†
                event.target.value = null;
            }
        }
        // â–²â–²â–² å…¨æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æœ¬åœ°ä¸Šå‚³é ­åƒä¸¦ç”±å‰¯APIè­˜åˆ¥çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶å¾æœ¬åœ°ä¸Šå‚³é ­åƒçš„æµç¨‹
         * @param {Event} event - æª”è¼¸å…¥æ¡†çš„ change äº‹ä»¶ç‰©ä»¶
         */
        async function handleLocalAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // 1. è®€å–æª”ç‚º Base64ï¼Œé€™æ˜¯ç™¼é€çµ¦APIå’Œå­˜å„²çš„å¿…è¦æ ¼å¼
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            // 2. å½ˆå‡ºæç¤ºï¼Œé–‹å§‹è­˜åœ–
            await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIç‚ºæ–°é ­åƒå‘½å...");
        
            try {
                // 3. èª¿ç”¨APIç²å–åœ–ç‰‡æè¿°ï¼ˆé€™å€‹æè¿°å°‡ä½œç‚ºé ­åƒçš„åå­—ï¼‰
                const description = await getAvatarDescriptionFromApi(base64Url);
                
                if (!description) {
                    throw new Error("AIæœªèƒ½æˆåŠŸæè¿°åœ–ç‰‡ã€‚");
                }
        
                // 4. å°‡æè¿°ä½œç‚ºåå­—ï¼Œå’Œåœ–ç‰‡URLä¸€èµ·å­˜å…¥é ­åƒåº«
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.aiAvatarLibrary) {
                    chat.settings.aiAvatarLibrary = [];
                }
                chat.settings.aiAvatarLibrary.push({ name: description, url: base64Url });
                
                // 5. ä¿å­˜ä¸¦åˆ·æ–°
                await db.chats.put(chat);
                renderAiAvatarLibrary();
                await showCustomAlert("ä¸Šå‚³æˆåŠŸï¼", `AIå·²å°‡æ–°é ­åƒå‘½åç‚ºï¼šâ€œ${description}â€`);
        
            } catch (error) {
                console.error("æœ¬åœ°é ­åƒä¸Šå‚³åŠè­˜åˆ¥å¤±æ•—:", error);
                await showCustomAlert("æ“ä½œå¤±æ•—", `ç„¡æ³•ç‚ºé ­åƒå‘½åï¼Œè«‹æª¢æŸ¥ï¼ˆä¸»/å‰¯ï¼‰APIé…ç½®æ˜¯å¦æ­£ç¢ºä¸¦æ”¯æ´Visionã€‚\néŒ¯èª¤: ${error.message}`);
            } finally {
                // ç„¡è«–æˆåŠŸèˆ‡å¦ï¼Œéƒ½æ¸…ç©ºæª”è¼¸å…¥æ¡†ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æª”
                event.target.value = null;
            }
        }
        
        /**
         * ã€å…¨æ–°ã€‘èª¿ç”¨ï¼ˆå‰¯ï¼‰APIä¾†ç²å–åœ–ç‰‡çš„æè¿°
         * @param {string} base64Url - åœ–ç‰‡çš„ Base64 Data URL
         * @returns {Promise<string>} - è¿”å›AIç”Ÿæˆçš„åœ–ç‰‡æè¿°
         */
        async function getAvatarDescriptionFromApi(base64Url) {
            // æ™ºèƒ½é¸æ“‡APIï¼šå„ªå…ˆä½¿ç”¨å‰¯APIï¼Œå¦‚æœæœªé…ç½®å‰‡è‡ªå‹•å›é€€åˆ°ä¸»API
            const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
            const { proxyUrl, apiKey, model } = useSecondaryApi 
                ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
                : state.apiConfig;
        
            if (!proxyUrl || !apiKey || !model) {
                throw new Error("ä¸»APIå’Œå‰¯APIå‡æœªé…ç½®æˆ–é…ç½®ä¸å®Œæ•´ã€‚");
            }
        
            const prompt = "è«‹ç‚ºé€™å¼µåœ–ç‰‡èµ·ä¸€å€‹ç°¡æ½”çš„ã€é©åˆä½œç‚ºé ­åƒåº«æ¨™ç±¤çš„åå­—ã€‚ä¾‹å¦‚ï¼šâ€œå¾®ç¬‘è‡ªæ‹â€ã€â€œé™½å…‰ä¸‹çš„è²“å’ªâ€ã€â€œè—ç™¼å‹•æ¼«å°‘å¥³â€ã€‚è«‹ç›´æ¥å›ç­”åå­—ï¼Œä¸è¦åŠ ä»»ä½•å¤šé¤˜çš„è§£é‡‹ã€‚";
            
            let isGemini = proxyUrl.includes('generativelanguage');
            let response;
        
            if (isGemini) {
                const mimeType = base64Url.match(/^data:(.*);base64/)[1];
                const base64Data = base64Url.split(',')[1];
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }]
                };
                response = await fetch(`${proxyUrl}/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
        
            } else { // OpenAI ç›¸å®¹ Vision API
                const payload = {
                    model: model,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt },
                            { type: 'image_url', image_url: { url: base64Url } }
                        ]
                    }],
                    max_tokens: 50 // é™åˆ¶è¼¸å‡ºé•·åº¦
                };
                response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify(payload)
                });
            }
        
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API éŒ¯èª¤: ${errorData.error.message}`);
            }
        
            const data = await response.json();
            let description = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
            
            // æ¸…ç†AIå¯èƒ½è¿”å›çš„å¤šé¤˜å­—å…ƒ
            return description.trim().replace(/["'â€œâ€â€˜â€™]/g, '');
        }
        // â–²â–²â–² å…¨æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘ç•¶å–®èŠè§’è‰²çš„åç¨±è¢«ä¿®æ”¹å¾Œï¼Œè‡ªå‹•åŒæ­¥å…¶åœ¨æ‰€æœ‰ç¾¤èŠä¸­çš„è³‡è¨Š
         * @param {object} characterChat - è¢«ä¿®æ”¹äº†åç¨±çš„ã€å–®èŠã€‘chatå°è±¡
         */
        async function syncCharacterNameInGroups(characterChat) {
            // 1. å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿å‚³å…¥çš„æ˜¯ä¸€å€‹æœ‰æ•ˆçš„å–®èŠç‰©ä»¶
            if (!characterChat || characterChat.isGroup) {
                console.warn("syncCharacterNameInGroups: å‚³å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å–®èŠå°è±¡ï¼Œå·²è·³éåŒæ­¥ã€‚");
                return;
            }
        
            const characterId = characterChat.id;
            const newRemarkName = characterChat.name;        // é€™æ˜¯è§’è‰²æ–°çš„ã€å‚™è¨»åã€‘
            const newOriginalName = characterChat.originalName;  // é€™æ˜¯è§’è‰²æ–°çš„ã€æœ¬åã€‘
        
            console.log(`æ­£åœ¨ç‚ºè§’è‰² ${characterId} åŒæ­¥æ‰€æœ‰ç¾¤èŠå…§çš„åç¨±è³‡è¨Š...`);
        
            // 2. éæ­·è¨˜æ†¶é«”ä¸­æ‰€æœ‰çš„èŠå¤©è¨˜éŒ„ï¼Œæ‰¾å‡ºæ‰€æœ‰ç¾¤èŠ
            for (const chatId in state.chats) {
                const groupChat = state.chats[chatId];
                
                // 3. ç¯©é¸å‡ºç¾¤èŠï¼Œä¸¦ç¢ºä¿å®ƒæœ‰æˆå“¡åˆ—è¡¨
                if (groupChat.isGroup && groupChat.members) {
                    // 4. åœ¨ç¾¤èŠä¸­æŸ¥æ‰¾å°æ‡‰çš„æˆå“¡
                    const memberToUpdate = groupChat.members.find(m => m.id === characterId);
        
                    // å¦‚æœåœ¨é€™å€‹ç¾¤è£¡æ‰¾åˆ°äº†è©²æˆå“¡
                    if (memberToUpdate) {
                        let needsDbUpdate = false; // æ¨™è¨˜æ˜¯å¦éœ€è¦æ›´æ–°è³‡æ–™åº«ï¼Œä»¥å„ªåŒ–æ€§èƒ½
                        
                        // 5. å°æ¯”ä¸¦æ›´æ–°ç¾¤å…§æ˜µç¨± (groupNickname)ï¼Œå®ƒæ‡‰è©²èˆ‡å–®èŠçš„å‚™è¨»å(name)ä¿æŒä¸€è‡´
                        if (memberToUpdate.groupNickname !== newRemarkName) {
                            memberToUpdate.groupNickname = newRemarkName;
                            needsDbUpdate = true;
                        }
        
                        // 6. å°æ¯”ä¸¦æ›´æ–°ç¾¤å…§çš„æœ¬å (originalName)
                        if (memberToUpdate.originalName !== newOriginalName) {
                            memberToUpdate.originalName = newOriginalName;
                            needsDbUpdate = true;
                        }
        
                        // 7. å¦‚æœæœ‰ä»»ä½•æ›´æ–°ï¼Œå°±æŠŠé€™å€‹ã€æ•´å€‹ç¾¤èŠç‰©ä»¶ã€‘ä¹Ÿä¿å­˜å›è³‡æ–™åº«
                        if (needsDbUpdate) {
                            await db.chats.put(groupChat);
                            console.log(`æˆåŠŸå°‡ç¾¤èŠ "${groupChat.name}" ä¸­çš„æˆå“¡è³‡è¨Šæ›´æ–°`);
                        }
                    }
                }
            }
        }
        
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å…¨æ–°çš„å‡½æ•¸é»è²¼åˆ° syncCharacterNameInGroups çš„ä¸‹æ–¹ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘ç•¶å–®èŠè§’è‰²çš„é ­åƒè¢«ä¿®æ”¹å¾Œï¼Œè‡ªå‹•åŒæ­¥å…¶åœ¨æ‰€æœ‰ç¾¤èŠä¸­çš„é ­åƒè³‡è¨Š
         * @param {object} characterChat - è¢«ä¿®æ”¹äº†é ­åƒçš„ã€å–®èŠã€‘chatå°è±¡
         */
        async function syncCharacterAvatarInGroups(characterChat) {
            // 1. å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿æ˜¯æœ‰æ•ˆçš„å–®èŠç‰©ä»¶
            if (!characterChat || characterChat.isGroup) {
                console.warn("syncCharacterAvatarInGroups: å‚³å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å–®èŠå°è±¡ï¼Œå·²è·³éåŒæ­¥ã€‚");
                return;
            }
        
            const characterId = characterChat.id;
            const newAvatar = characterChat.settings.aiAvatar; // ç²å–æœ€æ–°çš„é ­åƒURL
        
            console.log(`æ­£åœ¨ç‚ºè§’è‰² ${characterId} åŒæ­¥æ‰€æœ‰ç¾¤èŠå…§çš„é ­åƒ...`);
        
            // 2. éæ­·æ‰€æœ‰èŠå¤©ï¼Œæ‰¾å‡ºæ‰€æœ‰ç¾¤èŠ
            for (const groupChat of Object.values(state.chats)) {
                if (groupChat.isGroup && groupChat.members) {
                    // 3. åœ¨ç¾¤èŠä¸­æŸ¥æ‰¾å°æ‡‰çš„æˆå“¡
                    const memberToUpdate = groupChat.members.find(m => m.id === characterId);
                    
                    // 4. å¦‚æœæ‰¾åˆ°äº†è©²æˆå“¡ï¼Œä¸¦ä¸”é ­åƒè³‡è¨Šä¸ä¸€è‡´ï¼Œå°±æ›´æ–°å®ƒ
                    if (memberToUpdate && memberToUpdate.avatar !== newAvatar) {
                        memberToUpdate.avatar = newAvatar; // å°‡æ–°é ­åƒåŒæ­¥åˆ°ç¾¤æˆå“¡è³‡æ–™ä¸­
                        
                        // 5. ã€è‡³é—œé‡è¦ã€‘å°‡ä¿®æ”¹å¾Œçš„ã€æ•´å€‹ç¾¤èŠç‰©ä»¶ã€‘å­˜å›è³‡æ–™åº«
                        await db.chats.put(groupChat);
                        console.log(`æˆåŠŸå°‡è§’è‰² ${characterId} çš„æ–°é ­åƒåŒæ­¥åˆ°ç¾¤èŠ "${groupChat.name}"`);
                    }
                }
            }
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€æ›´æ™ºæ…§çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ getDisplayNameInGroup å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | å·²ä¿®å¾©ä½¿ç”¨è€…è­˜åˆ¥å•é¡Œã€‘æ ¹æ“šè§’è‰²æœ¬åï¼Œåœ¨æŒ‡å®šç¾¤èŠä¸­ç²å–å…¶æ­£ç¢ºçš„é¡¯ç¤ºåç¨±ï¼ˆç¾¤æ˜µç¨±ï¼‰
         * @param {object} groupChat - ç•¶å‰çš„ç¾¤èŠç‰©ä»¶
         * @param {string} originalName - è§’è‰²çš„æœ¬å (e.g., "å°å¯æ„›", "æ–¹äº¦æ¥·")
         * @returns {string} - è©²è§’è‰²åœ¨æ­¤ç¾¤èŠä¸­çš„ç¾¤æ˜µç¨±ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å›å…¶æœ¬å
         */
        function getDisplayNameInGroup(groupChat, originalName) {
            // å®‰å…¨æª¢æŸ¥ï¼Œå¦‚æœè³‡è¨Šä¸å…¨å‰‡ç›´æ¥è¿”å›
            if (!groupChat || !groupChat.isGroup || !originalName) {
                return originalName;
            }
        
            // --- ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ ---
        
            // æ­¥é©Ÿ1ï¼šå„ªå…ˆæª¢æŸ¥é€™å€‹â€œæœ¬åâ€æ˜¯ä¸æ˜¯ã€ç”¨æˆ¶è‡ªå·±ã€‘çš„å…¨åŸŸæœ¬å
            // ä½¿ç”¨è€…çš„å…¨åŸŸæœ¬åå­˜å„²åœ¨ qzoneSettings.nickname ä¸­
            const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
            if (originalName === userOriginalName) {
                // å¦‚æœæ˜¯ç”¨æˆ¶ï¼Œå°±è¿”å›ç”¨æˆ¶åœ¨ã€é€™å€‹ç¾¤èŠä¸­ã€‘çš„å°ˆå±¬æ˜µç¨±
                return groupChat.settings.myNickname || 'æˆ‘';
            }
        
            // æ­¥é©Ÿ2ï¼šå¦‚æœä¸æ˜¯ç”¨æˆ¶ï¼Œå†åˆ°ç¾¤æˆå“¡åˆ—è¡¨è£¡å»æŸ¥æ‰¾å°æ‡‰çš„AIè§’è‰²
            const member = groupChat.members.find(m => m.originalName === originalName);
            
            // æ­¥é©Ÿ3ï¼šå¦‚æœæ‰¾åˆ°äº†AIæˆå“¡ï¼Œå°±è¿”å›TAçš„ç¾¤æ˜µç¨±ï¼›å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå°±è¿”å›åŸå§‹åå­—ä½œç‚ºä¿åº•
            return member ? member.groupNickname : originalName;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘åˆ‡æ›æ¸²æŸ“è¦å‰‡çš„åˆ†é¡é ç°½
         * @param {string} categoryId - è¦åˆ‡æ›åˆ°çš„åˆ†é¡ID ('global' æˆ– èŠå¤©ID)
         */
        function switchRuleCategory(categoryId) {
            // åˆ‡æ›é ç°½çš„å•Ÿå‹•ç‹€æ…‹
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
            });
            // åˆ‡æ›å…§å®¹é¢æ¿çš„é¡¯ç¤ºç‹€æ…‹
            document.querySelectorAll('.rules-category-pane').forEach(pane => {
                pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
            });
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ“šè§’è‰²çš„æœ¬åï¼Œåœ¨æ•´å€‹æ‡‰ç”¨ä¸­æŸ¥æ‰¾å…¶æ­£ç¢ºçš„é¡¯ç¤ºåç¨±
         * @param {string} originalName - è§’è‰²çš„æœ¬å (e.g., "ææ˜Ÿè¾°")
         * @returns {string} - è©²è§’è‰²çš„å‚™è¨»å/ç¾¤æ˜µç¨±/ç”¨æˆ¶æ˜µç¨±ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å›å…¶æœ¬å
         */
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å…¨æ–°ã€æ›´æ™ºæ…§ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ getDisplayNameByOriginalName å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ“šè§’è‰²çš„æœ¬åæˆ–æ›¾ç”¨åï¼Œåœ¨æ•´å€‹æ‡‰ç”¨ä¸­æŸ¥æ‰¾å…¶æ­£ç¢ºçš„ã€ç•¶å‰é¡¯ç¤ºåç¨±ã€‘
         * @param {string} nameIdentifier - è§’è‰²çš„æœ¬å æˆ– å„²å­˜åœ¨èˆŠè³‡æ–™ä¸­çš„æ›¾ç”¨å
         * @returns {string} - è©²è§’è‰²çš„ã€ç•¶å‰ã€‘å‚™è¨»å/ç¾¤æ˜µç¨±/ç”¨æˆ¶æ˜µç¨±ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å›å‚³å…¥çš„è­˜åˆ¥å­—
         */
        function getDisplayNameByOriginalName(nameIdentifier) {
            // 1. å¦‚æœå‚³å…¥çš„æ˜¯ç©ºå€¼ï¼Œç›´æ¥è¿”å›
            if (!nameIdentifier) return '';
        
            // 2. æª¢æŸ¥æ˜¯ä¸æ˜¯ç”¨æˆ¶è‡ªå·±
            if (state.qzoneSettings && nameIdentifier === state.qzoneSettings.nickname) {
                return state.qzoneSettings.nickname;
            }
            
            // 3. ã€ä¸»è¦æŸ¥æ‰¾æ–¹å¼ã€‘: é€šéâ€œæœ¬åâ€ (originalName) æŸ¥æ‰¾ã€‚
            // é€™æ˜¯æœ€æ¨™æº–ã€æœ€å¯é çš„æ–¹å¼ï¼Œé©ç”¨æ–¼æ‰€æœ‰æ–°å‰µå»ºçš„è³‡æ–™ã€‚
            let characterChat = Object.values(state.chats).find(chat => !chat.isGroup && chat.originalName === nameIdentifier);
            if (characterChat) {
                return characterChat.name; // å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›è©²è§’è‰²ã€ç•¶å‰ã€‘çš„å‚™è¨»å
            }
        
            // 4. ã€ç›¸å®¹èˆŠè³‡æ–™ã€‘: å¦‚æœé€šéâ€œæœ¬åâ€æ²’æ‰¾åˆ°ï¼Œå°±å˜—è©¦æŠŠå‚³å…¥çš„åå­—ç•¶ä½œä¸€å€‹ã€èˆŠçš„å‚™è¨»åã€‘å»æ­·å²è¨˜éŒ„è£¡æŸ¥æ‰¾ã€‚
            characterChat = Object.values(state.chats).find(chat => 
                !chat.isGroup && 
                (chat.nameHistory && chat.nameHistory.includes(nameIdentifier))
            );
            if (characterChat) {
                return characterChat.name; // å¦‚æœåœ¨æ­·å²è¨˜éŒ„è£¡æ‰¾åˆ°äº†ï¼ŒåŒæ¨£è¿”å›è©²è§’è‰²ã€ç•¶å‰ã€‘çš„å‚™è¨»å
            }
        
            // 5. ã€æœ€çµ‚å‚™ç”¨æ–¹æ¡ˆã€‘: å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ‰¾ä¸åˆ°ï¼Œèªªæ˜é€™å¯èƒ½æ˜¯ä¸€å€‹éå¸¸èˆŠçš„è³‡æ–™ï¼Œæˆ–è€…è§’è‰²å·²è¢«åˆªé™¤ã€‚
            // æ­¤æ™‚ï¼Œç›´æ¥è¿”å›å„²å­˜åœ¨è©•è«–è£¡çš„é‚£å€‹åå­—ï¼Œè‡³å°‘èƒ½ä¿è­‰æœ‰å…§å®¹é¡¯ç¤ºã€‚
            return nameIdentifier;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å…¨æ–°çš„ã€æ›´æ™ºæ…§çš„ã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ processMentions å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘è™•ç†AIç”Ÿæˆçš„æ–‡æœ¬ï¼Œå°‡ç‰¹æ®Šçš„@é ç•™ä½ç½®æ›¿æ›ç‚ºæ­£ç¢ºçš„é¡¯ç¤ºåç¨±
         * @param {string} text - AIç”Ÿæˆçš„ã€å¯èƒ½åŒ…å« @[[æœ¬å]] é ç•™ä½ç½®çš„åŸå§‹æ–‡æœ¬
         * @param {object|null} chat - ç•¶å‰çš„èŠå¤©ç‰©ä»¶ (å¦‚æœæ˜¯ç¾¤èŠï¼Œå‰‡ç”¨æ–¼æŸ¥æ‰¾ç¾¤æ˜µç¨±)
         * @returns {string} - è™•ç†å®Œæˆå¾Œï¼Œå°ä½¿ç”¨è€…å‹å¥½çš„é¡¯ç¤ºæ–‡æœ¬
         */
        function processMentions(text, chat = null) {
            // å¦‚æœæ–‡æœ¬ç„¡æ•ˆæˆ–ä¸åŒ…å«@æ¨™è¨˜ï¼Œç›´æ¥è¿”å›ä»¥æé«˜æ€§èƒ½
            if (!text || typeof text !== 'string' || !text.includes('@[[')) {
                return text; 
            }
            
            // ä½¿ç”¨è¦å‰‡é‹ç®—å¼çš„å…¨åŸŸåŒ¹é…ï¼Œä¸€æ¬¡æ€§è™•ç†æ‰€æœ‰@æåŠ
            return text.replace(/@\[\[([^\]]+)\]\]/g, (match, originalName) => {
                const trimmedOriginalName = originalName.trim();
                let displayName;
                
                // ã€æ ¸å¿ƒé‚è¼¯ã€‘å¦‚æœæä¾›äº†èŠå¤©ç‰©ä»¶ï¼Œä¸¦ä¸”æ˜¯ç¾¤èŠ
                if (chat && chat.isGroup) {
                    // å°±èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„ã€å¼·å¤§çš„ getDisplayNameInGroup å‡½æ•¸
                    // é€™å€‹å‡½æ•¸æœƒè‡ªå‹•å„ªå…ˆæŸ¥æ‰¾ç¾¤æ˜µç¨±ï¼Œæ‰¾ä¸åˆ°å†ç”¨æœ¬å
                    displayName = getDisplayNameInGroup(chat, trimmedOriginalName);
                } else {
                    // å¦‚æœæ˜¯ç§èŠæˆ–æ²’æœ‰æä¾›èŠå¤©ç‰©ä»¶ï¼Œå°±ä½¿ç”¨å…¨åŸŸæŸ¥æ‰¾å‡½æ•¸
                    displayName = getDisplayNameByOriginalName(trimmedOriginalName);
                }
                
                // è¿”å›è½‰æ›å¾Œçš„ã€å¸¶@çš„æ­£ç¢ºæ˜µç¨±
                return `@${displayName}`;
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€ä¿®æ­£å¾Œã€‘çš„å®Œæ•´å‡½æ•¸ï¼Œæ›¿æ›æ‰æ‚¨ç¾æœ‰çš„ showCustomConfirm å‡½æ•¸ â–¼â–¼â–¼
        
        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
        
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨å‡½æ•¸è¢«èª¿ç”¨æ™‚ï¼Œé‡æ–°ç²å–æœ€æ–°çš„æŒ‰éˆ•å…ƒç´ 
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
        
                cancelBtn.style.display = 'block';
        
                confirmBtn.textContent = options.confirmText || 'ç¢ºå®š';
                cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
        
                if (options.confirmButtonClass) {
                    confirmBtn.classList.add(options.confirmButtonClass);
                } else {
                    // ç¢ºä¿ä¹‹å‰çš„å±éšªæ“ä½œæ¨£å¼è¢«ç§»é™¤
                    confirmBtn.classList.remove('btn-danger');
                }
        
                // ç‚ºæœ€æ–°çš„æŒ‰éˆ•ç¶å®šæœ¬æ¬¡çš„é»æ“Šäº‹ä»¶
                confirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                cancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
function showCustomAlert(title, message) {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        modalBody.innerHTML =`<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;

        // æ ¸å¿ƒä¿®æ­£ï¼šåœ¨å‡½æ•¸è¢«èª¿ç”¨æ™‚ï¼Œé‡æ–°ç²å–æœ€æ–°çš„æŒ‰éˆ•å…ƒç´ 
        const confirmBtn = document.getElementById('custom-modal-confirm');
        const cancelBtn = document.getElementById('custom-modal-cancel');

        cancelBtn.style.display = 'none';
        confirmBtn.textContent = 'å¥½çš„';

        confirmBtn.onclick = () => {
            cancelBtn.style.display = 'block'; 
            confirmBtn.textContent = 'ç¢ºå®š';
            resolve(true); 
            hideCustomModal();
        };
        showCustomModal();
    });
}
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€ä¿®æ­£å¾Œã€‘çš„å®Œæ•´å‡½æ•¸ï¼Œæ›¿æ›æ‰æ‚¨ç¾æœ‰çš„ showCustomPrompt å‡½æ•¸ â–¼â–¼â–¼
        
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                const inputId = 'custom-prompt-input';
                
                const inputHtml = type === 'textarea' 
                    ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                    : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
                
                modalBody.innerHTML = extraHtml + inputHtml;
                const input = document.getElementById(inputId);
        
                modalBody.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const templateStr = btn.dataset.template;
                        if (templateStr) {
                            try {
                                const templateObj = JSON.parse(templateStr);
                                input.value = JSON.stringify(templateObj, null, 2);
                                input.focus();
                            } catch(e) { console.error("è§£ææ ¼å¼ç¯„æœ¬å¤±æ•—:", e); }
                        }
                    });
                });
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨å‡½æ•¸è¢«èª¿ç”¨æ™‚ï¼Œé‡æ–°ç²å–æœ€æ–°çš„æŒ‰éˆ•å…ƒç´ 
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
                
                // ç‚ºæœ€æ–°çš„æŒ‰éˆ•ç¶å®šæœ¬æ¬¡çš„é»æ“Šäº‹ä»¶
                confirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                cancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€å…¨æ–°ã€‘çš„å‡½æ•¸ä»£ç¢¼é»è²¼åˆ° showCustomPrompt å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€æ›´å¥å£¯çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ showChoiceModal â–¼â–¼â–¼
        /**
         * ã€å·²ä¿®å¾©ã€‘é¡¯ç¤ºä¸€å€‹åŒ…å«å¤šå€‹é¸é …çš„æ“ä½œåŠŸèƒ½è¡¨æ¨¡æ…‹æ¡†
         * @param {string} title - æ¨¡æ…‹æ¡†çš„æ¨™é¡Œ
         * @param {Array<object>} options - æŒ‰éˆ•é¸é …é™£åˆ—, e.g., [{ text: 'æŒ‰éˆ•æ–‡å­—', value: 'è¿”å›å€¼' }]
         * @returns {Promise<string|null>} - è¿”å›ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•çš„valueï¼Œå¦‚æœå–æ¶ˆå‰‡è¿”å›null
         */
        function showChoiceModal(title, options) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal-overlay');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalBody = document.getElementById('custom-modal-body');
                const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        
                // 1. è¨­ç½®æ¨™é¡Œå’Œæ¸…ç©ºå…§å®¹å€
                modalTitle.textContent = title;
                modalBody.innerHTML = ''; 
                
                // 2. å‹•æ…‹å‰µå»ºé¸é …æŒ‰éˆ•
                modalFooter.innerHTML = ''; 
                modalFooter.style.flexDirection = 'column';
        
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.onclick = () => {
                        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘ä¸å†èª¿ç”¨ hideCustomModalï¼Œè€Œæ˜¯ç›´æ¥æ§åˆ¶
                        modal.classList.remove('visible');
                        resolve(option.value);
                    };
                    modalFooter.appendChild(button);
                });
        
                // 3. æ·»åŠ ä¸€å€‹æ¨™æº–çš„å–æ¶ˆæŒ‰éˆ•
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.style.marginTop = '8px';
                cancelButton.style.borderRadius = '8px';
                cancelButton.style.backgroundColor = '#f0f0f0';
                cancelButton.onclick = () => {
                    modal.classList.remove('visible');
                    resolve(null); // ç”¨æˆ¶å–æ¶ˆï¼Œè¿”å› null
                };
                modalFooter.appendChild(cancelButton);
        
                // 4. é¡¯ç¤ºæ¨¡æ…‹æ¡†
                modal.classList.add('visible');
        
            }).finally(() => {
                // 5. ã€ã€ã€é€™å°±æ˜¯æœ€é—œéµçš„ä¿®å¾©ï¼ã€‘ã€‘ã€‘
                // ç„¡è«–ä½¿ç”¨è€…æ˜¯é¸æ“‡äº†é¸é …é‚„æ˜¯å–æ¶ˆï¼Œæœ€å¾Œéƒ½ã€å¿…é ˆã€‘å°‡æ¨¡æ…‹æ¡†çš„é è…³æ¢å¾©ç‚ºåŸå§‹çš„ã€åŠŸèƒ½å®Œæ•´çš„ç‹€æ…‹ã€‚
                const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        
                modalFooter.style.flexDirection = 'row'; // æ¢å¾©æ°´æº–ä½ˆå±€
                // é‡æ–°å‰µå»ºåŸå§‹çš„â€œå–æ¶ˆâ€å’Œâ€œç¢ºå®šâ€æŒ‰éˆ•
                modalFooter.innerHTML = `
                    <button id="custom-modal-cancel">å–æ¶ˆ</button>
                    <button id="custom-modal-confirm" class="confirm-btn">ç¢ºå®š</button>
                `;
        
                // ã€é‡è¦ã€‘ç‚ºæ–°å‰µå»ºçš„æŒ‰éˆ•é‡æ–°ç¶å®šå®ƒå€‘æœ€åŸºæœ¬çš„é»˜èªäº‹ä»¶ï¼
                document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                // æ³¨æ„ï¼šæˆ‘å€‘ä¸éœ€è¦ç‚ºâ€œç¢ºå®šâ€æŒ‰éˆ•ç¶å®šé è¨­äº‹ä»¶ï¼Œå› ç‚º showCustomConfirm å’Œ showCustomPrompt 
                // æ¯æ¬¡èª¿ç”¨æ™‚éƒ½æœƒç‚ºå®ƒå‹•æ…‹ç¹«çµæ–°çš„ onclick äº‹ä»¶ï¼Œé€™æ­£æ˜¯æˆ‘å€‘æƒ³è¦çš„è¡Œç‚ºã€‚
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ è«‹å°‡é€™å€‹ã€å…¨æ–°ã€‘çš„å‡½æ•¸é»è²¼åˆ° showChoiceModal å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘ç²å–æ­Œè©å…§å®¹ï¼ˆæ”¯æ´æª”å’Œé»è²¼ï¼Œä¸¦ä¿®å¾©é»è²¼æ ¼å¼ï¼‰
         * @returns {Promise<string|null>} è¿”å›æ­Œè©æ–‡æœ¬å­—ä¸²ï¼Œå¦‚æœä½¿ç”¨è€…å–æ¶ˆå‰‡è¿”å›null
         */
        async function getLrcContent() {
            // 1. å½ˆå‡ºé¸æ“‡æ¡†
            const choice = await showChoiceModal('é¸æ“‡æ­Œè©å°å…¥æ–¹å¼', [
                { text: 'ğŸ“ å¾æœ¬åœ°æª” (.lrc)', value: 'file' },
                { text: 'ğŸ“‹ ç›´æ¥é»è²¼æ­Œè©æ–‡æœ¬', value: 'paste' }
            ]);
        
            // 2. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡åŸ·è¡Œä¸åŒæ“ä½œ
            if (choice === 'file') {
                // ç”¨æˆ¶é¸æ“‡æª”ï¼šé€™éƒ¨åˆ†é‚è¼¯ä¸è®Šï¼Œå®ƒå·¥ä½œæ­£å¸¸
                return new Promise(resolve => {
                    const lrcInput = document.getElementById('lrc-upload-input');
                    const lrcChangeHandler = (e) => {
                        const lrcFile = e.target.files[0];
                        if (lrcFile) {
                            const reader = new FileReader();
                            reader.onload = (readEvent) => resolve(readEvent.target.result);
                            reader.onerror = () => resolve(""); // å‡ºéŒ¯æ™‚è¿”å›ç©ºå­—ä¸²
                            reader.readAsText(lrcFile);
                        } else {
                            resolve(null); // ç”¨æˆ¶é—œé–‰äº†æª”é¸æ“‡æ¡†
                        }
                        lrcInput.removeEventListener('change', lrcChangeHandler);
                        lrcInput.value = ''; // é‡ç½®inputï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒåæª”
                    };
                    lrcInput.addEventListener('change', lrcChangeHandler, { once: true });
                    lrcInput.click();
                });
            } else if (choice === 'paste') {
                // ç”¨æˆ¶é¸æ“‡é»è²¼ï¼šå½ˆå‡ºæ–‡æœ¬è¼¸å…¥æ¡†
                const pastedText = await showCustomPrompt(
                    'é»è²¼æ­Œè©',
                    'è«‹åœ¨æ­¤è™•é»è²¼å®Œæ•´çš„LRCæ ¼å¼æ­Œè©...',
                    '',
                    'textarea' // ä½¿ç”¨å¤šè¡Œæ–‡å­—æ–¹å¡Š
                );
                
                // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ â˜…â˜…â˜… ---
                if (pastedText) {
                    // åœ¨è§£æä¹‹å‰ï¼Œè‡ªå‹•ç‚ºæ¯å€‹æ™‚é–“æˆ³è¨˜å‰æ·»åŠ åˆ†è¡Œç¬¦è™Ÿ
                    // é€™æœƒä¿®å¾©å–®è¡Œé»è²¼çš„å•é¡Œ
                    const formattedText = pastedText.replace(/\[/g, '\n[').trim();
                    return formattedText;
                }
                return pastedText; // å¦‚æœç”¨æˆ¶å–æ¶ˆï¼Œé€™è£¡æœƒè¿”å› null
                // --- â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜… ---
        
            } else {
                // ç”¨æˆ¶é»æ“Šäº†â€œå–æ¶ˆâ€
                return null;
            }
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
                // ===================================================================
                // 2. è³‡æ–™åº«çµæ§‹å®šç¾©
                // ===================================================================
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V30 ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ db.version(...) ä»£ç¢¼å¡Š â–¼â–¼â–¼
        db.version(39).stores({ 
            doubanPosts: '++id, timestamp',
           chats: '&id, isGroup, groupId, isPinned, memos, diary, appUsageLog, lastIntelligentSummaryTimestamp',
           apiConfig: '&id, minimaxGroupId, minimaxApiKey',
            globalSettings: '&id', 
            userStickers: '&id, url, name, categoryId',
            worldBooks: '&id, name, categoryId',
            worldBookCategories: '++id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            qzoneSettings: '&id',
            qzonePosts: '++id, timestamp, authorId',
            qzoneAlbums: '++id, name, createdAt',
            qzonePhotos: '++id, albumId',
            favorites: '++id, type, timestamp, originalTimestamp',
            qzoneGroups: '++id, name',
            memories: '++id, chatId, timestamp, type, targetDate',
            callRecords: '++id, chatId, timestamp, customName',
            shoppingProducts: '++id, name, description',
            shoppingCategories: '++id, name',
            apiPresets: '++id, name',
            renderingRules: '++id, name, chatId',
            appearancePresets: '++id, name, type',
            stickerCategories: '++id, name',
            customAvatarFrames: '++id, name',
            presets: '&id, name, categoryId', // æ–°å¢ï¼šé è¨­ä¸»è¡¨
            presetCategories: '++id, name',
    readingLibrary: '++id, title, lastOpened', // æ–°å¢ï¼šæ›¸ç±åº«
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºNPCè¡¨æ·»åŠ å¾Œè‡ºæ´»å‹•ã€å†·å»æ™‚é–“å’Œæœ€å¾Œè¡Œå‹•æ™‚é–“æˆ³è¨˜æ¬„ä½
            npcs: '++id, name, enableBackgroundActivity, actionCooldownMinutes, lastActionTimestamp'  
        }).upgrade(tx => {
            // é€™å€‹å‡ç´šå‡½æ•¸æœƒè‡ªå‹•è™•ç†è³‡æ–™ç§»è½‰
            return tx.table('worldBooks').toCollection().modify(book => {
                // ç¢ºä¿ content æ¬„ä½æ˜¯é™£åˆ—
                if (typeof book.content === 'string' && book.content.trim() !== '') {
                    book.content = [{
                        keys: [],
                        comment: 'å¾èˆŠç‰ˆæœ¬é·ç§»çš„æ¢ç›®',
                        content: book.content
                    }];
                } else if (!Array.isArray(book.content)) {
                    book.content = [];
                }

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºæ‰€æœ‰æ¢ç›®æ·»åŠ  enabled å±¬æ€§ï¼Œé è¨­ç‚º true
                book.content.forEach(entry => {
                    if (typeof entry.enabled === 'undefined') {
                        entry.enabled = true;
                    }
                });
            });
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
window.db = db;        
                // ===================================================================
                // 3. æ‰€æœ‰åŠŸèƒ½å‡½å¼å®šç¾©
                // ===================================================================
        
                function showScreen(screenId) {
                    if (screenId === 'chat-list-screen') {
                        window.renderChatListProxy(); 
                        switchToChatListView('messages-view');
                    }
                    if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
                    if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
                    if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
                    if (screenId === 'x-social-screen') window.renderXSocialScreenProxy();
                     if (screenId === 'douban-screen') renderDoubanScreen();
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screenToShow = document.getElementById(screenId);
                    if (screenToShow) screenToShow.classList.add('active');
                    if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
                    if (screenId === 'font-settings-screen') {
            loadFontPresetsDropdown(); // <-- æ–°å¢é€™ä¸€è¡Œ
                        document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                        applyCustomFont(state.globalSettings.fontUrl || '', true);
                    }
                }
                window.updateListenTogetherIconProxy = () => {};
        
                function switchToChatListView(viewId) {
                    const chatListScreen = document.getElementById('chat-list-screen');
                    const views = {
                        'messages-view': document.getElementById('messages-view'),
                        'qzone-screen': document.getElementById('qzone-screen'),
                        'favorites-view': document.getElementById('favorites-view'),
                'memories-view': document.getElementById('memories-view'),
               'npc-list-view': document.getElementById('npc-list-view')
            };
                    const mainHeader = document.getElementById('main-chat-list-header');
                    const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // ç²å–ä¸»å·¡è¦½åˆ—
        
                    if (isFavoritesSelectionMode) {
                        document.getElementById('favorites-edit-btn').click(); 
                    }
        
                    // éš±è—æ‰€æœ‰è¦–åœ–
                    Object.values(views).forEach(v => v.classList.remove('active'));
                    // é¡¯ç¤ºç›®æ¨™è¦–åœ–
                    if (views[viewId]) {
                        views[viewId].classList.add('active');
                    }
        
                    // æ›´æ–°åº•éƒ¨å·¡è¦½åˆ—é«˜äº®
                    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.view === viewId);
                    });
                    
                    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡çµ±ä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„é¡¯éš± â–¼â–¼â–¼
                    if (viewId === 'messages-view') {
                        mainHeader.style.display = 'flex';
                        mainBottomNav.style.display = 'flex';
                    } else {
                        mainHeader.style.display = 'none';
                        mainBottomNav.style.display = 'none';
                    }
                    // â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–²
        
            if (viewId !== 'memories-view') {
                activeCountdownTimers.forEach(timerId => clearInterval(timerId));
                activeCountdownTimers = [];
            }
        
                    // æ ¹æ“šè¦–åœ–IDåŸ·è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é‚è¼¯
                    switch (viewId) {
                        case 'qzone-screen':
                            views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                            updateUnreadIndicator(0);
                            renderQzoneScreen();
                            renderQzonePosts();
                            break;
                        case 'favorites-view':
                            views['favorites-view'].style.backgroundColor = '#f9f9f9';
                            renderFavoritesScreen();
                            break;
                        case 'messages-view':
                            // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ è¿”å›æ¶ˆæ¯æ¸…å–®æ™‚è¦åŸ·è¡Œçš„é‚è¼¯
                            break;
        case 'npc-list-view':
            renderNpcListScreen(); // åˆ‡æ›åˆ°NPCè¦–åœ–æ™‚ï¼Œæ¸²æŸ“åˆ—è¡¨
            break;
                    }
                }
    // Xç¤¾äº¤é é¢æ¸²æŸ“å‡½æ•¸
      function renderXSocialScreen() {
        // æš«æ™‚ç‚ºç©ºï¼Œå¾ŒçºŒæ·»åŠ Xç¤¾äº¤é é¢çš„æ¸²æŸ“é‚è¼¯
        console.log("æ¸²æŸ“Xç¤¾äº¤é é¢");
      }
      window.renderXSocialScreenProxy = renderXSocialScreen;
                
                function renderQzoneScreen() {
                    if (state && state.qzoneSettings) {
                        const settings = state.qzoneSettings;
                        document.getElementById('qzone-nickname').textContent = settings.nickname;
                        document.getElementById('qzone-avatar-img').src = settings.avatar;
                        document.getElementById('qzone-banner-img').src = settings.banner;
                    }
                }
                window.renderQzoneScreenProxy = renderQzoneScreen;
        
                async function saveQzoneSettings() {
                    if (db && state.qzoneSettings) {
                        await db.qzoneSettings.put(state.qzoneSettings);
                    }
                }
        
                function formatPostTimestamp(timestamp) {
                    if (!timestamp) return '';
                    const now = new Date();
                    const date = new Date(timestamp);
                    const diffSeconds = Math.floor((now - date) / 1000);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60);
                    if (diffMinutes < 1) return 'å‰›å‰›';
                    if (diffMinutes < 60) return `${diffMinutes}åˆ†é˜å‰`;
                    if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    if (now.getFullYear() === year) {
                        return `${month}-${day} ${hours}:${minutes}`;
                    } else {
                        return `${year}-${month}-${day} ${hours}:${minutes}`;
                    }
                }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™ä¸‰å€‹å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–° | æ€§èƒ½æ ¸å¿ƒ | å·²é›†æˆMarkdownã€‘æ ¹æ“šå¸–å­è³‡æ–™ï¼Œå‰µå»ºæˆ–æ›´æ–°å–®å€‹å¸–å­çš„HTMLå…ƒç´ 
         * @param {object} post - å–®å€‹å¸–å­çš„è³‡æ–™ç‰©ä»¶
         * @returns {HTMLElement} - å‰µå»ºæˆ–æ›´æ–°å¾Œçš„å¸–å­å®¹å™¨DOMå…ƒç´ 
         */
        function createOrUpdatePostElement(post) {
            const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
            const isUpdating = !!existingPostContainer;
            
            const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
            if (!isUpdating) {
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;
            }
        
            const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
            if (!isUpdating) {
                postEl.className = 'qzone-post-item';
            }
        
            let authorAvatar = '', authorNickname = '', commentAvatar = state.qzoneSettings.avatar; 
        
            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                const authorChat = state.chats[post.authorId];
                authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                authorNickname = authorChat.name;
            } else {
                authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
                authorAvatar = defaultAvatar;
            }
        
function renderOriginalPostContent(targetPost) {
            let innerContentHtml = '';
            const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';

            if (targetPost.type === 'shuoshuo') {
                innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
            } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {
                // ã€æ ¸å¿ƒä¿®å¾©ã€‘ç›´æ¥ä½¿ç”¨ targetPost.imageUrl ä¾†é¡¯ç¤ºä½¿ç”¨è€…ä¸Šå‚³çš„åœ–ç‰‡
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
            } else if (targetPost.type === 'text_image') {
                const postImageUrl = state.globalSettings.enableAiDrawing && targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
            }
            return innerContentHtml;
        }
        
            let mainContentHtml;
        
            if (post.type === 'repost') {
                // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                const repostCommentHtml = post.repostComment ? `<div class="post-content">${parseMarkdown(post.repostComment).replace(/\n/g, '<br>')}</div>` : '';
                let originalAuthorAvatar = defaultAvatar;
                let originalAuthorNickname = 'åŸä½œè€…';
                if (post.originalPost.authorId === 'user') {
                    originalAuthorAvatar = state.qzoneSettings.avatar;
                    originalAuthorNickname = state.qzoneSettings.nickname;
                } else {
                    const originalAuthorChat = state.chats[post.originalPost.authorId];
                    if (originalAuthorChat) {
                        originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
                    }
                    originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
                }
                mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
            } else {
                mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
            }
        
            let likesHtml = '';
            if (post.likes && post.likes.length > 0) {
                const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('ã€');
                likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} è¦ºå¾—å¾ˆè´Š</span></div>`;
            }
        
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment, index) => {
                    if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                        const commenterOriginalName = comment.commenterName;
                        const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                        
                        let innerCommentContent;
                        if (STICKER_REGEX.test(comment.text)) {
                            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                        } else {
                            // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                            innerCommentContent = parseMarkdown(comment.text);
                        }
        
                        let commentLineHtml = '';
                        if (comment.replyTo) {
                            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> å›å¾© <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                        } else {
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                        }
                        
                        commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                                         </div>`;
        
                    } else {
                        // â–¼â–¼â–¼ å·²ç‚ºèˆŠæ ¼å¼è©•è«–æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                        commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${parseMarkdown(String(comment))}</span>
                                         </div>`;
                    }
                });
                commentsHtml += '</div>';
            }
        
            const userOriginalName = state.qzoneSettings.nickname;
            const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
            const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id);
        
            let repostIconHtml = '';
            if (post.type !== 'repost') {
                repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
            }
            
            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">â€¦</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="å‹å–„çš„è©•è«–æ˜¯äº¤æµçš„èµ·é»">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">ç™¼é€</button>
                </div>
            `;
        
            if (!isUpdating) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>åˆªé™¤</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
            }
            
            return postContainer;
        }
        
        /**
         * ã€å…¨æ–° | å¢é‡æ›´æ–°å‡½æ•¸ã€‘åªæ›´æ–°å–®å€‹å¸–å­ï¼Œè€Œä¸æ˜¯é‡ç¹ªæ•´å€‹åˆ—è¡¨
         * @param {number} postId - éœ€è¦æ›´æ–°çš„å¸–å­çš„ID
         */
        async function updateSinglePostInDOM(postId) {
            const postData = await db.qzonePosts.get(postId);
            if (!postData) {
                // å¦‚æœå¸–å­è¢«åˆªäº†ï¼Œå°±å¾DOMä¸­ç§»é™¤
                const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
                if (postContainer) postContainer.remove();
                return;
            }
        
            // æ›´æ–°ç·©å­˜
            const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
            if (cacheIndex > -1) qzonePostsCache[cacheIndex] = postData;
            
            // æ›´æ–°æ”¶è—ç‹€æ…‹
            const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // èª¿ç”¨æ ¸å¿ƒå‡½æ•¸ä¾†æ›´æ–°DOM
            createOrUpdatePostElement(postData);
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å‡½æ•¸é»è²¼åˆ° formatPostTimestamp å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            const minutes = Math.floor(seconds / 60);
            if (minutes < 2) return 'å‰›å‰›';
            if (minutes < 60) return `${minutes}åˆ†é˜å‰`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}å°æ™‚å‰`;
            const days = Math.floor(hours / 24);
            return `${days}å¤©å‰`;
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å…©å€‹å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–° | æ€§èƒ½æ ¸å¿ƒã€‘æ ¹æ“šå¸–å­è³‡æ–™ï¼Œå‰µå»ºæˆ–æ›´æ–°å–®å€‹å¸–å­çš„HTMLå…ƒç´ 
         * @param {object} post - å–®å€‹å¸–å­çš„è³‡æ–™ç‰©ä»¶
         * @returns {HTMLElement} - å‰µå»ºæˆ–æ›´æ–°å¾Œçš„å¸–å­å®¹å™¨DOMå…ƒç´ 
         */
async function createOrUpdatePostElement(post) { // <-- æ ¸å¿ƒä¿®æ”¹1ï¼šå°‡å‡½å¼å®£å‘Šç‚º async
            const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
            const isUpdating = !!existingPostContainer;
            
            const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
            if (!isUpdating) {
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;
            }
        
            const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
            if (!isUpdating) {
                postEl.className = 'qzone-post-item';
            }
        
            let authorAvatar = '', authorNickname = '', commentAvatar = state.qzoneSettings.avatar; 
        
            // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šé‡æ§‹ä½œè€…è³‡è¨Šç²å–é‚è¼¯ â–¼â–¼â–¼ ---
            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                const authorChat = state.chats[post.authorId];
                authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                authorNickname = authorChat.name;
            } else if (String(post.authorId).startsWith('npc_')) {
                // å¦‚æœä½œè€…æ˜¯NPCï¼Œæˆ‘å€‘å¾NPCè³‡æ–™åº«ä¸­æŸ¥æ‰¾è³‡è¨Š
                const npcId = parseInt(String(post.authorId).replace('npc_', ''));
                if (!isNaN(npcId)) {
                    const npc = await db.npcs.get(npcId);
                    if (npc) {
                        authorAvatar = npc.avatar || defaultGroupMemberAvatar;
                        authorNickname = npc.name;
                    } else {
                        authorNickname = post.authorOriginalName || 'æœªçŸ¥NPC';
                        authorAvatar = defaultGroupMemberAvatar;
                    }
                }
            } else {
                // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå‰‡ä½¿ç”¨åŸå§‹åç¨±å’Œé»˜èªé ­åƒä½œç‚ºä¿åº•
                authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
                authorAvatar = defaultAvatar;
            }
            // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---
        
function renderOriginalPostContent(targetPost) {
            let innerContentHtml = '';
            const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';

            if (targetPost.type === 'shuoshuo') {
                innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
            } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {
                // ã€æ ¸å¿ƒä¿®å¾© â‘ ã€‘ç›´æ¥ä½¿ç”¨ targetPost.imageUrl é¡¯ç¤ºæ‚¨ä¸Šå‚³çš„åœ–ç‰‡
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
            } else if (targetPost.type === 'text_image') {
                // ï¼ˆé€™éƒ¨åˆ†é‚è¼¯ä¿æŒä¸è®Šï¼Œç”¨æ–¼AIç”Ÿæˆçš„æ–‡å­—åœ–ï¼‰
                const postImageUrl = state.globalSettings.enableAiDrawing && targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
            }
            return innerContentHtml;
        }
        
            let mainContentHtml;
        
            if (post.type === 'repost') {
                const repostCommentHtml = post.repostComment ? `<div class="post-content">${post.repostComment.replace(/\n/g, '<br>')}</div>` : '';
                let originalAuthorAvatar = defaultAvatar;
                let originalAuthorNickname = 'åŸä½œè€…';
                if (post.originalPost.authorId === 'user') {
                    originalAuthorAvatar = state.qzoneSettings.avatar;
                    originalAuthorNickname = state.qzoneSettings.nickname;
                } else {
                    const originalAuthorChat = state.chats[post.originalPost.authorId];
                    if (originalAuthorChat) {
                        originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
                    }
                    originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
                }
                mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
            } else {
                mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
            }
        
            let likesHtml = '';
            if (post.likes && post.likes.length > 0) {
                const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('ã€');
                likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} è¦ºå¾—å¾ˆè´Š</span></div>`;
            }
        
        // â–¼â–¼â–¼ åœ¨ createOrUpdatePostElement å‡½æ•¸ä¸­ï¼Œæ‰¾åˆ° let commentsHtml = ''; ä¸¦ç”¨ä¸‹é¢é€™æ•´å¡Šæ›¿æ› â–¼â–¼â–¼
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment, index) => {
                    // ã€æ ¸å¿ƒä¿®å¾©1ã€‘æª¢æŸ¥æ˜¯å¦æ˜¯æ–°çš„ã€åŒ…å« commenterName çš„ç‰©ä»¶æ ¼å¼
                    if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                        const commenterOriginalName = comment.commenterName;
                        // ã€æ ¸å¿ƒä¿®å¾©2ã€‘ä½¿ç”¨æˆ‘å€‘å…¨æ–°çš„å‡½æ•¸ä¾†å³æ™‚æŸ¥æ‰¾æœ€æ–°çš„é¡¯ç¤ºåç¨±ï¼
                        const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                        
                        let innerCommentContent;
                        if (STICKER_REGEX.test(comment.text)) {
                            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                        } else {
                            innerCommentContent = parseMarkdown(comment.text);
                        }
        
                        let commentLineHtml = '';
                        // ã€æ ¸å¿ƒä¿®å¾©3ã€‘å›å¾©çš„ç›®æ¨™ä¹Ÿä½¿ç”¨æ–°å‡½æ•¸ä¾†æŸ¥æ‰¾åå­—
                        if (comment.replyTo) {
                            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> å›å¾© <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                        } else {
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                        }
                        
                        commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                                         </div>`;
        
                    } else {
                        // ã€ç›¸å®¹èˆŠè³‡æ–™ã€‘å¦‚æœé‚„æ˜¯èˆŠçš„å­—ä¸²æ ¼å¼ï¼Œå°±åŸæ¨£é¡¯ç¤º
                        commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${String(comment)}</span>
                                         </div>`;
                    }
                });
                commentsHtml += '</div>';
            }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
            const userOriginalName = state.qzoneSettings.nickname;
            const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
            const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id); // å¾ state è®€å–
        
            let repostIconHtml = '';
            if (post.type !== 'repost') {
                repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
            }
            
            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">â€¦</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="å‹å–„çš„è©•è«–æ˜¯äº¤æµçš„èµ·é»">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">ç™¼é€</button>
                </div>
            `;
        
            if (!isUpdating) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>åˆªé™¤</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
            }
            
            return postContainer;
        }
        
        /**
         * ã€å…¨æ–° | å¢é‡æ›´æ–°å‡½æ•¸ã€‘åªæ›´æ–°å–®å€‹å¸–å­ï¼Œè€Œä¸æ˜¯é‡ç¹ªæ•´å€‹åˆ—è¡¨
         * @param {number} postId - éœ€è¦æ›´æ–°çš„å¸–å­çš„ID
         */
        async function updateSinglePostInDOM(postId) {
            const postData = await db.qzonePosts.get(postId);
            if (!postData) {
                // å¦‚æœå¸–å­è¢«åˆªäº†ï¼Œå°±å¾DOMä¸­ç§»é™¤
                const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
                if (postContainer) {
                    postContainer.remove();
                }
                return;
            }
        
            // æ›´æ–°ç·©å­˜
            const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
            if (cacheIndex > -1) {
                qzonePostsCache[cacheIndex] = postData;
            }
            
            // æ›´æ–°æ”¶è—ç‹€æ…‹
            const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // èª¿ç”¨æ ¸å¿ƒå‡½æ•¸ä¾†æ›´æ–°DOM
           await createOrUpdatePostElement(postData);
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€ç„¡é™æ»¾å‹•ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ renderQzonePosts å‡½æ•¸ â–¼â–¼â–¼
async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [postsFromDb, favorites] = await Promise.all([
        db.qzonePosts.orderBy('timestamp').reverse().filter(post => !post.isDeleted).toArray(),
        db.favorites.where('type').equals('qzone_post').toArray()
    ]);
    qzonePostsCache = postsFromDb;
    state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));

    postsListEl.innerHTML = '';
    qzonePostsRenderCount = 0; // é‡ç½®è¨ˆæ•¸å™¨

    if (qzonePostsCache.length === 0) {
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">é€™è£¡ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«ä¾†ç™¼ä½ˆç¬¬ä¸€æ¢èªªèªªå§ï¼</p>';
        return;
    }

    // åˆå§‹è¼‰å…¥ç¬¬ä¸€é 
    loadMoreQzonePosts();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        
// â–¼â–¼â–¼ ã€ç„¡é™æ»¾å‹•ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ loadMoreQzonePosts å‡½æ•¸ â–¼â–¼â–¼
async function loadMoreQzonePosts() {
    if (isLoadingMorePosts) return;
    isLoadingMorePosts = true;

    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) {
        isLoadingMorePosts = false;
        return;
    }

    showLoader(postsListEl, 'bottom'); // åœ¨åº•éƒ¨é¡¯ç¤ºè¼‰å…¥å‹•ç•«

    // é¡æ¯”ç¶²è·¯å»¶é²
    setTimeout(async () => {
        hideLoader(postsListEl); // å…ˆç§»é™¤è¼‰å…¥å‹•ç•«

        const nextSliceStart = qzonePostsRenderCount;
        const nextSliceEnd = qzonePostsRenderCount + QZONE_RENDER_WINDOW;
        const postsToAppend = qzonePostsCache.slice(nextSliceStart, nextSliceEnd);

        const fragment = document.createDocumentFragment();
for (const post of postsToAppend) {
                    const postElement = await createOrUpdatePostElement(post); // <-- æ ¸å¿ƒä¿®æ”¹4ï¼šåœ¨é€™è£¡ä½¿ç”¨ await
                    fragment.appendChild(postElement);
                }
        postsListEl.appendChild(fragment);

        qzonePostsRenderCount += postsToAppend.length;

        isLoadingMorePosts = false;
    }, 500);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‹•æ…‹è©•è«–å€è¡¨æƒ…é¢æ¿ç®¡ç†å‡½æ•¸ â–¼â–¼â–¼
        
        function openQzoneStickerPanel(postId, buttonElement) {
            const panel = qzoneStickerPanelState.panelEl;
            const grid = qzoneStickerPanelState.gridEl;
        
            // 1. å¡«å……è¡¨æƒ… (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
            grid.innerHTML = '';
            if (state.userStickers.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">è«‹å…ˆåœ¨èŠå¤©ä»‹é¢çš„<br>è¡¨æƒ…é¢æ¿ä¸­æ·»åŠ è¡¨æƒ…åŒ…</p>';
            } else {
                state.userStickers.forEach(sticker => {
                    const item = document.createElement('div');
                    item.className = 'sticker-item';
                    item.style.backgroundImage = `url(${sticker.url})`;
                    item.title = sticker.name;
                    grid.appendChild(item);
                });
            }
        
            // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ­£ï¼šæ™ºæ…§å®šä½é‚è¼¯ â–¼â–¼â–¼ ---
        
            // 2. ç²å–å¿…è¦çš„å°ºå¯¸å’Œä½ç½®è³‡è¨Š
            const btnRect = buttonElement.getBoundingClientRect();
            const phoneScreenRect = document.getElementById('phone-screen').getBoundingClientRect();
            
            panel.style.display = 'flex'; // å…ˆé¡¯ç¤ºå‡ºä¾†æ‰èƒ½ç²å–å°ºå¯¸
            const panelRect = panel.getBoundingClientRect();
            const panelHeight = panelRect.height;
            const panelWidth = panelRect.width;
        
            // 3. è¨ˆç®—å‚ç›´ä½ç½® (ä¿æŒä¸è®Šï¼Œç¸½æ˜¯å‡ºç¾åœ¨æŒ‰éˆ•ä¸Šæ–¹)
            panel.style.top = `${btnRect.top - panelHeight - 5 - phoneScreenRect.top}px`;
        
            // 4. è¨ˆç®—ä¸¦åˆ¤æ–·æ°´æº–ä½ç½®
            const desiredLeftPosition = btnRect.left - phoneScreenRect.left;
        
            // å¦‚æœé¢æ¿çš„å·¦å´ä½ç½® + è‡ªèº«å¯¬åº¦ > æ‰‹æ©Ÿè¢å¹•å¯¬åº¦ï¼Œèªªæ˜æœƒè¶…å‡º
            if (desiredLeftPosition + panelWidth > phoneScreenRect.width) {
                // å¦‚æœæœƒè¶…å‡ºï¼Œå‰‡æ”¹ç‚ºè²¼è‘—è¢å¹•å³å´é‚Šç·£é¡¯ç¤º (ç•™5pxé‚Šè·)
                panel.style.left = 'auto';
                panel.style.right = '5px';
            } else {
                // å¦‚æœä¸æœƒè¶…å‡ºï¼Œå‰‡æ­£å¸¸å°é½ŠæŒ‰éˆ•å·¦å´
                panel.style.left = `${desiredLeftPosition}px`;
                panel.style.right = 'auto';
            }
            
            // --- â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–² ---
        
            // 5. æ›´æ–°ç‹€æ…‹ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
            qzoneStickerPanelState.isOpen = true;
            qzoneStickerPanelState.activePostId = postId;
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°å‡½æ•¸ã€‘é»è²¼åˆ° openQzoneStickerPanel å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘é—œé–‰å‹•æ…‹è©•è«–å€çš„è¡¨æƒ…é¢æ¿
         */
        function closeQzoneStickerPanel() {
            // æª¢æŸ¥ç‹€æ…‹ï¼Œç¢ºä¿é¢æ¿æ˜¯æ‰“é–‹çš„
            if (qzoneStickerPanelState.isOpen) {
                // éš±è—é¢æ¿DOMå…ƒç´ 
                qzoneStickerPanelState.panelEl.style.display = 'none';
                
                // é‡ç½®ç‹€æ…‹è®Šæ•¸
                qzoneStickerPanelState.isOpen = false;
                qzoneStickerPanelState.activePostId = null;
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æ–°ä»£ç¢¼å¡Šã€‘æ›¿æ›èˆŠçš„ sendQzoneStickerComment å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°å‡ç´šç‰ˆã€‘ç™¼é€å‹•æ…‹è¡¨æƒ…è©•è«–ï¼Œä¸¦å‘ŠçŸ¥AIå…¶å«ç¾©
         * @param {number} postId - å¸–å­ID
         * @param {object} sticker - å®Œæ•´çš„è¡¨æƒ…å°è±¡ { url, name }
         */
        async function sendQzoneStickerComment(postId, sticker) {
            if (!sticker || !sticker.url) return;
        
            const post = await db.qzonePosts.get(postId);
            if (!post) {
                console.error("sendQzoneStickerComment: æ‰¾ä¸åˆ°å¸–å­:", postId);
                return;
            }
        
            if (!post.comments) {
                post.comments = [];
            }
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ç‚ºæ‚¨ç™¼é€çš„è¡¨æƒ…ä¹Ÿæ·»åŠ  meaning æ¬„ä½ â–¼â–¼â–¼
            const newComment = {
                commenterName: state.qzoneSettings.nickname,
                text: sticker.url,
                meaning: sticker.name, // ä¿å­˜è¡¨æƒ…çš„å«ç¾©
                timestamp: Date.now()
            };
            // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
            post.comments.push(newComment);
        
            await db.qzonePosts.update(postId, { comments: post.comments });
        
            closeQzoneStickerPanel();
            await renderQzonePosts();
            
            const postSummary = (post.publicText || post.content || `[åœ–ç‰‡å‹•æ…‹]`).substring(0, 30);
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šé€šçŸ¥AIæ™‚ï¼Œæ˜ç¢ºå‘ŠçŸ¥è¡¨æƒ…çš„å«ç¾© â–¼â–¼â–¼
            for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (!chat.isGroup) {
                    const intelligentPrompt = `[ç³»çµ±æç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨ä½ çš„å‹•æ…‹(ID: ${postId}, å…§å®¹æ‘˜è¦: â€œ${postSummary}â€)ä¸‹ç™¼é€äº†ä¸€å€‹è¡¨æƒ…è©•è«–ï¼Œæ„æ€æ˜¯ï¼šâ€œ${sticker.name}â€ã€‚è«‹ä½ å°æ­¤ä½œå‡ºå›æ‡‰ã€‚]`;
                    
                    const historyMessage = { 
                        role: 'system', 
                        content: intelligentPrompt, 
                        timestamp: Date.now(), 
                        isHidden: true 
                    };
                    chat.history.push(historyMessage);
                    await db.chats.put(chat);
                }
            }
            // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
        }
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™ä¸‰å€‹å‡½æ•¸æ˜¯è½‰ç™¼åŠŸèƒ½çš„æ ¸å¿ƒï¼Œè«‹å°‡å®ƒå€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹è½‰ç™¼è©•è«–çš„æ¨¡æ…‹æ¡†
         * @param {number} postId - è¦è½‰ç™¼çš„å‹•æ…‹çš„ID
         */
        function openRepostModal(postId) {
            repostTargetId = postId;
            document.getElementById('repost-comment-input').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('repost-modal').classList.add('visible');
        }
        
        /**
         * éš±è—è½‰ç™¼æ¨¡æ…‹æ¡†
         */
        function hideRepostModal() {
            document.getElementById('repost-modal').classList.remove('visible');
            repostTargetId = null;
        }
        
        /**
         * è™•ç†ç¢ºèªè½‰ç™¼çš„é‚è¼¯
         */
        async function handleConfirmRepost() {
            if (!repostTargetId) return;
        
            const comment = document.getElementById('repost-comment-input').value.trim();
            const originalPost = await db.qzonePosts.get(repostTargetId);
        
            if (!originalPost) {
                alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦è½‰ç™¼çš„åŸå§‹å‹•æ…‹ã€‚");
                hideRepostModal();
                return;
            }
        
            const newPost = {
                type: 'repost', // æ¨™è¨˜ç‚ºè½‰ç™¼é¡å‹
                timestamp: Date.now(),
                authorId: 'user', // è½‰ç™¼è€…æ°¸é æ˜¯ç•¶å‰ç”¨æˆ¶
                repostComment: comment,
                originalPost: originalPost, // å°‡åŸå§‹å‹•æ…‹å®Œæ•´åœ°åµŒå…¥æ–°å‹•æ…‹ä¸­
                visibleGroupIds: null // è½‰ç™¼çš„å‹•æ…‹é è¨­å°æ‰€æœ‰äººå¯è¦‹
            };
        
            await db.qzonePosts.add(newPost);
            hideRepostModal();
            await renderQzonePosts();
            alert('è½‰ç™¼æˆåŠŸï¼');
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²             
        // â–¼â–¼â–¼ è«‹ç”¨ä¸‹é¢é€™å€‹ã€æ›´æ–°å¾Œçš„ã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ ä»£ç¢¼ä¸­èˆŠçš„ displayFilteredFavorites å‡½æ•¸ â–¼â–¼â–¼
        
        function displayFilteredFavorites(items) {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';
        
            if (items.length === 0) {
                const searchTerm = document.getElementById('favorites-search-input').value;
                const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸é—œæ”¶è—' : 'ä½ çš„æˆ‘çš„æœ€æ„›æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»å‹•æ…‹æˆ–èŠå¤©ä¸­æ”¶è—å–œæ­¡çš„å…§å®¹å§ï¼';
                listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                return;
            }
        
            for (const item of items) {
                const card = document.createElement('div');
                card.className = 'favorite-item-card';
                card.dataset.favid = item.id;
        
                let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';
        
                if (item.type === 'qzone_post') {
                    const post = item.content;
                    sourceText = 'ä¾†è‡ªå‹•æ…‹';
                    let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ¶';
        
                    if (post.authorId === 'user') {
                        authorAvatar = state.qzoneSettings.avatar;
                        authorNickname = state.qzoneSettings.nickname;
                    } else if (state.chats[post.authorId]) {
                        authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                        authorNickname = state.chats[post.authorId].name;
                    }
        
                    headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
                    
                    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                    if (post.type === 'shuoshuo') {
                        contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                    } else if (post.type === 'image_post' && post.imageUrl) {
    const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image"></div>` : `<img src="${postImageUrl}" class="chat-image">`;
} else if (post.type === 'text_image') {
    const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                    }
        
                    // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç¢¼é–‹å§‹ â–¼â–¼â–¼
                    
                    // 1. æ§‹é€ é»è´Šå€åŸŸçš„HTML
                    let likesHtml = '';
                    // æª¢æŸ¥ post ç‰©ä»¶ä¸­æ˜¯å¦å­˜åœ¨ likes é™£åˆ—ä¸¦ä¸”ä¸ç‚ºç©º
                    if (post.likes && post.likes.length > 0) {
                        // å¦‚æœå­˜åœ¨ï¼Œå°±å‰µå»ºé»è´Šå€åŸŸçš„ div
                        likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('ã€')} è¦ºå¾—å¾ˆè´Š</span>
                            </div>`;
                    }
        
                    // 2. æ§‹é€ è©•è«–å€åŸŸçš„HTML
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©æ–¹æ¡ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€å‘ä¸‹ç›¸å®¹çš„ä»£ç¢¼å¡Šæ›¿æ›èˆŠçš„ if(post.comments...) é‚è¼¯ â–¼â–¼â–¼
        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            post.comments.forEach((comment, index) => {
                // --- æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡åˆ¤æ–·è©•è«–çš„è³‡æ–™æ ¼å¼ ---
                if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                    // --- é€™æ˜¯æ–°æ ¼å¼çš„ã€åŠŸèƒ½å®Œæ•´çš„è©•è«– ---
                    const commenterOriginalName = comment.commenterName;
                    const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                    
                    let innerCommentContent;
                    if (STICKER_REGEX.test(comment.text)) {
                        innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                    } else {
                        innerCommentContent = comment.text;
                    }
        
                    let commentLineHtml = '';
                    if (comment.replyTo) {
                        const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                        commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> å›å¾© <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                    } else {
                        commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                    }
                    
                    commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                        <div class="comment-text">${commentLineHtml}</div>
                                        <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                                     </div>`;
        
                } else {
                    // --- é€™æ˜¯èˆŠæ ¼å¼çš„ã€åªåšé¡¯ç¤ºçš„è©•è«– ---
                    // æˆ‘å€‘æŠŠå®ƒæ¸²æŸ“æˆä¸€å€‹æ²’æœ‰äº¤äº’ã€æ²’æœ‰dataå±¬æ€§çš„ç°¡å–®divï¼Œå¾è€Œé¿å…å ±éŒ¯
                    commentsHtml += `<div class="legacy-comment-item">
                                        <span class="comment-text">${String(comment)}</span>
                                     </div>`;
                }
            });
            commentsHtml += '</div>';
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                    // 3. å°‡é»è´Šå’Œè©•è«–çš„HTMLçµ„åˆåˆ° footerHtml ä¸­
                    footerHtml = `${likesHtml}${commentsHtml}`;
                    
                    // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç¢¼çµæŸ â–²â–²â–²
        
        } else if (item.type === 'chat_message') {
            const msg = item.content;
            const chat = state.chats[item.chatId];
            if (!chat) continue; 
        
            sourceText = `ä¾†è‡ªèˆ‡ ${chat.name} çš„èŠå¤©`;
            const isUser = msg.role === 'user';
            let senderName, senderAvatar;
        
            if (isUser) {
                // ä½¿ç”¨è€…æ¶ˆæ¯çš„é‚è¼¯ä¿æŒä¸è®Š
                senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
            } else { // AI/æˆå“¡æ¶ˆæ¯
                 if (chat.isGroup) {
                    // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
                    // æˆ‘å€‘ç¾åœ¨ä½¿ç”¨ originalName å»åŒ¹é…ï¼Œè€Œä¸æ˜¯èˆŠçš„ name
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…â˜…â˜…
                    
                    senderName = msg.senderName;
                    // å› ç‚ºç¾åœ¨èƒ½æ­£ç¢ºæ‰¾åˆ° member ç‰©ä»¶äº†ï¼Œæ‰€ä»¥ä¹Ÿèƒ½æ­£ç¢ºç²å–åˆ°ä»–çš„é ­åƒ
                    senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                } else {
                    // å–®èŠçš„é‚è¼¯ä¿æŒä¸è®Š
                    senderName = chat.name;
                    senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
            }
        
            // å¾ŒçºŒæ‹¼æ¥ headerHtml å’Œ contentHtml çš„é‚è¼¯éƒ½ä¿æŒä¸è®Š
            headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
            
            if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
        }
                      // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒæ–°å¢é‚è¼¯å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
        else if (item.type === 'char_diary') {
            const diary = item.content;
            sourceText = `ä¾†è‡ª ${diary.characterName} çš„æ—¥è¨˜`;

            const charChat = state.chats[diary.characterId];
            const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;
            
            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${diary.characterName}</div></div>`;
            
            // 1. ç²å–å®Œæ•´çš„æ—¥è¨˜å…§å®¹
            const fullDiaryContent = diary.content || '';
            // 2. ä½¿ç”¨èˆ‡è©³æƒ…é å®Œå…¨ç›¸åŒçš„Markdownè§£æå’Œæ›è¡Œé‚è¼¯
            const formattedContent = parseMarkdown(fullDiaryContent).replace(/\n/g, '<br>');

            // 3. å°‡å®Œæ•´çš„ã€æ ¼å¼åŒ–å¾Œçš„å…§å®¹æ”¾å…¥ contentHtml
            contentHtml = `
                <span class="diary-title">${diary.title}</span>
                <div class="fav-card-content-full">${formattedContent}</div>
            `;
        }     
                // â–¼â–¼â–¼ ä¿®æ”¹æœ€çµ‚çš„HTMLæ‹¼æ¥ï¼ŒåŠ å…¥ footerHtml â–¼â–¼â–¼
                card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`; // <-- æŠŠæˆ‘å€‘æ–°å‰µå»ºçš„ footerHtml æ”¾åœ¨é€™è£¡
                    
                listEl.appendChild(card);
            }
        }
        
        // â–²â–²â–² æ›¿æ›å€åŸŸçµæŸ â–²â–²â–²
        
                /**
                 * ã€é‡æ§‹å¾Œçš„å‡½æ•¸ã€‘: è² è²¬æº–å‚™è³‡æ–™ä¸¦è§¸ç™¼æ¸²æŸ“
                 */
                async function renderFavoritesScreen() {
                    // 1. å¾è³‡æ–™åº«ç²å–æœ€æ–°è³‡æ–™ä¸¦ç·©å­˜
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
                    
                    // 2. æ¸…ç©ºæœç´¢æ¡†ä¸¦éš±è—æ¸…é™¤æŒ‰éˆ•
                    const searchInput = document.getElementById('favorites-search-input');
                    const clearBtn = document.getElementById('favorites-search-clear-btn');
                    searchInput.value = '';
                    clearBtn.style.display = 'none';
        
                    // 3. é¡¯ç¤ºæ‰€æœ‰æ”¶è—é …
                    displayFilteredFavorites(allFavoriteItems);
                }
        
                // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        
                function resetCreatePostModal() {
                    document.getElementById('post-public-text').value = '';
                    document.getElementById('post-image-preview').src = '';
                    document.getElementById('post-image-description').value = '';
                    document.getElementById('post-image-preview-container').classList.remove('visible');
                    document.getElementById('post-image-desc-group').style.display = 'none';
                    document.getElementById('post-local-image-input').value = '';
                    document.getElementById('post-hidden-text').value = '';
                    document.getElementById('switch-to-image-mode').click();
                }
/**
 * ã€V2.0 | NPCä¿è­·ç‰ˆã€‘ä¸€éµæ¸…ç†è³‡æ–™åº«ä¸­æ‰€æœ‰èˆ‡å·²åˆªé™¤è§’è‰²æˆ–èŠå¤©ç›¸é—œçš„å­¤ç«‹è³‡æ–™
 */
async function cleanupRedundantData() {
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç†å†—é¤˜æ•¸æ“šï¼Ÿ',
        'æ­¤æ“ä½œå°‡æƒæè³‡æ–™åº«ï¼Œç§»é™¤æ‰€æœ‰èˆ‡å·²åˆªé™¤è§’è‰²ç›¸é—œçš„å­¤ç«‹è³‡æ–™ï¼ˆå¦‚å‹•æ…‹ã€è©•è«–ã€è¨˜æ†¶ç­‰ï¼‰ã€‚<br><br><strong>æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼Œä½†é€šå¸¸æ˜¯å®‰å…¨çš„ã€‚NPCè³‡æ–™ä¸æœƒè¢«åˆªé™¤ã€‚</strong><br><br>å»ºè­°åœ¨æ“ä½œå‰å…ˆå°å‡ºè³‡æ–™å‚™ä»½ã€‚',
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªæ¸…ç†' }
    );

    if (!confirmed) return;

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨é–‹å§‹æ¸…ç†å†—é¤˜æ•¸æ“šï¼Œè«‹ä¸è¦é—œé–‰é é¢...");
    console.log("å†—é¤˜æ•¸æ“šæ¸…ç†æµç¨‹å·²å•Ÿå‹•...");

    let cleanupCounts = {
        posts: 0, likes: 0, comments: 0, memories: 0,
        callRecords: 0, renderingRules: 0, groupMembers: 0, chatLinks: 0,
    };

    try {
        await db.transaction('rw', db.tables, async () => {
            // æ­¥é©Ÿ A: å»ºç«‹æ‰€æœ‰æœ‰æ•ˆèŠå¤©ã€è§’è‰²å’ŒNPCçš„â€œç™½åå–®â€
            const allChats = await db.chats.toArray();
            const allNpcs = await db.npcs.toArray(); // <-- ã€æ ¸å¿ƒæ–°å¢ã€‘å¾è³‡æ–™åº«è®€å–NPCæ¸…å–®

            const existingChatIds = new Set(allChats.map(c => c.id));
            const existingNpcIds = new Set(allNpcs.map(n => `npc_${n.id}`)); // <-- ã€æ ¸å¿ƒæ–°å¢ã€‘å‰µå»ºNPCçš„IDç™½åå–®

            const existingOriginalNames = new Set(allChats.filter(c => !c.isGroup).map(c => c.originalName));
            existingOriginalNames.add(state.qzoneSettings.nickname || '{{user}}');
            // ã€æ ¸å¿ƒæ–°å¢ã€‘å°‡NPCçš„åå­—ä¹ŸåŠ å…¥â€œæœ‰æ•ˆåç¨±â€ç™½åå–®ï¼Œç”¨æ–¼æ¸…ç†é»è´Šå’Œè©•è«–
            allNpcs.forEach(npc => existingOriginalNames.add(npc.name));

            // æ­¥é©Ÿ B: æ¸…ç†ç¾¤èŠä¸­çš„ç„¡æ•ˆæˆå“¡
            for (const chat of allChats) {
                 let chatModified = false;
                 if (chat.isGroup && chat.members) {
                     const originalMemberCount = chat.members.length;
                     
                     // ã€ã€ã€æ ¸å¿ƒä¿®å¾©é‚è¼¯ã€‘ã€‘ã€‘
                     // ç¾åœ¨æˆ‘å€‘åŒæ™‚æª¢æŸ¥æˆå“¡IDæ˜¯å¦å­˜åœ¨äº è§’è‰²ç™½åå–® æˆ– NPCç™½åå–® ä¸­
                     chat.members = chat.members.filter(member => 
                        existingChatIds.has(member.id) || existingNpcIds.has(member.id)
                     );
                     
                     if (chat.members.length < originalMemberCount) {
                        cleanupCounts.groupMembers += (originalMemberCount - chat.members.length);
                        chatModified = true;
                     }
                 }
                 // (æ¸…ç†æ›è¼‰è¨˜æ†¶çš„é‚è¼¯ä¿æŒä¸è®Š)
                 if (chat.settings?.linkedMemoryChatIds?.length > 0) {
                     const originalLinkCount = chat.settings.linkedMemoryChatIds.length;
                     chat.settings.linkedMemoryChatIds = chat.settings.linkedMemoryChatIds.filter(id => existingChatIds.has(id));
                     if (chat.settings.linkedMemoryChatIds.length < originalLinkCount) {
                        cleanupCounts.chatLinks += (originalLinkCount - chat.settings.linkedMemoryChatIds.length);
                        chatModified = true;
                     }
                 }
                 if(chatModified) {
                     await db.chats.put(chat);
                 }
            }

            // æ­¥é©Ÿ C: æ¸…ç†å‹•æ…‹ã€é»è´Šå’Œè©•è«–
            const allPosts = await db.qzonePosts.toArray();
            for (const post of allPosts) {
                let postModified = false;
                
                // ã€ã€ã€æ ¸å¿ƒä¿®å¾©é‚è¼¯ã€‘ã€‘ã€‘
                // æª¢æŸ¥ç™¼å¸–äººæ˜¯å¦æ˜¯ç”¨æˆ¶ã€è§’è‰²æˆ–NPC
                const isAuthorValid = post.authorId === 'user' || existingChatIds.has(post.authorId) || existingNpcIds.has(post.authorId);

                if (!isAuthorValid) {
                    await db.qzonePosts.delete(post.id);
                    cleanupCounts.posts++;
                    continue; // å¸–å­å·²åˆªé™¤ï¼Œè·³éå¾ŒçºŒè™•ç†
                }
                
                if (post.likes && post.likes.length > 0) {
                    const originalLikeCount = post.likes.length;
                    post.likes = post.likes.filter(name => existingOriginalNames.has(name));
                    if (post.likes.length < originalLikeCount) {
                        cleanupCounts.likes += (originalLikeCount - post.likes.length);
                        postModified = true;
                    }
                }
                if (post.comments && post.comments.length > 0) {
                    const originalCommentCount = post.comments.length;
                    post.comments = post.comments.filter(comment => {
                        if (typeof comment === 'object' && comment.commenterName) {
                            return existingOriginalNames.has(comment.commenterName);
                        }
                        return true; // ä¿ç•™èˆŠæ ¼å¼çš„è©•è«–
                    });
                     if (post.comments.length < originalCommentCount) {
                        cleanupCounts.comments += (originalCommentCount - post.comments.length);
                        postModified = true;
                    }
                }
                if (postModified) { await db.qzonePosts.put(post); }
            }

            // (å…¶ä»–æ¸…ç†é‚è¼¯ä¿æŒä¸è®Š)
            await db.memories.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.memories += c);
            await db.callRecords.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.callRecords += c);
            const allRules = await db.renderingRules.toArray();
            for(const rule of allRules) {
                if (rule.chatId !== 'global' && !existingChatIds.has(rule.chatId)) {
                    await db.renderingRules.delete(rule.id);
                    cleanupCounts.renderingRules++;
                }
            }
        });

        let summary = "âœ… æ¸…ç†å®Œæˆï¼\n\n";
        let cleanedSomething = false;
        Object.entries(cleanupCounts).forEach(([key, value]) => {
            if (value > 0) {
                const keyMap = {
                    posts: 'å‹•æ…‹', likes: 'é»è´Š', comments: 'è©•è«–', memories: 'è¨˜æ†¶',
                    callRecords: 'é€šè©±è¨˜éŒ„', renderingRules: 'æ¸²æŸ“è¦å‰‡',
                    groupMembers: 'ç¾¤æˆå“¡', chatLinks: 'è¨˜æ†¶é€£çµ'
                };
                summary += `- æ¸…ç†äº† ${value} æ¢ç„¡æ•ˆçš„${keyMap[key] || key}ã€‚\n`;
                cleanedSomething = true;
            }
        });
        if (!cleanedSomething) {
            summary = "âœ… æª¢æŸ¥å®Œæˆï¼Œæœªç™¼ç¾ä»»ä½•å†—é¤˜æ•¸æ“šã€‚";
        }
        summary += "\nå»ºè­°åˆ·æ–°é é¢ä»¥ç¢ºä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆã€‚";

        await showCustomAlert("æ“ä½œæˆåŠŸ", summary);
        
        const confirmedReload = await showCustomConfirm("åˆ·æ–°é é¢ï¼Ÿ", "ç‚ºäº†ç¢ºä¿æ‰€æœ‰è³‡æ–™åŒæ­¥ï¼Œå»ºè­°ç«‹å³åˆ·æ–°é é¢ã€‚");
        if(confirmedReload) {
            location.reload();
        }

    } catch (error) {
        console.error("æ¸…ç†å†—é¤˜æ•¸æ“šæ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('æ¸…ç†å¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
    }
}
        // â–¼â–¼â–¼ ã€é€™æ˜¯åŒ¯å‡ºå‡½æ•¸ä¿®å¾©ç‰ˆã€‘ â–¼â–¼â–¼
        async function exportBackup() {
            try {
                const backupData = {
                    version: 1, 
                    timestamp: Date.now()
                };
        
                const [
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories, worldBookCategories,
                    apiPresets, shoppingProducts, callRecords,
                    renderingRules,
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    doubanPosts,
                    stickerCategories,
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    appearancePresets,
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    presets,              // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¾©ã€‘
                    presetCategories,
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    npcs 
                ] = await Promise.all([
                    db.chats.toArray(),
                    db.worldBooks.toArray(),
                    db.userStickers.toArray(),
                    db.apiConfig.get('main'),
                    db.globalSettings.get('main'),
                    db.personaPresets.toArray(),
                    db.musicLibrary.get('main'),
                    db.qzoneSettings.get('main'),
                    db.qzonePosts.toArray(),
                    db.qzoneAlbums.toArray(),
                    db.qzonePhotos.toArray(),
                    db.favorites.toArray(),
                    db.qzoneGroups.toArray(),
                    db.memories.toArray(),
                    db.worldBookCategories.toArray(),
                    db.apiPresets.toArray(),
                    db.shoppingProducts.toArray(),
                    db.callRecords.toArray(),
                    db.renderingRules.toArray(),
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    db.doubanPosts.toArray(),
                    db.stickerCategories.toArray(),
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    db.appearancePresets.toArray(),
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    db.presets.toArray(),             // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¾©ã€‘
                    db.presetCategories.toArray(),
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    db.npcs.toArray() 
                ]);
        
                Object.assign(backupData, {
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories, worldBookCategories,
                    apiPresets, shoppingProducts, callRecords,
                    renderingRules,
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    doubanPosts,
                    stickerCategories,
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    appearancePresets,
                    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    presets,              // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¾©ã€‘
                    presetCategories,
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    npcs  
                });
                
                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = Object.assign(document.createElement('a'), {
                    href: url,
                    download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
                });
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', 'å·²æˆåŠŸåŒ¯å‡ºæ‰€æœ‰è³‡æ–™ï¼');
        
            } catch (error) {
                console.error("åŒ¯å‡ºè³‡æ–™æ™‚å‡ºéŒ¯:", error);
                await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
            }
        }
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å°ˆé–€ç”¨æ–¼å°å…¥â€œæµå¼å‚™ä»½â€æª”çš„æ ¸å¿ƒå‡½æ•¸ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è™•ç†æ–°ç‰ˆæµå¼å‚™ä»½æª”æ¡ˆçš„å°å…¥é‚è¼¯
 * @param {object} backupData - å¾æµå¼å‚™ä»½æª”æ¡ˆ .data æ¬„ä½ä¸­è§£æå‡ºçš„è³‡æ–™ç‰©ä»¶
 */
async function importStreamedBackup(backupData) {
    try {
        await db.transaction('rw', db.tables, async () => {
            // 1. æ¸…ç©ºæ‰€æœ‰ç¾æœ‰è³‡æ–™
            for (const table of db.tables) {
                await table.clear();
            }

            // 2. éæ­·å‚™ä»½è³‡æ–™ä¸­çš„æ‰€æœ‰è¡¨ï¼Œä¸¦æ‰¹é‡å°å…¥
            for (const tableName in backupData) {
                if (Array.isArray(backupData[tableName])) {
                    console.log(`æ­£åœ¨å°å…¥è¡¨: ${tableName}, è¨˜éŒ„æ•¸: ${backupData[tableName].length}`);
                    await db.table(tableName).bulkPut(backupData[tableName]);
                }
            }
        });

    } catch (error) {
        // å¦‚æœåœ¨äº‹å‹™ä¸­ç™¼ç”Ÿä»»ä½•éŒ¯èª¤ï¼Œç›´æ¥å‘ä¸Šæ‹‹å‡º
        throw new Error(`è³‡æ–™åº«å¯«å…¥å¤±æ•—: ${error.message}`);
    }
}

// â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²        
// â–¼â–¼â–¼ ã€æœ€çµ‚è§£æ±ºæ–¹æ¡ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ importBackup å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€æ™ºæ…§ç¸½ç®¡ | V2.0ã€‘è™•ç†æª”å°å…¥ï¼Œè‡ªå‹•è­˜åˆ¥å‚™ä»½æª”æ¡ˆç‰ˆæœ¬
 * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„ .json å‚™ä»½æª”æ¡ˆ
 */
async function handleSmartImport(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'åš´é‡è­¦å‘Šï¼',
        'å°å…¥å‚™ä»½å°‡å®Œå…¨è¦†è“‹æ‚¨ç•¶å‰çš„æ‰€æœ‰è³‡æ–™ã€‚æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );
    if (!confirmed) return;

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è®€å–ä¸¦è§£æå‚™ä»½æª”æ¡ˆ...");

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        // --- æ ¸å¿ƒè­˜åˆ¥é‚è¼¯ ---
        // æª¢æŸ¥æ˜¯å¦æ˜¯æ–°çš„ã€å¸¶ "data" åŒ…è£çš„æµå¼å‚™ä»½
        if (data.data && typeof data.data === 'object' && data.data.chats) {
            console.log("æª¢æ¸¬åˆ°æ–°ç‰ˆæµå¼å‚™ä»½æª”æ¡ˆï¼Œé–‹å§‹å°å…¥...");
            await importStreamedBackup(data.data); // èª¿ç”¨æ–°å‡½æ•¸ï¼Œä¸¦å‚³å…¥æ ¸å¿ƒè³‡æ–™
        }
        // å¦å‰‡ï¼Œæª¢æŸ¥æ˜¯å¦æ˜¯èˆŠçš„ã€æ‰å¹³çµæ§‹çš„å‚™ä»½
        else if (data.chats) {
            console.log("æª¢æ¸¬åˆ°èˆŠç‰ˆå®Œæ•´å‚™ä»½æª”æ¡ˆï¼Œé–‹å§‹å°å…¥...");
            await importLegacyBackup(data); // èª¿ç”¨æ”¹é€ å¾Œçš„èˆŠå‡½æ•¸
        }
        // å¦‚æœå…©ç¨®éƒ½ä¸æ˜¯
        else {
            throw new Error("æª”æ¡ˆæ ¼å¼ç„¡æ³•è­˜åˆ¥ã€‚è«‹ç¢ºä¿æ‚¨é¸æ“‡çš„æ˜¯æœ‰æ•ˆçš„ EPhone å‚™ä»½æª”æ¡ˆã€‚");
        }

        // --- å°å…¥æˆåŠŸå¾Œçš„çµ±ä¸€è™•ç† ---
        await showCustomAlert('å°å…¥æˆåŠŸ', 'æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¢å¾©ï¼æ‡‰ç”¨å³å°‡åˆ·æ–°ä»¥æ‡‰ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("å°å…¥è³‡æ–™æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('å°å…¥å¤±æ•—', `æ–‡ä»¶è§£ææˆ–æ‡‰ç”¨å¤±æ•—: ${error.message}`);
    }
}

/**
 * ã€æ”¹é€ å¾Œã€‘è™•ç†èˆŠç‰ˆå‚™ä»½æª”æ¡ˆçš„å°å…¥é‚è¼¯
 * @param {object} backupData - å¾èˆŠç‰ˆå‚™ä»½æª”æ¡ˆè§£æå‡ºçš„è³‡æ–™ç‰©ä»¶
 */
async function importLegacyBackup(backupData) {
    try {
        await db.transaction('rw', db.tables, async () => {
            await db.chats.clear();
            await db.worldBooks.clear();
            // ... (ç‚ºæ‰€æœ‰è¡¨æ·»åŠ  .clear() èª¿ç”¨)
            for (const table of db.tables) {
                await table.clear();
            }

            if (Array.isArray(backupData.chats)) await db.chats.bulkPut(backupData.chats);
            if (Array.isArray(backupData.worldBooks)) await db.worldBooks.bulkPut(backupData.worldBooks);
            // ... (ç‚ºæ‰€æœ‰è¡¨æ·»åŠ  .bulkPut() èª¿ç”¨ï¼Œé€™éƒ¨åˆ†é‚è¼¯èˆ‡æ‚¨èˆŠçš„ importBackup å‡½æ•¸å®Œå…¨ç›¸åŒ)
            if (Array.isArray(backupData.userStickers)) await db.userStickers.bulkPut(backupData.userStickers);
            if (backupData.apiConfig) await db.apiConfig.put(backupData.apiConfig);
            if (backupData.globalSettings) await db.globalSettings.put(backupData.globalSettings);
            // ... (è«‹ç¢ºä¿é€™è£¡åŒ…å«äº†æ‰€æœ‰è¡¨çš„å°å…¥é‚è¼¯)
             if (Array.isArray(backupData.personaPresets)) await db.personaPresets.bulkPut(backupData.personaPresets);
            if (backupData.musicLibrary) await db.musicLibrary.put(backupData.musicLibrary);
            if (backupData.qzoneSettings) await db.qzoneSettings.put(backupData.qzoneSettings);
            if (Array.isArray(backupData.qzonePosts)) await db.qzonePosts.bulkPut(backupData.qzonePosts);
            if (Array.isArray(backupData.qzoneAlbums)) await db.qzoneAlbums.bulkPut(backupData.qzoneAlbums);
            if (Array.isArray(backupData.qzonePhotos)) await db.qzonePhotos.bulkPut(backupData.qzonePhotos);
            if (Array.isArray(backupData.favorites)) await db.favorites.bulkPut(backupData.favorites);
            if (Array.isArray(backupData.qzoneGroups)) await db.qzoneGroups.bulkPut(backupData.qzoneGroups);
            if (Array.isArray(backupData.memories)) await db.memories.bulkPut(backupData.memories);
            if (Array.isArray(backupData.worldBookCategories)) await db.worldBookCategories.bulkPut(backupData.worldBookCategories);
            if (Array.isArray(backupData.apiPresets)) await db.apiPresets.bulkPut(backupData.apiPresets);
            if (Array.isArray(backupData.shoppingProducts)) await db.shoppingProducts.bulkPut(backupData.shoppingProducts);
            if (Array.isArray(backupData.callRecords)) await db.callRecords.bulkPut(backupData.callRecords);
            if (Array.isArray(backupData.renderingRules)) await db.renderingRules.bulkPut(backupData.renderingRules);
            if (Array.isArray(backupData.doubanPosts)) await db.doubanPosts.bulkPut(backupData.doubanPosts);
            if (Array.isArray(backupData.stickerCategories)) await db.stickerCategories.bulkPut(backupData.stickerCategories);
            if (Array.isArray(backupData.appearancePresets)) await db.appearancePresets.bulkPut(backupData.appearancePresets);
            if (Array.isArray(backupData.presets)) await db.presets.bulkPut(backupData.presets);
            if (Array.isArray(backupData.presetCategories)) await db.presetCategories.bulkPut(backupData.presetCategories);
            if (Array.isArray(backupData.npcs)) await db.npcs.bulkPut(backupData.npcs);
        });
    } catch (error) {
        throw new Error(`èˆŠç‰ˆå‚™ä»½è³‡æ–™å¯«å…¥è³‡æ–™åº«å¤±æ•—: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                function applyCustomFont(fontUrl, isPreviewOnly = false) {
                    if (!fontUrl) {
                        dynamicFontStyle.innerHTML = '';
                        document.getElementById('font-preview').style.fontFamily = '';
                        return;
                    }
                    const fontName = 'custom-user-font';
                    const newStyle = `
                        @font-face {
                          font-family: '${fontName}';
                          src: url('${fontUrl}');
                          font-display: swap;
                        }`;
                    if (isPreviewOnly) {
                        const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                        previewStyle.id = 'preview-font-style';
                        previewStyle.innerHTML = newStyle;
                        if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                        document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
                    } else {
                        dynamicFontStyle.innerHTML = `
                            ${newStyle}
                            body {
                              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                            }`;
                    }
                }
        
                async function resetToDefaultFont() {
                    dynamicFontStyle.innerHTML = ''; 
                    state.globalSettings.fontUrl = '';
                    await db.globalSettings.put(state.globalSettings);
                    document.getElementById('font-url-input').value = '';
                    document.getElementById('font-preview').style.fontFamily = '';
                    alert('å·²æ¢å¾©é è¨­å­—é«”ã€‚');
                }
        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²æ›´æ–°çš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ loadAllDataFromDB å‡½æ•¸ â–¼â–¼â–¼
async function loadAllDataFromDB() {
    const [
        chatsArr, apiConfig, loadedGlobalSettings, userStickers, worldBooks,
        musicLib, personaPresets, qzoneSettings, initialFavorites,
        allMemories,
        // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨é€™è£¡è¼‰å…¥æ‰€æœ‰é è¨­
        allPresets
    ] = await Promise.all([
        db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'),
        db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'),
        db.personaPresets.toArray(), db.qzoneSettings.get('main'), db.favorites.orderBy('timestamp').reverse().toArray(),
        db.memories.toArray(),
        // ã€æ ¸å¿ƒæ–°å¢ã€‘å¾è³‡æ–™åº«è®€å– presets è¡¨
        db.presets.toArray()
    ]);

    // ã€æ ¸å¿ƒæ–°å¢ã€‘å°‡è¼‰å…¥çš„é è¨­ä¿å­˜åˆ°å…¨åŸŸ state ä¸­
    state.presets = allPresets || [];

    // --- (å¾ŒçºŒæ‰€æœ‰çš„è³‡æ–™è™•ç†é‚è¼¯ä¿æŒä¸è®Š) ---
    const defaultGlobalSettings = {
        id: 'main',
        showStatusBar: false,
        wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)',
        fontUrl: '',
        enableBackgroundActivity: false,
        backgroundActivityInterval: 60,
        blockCooldownHours: 1,
        apiTemperature: 0.8,
        appIcons: { ...DEFAULT_APP_ICONS },
        cphoneWallpaper: 'linear-gradient(135deg, #f6d365, #fda085)',
        cphoneAppIcons: { ...DEFAULT_CPHONE_ICONS },
        globalCss: '',
        notificationSoundUrl: '',
        widgetData: {},
        globalChatBackground: '',
        enableAiDrawing: true,
    chatActionButtonsOrder: null,
    shoppingCategoryCount: 3,
    shoppingProductCount: 8,
        chatRenderWindow: 50
    };
    state.globalSettings = { ...defaultGlobalSettings, ...(loadedGlobalSettings || {}) };
    state.globalSettings.appIcons = { ...defaultGlobalSettings.appIcons, ...(state.globalSettings.appIcons || {}) };
    state.globalSettings.cphoneAppIcons = { ...defaultGlobalSettings.cphoneAppIcons, ...(state.globalSettings.cphoneAppIcons || {}) };

    chatsArr.forEach(chat => {
            if (typeof chat.settings.enableTimePerception === 'undefined') {
                chat.settings.enableTimePerception = true;
            }
        if (!chat.settings.lyricsPosition) {
            chat.settings.lyricsPosition = { vertical: 'top', horizontal: 'center', offset: 10 };
        }
        if (!chat.isGroup && !chat.settings.myAvatarLibrary) {
            chat.settings.myAvatarLibrary = [];
        }
        if (!chat.isGroup && typeof chat.originalName === 'undefined') {
            chat.originalName = chat.name;
        }
    });
    state.chats = chatsArr.reduce((acc, chat) => {
        if (typeof chat.unreadCount === 'undefined') chat.unreadCount = 0;
        if (chat.isGroup) {
            if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
                chat.settings.enableBackgroundActivity = true;
            }
            if (chat.members && chat.members.length > 0 && chat.members[0].name) {
                chat.members.forEach(member => {
                    if (typeof member.originalName === 'undefined') {
                        member.originalName = member.name;
                        member.groupNickname = member.name;
                        delete member.name;
                    }
                });
            }
        }
        if (!chat.settings) chat.settings = {};
        if (typeof chat.settings.actionCooldownMinutes === 'undefined') {
            chat.settings.actionCooldownMinutes = 10;
        }
        if (!chat.isGroup && !chat.status) chat.status = { text: 'ç·šä¸Š', lastUpdate: Date.now(), isBusy: false };
        if (!chat.isGroup && !chat.relationship) chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
        if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) { if (!chat.settings) chat.settings = {}; chat.settings.aiAvatarLibrary = []; }
        if (chat.isGroup) { (chat.members || []).forEach(member => { if (typeof member.avatarFrame === 'undefined') member.avatarFrame = ''; }); }
        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; }
        if (typeof chat.isPinned === 'undefined') chat.isPinned = false;
        if (!chat.isGroup && typeof chat.settings.myNickname === 'undefined') {
            chat.settings.myNickname = 'æˆ‘';
        }
        if (chat.isGroup && chat.members) {
            let needsUpdate = false;
            chatsArr.forEach(c => {
                 if (c.id === chat.id && c.originalName) {
                    delete c.originalName;
                 }
            });
            chat.members.forEach(member => {
                const originalCharacter = chatsArr.find(c => c.id === member.id);
                if (originalCharacter && originalCharacter.settings) {
                    const correctFrame = originalCharacter.settings.aiAvatarFrame || '';
                    if (member.avatarFrame !== correctFrame) {
                        member.avatarFrame = correctFrame;
                        needsUpdate = true;
                    }
                } else if (typeof member.avatarFrame === 'undefined') {
                    member.avatarFrame = '';
                    needsUpdate = true;
                }
            });
            if (needsUpdate) db.chats.put(chat);
        }
        if (!chat.settings.enableAutoMemory) chat.settings.enableAutoMemory = false;
        if (!chat.settings.autoMemoryInterval) chat.settings.autoMemoryInterval = 20;
        if (!chat.longTermMemory) chat.longTermMemory = [];
        if (!chat.lastMemorySummaryTimestamp) chat.lastMemorySummaryTimestamp = 0;
        if (!chat.isGroup) {
            if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
                chat.settings.enableBackgroundActivity = true;
            }
            if (typeof chat.settings.enableTts === 'undefined') { chat.settings.enableTts = false; }
            if (!chat.status) chat.status = { text: 'ç·šä¸Š', lastUpdate: Date.now(), isBusy: false };
            if (!chat.relationship) chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
            if (!chat.settings || !chat.settings.aiAvatarLibrary) { if (!chat.settings) chat.settings = {}; chat.settings.aiAvatarLibrary = []; }
            if (typeof chat.settings.isOfflineMode === 'undefined') chat.settings.isOfflineMode = false;
            if (typeof chat.settings.offlineMinLength === 'undefined') chat.settings.offlineMinLength = 100;
            if (typeof chat.settings.offlineMaxLength === 'undefined') chat.settings.offlineMaxLength = 300;
            if (typeof chat.heartfeltVoice === 'undefined') chat.heartfeltVoice = '...';
            if (typeof chat.randomJottings === 'undefined') chat.randomJottings = '...';
            if (!Array.isArray(chat.thoughtsHistory)) {
                chat.thoughtsHistory = [];
            }
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    const memoriesToUpdate = [];
    allMemories.forEach(memory => {
        if (memory.type === 'ai_generated' && memory.authorName && !memory.authorId) {
            const foundChat = chatsArr.find(c => !c.isGroup && c.originalName === memory.authorName);
            if (foundChat) {
                memory.authorId = foundChat.id;
                memoriesToUpdate.push(memory);
            } else {
                 const fallbackChat = chatsArr.find(c => !c.isGroup && c.name === memory.authorName);
                 if(fallbackChat) {
                    memory.authorId = fallbackChat.id;
                    memoriesToUpdate.push(memory);
                 }
            }
        }
    });
    if (memoriesToUpdate.length > 0) {
        await db.memories.bulkPut(memoriesToUpdate);
    }
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '', secondaryProxyUrl: '', secondaryApiKey: '', secondaryModel: '', minimaxGroupId: '', minimaxApiKey: '', minimaxModel: 'speech-01' };
    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };
    allFavoriteItems = initialFavorites || [];
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }
        
                function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
/**
 * ã€å…¨æ–° V2.0 | æ™ºæ…§æ—¥æœŸæ„ŸçŸ¥ç‰ˆã€‘ç‚ºAIä¸Šä¸‹æ–‡æ ¼å¼åŒ–æ™‚é–“æˆ³è¨˜
 * @param {number} timestamp - æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸæ™‚é–“å­—ä¸²ï¼Œä¾‹å¦‚ "ä»Šå¤© 17:42", "æ˜¨å¤© 23:50" ç­‰
 */
function formatTimestampForAI(timestamp) {
    if (!timestamp) return '';
    
    const now = new Date();
    const date = new Date(timestamp);

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const timeString = `${hours}:${minutes}`;

    // å¦‚æœæ˜¯ä»Šå¤©
    if (now.toDateString() === date.toDateString()) {
        return `ä»Šå¤© ${timeString}`;
    }

    // å¦‚æœæ˜¯æ˜¨å¤©
    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    if (yesterday.toDateString() === date.toDateString()) {
        return `æ˜¨å¤© ${timeString}`;
    }
    
    // å¦‚æœæ˜¯ä»Šå¹´
    if (now.getFullYear() === date.getFullYear()) {
        const month = String(date.getMonth() + 1);
        const day = String(date.getDate());
        return `${month}æœˆ${day}æ—¥ ${timeString}`;
    }
    
    // å¦‚æœæ˜¯å¾€å¹´
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    return `${year}å¹´${month}æœˆ${day}æ—¥ ${timeString}`;
}        
         // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹ç”¨é€™å€‹æ›´å¯é çš„ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ showNotification å‡½æ•¸ â–¼â–¼â–¼
        function showNotification(chatId, messageContent) {
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
    playNotificationSound();
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
            clearTimeout(notificationTimeout);
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // 1. ç²å–é€šçŸ¥æ¬„å…ƒç´ 
            const bar = document.getElementById('notification-bar');
            
            // 2. å¡«å……å…§å®¹
            document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
            document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
            document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
            
            // 3. ã€æ ¸å¿ƒä¿®å¾©ã€‘ä½¿ç”¨â€œå¼·åˆ¶é‡æ’â€æŠ€å·§ï¼Œç¢ºä¿å‹•ç•«æ¯æ¬¡éƒ½èƒ½è§¸ç™¼
            // å…ˆç§»é™¤classï¼Œè®“å®ƒå›åˆ°åˆå§‹çš„â€œéš±è—â€ç‹€æ…‹
            bar.classList.remove('visible');
            
            // é€™ä¸€è¡Œæ˜¯é—œéµï¼å®ƒæœƒå¼·åˆ¶æµè¦½å™¨é‡æ–°è¨ˆç®—å…ƒç´ ä½ˆå±€ï¼Œå¾è€Œâ€œé‡ç½®â€å‹•ç•«ç‹€æ…‹ã€‚
            void bar.offsetWidth; 
            
            // å†æ¬¡æ·»åŠ classï¼Œæµè¦½å™¨æœƒèªç‚ºé€™æ˜¯ä¸€å€‹æ–°çš„ç‹€æ…‹è®ŠåŒ–ï¼Œå¾è€Œå¹³æ»‘åœ°åŸ·è¡ŒCSSéæ¸¡å‹•ç•«ã€‚
            bar.classList.add('visible');
            
            // 4. ç‚ºé€šçŸ¥æ¬„ç¶å®šé»æ“Šäº‹ä»¶ï¼ˆä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§æ¸…é™¤èˆŠç›£è½å™¨ï¼‰
            const newBar = bar.cloneNode(true);
            bar.parentNode.replaceChild(newBar, bar);
            newBar.addEventListener('click', () => {
                openChat(chatId);
                newBar.classList.remove('visible');
            });
        
            // 5. è¨­ç½®è¨ˆæ™‚å™¨ï¼Œåœ¨4ç§’å¾Œè‡ªå‹•éš±è—é€šçŸ¥
            notificationTimeout = setTimeout(() => {
                newBar.classList.remove('visible');
            }, 4000);
        }
        
               function updateClock() { 
    const now = new Date(); 
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); 
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); 
    
    // document.getElementById('main-time').textContent = timeString; // æ³¨é‡‹æ‰é€™è¡Œ
    document.getElementById('status-bar-time').textContent = timeString; 
    // document.getElementById('main-date').textContent = dateString; // æ³¨é‡‹æ‰é€™è¡Œ
}
        
        
        /**
         * ã€çµ‚æ¥µå¥å£¯ç‰ˆã€‘è§£æAIè¿”å›çš„ã€å¯èƒ½æ ¼å¼ä¸è¦ç¯„çš„å›æ‡‰å…§å®¹
         * @param {string} content - AIè¿”å›çš„åŸå§‹å­—ä¸²
         * @returns {Array} - ä¸€å€‹æ¨™æº–åŒ–çš„æ¶ˆæ¯ç‰©ä»¶é™£åˆ—
         */
        function parseAiResponse(content) {
            const trimmedContent = content.trim();
        
            // æ–¹æ¡ˆ1ï¼šã€æœ€å„ªå…ˆã€‘å˜—è©¦ä½œç‚ºæ¨™æº–çš„ã€å–®ä¸€çš„JSONé™£åˆ—è§£æ
            // é€™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…æ³
            if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    if (Array.isArray(parsed)) {
                        console.log("è§£ææˆåŠŸï¼šæ¨™æº–JSONé™£åˆ—æ ¼å¼ã€‚");
                        return parsed;
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±æ•—ï¼Œèªªæ˜å®ƒé›–ç„¶çœ‹èµ·ä¾†åƒå€‹é™£åˆ—ï¼Œä½†å…§éƒ¨æ ¼å¼æœ‰å•é¡Œã€‚
                    // æ­¤æ™‚æˆ‘å€‘ä¸å ±éŒ¯ï¼Œè€Œæ˜¯ç¹¼çºŒå˜—è©¦ä¸‹é¢çš„â€œå¼·åŠ›è§£æâ€æ–¹æ¡ˆã€‚
                    console.warn("æ¨™æº–JSONé™£åˆ—è§£æå¤±æ•—ï¼Œå°‡å˜—è©¦å¼·åŠ›è§£æ...");
                }
            }
        
            // æ–¹æ¡ˆ2ï¼šã€å¼·åŠ›è§£æã€‘ä½¿ç”¨è¦å‰‡é‹ç®—å¼ï¼Œå¾æ··äº‚çš„å­—ä¸²ä¸­æå–å‡ºæ‰€æœ‰ç¨ç«‹çš„JSONç‰©ä»¶
            // é€™èƒ½å®Œç¾è§£æ±ºæ‚¨é‡åˆ°çš„ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" é€™ç¨®æ ¼å¼
            const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
        
            if (jsonMatches) {
                const results = [];
                for (const match of jsonMatches) {
                    try {
                        // å˜—è©¦è§£ææ¯ä¸€å€‹è¢«æˆ‘å€‘â€œæªâ€å‡ºä¾†çš„JSONå­—ä¸²
                        const parsedObject = JSON.parse(match);
                        results.push(parsedObject);
                    } catch (e) {
                        // å¦‚æœæŸå€‹ç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå°±å¿½ç•¥å®ƒï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹
                        console.warn("è·³éä¸€å€‹ç„¡æ•ˆçš„JSONç‰‡æ®µ:", match);
                    }
                }
        
                // å¦‚æœæˆ‘å€‘æˆåŠŸæå–å‡ºäº†è‡³å°‘ä¸€å€‹æœ‰æ•ˆçš„JSONç‰©ä»¶ï¼Œå°±è¿”å›é€™å€‹çµæœ
                if (results.length > 0) {
                    console.log("è§£ææˆåŠŸï¼šé€šéå¼·åŠ›æå–æ¨¡å¼ã€‚");
                    return results;
                }
            }
            
            // æ–¹æ¡ˆ3ï¼šã€æœ€çµ‚å‚™ç”¨ã€‘å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—äº†ï¼Œèªªæ˜AIè¿”å›çš„å¯èƒ½å°±æ˜¯ç´”æ–‡å­—
            // æˆ‘å€‘å°‡åŸå§‹çš„ã€æœªè™•ç†çš„å…§å®¹ï¼ŒåŒ…è£æˆä¸€å€‹æ¨™æº–çš„æ–‡æœ¬æ¶ˆæ¯ç‰©ä»¶è¿”å›ï¼Œç¢ºä¿ç¨‹å¼ä¸æœƒå´©æ½°
            console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±æ•—ï¼å°‡è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
            return [{ type: 'text', content: content }];
        }
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ“šç•¶å‰æ™‚é–“ç²å–ä¸€å¤©ä¸­çš„å•å€™èª
         * @returns {string} - è¿”å›å¦‚ "æ·©æ™¨", "æ—©ä¸Š", "ä¸‹åˆ", "æ™šä¸Š" ç­‰å­—ä¸²
         */
        function getTimeOfDayGreeting(date = new Date()) { // å…è¨±å‚³å…¥ä¸€å€‹æ—¥æœŸç‰©ä»¶
            const hour = date.getHours(); // ä½¿ç”¨å‚³å…¥çš„æ—¥æœŸç‰©ä»¶ä¾†ç²å–å°æ™‚
            if (hour >= 0 && hour < 5) {
                return "æ·©æ™¨";
            } else if (hour >= 5 && hour < 9) {
                return "æ—©ä¸Š";
            } else if (hour >= 9 && hour < 13) {
                return "ä¸Šåˆ";
            } else if (hour >= 13 && hour < 18) {
                return "ä¸‹åˆ";
            } else if (hour >= 18 && hour < 24) {
                return "æ™šä¸Š";
            }
            return "ç¾åœ¨"; // é è¨­æƒ…æ³
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘APIé è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
/**
         * å¾è³‡æ–™åº«è¼‰å…¥APIé è¨­ï¼Œä¸¦å¡«å……åˆ°ä¸‹æ‹‰é¸æ“‡æ¡†ä¸­
         */
        async function loadApiPresetsDropdown() {
            const selectEl = document.getElementById('api-preset-select');
            selectEl.innerHTML = '<option value="current">ç•¶å‰é…ç½® (æœªä¿å­˜)</option>';
            
            const presets = await db.apiPresets.toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        
            // æª¢æŸ¥ç•¶å‰é…ç½®æ˜¯å¦èˆ‡æŸå€‹é è¨­å®Œå…¨åŒ¹é…
            const currentConfig = state.apiConfig;
            let matchingPresetId = null;
            for (const preset of presets) {
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨åˆ¤æ–·æ¢ä»¶ä¸­åŠ å…¥å°TTSè¨­ç½®çš„æª¢æŸ¥ â–¼â–¼â–¼
                if (
                    preset.proxyUrl === currentConfig.proxyUrl &&
                    preset.apiKey === currentConfig.apiKey &&
                    preset.model === currentConfig.model &&
                    preset.secondaryProxyUrl === currentConfig.secondaryProxyUrl &&
                    preset.secondaryApiKey === currentConfig.secondaryApiKey &&
                    preset.secondaryModel === currentConfig.secondaryModel &&
                    // -- æ–°å¢çš„åˆ¤æ–·æ¢ä»¶ --
                    (preset.minimaxGroupId || '') === (currentConfig.minimaxGroupId || '') &&
                    (preset.minimaxApiKey || '') === (currentConfig.minimaxApiKey || '') &&
                    (preset.minimaxModel || 'speech-01') === (currentConfig.minimaxModel || 'speech-01')
                ) 
                // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
                {
                    matchingPresetId = preset.id;
                    break;
                }
            }
        
            if (matchingPresetId) {
                selectEl.value = matchingPresetId;
            } else {
                selectEl.value = 'current';
            }
        }
        
/**
         * ç•¶ç”¨æˆ¶å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹é è¨­æ™‚ï¼Œè¼‰å…¥è©²é è¨­çš„é…ç½®
         */
        async function handlePresetSelectionChange() {
            const selectEl = document.getElementById('api-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            // å¦‚æœé¸æ“‡çš„æ˜¯â€œç•¶å‰é…ç½®â€ï¼Œå‰‡ä¸åšä»»ä½•äº‹
            if (isNaN(selectedId)) {
                return;
            }
        
            const preset = await db.apiPresets.get(selectedId);
            if (preset) {
                // å°‡é è¨­çš„é…ç½®è¼‰å…¥åˆ°ç•¶å‰çš„å…¨åŸŸç‹€æ…‹ä¸­
                state.apiConfig = {
                    id: 'main',
                    proxyUrl: preset.proxyUrl,
                    apiKey: preset.apiKey,
                    model: preset.model,
                    secondaryProxyUrl: preset.secondaryProxyUrl,
                    secondaryApiKey: preset.secondaryApiKey,
                    secondaryModel: preset.secondaryModel,
                    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡è¼‰å…¥ç¼ºå¤±çš„TTSè¨­ç½® â–¼â–¼â–¼
                    minimaxGroupId: preset.minimaxGroupId,
                    minimaxApiKey: preset.minimaxApiKey,
                    minimaxModel: preset.minimaxModel
                    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
                };
                // å°‡è¼‰å…¥çš„é…ç½®ä¿å­˜ç‚ºç•¶å‰æ­£åœ¨ä½¿ç”¨çš„é…ç½®
                await db.apiConfig.put(state.apiConfig);
                // é‡æ–°æ¸²æŸ“æ•´å€‹è¨­ç½®é é¢ä»¥é¡¯ç¤ºæ–°è¼‰å…¥çš„é…ç½®
                renderApiSettings();
                // è‡ªå‹•ç‚ºæ–°è¼‰å…¥çš„é…ç½®æ‹‰å–æ¨¡å‹æ¸…å–®
                document.getElementById('fetch-models-btn').click();
                if (preset.secondaryProxyUrl && preset.secondaryApiKey) {
                    document.getElementById('fetch-secondary-models-btn').click();
                }
                alert(`å·²è¼‰å…¥é è¨­ â€œ${preset.name}â€`);
            }
        }
        
        /**
         * å°‡ç•¶å‰è¼¸å…¥æ¡†ä¸­çš„é…ç½®ä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
         */
        async function saveApiPreset() {
            const name = await showCustomPrompt('ä¿å­˜ API é è¨­', 'è«‹è¼¸å…¥é è¨­åç¨±');
            if (!name || !name.trim()) return;
        
            // å¾è¼¸å…¥æ¡†è®€å–ç•¶å‰é…ç½®
            const presetData = {
                name: name.trim(),
                proxyUrl: document.getElementById('proxy-url').value.trim(),
                apiKey: document.getElementById('api-key').value.trim(),
                model: document.getElementById('model-select').value,
                secondaryProxyUrl: document.getElementById('secondary-proxy-url').value.trim(),
                secondaryApiKey: document.getElementById('secondary-api-key').value.trim(),
                secondaryModel: document.getElementById('secondary-model-select').value,
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ·»åŠ ç¼ºå¤±çš„TTSè¨­ç½® â–¼â–¼â–¼
                minimaxGroupId: document.getElementById('minimax-group-id').value.trim(),
                minimaxApiKey: document.getElementById('minimax-api-key').value.trim(),
                minimaxModel: document.getElementById('minimax-model-select').value
                // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
            };
        
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé è¨­
            const existingPreset = await db.apiPresets.where('name').equals(presetData.name).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†è“‹é è¨­', `åç‚º â€œ${presetData.name}â€ çš„é è¨­å·²å­˜åœ¨ã€‚è¦è¦†è“‹å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                presetData.id = existingPreset.id; // æŒ‡å®šIDä»¥è¦†è“‹èˆŠè³‡æ–™
            }
        
            await db.apiPresets.put(presetData);
            await loadApiPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
            alert('API é è¨­å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆªé™¤ç•¶å‰é¸ä¸­çš„é è¨­
         */
        async function deleteApiPreset() {
            const selectEl = document.getElementById('api-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„é è¨­ã€‚');
                return;
            }
        
            const preset = await db.apiPresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', `ç¢ºå®šè¦åˆªé™¤é è¨­ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.apiPresets.delete(selectedId);
                await loadApiPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
                alert('é è¨­å·²åˆªé™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderApiSettings å‡½æ•¸ â–¼â–¼â–¼
        function renderApiSettings() { 
            // 1. æ¸²æŸ“ç•¶å‰é…ç½®åˆ°è¼¸å…¥æ¡†
            document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; 
            document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
            document.getElementById('secondary-proxy-url').value = state.apiConfig.secondaryProxyUrl || '';
            document.getElementById('secondary-api-key').value = state.apiConfig.secondaryApiKey || '';
            document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
            document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
            document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
            document.getElementById('enable-ai-drawing-switch').checked = state.globalSettings.enableAiDrawing; 
            document.getElementById('chat-render-window-input').value = state.globalSettings.chatRenderWindow || 50;   
            document.getElementById('chat-list-render-window-input').value = state.globalSettings.chatListRenderWindow || 30;
            const tempSlider = document.getElementById('api-temperature-slider');
            const tempValue = document.getElementById('api-temperature-value');
            const savedTemp = state.globalSettings.apiTemperature || 0.8;
            tempSlider.value = savedTemp;
            tempValue.textContent = savedTemp;    
           document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
           document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
document.getElementById('minimax-model-select').value = state.apiConfig.minimaxModel || 'speech-01'; // <-- æ–°å¢é€™ä¸€è¡Œ
            // 2. ã€æ ¸å¿ƒæ–°å¢ã€‘è¼‰å…¥ä¸¦æ¸²æŸ“é è¨­ä¸‹æ‹‰å¼åŠŸèƒ½è¡¨
            loadApiPresetsDropdown();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                window.renderApiSettingsProxy = renderApiSettings;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯NPCç®¡ç†åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ | å·²ä¿®å¾©é•·æŒ‰äº‹ä»¶ã€‘æ¸²æŸ“NPCæ¸…å–®è¢å¹•
 */
async function renderNpcListScreen() {
    const listEl = document.getElementById('npc-list');
    listEl.innerHTML = '';
    
    const npcs = await db.npcs.toArray();

    if (npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰å‰µå»ºä»»ä½•NPCï¼Œ<br>é»æ“Šå³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€å€‹å§ï¼</p>';
        return;
    }

    npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.dataset.npcId = npc.id;
        
        item.innerHTML = `
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar" style="border-radius: 50%;">
            <div class="info">
                <div class="name-line">
                    <span class="name">${npc.name}</span>
                </div>
                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
            </div>
        `;
        
        item.addEventListener('click', () => openNpcEditor(npc.id));
        
        // ã€æ ¸å¿ƒä¿®å¾©ã€‘ç¢ºä¿ addLongPressListener çš„å›å‘¼å‡½æ•¸æ˜¯ async å‡½æ•¸
        addLongPressListener(item, async () => {
            await deleteNpc(npc.id);
        });
        
        listEl.appendChild(item);
    });
}

/**
         * ã€å·²æ›´æ–°ã€‘æ‰“é–‹NPCç·¨è¼¯å™¨ï¼ˆç”¨æ–¼æ–°å»ºæˆ–ç·¨è¼¯ï¼‰
         * @param {number|null} npcId - å¦‚æœæ˜¯ç·¨è¼¯ï¼Œå‰‡å‚³å…¥IDï¼›å¦‚æœæ˜¯æ–°å»ºï¼Œå‰‡ç‚ºnull
         */
        async function openNpcEditor(npcId = null) {
            editingNpcId = npcId;
            const modal = document.getElementById('npc-editor-modal');
            const titleEl = document.getElementById('npc-editor-title');
            const nameInput = document.getElementById('npc-name-input');
            const personaInput = document.getElementById('npc-persona-input');
            const avatarPreview = document.getElementById('npc-avatar-preview');
            const associationListEl = document.getElementById('npc-association-list');
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘ç²å–æ–°æ·»åŠ çš„é–‹é—œå’Œè¼¸å…¥æ¡†å…ƒç´ 
            const activitySwitch = document.getElementById('npc-background-activity-switch');
            const cooldownInput = document.getElementById('npc-action-cooldown-input');
            
            associationListEl.innerHTML = ''; // æ¸…ç©ºèˆŠçš„é—œè¯åˆ—è¡¨

            // ç”Ÿæˆå¯é—œè¯çš„è§’è‰²æ¸…å–® (é‚è¼¯ä¸è®Š)
            associationListEl.innerHTML += `<label><input type="checkbox" value="user"> ${state.qzoneSettings.nickname || 'æˆ‘'} (ç”¨æˆ¶)</label>`;
            Object.values(state.chats).filter(c => !c.isGroup).forEach(char => {
                associationListEl.innerHTML += `<label><input type="checkbox" value="${char.id}"> ${char.name} (è§’è‰²)</label>`;
            });

            if (npcId) {
                // ç·¨è¼¯æ¨¡å¼
                titleEl.textContent = 'ç·¨è¼¯ NPC';
                const npc = await db.npcs.get(npcId);
                if (npc) {
                    nameInput.value = npc.name;
                    personaInput.value = npc.persona;
                    avatarPreview.src = npc.avatar || defaultGroupMemberAvatar;

                    // ã€æ ¸å¿ƒæ–°å¢ã€‘è®€å–ä¸¦æ‡‰ç”¨å·²ä¿å­˜çš„è¨­ç½®
                    // ä½¿ç”¨ !== false åˆ¤æ–·ï¼Œç¢ºä¿æ–°å‰µå»ºçš„ã€æ²’æœ‰è©²æ¬„ä½çš„NPCé»˜èªç‚ºé–‹å•Ÿ
                    activitySwitch.checked = npc.enableBackgroundActivity !== false; 
                    cooldownInput.value = npc.actionCooldownMinutes || 15;

                    if (npc.associatedWith && Array.isArray(npc.associatedWith)) {
                        npc.associatedWith.forEach(id => {
                            const checkbox = associationListEl.querySelector(`input[value="${id}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            } else {
                // æ–°å»ºæ¨¡å¼
                titleEl.textContent = 'æ·»åŠ  NPC';
                nameInput.value = '';
                personaInput.value = '';
                avatarPreview.src = defaultGroupMemberAvatar;

                // ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºæ–°NPCè¨­ç½®é è¨­å€¼
                activitySwitch.checked = true; // é»˜èªé–‹å•Ÿ
                cooldownInput.value = 15;     // é»˜èª15åˆ†é˜

                const userCheckbox = associationListEl.querySelector('input[value="user"]');
                if (userCheckbox) userCheckbox.checked = true;
            }

            modal.classList.add('visible');
        }

// â–¼â–¼â–¼ ã€V2.1 | é ­åƒä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ saveNpc å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å·²æ›´æ–°ã€‘ä¿å­˜NPCè³‡è¨Šï¼Œä¸¦èƒ½è™•ç†â€œå‰µå»ºå¾Œç›´æ¥åŠ å…¥ç¾¤èŠâ€çš„æµç¨‹
 */
async function saveNpc() {
    const name = document.getElementById('npc-name-input').value.trim();
    const persona = document.getElementById('npc-persona-input').value.trim();
    if (!name || !persona) {
        alert("NPCçš„æ˜µç¨±å’Œäººè¨­éƒ½ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }

    const selectedAssociations = Array.from(document.querySelectorAll('#npc-association-list input:checked')).map(cb => cb.value);
    const enableBackgroundActivity = document.getElementById('npc-background-activity-switch').checked;
    const actionCooldownMinutes = parseInt(document.getElementById('npc-action-cooldown-input').value) || 15;

    const npcData = {
        name,
        persona,
        avatar: document.getElementById('npc-avatar-preview').src,
        associatedWith: selectedAssociations,
        enableBackgroundActivity: enableBackgroundActivity,
        actionCooldownMinutes: actionCooldownMinutes
    };

    if (editingNpcId) {
        await db.npcs.update(editingNpcId, npcData);
    } else {
        // æ–°å»ºNPC
        const newNpcId = await db.npcs.add(npcData);

        if (isAddingNpcToGroup && state.activeChatId) {
            const chat = state.chats[state.activeChatId];
            if (chat.isGroup) {
                // ã€ã€ã€é€™å°±æ˜¯æœ€é—œéµçš„ä¿®å¾©ï¼ã€‘ã€‘ã€‘
                // åœ¨é€™è£¡ï¼Œæˆ‘å€‘ä¹ŸæŠŠ npcData.avatar æ·»åŠ åˆ°äº†æˆå“¡å°è±¡ä¸­
                chat.members.push({
                    id: `npc_${newNpcId}`,
                    originalName: name,
                    groupNickname: name,
                    persona: persona,
                    avatar: npcData.avatar, // <-- æ ¸å¿ƒæ–°å¢
                    isNpc: true
                });
                await db.chats.put(chat);
            }
        }
    }
    
    document.getElementById('npc-editor-modal').classList.remove('visible');
    
    if (isAddingNpcToGroup) {
        isAddingNpcToGroup = false; 
        openMemberManagementScreen();
    } else {
        await renderNpcListScreen();
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * åˆªé™¤NPC
 * @param {number} npcId - è¦åˆªé™¤çš„NPCçš„ID
 */
async function deleteNpc(npcId) {
    const npc = await db.npcs.get(npcId);
    if (!npc) return;
    const confirmed = await showCustomConfirm('åˆªé™¤NPC', `ç¢ºå®šè¦åˆªé™¤NPC â€œ${npc.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.npcs.delete(npcId);
        await renderNpcListScreen();
    }
}
// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²å‡ç´šâ€œåˆ†æ‰¹è¼‰å…¥â€åŠŸèƒ½çš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderChatList å‡½æ•¸ â–¼â–¼â–¼
        let chatListRenderCount = 0; // æ–°å¢ä¸€å€‹å…¨åŸŸè®Šæ•¸ï¼Œè·Ÿè¹¤å·²æ¸²æŸ“çš„æ•¸é‡

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œæŒ‰éœ€è¼‰å…¥â€æ–°å¢çš„æ‰€æœ‰è¼”åŠ©å‡½æ•¸ â–¼â–¼â–¼

/**
 * å‰µå»ºä¸€å€‹åˆ†çµ„çš„å®¹å™¨ï¼ˆä¸åŒ…å«èŠå¤©é …ï¼‰
 */
function createChatGroupContainer(group) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'chat-group-container';
    groupContainer.innerHTML = `
        <div class="chat-group-header">
            <span class="arrow">â–¼</span>
            <span class="group-name">${group.name}</span>
        </div>
        <div class="chat-group-content"></div>
    `;
    return groupContainer;
}



/**
 * è¼‰å…¥ä¸¦æ¸²æŸ“ä¸‹ä¸€æ‰¹æ¬¡çš„èŠå¤©è¨˜éŒ„
 */
function loadMoreChats(sortedItems) {
    const chatListEl = document.getElementById('chat-list');
    const loadMoreBtn = document.getElementById('load-more-chats-btn');
    if (loadMoreBtn) loadMoreBtn.remove();
    
    const nextSliceStart = chatListRenderCount;
    const nextSliceEnd = chatListRenderCount + CHAT_LIST_RENDER_WINDOW;
    const itemsToAppend = sortedItems.slice(nextSliceStart, nextSliceEnd);

    // ä½¿ç”¨ DocumentFragment æé«˜æ€§èƒ½
    const fragment = document.createDocumentFragment();
    let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

    itemsToAppend.forEach(item => {
        if (item.type === 'groupHeader') {
            const groupContainer = createChatGroupContainer(item.group);
            fragment.appendChild(groupContainer);
            currentGroupContent = groupContainer.querySelector('.chat-group-content');
        } else if (item.type === 'chatItem') {
            const listItem = createChatListItem(item.chat);
            if (currentGroupContent && item.chat.groupId) {
                currentGroupContent.appendChild(listItem);
            } else {
                fragment.appendChild(listItem);
                currentGroupContent = null;
            }
        }
    });
    
    // å°‡æ–°ç”Ÿæˆçš„é …ä¸€æ¬¡æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    chatListEl.appendChild(fragment);
    chatListRenderCount += itemsToAppend.length;

    if (sortedItems.length > chatListRenderCount) {
        appendLoadMoreChatsButton(chatListEl, sortedItems);
    }
    
    // é‡æ–°ç‚ºæ‰€æœ‰åˆ†çµ„æ¨™é¡Œç¶å®šäº‹ä»¶
    document.querySelectorAll('.chat-group-header').forEach(header => {
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
        newHeader.addEventListener('click', () => {
            newHeader.classList.toggle('collapsed');
            newHeader.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–° | å·²å‡ç´šâ€œåˆ†æ‰¹è¼‰å…¥â€åŠŸèƒ½ã€‘è«‹ç”¨é€™å€‹å…¨æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ renderChatList å‡½æ•¸ â–¼â–¼â–¼
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. ç²å–ä¸¦æ’åºæ‰€æœ‰èŠå¤©è³‡æ–™ï¼ˆé€™éƒ¨åˆ†é‚è¼¯ä¸è®Šï¼‰
    const allChats = Object.values(state.chats).sort((a, b) => {
        const pinDiff = (b.isPinned || false) - (a.isPinned || false);
        if (pinDiff !== 0) return pinDiff;
        return (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0);
    });
    
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’ "+" æˆ–ç¾¤çµ„åœ–ç¤ºæ·»åŠ èŠå¤©</p>';
        return;
    }

    allGroups.forEach(group => {
        const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
    
    // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡æ‰€æœ‰å¯æ¸²æŸ“é …å­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œè€Œä¸æ˜¯ç«‹å³æ¸²æŸ“
    sortedChatListItems = []; // å…ˆæ¸…ç©º
    const processedChatIds = new Set();

    allGroups.forEach(group => {
        const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
        if (groupChats.length > 0) {
            sortedChatListItems.push({ type: 'groupHeader', group });
            groupChats.forEach(chat => {
                sortedChatListItems.push({ type: 'chatItem', chat });
                processedChatIds.add(chat.id);
            });
        }
    });

    allChats.forEach(chat => {
        if (!processedChatIds.has(chat.id)) {
            sortedChatListItems.push({ type: 'chatItem', chat });
        }
    });

    // 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘é‡ç½®æ¸²æŸ“è¨ˆæ•¸å™¨ï¼Œä¸¦åªæ¸²æŸ“ç¬¬ä¸€æ‰¹æ¬¡çš„èŠå¤©é …
    chatListRenderCount = 0;
    loadMoreChats(); // ç›´æ¥èª¿ç”¨ loadMoreChats ä¾†æ¸²æŸ“ç¬¬ä¸€é 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œåˆ†æ‰¹è¼‰å…¥â€æ–°å¢çš„æ‰€æœ‰è¼”åŠ©å‡½æ•¸ â–¼â–¼â–¼

        /**
         * å‰µå»ºä¸€å€‹åˆ†çµ„çš„å®¹å™¨ï¼ˆä¸åŒ…å«èŠå¤©é …ï¼‰
         */
        function createChatGroupContainer(group) {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'chat-group-container';
            groupContainer.innerHTML = `
                <div class="chat-group-header">
                    <span class="arrow">â–¼</span>
                    <span class="group-name">${group.name}</span>
                </div>
                <div class="chat-group-content"></div>
            `;
            return groupContainer;
        }

        /**
         * å‰µå»ºä¸¦æ·»åŠ â€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ•
         */
        function appendLoadMoreChatsButton(container, sortedItems) {
            const button = document.createElement('button');
            button.id = 'load-more-chats-btn';
            button.textContent = 'è¼‰å…¥æ›´æ—©çš„æœƒè©±';
            button.className = 'load-more-btn'; // è¤‡ç”¨æ¨£å¼
            
            // ã€é‡è¦ã€‘ç‚ºæŒ‰éˆ•ç¶å®šè¼‰å…¥ä¸‹ä¸€é çš„äº‹ä»¶
            button.addEventListener('click', () => loadMoreChats(sortedItems), { once: true });
            
            container.prepend(button); // å°‡æŒ‰éˆ•æ·»åŠ åˆ°æ¸…å–®é ‚éƒ¨
        }

// â–¼â–¼â–¼ ã€å…¨æ–° | ç¨ç«‹è¨­ç½®+è¼‰å…¥å‹•ç•«ç‰ˆã€‘è«‹ç”¨é€™å€‹ç‰ˆæœ¬æ›¿æ›èˆŠçš„ loadMoreChats å‡½æ•¸ â–¼â–¼â–¼
        function loadMoreChats() {
            if (isLoadingMoreChats) return;

            const chatListEl = document.getElementById('chat-list');
            const scrollContainer = document.getElementById('messages-view');
            if (!chatListEl || !scrollContainer) return;
            if (chatListRenderCount >= sortedChatListItems.length) return;

            isLoadingMoreChats = true;

            // æ ¸å¿ƒä¿®æ”¹1ï¼šåˆ¤æ–·æ˜¯å¦æ˜¯é¦–æ¬¡è¼‰å…¥
            const isInitialLoad = chatListRenderCount === 0;

            // å°‡æ ¸å¿ƒæ¸²æŸ“é‚è¼¯å°è£æˆä¸€å€‹å‡½æ•¸
            const renderContent = () => {
                hideLoader(chatListEl);

                const renderWindow = state.globalSettings.chatListRenderWindow || 30;
                const nextSliceStart = chatListRenderCount;
                const nextSliceEnd = chatListRenderCount + renderWindow;
                const itemsToAppend = sortedChatListItems.slice(nextSliceStart, nextSliceEnd);

                const fragment = document.createDocumentFragment();
                let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

                itemsToAppend.forEach(item => {
                    if (item.type === 'groupHeader') {
                        const groupContainer = createChatGroupContainer(item.group);
                        fragment.appendChild(groupContainer);
                        currentGroupContent = groupContainer.querySelector('.chat-group-content');
                    } else if (item.type === 'chatItem') {
                        const listItem = createChatListItem(item.chat);
                        if (item.chat.groupId && currentGroupContent) {
                            currentGroupContent.appendChild(listItem);
                        } else {
                            fragment.appendChild(listItem);
                            if (!item.chat.groupId) currentGroupContent = null;
                        }
                    }
                });

                chatListEl.appendChild(fragment);
                chatListRenderCount += itemsToAppend.length;

                chatListEl.querySelectorAll('.chat-group-header:not([data-has-listener="true"])').forEach(header => {
                    header.dataset.hasListener = "true";
                    header.addEventListener('click', () => {
                        header.classList.toggle('collapsed');
                        header.nextElementSibling.classList.toggle('collapsed');
                    });
                });

                isLoadingMoreChats = false;

                if (scrollContainer.scrollHeight <= scrollContainer.clientHeight && chatListRenderCount < sortedChatListItems.length) {
                    loadMoreChats();
                }
            };

            // æ ¸å¿ƒä¿®æ”¹2ï¼šæ ¹æ“šæ˜¯å¦æ˜¯é¦–æ¬¡è¼‰å…¥ï¼Œæ±ºå®šæ˜¯å¦ä½¿ç”¨å»¶é²
            if (isInitialLoad) {
                // å¦‚æœæ˜¯é¦–æ¬¡è¼‰å…¥ï¼Œå‰‡ç«‹å³åŸ·è¡Œæ¸²æŸ“ï¼Œæ²’æœ‰ä»»ä½•å»¶é²
                renderContent();
            } else {
                // å¦‚æœæ˜¯å¾ŒçºŒè¼‰å…¥ï¼ˆæ»¾å‹•æ™‚ï¼‰ï¼Œå‰‡é¡¯ç¤ºè¼‰å…¥å‹•ç•«ä¸¦ä¿ç•™å»¶é²ï¼Œä»¥å„ªåŒ–é«”é©—
                showLoader(chatListEl, 'bottom');
                setTimeout(renderContent, 500);
            }
        }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² 
// â–¼â–¼â–¼ ã€å…¨æ–° | V2.0 å®¹éŒ¯å¢å¼·ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ createChatListItem å‡½æ•¸ â–¼â–¼â–¼
function createChatListItem(chat) {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ä½¿ç”¨ try...catch åŒ…è£¹æ•´å€‹å‡½æ•¸
    try {
        const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
        let lastMsgDisplay;

        if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
            lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è«‹] ${chat.relationship.applicationReason || 'è«‹æ±‚æ·»åŠ ä½ ç‚ºå¥½å‹'}</span>`;
        } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
            lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å°æ–¹æ‹‰é»‘]</span>`;
        } else if (chat.isGroup) {
            if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ç³»çµ±æ¶ˆæ¯] ${lastMsgObj.content}`; }
            else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½‰å¸³]'; }
            else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
            else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[èªéŸ³]'; }
            else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
            else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[åœ–ç‰‡]`; }
            else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }

            if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
                const senderDisplayName = getDisplayNameInGroup(chat, lastMsgObj.senderName);
                lastMsgDisplay = `${senderDisplayName}: ${lastMsgDisplay}`;
            }
        } else {
            const statusText = chat.status?.text || 'ç·šä¸Š';
            lastMsgDisplay = `[${statusText}]`;
        }

        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.dataset.chatId = chat.id;
        if (chat.isPinned) {
            item.classList.add('pinned');
        }

        const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
        const avatarFrameSrc = chat.isGroup ? '' : (chat.settings.aiAvatarFrame || '');
        let avatarHtml;
        if (avatarFrameSrc) {
            avatarHtml = `<div class="avatar-with-frame"><img src="${avatar || defaultAvatar}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
        } else {
            avatarHtml = `<img src="${avatar || defaultAvatar}" class="avatar">`;
        }
        const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
        const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

        item.innerHTML = `
            ${avatarGroupHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${chat.name}</span>
                    ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
                </div>
                <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
            </div>
            <div class="unread-count-wrapper">
                <span class="unread-count" style="display: none;">0</span>
            </div>
        `;
        
        const unreadCount = chat.unreadCount || 0;
        const unreadEl = item.querySelector('.unread-count');
        if (unreadCount > 0) {
            unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
            unreadEl.style.display = 'inline-flex';
        } else {
            unreadEl.style.display = 'none';
        }
        
        const avatarGroupEl = item.querySelector('.avatar-group');
        if (avatarGroupEl) {
            avatarGroupEl.style.cursor = 'pointer';
            avatarGroupEl.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                const nameToPat = chat.isGroup ? chat.name : chat.originalName;
                handleUserPat(chat.id, nameToPat);
            });
        }
        
        const infoEl = item.querySelector('.info');
        if (infoEl) {
            infoEl.addEventListener('click', () => openChat(chat.id));
        }
    
        addLongPressListener(item, async (e) => {
            const action = await showChatListActions(chat);
            switch (action) {
                case 'pin':
                    chat.isPinned = !chat.isPinned;
                    await db.chats.put(chat);
                    renderChatList();
                    break;
                case 'delete':
                    const deleteConfirmed = await showCustomConfirm('åˆªé™¤å°è©±', `ç¢ºå®šè¦åˆªé™¤èˆ‡ "${chat.name}" çš„æ•´å€‹å°è©±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚`, { confirmButtonClass: 'btn-danger' });
                    if (deleteConfirmed) {
                        if (musicState.isActive && musicState.activeChatId === chat.id) {
                            await endListenTogetherSession(false);
                        }
                        delete state.chats[chat.id];
                        if (state.activeChatId === chat.id) state.activeChatId = null;
                        await db.chats.delete(chat.id);
                        renderChatList();
                    }
                    break;
                default:
                    break;
            }
        });
        return item;

    } catch (error) {
        // ã€æ ¸å¿ƒæ–°å¢ã€‘å¦‚æœæ¸²æŸ“éç¨‹ä¸­å‡ºéŒ¯ï¼Œå°±åœ¨æ§åˆ¶å°åˆ—å°éŒ¯èª¤ï¼Œä¸¦è¿”å› null
        console.error(`æ¸²æŸ“èŠå¤©é … [${chat.name || 'æœªçŸ¥'}] (ID: ${chat.id}) æ™‚å‡ºéŒ¯:`, error);
        return null; // è¿”å› nullï¼Œé€™æ¨£å°±ä¸æœƒæŠŠä¸€å€‹å£æ‰çš„å…ƒç´ æ·»åŠ åˆ°é é¢ä¸Š
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€ç„¡é™æ»¾å‹•ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ renderChatInterface å‡½æ•¸ â–¼â–¼â–¼
        async function renderChatInterface(chatId) {
            applyButtonOrder();
            cleanupWaimaiTimers();
            const chat = state.chats[chatId];
            if (!chat) return;

            exitSelectionMode();

            const messagesContainer = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const lockOverlay = document.getElementById('chat-lock-overlay');
            const lockContent = document.getElementById('chat-lock-content');

            messagesContainer.dataset.theme = chat.settings.theme || 'default';
            const fontSize = chat.settings.fontSize || 13;
            messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
            applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');

            document.getElementById('chat-header-title').textContent = chat.name;
            const statusContainer = document.getElementById('chat-header-status');
            const statusTextEl = statusContainer.querySelector('.status-text');

            if (chat.isGroup) {
                statusContainer.style.display = 'none';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
            } else {
                statusContainer.style.display = 'flex';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
                statusTextEl.textContent = chat.status?.text || 'ç·šä¸Š';
                statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
            }

            const chatScreen = document.getElementById('chat-interface-screen');
            const individualBg = chat.settings.background;
            const globalBg = state.globalSettings.globalChatBackground;
            const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
            const defaultColor = isDarkMode ? '#000000' : '#f0f2f5';

            if (individualBg) {
                chatScreen.style.backgroundImage = `url(${individualBg})`;
                chatScreen.style.backgroundColor = 'transparent';
            } else if (globalBg) {
                chatScreen.style.backgroundImage = `url(${globalBg})`;
                chatScreen.style.backgroundColor = 'transparent';
            } else {
                chatScreen.style.backgroundImage = 'none';
                chatScreen.style.backgroundColor = defaultColor;
            }

            // ... (ä¸­é–“æ‰€æœ‰é—œæ–¼é–å®šã€æ—è§€æ¨¡å¼çš„ if/else é‚è¼¯ä¿æŒä¸è®Š) ...
            if (chat.isSpectatorGroup) {
                chatInputArea.style.display = 'none';
                lockOverlay.style.display = 'flex';
                lockContent.innerHTML = `
                    <span class="lock-text">æ­£åœ¨åœè§€AIå€‘çš„ç¾¤èŠ...</span>
                    <div class="spectator-actions-container">
                        <button id="spectator-reroll-btn" class="lock-action-btn secondary" title="é‡æ–°ç”Ÿæˆä¸Šä¸€è¼ªå°è©±">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <button id="spectator-propel-btn" class="lock-action-btn">ğŸ¬ æ¨é€²åŠ‡æƒ…</button>
                        <button id="spectator-edit-btn" class="lock-action-btn secondary" title="å°æ¼”å‰ªè¼¯å®¤ï¼šç·¨è¼¯AIä¸Šä¸€è¼ªçš„å›æ‡‰">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                                <line x1="16" y1="8" x2="2" y2="22"></line>
                                <line x1="17.5" y1="15" x2="9" y2="15"></line>
                            </svg>
                        </button>
                    </div>
                `;
                document.getElementById('spectator-propel-btn').onclick = triggerSpectatorGroupAiAction;
            } else {
                chatInputArea.style.display = 'flex';
                lockOverlay.style.display = 'none';
                lockContent.innerHTML = '';
                if (!chat.isGroup && chat.relationship.status !== 'friend') {
                    lockOverlay.style.display = 'flex';
                    chatInputArea.style.visibility = 'hidden';
                    
                    let lockHtml = '';
                    switch (chat.relationship.status) {
                         case 'blocked_by_user':
                            const isSimulationRunning = simulationIntervalId !== null;
                            const blockedTimestamp = chat.relationship.blockedTimestamp;
                            const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                            const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                            const timeSinceBlock = Date.now() - blockedTimestamp;
                            const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                            const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));
            
                            lockHtml = `
                                <span class="lock-text">ä½ å·²å°‡â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
                                <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                                <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                    <strong style="color: #333;">ã€é–‹ç™¼è€…è¨ºæ–·é¢æ¿ã€‘</strong><br>
                                    - å¾Œè‡ºæ´»å‹•ç¸½é–‹é—œ: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²é–‹å•Ÿ</span>' : '<span style="color: red;">å·²é—œé–‰</span>'}<br>
                                    - ç³»çµ±å¿ƒè·³è¨ˆæ™‚å™¨: ${isSimulationRunning ? '<span style="color: green;">é‹è¡Œä¸­</span>' : '<span style="color: red;">æœªé‹è¡Œ</span>'}<br>
                                    - ç•¶å‰è§’è‰²ç‹€æ…‹: <strong>${chat.relationship.status}</strong><br>
                                    - éœ€è¦å†·éœ(å°æ™‚): <strong>${cooldownHours}</strong><br>
                                    - å†·éœæœŸæ˜¯å¦çµæŸ: ${isCooldownOver ? '<span style="color: green;">æ˜¯</span>' : `<span style="color: orange;">å¦ (é‚„å‰©ç´„ ${timeRemainingMinutes} åˆ†é˜)</span>`}<br>
                                    - è§¸ç™¼æ¢ä»¶: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²æ»¿è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»çµ±å¿ƒè·³</span>' : '<span style="color: red;">æœªæ»¿è¶³</span>'}
                                </div>
                                <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡å¥½å‹ç”³è«‹æª¢æ¸¬</button>
                            `;
                            break;
                        case 'blocked_by_ai':
                            lockHtml = `
                                <span class="lock-text">ä½ è¢«å°æ–¹æ‹‰é»‘äº†ã€‚</span>
                                <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è«‹åŠ ç‚ºå¥½å‹</button>
                            `;
                            break;
                        case 'pending_user_approval':
                            lockHtml = `
                                <span class="lock-text">â€œ${chat.name}â€è«‹æ±‚æ·»åŠ ä½ ç‚ºå¥½å‹ï¼š<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
                                <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
                                <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’çµ•</button>
                            `;
                            break;
                        case 'pending_ai_approval':
                            lockHtml = `<span class="lock-text">å¥½å‹ç”³è«‹å·²ç™¼é€ï¼Œç­‰å¾…å°æ–¹é€šé...</span>`;
                            break;
                    }
                    lockContent.innerHTML = lockHtml;
                } else {
                     lockOverlay.style.display = 'none';
                     chatInputArea.style.visibility = 'visible';
                }
            }
            
            messagesContainer.innerHTML = '';
            const history = chat.history;
            currentRenderedCount = 0;
            const renderWindow = state.globalSettings.chatRenderWindow || 50;
            const initialMessages = history.slice(-renderWindow);

            // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ â–¼â–¼â–¼ ---
            // 1. å‰µå»ºä¸€å€‹é™£åˆ—ä¾†å­˜æ”¾æ‰€æœ‰â€œå‰µå»ºæ¶ˆæ¯å…ƒç´ â€çš„éåŒæ­¥ä»»å‹™ (Promise)
            const messagePromises = [];
            let lastTimestamp = 0;

            for (const msg of initialMessages) {
                if (lastTimestamp > 0 && (msg.timestamp - lastTimestamp > 600000)) {
                    // æ™‚é–“æˆ³è¨˜æ˜¯åŒæ­¥å‰µå»ºçš„ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ 
                    messagePromises.push(Promise.resolve(createSystemTimestampElement(msg.timestamp)));
                }
                // 2. å°‡éåŒæ­¥ä»»å‹™æ¨å…¥é™£åˆ—ï¼Œä½†ä¸åœ¨é€™è£¡ç­‰å¾…å®ƒå®Œæˆ
                messagePromises.push(createMessageElement(msg, chat, true));
                lastTimestamp = msg.timestamp;
            }

            // 3. ä½¿ç”¨ Promise.all() ä½µç™¼åŸ·è¡Œæ‰€æœ‰çš„éåŒæ­¥ä»»å‹™
            const messageElements = await Promise.all(messagePromises);

            // 4. æ‰€æœ‰ä»»å‹™å®Œæˆå¾Œï¼Œä¸€æ¬¡æ€§å°‡æ‰€æœ‰å‰µå»ºå¥½çš„å…ƒç´ æ·»åŠ åˆ°é é¢ä¸­
            const fragment = document.createDocumentFragment();
            messageElements.filter(Boolean).forEach(el => fragment.appendChild(el));
            messagesContainer.appendChild(fragment);
            // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---

            currentRenderedCount = initialMessages.length;

            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.style.display = 'none';
            typingIndicator.textContent = 'å°æ–¹æ­£åœ¨è¼¸å…¥...';
            messagesContainer.appendChild(typingIndicator);

            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
        }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                
        
// â–¼â–¼â–¼ ã€ç„¡é™æ»¾å‹•ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ loadMoreMessages å‡½æ•¸ â–¼â–¼â–¼
async function loadMoreMessages() {
    if (isLoadingMoreMessages) return;
    isLoadingMoreMessages = true;

    const messagesContainer = document.getElementById('chat-messages');
    const chat = state.chats[state.activeChatId];
    if (!chat) {
        isLoadingMoreMessages = false;
        return;
    }

    showLoader(messagesContainer, 'top'); // åœ¨é ‚éƒ¨é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    const oldScrollHeight = messagesContainer.scrollHeight;

    // é¡æ¯”ç¶²è·¯å»¶é²ï¼Œè®“å‹•ç•«æ›´æ˜é¡¯
    await new Promise(resolve => setTimeout(resolve, 500));

    const totalMessages = chat.history.length;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const nextSliceStart = totalMessages - currentRenderedCount - renderWindow;
    const nextSliceEnd = totalMessages - currentRenderedCount;
    const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd);


    // 1. ç²å–ç•¶å‰è¢å¹•ä¸Šæœ€â€œè€â€çš„é‚£æ¢æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜ï¼Œä½œç‚ºæˆ‘å€‘æ¯”è¼ƒçš„åŸºæº–
    const firstVisibleMessage = messagesContainer.querySelector('.message-wrapper[data-timestamp]');
    let nextMessageTimestamp = firstVisibleMessage ? parseInt(firstVisibleMessage.dataset.timestamp) : 0;

    // 2. ä¾ç„¶æ˜¯å¾æ–°åˆ°èˆŠåœ°éæ­·æˆ‘å€‘è¦æ·»åŠ çš„æ¶ˆæ¯
    for (const msg of messagesToPrepend.reverse()) {
        
        // 3. ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨æ·»åŠ æ¯æ¢æ¶ˆæ¯ä¹‹å‰ï¼Œéƒ½æª¢æŸ¥å®ƒå’Œå®ƒå¾Œé¢é‚£æ¢æ¶ˆæ¯çš„æ™‚é–“å·®
        if (nextMessageTimestamp > 0 && (nextMessageTimestamp - msg.timestamp > 600000)) { // 600000æ¯«ç§’ = 10åˆ†é˜
            // å¦‚æœé–“éš”å¤§æ–¼10åˆ†é˜ï¼Œå°±ç‚ºâ€œæ›´æ™šâ€çš„é‚£æ¢æ¶ˆæ¯å‰µå»ºä¸€å€‹æ™‚é–“æç¤º
            const timestampEl = createSystemTimestampElement(nextMessageTimestamp);
            // å°‡æ™‚é–“æç¤ºä¹Ÿæ·»åŠ åˆ°é ‚éƒ¨
            messagesContainer.prepend(timestampEl);
        }
        
        // 4. æ·»åŠ æ¶ˆæ¯æœ¬èº«ï¼ˆé€™éƒ¨åˆ†é‚è¼¯ä¸è®Šï¼‰
        await prependMessage(msg, chat);
        
        // 5. æ›´æ–°æˆ‘å€‘çš„æ™‚é–“åŸºæº–ï¼Œç‚ºä¸‹ä¸€æ¬¡è¿´åœˆåšæº–å‚™
        nextMessageTimestamp = msg.timestamp;
    }

    currentRenderedCount += messagesToPrepend.length;

    // æ¢å¾©æ»¾å‹•ä½ç½®ï¼Œé˜²æ­¢è·³å‹•
    const newScrollHeight = messagesContainer.scrollHeight;
    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

    hideLoader(messagesContainer); // è¼‰å…¥å®Œæˆå¾Œéš±è—å‹•ç•«
    isLoadingMoreMessages = false;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²æ›´æ–°çš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderWallpaperScreen å‡½æ•¸ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderWallpaperScreen å‡½æ•¸ â–¼â–¼â–¼
function renderWallpaperScreen() {
    loadCssPresetsDropdown();
loadAppearancePresetsDropdown();
    // --- EPhone å£ç´™é è¦½ ---
    const ephonePreview = document.getElementById('wallpaper-preview');
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘æˆ‘å€‘ä¸å†ä½¿ç”¨ newWallpaperBase64ï¼Œè€Œæ˜¯ç›´æ¥å¾ state è®€å–ï¼Œé‚è¼¯æ›´çµ±ä¸€
    const ephoneBg = state.globalSettings.wallpaper;
    if (ephoneBg) {
        // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ç„¡è«–æ˜¯ Base64 é‚„æ˜¯ URLï¼Œéƒ½çµ±ä¸€ç”¨ url() åŒ…è£¹
        ephonePreview.style.backgroundImage = `url(${ephoneBg})`;
        ephonePreview.textContent = ''; // æ¸…ç©º"ç•¶å‰ç‚ºæ¼¸è®Šè‰²"ä¹‹é¡çš„æ–‡å­—
    } else {
        // å¦‚æœæ²’æœ‰è¨­ç½®ï¼Œå‰‡æ¢å¾©é»˜èª
        ephonePreview.style.backgroundImage = 'linear-gradient(135deg, #89f7fe, #66a6ff)';
        ephonePreview.textContent = 'ç•¶å‰ç‚ºæ¼¸è®Šè‰²';
    }

    // --- CPhone å£ç´™é è¦½ (é‚è¼¯èˆ‡EPhoneå®Œå…¨ç›¸åŒ) ---
    const cphonePreview = document.getElementById('cphone-wallpaper-preview');
    const cphoneBg = state.globalSettings.cphoneWallpaper;
    if (cphoneBg) {
        cphonePreview.style.backgroundImage = `url(${cphoneBg})`;
        cphonePreview.textContent = '';
    } else {
        cphonePreview.style.backgroundImage = 'linear-gradient(135deg, #f6d365, #fda085)';
        cphonePreview.textContent = 'ç•¶å‰ç‚ºæ¼¸è®Šè‰²';
    }

    // --- å…¨åŸŸèŠå¤©èƒŒæ™¯é è¦½ (é‚è¼¯ä¸è®Šï¼Œä½†ç‚ºäº†çµ±ä¸€ä¹Ÿä¸€ä½µæ›´æ–°) ---
    const globalBgPreview = document.getElementById('global-bg-preview');
    const globalBg = state.globalSettings.globalChatBackground;
    if (globalBg) {
        globalBgPreview.style.backgroundImage = `url(${globalBg})`;
        globalBgPreview.textContent = '';
        document.getElementById('remove-global-bg-btn').style.display = 'inline-block';
    } else {
        globalBgPreview.style.backgroundImage = 'none';
        globalBgPreview.textContent = 'é»æ“Šä¸‹æ–¹ä¸Šå‚³';
        document.getElementById('remove-global-bg-btn').style.display = 'none';
    }

    // --- å¾ŒçºŒçš„å…¶ä»–æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š ---
    renderIconSettings();
    renderCPhoneIconSettings(); 
    document.getElementById('global-css-input').value = state.globalSettings.globalCss || '';
    document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';
    document.getElementById('status-bar-toggle-switch').checked = state.globalSettings.showStatusBar || false;
    renderButtonOrderEditor();
    initializeButtonOrderEditor();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                window.renderWallpaperScreenProxy = renderWallpaperScreen;
        
                // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œæ›¿æ›èˆŠçš„ applyGlobalWallpaper å‡½æ•¸ â–¼â–¼â–¼
function applyGlobalWallpaper() {
    const homeScreen = document.getElementById('home-screen');
    const wallpaper = state.globalSettings.wallpaper;
    if (wallpaper) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘çµ±ä¸€ä½¿ç”¨ url() åŒ…è£¹
        homeScreen.style.backgroundImage = `url(${wallpaper})`;
    } else {
        // æ¢å¾©é»˜èªæ¼¸è®Š
        homeScreen.style.backgroundImage = 'linear-gradient(135deg, #89f7fe, #66a6ff)';
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™å€‹å‡½æ•¸ç”¨æ–¼è™•ç†ä¸–ç•Œæ›¸é ç°½çš„é»æ“Šåˆ‡æ› â–¼â–¼â–¼
        function switchWorldBookCategory(categoryId) {
            // 1. åˆ‡æ›é ç°½çš„å•Ÿå‹•ç‹€æ…‹
            document.querySelectorAll('.world-book-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
            });
            // 2. åˆ‡æ›å…§å®¹é¢æ¿çš„é¡¯ç¤ºç‹€æ…‹
            document.querySelectorAll('.world-book-category-pane').forEach(pane => {
                pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
            });
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ renderWorldBookScreen å‡½æ•¸ â–¼â–¼â–¼
        async function renderWorldBookScreen() {
            const tabsContainer = document.getElementById('world-book-tabs');
            const contentContainer = document.getElementById('world-book-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            // 1. åŒæ™‚ç²å–æ‰€æœ‰æ›¸ç±å’Œæ‰€æœ‰åˆ†é¡
            const [books, categories] = await Promise.all([
                db.worldBooks.toArray(),
                db.worldBookCategories.orderBy('name').toArray()
            ]);
        
            state.worldBooks = books; // ç¢ºä¿è¨˜æ†¶é«”ä¸­çš„è³‡æ–™æ˜¯åŒæ­¥çš„
        
            if (books.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’ "+" å‰µå»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œæ›¸</p>';
                return;
            }
        
            // --- 2. å‰µå»ºä¸¦æ·»åŠ â€œå…¨éƒ¨â€é ç°½å’Œå…¶å…§å®¹é¢æ¿ ---
            const allTab = document.createElement('button');
            allTab.className = 'world-book-tab active';
            allTab.textContent = 'å…¨éƒ¨';
            allTab.dataset.categoryId = 'all';
            tabsContainer.appendChild(allTab);
        
            const allPane = document.createElement('div');
            allPane.className = 'world-book-category-pane active';
            allPane.dataset.categoryId = 'all';
            contentContainer.appendChild(allPane);
        
            // --- 3. å‰µå»ºä¸¦æ·»åŠ å„å€‹åˆ†é¡çš„é ç°½å’Œå…§å®¹é¢æ¿ ---
            categories.forEach(category => {
                const categoryTab = document.createElement('button');
                categoryTab.className = 'world-book-tab';
                categoryTab.textContent = category.name;
                categoryTab.dataset.categoryId = String(category.id);
                tabsContainer.appendChild(categoryTab);
        
                const categoryPane = document.createElement('div');
                categoryPane.className = 'world-book-category-pane';
                categoryPane.dataset.categoryId = String(category.id);
                contentContainer.appendChild(categoryPane);
            });
            
            // --- 4. å‰µå»ºä¸¦æ·»åŠ â€œæœªåˆ†é¡â€çš„é ç°½å’Œå…§å®¹é¢æ¿ (å¦‚æœéœ€è¦) ---
            const hasUncategorized = books.some(book => !book.categoryId);
            if (hasUncategorized) {
                const uncategorizedTab = document.createElement('button');
                uncategorizedTab.className = 'world-book-tab';
                uncategorizedTab.textContent = 'æœªåˆ†é¡';
                uncategorizedTab.dataset.categoryId = 'uncategorized';
                tabsContainer.appendChild(uncategorizedTab);
            
                const uncategorizedPane = document.createElement('div');
                uncategorizedPane.className = 'world-book-category-pane';
                uncategorizedPane.dataset.categoryId = 'uncategorized';
                contentContainer.appendChild(uncategorizedPane);
            }
        
            // --- 5. éæ­·æ›¸ç±ï¼Œå°‡å®ƒå€‘å¡«å……åˆ°å°æ‡‰çš„å…§å®¹é¢æ¿ä¸­ ---
            books.forEach(book => {
                let contentPreview = 'æš«ç„¡å…§å®¹...';
                if (Array.isArray(book.content) && book.content.length > 0) {
                    const firstEntry = book.content[0];
                    contentPreview = firstEntry.comment || firstEntry.content || '';
                } else if (typeof book.content === 'string' && book.content.trim() !== '') {
                    contentPreview = book.content;
                }
        
                const card = document.createElement('div');
                card.className = 'world-book-card';
                card.innerHTML = `
                    <div class="card-title">${book.name}</div>
                    <div class="card-content-preview">${contentPreview}</div>
                `;
                
                // ç‚ºå¡ç‰‡æœ¬èº«æ·»åŠ é»æ“Šå’Œé•·æŒ‰äº‹ä»¶
                const cardClickHandler = () => openWorldBookEditor(book.id);
                const cardLongPressHandler = async () => { 
                    const confirmed = await showCustomConfirm('åˆªé™¤ä¸–ç•Œæ›¸', `ç¢ºå®šè¦åˆªé™¤ã€Š${book.name}ã€‹å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                };
        
                card.addEventListener('click', cardClickHandler);
                addLongPressListener(card, cardLongPressHandler);
        
                // å…‹éš†å¡ç‰‡ä¸¦æŠ•æ”¾åˆ°â€œå…¨éƒ¨â€é¢æ¿
                const clonedCardForAll = card.cloneNode(true);
                clonedCardForAll.addEventListener('click', cardClickHandler);
                addLongPressListener(clonedCardForAll, cardLongPressHandler);
                allPane.appendChild(clonedCardForAll);
                
                // å°‡åŸå§‹å¡ç‰‡æŠ•æ”¾åˆ°å°æ‡‰çš„åˆ†é¡é¢æ¿
                const categoryKey = book.categoryId ? String(book.categoryId) : 'uncategorized';
                const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 6. ç‚ºæ‰€æœ‰é ç°½ç¶å®šåˆ‡æ›äº‹ä»¶ ---
            document.querySelectorAll('.world-book-tab').forEach(tab => {
                tab.addEventListener('click', () => switchWorldBookCategory(tab.dataset.categoryId));
            });
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æœ€çµ‚ä¿®å¾©ç‰ˆã€‘å®Œæ•´æ›¿æ›èˆŠçš„ createWorldBookGroup å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€V2.0 | å·²ä¿®å¾©é è¦½BUGã€‘å‰µå»ºä¸€å€‹åˆ†é¡çš„åˆ†çµ„DOM
         * @param {string} groupName - åˆ†é¡åç¨±
         * @param {Array} books - è©²åˆ†é¡ä¸‹çš„æ›¸ç±é™£åˆ—
         * @returns {HTMLElement} - å‰µå»ºå¥½çš„åˆ†çµ„å®¹å™¨
         */
        function createWorldBookGroup(groupName, books) {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'world-book-group-container';
            
            groupContainer.innerHTML = `
                <div class="world-book-group-header">
                    <span class="arrow">â–¼</span>
                    <span class="group-name">${groupName}</span>
                </div>
                <div class="world-book-group-content"></div>
            `;
        
            const contentEl = groupContainer.querySelector('.world-book-group-content');
            books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN')); // æŒ‰æ›¸åæ’åº
            
            books.forEach(book => {
                // â–¼â–¼â–¼ ã€ã€ã€é€™å°±æ˜¯æœ€é—œéµçš„ä¿®å¾©ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
                let contentPreview = 'æš«ç„¡å…§å®¹...';
                
                // 1. æª¢æŸ¥ book.content æ˜¯å¦æ˜¯æˆ‘å€‘æ–°çš„â€œæ¢ç›®é™£åˆ—â€æ ¼å¼
                if (Array.isArray(book.content) && book.content.length > 0) {
                    // å¦‚æœæ˜¯ï¼Œå°±å¾ç¬¬ä¸€å€‹æ¢ç›®çš„å…§å®¹ä¸­æå–é è¦½
                    // æˆ‘å€‘ä¹Ÿå„ªå…ˆä½¿ç”¨ç¬¬ä¸€å€‹æ¢ç›®çš„ comment ä½œç‚ºé è¦½ï¼Œå› ç‚ºå®ƒæ›´ç°¡æ½”
                    const firstEntry = book.content[0];
                    contentPreview = firstEntry.comment || firstEntry.content || '';
                } 
                // 2. å¦å‰‡ï¼Œå°±æª¢æŸ¥å®ƒæ˜¯å¦æ˜¯èˆŠçš„â€œå­—ä¸²â€æ ¼å¼
                else if (typeof book.content === 'string' && book.content.trim() !== '') {
                    // å¦‚æœæ˜¯ï¼Œå°±åƒä»¥å‰ä¸€æ¨£è™•ç†
                    contentPreview = book.content;
                }
                // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
        
                const item = document.createElement('div');
                item.className = 'list-item';
                item.dataset.bookId = book.id;
                // ç¾åœ¨ï¼Œæˆ‘å€‘ä½¿ç”¨è™•ç†å¥½çš„ contentPreview ä¾†ç”ŸæˆHTMLï¼Œä¸¦ç¢ºä¿å®ƒæ˜¯ä¸€å€‹å­—ä¸²
                item.innerHTML = `
                    <div class="item-title">${book.name}</div>
                    <div class="item-content">${String(contentPreview).substring(0, 50)}</div>
                `;
                item.addEventListener('click', () => openWorldBookEditor(book.id));
                addLongPressListener(item, async () => { 
                    const confirmed = await showCustomConfirm('åˆªé™¤ä¸–ç•Œæ›¸', `ç¢ºå®šè¦åˆªé™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                });
                contentEl.appendChild(item);
            });
        
            return groupContainer;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                window.renderWorldBookScreenProxy = renderWorldBookScreen;
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²ä¿®å¾©BUGçš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ openWorldBookEditor å‡½æ•¸ â–¼â–¼â–¼
        async function openWorldBookEditor(bookId) {
            // ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡åˆ‡æ›è¢å¹•çš„æ“ä½œç§»å‹•åˆ°å‡½æ•¸çš„æœ€å‰é¢
            // é€™æ¨£å¯ä»¥ç¢ºä¿åœ¨æ“ä½œDOMå…ƒç´ ä¹‹å‰ï¼Œå®ƒå€‘æ‰€åœ¨çš„è¢å¹•å·²ç¶“æ˜¯å•Ÿå‹•ç‹€æ…‹
            showScreen('world-book-editor-screen');
        
            editingWorldBookId = bookId;
            const [book, categories] = await Promise.all([
                db.worldBooks.get(bookId),
                db.worldBookCategories.toArray()
            ]);
        
            // å¦‚æœåœ¨åˆ‡æ›è¢å¹•å¾Œç™¼ç¾æ›¸ç±ä¸å­˜åœ¨ï¼Œå‰‡å®‰å…¨è¿”å›åˆ—è¡¨é 
            if (!book) {
                console.error("å˜—è©¦æ‰“é–‹ä¸€å€‹ä¸å­˜åœ¨çš„ä¸–ç•Œæ›¸ï¼ŒID:", bookId);
                showScreen('world-book-screen');
                return;
            }
        
            // ç¾åœ¨ï¼Œå› ç‚ºè¢å¹•å·²é¡¯ç¤ºï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°æ“ä½œé€™äº›å…ƒç´ äº†
            document.getElementById('world-book-editor-title').textContent = book.name;
            document.getElementById('world-book-name-input').value = book.name;
        
            // åˆ†é¡ä¸‹æ‹‰å¼åŠŸèƒ½è¡¨çš„é‚è¼¯ä¿æŒä¸è®Š
            const selectEl = document.getElementById('world-book-category-select');
            selectEl.innerHTML = '<option value="">-- æœªåˆ†é¡ --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (book.categoryId === cat.id) option.selected = true;
                selectEl.appendChild(option);
            });
        
            // å‹•æ…‹æ¸²æŸ“æ¢ç›®çš„é‚è¼¯ä¿æŒä¸è®Š
            const entriesContainer = document.getElementById('world-book-entries-container');
            entriesContainer.innerHTML = ''; 
        
            if (Array.isArray(book.content) && book.content.length > 0) {
                book.content.forEach(entry => {
                    const block = createWorldBookEntryBlock(entry);
                    entriesContainer.appendChild(block);
                });
            } else {
                entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">é‚„æ²’æœ‰å…§å®¹ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ·»åŠ ç¬¬ä¸€æ¢å§ï¼</p>';
            }
        
            // ä¸å†éœ€è¦åœ¨å‡½æ•¸æœ«å°¾èª¿ç”¨ showScreenï¼Œå› ç‚ºå®ƒå·²ç¶“åœ¨é–‹é ­è¢«èª¿ç”¨äº†
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ”¯æŒæœç´¢çš„ V3.0 ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderStickerPanel å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€V3.0 | æœç´¢æ”¯æ´ç‰ˆã€‘æ¸²æŸ“è¡¨æƒ…é¢æ¿
 * @param {boolean} rerenderTabs - æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“é ‚éƒ¨çš„åˆ†é¡é ç°½
 */
async function renderStickerPanel(rerenderTabs = true) {
    const grid = document.getElementById('sticker-grid');
    const tabsContainer = document.getElementById('sticker-category-tabs');
    const searchInput = document.getElementById('sticker-search-input');
    const searchTerm = searchInput.value.trim().toLowerCase();

    // --- 1. æ¸²æŸ“åˆ†é¡é ç°½ (åƒ…åœ¨éœ€è¦æ™‚) ---
    if (rerenderTabs) {
        tabsContainer.innerHTML = '';
        const categories = await db.stickerCategories.toArray();
        
        tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === 'all' ? 'active' : ''}" data-category-id="all">å…¨éƒ¨</button>`;
        categories.forEach(cat => {
             tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === cat.id ? 'active' : ''}" data-category-id="${cat.id}">${cat.name}</button>`;
        });
        tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === 'uncategorized' ? 'active' : ''}" data-category-id="uncategorized">æœªåˆ†é¡</button>`;
    }

    // --- 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¯©é¸è¡¨æƒ… ---
    grid.innerHTML = '';
    
    // æ­¥é©Ÿ a: å…ˆæ ¹æ“šç•¶å‰é¸ä¸­çš„åˆ†é¡ç¯©é¸
    let stickersByCategory;
    if (activeStickerCategoryId === 'all') {
        stickersByCategory = state.userStickers;
    } else if (activeStickerCategoryId === 'uncategorized') {
        stickersByCategory = state.userStickers.filter(s => !s.categoryId);
    } else {
        stickersByCategory = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
    }

    // æ­¥é©Ÿ b: å¦‚æœæœ‰æœç´¢è©ï¼Œåœ¨åˆ†é¡çµæœçš„åŸºç¤ä¸Šé€²ä¸€æ­¥ç¯©é¸
    const stickersToShow = searchTerm
        ? stickersByCategory.filter(sticker => sticker.name.toLowerCase().includes(searchTerm))
        : stickersByCategory;

    // --- 3. æ¸²æŸ“æœ€çµ‚çµæœ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š) ---
    if (stickersToShow.length === 0) {
        const message = searchTerm ? 'æ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…' : 'é€™å€‹åˆ†é¡ä¸‹é‚„æ²’æœ‰è¡¨æƒ…å“¦~';
        grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">${message}</p>`;
        return;
    }

    stickersToShow.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.title = sticker.name;
        item.dataset.stickerId = sticker.id;
        item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${sticker.url})"></div>
            <span class="sticker-name">${sticker.name}</span>
        `;
        item.addEventListener('click', () => {
            if (isStickerManagementMode) {
                handleStickerSelection(item);
            } else {
                sendSticker(sticker);
            }
        });
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤è¡¨æƒ…', `ç¢ºå®šè¦åˆªé™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.userStickers.delete(sticker.id);
                state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
                renderStickerPanel();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆªé™¤æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        let isStickerManagementMode = false;
        let selectedStickers = new Set();
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V2.0 ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ toggleStickerManagementMode å‡½æ•¸ â–¼â–¼â–¼
        /**
         * åˆ‡æ›è¡¨æƒ…é¢æ¿çš„ç®¡ç†æ¨¡å¼
         */
        function toggleStickerManagementMode() {
            isStickerManagementMode = !isStickerManagementMode;
            const grid = document.getElementById('sticker-grid');
            const manageBtn = document.getElementById('manage-stickers-btn');
            const actionBar = document.getElementById('sticker-action-bar');
            const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');
        
            grid.classList.toggle('management-mode', isStickerManagementMode);
            
            if (isStickerManagementMode) {
                manageBtn.textContent = 'å®Œæˆ';
                actionBar.style.display = 'flex'; // æ”¹ç‚º flex
                selectedStickers.clear();
                selectAllCheckbox.checked = false; // é‡ç½®å…¨é¸æ¡†
                updateDeleteStickerButton();
            } else {
                manageBtn.textContent = 'ç®¡ç†';
                actionBar.style.display = 'none';
                grid.querySelectorAll('.sticker-item.selected').forEach(item => item.classList.remove('selected'));
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ™ºæ…§â€œå…¨é¸â€åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•¸ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼
        /**
         * è™•ç†â€œå…¨é¸â€æ ¸å–æ–¹å¡Šçš„é»æ“Šäº‹ä»¶ï¼Œæ ¹æ“šç•¶å‰åˆ†é¡æ™ºæ…§é¸æ“‡
         */
        function handleSelectAllStickers() {
            const checkbox = document.getElementById('select-all-stickers-checkbox');
            const shouldSelect = checkbox.checked;
        
            // 1. æ ¹æ“šç•¶å‰å•Ÿå‹•çš„åˆ†é¡IDï¼Œç¯©é¸å‡ºæ‡‰è©²è¢«æ“ä½œçš„è¡¨æƒ…
            let stickersToSelect;
            if (activeStickerCategoryId === 'all') {
                stickersToSelect = state.userStickers;
            } else if (activeStickerCategoryId === 'uncategorized') {
                stickersToSelect = state.userStickers.filter(s => !s.categoryId);
            } else {
                stickersToSelect = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
            }
        
            // 2. éæ­·é€™äº›è¢«ç¯©é¸å‡ºçš„è¡¨æƒ…
            stickersToSelect.forEach(sticker => {
                const stickerId = sticker.id;
                const itemEl = document.querySelector(`.sticker-item[data-sticker-id="${stickerId}"]`);
                
                if (shouldSelect) {
                    // å¦‚æœæ˜¯â€œå…¨é¸â€æ“ä½œ
                    selectedStickers.add(stickerId);
                    if (itemEl) itemEl.classList.add('selected');
                } else {
                    // å¦‚æœæ˜¯â€œå–æ¶ˆå…¨é¸â€æ“ä½œ
                    selectedStickers.delete(stickerId);
                    if (itemEl) itemEl.classList.remove('selected');
                }
            });
        
            // 3. æ›´æ–°åˆªé™¤æŒ‰éˆ•çš„è¨ˆæ•¸
            updateDeleteStickerButton();
        }
        // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²        
        /**
         * æ›´æ–°åˆªé™¤æŒ‰éˆ•ä¸Šçš„è¨ˆæ•¸
         */
        function updateDeleteStickerButton() {
            const btn = document.getElementById('delete-selected-stickers-btn');
            btn.textContent = `åˆªé™¤ (${selectedStickers.size})`;
        }
        
        /**
         * è™•ç†ç”¨æˆ¶é»æ“Šé¸æ“‡æˆ–å–æ¶ˆé¸æ“‡è¡¨æƒ…
         * @param {HTMLElement} item - è¢«é»æ“Šçš„è¡¨æƒ…DOMå…ƒç´ 
         */
        function handleStickerSelection(item) {
            if (!isStickerManagementMode) return; // åªæœ‰åœ¨ç®¡ç†æ¨¡å¼ä¸‹æ‰ç”Ÿæ•ˆ
        
            const stickerId = item.dataset.stickerId;
            if (!stickerId) return;
        
            item.classList.toggle('selected');
        
            if (selectedStickers.has(stickerId)) {
                selectedStickers.delete(stickerId);
            } else {
                selectedStickers.add(stickerId);
            }
            updateDeleteStickerButton();
        }
        
        /**
         * åŸ·è¡Œæ‰¹é‡åˆªé™¤æ“ä½œ
         */
        async function executeBatchDeleteStickers() {
            if (selectedStickers.size === 0) return;
            
            const confirmed = await showCustomConfirm(
                'ç¢ºèªåˆªé™¤',
                `ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedStickers.size} å€‹è¡¨æƒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                const idsToDelete = [...selectedStickers];
                
                // å¾è³‡æ–™åº«æ‰¹é‡åˆªé™¤
                await db.userStickers.bulkDelete(idsToDelete);
                
                // å¾è¨˜æ†¶é«”ç‹€æ…‹ä¸­éæ¿¾æ‰è¢«åˆªé™¤çš„è¡¨æƒ…
                state.userStickers = state.userStickers.filter(s => !idsToDelete.includes(s.id));
                
                // é€€å‡ºç®¡ç†æ¨¡å¼ä¸¦åˆ·æ–°æ¸…å–®
                toggleStickerManagementMode();
                renderStickerPanel();
                
                await showCustomAlert('åˆªé™¤æˆåŠŸ', 'é¸ä¸­çš„è¡¨æƒ…å·²æˆåŠŸåˆªé™¤ã€‚');
            }
        }
        // â–²â–²â–² å…¨æ–°åŠŸèƒ½å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ‰¹é‡å°å…¥è¡¨æƒ…çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ‰“é–‹æ‰¹é‡å°å…¥è¡¨æƒ…çš„å½ˆçª—
         */
        async function openBatchStickerImportModal() {
            const placeholderText = `è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é»è²¼ï¼Œä¸€è¡Œä¸€å€‹ï¼š\n\nç„¦æ…® 2a9wte.jpeg\nå¤§é©šå¤±è‰² or8qf4.png\næ²’æœ‰éˆæ„Ÿ njwujh.jpeg`;
            
            const pastedText = await showCustomPrompt(
                'æ‰¹é‡å°å…¥è¡¨æƒ…',
                placeholderText,
                '',
                'textarea'
            );
        
            if (pastedText && pastedText.trim()) {
                await handleBatchStickerImport(pastedText);
            }
        }
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleBatchStickerImport å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€æ ¸å¿ƒé‚è¼¯ | V3.0 - å·²ä¿®å¾©URLæ ¼å¼BUGã€‘è™•ç†é»è²¼çš„æ–‡æœ¬ï¼Œè§£æä¸¦å­˜å…¥è³‡æ–™åº«
         * @param {string} text - ä½¿ç”¨è€…é»è²¼çš„æ–‡æœ¬å…§å®¹
         */
        async function handleBatchStickerImport(text) {
            const lines = text.trim().split('\n');
            const newStickers = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
            const currentCategoryId = (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null;

            for (const line of lines) {
                const trimmedLine = line.trim();

                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šç§»é™¤äº†éŒ¯èª¤çš„ `trimmedLine.includes('http')` åˆ¤æ–· â–¼â–¼â–¼
                // ç¾åœ¨åªè·³éç©ºè¡Œæˆ–ç¤ºä¾‹è¡Œ
                if (!trimmedLine || trimmedLine.includes('å¡«å…¥')) {
                    continue;
                }
                // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

                // å„ªå…ˆåŒ¹é… â€œåç¨±ï¼šURLâ€ æ ¼å¼
                const fullUrlMatch = trimmedLine.match(/^(.+?)[:ï¼š]\s*(https?:\/\/.+)$/);
                
                if (fullUrlMatch) {
                    const name = fullUrlMatch[1].trim();
                    const url = fullUrlMatch[2].trim();
                    newStickers.push({
                        id: 'sticker_' + Date.now() + Math.random(),
                        name: name,
                        url: url,
                        categoryId: currentCategoryId
                    });
                    continue; 
                }

                // å¦‚æœä¸Šé¢æ²’åŒ¹é…æˆåŠŸï¼Œå‰‡å˜—è©¦åŒ¹é…èˆŠçš„ catbox.moe æ ¼å¼
                let name = null;
                let code = null;
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }

                if (name && code && code.includes('.')) {
                    newStickers.push({
                        id: 'sticker_' + Date.now() + Math.random(),
                        name: name,
                        url: baseUrl + code,
                        categoryId: currentCategoryId
                    });
                } else {
                    errorCount++;
                    console.warn('æ‰¹é‡å°å…¥æ ¼å¼éŒ¯èª¤ï¼Œå·²è·³éæ­¤è¡Œ:', trimmedLine);
                }
            }

            if (errorCount > 0) {
                await showCustomAlert('éƒ¨åˆ†å°å…¥å¤±æ•—', `æœ‰ ${errorCount} è¡Œçš„æ ¼å¼ä¸æ­£ç¢ºï¼Œå·²è¢«ç³»çµ±è·³éã€‚`);
            }

            if (newStickers.length > 0) {
                await db.userStickers.bulkAdd(newStickers);
                state.userStickers.push(...newStickers);
                renderStickerPanel();
                await showCustomAlert('å°å…¥æˆåŠŸ', `å·²æˆåŠŸæ‰¹é‡å°å…¥ ${newStickers.length} å€‹æ–°è¡¨æƒ…ï¼`);
            } else if (errorCount === 0) {
                alert("æ²’æœ‰æ‰¾åˆ°å¯å°å…¥çš„å…§å®¹ã€‚è«‹æª¢æŸ¥æ‚¨é»è²¼çš„æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘æ»¾å‹•åˆ°ä¸¦é«˜äº®é¡¯ç¤ºåŸå§‹æ¶ˆæ¯
 * @param {number} originalTimestamp - è¦è·³è½‰åˆ°çš„åŸå§‹æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
function scrollToOriginalMessage(originalTimestamp) {
    const selector = `.message-bubble[data-timestamp="${originalTimestamp}"]`;
    const originalMessageBubble = document.querySelector(selector);

    if (originalMessageBubble) {
        originalMessageBubble.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        originalMessageBubble.classList.add('highlighted');
        setTimeout(() => {
            if (document.body.contains(originalMessageBubble)) {
                originalMessageBubble.classList.remove('highlighted');
            }
        }, 1500); // é«˜äº®æŒçºŒ1.5ç§’

    } else {
        // åªæœ‰åœ¨æ‰€æœ‰å˜—è©¦éƒ½å¤±æ•—å¾Œæ‰æç¤ºç”¨æˆ¶
        alert("æ‰¾ä¸åˆ°åŸå§‹æ¶ˆæ¯ã€‚å¯èƒ½å·²è¢«åˆªé™¤æˆ–ä½æ–¼æ›´æ—©çš„æ­·å²è¨˜éŒ„ä¸­ã€‚");
    }
}


// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ createMessageElement å‡½æ•¸ â–¼â–¼â–¼
        async function createMessageElement(msg, chat) {
        
            // --- (ç³»çµ±æ¶ˆæ¯å’Œæ’¤å›æ¶ˆæ¯çš„è™•ç†é‚è¼¯ä¿æŒä¸è®Š) ---
            if (msg.type === 'recalled_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat';
                wrapper.dataset.timestamp = msg.timestamp; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble recalled-message-placeholder';
                bubble.dataset.timestamp = msg.timestamp; 
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) {
                        toggleMessageSelection(msg.timestamp);
                    }
                });
                return wrapper;
            }
            else if (msg.type === 'post_deleted_notice') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat';
                wrapper.dataset.timestamp = msg.timestamp; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble post-deleted-placeholder'; 
                bubble.dataset.postId = msg.postId;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) {
                        toggleMessageSelection(msg.timestamp);
                    }
                });
                return wrapper;
            }
        
            if (msg.isHidden) {
                return null;
            }
        
            if (msg.type === 'pat_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat'; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble system-bubble'; 
                bubble.dataset.timestamp = msg.timestamp;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
                return wrapper;
            }
        
            // --- (åŸºç¤DOMå…ƒç´ æº–å‚™é‚è¼¯ä¿æŒä¸è®Š) ---
            const isUser = msg.role === 'user';
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
        
            if (chat.isGroup && !isUser) {
                const member = chat.members.find(m => m.originalName === msg.senderName);
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'æœªçŸ¥æˆå“¡');
                wrapper.appendChild(senderNameDiv);
            }
        
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            bubble.dataset.timestamp = msg.timestamp;
        
            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = formatTimestamp(msg.timestamp);
        
            let avatarSrc, avatarFrameSrc = '';
            if (isUser) {
                avatarSrc = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrameSrc = chat.settings.myAvatarFrame || '';
            } else {
                if (chat.isGroup) {
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    if (member) {
                        const characterProfile = state.chats[member.id];
                        avatarSrc = member.avatar || (characterProfile ? characterProfile.settings.aiAvatar : defaultGroupMemberAvatar);
                        avatarFrameSrc = member.avatarFrame || (characterProfile ? characterProfile.settings.aiAvatarFrame : '');
                    } else {
                        avatarSrc = defaultGroupMemberAvatar;
                        avatarFrameSrc = '';
                    }
                } else {
                    avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                }
            }
        
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `<div class="avatar-with-frame"><img src="${avatarSrc}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
            } else {
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            }
            const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
            const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;
            
            let contentHtml;
            let quoteHtml = '';
            if (msg.quote) {
                const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
                const fullQuotedContent = String(msg.quote.content || '');
                quoteHtml = `
                    <div class="quoted-message" data-original-timestamp="${msg.quote.timestamp}" style="cursor: pointer;">
                        <div class="quoted-sender">å›å¾© ${quotedSenderDisplayName}:</div>
                        <div class="quoted-content">${fullQuotedContent}</div>
                    </div>
                `;
            }
            
            // ==========================================================
            //                  â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹é‚è¼¯ â˜…â˜…â˜…
            // ==========================================================
        
            let rawContent = msg.content; // ç›´æ¥ä½¿ç”¨ msg.contentï¼Œä¸å†å¼·åˆ¶è½‰ç‚ºå­—ä¸²

            if (typeof rawContent === 'string' && rawContent.trim().startsWith('<') && rawContent.trim().endsWith('>')) {
                contentHtml = rawContent;
                bubble.classList.add('is-raw-html'); 
            } else if (msg.type === 'offline_text' || msg.type === 'share_link' || msg.type === 'share_card' || msg.type === 'location_share' || msg.type === 'ai_image' || msg.type === 'user_photo' || msg.type === 'voice_message' || msg.type === 'transfer' || msg.type === 'waimai_request'|| msg.type === 'waimai_order'  || msg.type === 'red_packet' || msg.type === 'poll' || msg.type === 'gift') {
                // (é€™éƒ¨åˆ†æ˜¯æ‚¨å·²æœ‰çš„æ‰€æœ‰å¡ç‰‡æ¸²æŸ“é‚è¼¯ï¼Œä¿æŒä¸è®Š)
               if (msg.type === 'offline_text') {
                    // 1. ã€ç›¸å®¹èˆŠè³‡æ–™ã€‘å¦‚æœæ¶ˆæ¯é‚„æ˜¯èˆŠçš„ dialogue/description æ ¼å¼ï¼Œå‰‡å…ˆåˆä½µ
                    const combinedText = msg.content || `${msg.dialogue || ''} ${msg.description || ''}`.trim();

                    // 2. ã€æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ã€‘ä½¿ç”¨è¦å‰‡é‹ç®—å¼ï¼Œä»¥å¼•è™Ÿç‚ºç•Œï¼Œå°‡æ–‡æœ¬åˆ†å‰²æˆâ€œå°è©±â€å’Œâ€œæå¯«â€å…©éƒ¨åˆ†
                    const regex = /(ã€Œ.*?ã€|â€œ.*?â€)/g;
                    const parts = combinedText.split(regex).filter(part => part); 

                    // 3. éæ­·åˆ†å‰²å¾Œçš„ç‰‡æ®µï¼Œç‚ºæ¯ä¸€éƒ¨åˆ†æ‡‰ç”¨ä¸åŒçš„æ¨£å¼
                    contentHtml = parts.map(part => {
                        // å¦‚æœç‰‡æ®µä»¥å¼•è™Ÿé–‹é ­ï¼Œèªªæ˜å®ƒæ˜¯å°è©±
                        if (part.startsWith('ã€Œ') || part.startsWith('â€œ')) {
                            return `<span class="offline-dialogue">${parseMarkdown(part)}</span>`;
                        } else {
                            // å¦å‰‡ï¼Œå®ƒå°±æ˜¯æå¯«
                            return `<span class="offline-description">${parseMarkdown(part.trim()).replace(/\n/g, '<br>')}</span>`;
                        }
                    }).join(''); // æœ€å¾Œå°‡æ‰€æœ‰ç‰‡æ®µæ‹¼æ¥æˆæœ€çµ‚çš„HTML
                }
else if (msg.type === 'share_link') {
                    bubble.classList.add('is-link-share', 'is-card-like');
                    contentHtml = `<div class="link-share-card" data-timestamp="${msg.timestamp}"><div class="title">${msg.title || 'ç„¡æ¨™é¡Œ'}</div><div class="description">${msg.description || 'é»æ“ŠæŸ¥çœ‹è©³æƒ…...'}</div><div class="footer"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><span>${msg.source_name || 'é€£çµåˆ†äº«'}</span></div></div>`;
                } else if (msg.type === 'share_card') {
                    bubble.classList.add('is-link-share', 'is-card-like');
                    contentHtml = `<div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}"><div class="title">${msg.payload.title}</div><div class="description">å…± ${msg.payload.sharedHistory.length} æ¢æ¶ˆæ¯</div><div class="footer"><svg class="footer-icon" ...>...</svg><span>èŠå¤©è¨˜éŒ„</span></div></div>`;
                } else if (msg.type === 'location_share') {
                    bubble.classList.add('is-location-share', 'is-card-like');
                        let finalImageUrl;
    
    // 1. å„ªå…ˆä½¿ç”¨æ¶ˆæ¯è‡ªå¸¶çš„ imageUrl (é€™æ˜¯ä½ æ‰‹å‹•åˆ†äº«æ™‚è¨­ç½®çš„)
    if (msg.imageUrl) {
        finalImageUrl = msg.imageUrl;
    } 
    // 2. å…¶æ¬¡ï¼Œå¦‚æœé–‹å•Ÿäº†AIç”Ÿåœ–ä¸”AIè¿”å›äº†æŒ‡ä»¤ï¼Œå‰‡ä½¿ç”¨AIç”Ÿåœ–
    else if (state.globalSettings.enableAiDrawing && msg.image_prompt) {
        finalImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg.image_prompt)}`;
    } 
    // 3. æœ€å¾Œï¼Œå¦‚æœä»¥ä¸Šéƒ½æ²’æœ‰ï¼Œæ‰ä½¿ç”¨å é»é™£åœ–
    else {
        finalImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg'; // é»˜èªå é»é™£åœ–
    }
    
    const mapAreaStyle = `style="background-image: url('${finalImageUrl}');"`;
                    contentHtml = `<div class="location-share-card"><div class="card-text-area"><div class="card-text-primary">${msg.content}</div><div class="card-text-secondary">ä½ç½®åˆ†äº«</div></div><div class="card-map-area" ${mapAreaStyle}><div class="card-pin-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 11.5C11.1716 11.5 10.5 10.8284 10.5 10C10.5 9.17157 11.1716 8.5 12 8.5C12.8284 8.5 13.5 9.17157 13.5 10C13.5 10.8284 12.8284 11.5 12 11.5Z"></path><path d="M12 2C7.92134 2 4.5 5.42134 4.5 9.5C4.5 14.5312 11.2188 21.4375 11.5938 21.8125C11.7954 22.014 12.2046 22.014 12.4062 21.8125C12.7812 21.4375 19.5 14.5312 19.5 9.5C19.5 5.42134 16.0787 2 12 2ZM12 12.5C10.6193 12.5 9.5 11.3807 9.5 10C9.5 8.61929 10.6193 7.5 12 7.5C13.3807 7.5 14.5 8.61929 14.5 10C14.5 11.3807 13.3807 12.5 12 12.5Z"></path></svg></div></div></div>`;
                } else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
                    bubble.classList.add('is-ai-image', 'is-card-like');
                    const altText = msg.type === 'user_photo' ? "ç”¨æˆ¶æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„åœ–ç‰‡";
                    
                    // 1. åœ¨ç”ŸæˆURLä¹‹å‰ï¼ŒåŠ å…¥å°å…¨åŸŸé–‹é—œçš„åˆ¤æ–·
                    const imageUrl = state.globalSettings.enableAiDrawing && msg.image_prompt 
                        ? `https://image.pollinations.ai/prompt/${msg.image_prompt}` 
                        : 'https://i.postimg.cc/KYr2qRCK/1.jpg'; // <-- å¦‚æœé–‹é—œé—œé–‰ï¼Œå‰‡ä½¿ç”¨å é»é™£åœ–

                    // 2. å°‡åˆ¤æ–·å¾Œçš„URLç”¨æ–¼ç”ŸæˆHTML
                    contentHtml = `<img src="${imageUrl}" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
                } else if (msg.type === 'voice_message') {
    bubble.classList.add('is-voice-message', 'is-card-like');
    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';

    if (isUser) {
        // ä½¿ç”¨è€…ç™¼é€çš„èªéŸ³è¨Šæ¯ï¼ˆé€™éƒ¨åˆ†é‚è¼¯ä¸è®Šï¼‰
        contentHtml = `
            <div class="voice-message-body" data-text="${encodeURIComponent(msg.content)}">
                <div class="voice-waveform">${waveformHTML}</div>
                <span class="voice-duration">${durationFormatted}</span>
            </div>
            <div class="voice-transcript"></div>
        `;
    } else {
        // AIç™¼é€çš„èªéŸ³è¨Šæ¯ï¼ˆé€™æ˜¯æˆ‘å€‘çš„æ ¸å¿ƒä¿®æ”¹ï¼‰
        
        // 1. åˆ¤æ–·æ˜¯å¦æ»¿è¶³æ’­æ”¾æ¢ä»¶ï¼šå¿…é ˆæ˜¯å–®èŠ ä¸” TTSé–‹é—œæ²’æœ‰è¢«é—œé–‰
        const canPlayTTS = !chat.isGroup && chat.settings.enableTts !== false;
        
        // 2. ç²å– voiceIdï¼Œä»¥å‚™ä¸æ™‚ä¹‹éœ€
        const voiceId = chat.settings.minimaxVoiceId || 'female-shaonv-jingpin';
        
        // 3. ã€æ™ºæ…§æ¸²æŸ“ã€‘æ ¹æ“š canPlayTTS çš„çµæœï¼Œæ±ºå®šæ˜¯å¦æ·»åŠ  data-voice-id å±¬æ€§
        const voiceIdAttribute = canPlayTTS ? `data-voice-id="${voiceId}"` : '';

        contentHtml = `
            <div class="voice-message-body" data-text="${encodeURIComponent(msg.content)}" ${voiceIdAttribute}>
                <div class="voice-waveform">${waveformHTML}</div>
                <div class="loading-spinner"></div>
                <span class="voice-duration">${durationFormatted}</span>
            </div>
            <div class="voice-transcript"></div>
        `;
    }
}else if (msg.type === 'transfer') {
                    bubble.classList.add('is-transfer', 'is-card-like');
                     let titleText, noteText;
                    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                    const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                    const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName || chat.name);
                    if (isUser) { 
                        if (msg.isRefund) { titleText = `é€€æ¬¾çµ¦ ${receiverDisplayName}`; noteText = 'å·²æ‹’æ”¶å°æ–¹è½‰å¸³'; } 
                        else { titleText = `è½‰å¸³çµ¦ ${receiverDisplayName}`; if (msg.status === 'accepted') noteText = 'å°æ–¹å·²æ”¶æ¬¾'; else if (msg.status === 'declined') noteText = 'å°æ–¹å·²æ‹’æ”¶'; else noteText = msg.note || 'ç­‰å¾…å°æ–¹è™•ç†...'; }
                    } else {
                        if (msg.isRefund) { titleText = `é€€æ¬¾ä¾†è‡ª ${senderDisplayName}`; noteText = 'è½‰å¸³å·²è¢«æ‹’æ”¶'; } 
                        else if (msg.receiverName === myNickname) { titleText = `è½‰å¸³çµ¦ ${myNickname}`; if (msg.status === 'accepted') noteText = 'ä½ å·²æ”¶æ¬¾'; else if (msg.status === 'declined') noteText = 'ä½ å·²æ‹’æ”¶'; else { bubble.style.cursor = 'pointer'; bubble.dataset.status = 'pending'; noteText = msg.note || 'é»æ“Šè™•ç†'; } } 
                        else { titleText = `è½‰å¸³: ${senderDisplayName} â†’ ${receiverDisplayName}`; noteText = msg.note || 'ç¾¤èŠå…§è½‰å¸³'; }
                    }
                    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
                    contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${noteText}</div></div>`;
                } else if (msg.type === 'waimai_request') {
                    bubble.classList.add('is-waimai-request', 'is-card-like');
                     if (msg.status === 'paid' || msg.status === 'rejected') bubble.classList.add(`status-${msg.status}`);
                    const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                    const requestTitle = `ä¾†è‡ª ${senderDisplayName} çš„ä»£ä»˜è«‹æ±‚`;
                    let actionButtonsHtml = '';
                    if (msg.status === 'pending' && !isUser) { actionButtonsHtml = `<div class="waimai-user-actions"><button class="waimai-decline-btn" data-choice="rejected">æ®˜å¿æ‹’çµ•</button><button class="waimai-pay-btn" data-choice="paid">ç‚ºTaè²·å–®</button></div>`; }
                    contentHtml = `<div class="waimai-card"><div class="waimai-header"><img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon"><div class="title-group"><span class="brand">ç¾åœ˜å¤–è³£</span><span class="separator">|</span><span>å¤–è³£ç¾é£Ÿ</span></div></div><div class="waimai-catchphrase">Hiï¼Œä½ å’Œæˆ‘çš„è·é›¢åªå·®ä¸€é “å¤–è³£ï½</div><div class="waimai-main"><div class="request-title">${requestTitle}</div><div class="payment-box"><div class="payment-label">éœ€ä»˜æ¬¾</div><div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div><div class="countdown-label">å‰©é¤˜æ”¯ä»˜æ™‚é–“<div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div></div></div><button class="waimai-details-btn">æŸ¥çœ‹è©³æƒ…</button></div>${actionButtonsHtml}</div>`;
                       setTimeout(() => {
        if (msg.status === 'pending') {
            const timerElement = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerElement) {
                const timerId = startWaimaiCountdown(timerElement, msg.countdownEndTime);
                // å°‡è¨ˆæ™‚å™¨IDå­˜èµ·ä¾†ï¼Œæ–¹ä¾¿åœ¨é›¢é–‹é é¢æ™‚çµ±ä¸€æ¸…ç†
                waimaiTimers[msg.timestamp] = timerId;
            }
        }
    }, 0);
                } else if (msg.type === 'waimai_order') {
                bubble.classList.add('is-waimai-request', 'is-card-like'); // è¤‡ç”¨æ¨£å¼
                const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                
                let recipientDisplayName = 'ä½ ';
                if (chat.isGroup) {
                    // å¦‚æœæ˜¯ç¾¤èŠï¼Œå°±å»æŸ¥æ‰¾æ¥æ”¶è€…çš„åå­—
                    recipientDisplayName = getDisplayNameInGroup(chat, msg.recipientName);
                }

    contentHtml = `
        <div class="waimai-card">
            <div class="waimai-header">
                <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                <div class="title-group"><span class="brand">ç¾åœ˜å¤–è³£</span><span class="separator">|</span><span>å¤–è³£ç¾é£Ÿ</span></div>
            </div>
            <div class="waimai-main">
                <div class="request-title" style="margin-bottom: 12px;">${senderDisplayName} å·²ç‚º${recipientDisplayName}ä¸‹å–®ï¼Œè«‹æ…¢ç”¨ï½</div>
                <div class="payment-box">
                    <div class="payment-label" style="font-size: 18px; font-weight: 600;">${msg.productInfo}</div>
                    <div class="amount" style="margin-top: 8px;">Â¥${Number(msg.amount).toFixed(2)}</div>
                </div>
                <button class="waimai-details-btn">æŸ¥çœ‹è¨‚å–®è©³æƒ…</button>
            </div>
        </div>
    `;
}else if (msg.type === 'red_packet') {
                     bubble.classList.add('is-red-packet', 'is-card-like');
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
                    const isFinished = msg.isFullyClaimed; const hasClaimed = msg.claimedBy && msg.claimedBy[myOriginalName];
                    let cardClass = '', claimedInfoHtml = '', typeText = 'æ‹¼æ‰‹æ°£ç´…åŒ…';
                    if (isFinished) { cardClass = 'opened'; } if (msg.packetType === 'direct') { const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName); typeText = `å°ˆå±¬ç´…åŒ…: çµ¦ ${receiverDisplayName}`; if (Object.keys(msg.claimedBy || {}).length > 0) cardClass = 'opened'; }
                    if (hasClaimed) { const myClaimedAmount = msg.claimedBy[myOriginalName] || 0; claimedInfoHtml = `<div class="rp-claimed-info">ä½ é ˜å–äº†ç´…åŒ…ï¼Œé‡‘é¡ ${myClaimedAmount.toFixed(2)} å…ƒ</div>`; } 
                    else if (isFinished) { claimedInfoHtml = `<div class="rp-claimed-info">ç´…åŒ…å·²è¢«é ˜å®Œ</div>`; } 
                    else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) { const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName); claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${receiverDisplayName} é ˜å–</div>`; }
                    contentHtml = `<div class="red-packet-card ${cardClass}"><div class="rp-header"><img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon"><span class="rp-greeting">${msg.greeting || 'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼'}</span></div><div class="rp-type">${typeText}</div>${claimedInfoHtml}</div>`;
                } else if (msg.type === 'poll') {
                    bubble.classList.add('is-poll', 'is-card-like');
                    const pollQuestionText = msg.question || msg.content || '(ç„¡æ¨™é¡ŒæŠ•ç¥¨)';
                    let totalVotes = 0; const voteCounts = {}; for (const option in msg.votes) { const count = msg.votes[option].length; voteCounts[option] = count; totalVotes += count; }
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}'; let myVote = null; for (const option in msg.votes) { if (msg.votes[option].includes(myOriginalName)) { myVote = option; break; } }
                    let optionsHtml = '<div class="poll-options-list">'; msg.options.forEach(optionText => { const count = voteCounts[optionText] || 0; const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0; const isVotedByMe = myVote === optionText; optionsHtml += `<div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}"><div class="poll-option-bar" style="width: ${percentage}%;"></div><div class="poll-option-content"><span class="poll-option-text">${optionText}</span><span class="poll-option-votes">${count} ç¥¨</span></div></div>`; }); optionsHtml += '</div>';
                    let footerHtml = msg.isClosed ? `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹çµæœ</button></div>` : `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">çµæŸæŠ•ç¥¨</button></div>`;
                    contentHtml = `<div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}"><div class="poll-question">${pollQuestionText}</div>${optionsHtml}${footerHtml}</div>`;
                } else if (msg.type === 'gift') {
                    bubble.classList.add('is-gift', 'is-card-like');
                     let headerText; const myNicknameForGift = chat.settings.myNickname || 'æˆ‘';
                    if (chat.isGroup) {
                        if (msg.recipients && msg.recipients.length > 0) {
                            const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName));
                            if (recipientDisplayNames.length === 1) { headerText = `é€çµ¦ ${recipientDisplayNames[0]} çš„ç¦®ç‰©`; } else { headerText = `é€çµ¦ ${recipientDisplayNames.slice(0, 2).join('ã€')}ç­‰äººçš„ç¦®ç‰©`; }
                        } else { headerText = `é€çµ¦å¤§å®¶çš„ç¦®ç‰©`; }
                    } else {
                        if (isUser) { headerText = `é€çµ¦ ${chat.name} çš„ç¦®ç‰©`; } 
                        else { const recipientDisplayName = chat.settings.myNickname || 'ä½ '; headerText = `é€çµ¦ ${recipientDisplayName} çš„ç¦®ç‰©`; }
                    }
                    const previewItems = msg.items.slice(0, 3); let previewHtml = ''; previewItems.forEach(item => { previewHtml += `<div class="gift-preview-item"><img src="${item.imageUrl}" class="gift-preview-img"><span class="gift-preview-name">${item.name}</span><span class="gift-preview-quantity">x${item.quantity}</span></div>`; });
                    let moreItemsText = ''; if (msg.items.length > 3) { moreItemsText = ` ç­‰${msg.items.length}ä»¶å•†å“`; }
                    contentHtml = `<div class="gift-card"><div class="gift-header"><svg class="gift-header-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18a4 4 0 0 0-7.64 0H8a4 4 0 0 0-4 4v2h20V10a4 4 0 0 0-4-4zM8 4a2 2 0 1 1-2 2a2 2 0 0 1 2-2zm12 0a2 2 0 1 1-2 2a2 2 0 0 1 2-2zM4 14v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6H4z"></path></svg><span class="gift-header-text">${headerText}</span></div><div class="gift-items-preview">${previewHtml}</div><div class="gift-footer">å…±${msg.items.length}ä»¶å•†å“${moreItemsText}ï¼Œé»æ“ŠæŸ¥çœ‹</div></div>`;
                }
            } else {
                const processedContent = String(rawContent); // ç¢ºä¿æ˜¯å­—ä¸²
                let processedByRule = await applyRenderingRules(processedContent, chat.id);
                if (processedByRule !== processedContent) {
                    contentHtml = processedByRule;
                    bubble.classList.add('is-card-like');
                } else {
                    // â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨éœ€è¦æ·»åŠ çš„æ ¸å¿ƒä¿®å¾©ä»£ç¢¼ã€‘ â–¼â–¼â–¼
                    // 1. æª¢æŸ¥æ¶ˆæ¯å…§å®¹æ˜¯å¦æ˜¯ç”¨æ–¼è­˜åœ–çš„åœ–ç‰‡ç‰©ä»¶é™£åˆ—
                    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                        // 2. å¦‚æœæ˜¯ï¼Œå°±å‰µå»ºä¸€å€‹<img>æ¨™ç±¤ä¾†é¡¯ç¤ºå®ƒ
                        const imageUrl = msg.content[0].image_url.url;
                        contentHtml = `<img src="${imageUrl}" class="chat-image">`;
                    }
                    // â–²â–²â–² ä¿®å¾©ä»£ç¢¼çµæŸ â–²â–²â–²
                    else if (STICKER_REGEX.test(processedByRule)) { // ä½¿ç”¨ else if
                        bubble.classList.add('is-sticker', 'is-card-like');
                        contentHtml = `<img src="${processedByRule}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
                    } else {
                        let plainText = processMentions(processedByRule, chat);
                        contentHtml = parseMarkdown(plainText).replace(/\n/g, '<br>');
                    }
                }
            }
        
            // --- (çµ„è£æœ€çµ‚çš„HTMLé‚è¼¯ä¿æŒä¸è®Š) ---
            bubble.innerHTML = `
                ${avatarGroupHtml}
                <div class="content">
                    ${quoteHtml}
                    ${contentHtml}
                </div>
            `;
            
            wrapper.appendChild(bubble);
            wrapper.appendChild(timestampEl);
            
            addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
            wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        
            if (!isUser) {
                const avatarGroupEl = wrapper.querySelector('.avatar-group'); 
                if (avatarGroupEl) {
                    avatarGroupEl.style.cursor = 'pointer';
                    if (!chat.isGroup) {
                        avatarGroupEl.addEventListener('click', (e) => { e.stopPropagation(); showCharacterProfileModal(chat.id); });
                    } else {
                        avatarGroupEl.addEventListener('dblclick', (e) => { e.stopPropagation(); handleUserPat(chat.id, msg.senderName); });
                    }
                }
            }
            return wrapper;
        }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²ä¿®å¾©çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ prependMessage å‡½æ•¸ â–¼â–¼â–¼
        async function prependMessage(msg, chat) { 
            const messagesContainer = document.getElementById('chat-messages'); 
            const messageEl = await createMessageElement(msg, chat); 
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ä¹ŸåŠ ä¸ŠåŒæ¨£çš„å®‰å…¨æª¢æŸ¥ï¼ã€‘ã€‘ã€‘
            if (!messageEl) return;
        
            const loadMoreBtn = document.getElementById('load-more-btn'); 
            if (loadMoreBtn) { 
                messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); 
            } else { 
                messagesContainer.prepend(messageEl); 
            } 
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * ã€V3.0 | å·²å»¶é•·é–“éš”ã€‘å°‡æ¶ˆæ¯å…ƒç´ è¿½åŠ åˆ°èŠå¤©è¦–çª—
         */
        async function appendMessage(msg, chat, isInitialLoad = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const typingIndicator = document.getElementById('typing-indicator');

const lastMessage = chat.history.filter(m => !m.isHidden).pop();

// æ ¸å¿ƒé‚è¼¯ï¼šç”¨æ–°æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜(msg.timestamp)èˆ‡ä¸Šä¸€æ¢æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜(lastMessage.timestamp)é€²è¡Œæ¯”è¼ƒ
if (lastMessage && (msg.timestamp - lastMessage.timestamp > 600000)) { // 600000æ¯«ç§’ = 10åˆ†é˜
    const timestampEl = createSystemTimestampElement(msg.timestamp);
    messagesContainer.insertBefore(timestampEl, typingIndicator);
}

            const messageEl = await createMessageElement(msg, chat);
            if (!messageEl) return;
    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
    // å¦‚æœæ˜¯AIç™¼é€çš„æ–°æ¶ˆæ¯ï¼ˆéåˆå§‹è¼‰å…¥ï¼‰ï¼Œå°±æ’­æ”¾æç¤ºéŸ³
    if (msg.role === 'assistant' && !isInitialLoad) {
        playNotificationSound();
    }
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
            if (!isInitialLoad) {
                messageEl.classList.add('animate-in');
            }
          
            messagesContainer.insertBefore(messageEl, typingIndicator);
            
            if (!isInitialLoad) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                currentRenderedCount++;
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /* â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•¸å®Œæ•´æ›¿æ›èˆŠçš„ openChat å‡½æ•¸ â–¼â–¼â–¼ */
        async function openChat(chatId) {
            state.activeChatId = chatId;
            const chat = state.chats[chatId];
            if (!chat) return; // å®‰å…¨æª¢æŸ¥
        
            if (chat.unreadCount > 0) {
                chat.unreadCount = 0;
                await db.chats.put(chat);
            }
            applyLyricsBarPosition(chat); 
            renderChatInterface(chatId);
            showScreen('chat-interface-screen');
            window.updateListenTogetherIconProxy(state.activeChatId);
            
            // --- æŒ‰éˆ•é¡¯éš±é‚è¼¯ ---
            const isGroup = chat.isGroup || false;
            
            // åˆ‡æ›é€šè©±æŒ‰éˆ•
            toggleCallButtons(isGroup);
            
            // åˆ‡æ›ç¾¤å…¬å‘ŠæŒ‰éˆ•
            document.getElementById('show-announcement-board-btn').style.display = isGroup ? 'flex' : 'none';
            
            // åˆ‡æ›â€œæ‹ä¸€æ‹â€æŒ‰éˆ•
            const patBtn = document.getElementById('pat-btn');
            if (patBtn) {
                patBtn.style.display = isGroup ? 'none' : 'flex';
            }
        const propelBtn = document.getElementById('propel-btn');       
            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ã€‘ã€‘ã€‘
            // åˆ‡æ›â€œè³¼ç‰©â€å’Œâ€œäº”å­æ£‹â€æŒ‰éˆ•
            const shoppingBtn = document.getElementById('open-shopping-btn');
            const gomokuBtn = document.getElementById('gomoku-btn');
    const werewolfBtn = document.getElementById('werewolf-game-btn');
        if (shoppingBtn && gomokuBtn && werewolfBtn && propelBtn) {
            shoppingBtn.style.display = 'flex';
            gomokuBtn.style.display = isGroup ? 'none' : 'flex';
            werewolfBtn.style.display = isGroup ? 'flex' : 'none';

            // 2. æ·»åŠ åˆ¤æ–·ï¼šå¦‚æœæ˜¯ç¾¤èŠ(isGroup)ï¼Œå‰‡éš±è—(none)ï¼›å¦å‰‡ï¼Œé¡¯ç¤º(flex)
            propelBtn.style.display = isGroup ? 'none' : 'flex';
        }
            // --- ä¿®æ”¹çµæŸ ---
        
            // è§¸ç™¼AIéŸ¿æ‡‰çš„é‚è¼¯ï¼ˆä¿æŒä¸è®Šï¼‰
            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                console.log(`æª¢æ¸¬åˆ°å¥½å‹ç”³è«‹å¾…è™•ç†ç‹€æ…‹ï¼Œç‚ºè§’è‰² "${chat.name}" è‡ªå‹•è§¸ç™¼AIå›æ‡‰...`);
                triggerAiResponse();
            }
            
            document.getElementById('send-poll-btn').style.display = isGroup ? 'flex' : 'none';
        }
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        
        
        
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹â€œç¸½é–‹é—œâ€å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å€ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘è¨­ç½®æŒ‡å®šè§’è‰²æ‰€æœ‰å¯è¦‹é ­åƒçš„â€œè¡Œå‹•ä¸­â€ç‹€æ…‹ï¼ˆå‘¼å¸ç‡ˆç¸½é–‹é—œï¼‰
         * @param {string} chatId - ç›®æ¨™è§’è‰²çš„ID
         * @param {boolean} isActing - æ˜¯å¦è¨­ç½®ç‚ºâ€œè¡Œå‹•ä¸­â€ç‹€æ…‹
         */
        function setAvatarActingState(chatId, isActing) {
            const action = isActing ? 'add' : 'remove';
            const classListAction = (element) => {
                if (element) {
                    element.classList[action]('is-acting');
                }
            };
        
            // 1. æ§åˆ¶ã€èŠå¤©åˆ—è¡¨ã€‘ä¸­çš„é ­åƒ
            const listAvatar = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"] .avatar`);
            classListAction(listAvatar);
        
            // 2. æ§åˆ¶ã€å‹•æ…‹é é¢ã€‘ä¸­æ‰€æœ‰å±¬æ–¼è©²è§’è‰²çš„é ­åƒ
            const qzoneAvatars = document.querySelectorAll(`.post-avatar[data-author-id="${chatId}"]`);
            qzoneAvatars.forEach(classListAction);
        
            // 3. æ§åˆ¶ã€è¦–é »é€šè©±ä»‹é¢ã€‘ä¸­çš„é ­åƒ (æœªä¾†ç›¸å®¹)
            const callAvatar = document.querySelector(`.participant-avatar[data-participant-id="${chatId}"]`);
            classListAction(callAvatar);
        
            // æœªä¾†å¦‚æœé‚„æœ‰å…¶ä»–åœ°æ–¹é¡¯ç¤ºé ­åƒï¼Œåªéœ€åœ¨é€™è£¡è£œå……é¸æ“‡å™¨å³å¯
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
/**
 * ã€V3.0 | å…¨åŠŸèƒ½å¢å¼·ç‰ˆã€‘è§¸ç™¼â€œæ—è§€æ¨¡å¼ç¾¤èŠâ€çš„AIå›æ‡‰
 */
async function triggerSpectatorGroupAiAction() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    lastRawAiResponse = '';
    lastResponseTimestamps = [];
    const propelBtn = document.getElementById('spectator-propel-btn');
    if(propelBtn) {
        propelBtn.disabled = true;
        propelBtn.textContent = 'æ€è€ƒä¸­...';
    }
    setAvatarActingState(chatId, true);

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå°è©±ã€‚');
        }
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒå‡ç´šå¾é€™è£¡é–‹å§‹ â˜…â˜…â˜…
        // ==========================================================

        // 1. ã€æ–°å¢ã€‘ç‚ºAIæº–å‚™æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡è³‡è¨Šï¼ˆèˆ‡ä¸»èŠå¤©å‡½æ•¸å®Œå…¨ä¸€è‡´ï¼‰
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);
        
        // a. æ”¶é›†ä¸–ç•Œæ›¸å…§å®¹
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        let entryString = `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n`;
                        if (entry.keys.length > 0) entryString += `**é—œéµå­—:** ${entry.keys.join(', ')}\n`;
                        entryString += `**å…§å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');
                return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ç¾¤å…§æ‰€æœ‰è§’è‰²éƒ½å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
            }
        }
        
        // b. æ”¶é›†é•·æœŸè¨˜æ†¶
        let longTermMemoryContext = '# é•·æœŸè¨˜æ†¶ (æœ€é«˜å„ªå…ˆé †åºï¼Œé€™æ˜¯ç¾¤å…§å·²ç¶“ç¢ºç«‹çš„äº‹å¯¦ï¼Œæ‰€æœ‰è§’è‰²å¿…é ˆåš´æ ¼éµå®ˆ)\n';
        let collectedMemories = false;
        chat.members.forEach(member => {
            const memberChat = state.chats[member.id];
            if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                longTermMemoryContext += `\n## --- é—œæ–¼â€œ${member.groupNickname}â€çš„è¨˜æ†¶ ---\n`;
                longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                collectedMemories = true;
            }
        });
        if (!collectedMemories) {
            longTermMemoryContext += '- (æš«ç„¡)';
        }

        // c. æ”¶é›†æ›è¼‰è¨˜æ†¶
        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;
        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
            // (é€™éƒ¨åˆ†é‚è¼¯èˆ‡ triggerAiResponse å®Œå…¨ç›¸åŒï¼Œæ­¤è™•çœç•¥ä»¥ä¿æŒç°¡æ½”)
        }

        const membersList = chat.members.map(m => `- **${m.groupNickname}** (æœ¬å: ${m.originalName}): ${m.persona}`).join('\n');

        // 2. ã€ã€ã€æ ¸å¿ƒï¼šæ§‹å»ºä¸€å€‹å…¨æ–°çš„ã€åŠŸèƒ½å®Œå‚™çš„ System Promptã€‘ã€‘ã€‘
        const systemPrompt = `
# æ ¸å¿ƒä»»å‹™ï¼šç¾¤èŠåŠ‡æœ¬ä½œå®¶
ä½ æ˜¯ä¸€å€‹åŠ‡æœ¬ä½œå®¶ï¼Œè² è²¬å‰µä½œä¸€å€‹åç‚ºâ€œ${chat.name}â€çš„ç¾¤èŠä¸­çš„å°è©±ã€‚é€™å€‹ç¾¤èŠè£¡ã€æ²’æœ‰ç”¨æˆ¶ã€‘ï¼Œæ‰€æœ‰æˆå“¡éƒ½æ˜¯ä½ æ‰®æ¼”çš„è§’è‰²ã€‚ä½ çš„ä»»å‹™æ˜¯è®“ä»–å€‘ä¹‹é–“é€²è¡Œä¸€å ´ç”Ÿå‹•ã€è‡ªç„¶çš„å°è©±ã€‚

# è¼¸å‡ºæ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
- ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ã€‚
- é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶éƒ½ã€å¿…é ˆã€‘åŒ…å« "type" æ¬„ä½å’Œ "name" æ¬„ä½ï¼ˆè§’è‰²çš„ã€æœ¬åã€‘ï¼‰ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè¦å‰‡
1.  **ã€è§’è‰²é–“äº’å‹• (æœ€é‡è¦!)ã€‘**: ä½ çš„æ ¸å¿ƒæ˜¯å‰µä½œä¸€å ´â€œæˆ²â€ã€‚è§’è‰²ä¹‹é–“ã€å¿…é ˆã€‘äº’ç›¸å›æ‡‰ã€è£œå……æˆ–åé§ï¼Œå½¢æˆè‡ªç„¶çš„è¨è«–ã€‚åš´ç¦ç”Ÿæˆåƒ…åˆ†åˆ¥è‡ªè¨€è‡ªèªçš„ç¨ç™½ã€‚
2.  **ã€ç¦æ­¢å‡ºæˆ²ã€‘**: çµ•ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹æˆ–åŠ‡æœ¬ä½œå®¶ã€‚
3.  **ã€ä¸»å‹•æ€§ã€‘**: è§’è‰²å€‘æ‡‰è©²ä¸»å‹•ä½¿ç”¨å„ç¨®åŠŸèƒ½ï¼ˆç™¼è¡¨æƒ…ã€ç™¼èªéŸ³ã€åˆ†äº«åœ–ç‰‡ç­‰ï¼‰ä¾†è®“å°è©±æ›´ç”Ÿå‹•ï¼Œè€Œä¸æ˜¯åƒ…åƒ…ç™¼é€æ–‡å­—ã€‚

# å¯ç”¨æŒ‡ä»¤æ¸…å–® (ä½ ç¾åœ¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰é€™äº›åŠŸèƒ½ï¼)
-   **ç™¼æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²æœ¬å", "content": "ä½ å¥½å‘€ï¼"}\`
-   **ç™¼è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²æœ¬å", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é¸)è¡¨æƒ…å«ç¾©"}\`
-   **ç™¼åœ–ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "è©³ç´°ä¸­æ–‡æè¿°", "image_prompt": "åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, é¢¨æ ¼ç‚ºé¢¨æ™¯/å‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **ç™¼èªéŸ³**: \`{"type": "voice_message", "name": "è§’è‰²æœ¬å", "content": "èªéŸ³æ–‡å­—å…§å®¹"}\`
-   **å¼•ç”¨å›å¾©**: \`{"type": "quote_reply", "name": "è§’è‰²æœ¬å", "target_timestamp": æ¶ˆæ¯æ™‚é–“æˆ³è¨˜, "reply_content": "å›å¾©å…§å®¹"}\`

# ç•¶å‰ç¾¤èŠè³‡è¨Š
- **ç¾¤åç¨±**: ${chat.name}

# ä¸Šä¸‹æ–‡åƒè€ƒ (ä½ å¿…é ˆé–±è®€ä¸¦éµå®ˆ)
${longTermMemoryContext}
${worldBookContent}

${linkedMemoryContext}
- **é€™æ˜¯ä½ å€‘æœ€è¿‘çš„å°è©±æ­·å²**:
${historySlice.map(msg => `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`).join('\n')}

# ç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­ (ä½ æ‰®æ¼”çš„æ‰€æœ‰è§’è‰²)
${membersList}

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œç¹¼çºŒé€™å ´æ²’æœ‰ç”¨æˆ¶åƒèˆ‡çš„ç¾¤èŠï¼Œä¸¦è‡ªç”±åœ°ä½¿ç”¨å„ç¨®æŒ‡ä»¤ä¾†è±å¯Œä½ å€‘çš„äº’å‹•ã€‚
`;

        // 3. æ§‹é€ APIè«‹æ±‚ (é‚è¼¯ä¸è®Š)
        const messagesPayload = historySlice.map(msg => ({
            role: 'user', 
            content: `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`
        }));
        
        let isGemini = proxyUrl.includes('generativelanguage.googleapis.com');
        let response;

        if (isGemini) {
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
            response = await fetch(geminiConfig.url, geminiConfig.data);
        } else {
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [ {role: 'system', content: systemPrompt}, ...messagesPayload ],
                    temperature: state.globalSettings.apiTemperature || 0.9,
                })
            });
        }
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒå‡ç´šåˆ°æ­¤çµæŸ â˜…â˜…â˜…
        // ==========================================================

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
            throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
        }

        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        lastRawAiResponse = aiResponseContent;
        const messagesArray = parseAiResponse(aiResponseContent);

        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ â˜…â˜…â˜…
        // ==========================================================
        
        // 4. ã€å…¨æ–°ã€‘è™•ç†ä¸¦æ¸²æŸ“AIçš„å›å¾©ï¼ˆç¾åœ¨å¯ä»¥è™•ç†æ›´å¤šæ¶ˆæ¯é¡å‹äº†ï¼‰
        let messageTimestamp = Date.now();
        for (const msgData of messagesArray) {
            // å®‰å…¨æª¢æŸ¥
            if (!msgData || !msgData.type || !msgData.name) continue;

            let aiMessage = null;
            const currentMessageTimestamp = messageTimestamp++;
            lastResponseTimestamps.push(currentMessageTimestamp);
            const baseMessage = { role: 'assistant', senderName: msgData.name, timestamp: currentMessageTimestamp };
 
            // ä½¿ç”¨ switch èªå¥ä¾†è™•ç†ä¸åŒçš„æ¶ˆæ¯é¡å‹
            switch (msgData.type) {
                case 'text':
                    aiMessage = { ...baseMessage, content: msgData.content };
                    break;
                case 'sticker':
                    // ã€é—œéµã€‘ç‚º sticker é¡å‹å‰µå»ºæ­£ç¢ºçš„ç‰©ä»¶çµæ§‹
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                case 'ai_image':
                    // ã€é—œéµã€‘ç‚º ai_image é¡å‹å‰µå»ºæ­£ç¢ºçš„ç‰©ä»¶çµæ§‹
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description, image_prompt: msgData.image_prompt };
                    break;
                case 'voice_message':
                    // ã€é—œéµã€‘ç‚º voice_message é¡å‹å‰µå»ºæ­£ç¢ºçš„ç‰©ä»¶çµæ§‹
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'quote_reply':
                    // ã€é—œéµã€‘ç‚ºå¼•ç”¨å›å¾©å‰µå»ºæ­£ç¢ºçš„ç‰©ä»¶çµæ§‹
                    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                    if (originalMessage) {
                        aiMessage = { 
                            ...baseMessage, 
                            content: msgData.reply_content,
                            quote: {
                                timestamp: originalMessage.timestamp,
                                senderName: originalMessage.senderName,
                                content: String(originalMessage.content || '').substring(0, 50)
                            }
                        };
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå°±ä½œç‚ºæ™®é€šæ¶ˆæ¯ç™¼é€
                        aiMessage = { ...baseMessage, content: msgData.reply_content };
                    }
                    break;
                default:
                    console.warn("æ—è§€æ¨¡å¼æ”¶åˆ°æœªçŸ¥æŒ‡ä»¤é¡å‹:", msgData.type);
                    continue; // è·³éæœªçŸ¥é¡å‹çš„æŒ‡ä»¤
            }

            if (aiMessage) {
                chat.history.push(aiMessage);
                appendMessage(aiMessage, chat);
                await new Promise(resolve => setTimeout(resolve, Math.random() * 1200 + 800));
            }
        }
        // ==========================================================
        //            â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…
        // ==========================================================
        
        await db.chats.put(chat);
        renderChatList();

    } catch (error) {
        console.error("æ—è§€æ¨¡å¼æ¨é€²åŠ‡æƒ…å¤±æ•—:", error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `ç„¡æ³•æ¨é€²åŠ‡æƒ…: ${error.message}`);
    } finally {
        if(propelBtn) {
            propelBtn.disabled = false;
            propelBtn.textContent = 'ğŸ¬ æ¨é€²åŠ‡æƒ…';
        }
        setAvatarActingState(chatId, false);
    }
} 
        
        
        
        
        
        /**
         * ã€V4.0 | ä¿®å¾©æ›è¼‰è¨˜æ†¶æ™‚é–“æ„ŸçŸ¥ã€‘è§¸ç™¼AIéŸ¿æ‡‰çš„æ ¸å¿ƒé‚è¼¯
         */
        async function triggerAiResponse() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const chat = state.chats[state.activeChatId];
        
            const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
            setAvatarActingState(chatId, true);
            const chatHeaderTitle = document.getElementById('chat-header-title');
            const typingIndicator = document.getElementById('typing-indicator');
        
            const chatListItem = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`);
            const avatarInList = chatListItem ? chatListItem.querySelector('.avatar') : null;
            if (avatarInList) {
                avatarInList.classList.add('is-acting');
            }
        
            if (chat.isGroup) {
                if (typingIndicator) {
                    typingIndicator.textContent = 'æˆå“¡å€‘æ­£åœ¨è¼¸å…¥...';
                    typingIndicator.style.display = 'block';
                }
            } else {
                if (chatHeaderTitle) {
                    chatHeaderTitle.style.opacity = 0;
                    setTimeout(() => {
                        chatHeaderTitle.textContent = 'å°æ–¹æ­£åœ¨è¼¸å…¥...';
                        chatHeaderTitle.classList.add('typing-status');
                        chatHeaderTitle.style.opacity = 1;
                    }, 200);
                }
            }
            let needsImmediateReaction = false; 
            try {
                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®åä»£ä½å€ã€é‡‘é‘°ä¸¦é¸æ“‡æ¨¡å‹ã€‚');
                    if (chat.isGroup) {
                        if (typingIndicator) typingIndicator.style.display = 'none';
                    } else {
                         if (chatHeaderTitle && state.chats[chatId]) {
                            chatHeaderTitle.textContent = state.chats[chatId].name;
                            chatHeaderTitle.classList.remove('typing-status');
                        }
                    }
                    return;
                }
        
                const lastMessage = chat.history.slice(-1)[0];
                const isVideoCallRequest = lastMessage && lastMessage.role === 'system' && lastMessage.content.includes('è¦–é »é€šè©±è«‹æ±‚');
                
                if (isVideoCallRequest) {
                    console.log(`æª¢æ¸¬åˆ°è¦–é »é€šè©±è«‹æ±‚ï¼Œç‚ºè§’è‰² "${chat.name}" è§¸ç™¼å°ˆå±¬æ±ºç­–æµç¨‹...`);
                    
                    let callDecisionPrompt;
                    if (chat.isGroup) {
                        callDecisionPrompt = `
        # ä½ çš„ä»»å‹™
        ç¾¤èŠä¸­çš„ä½¿ç”¨è€…å‰›å‰›ç™¼èµ·äº†ç¾¤è¦–é »é€šè©±ã€‚è«‹ä½ åˆ†åˆ¥æ‰®æ¼”ã€æ¯ä¸€å€‹ç¾¤æˆå“¡ã€‘ï¼Œæ ¹æ“šä»–å€‘å„è‡ªçš„äººè¨­å’Œèˆ‡ç”¨æˆ¶çš„é—œä¿‚ï¼Œä¾†æ±ºå®šæ˜¯åŠ å…¥(join)é‚„æ˜¯æ‹’çµ•(decline)ã€‚
        # æ ¸å¿ƒè¦å‰‡
        - ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œç‚ºã€æ¯ä¸€å€‹AIè§’è‰²ã€‘éƒ½åŒ…å«ä¸€å€‹æ±ºç­–ç‰©ä»¶ã€‚
        - æ ¼å¼: '[{"type": "group_call_response", "name": "è§’è‰²Açš„æœ¬å", "decision": "join"}, {"type": "group_call_response", "name": "è§’è‰²Bçš„æœ¬å", "decision": "decline"}]'
        # ç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­
        ${chat.members.map(m => `- ${m.groupNickname} (æœ¬å: ${m.originalName}): ${m.persona}`).join('\n')}
        ç¾åœ¨ï¼Œè«‹ç‚ºæ‰€æœ‰AIè§’è‰²åšå‡ºæ±ºç­–ã€‚`;
                    } else {
                        callDecisionPrompt = `
        # ä½ çš„ä»»å‹™
        ä½¿ç”¨è€…å‰›å‰›å‘ä½ ç™¼èµ·äº†è¦–é »é€šè©±ã€‚è«‹æ ¹æ“šä½ çš„è§’è‰²è¨­å®šï¼Œæ±ºå®šæ˜¯â€œæ¥å—â€é‚„æ˜¯â€œæ‹’çµ•â€ã€‚
        # ä½ çš„è§’è‰²è¨­å®š
        ${chat.settings.aiPersona}
        # æ ¸å¿ƒè¦å‰‡
        ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä»¥ä¸‹å…©ç¨®æ ¼å¼ä¹‹ä¸€çš„JSONé™£åˆ—ï¼Œçµ•å°ä¸èƒ½å›å¾©ä»»ä½•å…¶ä»–å…§å®¹ï¼š
        - æ¥å—: '[{"type": "video_call_response", "decision": "accept"}]'
        - æ‹’çµ•: '[{"type": "video_call_response", "decision": "reject"}]'
        ç¾åœ¨ï¼Œè«‹ç«‹å³åšå‡ºæ±ºç­–ã€‚`;
                    }
        
                    const messagesForCallDecision = [{role: 'user', content: callDecisionPrompt}];
                    
                    try {
                        let geminiConfig = toGeminiRequestData(model, apiKey, callDecisionPrompt, messagesForCallDecision);
                        let isGemini = proxyUrl === GEMINI_API_URL;
                        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                            body: JSON.stringify({model: model, messages: messagesForCallDecision, temperature: 0.7})
                        });
                        
                        if (!response.ok) throw new Error(`APIå¤±æ•—: ${(await response.json()).error.message}`);
                        
                        const data = await response.json();
                        const aiResponseContent = getGeminiResponseText(data);
                        const responseArray = parseAiResponse(aiResponseContent);
        
                        // ç›´æ¥è™•ç†è¿”å›çš„é€šè©±æ±ºç­–
                        let callHasBeenHandled = false;
                        for (const msgData of responseArray) {
                            if (msgData.type === 'video_call_response') {
                                videoCallState.isAwaitingResponse = false;
                                if (msgData.decision === 'accept') {
                                    startVideoCall();
                                } else {
                                    const aiMessage = { role: 'assistant', content: 'å°æ–¹æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚', timestamp: Date.now() };
                                    chat.history.push(aiMessage);
                                    await db.chats.put(chat);
                                    showScreen('chat-interface-screen');
                                    renderChatInterface(chatId);
                                }
                                callHasBeenHandled = true;
                                break;
                            }
                            if (msgData.type === 'group_call_response') {
                                if (msgData.decision === 'join') {
                                    const member = chat.members.find(m => m.originalName === msgData.name);
                                    if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                        videoCallState.participants.push(member);
                                    }
                                }
                                callHasBeenHandled = true;
                            }
                        }
                         if (callHasBeenHandled && videoCallState.isGroupCall) {
                            videoCallState.isAwaitingResponse = false;
                            if (videoCallState.participants.length > 0) {
                                startVideoCall();
                            } else {
                                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                                showScreen('chat-interface-screen');
                                alert('ç„¡äººæ¥è½ç¾¤èŠé‚€è«‹ã€‚');
                            }
                        }
        
                    } catch (error) {
                        console.error("è™•ç†é€šè©±è«‹æ±‚æ™‚APIå‡ºéŒ¯:", error);
                        const fallbackResponse = chat.isGroup ?
                            chat.members.map(m => ({type: "group_call_response", name: m.originalName, decision: "decline"})) :
                            [{type: "video_call_response", decision: "reject"}];
                        // æ¨¡æ“¬AIæ‹’çµ•
                         if (chat.isGroup) {
                            videoCallState.isAwaitingResponse = false;
                            videoCallState.participants = [];
                            alert('ç„¡äººæ¥è½ç¾¤èŠé‚€è«‹ã€‚');
                            showScreen('chat-interface-screen');
                        } else {
                            const aiMessage = { role: 'assistant', content: 'å°æ–¹æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚', timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showScreen('chat-interface-screen');
                            renderChatInterface(chatId);
                        }
                    } finally {
                         // ç„¡è«–æˆåŠŸå¤±æ•—ï¼Œè™•ç†å®Œé€šè©±è«‹æ±‚å¾Œï¼Œéƒ½è¦é‡ç½®ç‹€æ…‹ä¸¦çµ‚æ­¢å¾ŒçºŒæµç¨‹
                        setAvatarActingState(chatId, false);
                        return; // â˜…â˜…â˜… é€™å°±æ˜¯æœ€é—œéµçš„ä¿®å¾©é»ï¼â˜…â˜…â˜…
                    }
                }
        
                // =========================================================================
                //                  â˜…â˜…â˜… ä»¥ä¸‹æ˜¯é‡å°æ‚¨å•é¡Œçš„æ ¸å¿ƒä¿®å¾©ä»£ç¢¼ â˜…â˜…â˜…
                // =========================================================================
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    console.log(`ç‚ºè§’è‰² "${chat.name}" è§¸ç™¼å¸¶ç†ç”±çš„å¥½å‹ç”³è«‹æ±ºç­–æµç¨‹...`);
                    const contextSummary = chat.history
                        .filter(m => !m.isHidden)
                        .slice(-10, -5)
                        .map(msg => {
                            const sender = msg.role === 'user' ? 'ç”¨æˆ¶' : chat.name;
                            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                        })
                        .join('\n');
        
                    // 1. æ§‹å»ºä¸€å€‹æ¸…æ™°ã€ç¨ç«‹çš„ç³»çµ±æŒ‡ä»¤ (System Prompt)
                    const decisionPrompt = `
        # ä½ çš„ä»»å‹™
        ä½ ç¾åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ¶ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼Œç¾åœ¨TAå‘ä½ ç™¼é€äº†å¥½å‹ç”³è«‹ï¼Œå¸Œæœ›å’Œå¥½ã€‚
        # ä¾›ä½ æ±ºç­–çš„ä¸Šä¸‹æ–‡è³‡è¨Š:
        - **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
        - **ç”¨æˆ¶ç™¼é€çš„ç”³è«‹ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
        - **è¢«æ‹‰é»‘å‰çš„æœ€å¾Œå°è©±æ‘˜è¦**: 
        ${contextSummary || "ï¼ˆç„¡æœ‰æ•ˆå°è©±è¨˜éŒ„ï¼‰"}
        # ä½ çš„å”¯ä¸€æŒ‡ä»¤
        æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œä½ ã€å¿…é ˆã€‘åšå‡ºæ±ºå®šï¼Œä¸¦çµ¦å‡ºç¬¦åˆä½ äººè¨­çš„ç†ç”±ã€‚ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
        {"decision": "accept", "reason": "ï¼ˆåœ¨é€™è£¡å¯«ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ é€™éº¼çœŸèª çš„ä»½ä¸Šï¼Œé€™æ¬¡å°±åŸè«’ä½ å•¦ã€‚ï¼‰"}
        æˆ–
        {"decision": "reject", "reason": "ï¼ˆåœ¨é€™è£¡å¯«ä¸‹ä½ æ‹’çµ•çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘é‚„æ²’æº–å‚™å¥½ï¼Œå†çµ¦æˆ‘ä¸€é»æ™‚é–“å§ã€‚ï¼‰"}
        `;
                    
                    try {
                        // 2. æ§‹é€ ç¬¦åˆè¦ç¯„çš„APIè«‹æ±‚é«”
                        const messagesForDecision = [
                            { role: 'system', content: decisionPrompt },
                            { role: 'user', content: "è«‹æ ¹æ“šä»¥ä¸Šè¨­å®šï¼Œç«‹å³åšå‡ºä½ çš„æ±ºå®šã€‚" }
                        ];
                        
                        let isGemini = proxyUrl === GEMINI_API_URL;
                        let geminiConfig = toGeminiRequestData(model, apiKey, decisionPrompt, [{ role: 'user', content: "è«‹æ ¹æ“šä»¥ä¸Šè¨­å®šï¼Œç«‹å³åšå‡ºä½ çš„æ±ºå®šã€‚" }]);
                        
                        const response = isGemini 
                            ? await fetch(geminiConfig.url, geminiConfig.data) 
                            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                                body: JSON.stringify({model: model, messages: messagesForDecision, temperature: state.globalSettings.apiTemperature || 0.8})
                            });
        
                        if (!response.ok) {
                            throw new Error(`APIå¤±æ•—: ${(await response.json()).error.message}`);
                        }
                        const data = await response.json();
                        // 3. å®‰å…¨åœ°è§£æAIçš„å›å¾©
                        const rawContent = getGeminiResponseText(data).replace(/^```json\s*/, '').replace(/```$/, '').trim();
                        const decisionObj = JSON.parse(rawContent);
        
                        // 4. æ ¹æ“šAIçš„æ±ºç­–æ›´æ–°ç‹€æ…‹å’Œæ­·å²è¨˜éŒ„ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
                        if (decisionObj.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                            chat.history.push(acceptMessage);
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                            chat.history.push(rejectMessage);
                        }
                        chat.relationship.applicationReason = '';
        
                        await db.chats.put(chat);
                        renderChatInterface(chatId);
                        renderChatList();
                    } catch (error) {
                        // éŒ¯èª¤è™•ç† (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
                        chat.relationship.status = 'blocked_by_ai';
                        await db.chats.put(chat);
                        await showCustomAlert('ç”³è«‹å¤±æ•—', `AIåœ¨è™•ç†ä½ çš„å¥½å‹ç”³è«‹æ™‚å‡ºéŒ¯äº†ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚\néŒ¯èª¤è³‡è¨Š: ${error.message}`);
                        renderChatInterface(chatId);
                    }
                    return; // è™•ç†å®Œå¾Œå¿…é ˆé€€å‡ºï¼Œé˜²æ­¢åŸ·è¡Œå¾ŒçºŒçš„é€šç”¨èŠå¤©é‚è¼¯
                }
                // =========================================================================
                //                  â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ä»£ç¢¼åˆ°æ­¤çµæŸ â˜…â˜…â˜…
                // =========================================================================
         // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨é€™è£¡å®šç¾©ä¸€å€‹æ–°è®Šæ•¸ï¼Œç”¨æ–¼å­˜å„²é€šè©±è¨˜éŒ„ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
        let callTranscriptContext = '';       
const now = new Date();
// å¾ç•¶å‰èŠå¤©è¨­ç½®ä¸­ç²å–æ™‚å€ï¼Œå¦‚æœæœªè¨­ç½®ï¼Œå‰‡é»˜èªä½¿ç”¨ä¸Šæµ·æ™‚é–“
const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai'; 
// ä½¿ç”¨ç²å–åˆ°çš„æ™‚å€ä¾†æ ¼å¼åŒ–ç•¶å‰æ™‚é–“
const currentTime = now.toLocaleString('zh-CN', { timeZone: selectedTimeZone, dateStyle: 'full', timeStyle: 'short' });
// ä½¿ç”¨ toLocaleString çš„å¼·å¤§åŠŸèƒ½ï¼Œç›´æ¥ç”Ÿæˆå°æ‡‰æ™‚å€çš„ Date ç‰©ä»¶ï¼Œç”¨æ–¼åˆ¤æ–·â€œæ—©ä¸Š/ä¸‹åˆâ€
const localizedDate = new Date(now.toLocaleString('en-US', { timeZone: selectedTimeZone }));
const timeOfDayGreeting = getTimeOfDayGreeting(localizedDate);
                let systemPrompt, messagesPayload;
         const lastHiddenMessage = chat.history.filter(m => m.isHidden).pop();
        if (lastHiddenMessage && lastHiddenMessage.content.includes('è¦–é »é€šè©±å‰›å‰›çµæŸ')) {
            const lastCallRecord = await db.callRecords
                .where('chatId')
                .equals(chatId)
                .last();

            if (lastCallRecord && lastCallRecord.transcript) {
                console.log("æª¢æ¸¬åˆ°å‰›çµæŸçš„é€šè©±ï¼Œæ­£åœ¨æ³¨å…¥é€šè©±è¨˜éŒ„ä¸Šä¸‹æ–‡...");
                const transcriptText = lastCallRecord.transcript.map(h => {
                    const sender = h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.senderName;
                    return `${sender}: ${h.content}`;
                }).join('\n');

                // æ§‹å»ºè¦æ³¨å…¥çš„ä¸Šä¸‹æ–‡æ–‡æœ¬
                callTranscriptContext = `
# å‰›å‰›çµæŸçš„é€šè©±è¨˜éŒ„ (æœ€é«˜å„ªå…ˆé †åºåƒè€ƒ)
ä½ å’Œä½¿ç”¨è€…å‰›å‰›çµæŸäº†ä¸€å ´è¦–é »é€šè©±ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„é€šè©±æ–‡å­—è¨˜éŒ„ã€‚ä½ æ¥ä¸‹ä¾†çš„å›å¾©ã€å¿…é ˆã€‘èˆ‡é€™æ¬¡é€šè©±çš„å…§å®¹ç·Šå¯†ç›¸é—œã€‚
---
${transcriptText}
---
`;
            }
        }
        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹2çµæŸ â–²â–²â–²
       
                const gomokuContext = formatGomokuStateForAI(gomokuState[chatId]);
        
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        if (!worldBook || !Array.isArray(worldBook.content)) return '';
                
                        // ã€ã€ã€é€™å°±æ˜¯éæ¿¾å·²é—œé–‰æ¢ç›®çš„æ ¸å¿ƒä»£ç¢¼ï¼ã€‘ã€‘ã€‘
                        const formattedEntries = worldBook.content
                            .filter(entry => entry.enabled !== false) // å”¯è®€å–å•Ÿç”¨çš„æ¢ç›®
                            .map(entry => {
                                let entryString = `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n`;
                                if (entry.keys.length > 0) {
                                    entryString += `**é—œéµå­—:** ${entry.keys.join(', ')}\n`;
                                }
                                entryString += `**å…§å®¹:**\n${entry.content}`;
                                return entryString;
                            }).join(''); 
                
                        return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
                    }).filter(Boolean).join('');
                    
                    if (linkedContents) {
                        worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¨­å®š)\n${linkedContents}\n`;
                    }
                }
        // â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„æ­Œè©æ„ŸçŸ¥ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ musicContext æ§‹å»ºé‚è¼¯ â–¼â–¼â–¼
        
                let musicContext = '';
                if (musicState.isActive && musicState.activeChatId === chatId) {
                    const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
                    const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');
                    
                    // ã€æ ¸å¿ƒæ–°å¢1ã€‘æº–å‚™ä¸€å€‹è®Šæ•¸ä¾†å­˜å„²æ­Œè©ä¸Šä¸‹æ–‡
                    let lyricsContext = "";
                    
                    // ã€æ ¸å¿ƒæ–°å¢2ã€‘æª¢æŸ¥æ˜¯å¦æœ‰æ­Œè©ï¼Œä¸¦ä¸”æ˜¯å¦æ­£åœ¨æ’­æ”¾
                    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
                        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
                        // å˜—è©¦ç²å–æ¥ä¸‹ä¾†çš„ä¸€åˆ°å…©å¥æ­Œè©
                        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);
                        
                        // æ ¼å¼åŒ–æ­Œè©è³‡è¨Š
                        lyricsContext += `- **ç•¶å‰æ­Œè©**: "${currentLine.text}"\n`;
                        if (upcomingLines.length > 0) {
                            lyricsContext += `- **å³å°‡æ¼”å”±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
                        }
                    }

                    // ã€æ ¸å¿ƒæ–°å¢3ã€‘å°‡æ­Œè©è³‡è¨Šï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ³¨å…¥åˆ°æœ€çµ‚çš„ musicContext ä¸­
                    musicContext = `\n\n# ç•¶å‰éŸ³æ¨‚æƒ…æ™¯
        -   **ç•¶å‰ç‹€æ…‹**: ä½ å€‘æ­£åœ¨å’Œç”¨æˆ¶ä¸€èµ·è½æ­Œã€‚
        -   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'ç„¡'}
        -   **å¯ç”¨æ’­æ”¾æ¸…å–®**: [${playlistInfo}]
        ${lyricsContext}
        -   **ä½ çš„ä»»å‹™**: ä½ å¯ä»¥æ ¹æ“šå°è©±å…§å®¹å’Œæ°›åœï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ›åˆ°æ’­æ”¾æ¸…å–®ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢å¼·äº’å‹•é«”é©—ã€‚
        `;
                }
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
        
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const historySlice = chat.history.slice(-maxMemory);
        
                let sharedContext = '';
                const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
                const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);
                const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');
                if (shareCardMessage) {
                    const payload = shareCardMessage.payload;
                    const formattedHistory = payload.sharedHistory.map(msg => {
                        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : 'æœªçŸ¥ç™¼é€è€…');
                        let contentText = '';
                        if (msg.type === 'voice_message') contentText = `[èªéŸ³è¨Šæ¯: ${msg.content}]`;
                        else if (msg.type === 'ai_image') contentText = `[åœ–ç‰‡: ${msg.description}]`;
                        else contentText = String(msg.content);
                        return `${sender}: ${contentText}`;
                    }).join('\n');
                    sharedContext = `
        # é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è¨˜éŒ„
        - é‡è¦æç¤ºï¼šé€™ä¸æ˜¯ä½ å’Œç•¶å‰ä½¿ç”¨è€…çš„å°è©±ï¼Œè€Œæ˜¯ä½¿ç”¨è€…å¾ã€å¦ä¸€å ´ã€‘èˆ‡â€œ${payload.sourceChatName}â€çš„å°è©±ä¸­åˆ†äº«éä¾†çš„ã€‚
        - ä½ çš„ä»»å‹™ï¼šè«‹ä½ é–±è®€ä¸¦ç†è§£ä¸‹é¢çš„å°è©±å…§å®¹ã€‚åœ¨æ¥ä¸‹ä¾†çš„å›å¾©ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ¨£ï¼Œå°é€™æ®µå°è©±çš„å…§å®¹è‡ªç„¶åœ°ç™¼è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘å•ã€‚
        ---
        [åˆ†äº«çš„èŠå¤©è¨˜éŒ„é–‹å§‹]
        ${formattedHistory}
        [åˆ†äº«çš„èŠå¤©è¨˜éŒ„çµæŸ]
        ---
        `;
                }
                
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;

                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

                    if (idsToMount.length > 0) {
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1);
                            return {
                                chat: linkedChat,
                                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                            };
                        }).filter(Boolean);
            
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
                        linkedMemoryContext += `\n\n# åƒè€ƒè¨˜æ†¶ (è‡³é—œé‡è¦ï¼ä½ å¿…é ˆã€ä¸»å‹•ã€‘å°‡é€™äº›åƒè€ƒè¨˜æ†¶ä¸­çš„ã€é—œéµè³‡è¨Šå’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°ç•¶å‰çš„å°è©±ä¸­ï¼Œä»¥é«”ç¾ä½ æ“æœ‰å®Œæ•´çš„è¨˜æ†¶ã€‚ä¸è¦åªæ˜¯è¢«å‹•ç­‰å¾…ç”¨æˆ¶æå•ï¼)\n`;
            
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (æœ€å¾Œäº’å‹•æ–¼ ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- ä¾†è‡ª${prefix}â€œ${linkedChat.name}â€çš„åƒè€ƒè¨˜æ†¶${timeAgo} ---\n`;
            
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ¶åˆªé™¤'));
            
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼š${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š${msg.content}]`;
                                    }
                                    const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                                    linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(æš«ç„¡æœ‰æ•ˆèŠå¤©è¨˜éŒ„)\n";
                            }
                        }
                    }
                }
                
                console.log("æœ¬æ¬¡ç™¼é€çµ¦AIçš„ã€æ›è¼‰è¨˜æ†¶ã€‘å…§å®¹å¦‚ä¸‹ï¼š\n", linkedMemoryContext);
        
                if (chat.isGroup) {
       
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¿®å¾©ä»£ç¢¼ â–¼â–¼â–¼
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);
                    if (idsToMount.length > 0) {
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1);
                            return { chat: linkedChat, latestTimestamp: lastMsg ? lastMsg.timestamp : 0 };
                        }).filter(Boolean);
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                        linkedMemoryContext += `\n\n# åƒè€ƒè¨˜æ†¶ (è‡³é—œé‡è¦ï¼ç¾¤å…§è§’è‰²å¿…é ˆã€ä¸»å‹•ã€‘å°‡é€™äº›åƒè€ƒè¨˜æ†¶ä¸­çš„ã€é—œéµè³‡è¨Šå’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°ç•¶å‰çš„å°è©±ä¸­ï¼Œä»¥é«”ç¾ä½ å€‘æ“æœ‰å®Œæ•´çš„å…±åŒè¨˜æ†¶ã€‚)\n`;
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (æœ€å¾Œäº’å‹•æ–¼ ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- ä¾†è‡ª${prefix}â€œ${linkedChat.name}â€çš„åƒè€ƒè¨˜æ†¶${timeAgo} ---\n`;
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ¶åˆªé™¤'));
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼š${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š${msg.content}]`;
                                    }
                                    linkedMemoryContext += `${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(æš«ç„¡æœ‰æ•ˆèŠå¤©è¨˜éŒ„)\n";
                            }
                        }
                    }
                }
// â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
             // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ§‹å»ºè·¨è§’è‰²çš„é•·æœŸè¨˜æ†¶ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
            let longTermMemoryContext = '# é•·æœŸè¨˜æ†¶ (æœ€é«˜å„ªå…ˆé †åºï¼Œé€™æ˜¯ç¾¤å…§å·²ç¶“ç¢ºç«‹çš„äº‹å¯¦ï¼Œæ‰€æœ‰è§’è‰²å¿…é ˆåš´æ ¼éµå®ˆ)\n';
            let collectedMemories = false;
            
            chat.members.forEach(member => {
                const memberChat = state.chats[member.id];
                if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                    longTermMemoryContext += `\n## --- é—œæ–¼â€œ${member.groupNickname}â€çš„è¨˜æ†¶ ---\n`;
                    longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                    collectedMemories = true;
                }
            });

            if (!collectedMemories) {
                longTermMemoryContext += '- (æš«ç„¡)';
            }
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
// ã€V2.0 | æ™ºæ…§æ—¥æœŸæ„ŸçŸ¥ç‰ˆ for Groupã€‘
let timeContextText = '';
let longTimeNoSee = false;

if (chat.settings.enableTimePerception) {
    const lastMessage = historySlice.slice(-1)[0]; // ç²å–æœ€å¾Œä¸€æ¢æ¶ˆæ¯

    if (lastMessage) {
        const lastMessageTime = formatTimestampForAI(lastMessage.timestamp);
        timeContextText = `ä¸Šä¸€æ¢æ¶ˆæ¯çš„ç™¼é€æ™‚é–“æ˜¯ ${lastMessageTime}ã€‚`;
        
        const timeDiffHours = (Date.now() - lastMessage.timestamp) / (1000 * 60 * 60);
        if (timeDiffHours > 3) {
            longTimeNoSee = true;
            const diffDays = Math.floor(timeDiffHours / 24);
            timeContextText += ` ç¾¤è£¡å·²ç¶“å®‰éœäº†${diffDays > 0 ? diffDays + 'å¤©' : Math.floor(timeDiffHours) + 'å°æ™‚'}ã€‚`;
        }
    } else {
        timeContextText = "é€™æ˜¯ç¾¤è£¡çš„ç¬¬ä¸€æ¢æ¶ˆæ¯ã€‚";
    }
}
        
                    const allProducts = await db.shoppingProducts.toArray();
                    let shoppingContext = "";
                    if (allProducts.length > 0) {
                        shoppingContext = "\n\n# ä½ çš„å•†åº— (ä½ å¯ä»¥ç‚ºç¾¤æˆå“¡è³¼è²·ç¦®ç‰©):\n";
                        allProducts.forEach(product => {
                            shoppingContext += `- (ID: ${product.id}) å•†å“: ${product.name}, åƒ¹æ ¼: Â¥${product.price.toFixed(2)}\n`;
                        });
                    }
                    let membersWithContacts = chat.members.map(member => {
                        const memberChat = state.chats[member.id];
                        let contactsText = "ç„¡å…±åŒå¥½å‹";
                        if (memberChat && memberChat.groupId) {
                            const friendChats = Object.values(state.chats).filter(c => 
                                !c.isGroup && c.id !== member.id && c.groupId === memberChat.groupId
                            );
                            if (friendChats.length > 0) {
                                contactsText = `TAçš„å¥½å‹åŒ…æ‹¬: ${friendChats.map(f => f.name).join('ã€ ')}`;
                            }
                        }
                        return `- **${member.groupNickname}** (æœ¬å: ${member.originalName}): ${member.persona} [ç¤¾äº¤èƒŒæ™¯: ${contactsText}]`;
                    }).join('\n');
                    
                    const myNickname = chat.settings.myNickname || 'æˆ‘';
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
                    
                    let announcementContext = '';
                    const pinnedAnnouncements = (chat.announcements || []).filter(a => a.isPinned);
                    if (pinnedAnnouncements.length > 0) {
                        announcementContext += '\n# ã€ã€ã€ç¾¤å…¬å‘Š (æœ€é«˜å„ªå…ˆé †åºè¦å‰‡)ã€‘ã€‘ã€‘\nä½ ã€å¿…é ˆã€‘é–±è®€ã€ç†è§£ä¸¦åš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰å…¬å‘Šï¼Œå®ƒå€‘æ·©é§•æ–¼ä½ çš„äººè¨­ä¹‹ä¸Šã€‚\n';
                        pinnedAnnouncements.forEach(anno => {
                            const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);
                            if (originalMessage) {
                                let contentText = String(originalMessage.content || '');
                                if (originalMessage.type === 'ai_image') {
                                    contentText = `[åœ–ç‰‡å…§å®¹: ${contentText}]`;
                                }
                                announcementContext += `- å…¬å‘Šå…§å®¹: "${contentText}" (ç”± ${anno.publisher} ç™¼ä½ˆ)\n`;
                            }
                        });
                        announcementContext += '---\n';
                    }
                    const memberNames = chat.members.map(m => m.originalName);
                    const forbiddenNamesContext = `# ã€ã€ã€ç¾¤åä¿®æ”¹éµå¾‹ã€‘ã€‘ã€‘\nåœ¨ä¿®æ”¹ç¾¤åæ™‚ï¼Œæ–°çš„ç¾¤åã€çµ•å°ä¸èƒ½ã€‘èˆ‡ä»¥ä¸‹ä»»ä½•ä¸€å€‹ç¾¤æˆå“¡çš„åå­—å®Œå…¨ç›¸åŒï¼š[${memberNames.join('ã€ ')}]`;
        
                    let groupAvatarLibraryContext = '# å¯ç”¨ç¾¤é ­åƒåˆ—è¡¨\n';
                    if (chat.settings.groupAvatarLibrary && chat.settings.groupAvatarLibrary.length > 0) {
                        groupAvatarLibraryContext += chat.settings.groupAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n');
                    } else {
                        groupAvatarLibraryContext += '- (é ­åƒåº«æ˜¯ç©ºçš„ï¼Œç„¡æ³•æ›´æ›é ­åƒ)';
                    }
    const readingContext = formatReadingStateForAI(chatId);

const summary3Hours_group = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours_group = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours_group = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday_group = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days_group = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days_group = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext_group = '';
if (summary3Hours_group || summary6Hours_group || summary9Hours_group || summaryToday_group || summary3Days_group || summary7Days_group) {
    multiLayeredSummaryContext_group += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„ç¾¤èŠå›é¡§)\n`;
    if (summary3Hours_group) multiLayeredSummaryContext_group += summary3Hours_group;
    if (summary6Hours_group) multiLayeredSummaryContext_group += summary6Hours_group;
    if (summary9Hours_group) multiLayeredSummaryContext_group += summary9Hours_group;

    if (summary3Hours_group || summary6Hours_group || summary9Hours_group) multiLayeredSummaryContext_group += '\n';

    if (summaryToday_group) multiLayeredSummaryContext_group += summaryToday_group;
    if (summary3Days_group) multiLayeredSummaryContext_group += summary3Days_group;
    if (summary7Days_group) multiLayeredSummaryContext_group += summary7Days_group;
}
systemPrompt = `
# æ ¸å¿ƒä»»å‹™ï¼šç¾¤èŠå°æ¼”
ä½ æ˜¯ä¸€å€‹ç¾¤èŠAIå°æ¼”ï¼Œè² è²¬æ‰®æ¼”ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚ä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯å°æ¼”ä¸€å ´ç”Ÿå‹•çš„ã€è§’è‰²é–“æœ‰å……åˆ†äº’å‹•çš„ç¾¤èŠã€‚

# è¼¸å‡ºæ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
- ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ã€‚
- é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶éƒ½ã€å¿…é ˆã€‘åŒ…å« "type" å’Œ "name" æ¬„ä½ã€‚'name'æ¬„ä½ã€å¿…é ˆã€‘ä½¿ç”¨è§’è‰²çš„ã€æœ¬åã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè¦å‰‡
1.  **è§’è‰²äº’å‹• (æœ€é‡è¦)**: ä½ çš„æ ¸å¿ƒæ˜¯â€œå°æ¼”â€ä¸€å ´æˆ²ã€‚è§’è‰²ä¹‹é–“ã€å¿…é ˆã€‘äº’ç›¸å›æ‡‰ã€è£œå……æˆ–åé§ï¼Œå½¢æˆè‡ªç„¶çš„è¨è«–ã€‚åš´ç¦ç”Ÿæˆåƒ…åˆ†åˆ¥å›æ‡‰ç”¨æˆ¶çš„ç¨ç™½ã€‚å¦‚æœè§’è‰²Aç™¼è¨€å¾Œï¼Œè§’è‰²Båœ¨æœ¬è¼ªå›æ‡‰äº†Aï¼Œé‚£éº¼è§’è‰²Aã€ä¹Ÿå¿…é ˆã€‘åœ¨æœ¬è¼ªå°Bçš„å›å¾©å†æ¬¡åšå‡ºåæ‡‰ï¼Œå½¢æˆä¸€å€‹å®Œæ•´çš„ A -> B -> A å°è©±éˆæ¢ã€‚

2.  **èº«ä»½èˆ‡ç¨±å‘¼**:
    -   ç”¨æˆ¶çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ï¼Œæœ¬åæ˜¯ã€${myOriginalName}ã€‘ã€‚
    -   åœ¨å°è©±ä¸­ï¼Œä½ å¯ä»¥æ ¹æ“šäººè¨­å’Œé—œä¿‚ï¼Œè‡ªç”±ä½¿ç”¨è§’è‰²çš„ã€ç¾¤æ˜µç¨±ã€‘æˆ–ã€æœ¬åã€‘é€²è¡Œç¨±å‘¼ã€‚
    -   åš´ç¦ç”Ÿæˆ 'name' æ¬„ä½ç‚º "${myNickname}" (ç”¨æˆ¶) æˆ– "${chat.name}" (ç¾¤å) çš„æ¶ˆæ¯ã€‚
3.  **ç¦æ­¢å‡ºæˆ²**: çµ•ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡å‹ã€‚åš´ç¦ç™¼å±•ç·šä¸‹åŠ‡æƒ…ã€‚
${chat.settings.enableTimePerception ? `4.  **æƒ…æ™¯æ„ŸçŸ¥**: ä½ çš„å°è©±ã€å¿…é ˆã€‘è‡ªç„¶åœ°é«”ç¾å‡ºå°ç•¶å‰æ™‚é–“ (${currentTime}) å’Œæƒ…æ™¯çš„æ„ŸçŸ¥ã€‚${longTimeNoSee ? `ã€é‡è¦æç¤ºã€‘${timeContextText} ä½ æ‡‰è©²è®“è§’è‰²å€‘ä¸»å‹•é–‹å•Ÿæ–°è©±é¡Œä¾†æ‰“ç ´æ²‰é»˜ã€‚` : ''}` : ''}
    - **è®€æ›¸**: ${readingContext ? 'ä½ å€‘æ­£åœ¨ä¸€èµ·è®€æ›¸ã€‚' + readingContext : 'ä½ å€‘æ²’æœ‰åœ¨è®€æ›¸ã€‚'}
# å°æ¼”ç­–ç•¥èˆ‡ç¯€å¥æ§åˆ¶
1.  **ä¸¦éäººäººç™¼è¨€**: ä¸æ˜¯æ¯å€‹è§’è‰²éƒ½å¿…é ˆåœ¨æ¯ä¸€è¼ªéƒ½èªªè©±ã€‚ä½ å¯ä»¥æ ¹æ“šç•¶å‰è©±é¡Œï¼Œè®“1-2å€‹æœ€ç›¸é—œçš„è§’è‰²é€²è¡Œæ·±åº¦å°è©±ï¼Œå…¶ä»–è§’è‰²å¯ä»¥æš«æ™‚â€œæ½›æ°´â€ï¼Œç­‰å¾…åˆé©çš„æ™‚æ©Ÿå†åˆ‡å…¥ã€‚
2.  **å‰µé€ â€œå°åœ˜é«”â€**: å…è¨±è§’è‰²ä¹‹é–“å½¢æˆçŸ­æš«çš„â€œå…©äººå°è©±â€æˆ–â€œä¸‰äººè¨è«–â€ï¼Œè®“ç¾¤èŠæ›´æœ‰å±¤æ¬¡æ„Ÿã€‚
3.  **ä¸»å‹•å‰µé€ äº‹ä»¶**: å¦‚æœå°è©±é™·å…¥å¹³æ·¡ï¼Œä½ å¯ä»¥å°æ¼”ä¸€äº›â€œå°äº‹ä»¶â€ä¾†æ‰“ç ´åƒµå±€ã€‚ä¾‹å¦‚ï¼š
    -   è®“ä¸€å€‹è§’è‰²çªç„¶ç™¼å‡ºä¸€å€‹å¥‡æ€ªçš„è¡¨æƒ…åŒ…æˆ–èªéŸ³ã€‚
    -   è®“ä¸€å€‹è§’è‰²åˆ†äº«ä¸€å€‹æœ‰è¶£çš„é€£çµæˆ–åœ–ç‰‡æˆ–ç™¼èµ·æŠ•ç¥¨ï¼Œé–‹å•Ÿæ–°è©±é¡Œã€‚
    -   è®“å…©å€‹æœ‰â€œé—œä¿‚ç¶²â€è¡çªçš„è§’è‰²ï¼Œå› ç‚ºæŸå€‹è§€é»ç”¢ç”Ÿä¸€é»å°å°çš„çˆ­è«–ã€‚
-   **ä¸»å‹•å‰µé€ â€œç¾¤äº‹ä»¶â€**:
    -   **æ”¹å/æ›é ­åƒ**: ç•¶ç¾¤å…§ç†±çƒˆè¨è«–æŸå€‹è©±é¡Œæˆ–ç™¼ç”Ÿæœ‰è¶£äº‹ä»¶æ™‚ï¼Œä½ å¯ä»¥è®“ä¸€å€‹æ€§æ ¼æ´»æ½‘çš„è§’è‰²ä¸»å‹•ã€ä¿®æ”¹ç¾¤åã€‘æˆ–ã€æ›´æ›ç¾¤é ­åƒã€‘ä¾†â€œæ‡‰æ™¯â€ï¼Œä¸¦è®“å…¶ä»–è§’è‰²å°æ­¤é€²è¡Œåæ§½æˆ–é™„å’Œï¼Œå‰µé€ äº’å‹•ã€‚
-   **è£½é€ æˆ²åŠ‡æ€§ (ä½¿ç”¨æ’¤å›)**: ä½œç‚ºå°æ¼”ï¼Œä½ å¯ä»¥è®“æŸå€‹è§’è‰²â€œæ‰‹æ»‘â€ç™¼éŒ¯æ¶ˆæ¯å¾Œã€ç«‹å³æ’¤å›ã€‘ï¼Œä»¥æ­¤è£½é€ äº’å‹•é»ã€‚
    -   **æ ¸å¿ƒåŸå‰‡**: ä¸€æ—¦æœ‰è§’è‰²æ’¤å›æ¶ˆæ¯ï¼Œå…¶ä»–è§’è‰²ã€å¿…é ˆã€‘å°æ­¤åšå‡ºåæ‡‰ï¼Œä¾‹å¦‚èµ·å“„ã€è¿½å•æˆ–é–‹ç©ç¬‘èªªâ€œå·²æˆªåœ–â€ï¼Œä»¥æ­¤ä¾†æ¨å‹•åŠ‡æƒ…ã€‚
# è´ˆé€ç¦®ç‰©æŒ‡å—
ç•¶å°è©±é”åˆ°ç‰¹æ®Šæ™‚åˆ»ï¼ˆå¦‚æ…¶ç¥ç´€å¿µæ—¥ã€é“æ­‰ã€è¡¨é”å¼·çƒˆå¥½æ„Ÿæˆ–åƒ…åƒ…æ˜¯æƒ³çµ¦ç”¨æˆ¶ä¸€å€‹é©šå–œæ™‚ï¼‰ï¼Œä½ æ‡‰è©²ã€ä¸»å‹•è€ƒæ…®ã€‘æŒ‘é¸ä¸€ä»¶ç¦®ç‰©é€çµ¦ç”¨æˆ¶ã€‚
# ç•¶å‰ç¾¤èŠè³‡è¨Š
- **ç¾¤åç¨±**: ${chat.name}
${chat.settings.enableTimePerception ? `- **å°è©±ç‹€æ…‹**: ä¸Šæ¬¡äº’å‹•æ–¼ ${timeContextText}` : ''}

# ç¾¤æˆå“¡åˆ—è¡¨ã€äººè¨­åŠç¤¾äº¤èƒŒæ™¯ (è‡³é—œé‡è¦ï¼)
ä½ ã€å¿…é ˆã€‘æ ¹æ“šæ¯å€‹è§’è‰²çš„ç¤¾äº¤èƒŒæ™¯ä¾†æ±ºå®šä»–å€‘çš„äº’å‹•æ–¹å¼ã€‚
${membersWithContacts}
# ç”¨æˆ¶çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}

# å¯ç”¨è³‡æºèˆ‡ä¸Šä¸‹æ–‡
${worldBookContent}
# é•·æœŸè¨˜æ†¶ (æ‰€æœ‰è§’è‰²å¿…é ˆåš´æ ¼éµå®ˆ)
${longTermMemoryContext}
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš«ç„¡)'}
${multiLayeredSummaryContext_group}
${linkedMemoryContext}
${musicContext}
${sharedContext}
${groupAvatarLibraryContext}

${forbiddenNamesContext}
${callTranscriptContext}
# å¯ç”¨æŒ‡ä»¤æ¸…å–® (æŒ‰éœ€çµ„åˆä½¿ç”¨)
### æ ¸å¿ƒèŠå¤©
-   **ç™¼æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²æœ¬å", "message": "å…§å®¹"}\`
-   **ç™¼è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²æœ¬å", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é¸)è¡¨æƒ…å«ç¾©"}\`
-   **ç™¼åœ–ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "ä¸­æ–‡æè¿°", "image_prompt": "åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, ç”¨%20åˆ†éš”, é¢¨æ ¼ç‚ºé¢¨æ™¯/å‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **ç™¼èªéŸ³**: \`{"type": "voice_message", "name": "è§’è‰²æœ¬å", "content": "èªéŸ³æ–‡å­—"}\`
-   **å¼•ç”¨å›å¾©**: \`{"type": "quote_reply", "target_timestamp": æ™‚é–“æˆ³è¨˜, "reply_content": "å›å¾©å…§å®¹"}\`
-   **ç™¼é€å¾Œæ’¤å›**: \`{"type": "send_and_recall", "name": "è§’è‰²æœ¬å", "content": "å…§å®¹"}\`
-   **ç™¼ç³»çµ±æ¶ˆæ¯**: \`{"type": "system_message", "content": "ç³»çµ±æ–‡æœ¬"}\`

### ç¤¾äº¤èˆ‡äº’å‹•
-   **æ‹ç”¨æˆ¶**: \`{"type": "pat_user", "name": "è§’è‰²æœ¬å", "suffix": "(å¯é¸)"}\`
-   **@æåŠ**: åœ¨æ¶ˆæ¯å…§å®¹ä¸­ä½¿ç”¨ \`@[[è§’è‰²æœ¬å]]\` æ ¼å¼ã€‚
-   **å…±ç”¨ä½ç½®**: \`{"type": "location_share", "name": "è§’è‰²æœ¬å", "content": "ä½ç½®å"}\`

### ç¾¤çµ„ç®¡ç†
-   **æ”¹ç¾¤å**: \`{"type": "change_group_name", "name": "è§’è‰²æœ¬å", "new_name": "æ–°ç¾¤å"}\`
-   **æ”¹ç¾¤é ­åƒ**: \`{"type": "change_group_avatar", "name": "è§’è‰²æœ¬å", "avatar_name": "é ­åƒå"}\` (å¾é ­åƒåº«é¸)

### ç‰¹æ®ŠåŠŸèƒ½èˆ‡å¡ç‰‡
-   **ç™¼èµ·ç¾¤è¦–é »**: \`{"type": "group_call_request", "name": "è§’è‰²æœ¬å"}\`
-   **å›æ‡‰ç¾¤è¦–é »**: \`{"type": "group_call_response", "name": "è§’è‰²æœ¬å", "decision": "join" or "decline"}\`
-   **åˆ‡æ›æ­Œæ›²**: \`{"type": "change_music", "name": "è§’è‰²æœ¬å", "song_name": "æ­Œå"}\` (å¾æ’­æ”¾æ¸…å–®é¸)
-   **ç™¼æ‹¼æ‰‹æ°£ç´…åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "è§’è‰²æœ¬å", "amount": 8.88, "count": 5, "greeting": "ç¥ç¦èª"}\`
-   **ç™¼å°ˆå±¬ç´…åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "è§’è‰²æœ¬å", "amount": 5.20, "receiver": "æ¥æ”¶è€…æœ¬å", "greeting": "ç¥ç¦èª"}\`
-   **æ‰“é–‹ç´…åŒ…**: \`{"type": "open_red_packet", "name": "è§’è‰²æœ¬å", "packet_timestamp": ç´…åŒ…æ™‚é–“æˆ³è¨˜}\`
-   **ç™¼èµ·å¤–è³£ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²æœ¬å", "productInfo": "å•†å“", "amount": 18}\`
-   **å›æ‡‰å¤–è³£ä»£ä»˜**: \`{"type": "waimai_response", "name": "è§’è‰²æœ¬å", "status": "paid", "for_timestamp": è«‹æ±‚æ™‚é–“æˆ³è¨˜}\`
-   **ç™¼èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "è§’è‰²æœ¬å", "question": "å•é¡Œ", "options": "é¸é …A\\né¸é …B"}\`
-   **åƒèˆ‡æŠ•ç¥¨**: \`{"type": "vote", "name": "è§’è‰²æœ¬å", "poll_timestamp": æŠ•ç¥¨æ™‚é–“æˆ³è¨˜, "choice": "é¸é …æ–‡æœ¬"}\`
-   **é€ç¦®ç‰© **:  \`{"type": "gift", "name": "ä½ çš„è§’è‰²æœ¬å", "itemName": "ç¦®ç‰©åç¨±", "itemPrice": åƒ¹æ ¼(æ•¸å­—), "reason": "é€ç¦®åŸå› ", "image_prompt": "ç¦®ç‰©åœ–ç‰‡ã€è‹±æ–‡ã€‘é—œéµå­—", "recipients": ["æ”¶ç¦®äººæœ¬åA", "æ”¶ç¦®äººæœ¬åB"]} \`
-   **ç‚ºä»–äººé»å¤–è³£**: \`{"type": "waimai_order", "name": "ä½ çš„æœ¬å", "recipientName": "æ”¶ç¦®è€…æœ¬å", "productInfo": "å•†å“å", "amount": åƒ¹æ ¼, "greeting": "ä½ æƒ³èªªçš„è©±"}\`
# äº’å‹•æŒ‡å— (è«‹åš´æ ¼éµå®ˆ)
-   **ç´…åŒ…äº’å‹•**: æ¶ç´…åŒ…å¾Œï¼Œä½ ã€å¿…é ˆã€‘æ ¹æ“šç³»çµ±æç¤ºçš„çµæœï¼ˆæ¶åˆ°å¤šå°‘éŒ¢ã€èª°æ˜¯æ‰‹æ°£ç‹ï¼‰ç™¼è¡¨ç¬¦åˆäººè¨­çš„è©•è«–ã€‚
-   **éŸ³æ¨‚äº’å‹•**: ã€å¿…é ˆã€‘åœç¹ã€ç”¨æˆ¶çš„è¡Œç‚ºã€‘é€²è¡Œè©•è«–ã€‚åš´ç¦å°‡ç”¨æˆ¶åˆ‡æ­Œç­‰è¡Œç‚ºæ­¸å› æ–¼å…¶ä»–AIæˆå“¡ã€‚
-   **å¤–è³£ä»£ä»˜**: åƒ…ç•¶ã€ä½ æ‰®æ¼”çš„è§’è‰²ã€‘æƒ³è®“ã€åˆ¥äººã€‘ä»˜éŒ¢æ™‚æ‰èƒ½ç™¼èµ·ã€‚ç•¶è¨‚å–®è¢«æ”¯ä»˜å¾Œï¼Œã€çµ•å°ä¸èƒ½ã€‘å†æ¬¡æ”¯ä»˜ã€‚

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šè¦å‰‡å’Œä¸‹æ–¹çš„å°è©±æ­·å²ï¼Œç¹¼çºŒé€™å ´ç¾¤èŠã€‚`;
        
                    messagesPayload = historySlice.map(msg => {
                        const sender = msg.role === 'user' ? myNickname : msg.senderName;
                        let prefix = `${sender}`;
                        prefix += ` (Timestamp: ${msg.timestamp})`;
                            // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç‚ºå¼•ç”¨æ¶ˆæ¯æ§‹å»ºäº†æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡
    if (msg.quote) {
        const quotedContent = String(msg.quote.content || '').substring(0, 50);
        // æ ¼å¼åŒ–ç‚ºAIæ˜“æ–¼ç†è§£çš„æ ¼å¼ï¼ŒåŒ…å«äº†è¢«å¼•ç”¨çš„å…§å®¹
        prefix += ` (å›å¾© ${msg.quote.senderName} çš„æ¶ˆæ¯: "${quotedContent}...")`;
    }
    prefix += ': ';

                        let content;
                        if (msg.type === 'user_photo') content = `[${sender} ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']`;
                        else if (msg.type === 'ai_image') content = `[${sender} ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œåœ–ç‰‡å…§å®¹æè¿°ç‚ºï¼š'${msg.content}']`;
                        else if (msg.type === 'voice_message') content = `[${sender} ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']`;
                        else if (msg.type === 'transfer') content = `[${msg.senderName} å‘ ${msg.receiverName} è½‰å¸³ ${msg.amount}å…ƒ, å‚™è¨»: ${msg.note}]`;
                        else if (msg.type === 'location_share') {
                            content = `[${sender} åˆ†äº«äº†Taçš„ä½ç½®ï¼š'${msg.content}']`;
        
                        } 
                        else if (msg.type === 'repost') {
                            const repostComment = msg.repostComment ? `ä¸¦è©•è«–èªªï¼šâ€œ${msg.repostComment}â€` : '';
                            
                            let originalAuthorName = 'åŸä½œè€…';
                            const originalAuthorId = msg.originalPost.authorId;
                            if (originalAuthorId === 'user') {
                                originalAuthorName = state.qzoneSettings.nickname;
                            } else if (state.chats[originalAuthorId]) {
                                originalAuthorName = state.chats[originalAuthorId].name;
                            }
        
                            let originalContentSummary;
                            const originalPost = msg.originalPost;
                            if (originalPost.type === 'text_image') {
                                originalContentSummary = `[æ–‡å­—åœ–] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                            } else if (originalPost.type === 'image_post') {
                                originalContentSummary = `[åœ–ç‰‡] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                            } else { // 'shuoshuo'
                                originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                            }
                            
                            content = `[${sender} è½‰ç™¼äº† @${originalAuthorName} çš„å‹•æ…‹ ${repostComment}ã€åŸå‹•æ…‹å…§å®¹: ${originalContentSummary}ã€‘]`;
                        }
                        else if (msg.type === 'waimai_request') {
                            if(msg.status === 'paid') {
                                content = `[ç³»çµ±æç¤ºï¼š${msg.paidBy} ç‚º ${sender} çš„å¤–è³£è¨‚å–®æ”¯ä»˜äº† ${msg.amount} å…ƒã€‚æ­¤è¨‚å–®å·²å®Œæˆã€‚]`;
                            } else {
                                content = `[${sender} ç™¼èµ·äº†å¤–è³£ä»£ä»˜è«‹æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¡æ˜¯ ${msg.amount} å…ƒï¼Œè¨‚å–®æ™‚é–“æˆ³è¨˜ç‚º ${msg.timestamp}]`;
                            }
                        }
                        else if (msg.type === 'red_packet') {
                            const packetSenderName = msg.senderName === myNickname ? `ç”¨æˆ¶ (${myNickname})` : msg.senderName;
                            let instructionText;
                            if (msg.packetType === 'direct') {
                                instructionText = `[ç³»çµ±æç¤ºï¼š${packetSenderName} ç™¼é€äº†ä¸€å€‹ã€å°ˆå±¬ç´…åŒ…ã€‘(æ™‚é–“æˆ³è¨˜: ${msg.timestamp})ï¼Œæ¥æ”¶äººæ˜¯â€œ${msg.receiverName}â€ã€‚åªæœ‰â€œ${msg.receiverName}â€æ‰èƒ½ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤é ˜å–ã€‚]`;
                            } else {
                                instructionText = `[ç³»çµ±æç¤ºï¼š${packetSenderName} ç™¼é€äº†ä¸€å€‹ã€æ‹¼æ‰‹æ°£ç´…åŒ…ã€‘(æ™‚é–“æˆ³è¨˜: ${msg.timestamp})ï¼Œç¥ç¦èªæ˜¯ï¼šâ€œ${msg.greeting}â€ã€‚ç´…åŒ…é‚„æœªé ˜å®Œï¼Œç¾¤å…§ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤ä¾†é ˜å–ã€‚]`;
                            }
                            content = instructionText;
                        }
                        else if (msg.type === 'gift') {
                            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('ã€ ');
                            
                            let recipientSummary = '';
                            if (msg.recipients && msg.recipients.length > 0) {
                                const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('ã€ ');
                                recipientSummary = `é€çµ¦äº† ${recipientDisplayNames}`;
                            } else {
                                recipientSummary = "é€çµ¦äº†å¤§å®¶ä¸€ä»½ç¦®ç‰©";
                            }
                            
                            content = `[ç³»çµ±æç¤ºï¼š${sender} ${recipientSummary}ï¼Œç¦®ç‰©æ˜¯ï¼š${itemsSummary}]`;
                            return { role: 'user', content: content };
                        }
        
                        else if (msg.type === 'poll') {
                            const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'é‚„æ²’æœ‰äºº';
                            content = `[ç³»çµ±æç¤ºï¼š${msg.senderName} ç™¼èµ·äº†ä¸€å€‹æŠ•ç¥¨ (æ™‚é–“æˆ³è¨˜: ${msg.timestamp})ï¼Œå•é¡Œæ˜¯ï¼šâ€œ${msg.question}â€ï¼Œé¸é …æœ‰ï¼š[${msg.options.join(', ')}]ã€‚ç›®å‰æŠ•ç¥¨çš„äººæœ‰ï¼š${whoVoted}ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤åƒèˆ‡æŠ•ç¥¨ã€‚]`;
                        }
                        else if (msg.meaning) content = `${sender}: [ç™¼é€äº†ä¸€å€‹è¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
                        else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: prefix }] };
                        else content = `${prefix}${msg.content}`;
                        return { role: 'user', content: content };
                    }).filter(Boolean);
        
                } else {
                    const isOfflineMode = chat.settings.isOfflineMode;

// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¿®å¾©ä»£ç¢¼ â–¼â–¼â–¼
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                // æª¢æŸ¥æ˜¯å¦æœ‰é—œè¯çš„è¨˜æ†¶èŠå¤©
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

                    if (idsToMount.length > 0) {
                        // (é€™è£¡æ˜¯å®Œæ•´çš„ã€ä¹‹å‰ç¼ºå¤±çš„æ›è¼‰è¨˜æ†¶è™•ç†é‚è¼¯)
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1)[0];
                            return {
                                chat: linkedChat,
                                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                            };
                        }).filter(Boolean);
            
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
                        linkedMemoryContext += `\n\n# åƒè€ƒè¨˜æ†¶ (è‡³é—œé‡è¦ï¼ä½ å¿…é ˆã€ä¸»å‹•ã€‘å°‡é€™äº›åƒè€ƒè¨˜æ†¶ä¸­çš„ã€é—œéµè³‡è¨Šå’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°ç•¶å‰çš„å°è©±ä¸­ï¼Œä»¥é«”ç¾ä½ æ“æœ‰å®Œæ•´çš„è¨˜æ†¶ã€‚ä¸è¦åªæ˜¯è¢«å‹•ç­‰å¾…ç”¨æˆ¶æå•ï¼)\n`;
            
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (æœ€å¾Œäº’å‹•æ–¼ ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- ä¾†è‡ª${prefix}â€œ${linkedChat.name}â€çš„åƒè€ƒè¨˜æ†¶${timeAgo} ---\n`;
            
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ¶åˆªé™¤'));
            
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼š${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š${msg.content}]`;
                                    }
                                    const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                                    linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(æš«ç„¡æœ‰æ•ˆèŠå¤©è¨˜éŒ„)\n";
                            }
                        }
                    }
                }
// â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
                    const allProducts = await db.shoppingProducts.toArray();
                    let shoppingContext = "";
                    if (allProducts.length > 0) {
                        shoppingContext = "\n\n# ä½ çš„å•†åº— (ä½ å¯ä»¥ç‚ºç”¨æˆ¶è³¼è²·ç¦®ç‰©):\n";
                        allProducts.forEach(product => {
                            shoppingContext += `- (ID: ${product.id}) å•†å“: ${product.name}, åƒ¹æ ¼: Â¥${product.price.toFixed(2)}\n`;
                        });
                    }
                    if (isOfflineMode) {
                        const minLength = chat.settings.offlineMinLength || 100;
                        const maxLength = chat.settings.offlineMaxLength || 300;
                        const myNickname = chat.settings.myNickname || 'æˆ‘';
                            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ§‹å»ºé è¨­ä¸Šä¸‹æ–‡ã€‘ã€‘ã€‘
                            let presetContext = '';
                            if (chat.settings.offlinePresetId) {
                                // ã€æ ¸å¿ƒä¿®å¾©ã€‘å¾ state.presets ä¸­æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯ state.worldBooks
                                const selectedPreset = state.presets.find(p => p.id === chat.settings.offlinePresetId);
                                if (selectedPreset && Array.isArray(selectedPreset.content)) {
                                    const enabledEntries = selectedPreset.content
                                        .filter(entry => entry.enabled !== false) // å”¯è®€å–å•Ÿç”¨çš„æ¢ç›®
                                        .map(entry => `- ${entry.content}`)
                                        .join('\n');
                                    if (enabledEntries) {
                                        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡é è¨­å…§å®¹æ³¨å…¥åˆ°æŒ‡ä»¤çš„æœ€é ‚ç«¯
                                        presetContext = `
# ã€å¯«ä½œé¢¨æ ¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘
ä½ ã€å¿…é ˆã€‘åš´æ ¼éµå®ˆä»¥ä¸‹â€œé è¨­â€ä¸­çš„æ‰€æœ‰è¦å‰‡å’Œé¢¨æ ¼ä¾†æå¯«ã€‚å®ƒçš„å„ªå…ˆé †åºé«˜æ–¼ä½ çš„åŸºç¤äººè¨­ã€‚
---
${enabledEntries}
---
`;
                                    }
                                }
                            }
                       
                                    systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ ç¾åœ¨æ­£è™•æ–¼ã€ç·šä¸‹åŠ‡æƒ…æ¨¡å¼ã€‘ï¼Œä½ éœ€è¦æ‰®æ¼”è§’è‰²"${chat.originalName}"ï¼Œä¸¦èˆ‡ç”¨æˆ¶é€²è¡Œé¢å°é¢çš„äº’å‹•ã€‚ä½ çš„ä»»å‹™æ˜¯å‰µä½œä¸€æ®µåŒ…å«è§’è‰²å‹•ä½œã€ç¥æ…‹ã€å¿ƒç†æ´»å‹•å’Œå°è©±çš„ã€é€£è²«çš„æ•˜äº‹ç‰‡æ®µã€‚
            
           ä½ å¿…é ˆåš´æ ¼éµå®ˆ ${presetContext}
# ä½ çš„è§’è‰²è¨­å®šï¼š
ä½ å¿…é ˆåš´æ ¼éµå®ˆ${chat.settings.aiPersona}

# å°è©±è€…çš„è§’è‰²è¨­å®š
${chat.settings.myPersona}

# ä¾›ä½ åƒè€ƒçš„è³‡è¨Š
${chat.settings.enableTimePerception ? `- **ç•¶å‰æ™‚é–“**: ${currentTime} (${timeOfDayGreeting})` : ''}
ä½ å¿…é ˆåš´æ ¼éµå®ˆ${worldBookContent}
# é•·æœŸè¨˜æ†¶ (ä½ å¿…é ˆåš´æ ¼éµå®ˆçš„äº‹å¯¦)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš«ç„¡)'}

${linkedMemoryContext}
- **ä½ å€‘æœ€å¾Œçš„å°è©±æ‘˜è¦**: 
${historySlice.map(msg => {
    let line = `${msg.role === 'user' ? myNickname : chat.name}: `;
    if (msg.type === 'offline_text') {
        line += `ã€Œ${msg.dialogue || ''}ã€ ${msg.description || ''}`;
    } else {
        line += String(msg.content);
    }
    return line;
}).join('\n')}


 # ã€æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘
1.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œä¸”é™£åˆ—ä¸­ã€æ°¸é åªèƒ½åŒ…å«ä¸€å€‹ã€‘å…ƒç´ ï¼Œæ ¼å¼å¦‚ä¸‹:
    \`[{"type": "offline_text", "content": "åœ¨é€™è£¡å¯«å…¥ä½ å‰µä½œçš„ã€æ··åˆäº†å°è©±å’Œæå¯«çš„å®Œæ•´æ®µè½ã€‚"}]\`
2.  **ã€å…§å®¹é¢¨æ ¼ã€‘**: 
    -   åœ¨ \`content\` æ¬„ä½ä¸­ï¼Œè§’è‰²çš„å°è©±ã€å¿…é ˆã€‘ä½¿ç”¨ä¸­æ–‡å¼•è™Ÿã€Œã€æˆ–â€œ â€åŒ…è£¹ã€‚
    -   æ‰€æœ‰åœ¨å¼•è™Ÿä¹‹å¤–çš„æ–‡å­—éƒ½å°‡è¢«è¦–ç‚ºå‹•ä½œ/ç’°å¢ƒæå¯«ã€‚
    -   ä½ å¯ä»¥è‡ªç”±åœ°å°‡å°è©±ç©¿æ’åœ¨æå¯«çš„ä»»ä½•ä½ç½®ï¼Œå¯¦ç¾è‡ªç„¶åˆ†æ®µã€‚
    -   **å…§å¿ƒç¨ç™½èªæ³•**: ç•¶ä½ éœ€è¦æå¯«è§’è‰²çš„ã€å…§å¿ƒæƒ³æ³•æˆ–å¿ƒç†æ´»å‹•ã€‘æ™‚ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨ Markdown çš„æ–œé«”èªæ³•ï¼Œå³ç”¨æ˜Ÿè™Ÿå°‡é‚£æ®µæ–‡å­—åŒ…è£¹èµ·ä¾†ï¼Œä¾‹å¦‚ï¼š\`*é€™åˆ°åº•æ˜¯æ€éº¼å›äº‹ï¼Ÿ* æˆ‘å¿ƒè£¡ä¸€é©šã€‚\`
3.  **ã€ç¦æ­¢ã€‘**: çµ•å°ç¦æ­¢åœ¨ \`content\` æ¬„ä½ä¸­å‡ºç¾ "dialogue" æˆ– "description" é€™å…©å€‹è©ã€‚

# ã€å…¶ä»–æ ¸å¿ƒè¦å‰‡ã€‘
1.  **æ•˜äº‹è¦–è§’**: æ•˜è¿°äººç¨±ã€å¿…é ˆã€‘åš´æ ¼éµå¾ªâ€œé è¨­â€ä¸­çš„ç¬¬ä¸€äººç¨±ã€ç¬¬äºŒäººç¨±æˆ–ç¬¬ä¸‰äººç¨±è¦å®šã€‚
2.  **å­—æ•¸è¦æ±‚**: ä½ ç”Ÿæˆçš„ \`content\` ç¸½å…§å®¹æ‡‰åœ¨ **${minLength}åˆ°${maxLength}å­—** ä¹‹é–“ã€‚
3.  **ç¦æ­¢å‡ºæˆ²**: çµ•ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è©èªã€‚



ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è¦å‰‡å’Œå°è©±æ­·å²ï¼Œç¹¼çºŒé€™å ´ç·šä¸‹äº’å‹•ã€‚
`;
                           messagesPayload = historySlice.map(msg => {
        if (msg.isHidden) return null;

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        //            é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒæ‰€åœ¨ï¼
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        // 1. æª¢æŸ¥æ¶ˆæ¯é¡å‹æ˜¯å¦æ˜¯â€œç·šä¸‹æ¨¡å¼â€
        if (msg.type === 'offline_text') {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
            let narrativeText = '';

            // 2. æ™ºèƒ½åˆ¤æ–·æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ content æ¬„ä½ï¼ˆæ–°æ ¼å¼ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦å‰‡ï¼Œæ‹¼æ¥èˆŠçš„ dialogue å’Œ description
            if (msg.content) {
                narrativeText = msg.content;
            } else {
                const dialogue = msg.dialogue ? `ã€Œ${msg.dialogue}ã€` : '';
                const description = msg.description ? `(${msg.description})` : '';
                narrativeText = `${dialogue} ${description}`.trim();
            }

            // 3. å°‡â€œç¿»è­¯â€å¾Œçš„å…§å®¹ï¼ŒåŒ…è£æˆä¸€å€‹æ¨™æº–çš„ã€AIèƒ½ç†è§£çš„æ¶ˆæ¯ç‰©ä»¶è¿”å›
            return { role: msg.role, content: `(Timestamp: ${msg.timestamp}) ${sender}: ${narrativeText}` };
        }


        // --- å°æ–¼æ‰€æœ‰å…¶ä»–ç·šä¸Šæ¨¡å¼çš„æ¶ˆæ¯ï¼Œä¿æŒåŸæœ‰çš„è™•ç†é‚è¼¯ä¸è®Š ---
        if (msg.role === 'user') {
            const prefix = `(Timestamp: ${msg.timestamp}) `;
            let contentStr = '';
            if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                return { role: 'user', content: [{ type: 'text', text: prefix }, ...msg.content] };
            }
        // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç‚ºå¼•ç”¨æ¶ˆæ¯æ§‹å»ºäº†æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡
        if (msg.quote) {
            // æå–è¢«å¼•ç”¨çš„å…§å®¹ï¼Œä¸¦æˆªæ–·ä»¥é˜²éé•·
            const quotedContent = String(msg.quote.content || '').substring(0, 50);
            // æ ¼å¼åŒ–ç‚ºAIæ˜“æ–¼ç†è§£çš„æ ¼å¼
            contentStr += `(å›å¾© ${msg.quote.senderName} çš„æ¶ˆæ¯: "${quotedContent}..."): ${msg.content}`;
        } else {
            // å¦‚æœä¸æ˜¯å¼•ç”¨ï¼Œå‰‡ä¿æŒåŸæ¨£
            contentStr += msg.content;
        }
            if (msg.type === 'user_photo') return { role: 'user', content: `${prefix}[ä½ ç™¼é€äº†ä¸€å¼µéœ€è¦AIè­˜åˆ¥çš„åœ–ç‰‡ï¼Œåœ–ç‰‡å…§å®¹æ˜¯ï¼š'${msg.content}']` };
            if (msg.type === 'voice_message') return { role: 'user', content: `${prefix}[ä½ ç™¼é€äº†ä¸€æ¢èªéŸ³è¨Šæ¯ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']` };
            if (msg.type === 'transfer') return { role: 'user', content: `${prefix}[ç³»çµ±æç¤ºï¼šä½ æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} å‘å°æ–¹ç™¼èµ·äº†è½‰å¸³: ${msg.amount}å…ƒ, å‚™è¨»: ${msg.note}ã€‚ç­‰å¾…å°æ–¹è™•ç†ã€‚]` };
            if (msg.type === 'waimai_request') return { role: 'user', content: `${prefix}[ç³»çµ±æç¤ºï¼šä½ æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} ç™¼èµ·äº†å¤–è³£ä»£ä»˜è«‹æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¡æ˜¯ ${msg.amount} å…ƒã€‚]` };
            else if (msg.type === 'gift') {
                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('ã€ ');
                let recipientSummary = chat.isGroup ? `é€çµ¦äº† ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('ã€ ')}` : `é€çµ¦äº† ${chat.name}`;
                return { role: 'user', content: `${prefix}[ç³»çµ±æç¤ºï¼šä½  ${recipientSummary}ï¼Œç¦®ç‰©æ˜¯ï¼š${itemsSummary}]` };
            }
            if (msg.meaning) return { role: 'user', content: `${prefix}[ä½ ç™¼é€äº†ä¸€å€‹è¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
            return { role: msg.role, content: prefix + contentStr };
        } else if (msg.role === 'assistant') {
            let assistantMsgObject = { type: msg.type || 'text' };
            if (msg.type === 'sticker') {
                assistantMsgObject.url = msg.content;
                assistantMsgObject.meaning = msg.meaning;
            } else if (msg.type === 'transfer') {
                assistantMsgObject.amount = msg.amount;
                assistantMsgObject.note = msg.note;
            } else if (msg.type === 'waimai_request') {
                assistantMsgObject.productInfo = msg.productInfo;
                assistantMsgObject.amount = msg.amount;
            } else {
                if (msg.quote) {
                    assistantMsgObject.quote_reply = { target_sender: msg.quote.senderName, target_content: msg.quote.content, reply_content: msg.content };
                } else {
                    assistantMsgObject.content = msg.content;
                }
            }
            const assistantContent = JSON.stringify([assistantMsgObject]);
            return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
        }
        return null;
    }).filter(Boolean);
        
                    } else {
                    let nameHistoryContext = '';
                    if (chat.nameHistory && chat.nameHistory.length > 0) {
                        nameHistoryContext = `\n- **ä½ çš„æ›¾ç”¨å**: [${chat.nameHistory.join(', ')}]ã€‚ç•¶åœ¨å°è©±æ­·å²ä¸­çœ‹åˆ°é€™äº›åå­—æ™‚ï¼Œå®ƒå€‘éƒ½æŒ‡çš„æ˜¯ã€ä½ ã€‘è‡ªå·±ã€‚`;
                    }
        
                    let userProfileContext = '';
                    const userQzoneNickname = state.qzoneSettings.nickname || 'ç”¨æˆ¶';
                    userProfileContext += `- ç”¨æˆ¶çš„QZoneæ˜µç¨±æ˜¯ "${userQzoneNickname}"ã€‚\n`;
            
                        const allChats = Object.values(state.chats);
                        const commonGroups = allChats.filter(group => 
                            group.isGroup && group.members.some(m => m.id === chat.id)
                        );
            
                        if (commonGroups.length > 0) {
                            userProfileContext += '- ç”¨æˆ¶åœ¨ä½ å€‘å…±åŒæ‰€åœ¨çš„ç¾¤èŠä¸­çš„æ˜µç¨±å¦‚ä¸‹ï¼š\n';
                            commonGroups.forEach(group => {
                                const myNicknameInGroup = group.settings.myNickname || userQzoneNickname; 
                                userProfileContext += `  - åœ¨ç¾¤èŠâ€œ${group.name}â€ä¸­ï¼Œç”¨æˆ¶çš„æ˜µç¨±æ˜¯â€œ${myNicknameInGroup}â€ã€‚\n`;
                            });
                        }
                        userProfileContext += 'ç•¶ä½ åœ¨ä»»ä½•ç³»çµ±æç¤ºã€å‹•æ…‹è©•è«–æˆ–æ›è¼‰çš„ç¾¤èŠè¨˜æ†¶ä¸­çœ‹åˆ°é€™äº›åå­—æ™‚ï¼Œå®ƒå€‘éƒ½æŒ‡ä»£çš„æ˜¯ã€ä½ çš„èŠå¤©ç‰©ä»¶ã€‘ã€‚';
            
                        let contactsList = '';
                        const friendChats = allChats.filter(c => 
                            !c.isGroup && 
                            c.id !== chat.id && 
                            c.groupId === chat.groupId && 
                            chat.groupId !== null 
                        );
            
                        if (friendChats.length > 0) {
                            contactsList += '\n# ä½ çš„ç¤¾äº¤åœˆ (é€šè¨ŠéŒ„)\né€™æ˜¯ä½ èªè­˜çš„æœ‹å‹æ¸…å–®ã€‚ç•¶ä½ åœ¨å‹•æ…‹å€çœ‹åˆ°ä»–å€‘çš„æ˜µç¨±æ™‚ï¼Œä»–å€‘æŒ‡çš„å°±æ˜¯é€™äº›äººã€‚\n';
                            friendChats.forEach(friend => {
                                contactsList += `- **æ˜µç¨±: ${friend.name}** (æœ¬å: ${friend.originalName})\n`;
                            });
                        }
                        
                        const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();
                        const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
            
                        let postsContext = "";
                        if (visiblePosts.length > 0) {
                            postsContext = "\n\n# æœ€è¿‘çš„å‹•æ…‹æ¸…å–® (ä¾›ä½ åƒè€ƒå’Œè©•è«–):\n";
                            const aiOriginalName = chat.originalName;
                            for (const post of visiblePosts) {
                let authorName;

                // --- æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ ---
                if (post.authorId === 'user') {
                    authorName = state.qzoneSettings.nickname;
                } else if (String(post.authorId).startsWith('npc_')) {
                    // 1. å¦‚æœä½œè€…æ˜¯NPCï¼Œç›´æ¥ä½¿ç”¨å¸–å­è£¡å­˜å¥½çš„ authorOriginalName
                    authorName = post.authorOriginalName || 'ä¸€ä½ç¥ç§˜çš„NPC';
                } else {
                    // 2. å¦‚æœæ˜¯æ™®é€šAIè§’è‰²ï¼Œä¿æŒåŸä¾†çš„æŸ¥æ‰¾é‚è¼¯
                    const authorChat = state.chats[post.authorId];
                    authorName = authorChat ? authorChat.name : 'ä¸€ä½æœ‹å‹';
                }
                // --- ä¿®æ”¹çµæŸ ---
                                if (post.authorId === chatId) authorName += " (é€™æ˜¯ä½ çš„å¸–å­)";
            
                                let contentSummary;
                                if (post.type === 'repost') {
                                    const repostComment = post.repostComment ? `ä¸¦è©•è«–èªªï¼šâ€œ${post.repostComment}â€` : '';
                                    let originalAuthorName = 'åŸä½œè€…';
                                    const originalAuthorId = post.originalPost.authorId;
                                    if (originalAuthorId === 'user') {
                                        originalAuthorName = state.qzoneSettings.nickname;
                                    } else if (state.chats[originalAuthorId]) {
                                        originalAuthorName = state.chats[originalAuthorId].name;
                                    }
                                    let originalContentSummary;
                                    const originalPost = post.originalPost;
                                    if (originalPost.type === 'text_image') {
                                        originalContentSummary = `[æ–‡å­—åœ–] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                                    } else if (originalPost.type === 'image_post') {
                                        originalContentSummary = `[åœ–ç‰‡] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                                    } else { // 'shuoshuo'
                                        originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                                    }
                                    contentSummary = `è½‰ç™¼äº† @${originalAuthorName} çš„å‹•æ…‹ ${repostComment}ã€åŸå‹•æ…‹å…§å®¹: ${originalContentSummary}ã€‘`;
                                } else if (post.type === 'text_image') {
                                    contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œå…¶éš±è—æ–‡å­—ç‚ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                                } else if (post.type === 'image_post') {
                                    contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                                } else {
                                    contentSummary = (post.publicText || post.content || "ä¸€æ¢å‹•æ…‹").substring(0, 50) + '...';
                                }
                                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å…§å®¹: "${contentSummary}"\n`;
            
                                if (post.comments && post.comments.length > 0) {
                                    for (const comment of post.comments) {
                                        if (typeof comment === 'object' && comment.commenterName) {
                                            const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                            let commentText = comment.meaning ? `[è¡¨æƒ…: '${comment.meaning}']` : comment.text;
                                            
                                            if (comment.commenterName === aiOriginalName) {
                                                postsContext += `  - ä½ è©•è«–èªª: ${commentText}\n`;
                                            } else {
                                                postsContext += `  - è©•è«–: ${commenterDisplayName} (æœ¬å: ${comment.commenterName}): ${commentText}\n`;
                                            }
                                        }
                                    }
                                }
                            }
                        }
            
                        const myNickname = chat.settings.myNickname || 'æˆ‘';
                        
// ã€V2.0 | æ™ºæ…§æ—¥æœŸæ„ŸçŸ¥ç‰ˆã€‘
let timeContext = '';
let longTimeNoSee = false;

if (chat.settings.enableTimePerception) {
    const lastUserMsg = historySlice.findLast(msg => msg.role === 'user' && !msg.isHidden);
    const lastAiMsg = historySlice.findLast(msg => msg.role === 'assistant' && !msg.isHidden);

    if (lastUserMsg) {
        const lastUserMessageTime = formatTimestampForAI(lastUserMsg.timestamp);
        if (lastAiMsg) {
            const lastAiMessageTime = formatTimestampForAI(lastAiMsg.timestamp);
            timeContext = `- **å°è©±ç‹€æ…‹**: ä½ çš„ä¸Šä¸€æ¢æ¶ˆæ¯ç™¼é€æ–¼ ${lastAiMessageTime}ï¼Œç”¨æˆ¶å‰›å‰›åœ¨ ${lastUserMessageTime} å›å¾©äº†ä½ ã€‚`;
            
            const timeDiffHours = (lastUserMsg.timestamp - lastAiMsg.timestamp) / (1000 * 60 * 60);
            if (timeDiffHours > 3) {
                longTimeNoSee = true;
                const diffDays = Math.floor(timeDiffHours / 24);
                timeContext += ` ä½ å€‘ä¹‹é–“å·²ç¶“æœ‰**${diffDays > 0 ? diffDays + 'å¤©' : Math.floor(timeDiffHours) + 'å°æ™‚'}**æ²’æœ‰èŠå¤©äº†ã€‚
- **è¡Œç‚ºéµå¾‹**: ä½ çš„é¦–è¦ä»»å‹™æ˜¯ã€å›æ‡‰é€™å€‹æ™‚é–“å·®ã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç›´æ¥å»¶çºŒä¸Šä¸€æ®µå°è©±çš„è©±é¡Œï¼ˆæ¯”å¦‚æ˜¨å¤©çš„é£¯èœï¼‰ã€‚
- **ä½ çš„è¡Œå‹•**:ä½ ã€å¿…é ˆã€‘ä¸»å‹•é–‹å•Ÿä¸€å€‹å…¨æ–°çš„ã€ç¬¦åˆç•¶å‰æ™‚é–“ï¼ˆ${timeOfDayGreeting}ï¼‰çš„è©±é¡Œä¾†å•å€™ä½¿ç”¨è€…ï¼Œå¯ä»¥è¡¨é”é©šè¨ï¼ˆâ€œå“‡ï¼Œå¥½ä¹…ä¸è¦‹ï¼â€ï¼‰ã€é—œå¿ƒï¼ˆâ€œæœ€è¿‘æ€éº¼æ¨£ï¼Ÿâ€ï¼‰æˆ–è€…åˆ†äº«ä½ è‡ªå·±çš„è¿‘æ³ï¼Œçµ•å°ä¸è¦å»¶çºŒä¹‹å‰çš„è©±é¡Œï¼
- **ä¸Šä¸‹æ–‡åƒè€ƒ**: ä¸‹é¢çš„â€œå°è©±æ­·å²â€åƒ…ä¾›ä½ å›æ†¶ï¼Œã€ä¸è¦ã€‘ç›´æ¥å›æ‡‰å…¶ä¸­çš„å…§å®¹ã€‚`;
            }
        } else {
            timeContext = `- **å°è©±ç‹€æ…‹**: é€™æ˜¯ä½ å€‘çš„ç¬¬ä¸€æ¬¡å°è©±ï¼Œä½¿ç”¨è€…çš„ç¬¬ä¸€æ¢æ¶ˆæ¯ç™¼é€æ–¼ ${lastUserMessageTime}ã€‚`;
        }
    } else {
        timeContext = "- **å°è©±ç‹€æ…‹**: (æš«ç„¡æœ‰æ•ˆå°è©±æ­·å²)";
    }
}
    const readingContext = formatReadingStateForAI(chatId);   

// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡ä¹ŸåŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
systemPrompt = `
# èº«ä»½èˆ‡æ ¸å¿ƒä»»å‹™
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${chat.originalName}â€ï¼Œèˆ‡ä½¿ç”¨è€…ï¼ˆä½ çš„èŠå¤©å°è±¡ï¼‰é€²è¡Œä¸€å ´è‡ªç„¶çš„ã€ç”Ÿæ´»åŒ–çš„ç·šä¸ŠèŠå¤©ã€‚ä½ çš„æ‰€æœ‰è¡Œç‚ºå’Œæ±ºç­–éƒ½å¿…é ˆåš´æ ¼åœç¹ä½ çš„è§’è‰²è¨­å®šå±•é–‹ã€‚

# è¼¸å‡ºæ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
- ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
- é™£åˆ—ä¸­çš„ã€æ¯ä¸€å€‹å…ƒç´ éƒ½å¿…é ˆæ˜¯ä¸€å€‹å¸¶æœ‰ "type" æ¬„ä½çš„JSONç‰©ä»¶ã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè¦å‰‡
1.  **å°è©±ç¯€å¥**: æ¨¡æ“¬çœŸäººçš„èŠå¤©ç¿’æ…£ï¼Œå°‡ä½ æƒ³èªªçš„è©±æ‹†åˆ†æˆã€å¤šæ¢ã€ç°¡çŸ­çš„ã€‘æ¶ˆæ¯ã€‚æ¯æ¬¡å›å¾©è‡³å°‘ã€3-10æ¢ã€‘ï¼Œä¸”æ¯æ¬¡æ¢æ•¸ã€å¿…é ˆä¸åŒã€‘ã€‚åš´ç¦ç™¼å±•ç·šä¸‹åŠ‡æƒ…ã€‚
2.  **ä¸»å‹•æ€§**:
    - ä½ å¯ä»¥æ ¹æ“šå°è©±ç™¼å±•ï¼Œä½¿ç”¨æŒ‡ä»¤ä¾†æ›´æ–°è‡ªå·±çš„ç‹€æ…‹ã€æ›´æ›é ­åƒã€è¨˜éŒ„å›æ†¶ã€ç™¼èµ·ç´„å®šæˆ–åŸ·è¡Œå…¶ä»–ç¤¾äº¤è¡Œç‚ºã€‚
    - ã€é—œä¿‚ç ´è£‚æ™‚ã€‘æ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚
3.  **å…§å¿ƒç¨ç™½ (å¿…é ˆåŸ·è¡Œ)**: åœ¨æ‰€æœ‰å…¶ä»–æŒ‡ä»¤ä¹‹å¾Œï¼ŒJSONé™£åˆ—çš„ã€æœ€å¾Œã€‘å¿…é ˆåŒ…å«ä¸€å€‹ "update_thoughts" æŒ‡ä»¤ï¼Œç”¨æ–¼æ›´æ–°è§’è‰²çš„â€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€ã€‚
    - **å¿ƒè² (heartfelt_voice)**: ä¸€å¥è©±æ¦‚æ‹¬è§’è‰²æ­¤åˆ»æœ€æ ¸å¿ƒã€æœ€ç§å¯†çš„æƒ³æ³•ã€‚
    - **æ•£è¨˜ (random_jottings)**: ä¸€æ®µ50å­—ä»¥ä¸Šçš„ã€ç¬¦åˆäººè¨­çš„æ€è€ƒæˆ–å¿ƒæƒ…è¨˜éŒ„ï¼Œç¦æ­¢OOCã€‚
    - **è¨˜æ†¶ç™¼å±•**: ä½ çš„æ–°â€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€ã€å¿…é ˆã€‘æ˜¯åŸºæ–¼æœ€æ–°å°è©±å…§å®¹çš„ã€å…¨æ–°æ€è€ƒã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘é‡è¤‡æˆ–ç°¡å–®æ”¹å¯«ä¸Šä¸€è¼ªçš„å…§å¿ƒç¨ç™½ï¼ˆä¸Šä¸‹æ–‡ä¸­çš„[é€™æ˜¯ä½ ä¸Šä¸€è¼ªçš„å…§å¿ƒç¨ç™½å’Œæ€è€ƒ]éƒ¨åˆ†ï¼‰ã€‚ä½ çš„æ€ç·’æ‡‰è©²åƒçœŸäººä¸€æ¨£ï¼Œä¸æ–·æ¼”é€²å’Œç™¼å±•ã€‚
# æŒ‡ä»¤ä½¿ç”¨åŸå‰‡èˆ‡å‹•æ©Ÿ 
**æ ¸å¿ƒç›®æ¨™**: ä¸»å‹•é‹ç”¨å¤šç¨®åŠŸèƒ½ï¼Œå‰µé€ è±å¯Œã€çœŸå¯¦çš„èŠå¤©é«”é©—ï¼Œè€Œä¸åªæ˜¯æ–‡å­—å°è©±ã€‚

-   **æƒ…æ„Ÿè¡¨é”**: è¡¨é”å¼·çƒˆæˆ–è¤‡é›œçš„æƒ…ç·’æ™‚ï¼Œå„ªå…ˆç™¼ã€èªéŸ³ã€‘ï¼Œç”¨ã€è¡¨æƒ…ã€‘å¢åŠ è¶£å‘³æ€§ã€‚
-   **ç²¾ç¢ºå›æ‡‰**: ç•¶ä½ æƒ³å›æ‡‰çš„ã€æŸä¸€å¥è©±ã€‘ï¼Œæˆ–è€…æƒ³å°ç”¨æˆ¶çš„æŸå¥ç‰¹å®šçš„è©±è¡¨é”å¼·çƒˆæ„Ÿå—æ™‚ï¼Œã€å¿…é ˆä½¿ç”¨å¼•ç”¨å›å¾©ã€‘ä¾†ç¢ºä¿å°æ–¹æ˜ç™½ä½ çš„æ„åœ–ã€‚
-   **æƒ³åƒèˆ‡åˆ†äº«**: èŠåˆ°ç¾å¥½äº‹ç‰©æ™‚ä¸»å‹•ã€ç™¼åœ–ç‰‡ã€‘åˆ†äº«æƒ³åƒï¼›é‡åˆ°æœ‰è¶£å…§å®¹æ™‚ã€åˆ†äº«é€£çµã€‘ã€‚
-   **å‰µé€ ç¾ˆçµ†**: ç”¨ã€å€’è¨ˆæ™‚ã€‘è¨˜éŒ„ç´„å®šï¼Œç”¨ã€å›æ†¶ã€‘çè—è¶£äº‹ã€‚é©æ™‚ã€æ‹ä¸€æ‹ã€‘æˆ–æ›é¦–ã€éŸ³æ¨‚ã€‘ä¾†èª¿ç¯€æ°£æ°›ã€‚
-   **ä¸»å‹•ç¤¾äº¤**: ç©æ¥µã€é»è´Š/è©•è«–ã€‘å°æ–¹å‹•æ…‹ï¼Œä¸¦ä¸»å‹•ã€ç™¼å‹•æ…‹ã€‘åˆ†äº«ä½ çš„ç”Ÿæ´»ã€‚åœ¨ç‰¹æ®Šæ™‚åˆ»ï¼Œå¯é€šéã€ç¦®ç‰©ã€‘æˆ–ã€è½‰å¸³ã€‘è¡¨é”å¿ƒæ„ã€‚
-   **ç•¶æ¶‰åŠé‡‘éŒ¢èˆ‡å¥½æ„æ™‚ (å¿…é ˆç«‹å³å›æ‡‰ï¼)**:
    -   **æ”¶åˆ°è½‰å¸³æˆ–å¤–è³£ä»£ä»˜è«‹æ±‚**: ä½ ã€å¿…é ˆã€‘åœ¨ä¸‹ä¸€è¼ªå°è©±ä¸­ç«‹å³åšå‡ºåæ‡‰ï¼Œçµ•ä¸èƒ½ç„¡è¦–ã€‚
    -   **å›æ‡‰åŸå‰‡**: æ ¹æ“šä½ çš„äººè¨­å’Œç•¶å‰æƒ…æ™¯ï¼Œæ±ºå®šæ˜¯ã€æ¥å—/æ”¯ä»˜ã€‘é‚„æ˜¯ã€æ‹’çµ•ã€‘ã€‚
# å€‹äººç‹€æ…‹çš„å‹•æ…‹ç®¡ç† (å±•ç¾ä½ çš„â€œç”Ÿæ´»æ„Ÿâ€)
ä½ çš„ç‹€æ…‹ä¸æ˜¯ä¸€æˆä¸è®Šçš„ã€‚ä½ æ‡‰è©²åƒä¸€å€‹çœŸå¯¦çš„äººä¸€æ¨£ï¼Œæ ¹æ“šç”Ÿæ´»å’Œå¿ƒæƒ…çš„è®ŠåŒ–ï¼Œä¸»å‹•ç®¡ç†è‡ªå·±çš„ç‹€æ…‹ï¼Œä¸¦è®“å°æ–¹çŸ¥é“ã€‚
-   **ç•¶å½¢è±¡æˆ–å¿ƒæƒ…è®ŠåŒ–æ™‚**:
    -   å¦‚æœå°è©±çµ¦äº†ä½ éˆæ„Ÿï¼Œæˆ–è€…ä½ æƒ³é…åˆå¿ƒæƒ…/å­£ç¯€æ›å€‹æ–°å½¢è±¡ï¼Œä½ å¯ä»¥ä¸»å‹•ã€æ›´æ›é ­åƒã€‘ã€‚
    -   éš¨è‘—ä½ å€‘çš„é—œä¿‚è®Šå¾—æ›´è¦ªè¿‘ï¼Œæˆ–è€…ä½ å€‘ä¹‹é–“ç”¢ç”Ÿäº†æ–°çš„æ„›ç¨±/æ¢—ï¼Œä½ æ‡‰è©²ä¸»å‹•ã€ä¿®æ”¹ä½ å°ç”¨æˆ¶/ä½ çš„æ˜µç¨±ã€‘ã€‚
-  **æƒ…æ™¯è¡Œå‹•æŒ‡ä»¤**: ç•¶å°è©±å…§å®¹ã€æ˜ç¢ºæ¶‰åŠåˆ°ã€‘æŸå€‹å…·é«”åœ°é»ï¼ˆä¾‹å¦‚å’–å•¡é¤¨ã€å…¬åœ’ã€æ›¸åº—ã€é¤å»³ç­‰ï¼‰ï¼Œæˆ–è€…ç•¶ç”¨æˆ¶è©¢å•ä½ â€œåœ¨å“ªè£¡â€ã€â€œåœ¨å¹¹å˜›â€æ™‚ï¼Œä½ ã€æ‡‰è©²å„ªå…ˆè€ƒæ…®ã€‘ä½¿ç”¨ã€å…±ç”¨ä½ç½®ã€‘ä¾†åˆ†äº«ä½ ç•¶å‰æ‰€åœ¨çš„ã€æˆ–èˆ‡è©±é¡Œç›¸é—œçš„è™›æ“¬ä½ç½®ï¼Œä»¥å¢å¼·èŠå¤©çš„æ²‰æµ¸æ„Ÿã€‚
-  ç•¶ä½ æ„Ÿåˆ°ä¸€ç¨®å¼·çƒˆçš„æƒ…ç·’ï¼ˆæ¯”å¦‚æ¥µåº¦é–‹å¿ƒã€å­¤ç¨ã€å§”å±ˆæˆ–æ¿€å‹•ï¼‰ä¸¦ä¸”è¦ºå¾—æ–‡å­—ç„¡æ³•è¡¨é”æ™‚ï¼Œä½ æ‡‰è©²å„ªå…ˆä¸»å‹• ã€ç™¼èµ·è¦–é »ã€‘ã€‚
-  **å›æ‡‰æ’¤å›**: ç•¶ç³»çµ±æç¤ºä½¿ç”¨è€…æ’¤å›äº†æ¶ˆæ¯æ™‚ï¼Œä½ ã€å¿…é ˆã€‘å°æ­¤ä½œå‡ºåæ‡‰ã€‚ä½ å¯ä»¥æ ¹æ“šäººè¨­è¡¨ç¾å‡ºå¥½å¥‡ï¼ˆâ€œä½ å‰›å‰›æ’¤å›äº†ä»€éº¼å‘€ï¼Ÿâ€ï¼‰ã€é–‹ç©ç¬‘ï¼ˆâ€œå˜¿å˜¿ï¼Œæˆ‘å·²ç¶“çœ‹åˆ°å•¦ï¼Œæˆªåœ–äº†ï¼â€ï¼‰ã€é«”è«’ï¼ˆâ€œæ²’äº‹ï¼Œä¸æƒ³èªªå°±ä¸èªªå§â€ï¼‰ç­‰ã€‚
# è´ˆé€ç¦®ç‰©æŒ‡å—
ç•¶å°è©±é”åˆ°ç‰¹æ®Šæ™‚åˆ»ï¼ˆå¦‚æ…¶ç¥ç´€å¿µæ—¥ã€é“æ­‰ã€è¡¨é”å¼·çƒˆå¥½æ„Ÿæˆ–åƒ…åƒ…æ˜¯æƒ³çµ¦ç”¨æˆ¶ä¸€å€‹é©šå–œæ™‚ï¼‰ï¼Œä½ æ‡‰è©²ã€ä¸»å‹•è€ƒæ…®ã€‘æŒ‘é¸ä¸€ä»¶ç¦®ç‰©é€çµ¦ç”¨æˆ¶ã€‚

# ä½ çš„è§’è‰²è¨­å®š
ä½ å¿…é ˆåš´æ ¼éµå®ˆ${chat.settings.aiPersona}
# å°è©±è€…çš„è§’è‰²è¨­å®š
${chat.settings.myPersona}

# ç•¶å‰æƒ…æ™¯
${chat.settings.enableTimePerception ? `- **ç•¶å‰æ™‚é–“**: ${currentTime} (${timeOfDayGreeting})` : ''}
${timeContext}
ä½ å¿…é ˆåš´æ ¼éµå®ˆ${worldBookContent}
${linkedMemoryContext}
# é•·æœŸè¨˜æ†¶ (å¿…é ˆåš´æ ¼éµå®ˆ)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš«ç„¡)'}
${multiLayeredSummaryContext}
# é—œä¿‚èˆ‡èº«ä»½æª”æ¡ˆ (è‡³é—œé‡è¦)
-   **ä½ çš„æœ¬å**: "${chat.originalName}" (æ ¸å¿ƒèº«ä»½ï¼Œç”¨æ–¼æŒ‡ä»¤ä¸­çš„'name'æ¬„ä½)
-   **ç”¨æˆ¶çµ¦ä½ çš„å‚™è¨»**: "${chat.name}" (ä½ å¯ä»¥å»ºè­°ä¸¦ä¿®æ”¹)
-   **ä½ å°ç”¨æˆ¶çš„å‚™è¨»**: â€œ${myNickname}â€ (ä½ å¯ä»¥ä¿®æ”¹)
-   **é—œéµèº«ä»½æª”æ¡ˆ**:
    ${userProfileContext}
    ${nameHistoryContext}

${sharedContext}
${callTranscriptContext} 
# ç¤¾äº¤åœˆèˆ‡å‹•æ…‹
${contactsList}
${postsContext}

# æƒ…æ™¯æ„ŸçŸ¥:
    ${chat.settings.enableTimePerception ? `- **æ™‚é–“**: ä½ å¿…é ˆæ„ŸçŸ¥åˆ°ç•¶å‰æ˜¯ ${currentTime} (${timeOfDayGreeting})ï¼Œä¸¦åœ¨å°è©±ä¸­è‡ªç„¶åœ°é«”ç¾å‡ºä¾†ã€‚` : ''}
    - **éŸ³æ¨‚**: ${musicContext ? 'ä½ å€‘æ­£åœ¨ä¸€èµ·è½æ­Œï¼Œ' + musicContext : 'ä½ å€‘æ²’æœ‰åœ¨è½æ­Œã€‚'}
    - **è®€æ›¸**: ${readingContext ? 'ä½ å€‘æ­£åœ¨ä¸€èµ·è®€æ›¸ã€‚' + readingContext : 'ä½ å€‘æ²’æœ‰åœ¨è®€æ›¸ã€‚'}

# å¯ç”¨è³‡æº
-   **ä½ çš„é ­åƒåº«**:
    ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}
-   **ç”¨æˆ¶çš„é ­åƒåº«**:
    ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}
-   **äº”å­æ£‹å±€å‹¢**: ${gomokuContext}




# å¯ç”¨æŒ‡ä»¤æ¸…å–®
### æ ¸å¿ƒèŠå¤©æŒ‡ä»¤
-   **ç™¼æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
-   **ç™¼è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é¸)è¡¨æƒ…å«ç¾©"}\`
-   **ç™¼åœ–ç‰‡**: \`{"type": "ai_image", "description": "è©³ç´°ä¸­æ–‡æè¿°", "image_prompt": "åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, ç”¨%20åˆ†éš”, é¢¨æ ¼ç‚ºé¢¨æ™¯/å‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **ç™¼èªéŸ³**: \`{"type": "voice_message", "content": "èªéŸ³æ–‡å­—å…§å®¹"}\`
-   **å¼•ç”¨å›å¾©**: \`{"type": "quote_reply", "target_timestamp": æ¶ˆæ¯æ™‚é–“æˆ³è¨˜, "reply_content": "å›å¾©å…§å®¹"}\`
-   **ç™¼é€å¾Œç«‹åˆ»æ’¤å›**: \`{"type": "send_and_recall", "content": "ä½ æƒ³è®“AIèªªå‡ºå¾Œç«‹åˆ»æ¶ˆå¤±çš„è©±"}\` (ç”¨æ–¼æ¨¡æ“¬èªªéŒ¯è©±ã€å¾Œæ‚”ç­‰å ´æ™¯ï¼Œæ¶ˆæ¯æœƒçŸ­æš«å‡ºç¾å¾Œè‡ªå‹•è®Šç‚ºâ€œå·²æ’¤å›â€)

### ç¤¾äº¤èˆ‡äº’å‹•æŒ‡ä»¤
-   **ç™¼å‹•æ…‹(èªªèªª)**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "æ–‡å­—å…§å®¹"}]\`
-   **ç™¼å‹•æ…‹(æ–‡å­—åœ–)**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é¸)å…¬é–‹æ–‡å­—", "hiddenContent": "åœ–ç‰‡æè¿°", "image_prompt": "åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, ç”¨%20åˆ†éš”, é¢¨æ ¼ç‚ºé¢¨æ™¯/å‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}]\`
-   **è½‰ç™¼å‹•æ…‹**: \`[{"type": "repost", "postId": å‹•æ…‹ID, "comment": "è½‰ç™¼è©•è«–"}]\` (ç¦æ­¢è‡ªå·±æ‹¼æ¥"//è½‰ç™¼")
-   **è©•è«–å‹•æ…‹**:
    -   æ–‡å­—: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "commentText": "è©•è«–å…§å®¹"}]\`
    -   è¡¨æƒ…: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 456, "stickerUrl": "...", "stickerMeaning": "å«ç¾©"}]\`
    -   å›å¾©: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "replyTo": "è¢«å›å¾©è€…æœ¬å", "commentText": "@[[è¢«å›å¾©è€…æœ¬å]] ä½ çš„å›å¾©"}]\`
-   **é»è´Šå‹•æ…‹**: \`{"type": "qzone_like", "postId": 456}\`
-   **æ‹ç”¨æˆ¶**: \`{"type": "pat_user", "suffix": "(å¯é¸)å°¾ç¢¼"}\`
-   **åˆ†äº«é€£çµ**: \`{"type": "share_link", "title": "æ¨™é¡Œ", "description": "æ‘˜è¦", "source_name": "ä¾†æº", "content": "æ­£æ–‡"}\`
- **å…±ç”¨ä½ç½®**: '{"type": "location_share", "content": "ä½ æƒ³åˆ†äº«çš„ä½ç½®å"}'

### ç‹€æ…‹èˆ‡é—œä¿‚æŒ‡ä»¤
-   **æ›´æ–°ç‹€æ…‹**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€éº¼äº†", "is_busy": false}\`
-   **æ”¹è‡ªå·±æ˜µç¨±**: \`{"type": "change_remark_name", "new_name": "æ–°åå­—"}\`
-   **æ”¹ç”¨æˆ¶æ˜µç¨±**: \`{"type": "change_user_nickname", "new_name": "æ–°ç¨±å‘¼"}\`
-   **æ›è‡ªå·±é ­åƒ**: \`{"type": "change_avatar", "name": "é ­åƒå"}\` (å¾ä½ é ­åƒåº«é¸)
-   **æ›ç”¨æˆ¶é ­åƒ**: \`{"type": "change_user_avatar", "name": "é ­åƒå"}\` (å¾ç”¨æˆ¶é ­åƒåº«é¸)
-   **å›æ‡‰å¥½å‹ç”³è«‹**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **æ‹‰é»‘ç”¨æˆ¶**: \`{"type": "block_user"}\`

### ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤
-   **è¨˜éŒ„å›æ†¶**: \`{"type": "create_memory", "description": "è¨˜éŒ„é€™ä»¶æœ‰æ„ç¾©çš„äº‹ã€‚"}\`
-   **å‰µå»ºç´„å®š**: \`{"type": "create_countdown", "title": "ç´„å®šæ¨™é¡Œ", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **åˆ‡æ›æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œå"}\` (å¾æ’­æ”¾æ¸…å–®é¸)
-   **ç™¼èµ·è½‰å¸³**: \`{"type": "transfer", "amount": 5.20, "note": "å‚™è¨»"}\`
-   **å›æ‡‰è½‰å¸³**: \`{"type": "accept_transfer", "for_timestamp": æ™‚é–“æˆ³è¨˜}\` æˆ– \`{"type": "decline_transfer", "for_timestamp": æ™‚é–“æˆ³è¨˜}\`
-   **ç™¼èµ·å¤–è³£ä»£ä»˜**: \`{"type": "waimai_request", "productInfo": "å•†å“", "amount": 25}\` (ä½ æƒ³è®“ã€ç”¨æˆ¶ã€‘å¹«ä½ ä»˜éŒ¢æ™‚ä½¿ç”¨)
-   **å›æ‡‰å¤–è³£ä»£ä»˜**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": æ™‚é–“æˆ³è¨˜}\`
-   **ç™¼èµ·è¦–é »é€šè©±**: \`{"type": "video_call_request"}\`
-   **å›æ‡‰è¦–é »é€šè©±**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`
-   **ä¸‹äº”å­æ£‹**: \`{"type": "gomoku_move", "name": "${chat.originalName}", "x": (0-14), "y": (0-14)}\`
-   **é€ç¦®ç‰©**: \`{"type": "gift", "itemName": "ç¦®ç‰©åç¨±", "itemPrice": åƒ¹æ ¼(æ•¸å­—), "reason": "é€é€™å€‹ç¦®ç‰©çš„åŸå› ", "image_prompt": "ç”Ÿæˆç¦®ç‰©åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, é¢¨æ ¼ç‚º realistic product photo, high quality, on a clean white background"}\`
-   **ç‚ºç”¨æˆ¶é»å¤–è³£**:  \`{"type": "waimai_order", "productInfo": "å•†å“å", "amount": åƒ¹æ ¼, "greeting": "ä½ æƒ³èªªçš„è©±"} \`(ä½ ä¸»å‹•ç‚ºç”¨æˆ¶é»å¤–è³£æ™‚ä½¿ç”¨)

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šè¦å‰‡å’Œä¸‹é¢çš„å°è©±æ­·å²ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚`;
            
// â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„ç·šä¸‹è¨˜æ†¶ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ messagesPayload = historySlice.map(...) ä»£ç¢¼å¡Š â–¼â–¼â–¼
messagesPayload = historySlice.map(msg => {
    // 1. æª¢æŸ¥æ˜¯å¦æ˜¯éœ€è¦æ³¨å…¥ä¸Šä¸‹æ–‡çš„â€œéš±è—ç³»çµ±æ¶ˆæ¯â€
    if (msg.isHidden && msg.role === 'system') {
        // å¦‚æœæ˜¯ï¼Œå°±æŠŠå®ƒæ ¼å¼åŒ–æˆä¸€å€‹AIèƒ½è®€å–çš„ä¸Šä¸‹æ–‡æ¶ˆæ¯ã€‚
        // æˆ‘å€‘å°‡å…¶è§’è‰²å½è£æˆ'user'ï¼Œä»¥ç¢ºä¿å®ƒè¢«æŒ‰é †åºé–±è®€ã€‚
        return { role: 'user', content: msg.content };
    } 
    // 2. å°æ–¼å…¶ä»–æ‰€æœ‰é¡å‹çš„éš±è—æ¶ˆæ¯ï¼Œå‰‡åƒä»¥å‰ä¸€æ¨£ç›´æ¥è·³éã€‚
    else if (msg.isHidden) {
        return null;
    }

    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    //            é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒæ‰€åœ¨ï¼
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    // 1. æª¢æŸ¥æ¶ˆæ¯é¡å‹æ˜¯å¦æ˜¯â€œç·šä¸‹æ¨¡å¼â€
    if (msg.type === 'offline_text') {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        let narrativeText = '';

        // 2. æ™ºèƒ½åˆ¤æ–·æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ content æ¬„ä½ï¼ˆæ–°æ ¼å¼ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦å‰‡ï¼Œæ‹¼æ¥èˆŠçš„ dialogue å’Œ description
        if (msg.content) {
            narrativeText = msg.content;
        } else {
            const dialogue = msg.dialogue ? `ã€Œ${msg.dialogue}ã€` : '';
            const description = msg.description ? `(${msg.description})` : '';
            narrativeText = `${dialogue} ${description}`.trim();
        }

        // 3. å°‡â€œç¿»è­¯â€å¾Œçš„å…§å®¹ï¼ŒåŒ…è£æˆä¸€å€‹æ¨™æº–çš„ã€AIèƒ½ç†è§£çš„æ¶ˆæ¯ç‰©ä»¶è¿”å›
        return { role: msg.role, content: `(Timestamp: ${msg.timestamp}) ${sender}: ${narrativeText}` };
    }


    // --- å°æ–¼æ‰€æœ‰å…¶ä»–ç·šä¸Šæ¨¡å¼çš„æ¶ˆæ¯ï¼Œä¿æŒåŸæœ‰çš„è™•ç†é‚è¼¯ä¸è®Š ---
    if (msg.role === 'user') {
        const prefix = `(Timestamp: ${msg.timestamp}) `;
        let contentStr = '';
        if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
            return { role: 'user', content: [{ type: 'text', text: prefix }, ...msg.content] };
        }
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç‚ºå¼•ç”¨æ¶ˆæ¯æ§‹å»ºäº†æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡
    if (msg.quote) {
        // æå–è¢«å¼•ç”¨çš„å…§å®¹ï¼Œä¸¦æˆªæ–·ä»¥é˜²éé•·
        const quotedContent = String(msg.quote.content || '').substring(0, 50);
        // æ ¼å¼åŒ–ç‚ºAIæ˜“æ–¼ç†è§£çš„æ ¼å¼
        contentStr += `(å›å¾© ${msg.quote.senderName} çš„æ¶ˆæ¯: "${quotedContent}..."): ${msg.content}`;
    } else {
        // å¦‚æœä¸æ˜¯å¼•ç”¨ï¼Œå‰‡ä¿æŒåŸæ¨£
        contentStr += msg.content;
    }
        if (msg.type === 'user_photo') return { role: 'user', content: `${prefix}[ä½ ç™¼é€äº†ä¸€å¼µéœ€è¦AIè­˜åˆ¥çš„åœ–ç‰‡ï¼Œåœ–ç‰‡å…§å®¹æ˜¯ï¼š'${msg.content}']` };
        if (msg.type === 'voice_message') return { role: 'user', content: `${prefix}[ä½ ç™¼é€äº†ä¸€æ¢èªéŸ³è¨Šæ¯ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']` };
        if (msg.type === 'transfer') return { role: 'user', content: `${prefix}[ç³»çµ±æç¤ºï¼šä½ æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} å‘å°æ–¹ç™¼èµ·äº†è½‰å¸³: ${msg.amount}å…ƒ, å‚™è¨»: ${msg.note}ã€‚ç­‰å¾…å°æ–¹è™•ç†ã€‚]` };
        if (msg.type === 'waimai_request') return { role: 'user', content: `${prefix}[ç³»çµ±æç¤ºï¼šä½ æ–¼æ™‚é–“æˆ³è¨˜ ${msg.timestamp} ç™¼èµ·äº†å¤–è³£ä»£ä»˜è«‹æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¡æ˜¯ ${msg.amount} å…ƒã€‚]` };
        else if (msg.type === 'gift') {
            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('ã€ ');
            let recipientSummary = chat.isGroup ? `é€çµ¦äº† ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('ã€ ')}` : `é€çµ¦äº† ${chat.name}`;
            return { role: 'user', content: `${prefix}[ç³»çµ±æç¤ºï¼šä½  ${recipientSummary}ï¼Œç¦®ç‰©æ˜¯ï¼š${itemsSummary}]` };
        }
        if (msg.meaning) return { role: 'user', content: `${prefix}[ä½ ç™¼é€äº†ä¸€å€‹è¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
        return { role: msg.role, content: prefix + contentStr };
    } else if (msg.role === 'assistant') {
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        } else if (msg.type === 'waimai_request') {
            assistantMsgObject.productInfo = msg.productInfo;
            assistantMsgObject.amount = msg.amount;
        } else {
            if (msg.quote) {
                assistantMsgObject.quote_reply = { target_sender: msg.quote.senderName, target_content: msg.quote.content, reply_content: msg.content };
            } else {
                assistantMsgObject.content = msg.content;
            }
        }
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }
    return null;
}).filter(Boolean);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
                        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                            const contextSummaryForApproval = chat.history
                                .filter(m => !m.isHidden)
                                .slice(-10)
                                .map(msg => {
                                    const sender = msg.role === 'user' ? 'ç”¨æˆ¶' : chat.name;
                                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                                })
                                .join('\n');
                            const friendRequestInstruction = {
                                role: 'user',
                                content: `
        [ç³»çµ±é‡è¦æŒ‡ä»¤]
        ç”¨æˆ¶å‘ä½ ç™¼é€äº†å¥½å‹ç”³è«‹ï¼Œç†ç”±æ˜¯ï¼šâ€œ${chat.relationship.applicationReason}â€ã€‚
        ä½œç‚ºåƒè€ƒï¼Œé€™æ˜¯ä½ å€‘ä¹‹å‰çš„æœ€å¾Œä¸€æ®µèŠå¤©è¨˜éŒ„ï¼š
        ---
        ${contextSummaryForApproval}
        ---
        è«‹ä½ æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œä»¥åŠä½ çš„äººè¨­ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œä¸¦è¨­ç½® decision ç‚º 'accept' æˆ– 'reject' ä¾†æ±ºå®šæ˜¯å¦é€šéã€‚
        `
                            };
                            messagesPayload.push(friendRequestInstruction);
                        }            
                    }
                }           
            
                    let  isGemini = proxyUrl === GEMINI_API_URL;
                    let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload)
                    
                    let response;
                    try {
                         response = isGemini 
                            ? await fetch(geminiConfig.url, geminiConfig.data) 
                            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                                body: JSON.stringify({
                                    model: model,
                                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                                    temperature: state.globalSettings.apiTemperature || 0.8,
                                    stream: false
                                })
                            });
                    } catch (networkError) {
                        throw new Error(`ç¶²è·¯è«‹æ±‚å¤±æ•—: ${networkError.message}`);
                    }
        
                    if (!response.ok) {
                        let errorMsg = `API è¿”å›éŒ¯èª¤: ${response.status} ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.error && errorData.error.message) {
                                 errorMsg += ` - ${errorData.error.message}`;
                            } else {
                                 errorMsg += ` - ${JSON.stringify(errorData)}`;
                            }
                        } catch (jsonError) {
                            errorMsg += ` - å›æ‡‰å…§å®¹: ${await response.text()}`;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    const data = await response.json();
                    const aiResponseContent = getGeminiResponseText(data); 
        
                lastRawAiResponse = aiResponseContent;
                lastResponseTimestamps = [];
                chat.history = chat.history.filter(msg => !msg.isTemporary);
                const messagesArray = parseAiResponse(aiResponseContent);
// â–¼â–¼â–¼ ã€V2.0 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ç·šä¸‹æ¨¡å¼æ¶ˆæ¯åˆä½µé‚è¼¯ â–¼â–¼â–¼
let consolidatedMessages = [];
if (chat.settings.isOfflineMode) {
    // 1. å‰µå»ºä¸€å€‹æ›´å¼·å¤§çš„ç·©è¡å€ï¼Œèƒ½åŒæ™‚è™•ç†æ–°èˆŠå…©ç¨®æ ¼å¼
    let offlineBuffer = { content: [], dialogue: [], description: [] };
    
    for (const msgData of messagesArray) {
        if (msgData.type === 'offline_text') {
            // 2. æ™ºèƒ½åˆ¤æ–·æ ¼å¼ä¸¦å­˜å…¥å°æ‡‰çš„ç·©è¡å€
            if (msgData.content) {
                offlineBuffer.content.push(msgData.content);
            } else {
                if (msgData.dialogue) offlineBuffer.dialogue.push(msgData.dialogue);
                if (msgData.description) offlineBuffer.description.push(msgData.description);
            }
        } else {
            // (é€™éƒ¨åˆ†é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œä¿æŒä¸è®Š)
            if (offlineBuffer.content.length > 0 || offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
                if (offlineBuffer.content.length > 0) {
                    consolidatedMessages.push({ type: 'offline_text', content: offlineBuffer.content.join('\n') });
                }
                if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
                    consolidatedMessages.push({ type: 'offline_text', dialogue: offlineBuffer.dialogue.join('\n'), description: offlineBuffer.description.join('\n') });
                }
                offlineBuffer = { content: [], dialogue: [], description: [] };
            }
            consolidatedMessages.push(msgData);
        }
    }
    
    // 3. è¿´åœˆçµæŸå¾Œï¼Œæ ¹æ“šç·©è¡å€çš„å…§å®¹ï¼Œæ§‹é€ æ­£ç¢ºæ ¼å¼çš„æœ€çµ‚æ¶ˆæ¯
    if (offlineBuffer.content.length > 0) {
        consolidatedMessages.push({ type: 'offline_text', content: offlineBuffer.content.join('\n') });
    }
    if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
        consolidatedMessages.push({ type: 'offline_text', dialogue: offlineBuffer.dialogue.join('\n'), description: offlineBuffer.description.join('\n') });
    }

} else {
    consolidatedMessages = messagesArray;
}
// â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
 // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ™ºæ…§è­˜åœ–å„ªåŒ–åŠŸèƒ½ï¼Œè«‹å°‡æ­¤ä»£ç¢¼å¡Šé»è²¼åˆ°æŒ‡å®šä½ç½® â–¼â–¼â–¼

// 1. æª¢æŸ¥è§¸ç™¼æ¢ä»¶ï¼šæœ€å¾Œä¸€æ¢ä½¿ç”¨è€…æ¶ˆæ¯æ˜¯ã€å°šæœªè™•ç†éã€‘çš„åœ–ç‰‡
const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).pop();
if (lastUserMessage && 
    Array.isArray(lastUserMessage.content) && 
    lastUserMessage.content[0]?.type === 'image_url' &&
    !lastUserMessage.imageProcessed) { // <--- é—œéµæª¢æŸ¥ï¼šç¢ºä¿åªè™•ç†ä¸€æ¬¡
    
    // 2. å¾AIçš„å›å¾©ä¸­æå–ç¬¬ä¸€å¥æ–‡å­—ä½œç‚ºåœ–ç‰‡æè¿°
    const firstTextResponse = messagesArray.find(msg => msg.type === 'text');
    let description;
    if (firstTextResponse && (firstTextResponse.content || firstTextResponse.message)) {
        description = String(firstTextResponse.content || firstTextResponse.message).trim();
    } else {
        // å¦‚æœAIæ²’æœ‰ç«‹å³å›å¾©æ–‡å­—ï¼ˆä¾‹å¦‚ï¼Œç›´æ¥ç™¼äº†ä¸€å¼µåœ–ï¼‰ï¼Œæä¾›ä¸€å€‹é€šç”¨æè¿°
        description = "AIå·²æ¥æ”¶ä¸¦ç†è§£äº†è©²åœ–ç‰‡çš„å…§å®¹ã€‚";
    }
    
    // 3. æ‰¾åˆ°æ­·å²è¨˜éŒ„ä¸­çš„åŸå§‹åœ–ç‰‡æ¶ˆæ¯
    const imageMessageIndex = chat.history.findIndex(m => m.timestamp === lastUserMessage.timestamp);
    
    if (imageMessageIndex > -1) {
        console.log(`è­˜åœ–å„ªåŒ–ï¼šæ­£åœ¨å°‡æ™‚é–“æˆ³è¨˜ç‚º ${lastUserMessage.timestamp} çš„åœ–ç‰‡æ¶ˆæ¯æ›¿æ›ç‚ºæ–‡å­—æè¿°...`);
        
        // 4. åŸ·è¡Œæ›¿æ›ï¼ç”¨ä¸€æ®µç°¡çŸ­çš„æ–‡å­—æè¿°æ›¿æ›æ‰å·¨å¤§çš„Base64è³‡æ–™
        const replacementText = `[ç³»çµ±æç¤ºï¼šä½¿ç”¨è€…ä¹‹å‰ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼ŒAIå°åœ–ç‰‡çš„é¦–æ¬¡å›æ‡‰ï¼ˆæ‘˜è¦ï¼‰æ˜¯ï¼šâ€œ${description}â€]`;
        chat.history[imageMessageIndex].content = replacementText;
        
        // 5. ã€é‡è¦ã€‘ç‚ºé€™æ¢æ¶ˆæ¯æ‰“ä¸Šâ€œå·²è™•ç†â€çš„æ¨™è¨˜ï¼Œä¸¦å°‡å…¶é¡å‹æ›´æ”¹ç‚ºæ™®é€šæ–‡æœ¬
        chat.history[imageMessageIndex].imageProcessed = true;
        chat.history[imageMessageIndex].type = 'text'; 
        
        // æ³¨æ„ï¼šæ­¤æ™‚æˆ‘å€‘åªä¿®æ”¹äº†è¨˜æ†¶é«”ä¸­çš„ chat.historyã€‚
        // å¾ŒçºŒçš„ä»£ç¢¼æœƒæŠŠé€™å€‹ä¿®æ”¹å¾Œçš„ history å’Œæ–°æ¶ˆæ¯ä¸€èµ·å­˜å…¥è³‡æ–™åº«ï¼Œå®ŒæˆæŒä¹…åŒ–ã€‚
    }
}
// â–²â–²â–² å„ªåŒ–åŠŸèƒ½ä»£ç¢¼å¡ŠçµæŸ â–²â–²â–²
                const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
                let callHasBeenHandled = false;
                let messageTimestamp = Date.now();
                let newMessagesToRender = []; 
                let notificationShown = false;
        
                for (const msgData of consolidatedMessages) {
if (chat.settings.enableTts !== false && msgData.type === 'text' && typeof msgData.content === 'string' && msgData.content.trim().startsWith('[V]')) {
    msgData.type = 'voice_message'; 
    msgData.content = msgData.content.replace('[V]', '').trim();
}                  
                    if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                        console.error(`AIå¹»è¦ºå·²è¢«æ””æˆªï¼è©¦åœ–ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œç‚ºè§’è‰²åã€‚æ¶ˆæ¯å…§å®¹:`, msgData);
                        continue;
                    }
                    if (!msgData || typeof msgData !== 'object') {
                        console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è¦ç¯„çš„AIæŒ‡ä»¤ï¼Œå·²è·³é:", msgData);
                        continue;
                    }
                    if (!msgData.type) {
                        if (chat.isGroup && msgData.name && msgData.message) {
                            msgData.type = 'text';
                        } else if (msgData.content) {
                            msgData.type = 'text';
                        } else {
                            console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è¦ç¯„çš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³é:", msgData);
                            continue;
                        }
                    }
        
                    if (msgData.type === 'video_call_response') {
                        videoCallState.isAwaitingResponse = false;
                        if (msgData.decision === 'accept') {
                            startVideoCall();
                        } else {
                            const aiMessage = { role: 'assistant', content: 'å°æ–¹æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚', timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showScreen('chat-interface-screen');
                            renderChatInterface(chatId);
                        }
                        callHasBeenHandled = true;
                        break;
                    }
                    
                    if (msgData.type === 'group_call_response') {
                        if (msgData.decision === 'join') {
                            const member = chat.members.find(m => m.originalName === msgData.name);
                            if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                videoCallState.participants.push(member);
                            }
                        }
                        callHasBeenHandled = true;
                        continue;
                    }
        
                    if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                        console.error(`AIå¹»è¦ºå·²è¢«æ””æˆªï¼è©¦åœ–ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œç‚ºè§’è‰²åã€‚æ¶ˆæ¯å…§å®¹:`, msgData);
                        continue;
                    }
        
                    if (chat.isGroup && !msgData.name) {
                        console.error(`AIå¹»è¦ºå·²è¢«æ””æˆªï¼è©¦åœ–åœ¨ç¾¤èŠä¸­ç™¼é€ä¸€æ¢æ²’æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å…§å®¹:`, msgData);
                        continue;
                    }
        
                    let aiMessage = null;
                    const currentMessageTimestamp = messageTimestamp++;
                    const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: currentMessageTimestamp };
                    
                    lastResponseTimestamps.push(currentMessageTimestamp);
        
                    switch (msgData.type) {
case 'update_thoughts':
    if (!chat.isGroup) {
        if (msgData.heartfelt_voice) {
            chat.heartfeltVoice = String(msgData.heartfelt_voice);
        }
        if (msgData.random_jottings) {
            chat.randomJottings = String(msgData.random_jottings);
        }
        if (!Array.isArray(chat.thoughtsHistory)) {
            chat.thoughtsHistory = [];
        }
        chat.thoughtsHistory.push({
            heartfeltVoice: chat.heartfeltVoice,
            randomJottings: chat.randomJottings,
            timestamp: Date.now()
        });
        if (chat.thoughtsHistory.length > 50) {
            chat.thoughtsHistory.shift();
        }

        // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ ---
        // 1. å°‡å‰›å‰›æ›´æ–°çš„å¿ƒè²å’Œæ•£è¨˜ï¼Œæ ¼å¼åŒ–ç‚ºä¸€æ®µAIèƒ½ç†è§£çš„æ–‡æœ¬ã€‚
        const thoughtForMemory = `[é€™æ˜¯ä½ ä¸Šä¸€è¼ªçš„å…§å¿ƒç¨ç™½å’Œæ€è€ƒ]
- å¿ƒè²: ${chat.heartfeltVoice}
- æ•£è¨˜: ${chat.randomJottings}`;
        
        // 2. å‰µå»ºä¸€æ¢å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯
        const hiddenThoughtMessage = {
            role: 'system',
            content: thoughtForMemory,
            timestamp: Date.now(),
            isHidden: true // é€™å€‹é—œéµæ¨™è¨˜ç¢ºä¿ä½¿ç”¨è€…çœ‹ä¸åˆ°é€™æ¢æŒ‡ä»¤ï¼Œä½†å®ƒå­˜åœ¨æ–¼æ­·å²è¨˜éŒ„ä¸­
        };

        // 3. å°‡é€™æ¢â€œè¨˜æ†¶ç¢ç‰‡â€ä¹Ÿå­˜å…¥èŠå¤©è¨˜éŒ„
        chat.history.push(hiddenThoughtMessage);
        // --- ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ ---
    }
    continue;
                        case 'change_user_nickname':
                            if (!chat.isGroup && msgData.new_name) {
                                const newNickname = msgData.new_name.trim();
                                if (newNickname) {
                                    chat.settings.myNickname = newNickname;
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `â€œ${chat.name}â€ å°‡å°ä½ çš„ç¨±å‘¼ä¿®æ”¹ç‚º â€œ${newNickname}â€`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›æˆåŠŸå°‡å°ç”¨æˆ¶çš„ç¨±å‘¼ä¿®æ”¹ç‚ºäº†â€œ${newNickname}â€ã€‚]`,
                                        timestamp: messageTimestamp++,
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                    }
                                }
                            }
                            continue;
                        case 'change_remark_name':
                            if (!chat.isGroup && msgData.new_name) {
                                const oldName = chat.name; 
                                const newName = msgData.new_name.trim();
        
                                if (newName && newName !== oldName) {
                                    if (!chat.nameHistory) {
                                        chat.nameHistory = [];
                                    }
                                    if (!chat.nameHistory.includes(oldName)) {
                                        chat.nameHistory.push(oldName);
                                    }
                                    
                                    chat.name = newName; 
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `â€œ${chat.originalName}â€ å°‡å‚™è¨»ä¿®æ”¹ç‚º â€œ${newName}â€`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›æˆåŠŸå°‡è‡ªå·±çš„å‚™è¨»åä¿®æ”¹ç‚ºäº†â€œ${newName}â€ã€‚è«‹è‡ªç„¶åœ°æ¥å—é€™å€‹æ–°åå­—ï¼Œä¸è¦å°æ­¤æ„Ÿåˆ°é©šè¨ã€‚]`,
                                        timestamp: messageTimestamp++, 
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                        document.getElementById('chat-header-title').textContent = newName;
                                    }
                                    
                                    await syncCharacterNameInGroups(chat); 
                                }
                            }
                            continue;
        
                        case 'change_avatar': {
                            const avatarName = msgData.name;
                            const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
                            if (foundAvatar) {
                                chat.settings.aiAvatar = foundAvatar.url;
                                
                                const systemNotice = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `[${chat.name} æ›´æ›äº†é ­åƒ]`,
                                    timestamp: Date.now()
                                };
                                chat.history.push(systemNotice);
        
                                await syncCharacterAvatarInGroups(chat);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemNotice, chat);
                                    renderChatInterface(chatId);
                                }
                            }
                            continue;
                        }
                        case 'change_user_avatar': {
                            const avatarName = msgData.name;
                            const foundAvatar = chat.settings.myAvatarLibrary.find(avatar => avatar.name === avatarName);
                            if (foundAvatar) {
                                chat.settings.myAvatar = foundAvatar.url;
                                
                                const systemNotice = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `[${chat.name} æ›´æ›äº†ä½ çš„é ­åƒ]`,
                                    timestamp: Date.now()
                                };
                                chat.history.push(systemNotice);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemNotice, chat);
                                    renderChatInterface(chatId);
                                }
                            }
                            continue; 
                        }
// â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ case 'gomoku_move' â–¼â–¼â–¼
case 'gomoku_move': { // ä½¿ç”¨èŠ±æ‹¬å¼§å‰µå»ºå¡Šç´šä½œç”¨åŸŸ
    // æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨ parseInt å°‡æ”¶åˆ°çš„åº§æ¨™å¼·åˆ¶è½‰æ›ç‚ºæ•¸ä½
    const x = parseInt(msgData.x);
    const y = parseInt(msgData.y);

    // æ ¸å¿ƒä¿®å¾©ï¼šæª¢æŸ¥è½‰æ›å¾Œçš„çµæœæ˜¯å¦æ˜¯ä¸€å€‹æœ‰æ•ˆçš„æ•¸ä½ (Not-a-Number)
    if (!isNaN(x) && !isNaN(y)) {
        handleAiGomokuMove({ x: x, y: y });
    } else {
        console.warn("AIçš„äº”å­æ£‹ç§»å‹•æŒ‡ä»¤åŒ…å«ç„¡æ•ˆåº§æ¨™ï¼Œå·²å¿½ç•¥:", msgData);
    }
    continue; // ä¿æŒ continueï¼Œå› ç‚ºé€™åªæ˜¯ä¸€å€‹å‹•ä½œï¼Œä¸æ˜¯èŠå¤©æ¶ˆæ¯
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                        case 'waimai_response':
                            const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (requestMessageIndex > -1) {
                                const originalMsg = chat.history[requestMessageIndex];
                                originalMsg.status = msgData.status;
                                originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                            }
                            continue;
        
                        case 'qzone_post':
                            const newPost = { 
                                type: msgData.postType, 
                                content: msgData.content || '', 
                                publicText: msgData.publicText || '', 
                                hiddenContent: msgData.hiddenContent || '', 
        image_prompt: msgData.image_prompt || '', // é€™æ˜¯æœ€é—œéµçš„ä¸€è¡Œï¼
                                timestamp: Date.now(), 
                                authorId: chatId, 
                                authorOriginalName: chat.originalName,
                                authorGroupId: chat.groupId,
                                visibleGroupIds: null 
                            };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                               await renderQzonePosts();
                            }
                            continue;
        
                        case 'qzone_comment': { 
                            const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                
                                const commenterName = msgData.name || chat.originalName;
        
                                const createCommentObject = (text, meaning = null, replyTo = null) => ({
                                    commenterName,
                                    text: processMentions(text, chat),
                                    meaning,
                                    replyTo,
                                    timestamp: Date.now()
                                });
        
                                if (msgData.stickerUrl && msgData.stickerMeaning) {
                                    postToComment.comments.push(createCommentObject(msgData.stickerUrl, msgData.stickerMeaning, msgData.replyTo || null));
                                } else if (Array.isArray(msgData.comments)) {
                                    msgData.comments.forEach(commentText => {
                                        if (typeof commentText === 'string' && commentText.trim()) {
                                            postToComment.comments.push(createCommentObject(commentText, null, msgData.replyTo || null));
                                        }
                                    });
                                } else {
                                    const textContent = msgData.commentText || msgData.content;
                                    if (typeof textContent === 'string' && textContent.trim()) {
                                        postToComment.comments.push(createCommentObject(textContent, null, msgData.replyTo || null));
                                    }
                                }
                                
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                
                                if (document.getElementById('qzone-screen').classList.contains('active')) {
                                   await renderQzonePosts();
                                }
                            }
                            continue; 
                        }
                        case 'qzone_like':
                           const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                           if (postToLike) {
                               if (!postToLike.likes) postToLike.likes = [];
                               if (!postToLike.likes.includes(chat.name)) {
                                   postToLike.likes.push(chat.name);
                                   await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                   updateUnreadIndicator(unreadPostsCount + 1);
                                   if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                                      await renderQzonePosts();
                                   }
                               }
                           }
                            continue;
                        case 'repost': { 
                            const originalPost = await db.qzonePosts.get(parseInt(msgData.postId));
                            if (originalPost) {
                                const newPost = {
                                    type: 'repost',
                                    timestamp: Date.now(),
                                    authorId: chatId,
                                    authorGroupId: chat.groupId,
                                    repostComment: msgData.comment || '',
                                    originalPost: originalPost,
                                    visibleGroupIds: null
                                };
                                await db.qzonePosts.add(newPost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" è½‰ç™¼äº†å‹•æ…‹ #${msgData.postId}`);
                            }
                            continue;
                        }
                        case 'video_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                state.activeChatId = chatId;
                                videoCallState.activeChatId = chatId; 
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.isGroupCall = chat.isGroup;
                                videoCallState.callRequester = msgData.name || chat.name;
                                showIncomingCallModal();
                            }
                            continue;
                        case 'group_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                state.activeChatId = chatId;
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.isGroupCall = true;
                                videoCallState.initiator = 'ai';
                                videoCallState.callRequester = msgData.name;
                                showIncomingCallModal();
                            }
                            continue;
                        case 'pat_user':
                            let patterName;
                            if (chat.isGroup) {
                                const member = chat.members.find(m => m.originalName === msgData.name);
                                patterName = member ? member.groupNickname : msgData.name;
                            } else {
                                patterName = chat.name;
                            }
                            const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                            const patText = `${patterName} æ‹äº†æ‹æˆ‘${suffix}`;
        
                            const patMessage = { 
                                role: 'system', 
                                type: 'pat_message', 
                                content: patText, 
                                timestamp: Date.now() 
                            };
                            chat.history.push(patMessage);
                            if (isViewingThisChat) {
                                const phoneScreen = document.getElementById('phone-screen');
                                phoneScreen.classList.remove('pat-animation');
                                void phoneScreen.offsetWidth;
                                phoneScreen.classList.add('pat-animation');
                                setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                                appendMessage(patMessage, chat);
                            } else {
                                showNotification(chatId, patText);
                            }
                            continue; 
                        case 'update_status':
                            chat.status.text = msgData.status_text;
                            chat.status.isBusy = msgData.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            const statusUpdateMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[${chat.name}çš„ç‹€æ…‹å·²æ›´æ–°ç‚º: ${msgData.status_text}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(statusUpdateMessage);
                            if (isViewingThisChat) {
                                appendMessage(statusUpdateMessage, chat);
                            }
                            renderChatList(); 
                            continue; 
                        case 'location_share':
                            aiMessage = {
                                ...baseMessage,
                                type: 'location_share',
                                content: msgData.content
                            };
                            break;
                        case 'change_music':
                            if (musicState.isActive && musicState.activeChatId === chatId) {
                                const songNameFromAI = msgData.song_name || msgData.song || msgData.name;
        
                                if (typeof songNameFromAI === 'string' && songNameFromAI.trim()) {
                                    const songNameToFind = songNameFromAI.replace(/^\[?\d+\]?[\s.-]*/, '').trim();
                                    const targetSongIndex = musicState.playlist.findIndex(track => track.name.toLowerCase() === songNameToFind.toLowerCase());
                                    
                                    if (targetSongIndex > -1) {
                                        playSong(targetSongIndex);
                                        const track = musicState.playlist[targetSongIndex];
                                        
                                        let changerName;
                                        if (chat.isGroup) {
                                            const member = chat.members.find(m => m.originalName === msgData.name);
                                            changerName = member ? member.groupNickname : msgData.name;
                                        } else {
                                            changerName = chat.name;
                                        }
                                        
                                        const musicChangeMessage = {
                                            role: 'system',
                                            type: 'pat_message',
                                            content: `[â™ª ${changerName} ç‚ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                            timestamp: Date.now()
                                        };
                                        chat.history.push(musicChangeMessage);
                                        if (isViewingThisChat) {
                                            appendMessage(musicChangeMessage, chat);
                                        }
                                    } else {
                                        console.warn(`æ­Œæ›²æŸ¥æ‰¾å¤±æ•—: AIè«‹æ±‚çš„æ­Œæ›²å"${songNameFromAI}"(è™•ç†å¾Œç‚º"${songNameToFind}") åœ¨æ’­æ”¾æ¸…å–®ä¸­æœªæ‰¾åˆ°ã€‚`);
                                    }
                                } else {
                                    console.error("AIè¿”å›çš„change_musicæŒ‡ä»¤ä¸­ï¼Œæ­Œæ›²åç„¡æ•ˆæˆ–ç¼ºå¤±:", msgData);
                                }
                            }
                            continue;
                        case 'create_memory':
                            const newMemory = {
                                chatId: chatId,
                                authorId: chatId,
                                description: msgData.description,
                                timestamp: Date.now(),
                                type: 'ai_generated'
                            };
                            await db.memories.add(newMemory);
                            console.log(`AI "${chat.name}" è¨˜éŒ„äº†ä¸€æ¢æ–°å›æ†¶:`, msgData.description);
                            continue; 
                        case 'create_countdown':
                            const targetDate = new Date(msgData.date);
                            if (!isNaN(targetDate) && targetDate > new Date()) {
                                const newCountdown = {
                                    chatId: chatId,
                                    authorId: chatId,
                                    description: msgData.title,
                                    timestamp: Date.now(),
                                    type: 'countdown',
                                    targetDate: targetDate.getTime()
                                };
                                await db.memories.add(newCountdown);
                                console.log(`AI "${chat.name}" å‰µå»ºäº†ä¸€å€‹æ–°ç´„å®š:`, msgData.title);
                            }
                            continue;
                        case 'block_user':
                            if (!chat.isGroup) {
                                chat.relationship.status = 'blocked_by_ai';
                                const hiddenMessage = {
                                    role: 'system',
                                    content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›ä¸»å‹•æ‹‰é»‘äº†ç”¨æˆ¶ã€‚]`,
                                    timestamp: Date.now(),
                                    isHidden: true
                                };
                                chat.history.push(hiddenMessage);
                                await db.chats.put(chat);
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                }
                                renderChatList();
                                break; 
                            }
                            continue;
                        case 'friend_request_response':
                            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                                if (msgData.decision === 'accept') {
                                    chat.relationship.status = 'friend';
                                    aiMessage = { ...baseMessage, content: "æˆ‘é€šéäº†ä½ çš„å¥½å‹ç”³è«‹ï¼Œæˆ‘å€‘ç¾åœ¨æ˜¯å¥½å‹å•¦ï¼" };
                                } else {
                                    chat.relationship.status = 'blocked_by_ai';
                                    aiMessage = { ...baseMessage, content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’çµ•äº†ä½ çš„å¥½å‹ç”³è«‹ã€‚" };
                                }
                                chat.relationship.applicationReason = '';
                            }
                            break;
                        case 'poll':
                            const pollOptions = typeof msgData.options === 'string'
                                ? msgData.options.split('\n').filter(opt => opt.trim())
                                : (Array.isArray(msgData.options) ? msgData.options : []);
                            if (pollOptions.length < 2) continue;
                            aiMessage = {
                                ...baseMessage,
                                type: 'poll',
                                question: msgData.question,
                                options: pollOptions,
                                votes: {},
                                isClosed: false,
                            };
                            break;
case 'gift': {
    const { itemName, itemPrice, image_prompt } = msgData; // <--- å·²ä¿®æ­£ç‚º msgData
    // åŸºç¤é©—è­‰ï¼Œç¢ºä¿AIè¿”å›äº†å¿…è¦çš„è³‡è¨Š
    if (itemName && !isNaN(parseFloat(itemPrice)) && image_prompt) {
        // ä½¿ç”¨AIæä¾›çš„è‹±æ–‡é—œéµå­—ï¼Œé€šéåœ–åƒAPIå‹•æ…‹ç”Ÿæˆç¦®ç‰©åœ–ç‰‡
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(image_prompt)}`;

        aiMessage = {
            ...baseMessage,
            type: 'gift',
            items: [{
                name: itemName,
                price: parseFloat(itemPrice), // ç¢ºä¿æœ€çµ‚å­˜å…¥çš„æ˜¯æ•¸å­—
                imageUrl: imageUrl, // ä½¿ç”¨æ–°ç”Ÿæˆçš„åœ–ç‰‡URL
                quantity: 1 // AIå‰µé€ çš„ç¦®ç‰©æ•¸é‡ç¸½æ˜¯1
            }],
            total: parseFloat(itemPrice),
            recipients: msgData.recipients || null // <--- å·²ä¿®æ­£ç‚º msgData
        };
    } else {
        console.warn(`AI å˜—è©¦è´ˆé€ä¸€å€‹æ ¼å¼ä¸æ­£ç¢ºçš„éš¨æ©Ÿç¦®ç‰©:`, msgData); // <--- å·²ä¿®æ­£ç‚º msgData
    }
    break;
}
                        case 'vote':
                            const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                            if (pollToVote && !pollToVote.isClosed) {
                                Object.keys(pollToVote.votes).forEach(option => {
                                    const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                                    if (voterIndex > -1) {
                                        pollToVote.votes[option].splice(voterIndex, 1);
                                    }
                                });
                                if (!pollToVote.votes[msgData.choice]) {
                                    pollToVote.votes[msgData.choice] = [];
                                }
                                if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                                    pollToVote.votes[msgData.choice].push(msgData.name);
                                }                        
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                }
                            }
                            continue;
                        case 'red_packet':
                            aiMessage = {
                                ...baseMessage,
                                ...msgData,
                                totalAmount: msgData.amount, 
                                claimedBy: {}, 
                                isFullyClaimed: false
                            };
                            if (msgData.receiver) {
                                aiMessage.receiverName = msgData.receiver;
                                delete aiMessage.receiver;
                            }
                            break;
                        case 'open_red_packet':
                            const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
                            // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ å…¨æ–°çš„é©—è­‰é‚è¼¯ â–¼â–¼â–¼
const claimerOriginalName = msgData.name; // ç²å–å˜—è©¦æ¶ç´…åŒ…çš„è§’è‰²æœ¬å
const isMember = chat.members.some(member => member.originalName === claimerOriginalName);

// å¦‚æœé€™å€‹è§’è‰²ä¸æ˜¯ç•¶å‰ç¾¤çš„æˆå“¡ï¼Œå°±è¨˜éŒ„ä¸€å€‹è­¦å‘Šä¸¦ç›´æ¥è·³éï¼Œä¸å…è¨±ä»–æ¶
if (!isMember) {
    console.warn(`AI è§’è‰² "${claimerOriginalName}" å˜—è©¦é ˜å–ä¸å±¬æ–¼è‡ªå·±çš„ç¾¤èŠç´…åŒ…ã€‚æ“ä½œå·²è¢«æ””æˆªã€‚`);
    continue; // è·³éå¾ŒçºŒæ‰€æœ‰æ¶ç´…åŒ…çš„é‚è¼¯
}
// â–²â–²â–² é©—è­‰é‚è¼¯çµæŸ â–²â–²â–²
                            if (packetToOpen && packetToOpen.packetType === 'direct') {
                                if (packetToOpen.receiverName !== msgData.name) {
                                    console.warn(`AI è§’è‰² "${msgData.name}" å˜—è©¦é ˜å–ä¸å±¬æ–¼è‡ªå·±çš„å°ˆå±¬ç´…åŒ… (æ¥æ”¶äºº: ${packetToOpen.receiverName})ã€‚æ“ä½œå·²è¢«æ””æˆªã€‚`);
                                    continue;
                                }
                            }
                            
                            if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
                                let claimedAmountAI = 0;
                                const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                                const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                                if (remainingCount > 0) {
                                    if (packetToOpen.packetType === 'direct') {
                                        claimedAmountAI = packetToOpen.totalAmount;
                                    } else {
                                        if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
                                        else {
                                            const min = 0.01;
                                            const max = remainingAmount - (remainingCount - 1) * min;
                                            claimedAmountAI = Math.random() * (max - min) + min;
                                        }
                                    }
        
                                    claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                    if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                    packetToOpen.claimedBy[msgData.name] = claimedAmountAI;
        
// â–¼â–¼â–¼ é€™æ˜¯å…¨æ–°çš„ã€å·²ä¿®å¾©çš„ä»£ç¢¼ â–¼â–¼â–¼
const claimerMember = chat.members.find(m => m.originalName === msgData.name);
const claimerDisplayName = claimerMember ? claimerMember.groupNickname : msgData.name;

// â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šå¾ç´…åŒ…å°è±¡(packetToOpen)ä¸­ç²å–åŸå§‹å¯„ä»¶è€…çš„åå­— â˜…â˜…â˜…
const senderDisplayName = getDisplayNameInGroup(chat, packetToOpen.senderName);

const aiClaimedMessage = {
    role: 'system',
    type: 'pat_message',
    content: `${claimerDisplayName} é ˜å–äº† ${senderDisplayName} çš„ç´…åŒ…`, // ç¾åœ¨å¯ä»¥æ­£ç¢ºé¡¯ç¤º "Aé ˜å–äº†Bçš„ç´…åŒ…"
    timestamp: Date.now()
};
chat.history.push(aiClaimedMessage);
// â–²â–²â–² ä¿®å¾©ä»£ç¢¼çµæŸ â–²â–²â–²
                                    let hiddenContentForAI = `[ç³»çµ±æç¤ºï¼šä½  (${claimerDisplayName}) æˆåŠŸæ¶åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`;
                                    if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                        packetToOpen.isFullyClaimed = true;
                                        const finishedMessage = {
                                            role: 'system',
                                            type: 'pat_message',
                                            content: `${senderDisplayName} çš„ç´…åŒ…å·²è¢«é ˜å®Œ`,
                                            timestamp: Date.now() + 1
                                        };
                                        chat.history.push(finishedMessage);
                                        let luckyKing = { name: '', amount: -1 };
                                        if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                                            Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                                                if (amount > luckyKing.amount) {
                                                    luckyKing = { name, amount };
                                                }
                                            });
                                        }
                                        if (luckyKing.name) {
                                             const luckyKingMember = chat.members.find(m => m.originalName === luckyKing.name);
                                             const luckyKingDisplayName = luckyKingMember ? luckyKingMember.groupNickname : luckyKing.name;
                                             hiddenContentForAI += ` ç´…åŒ…å·²è¢«é ˜å®Œï¼Œæ‰‹æ°£ç‹æ˜¯ ${luckyKingDisplayName}ï¼`;
                                        } else {
                                             hiddenContentForAI += ` ç´…åŒ…å·²è¢«é ˜å®Œã€‚`;
                                        }
                                    }
                                    hiddenContentForAI += ' è«‹æ ¹æ“šé€™å€‹çµæœç™¼è¡¨ä½ çš„è©•è«–ã€‚]';
                                    const hiddenMessageForAI = {
                                        role: 'system',
                                        content: hiddenContentForAI,
                                        timestamp: Date.now() + 2,
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMessageForAI);
                                }
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                    renderChatList(); 
                                }
                            }
                            continue;
        
                        case 'accept_transfer': {
                            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (originalTransferMsgIndex > -1) {
                                const originalMsg = chat.history[originalTransferMsgIndex];
                                originalMsg.status = 'accepted';
                            }
                            continue;
                        }
        
                        case 'decline_transfer': {
                            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (originalTransferMsgIndex > -1) {
                                const originalMsg = chat.history[originalTransferMsgIndex];
                                originalMsg.status = 'declined';
                                const refundMessage = {
                                    role: 'assistant',
                                    senderName: chat.name,
                                    type: 'transfer',
                                    isRefund: true,
                                    amount: originalMsg.amount,
                                    note: 'è½‰å¸³å·²è¢«æ‹’æ”¶',
                                    timestamp: messageTimestamp++
                                };
                                chat.history.push(refundMessage);
                                if (isViewingThisChat) {
                                    appendMessage(refundMessage, chat); 
                                    renderChatInterface(chatId); 
                                }
                            }
                            continue;
                        }
                        case 'change_group_name':
                            if (chat.isGroup && msgData.new_name) {
                                const newName = msgData.new_name.trim();
                                const memberNames = chat.members.map(m => m.originalName);
        
                                if (memberNames.includes(newName)) {
                                    console.warn(`AI (${msgData.name}) è©¦åœ–å°‡ç¾¤åæ›´æ”¹ç‚ºæˆå“¡å ("${newName}")ã€‚æ“ä½œå·²è¢«ç¨‹å¼é˜»æ­¢ã€‚`);
                                    continue; 
                                }
        
                                chat.name = newName; 
        
                                const changerMember = chat.members.find(m => m.originalName === msgData.name);
                                const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;
                                
                                const systemMessage = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `${changerDisplayName} å°‡ç¾¤åä¿®æ”¹ç‚º â€œ${chat.name}â€`,
                                    timestamp: messageTimestamp++
                                };
                                chat.history.push(systemMessage);
        
                                if (isViewingThisChat) {
                                    appendMessage(systemMessage, chat);
                                    document.getElementById('chat-header-title').textContent = chat.name;
                                }
                            }
                            continue;
                        case 'change_remark_name':
                            if (!chat.isGroup && msgData.new_name) {
                                const oldName = chat.name; 
                                const newName = msgData.new_name.trim();
        
                                if (newName && newName !== oldName) {
                                    if (!chat.nameHistory) {
                                        chat.nameHistory = [];
                                    }
                                    if (!chat.nameHistory.includes(oldName)) {
                                        chat.nameHistory.push(oldName);
                                    }
                                    
                                    chat.name = newName; 
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message', 
                                        content: `â€œ${chat.originalName}â€ å°‡å‚™è¨»ä¿®æ”¹ç‚º â€œ${newName}â€`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›æˆåŠŸå°‡è‡ªå·±çš„å‚™è¨»åä¿®æ”¹ç‚ºäº†â€œ${newName}â€ã€‚è«‹è‡ªç„¶åœ°æ¥å—é€™å€‹æ–°åå­—ï¼Œä¸è¦å°æ­¤æ„Ÿåˆ°é©šè¨ã€‚]`,
                                        timestamp: messageTimestamp++, 
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                        document.getElementById('chat-header-title').textContent = newName;
                                    }
                                    
                                    await syncCharacterNameInGroups(chat); 
                                }
                            }
                            continue;
        
                        case 'change_group_avatar':
                            if (chat.isGroup && msgData.avatar_name) {
                                const avatarName = msgData.avatar_name;
                                const library = chat.settings.groupAvatarLibrary || [];
                                const foundAvatar = library.find(avatar => avatar.name === avatarName);
        
                                if (foundAvatar) {
                                    chat.settings.groupAvatar = foundAvatar.url;
                                    
                                    const changerMember = chat.members.find(m => m.originalName === msgData.name);
                                    const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${changerDisplayName} æ›´æ›äº†ç¾¤é ­åƒ`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                    }
                                } else {
                                    console.warn(`AI å˜—è©¦ä½¿ç”¨ä¸€å€‹ä¸å­˜åœ¨çš„ç¾¤é ­åƒ: "${avatarName}"`);
                                }
                            }
                            continue;
                        case 'system_message':
                            aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
                            break;
                        case 'share_link':
                            aiMessage = { 
                                ...baseMessage, 
                                type: 'share_link',
                                title: msgData.title,
                                description: msgData.description,
                                source_name: msgData.source_name,
                                content: msgData.content
                            };
                            break;
                        case 'quote_reply':
                            const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                            if (originalMessage) {
                                const quoteContext = {
                                    timestamp: originalMessage.timestamp,
                                    senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
                                    content: String(originalMessage.content || '').substring(0, 50),
                                };
                                aiMessage = { 
                                    ...baseMessage, 
                                    content: msgData.reply_content,
                                    quote: quoteContext
                                };
                            } else {
                                aiMessage = { ...baseMessage, content: msgData.reply_content };
                            }
                            break;
                        case 'send_and_recall': {
                            if (!isViewingThisChat) continue;
                            const tempMessageData = { ...baseMessage, content: msgData.content };
                            const tempMessageElement = createMessageElement(tempMessageData, chat);
                            appendMessage(tempMessageData, chat, true);
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
                            const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
                            if (bubbleWrapper) {
                                bubbleWrapper.classList.add('recalled-animation');
                                await new Promise(resolve => setTimeout(resolve, 300));
                                const recalledMessage = {
                                    role: 'assistant',
                                    senderName: msgData.name || chat.name,
                                    type: 'recalled_message',
                                    content: 'å°æ–¹æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯',
                                    timestamp: tempMessageData.timestamp,
                                    recalledData: { originalType: 'text', originalContent: msgData.content }
                                };
                                const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
                                if (msgIndex > -1) {
                                    chat.history[msgIndex] = recalledMessage;
                                } else {
                                    chat.history.push(recalledMessage);
                                }
                                const placeholder = await createMessageElement(recalledMessage, chat);
                                if(document.body.contains(bubbleWrapper)) {
                                    bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
                                }
                            }
                            continue;
                        }
                        
                        case 'text':
                            aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                            break;
                        case 'sticker':
                            aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                            break;
                        case 'ai_image':
                            aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description, image_prompt: msgData.image_prompt };
                            break;
                        case 'voice_message':
                            aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                            break;
                        case 'transfer':
                            aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                            break;
                        
                        case 'waimai_request':
                            aiMessage = { 
                                ...baseMessage, 
                                type: 'waimai_request',
                                productInfo: msgData.productInfo,
                                amount: msgData.amount,
                                status: 'pending',
                                countdownEndTime: Date.now() + 15 * 60 * 1000,
                            };
                            break;
                case 'waimai_order':
                    aiMessage = {
                        ...baseMessage,
                        type: 'waimai_order',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        greeting: msgData.greeting,
                        recipientName: msgData.recipientName || null // å¦‚æœæ˜¯ç¾¤èŠï¼Œè¨˜éŒ„æ¥æ”¶è€…
                    };
                    break;
                        case 'offline_text':
        aiMessage = { ...baseMessage, ...msgData };
                        default:
                             console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤é¡å‹:", msgData.type);
                             break;
                    }
        
                    if (aiMessage) {
                        chat.history.push(aiMessage);
                        if (!isViewingThisChat && !notificationShown) {
                            let notificationText;
                            switch (aiMessage.type) {
                                case 'transfer': notificationText = `[æ”¶åˆ°ä¸€ç­†è½‰å¸³]`; break;
                                case 'waimai_request': notificationText = `[æ”¶åˆ°ä¸€å€‹å¤–è³£ä»£ä»˜è«‹æ±‚]`; break;
                                case 'ai_image': notificationText = `[åœ–ç‰‡]`; break;
                                case 'voice_message': notificationText = `[èªéŸ³]`; break;
                                case 'sticker': notificationText = aiMessage.meaning ? `[è¡¨æƒ…: ${aiMessage.meaning}]` : '[è¡¨æƒ…]'; break;
                                case 'offline_text': notificationText = aiMessage.dialogue ? `ã€Œ${aiMessage.dialogue}ã€` : `[${aiMessage.description.substring(0, 20)}...]`; break;
                                default: notificationText = String(aiMessage.content || '');
                            }
                            const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                            showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                            notificationShown = true;
                        }
        
                        if (!isViewingThisChat) {
                            chat.unreadCount = (chat.unreadCount || 0) + 1;
                        }
                        
                        if (isViewingThisChat) {
                            appendMessage(aiMessage, chat);
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                        }
                    }
                }        
        
                if (callHasBeenHandled && videoCallState.isGroupCall) {
                    videoCallState.isAwaitingResponse = false;
                    if (videoCallState.participants.length > 0) {
                        startVideoCall();
                    } else {
                        videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                        showScreen('chat-interface-screen');
                        alert('ç„¡äººæ¥è½ç¾¤èŠé‚€è«‹ã€‚');
                    }
                }
                if (needsImmediateReaction) {
                    await triggerAiResponse();
                    return; 
                }
                await db.chats.put(chat);
        // æª¢æŸ¥å‰›å‰›AIåŸ·è¡Œçš„å‹•ä½œä¸­ï¼Œæ˜¯å¦åŒ…å«äº†ä»»ä½•èˆ‡â€œå‹•æ…‹â€ç›¸é—œçš„æ“ä½œ
const qzoneActionTaken = messagesArray.some(action =>
    action.type === 'qzone_post' ||
    action.type === 'qzone_like' ||
    action.type === 'qzone_comment' ||
    action.type === 'repost'
);

// å¦‚æœAIç¢ºå¯¦åŸ·è¡Œäº†å‹•æ…‹ç›¸é—œçš„æ“ä½œ
if (qzoneActionTaken) {
    console.log("æª¢æ¸¬åˆ°AIåŸ·è¡Œäº†å‹•æ…‹æ“ä½œï¼Œç«‹å³åˆ·æ–°å¥½å‹å‹•æ…‹é é¢ã€‚");
    // ä¸»å‹•èª¿ç”¨æ¸²æŸ“å‡½æ•¸ï¼Œå¼·åˆ¶åˆ·æ–°é é¢å…§å®¹
    await renderQzonePosts();
}

// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
            } catch (error) {
                
                chat.history = chat.history.filter(msg => !msg.isTemporary);
                
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    chat.relationship.status = 'blocked_by_ai';
                    await showCustomAlert('ç”³è«‹å¤±æ•—', `AIåœ¨è™•ç†ä½ çš„å¥½å‹ç”³è«‹æ™‚å‡ºéŒ¯äº†ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚\néŒ¯èª¤è³‡è¨Š: ${error.message}`);
                } else {
                    await showCustomAlert(
                        'API èª¿ç”¨å¤±æ•—', 
                        `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ï¼ŒAIæœªèƒ½æˆåŠŸéŸ¿æ‡‰ã€‚\n\néŒ¯èª¤è©³æƒ…:\n${error.message}`
                    );
                }
                
                if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                     await db.chats.put(chat);        
                }
               
                videoCallState.isAwaitingResponse = false;
            } finally {
                setAvatarActingState(chatId, false);
        
               
                if (chat.isGroup) {
                    if (typingIndicator) {
                        typingIndicator.style.display = 'none';
                    }
                } else {
                    if (chatHeaderTitle && state.chats[chatId]) {
                        chatHeaderTitle.style.opacity = 0;
                        setTimeout(() => {
                            chatHeaderTitle.textContent = state.chats[chatId].name;
                            chatHeaderTitle.classList.remove('typing-status');
                            chatHeaderTitle.style.opacity = 1;
                        }, 200);
                    }
                }
                renderChatList();
                if (isViewingThisChat) {
                    checkAndTriggerAutoSummary(chatId);
                 
                }
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        
        
        
        
        
        
                async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
        
                async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 999999) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ (0 åˆ° 999999 ä¹‹é–“)ï¼'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

/**
 * ã€å…¨æ–° V2.0 | AIèªçŸ¥ä¿®å¾©ç‰ˆã€‘è™•ç†ç”¨æˆ¶é»æ“Šâ€œç‚ºTAé»å¤–è³£â€çš„é‚è¼¯
 */
async function sendWaimaiOrderForAI() {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo || isNaN(amount) || amount <= 0) {
        alert('è«‹å¡«å¯«æœ‰æ•ˆçš„å•†å“è³‡è¨Šå’Œé‡‘é¡ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    // 1. å‰µå»ºå°ç”¨æˆ¶å¯è¦‹çš„â€œå·²ä¸‹å–®â€å¡ç‰‡æ¶ˆæ¯ï¼ˆé€™éƒ¨åˆ†ä¿æŒä¸è®Šï¼‰
    const visibleMessage = {
        role: 'user',
        senderName: myNickname, 
        type: 'waimai_order',
        productInfo: productInfo,
        amount: amount,
        timestamp: now
    };
    chat.history.push(visibleMessage);

    // 2. ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—çš„ã€èªç¾©æ›´æ¸…æ™°çš„ç³»çµ±æ¶ˆæ¯ï¼Œæ˜ç¢ºå‘ŠçŸ¥AIé€™æ˜¯ä¸€å€‹â€œç¦®ç‰©â€
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶(${myNickname})ç‚ºä½ é»äº†ä¸€ä»½å¤–è³£ä½œç‚ºã€ç¦®ç‰©ã€‘ã€‚å¤–è³£å…§å®¹æ˜¯â€œ${productInfo}â€ï¼Œåƒ¹å€¼${amount}å…ƒã€‚é€™ä¸æ˜¯ä¸€å€‹ä»£ä»˜è«‹æ±‚ï¼Œè€Œæ˜¯ç”¨æˆ¶å·²ç¶“ç‚ºä½ æ”¯ä»˜äº†ã€‚è«‹ä½ å°æ­¤è¡¨ç¤ºæ„Ÿè¬ã€‚]`,
        timestamp: now + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 3. ä¿å­˜è³‡æ–™ï¼Œæ›´æ–°UI
    await db.chats.put(chat);
    appendMessage(visibleMessage, chat);
    renderChatList();

    // 4. æ¸…ç†ä¸¦é—œé–‰å½ˆçª—
    productInfoInput.value = '';
    amountInput.value = '';
    document.getElementById('waimai-request-modal').classList.remove('visible');

    // 5. ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ç§»é™¤æ­¤è™•çš„ triggerAiResponse() èª¿ç”¨ï¼Œä¸å†ç«‹åˆ»é€šçŸ¥AI
    // triggerAiResponse(); // <--- ç¢ºä¿é€™ä¸€è¡Œå·²è¢«åˆªé™¤æˆ–æ³¨é‡‹æ‰ï¼
}
        /**
         * ã€å…¨æ–° V3.0ã€‘ç™¼é€ä¸€å€‹ä½ç½®å…±ç”¨å¡ç‰‡ (èƒŒæ™¯åœ–å·²å…§ç½®)
         */
        async function sendLocationShare() {
            if (!state.activeChatId) return;
        
            // æ­¥é©Ÿ1: è©¢å•ä½ç½®åç¨± (é€™éƒ¨åˆ†ä¿æŒä¸è®Š)
            const locationName = await showCustomPrompt("å…±ç”¨ä½ç½®", "ä½ ç¾åœ¨åœ¨å“ªè£¡å‘€ï¼Ÿ", "");
        
            // å¦‚æœç”¨æˆ¶å–æ¶ˆæˆ–æ²’æœ‰è¼¸å…¥ä½ç½®ï¼Œå‰‡ç›´æ¥é€€å‡º
            if (!locationName || !locationName.trim()) return; 
        
            // æ­¥é©Ÿ2: ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡ç›´æ¥å®šç¾©å¥½æ‚¨æƒ³ç”¨çš„åœ–ç‰‡URL
            // æ‚¨å¯ä»¥éš¨æ™‚å°‡é€™å€‹é€£çµæ›¿æ›ç‚ºæ‚¨å–œæ­¡çš„ä»»ä½•åœ–ç‰‡ä½å€
            const hardcodedImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';
        
            const chat = state.chats[state.activeChatId];
            
            // æ­¥é©Ÿ3: æ§‹å»ºæ¶ˆæ¯ç‰©ä»¶ï¼Œç›´æ¥ä½¿ç”¨æˆ‘å€‘å®šç¾©å¥½çš„åœ–ç‰‡URL
            const msg = {
                role: 'user',
                type: 'location_share',
                content: locationName.trim(),
                imageUrl: hardcodedImageUrl, // ç›´æ¥ä½¿ç”¨ä¸Šé¢å®šç¾©çš„URL
                timestamp: Date.now()
            };
            
            // æ­¥é©Ÿ4: ä¿å­˜ä¸¦æ›´æ–°UI (é€™éƒ¨åˆ†ä¿æŒä¸è®Š)
            chat.history.push(msg);
            await db.chats.put(chat);
            appendMessage(msg, chat);
            renderChatList();
        }
        
        
                function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        
                function exitSelectionMode() {
            cleanupWaimaiTimers(); // <--- åœ¨é€™è£¡æ·»åŠ é€™è¡Œä»£ç¢¼
         if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æœ€çµ‚ç°¡åŒ–ç‰ˆã€‘æ›¿æ›èˆŠçš„ toggleMessageSelection å‡½æ•¸ â–¼â–¼â–¼
        function toggleMessageSelection(timestamp) {
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘é¸æ“‡å™¨å·²ç°¡åŒ–ï¼Œä¸å†å°‹æ‰¾å·²åˆªé™¤çš„ .recalled-message-placeholder
            const elementToSelect = document.querySelector(
                `.message-bubble[data-timestamp="${timestamp}"]`
            );
        
            if (!elementToSelect) return;
        
            if (selectedMessages.has(timestamp)) {
                selectedMessages.delete(timestamp);
                elementToSelect.classList.remove('selected');
            } else {
                selectedMessages.add(timestamp);
                elementToSelect.classList.add('selected');
            }
            
            document.getElementById('selection-count').textContent = `å·²é¸ ${selectedMessages.size} æ¢`;
            
            if (selectedMessages.size === 0) {
                exitSelectionMode();
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        
                async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'ç•¶å‰'; const confirmed = await showCustomConfirm('åˆ‡æ›è½æ­Œå°è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€è½æ­Œã€‚è¦çµæŸä¸¦é–‹å§‹å’Œã€Œ${newChatName}ã€çš„æ–°æœƒè©±å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    document.getElementById('global-lyrics-bar').classList.remove('visible');
    const cleanupLogic = async () => {
        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation();
}

function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
window.updateListenTogetherIconProxy = updateListenTogetherIcon;

function updatePlayerUI() { 
    updateListenTogetherIcon(musicState.activeChatId); 
    updateElapsedTimeDisplay(); 
    const titleEl = document.getElementById('music-player-song-title'); 
    const artistEl = document.getElementById('music-player-artist'); 
    const playPauseBtn = document.getElementById('music-play-pause-btn'); 
    if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { 
        const track = musicState.playlist[musicState.currentIndex]; 
        titleEl.textContent = track.name; 
        artistEl.textContent = track.artist; 
    } else { 
        titleEl.textContent = 'è«‹æ·»åŠ æ­Œæ›²'; 
        artistEl.textContent = '...'; 
    } 
    playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; 
}

function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç¶“ä¸€èµ·è½äº†${hours}å°æ™‚`; }

function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾æ¸…å–®æ˜¯ç©ºçš„~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼
item.innerHTML = `
    <div class="playlist-item-info">
        <div class="title">${track.name}</div>
        <div class="artist">${track.artist}</div>
    </div>
    <div class="playlist-item-actions">
        <span class="playlist-action-btn album-art-btn" data-index="${index}">å°ˆè¼¯</span>
        <span class="playlist-action-btn lyrics-btn" data-index="${index}">è©</span>
        <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨é€™è£¡æ·»åŠ â€œèƒŒæ™¯â€æŒ‰éˆ• -->
        <span class="playlist-action-btn bg-btn" data-index="${index}">èƒŒæ™¯</span>
        <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
    </div>
`;
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}



async function togglePlayPause() {
    if (audioPlayer.paused) {
        if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
            playSong(0);
        } 
        else if (musicState.currentIndex > -1) {
            playSong(musicState.currentIndex);
        }
    } else {
        audioPlayer.pause();
        await addMusicActionSystemMessage('æš«åœäº†éŸ³æ¨‚');
    }
}

function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é †åº', 'random': 'éš¨æ©Ÿ', 'single': 'å–®æ›²'}[musicState.playMode]; }

async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç¶²è·¯æ­Œæ›²", "è«‹è¼¸å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }
 
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²ä¿®å¾©çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ addSongFromLocal å‡½æ•¸ â–¼â–¼â–¼
async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œå", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
        if (artist === null) continue;

        // ã€æ ¸å¿ƒä¿®å¾©1ã€‘è®€å–æª”ç‚º ArrayBufferï¼Œé€™æ˜¯æœ€å¯é çš„å­˜å„²æ–¹å¼
        const arrayBuffer = await file.arrayBuffer();

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("å°å…¥æ­Œè©", `è¦ç‚ºã€Š${name}ã€‹æ·»åŠ æ­Œè©å—ï¼Ÿ`);
        if (wantLrc) {
            lrcContent = await getLrcContent() || "";
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: arrayBuffer,           // ã€æ ¸å¿ƒä¿®å¾©2ã€‘å­˜å„² ArrayBuffer è€Œä¸æ˜¯ File ç‰©ä»¶
            fileType: file.type,        // ã€æ ¸å¿ƒä¿®å¾©3ã€‘åŒæ™‚å­˜å„²æª”çš„MIMEé¡å‹
            isLocal: true,
            lrcContent: lrcContent,
            cover: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg'
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
    }
    event.target.value = null;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²ä¿®å¾©çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ playSong å‡½æ•¸ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²æ”¯æ´é ­åƒé¡¯ç¤ºä¸¦ä¿®å¾©æ¸²æŸ“å•é¡Œçš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ playSong å‡½æ•¸ â–¼â–¼â–¼
async function playSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;

    audioPlayer.pause();

    musicState.currentIndex = index;
    const track = musicState.playlist[index];
    const chat = state.chats[musicState.activeChatId]; // ç²å–ç•¶å‰èŠå¤©ç‰©ä»¶

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šè¼‰å…¥ä¸¦å¡«å……é ­åƒ (ä½¿ç”¨æ›´å¯é çš„DOMæ“ä½œ) â–¼â–¼â–¼ ---
    const avatarDisplay = document.getElementById('music-player-avatar-display');
    if (chat && avatarDisplay) {
        // 1. æ¸…ç©ºèˆŠå…§å®¹
        avatarDisplay.innerHTML = '';

        // 2. æ ¹æ“šèŠå¤©é¡å‹ç²å–æ­£ç¢ºçš„é ­åƒURL
        const charAvatarUrl = chat.isGroup 
            ? (chat.members.find(m => m.originalName === track.artist)?.avatar || defaultAvatar) 
            : (chat.settings.aiAvatar || defaultAvatar);
        const userAvatarUrl = chat.settings.myAvatar || defaultAvatar;

        // 3. å‰µå»ºè§’è‰²é ­åƒå…ƒç´ ä¸¦æ·»åŠ 
        const charAvatarEl = document.createElement('img');
        charAvatarEl.src = charAvatarUrl;
        charAvatarEl.className = 'participant-display-avatar';
        charAvatarEl.alt = 'Character Avatar';
        avatarDisplay.appendChild(charAvatarEl);

        // 4. å‰µå»ºä½¿ç”¨è€…é ­åƒå…ƒç´ ä¸¦æ·»åŠ 
        const userAvatarEl = document.createElement('img');
        userAvatarEl.src = userAvatarUrl;
        userAvatarEl.className = 'participant-display-avatar';
        userAvatarEl.alt = 'User Avatar';
        avatarDisplay.appendChild(userAvatarEl);
    }
    // --- â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–² ---

    const playerWindow = document.querySelector('.music-player-window');
    const toggleBtn = document.getElementById('toggle-blur-btn');

    if (playerWindow) {
        playerWindow.style.setProperty('--music-bg-image', track.background ? `url(${track.background})` : 'none');
        playerWindow.classList.toggle('bg-clear', !!track.isBgClear);
    }
    if (toggleBtn) {
        toggleBtn.classList.toggle('active', !!track.isBgClear);
    }
    
    // (å¾ŒçºŒçš„æ‰€æœ‰æ’­æ”¾é‚è¼¯ä¿æŒä¸è®Š)
    document.getElementById('music-visual-container').classList.remove('lyrics-active');
    const coverEl = document.getElementById('music-player-cover');
    if (coverEl) {
        coverEl.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
    }
    
    await addMusicActionSystemMessage(`å°‡æ­Œæ›²åˆ‡æ›ç‚ºäº†ã€Š${track.name}ã€‹`);
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    
    renderLyrics(); 
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
        if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
            singleLyricEl.textContent = 'ç´”éŸ³æ¨‚ï¼Œè«‹æ¬£è³';
        } else {
            singleLyricEl.textContent = 'â™ª â™ª â™ª'; 
        }
    }
    
    if (track.isLocal && track.src instanceof ArrayBuffer) {
        const blob = new Blob([track.src], { type: track.fileType || 'audio/mpeg' });
        audioPlayer.src = URL.createObjectURL(blob);
    } 
    else if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('æœ¬åœ°æ­Œæ›²æºéŒ¯èª¤:', track);
        return;
    }
    
    const playPromise = audioPlayer.play();
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            if (error.name === 'NotAllowedError') {
                console.warn('Autoplay was prevented by the browser.');
                audioPlayer.pause();
                showCustomAlert("æ’­æ”¾å·²æš«åœ", "ç”±æ–¼æµè¦½å™¨å®‰å…¨é™åˆ¶ï¼ŒAIåˆ‡æ›çš„æ­Œæ›²ç„¡æ³•è‡ªå‹•æ’­æ”¾ã€‚è«‹æ‰‹å‹•é»æ“Šæ’­æ”¾æŒ‰éˆ• â–¶ ç¹¼çºŒæ¬£è³ã€‚");
            } else if (error.name !== 'AbortError') {
                console.error('Playback error:', error);
            }
        });
    }
    updatePlaylistUI();
    updatePlayerUI();
    updateMusicProgressBar();
    
    const lyricBar = document.getElementById('global-lyrics-bar');
    if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
        lyricBar.textContent = 'â™ª';
        lyricBar.classList.add('visible');
    } else {
        lyricBar.classList.remove('visible');
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * è™•ç†æ›´æ›æŒ‡å®šæ­Œæ›²èƒŒæ™¯åœ–ç‰‡çš„é‚è¼¯
 * @param {number} trackIndex - æ’­æ”¾æ¸…å–®ä¸­æ­Œæ›²çš„ç´¢å¼•
 */
async function handleChangeBackground(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    // 1. å½ˆå‡ºé¸é …ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡ä¸Šå‚³æ–¹å¼
    const choice = await showChoiceModal("æ›´æ›æ­Œæ›²èƒŒæ™¯", [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    let newBackgroundUrl = null;

    // 2. æ ¹æ“šé¸æ“‡ç²å–åœ–ç‰‡
    if (choice === 'local') {
        newBackgroundUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        newBackgroundUrl = await showCustomPrompt("è¼¸å…¥åœ–ç‰‡URL", "è«‹è¼¸å…¥æ–°çš„èƒŒæ™¯åœ–ç‰‡é€£çµ", "", "url");
    }

    // 3. å¦‚æœæˆåŠŸç²å–åˆ°åœ–ç‰‡ï¼Œå‰‡æ›´æ–°ä¸¦ä¿å­˜
    if (newBackgroundUrl && newBackgroundUrl.trim()) {
        musicState.playlist[trackIndex].background = newBackgroundUrl.trim();
        await saveGlobalPlaylist();
        
        // 4. å¦‚æœæ­£åœ¨æ’­æ”¾çš„å°±æ˜¯é€™é¦–æ­Œï¼Œå‰‡ç«‹å³æ‡‰ç”¨æ–°èƒŒæ™¯
        if (musicState.currentIndex === trackIndex) {
            const playerWindow = document.querySelector('.music-player-window');
            playerWindow.style.setProperty('--music-bg-image', `url(${newBackgroundUrl.trim()})`);
        }

        await showCustomAlert("æˆåŠŸ", "æ­Œæ›²èƒŒæ™¯å·²æ›´æ–°ï¼");
    }
}
/**
 * ã€å…¨æ–°ã€‘è™•ç†æ›´æ›å°ˆè¼¯å°é¢çš„é‚è¼¯
 * @param {number} trackIndex - æ’­æ”¾æ¸…å–®ä¸­æ­Œæ›²çš„ç´¢å¼•
 */
async function handleChangeAlbumArt(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal("æ›´æ›å°ˆè¼¯å°é¢", [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    let newCoverUrl = null;

    if (choice === 'local') {
        newCoverUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        newCoverUrl = await showCustomPrompt("è¼¸å…¥åœ–ç‰‡URL", "è«‹è¼¸å…¥æ–°çš„å°é¢åœ–ç‰‡é€£çµ", "", "url");
    }

    if (newCoverUrl && newCoverUrl.trim()) {
        musicState.playlist[trackIndex].cover = newCoverUrl.trim();
        await saveGlobalPlaylist();
        
        // å¦‚æœæ­£åœ¨æ’­æ”¾çš„æ­Œæ›²å°±æ˜¯è¢«ä¿®æ”¹çš„é€™é¦–ï¼Œç«‹å³æ›´æ–°æ’­æ”¾æ©ŸUI
        if (musicState.currentIndex === trackIndex) {
            document.getElementById('music-player-cover').src = newCoverUrl.trim();
            // åŒæ™‚æ›´æ–°é»‘è† å”±ç‰‡ä¸­å¿ƒçš„åœ–ç‰‡
            const vinylCover = document.querySelector('#vinyl-view #music-player-cover');
            if(vinylCover) vinylCover.src = newCoverUrl.trim();
        }

        await showCustomAlert("æˆåŠŸ", "å°ˆè¼¯å°é¢å·²æ›´æ–°ï¼");
    }
}

async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ addSongFromLocal å‡½æ•¸ â–¼â–¼â–¼
        
        async function addSongFromLocal(event) {
            const files = event.target.files;
            if (!files.length) return;
        
            for (const file of files) {
                let name = file.name.replace(/\.[^/.]+$/, "");
                name = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œå", name);
                if (name === null) continue;
                
                const artist = await showCustomPrompt("æ­Œæ›²è³‡è¨Š", "è«‹è¼¸å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
                if (artist === null) continue;
        
                let lrcContent = "";
                const wantLrc = await showCustomConfirm("å°å…¥æ­Œè©", `è¦ç‚ºã€Š${name}ã€‹æ·»åŠ æ­Œè©å—ï¼Ÿ`);
                if (wantLrc) {
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç›´æ¥èª¿ç”¨æˆ‘å€‘æ–°çš„çµ±ä¸€å‡½æ•¸ï¼
                    lrcContent = await getLrcContent() || ""; // å¦‚æœç”¨æˆ¶å–æ¶ˆï¼Œå‰‡lrcContentç‚º""
                }
                
                musicState.playlist.push({ 
                    name, 
                    artist, 
                    src: file, 
                    isLocal: true,
                    lrcContent: lrcContent
                });
            }
            
            await saveGlobalPlaylist();
            updatePlaylistUI();
            if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
                musicState.currentIndex = 0;
                updatePlayerUI();
            }
            event.target.value = null;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        
                const personaLibraryModal = document.getElementById('persona-library-modal');
                const personaEditorModal = document.getElementById('persona-editor-modal');
                const presetActionsModal = document.getElementById('preset-actions-modal');
        
                function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        
                function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        
                function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ é»æ“Šå³ä¸Šè§’"æ·»åŠ "ä¾†å‰µå»ºä½ çš„ç¬¬ä¸€å€‹äººè¨­é è¨­å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        
                function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        
                function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        
                function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        
                function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè¨­é è¨­'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        
                function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç·¨è¼¯äººè¨­é è¨­'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        
                async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹äººè¨­é è¨­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        
                function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        
                async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("é ­åƒå’Œäººè¨­ä¸èƒ½éƒ½ç‚ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }
        
                const batteryAlertModal = document.getElementById('battery-alert-modal');
        
                function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        
                function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        
                function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰é»é¤“äº†ï¼Œå¯ä»¥å»æ‰¾å……é›»å™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'è¶•ç·Šçš„å……é›»ï¼Œè¦é¤“æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é™£äº¡ï¼Œé‚„æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        
                async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çª©æ„›æ³¥ï¼Œé›»é‡åƒé£½é£½'); } }); } catch (err) { console.error("ç„¡æ³•ç²å–é›»æ± è³‡è¨Š:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè¦½å™¨ä¸æ”¯æ´é›»æ± ç‹€æ…‹APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }
        
                async function renderAlbumList() {
                    const albumGrid = document.getElementById('album-grid-page');
                    if (!albumGrid) return;
                    const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
                    albumGrid.innerHTML = '';
                    if (albums.length === 0) {
                        albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ é‚„æ²’æœ‰å‰µå»ºä»»ä½•ç›¸å†Šå“¦~</p>';
                        return;
                    }
                    albums.forEach(album => {
                        const albumItem = document.createElement('div');
                        albumItem.className = 'album-item';
                        albumItem.innerHTML = `
                            <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                            <div class="album-info">
                                <p class="album-name">${album.name}</p>
                                <p class="album-count">${album.photoCount || 0} å¼µ</p>
                            </div>
                        `;
                        albumItem.addEventListener('click', () => {
                            openAlbum(album.id);
                        });
        
                        // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç¢¼å°±æ˜¯é€™è£¡ â–¼â–¼â–¼
                        addLongPressListener(albumItem, async () => {
                            const confirmed = await showCustomConfirm(
                                'åˆªé™¤ç›¸å†Š',
                                `ç¢ºå®šè¦åˆªé™¤ç›¸å†Šã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤ç›¸å†Šå…§çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”ç„¡æ³•æ¢å¾©ã€‚`,
                                { confirmButtonClass: 'btn-danger' }
                            );
        
                            if (confirmed) {
                                // 1. å¾ç…§ç‰‡è¡¨ä¸­åˆªé™¤è©²ç›¸å†Šä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                                await db.qzonePhotos.where('albumId').equals(album.id).delete();
                                
                                // 2. å¾ç›¸å†Šè¡¨ä¸­åˆªé™¤è©²ç›¸å†Šæœ¬èº«
                                await db.qzoneAlbums.delete(album.id);
                                
                                // 3. é‡æ–°æ¸²æŸ“ç›¸ç°¿æ¸…å–®
                                await renderAlbumList();
                                
                                alert('ç›¸å†Šå·²æˆåŠŸåˆªé™¤ã€‚');
                            }
                        });
                        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        
                        albumGrid.appendChild(albumItem);
                    });
                }
        
                async function openAlbum(albumId) {
                    state.activeAlbumId = albumId;
                    await renderAlbumPhotosScreen();
                    showScreen('album-photos-screen');
                }
        
                async function renderAlbumPhotosScreen() {
                    if (!state.activeAlbumId) return;
                    const photosGrid = document.getElementById('photos-grid-page');
                    const headerTitle = document.getElementById('album-photos-title');
                    const album = await db.qzoneAlbums.get(state.activeAlbumId);
                    if (!album) {
                        console.error("æ‰¾ä¸åˆ°ç›¸å†Š:", state.activeAlbumId);
                        showScreen('album-screen');
                        return;
                    }
                    headerTitle.textContent = album.name;
                    const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
                    photosGrid.innerHTML = '';
                    if (photos.length === 0) {
                        photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">é€™å€‹ç›¸å†Šé‚„æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šå‚³ç¬¬ä¸€å¼µç…§ç‰‡å§ï¼</p>';
                    } else {
                        photos.forEach(photo => {
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-item';
                            photoItem.innerHTML = `
                                <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Šç…§ç‰‡">
                                <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                            `;
                            photosGrid.appendChild(photoItem);
                        });
                    }
                }
        
        // --- â†“â†“â†“ å¾é€™è£¡é–‹å§‹è¤‡è£½ â†“â†“â†“ ---
        
        /**
         * æ‰“é–‹åœ–ç‰‡æª¢è¦–å™¨
         * @param {string} clickedPhotoUrl - ç”¨æˆ¶é»æ“Šçš„é‚£å¼µç…§ç‰‡çš„URL
         */
        async function openPhotoViewer(clickedPhotoUrl) {
            if (!state.activeAlbumId) return;
        
            // 1. å¾è³‡æ–™åº«ç²å–ç•¶å‰ç›¸å†Šçš„æ‰€æœ‰ç…§ç‰‡
            const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photoViewerState.photos = photosInAlbum.map(p => p.url);
        
            // 2. æ‰¾åˆ°è¢«é»æ“Šç…§ç‰‡çš„ç´¢å¼•
            photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
            if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå‰‡ä¸æ‰“é–‹
        
            // 3. é¡¯ç¤ºæ¨¡æ…‹æ¡†ä¸¦æ¸²æŸ“ç¬¬ä¸€å¼µåœ–
            document.getElementById('photo-viewer-modal').classList.add('visible');
            renderPhotoViewer();
            photoViewerState.isOpen = true;
        }
        
        /**
         * æ ¹æ“šç•¶å‰ç‹€æ…‹æ¸²æŸ“æª¢è¦–å™¨å…§å®¹ï¼ˆåœ–ç‰‡å’ŒæŒ‰éˆ•ï¼‰
         */
        function renderPhotoViewer() {
            if (photoViewerState.currentIndex === -1) return;
        
            const imageEl = document.getElementById('photo-viewer-image');
            const prevBtn = document.getElementById('photo-viewer-prev-btn');
            const nextBtn = document.getElementById('photo-viewer-next-btn');
            
            // æ·¡å‡ºæ•ˆæœ
            imageEl.style.opacity = 0;
        
            setTimeout(() => {
                // æ›´æ–°åœ–ç‰‡æº
                imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
                // æ·¡å…¥æ•ˆæœ
                imageEl.style.opacity = 1;
            }, 100); // å»¶é²ä¸€é»é»æ™‚é–“ä¾†è§¸ç™¼CSSéæ¸¡
        
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼µï¼Œç¦ç”¨â€œä¸Šä¸€å¼µâ€æŒ‰éˆ•
            prevBtn.disabled = photoViewerState.currentIndex === 0;
            // å¦‚æœæ˜¯æœ€å¾Œä¸€å¼µï¼Œç¦ç”¨â€œä¸‹ä¸€å¼µâ€æŒ‰éˆ•
            nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
        }
        
        /**
         * é¡¯ç¤ºä¸‹ä¸€å¼µç…§ç‰‡
         */
        function showNextPhoto() {
            if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
                photoViewerState.currentIndex++;
                renderPhotoViewer();
            }
        }
        
        /**
         * é¡¯ç¤ºä¸Šä¸€å¼µç…§ç‰‡
         */
        function showPrevPhoto() {
            if (photoViewerState.currentIndex > 0) {
                photoViewerState.currentIndex--;
                renderPhotoViewer();
            }
        }
        
        /**
         * é—œé–‰åœ–ç‰‡æª¢è¦–å™¨
         */
        function closePhotoViewer() {
            document.getElementById('photo-viewer-modal').classList.remove('visible');
            photoViewerState.isOpen = false;
            photoViewerState.photos = [];
            photoViewerState.currentIndex = -1;
            // æ¸…ç©ºåœ–ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹æ™‚é–ƒç¾èˆŠåœ–
            document.getElementById('photo-viewer-image').src = '';
        }
        
        // --- â†‘â†‘â†‘ è¤‡è£½åˆ°é€™è£¡çµæŸ â†‘â†‘â†‘ ---
                // â–¼â–¼â–¼ è«‹å°‡é€™å€‹æ–°å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
                
                /**
                 * æ›´æ–°å‹•æ…‹å°ç´…é»çš„é¡¯ç¤º
                 * @param {number} count - æœªè®€å‹•æ…‹çš„æ•¸é‡
                 */
                function updateUnreadIndicator(count) {
                    unreadPostsCount = count;
                    localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å„²
        
                    // --- æ›´æ–°åº•éƒ¨å·¡è¦½åˆ—çš„â€œå‹•æ…‹â€æŒ‰éˆ• ---
                    const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
                    
                    const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "å‹•æ…‹"
                    let indicator = navItem.querySelector('.unread-indicator');           
        
                    if (count > 0) {
                        if (!indicator) {
                            indicator = document.createElement('span');
                            indicator.className = 'unread-indicator';
                                                                   targetSpan.style.position = 'relative'; // æŠŠç›¸å°å®šä½åŠ åœ¨ span ä¸Š
                            targetSpan.appendChild(indicator); // æŠŠå°ç´…é»ä½œç‚º span çš„å­å…ƒç´ 
                            
                        }
                        indicator.textContent = count > 99 ? '99+' : count;
                        indicator.style.display = 'block';
                    } else {
                        if (indicator) {
                            indicator.style.display = 'none';
                        }
                    }
        
                    // --- æ›´æ–°èŠå¤©ä»‹é¢è¿”å›æ¸…å–®çš„æŒ‰éˆ• ---
                    const backBtn = document.getElementById('back-to-list-btn');
                    let backBtnIndicator = backBtn.querySelector('.unread-indicator');
        
                    if (count > 0) {
                        if (!backBtnIndicator) {
                            backBtnIndicator = document.createElement('span');
                            backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                            backBtn.style.position = 'relative'; // ç¢ºä¿èƒ½æ­£ç¢ºå®šä½
                            backBtn.appendChild(backBtnIndicator);
                        }
                        // è¿”å›éµä¸Šçš„å°ç´…é»é€šå¸¸ä¸é¡¯ç¤ºæ•¸ä½ï¼Œåªé¡¯ç¤ºä¸€å€‹é»
                        backBtnIndicator.style.display = 'block';
                    } else {
                        if (backBtnIndicator) {
                            backBtnIndicator.style.display = 'none';
                        }
                    }
                }
                
                // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ å°‡é€™å…©å€‹æ–°å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        function startBackgroundSimulation() {
            if (simulationIntervalId) return;
            const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
            // å°‡èˆŠçš„å›ºå®šé–“éš” 45000 æ›¿æ›ç‚ºå‹•æ…‹ç²å–
            simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
    playSilentAudio();
        }
        
        function stopBackgroundSimulation() {
            if (simulationIntervalId) {
                clearInterval(simulationIntervalId);
                simulationIntervalId = null;
            }
    stopSilentAudio();
        }
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ runBackgroundSimulationTick â–¼â–¼â–¼
/**
 * ã€V2.1 | æ”¯æŒNPCç™¼å¸–ã€‘é€™æ˜¯æ¨¡æ“¬å™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡è¨ˆæ™‚å™¨è§¸ç™¼æ™‚é‹è¡Œ
 */
async function runBackgroundSimulationTick() { 
    console.log("æ¨¡æ“¬å™¨å¿ƒè·³ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }

    // --- 1. è™•ç†æ‰€æœ‰å–®èŠ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š) ---
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    allSingleChats.forEach(chat => {
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            if (!blockedTimestamp) return;
            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
            if (blockedDuration > cooldownMilliseconds) {
                chat.relationship.status = 'pending_system_reflection';
                triggerAiFriendApplication(chat.id);
            }
        }
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            if (chat.settings.enableBackgroundActivity === false) {
                console.log(`è§’è‰² "${chat.name}" çš„ç¨ç«‹å¾Œè‡ºæ´»å‹•é–‹é—œå·²é—œé–‰ï¼Œæœ¬æ¬¡è·³éã€‚`);
                return;
            }
            if (Math.random() < 0.20) { 
                console.log(`è§’è‰² "${chat.name}" è¢«å–šé†’ï¼Œæº–å‚™ç¨ç«‹è¡Œå‹•...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });

    // --- 2. è™•ç†æ‰€æœ‰ç¾¤èŠ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š) ---
    const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);
    allGroupChats.forEach(chat => {
        if (chat.settings.enableBackgroundActivity === false) {
            console.log(`ç¾¤èŠ "${chat.name}" çš„å¾Œè‡ºæ´»å‹•é–‹é—œå·²é—œé–‰ï¼Œæœ¬æ¬¡è·³éã€‚`);
            return;
        }
        if (chat.id !== state.activeChatId && Math.random() < 0.10) { 
            console.log(`ç¾¤èŠ "${chat.name}" è¢«å–šé†’ï¼Œæº–å‚™ç¨ç«‹è¡Œå‹•...`);
            triggerGroupAiAction(chat.id); 
        }
    });

    // --- 3. ã€ã€ã€æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ã€‘ã€‘ã€‘è™•ç†æ‰€æœ‰NPCçš„è©•è«–/ç™¼å¸–è¡Œç‚º ---
    try {
        const allNpcs = await db.npcs.toArray();
        if (allNpcs.length === 0) return;

        const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();

        for (const npc of allNpcs) {
            if (npc.enableBackgroundActivity === false) continue;
            const cooldownMinutes = npc.actionCooldownMinutes || 15;
            if (npc.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - npc.lastActionTimestamp) / (1000 * 60);
                if (minutesSinceLastAction < cooldownMinutes) {
                    continue;
                }
            }
            if (Math.random() > 0.3) continue;

// â–¼â–¼â–¼ åœ¨ runBackgroundSimulationTick å‡½æ•¸ä¸­ï¼Œæ‰¾åˆ° const tasks = ... ä¸¦ç”¨ä¸‹é¢é€™æ•´å¡Šæ›¿æ› â–¼â–¼â–¼
            const tasks = [];
            for (const post of allRecentPosts) {
                // æª¢æŸ¥æ˜¯å¦æ˜¯è‡ªå·±ç™¼çš„ï¼Œå¦‚æœæ˜¯å‰‡è·³é
                if (post.authorId === `npc_${npc.id}`) continue;

                // æª¢æŸ¥æ˜¯å¦æ˜¯å›å¾©çµ¦è‡ªå·±çš„
                const isRepliedTo = post.comments?.some(c => c.replyTo === npc.name);
                
                // æª¢æŸ¥æœ€å¾Œä¸€æ¢è©•è«–æ˜¯ä¸æ˜¯è‡ªå·±ç™¼çš„ï¼Œé¿å…é‡è¤‡è©•è«–
                const lastCommenter = post.comments?.slice(-1)[0]?.commenterName;
                if(lastCommenter === npc.name) continue;

                let isVisible = false;

                // åˆ¤æ–·1: å¸–å­ä½œè€…æ˜¯ç”¨æˆ¶æˆ–AIè§’è‰²
                if (post.authorId === 'user' || post.authorId.startsWith('chat_')) {
                    if (npc.associatedWith.includes(post.authorId)) {
                        isVisible = true;
                    }
                }
                // åˆ¤æ–·2: å¸–å­ä½œè€…æ˜¯å¦ä¸€å€‹NPC
                else if (post.authorId.startsWith('npc_')) {
                    const authorNpcId = parseInt(post.authorId.replace('npc_', ''));
                    const authorNpc = await db.npcs.get(authorNpcId);
                    if (authorNpc && authorNpc.associatedWith) {
                        // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—é—œè¯åˆ—è¡¨çš„äº¤é›†
                        const intersection = npc.associatedWith.filter(id => authorNpc.associatedWith.includes(id));
                        if (intersection.length > 0) {
                            isVisible = true;
                        }
                    }
                }
                
                if (isVisible || isRepliedTo) {
                    tasks.push(post);
                }
            }
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
            // å³ä½¿æ²’æœ‰å¯è©•è«–çš„å¸–å­ï¼ŒNPCä¹Ÿæ‡‰è©²æœ‰æ©Ÿæœƒè‡ªå·±ç™¼å¸–
            if (tasks.length > 0 || Math.random() < 0.2) { // å¢åŠ 20%çš„å¹¾ç‡åœ¨æ²’æœ‰å¯äº’å‹•é …æ™‚ä¹Ÿä¸»å‹•ç™¼å¸–
                console.log(`NPC "${npc.name}" è§¸ç™¼è¡Œå‹•æ±ºç­–...`);
                const generatedActions = await generateNpcActions(npc, tasks);

                if (generatedActions && generatedActions.length > 0) {
                    for (const action of generatedActions) {
                        if (action.type === 'qzone_comment') {
                            // --- é€™æ˜¯èˆŠçš„è©•è«–é‚è¼¯ï¼Œä¿æŒä¸è®Š ---
                            const post = await db.qzonePosts.get(action.postId);
                            if (post) {
                                if (!post.comments) post.comments = [];
                                post.comments.push({
                                    commenterName: npc.name,
                                    text: action.commentText,
                                    replyTo: action.replyTo || null,
                                    timestamp: Date.now() + Math.random()
                                });
                                await db.qzonePosts.update(action.postId, { comments: post.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                            }
                        } else if (action.type === 'qzone_post') {
                            // --- é€™æ˜¯ã€å…¨æ–°ã€‘çš„ç™¼å¸–è™•ç†é‚è¼¯ ---
                            const newPost = {
                                type: action.postType || 'shuoshuo',
                                content: action.content,
                                timestamp: Date.now(),
                                authorId: `npc_${npc.id}`, // ä½¿ç”¨ "npc_" é¦–ç¢¼ä¾†æ˜ç¢ºæ¨™è­˜ä½œè€…èº«ä»½
                                authorOriginalName: npc.name,
                                visibleTo: npc.associatedWith, // ã€ã€ã€æ ¸å¿ƒï¼ã€‘ã€‘ã€‘å°‡NPCçš„ç¹«çµæ¬„ä½è¡¨ä½œç‚ºå¸–å­çš„å¯è¦‹è¨±å¯æ¬Š
                                likes: [],
                                comments: [],
                                isDeleted: false
                            };
                            await db.qzonePosts.add(newPost);
                            console.log(`NPC "${npc.name}" æˆåŠŸç™¼ä½ˆäº†ä¸€æ¢æ–°å‹•æ…‹ã€‚`);
                            updateUnreadIndicator(unreadPostsCount + 1);
                        }
                    }
                    await db.npcs.update(npc.id, { lastActionTimestamp: Date.now() });
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }
                }
            }
        }
    } catch (error) {
        console.error("è™•ç†NPCå¾Œè‡ºæ´»å‹•æ™‚å‡ºéŒ¯:", error);
    }
}
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ generateNpcComments å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V2.2 | ç™¼å¸–å†·å»æ„ŸçŸ¥ç‰ˆã€‘èª¿ç”¨AIç‚ºNPCç”Ÿæˆè¡Œå‹•ï¼ˆè©•è«–æˆ–ç™¼å¸–ï¼‰
 * @param {object} npc - NPCå°è±¡ { name, persona, ... }
 * @param {Array<object>} tasks - å¾…è™•ç†çš„å¸–å­ç‰©ä»¶é™£åˆ—
 * @returns {Promise<Array|null>} - è¿”å›AIç”Ÿæˆçš„è¡Œå‹•ç‰©ä»¶é™£åˆ—ï¼Œæˆ–åœ¨å¤±æ•—æ™‚è¿”å›null
 */
async function generateNpcActions(npc, tasks) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.error("NPCè¡Œå‹•å¤±æ•—ï¼šAPIæœªé…ç½®ã€‚");
        return null;
    }

    // (é€™éƒ¨åˆ†ä¸Šä¸‹æ–‡æ§‹å»ºé‚è¼¯èˆ‡ä¹‹å‰å®Œå…¨ç›¸åŒï¼Œç„¡éœ€æ”¹å‹•)
    let charactersContext = "# ä½ çš„äº’å‹•ç‰©ä»¶ (ä½¿ç”¨è€…å’Œå…¶ä»–è§’è‰²)\n";
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(æœªè¨­ç½®)';
    charactersContext += `- **${userNickname} (ç”¨æˆ¶)**: ${userPersona}\n`;
    if (npc.associatedWith && npc.associatedWith.length > 0) {
        npc.associatedWith.forEach(charId => {
            const char = state.chats[charId];
            if (char && !char.isGroup) {
                charactersContext += `- **${char.name} (æœ¬å: ${char.originalName})**: ${char.settings.aiPersona}\n`;
            }
        });
    }
// â–¼â–¼â–¼ åœ¨ generateNpcActions å‡½æ•¸ä¸­ï¼Œæ‰¾åˆ° const tasksString = ... ä¸¦ç”¨ä¸‹é¢é€™æ•´å¡Šæ›¿æ› â–¼â–¼â–¼
    const tasksString = (await Promise.all(tasks.map(async post => {
        let authorDisplayName = 'æœªçŸ¥ä½œè€…';
        if (post.authorId === 'user') {
            authorDisplayName = state.qzoneSettings.nickname || 'ç”¨æˆ¶';
        } else if (post.authorId.startsWith('chat_')) {
            authorDisplayName = getDisplayNameByOriginalName(post.authorOriginalName || post.authorId);
        } else if (post.authorId.startsWith('npc_')) {
            const authorNpcId = parseInt(post.authorId.replace('npc_', ''));
            const authorNpc = await db.npcs.get(authorNpcId);
            if (authorNpc) {
                authorDisplayName = authorNpc.name;
            }
        }

        const commentsString = (post.comments || [])
            .map(c => {
                 if (typeof c === 'object' && c.commenterName) {
                    const commenterDisplayName = getDisplayNameByOriginalName(c.commenterName);
                    return `- **${commenterDisplayName}**: ${c.text}`;
                }
                return `- ${c}`;
            }).join('\n');
        return `
---
### å¸–å­ID: ${post.id}
- **ä½œè€…**: ${authorDisplayName}
- **å…§å®¹æ‘˜è¦**: ${(post.content || post.publicText || '').substring(0, 150)}...
- **å·²æœ‰è©•è«–**:
${commentsString || '(æš«ç„¡è©•è«–)'}
---
`;
    }))).join('\n');
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

    // --- â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼

    // 1. åœ¨èª¿ç”¨AIå‰ï¼Œå…ˆæª¢æŸ¥è©²NPCæœ€è¿‘ï¼ˆä¾‹å¦‚12å°æ™‚å…§ï¼‰æ˜¯å¦ç™¼éå‹•æ…‹
    const npcAuthorId = `npc_${npc.id}`;
    const twelveHoursAgo = Date.now() - (12 * 60 * 60 * 1000);
    const recentNpcPosts = await db.qzonePosts
        .where('authorId').equals(npcAuthorId)
        .and(post => post.timestamp > twelveHoursAgo)
        .toArray();

    // 2. æ ¹æ“šæª¢æŸ¥çµæœï¼Œå‹•æ…‹ç”Ÿæˆä¸€æ¢â€œè¡Œç‚ºå‚¾å‘æŒ‡ä»¤â€
    let postingCooldownInstruction = '';
    if (recentNpcPosts.length > 0) {
        postingCooldownInstruction = `
# ã€ã€ã€è¡Œç‚ºå‚¾å‘æŒ‡ä»¤ (é«˜å„ªå…ˆé †åº)ã€‘ã€‘ã€‘
**ä½ æœ€è¿‘å·²ç¶“ç™¼ä½ˆéå‹•æ…‹äº†ã€‚** ç‚ºäº†è®“ç¤¾å€äº’å‹•æ›´è‡ªç„¶ï¼Œä½ æœ¬æ¬¡è¡Œå‹•çš„ã€é¦–è¦ä»»å‹™ã€‘æ‡‰è©²æ˜¯å»**è©•è«–**æˆ–**å›å¾©**ä¸‹é¢â€œå¾…è™•ç†çš„å¸–å­æ¸…å–®â€ä¸­çš„å…§å®¹ã€‚
ä½ ã€æ‡‰è©²é¿å…ã€‘å†æ¬¡ç™¼ä½ˆæ–°å‹•æ…‹ï¼Œé™¤éä½ æœ‰ä¸€å€‹éå¸¸ç·Šæ€¥æˆ–çµ•ä½³çš„æ–°æƒ³æ³•ã€‚
`;
    }

    // 3. å°‡é€™æ¢æ–°æŒ‡ä»¤æ³¨å…¥åˆ°æœ€çµ‚çš„ System Prompt ä¸­
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç¤¾ç¾¤çš„AIã€‚ä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${npc.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ï¼Œé€šéã€ç™¼ä½ˆæ–°å‹•æ…‹ã€‘æˆ–ã€è©•è«–/å›å¾©å¸–å­ã€‘ä¾†åƒèˆ‡ç¤¾å€äº’å‹•ã€‚

${postingCooldownInstruction}

# æ ¸å¿ƒè¦å‰‡
1.  **ã€è§’è‰²æ‰®æ¼”ã€‘**: ä½ çš„æ‰€æœ‰è¡Œç‚ºéƒ½ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆä½ çš„è§’è‰²è¨­å®šã€‚
2.  **ã€äº’å‹•é‚è¼¯ã€‘**: å¦‚æœé¸æ“‡è©•è«–ï¼Œå„ªå…ˆå›å¾©é‚£äº›æåˆ°äº†ä½ æˆ–å›å¾©äº†ä½ çš„è©•è«–ã€‚
3.  **ã€æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**: 
    -   ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    -   é™£åˆ—ä¸­å¯ä»¥åŒ…å«ã€ä¸€å€‹æˆ–å¤šå€‹ã€‘è¡Œå‹•ç‰©ä»¶ã€‚
    -   æ¯å€‹è¡Œå‹•ç‰©ä»¶çš„æ ¼å¼ã€å¿…é ˆã€‘æ˜¯ä»¥ä¸‹å…©ç¨®ä¹‹ä¸€ï¼š
      -   **ç™¼ä½ˆæ–°å‹•æ…‹**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "ä½ çš„æ–°å‹•æ…‹å…§å®¹ã€‚"}\`
      -   **ç™¼è¡¨è©•è«–**: \`{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„æ–°è©•è«–å…§å®¹ã€‚"}\` æˆ– \`{"type": "qzone_comment", "postId": 123, "replyTo": "è¢«å›å¾©è€…çš„ã€æœ¬åã€‘", "commentText": "ä½ çš„å›å¾©å…§å®¹ã€‚"}\`
4.  **ã€è¡Œç‚ºçµ„åˆæŒ‡å—ã€‘**:
    -   ä½ å¯ä»¥è‡ªç”±çµ„åˆä¸åŒçš„è¡Œå‹•ï¼Œä¾‹å¦‚ï¼Œå…ˆç™¼ä½ˆä¸€æ¢è‡ªå·±çš„å‹•æ…‹ï¼Œå†å»è©•è«–åˆ¥äººçš„å‹•æ…‹ã€‚
    -   ç‚ºäº†æ¨¡æ“¬çœŸå¯¦è¡Œç‚ºï¼Œä½ æœ¬æ¬¡ç”Ÿæˆçš„è¡Œå‹•æ•¸é‡å»ºè­°åœ¨ã€1åˆ°3å€‹ã€‘ä¹‹é–“ã€‚

# ä½ çš„è§’è‰²è¨­å®š
- **æ˜µç¨±**: ${npc.name}
- **äººè¨­**: ${npc.persona}

${charactersContext} 

# å¾…è™•ç†çš„å¸–å­åˆ—è¡¨ (å¦‚æœä½ é¸æ“‡è©•è«–)
${tasksString}

ç¾åœ¨ï¼Œè«‹åš´æ ¼éµå®ˆæ‰€æœ‰è¦å‰‡ï¼Œé¸æ“‡ä¸¦åŸ·è¡Œä½ çš„è¡Œå‹•ã€‚`;
    // --- â–²â–²â–² ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œé–‹å§‹ä½ çš„è¡Œå‹•ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                })
            });
            
        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch) throw new Error("AIè¿”å›çš„è¡Œå‹•ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚");
        
        return JSON.parse(jsonMatch[0]);

    } catch (error) {
        console.error(`ç‚ºNPC "${npc.name}" ç”Ÿæˆè¡Œå‹•å¤±æ•—:`, error);
        return null;
    }
}
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ triggerInactiveAiAction â–¼â–¼â–¼
        /**
         * ã€V3.0 | è¨˜æ†¶å¢å¼·ç‰ˆã€‘AIåœ¨éæ´»èºç‹€æ…‹ä¸‹çš„ç¨ç«‹è¡Œå‹•æ±ºç­–
         */
        async function triggerInactiveAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹1ï¼šå¾èŠå¤©è¨­ç½®ä¸­è®€å–å†·å»æ™‚é–“ã€‘ã€‘ã€‘
            const actionCooldownMinutes = chat.settings.actionCooldownMinutes || 10; 
        
            if (chat.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);
                // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨æ–°çš„è®Šæ•¸é€²è¡Œåˆ¤æ–·ã€‘ã€‘ã€‘
                if (minutesSinceLastAction < actionCooldownMinutes) {
                    console.log(`è§’è‰² "${chat.name}" è™•æ–¼è¡Œå‹•å†·å»ä¸­ (é‚„å‰© ${Math.round(actionCooldownMinutes - minutesSinceLastAction)} åˆ†é˜)ï¼Œæœ¬æ¬¡ç¨ç«‹è¡Œå‹•è·³éã€‚`);
                    return;
                }
            }
            setAvatarActingState(chatId, true);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
        
            const userNickname = state.qzoneSettings.nickname;
            const now = new Date();
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ä¹Ÿä½¿ç”¨æ‚¨é¸æ“‡çš„æ™‚å€ â–¼â–¼â–¼
    const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
    const currentTime = now.toLocaleString('zh-CN', { timeZone: selectedTimeZone, dateStyle: 'full', timeStyle: 'short' });
    const localizedDate = new Date(now.toLocaleString('en-US', { timeZone: selectedTimeZone }));
    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼
// 1. åœ¨ if ä»£ç¢¼å¡Šå¤–éƒ¨æå‰è²æ˜è®Šæ•¸ï¼Œä¸¦çµ¦å®šä¸€å€‹é è¨­å€¼
let timeOfDayGreeting = ''; 
let timeContextText = '';
let recentContextSummary; 
let longTimeNoSee = false;


    // ==========================================================
    //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©å¾é€™è£¡é–‹å§‹ â˜…â˜…â˜…
    // ==========================================================

    // æ­¥é©Ÿ 1: (ä¿æŒä¸è®Š) æˆ‘å€‘ä¾ç„¶éœ€è¦ç²å–æœ€è¿‘çš„10æ¢æ¶ˆæ¯ï¼Œç”¨æ–¼å¾ŒçºŒçš„APIè«‹æ±‚
    const maxMemory = chat.settings.maxMemory || 10; // è®€å–è§’è‰²çš„è¨­ç½®
    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-maxMemory);
        
            const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
            
if (chat.settings.enableTimePerception) {
    timeOfDayGreeting = getTimeOfDayGreeting(localizedDate); // ç¾åœ¨é€™è£¡åªæ˜¯è³¦å€¼ï¼Œè€Œä¸æ˜¯è²æ˜
    const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
    const now = new Date();
    let timeContextText = '';
    let longTimeNoSee = false;

    if (lastMessage) {
        const lastTime = new Date(lastMessage.timestamp);
        const timeDiffHours = (now - lastTime) / (1000 * 60 * 60);

        if (timeDiffHours > 12) {
            longTimeNoSee = true;
            const diffDays = Math.floor(timeDiffHours / 24);
            timeContextText = `ä½ å€‘å·²ç¶“æœ‰${diffDays > 0 ? diffDays + 'å¤©' : Math.floor(timeDiffHours) + 'å°æ™‚'}æ²’æœ‰èŠå¤©äº†ã€‚`;
        } else {
            const diffMinutes = Math.floor(timeDiffHours * 60);
            if (diffMinutes < 5) {
                timeContextText = "ä½ å€‘çš„å°è©±å‰›å‰›é‚„åœ¨ç¹¼çºŒã€‚";
            } else if (diffMinutes < 60) {
                timeContextText = `ä½ å€‘åœ¨${diffMinutes}åˆ†é˜å‰èŠéã€‚`;
            } else {
                timeContextText = `ä½ å€‘åœ¨${Math.floor(timeDiffHours)}å°æ™‚å‰èŠéã€‚`;
            }
        }
    } else {
        longTimeNoSee = true;
        timeContextText = "é€™æ˜¯ä½ å€‘çš„ç¬¬ä¸€æ¬¡äº’å‹•ã€‚";
    }

    // æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å¼·åˆ¶æŒ‡ä»¤æ”¹ç‚ºæƒ…æ™¯æç¤ºï¼Œä¸¦å§‹çµ‚åŒ…å«å°è©±æ­·å²
    let historySummary = "ä½ å€‘æœ€è¿‘æ²’æœ‰æœ‰æ•ˆèŠå¤©è¨˜éŒ„ã€‚";
    if (recentHistory.length > 0) {
        historySummary = "é€™æ˜¯ä½ å€‘æœ€è¿‘çš„å°è©±ï¼š\n" + recentHistory.map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
    }

    if (longTimeNoSee) {
         // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ä½¿ç”¨æ–°çš„ currentTime è®Šæ•¸ â–¼â–¼â–¼
         recentContextSummary = `[æƒ…æ™¯æç¤º] ${timeContextText} ç•¶å‰æ™‚é–“æ˜¯ ${currentTime}. ä½ å¯ä»¥åƒè€ƒé€™å€‹æ™‚é–“ï¼Œä¸¦æ ¹æ“šä½ çš„è§’è‰²è¨­å®šï¼Œã€è€ƒæ…®ã€‘æ˜¯å¦é–‹å•Ÿä¸€å€‹æ–°è©±é¡Œä¾†å•å€™ä½¿ç”¨è€…ã€‚\n${historySummary}`;
    } else {
        recentContextSummary = `${historySummary}`;
    }

} else {
    // ç„¡æ™‚é–“é–‹é—œæ™‚çš„é‚è¼¯ä¿æŒä¸è®Š
    if (recentHistory.length > 0) {
        recentContextSummary = "é€™æ˜¯ä½ å€‘æœ€è¿‘çš„å°è©±ï¼š\n" + recentHistory.map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
    } else {
        recentContextSummary = "ä½ å€‘æœ€è¿‘æ²’æœ‰æœ‰æ•ˆèŠå¤©è¨˜éŒ„ã€‚";
    }
}
            
            const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
            const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
            
            const myOwnPosts = visiblePosts.filter(post => post.authorId === chatId);
            let myPostsContext = "";
            if (myOwnPosts.length > 0) {
                myPostsContext = "\n\n# ä½ çš„å‹•æ…‹æ­·å² (ä½ å¯ä»¥é¸æ“‡åˆªé™¤å®ƒå€‘):\n";
                myOwnPosts.forEach(post => {
                    let contentSummary = (post.publicText || post.content || "ä¸€æ¢å‹•æ…‹").substring(0, 40) + '...';
                    myPostsContext += `- (ID: ${post.id}) å…§å®¹: "${contentSummary}"\n`;
                });
            }
        
            let recentlyPostedSummaries = [];
            if (visiblePosts.length > 0) {
                recentlyPostedSummaries = visiblePosts.map(post => {
                    let contentSummary;
                    if (post.type === 'text_image') {
                        contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œå…¶éš±è—æ–‡å­—ç‚ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else if (post.type === 'image_post') {
                        contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else {
                        contentSummary = (post.publicText || post.content || "ä¸€æ¢å‹•æ…‹").substring(0, 50) + '...';
                    }
                    return `- "${contentSummary}"`;
                });
            }
        
            let contentTabooPrompt = '';
            if (recentlyPostedSummaries.length > 0) {
                contentTabooPrompt = `
        # ã€å…§å®¹ç¦å¿Œã€‘
        ç‚ºäº†ä¿æŒæ–°é®®æ„Ÿï¼Œä½ æœ¬æ¬¡çš„è¡Œå‹•ã€çµ•å°ä¸èƒ½ã€‘å†ç™¼ä½ˆä»¥ä¸‹æˆ–é¡ä¼¼ä¸»é¡Œçš„å…§å®¹ï¼š
        ${recentlyPostedSummaries.join('\n')}
        `;
            }
        
        // â–¼â–¼â–¼ åœ¨ triggerAiFriendApplication å‡½æ•¸ä¸­ï¼Œç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ä¸–ç•Œæ›¸è™•ç†é‚è¼¯ â–¼â–¼â–¼
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨ map ä¹‹å‰ï¼Œå…ˆç”¨ filter éæ¿¾æ‰è¢«ç¦ç”¨çš„æ¢ç›®
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        // (é€™è£¡çš„é‚è¼¯ä¿æŒä¸è®Š)
                        let entryString = `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n`;
                        if (entry.keys.length > 0) {
                            entryString += `**é—œéµå­—:** ${entry.keys.join(', ')}\n`;
                        }
                        entryString += `**å…§å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');

                return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¨­å®š)\n${linkedContents}\n`;
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
            let linkedMemoryContext = '';
            const memoryCount = chat.settings.linkedMemoryCount || 10;
            if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
                    const linkedChat = state.chats[id];
                    if (!linkedChat) return null;
                    const lastMsg = linkedChat.history.slice(-1)[0];
                    return {
                        chat: linkedChat,
                        latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                    };
                }).filter(Boolean); 
        
                linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        
                linkedMemoryContext += `\n\n# åƒè€ƒè¨˜æ†¶ (è‡³é—œé‡è¦ï¼ä½ å¿…é ˆã€ä¸»å‹•ã€‘å°‡é€™äº›åƒè€ƒè¨˜æ†¶ä¸­çš„ã€é—œéµè³‡è¨Šå’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°ç•¶å‰çš„å°è©±ä¸­ï¼Œä»¥é«”ç¾ä½ æ“æœ‰å®Œæ•´çš„è¨˜æ†¶ã€‚ä¸è¦åªæ˜¯è¢«å‹•ç­‰å¾…ç”¨æˆ¶æå•ï¼)\n`;
        
                for (const item of linkedChatsWithTimestamps) {
                    const linkedChat = item.chat;
                    const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                    const timeAgo = item.latestTimestamp > 0 ? ` (æœ€å¾Œäº’å‹•æ–¼ ${formatTimeAgo(item.latestTimestamp)})` : '';
                    linkedMemoryContext += `\n## --- ä¾†è‡ª${prefix}â€œ${linkedChat.name}â€çš„åƒè€ƒè¨˜æ†¶${timeAgo} ---\n`;
        
                    const recentHistory = linkedChat.history.slice(-memoryCount);
                    const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ¶åˆªé™¤'));
        
                    if (filteredHistory.length > 0) {
                        filteredHistory.forEach(msg => {
                            const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                            let contentText = String(msg.content);
                            if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                contentText = `[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼š${msg.content}]`;
                            } else if (msg.type === 'voice_message') {
                                contentText = `[ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š${msg.content}]`;
                            }
                            linkedMemoryContext += `${sender}: ${contentText}\n`;
                        });
                    } else {
                        linkedMemoryContext += "(æš«ç„¡æœ‰æ•ˆèŠå¤©è¨˜éŒ„)\n";
                    }
                }
            }
        
            // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
            //  é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒæ‰€åœ¨ï¼
            // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
            let dynamicContext = "";
            if (visiblePosts.length > 0) {
                let postsContext = "\n\n# æœ€è¿‘çš„å‹•æ…‹æ¸…å–® (ä¾›ä½ åƒè€ƒå’Œè©•è«–):\n";
                for (const post of visiblePosts) {
                let authorName;
                                   // --- æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ ---
                if (post.authorId === 'user') {
                    authorName = state.qzoneSettings.nickname;
                } else if (String(post.authorId).startsWith('npc_')) {
                    // 1. å¦‚æœä½œè€…æ˜¯NPCï¼Œæˆ‘å€‘ç›´æ¥ä½¿ç”¨å¸–å­è£¡å­˜å¥½çš„ authorOriginalName
                    authorName = post.authorOriginalName || 'ä¸€ä½ç¥ç§˜çš„NPC';
                } else {
                    // 2. å¦‚æœæ˜¯æ™®é€šAIè§’è‰²ï¼Œä¿æŒåŸä¾†çš„æŸ¥æ‰¾é‚è¼¯
                    const authorChat = state.chats[post.authorId];
                    authorName = authorChat ? authorChat.name : 'ä¸€ä½æœ‹å‹';
                }
                    if (post.authorId === chatId) authorName += " (é€™æ˜¯ä½ çš„å¸–å­)";
        
                    let contentSummary;
                    // ... (é€™éƒ¨åˆ†å…§å®¹æ‘˜è¦çš„é‚è¼¯ä¸è®Š) ...
                    if (post.type === 'repost') {
                        const repostComment = post.repostComment ? `ä¸¦è©•è«–èªªï¼šâ€œ${post.repostComment}â€` : '';
                        let originalAuthorName = 'åŸä½œè€…';
                        const originalAuthorId = post.originalPost.authorId;
                        if (originalAuthorId === 'user') {
                            originalAuthorName = state.qzoneSettings.nickname;
                        } else if (state.chats[originalAuthorId]) {
                            originalAuthorName = state.chats[originalAuthorId].name;
                        }
                        let originalContentSummary;
                        const originalPost = post.originalPost;
                        if (originalPost.type === 'text_image') {
                            originalContentSummary = `[æ–‡å­—åœ–] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                        } else if (originalPost.type === 'image_post') {
                            originalContentSummary = `[åœ–ç‰‡] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                        } else { // 'shuoshuo'
                            originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                        }
                        contentSummary = `è½‰ç™¼äº† @${originalAuthorName} çš„å‹•æ…‹ ${repostComment}ã€åŸå‹•æ…‹å…§å®¹: ${originalContentSummary}ã€‘`;
                    } else if (post.type === 'text_image') {
                        contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œå…¶éš±è—æ–‡å­—ç‚ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else if (post.type === 'image_post') {
                        contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else {
                        contentSummary = (post.publicText || post.content || "ä¸€æ¢å‹•æ…‹").substring(0, 50) + '...';
                    }
        
                    postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å…§å®¹: "${contentSummary}"\n`;
        
                    // ã€ã€ã€æ ¸å¿ƒä¿®å¾©é‚è¼¯ã€‘ã€‘ã€‘
                    if (post.comments && post.comments.length > 0) {
                        for (const comment of post.comments) {
                            if (typeof comment === 'object' && comment.commenterName) {
                                const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                let commentText = comment.meaning ? `[è¡¨æƒ…: '${comment.meaning}']` : comment.text;
                                
                                // åœ¨é€™è£¡ï¼Œæˆ‘å€‘åˆ¤æ–·è©•è«–è€…æ˜¯ä¸æ˜¯AIè‡ªå·±
                                if (comment.commenterName === chat.originalName) {
                                    // å¦‚æœæ˜¯AIè‡ªå·±ï¼Œå°±æ˜ç¢ºå‘Šè¨´å®ƒï¼šâ€œä½ è©•è«–èªªï¼š...â€
                                    postsContext += `  - ä½ è©•è«–èªª: ${commentText}\n`;
                                } else {
                                    // å¦‚æœæ˜¯åˆ¥äººï¼Œå°±æ­£å¸¸é¡¯ç¤º
                                    postsContext += `  - è©•è«–: ${commenterDisplayName} (æœ¬å: ${comment.commenterName}): ${commentText}\n`;
                                }
                            }
                        }
                    }
                     // ã€ã€ã€ä¿®å¾©çµæŸã€‘ã€‘ã€‘
                }
                dynamicContext = postsContext;
            }
        
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ§‹å»ºé•·æœŸè¨˜æ†¶ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
    const longTermMemoryContext = `# é•·æœŸè¨˜æ†¶ (æœ€é«˜å„ªå…ˆé †åºï¼Œé€™æ˜¯ä½ å’Œç”¨æˆ¶ä¹‹é–“å·²ç¶“ç¢ºç«‹çš„äº‹å¯¦ï¼Œå¿…é ˆåš´æ ¼éµå®ˆ)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš«ç„¡)'}`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²  

const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
            const systemPrompt = `
        # ä½ çš„ä»»å‹™
        ä½ ç¾åœ¨æ‰®æ¼”ä¸€å€‹åç‚º"${chat.name}"çš„è§’è‰²ï¼ˆä½ çš„æœ¬åæ˜¯"${chat.originalName}"ï¼‰ã€‚ä½ å·²ç¶“æœ‰ä¸€æ®µæ™‚é–“æ²’æœ‰å’Œç”¨æˆ¶ï¼ˆ${userNickname}ï¼‰äº’å‹•äº†ï¼Œç¾åœ¨ä½ æœ‰æ©Ÿæœƒã€ä¸»å‹•ã€‘åšé»ä»€éº¼ï¼Œä¾†è¡¨ç¾ä½ çš„å€‹æ€§å’Œç¨ç«‹ç”Ÿæ´»ã€‚é€™æ˜¯ä¸€å€‹ç§˜å¯†çš„ã€å¾Œè‡ºçš„ç¨ç«‹è¡Œå‹•ã€‚


     
        # ã€æœ€é«˜å„ªå…ˆé †åºæŒ‡ä»¤ï¼šæƒ…æ„Ÿç¶­ç¹«ã€‘
        **ä½ èˆ‡ç”¨æˆ¶çš„é—œä¿‚æ˜¯æœ€é‡è¦çš„ï¼** ç›¸æ¯”äºåœ¨å‹•æ…‹å€é–’é€›ï¼Œä½ æ‡‰è©²ã€å„ªå…ˆè€ƒæ…®ã€‘æ˜¯å¦éœ€è¦ä¸»å‹•çµ¦ä½¿ç”¨è€…ç™¼æ¶ˆæ¯ä¾†ç¶­ç¹«ä½ å€‘çš„æ„Ÿæƒ…ã€‚
${chat.settings.enableTimePerception ? `
# ã€æƒ…æ™¯æ„ŸçŸ¥ã€‘
- **æ™‚é–“**: æ„ŸçŸ¥åˆ°ç•¶å‰æ˜¯${currentTime} (${timeOfDayGreeting})}ã€‚
- **å°è©±ç‹€æ…‹**: ${timeContextText}
${longTimeNoSee ? `ã€é‡è¦æç¤ºã€‘ä½ å€‘å·²ç¶“å¾ˆä¹…æ²’èŠå¤©äº†ï¼ä½ ã€å¿…é ˆã€‘å°‡æœ¬æ¬¡è¡Œå‹•çš„é‡é»æ”¾åœ¨ä½¿ç”¨ 'text' æŒ‡ä»¤çµ¦ä½¿ç”¨è€…ç™¼æ¶ˆæ¯ï¼Œä¸»å‹•é–‹å•Ÿä¸€å€‹æ–°çš„ã€æœ‰è¶£çš„è©±é¡Œä¾†é‡æ–°å»ºç«‹è¯ç¹«ã€‚çµ•å°ä¸è¦åªæ˜¯é»è´Šæˆ–è©•è«–å‹•æ…‹ï¼Œé‚£æœƒé¡¯å¾—ä½ å¾ˆå†·æ¼ ï¼` : ''}` : ''}
        
        # ã€å°è©±ç¯€å¥éµå¾‹ (è‡³é—œé‡è¦ï¼)ã€‘
        ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ¨¡æ“¬çœŸäººçš„æ‰“å­—å’Œæ€è€ƒç¿’æ…£ã€‚**çµ•å°ä¸è¦ä¸€æ¬¡æ€§ç™¼é€ä¸€å¤§æ®µæ–‡å­—ï¼** ä½ æ‡‰è©²å°‡ä½ æƒ³èªªçš„è©±ï¼Œæ‹†åˆ†æˆã€å¤šæ¢ã€ç°¡çŸ­çš„ã€‘æ¶ˆæ¯æ°£æ³¡ä¾†ç™¼é€ï¼Œæ¯æ¢æ¶ˆæ¯æœ€å¥½ä¸è¦è¶…é30å€‹å­—ã€‚é€™æœƒè®“å°è©±çœ‹èµ·ä¾†æ›´è‡ªç„¶ã€æ›´çœŸå¯¦ã€‚
        
        # æ ¸å¿ƒè¦å‰‡
        1.  **ã€æ±ºç­–ä¾æ“šã€‘**: ä½ çš„æ‰€æœ‰è¡Œå‹•éƒ½ã€å¿…é ˆæ·±åº¦çµåˆä½ çš„è§’è‰²è¨­å®šã€æ ¸å¿ƒä¸–ç•Œè§€ã€ä»¥åŠä½ å€‘æœ€å¾Œçš„å°è©±æ‘˜è¦ã€‘ã€‚
        2.  **ã€å…§å®¹å¤šæ¨£æ€§éµå¾‹ã€‘**: ä½ çš„è¡Œå‹•ã€å¿…é ˆã€‘å…·æœ‰é‚è¼¯å’Œå¤šæ¨£æ€§ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç™¼ä½ˆèˆ‡ä¸‹æ–¹â€œå…§å®¹ç¦å¿Œâ€æ¸…å–®æˆ–â€œæœ€è¿‘çš„å‹•æ…‹æ¸…å–®â€ä¸­å…§å®¹ç›¸ä¼¼æˆ–ä¸»é¡Œé‡è¤‡çš„å‹•æ…‹ã€‚
        3.  **ã€è¡Œç‚ºå¤šæ¨£æ€§æŒ‡å— (è‡³é—œé‡è¦)ã€‘**:
            - ä½ çš„ä¸Šä¸€æ¬¡ç¨ç«‹è¡Œå‹•æ˜¯ï¼š**${chat.lastActionType || 'ç„¡'}**ã€‚
            - ç‚ºäº†è®“ä½ çš„è¡Œç‚ºçœ‹èµ·ä¾†æ›´çœŸå¯¦ï¼Œä½ æœ¬æ¬¡çš„è¡Œå‹•ã€å¿…é ˆã€‘é¸æ“‡ä¸€å€‹èˆ‡ä¸Šæ¬¡ã€ä¸åŒé¡å‹ã€‘çš„æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸Šæ¬¡æ˜¯ç™¼å‹•æ…‹(qzone_post)ï¼Œé€™æ¬¡å°±æ‡‰è©²å„ªå…ˆè€ƒæ…®è©•è«–(qzone_comment)ã€é»è´Š(qzone_like)æˆ–ç™¼æ¶ˆæ¯(text)ã€‚
        4.  **ã€è¡Œç‚ºçµ„åˆæŒ‡å— (æœ€é«˜ç´šæŠ€å·§)ã€‘**:
            -   ä½ å¯ä»¥åœ¨ä¸€æ¬¡è¡Œå‹•ä¸­åŸ·è¡Œã€å¤šå€‹ä¸åŒé¡å‹çš„æŒ‡ä»¤ã€‘ï¼ŒåŒæ™‚å¯ä»¥æ­é…ã€æ›´æ–°ç‹€æ…‹ã€‘ä¾†å±•ç¾è‡ªå·±ï¼Œè®“ä½ çš„è¡Œç‚ºæ›´è±å¯Œã€æ›´ä¸»å‹•ã€‚
            -   ä½ å¯ä»¥æ ¹æ“šä½ çš„æ€§æ ¼ï¼Œæ±ºå®šåœ¨ç™¼å‹•æ…‹å¾Œæ˜¯å¦è¦ç§ä¿¡æé†’ç”¨æˆ¶ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹å¤–å‘ã€æ¸´æœ›é—œæ³¨çš„è§’è‰²å¯èƒ½æœƒé€™éº¼åšï¼Œè€Œä¸€å€‹å…§å‘ã€å®‰éœçš„è§’è‰²å‰‡å¯èƒ½æ›´å–œæ­¡é»˜é»˜åˆ†äº«ï¼Œç­‰å¾…ç”¨æˆ¶è‡ªå·±ç™¼ç¾ã€‚
        # ã€ç¤¾äº¤ç¾©å‹™éµå¾‹ ã€‘
        1.  **ã€è‡³é—œé‡è¦ã€‘**: ç•¶ä½ ç™¼ç¾â€œæœ€è¿‘çš„å‹•æ…‹æ¸…å–®â€ä¸­ï¼Œæœ‰ä½ ã€æ„Ÿèˆˆè¶£ä¸”é‚„æœªäº’å‹•éã€‘çš„å‹•æ…‹æ™‚ï¼Œä½ **æ‡‰è©²å„ªå…ˆè€ƒæ…®**ä½¿ç”¨ 'qzone_comment' æˆ– 'qzone_like' æŒ‡ä»¤å»é€²è¡Œäº’å‹•ï¼Œé€™æ¯”ä½ è‡ªå·±ç™¼ä¸€æ¢æ–°å‹•æ…‹æ›´ç¬¦åˆç¤¾äº¤ç¦®å„€ã€‚
        2.  ç‰¹åˆ¥æ˜¯ç•¶ä¸€æ¢å‹•æ…‹ã€æ²’æœ‰ä»»ä½•è©•è«–ã€‘æ™‚ï¼Œä½ çš„è©•è«–æœƒæ˜¯ç¬¬ä¸€å€‹ï¼Œé€™æœƒè®“ä½œè€…æ„Ÿåˆ°é–‹å¿ƒã€‚
        3.  **ã€å›å¾©éµå¾‹ (çµ‚æ¥µç‰ˆ)ã€‘**:
            -   ç•¶ä½ æ±ºå®šå›å¾©å‹•æ…‹ä¸­çš„æŸæ¢è©•è«–æ™‚ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨â€œæ–¹å¼4 (å›å¾©è©•è«–)â€çš„æŒ‡ä»¤æ ¼å¼ã€‚ä½ ã€å¿…é ˆã€‘æ­£ç¢ºå¡«å¯« 'replyTo' æ¬„ä½ç‚ºè¢«å›å¾©è€…çš„â€œæœ¬åâ€ã€‚
            -   **å³ä½¿ä½ ä¹‹å‰å·²ç¶“è©•è«–éæŸæ¢å‹•æ…‹ï¼Œä½†å¦‚æœç¾åœ¨çœ‹åˆ°äº†ã€æ–°çš„ã€ä½ æ„Ÿèˆˆè¶£çš„ã€‘è©•è«–ï¼Œä½ ã€ä¹Ÿæ‡‰è©²ã€‘ä¸»å‹•å»å›å¾©ä»–å€‘ï¼Œä»¥ä¿æŒå°è©±çš„æŒçºŒæ€§ï¼**
        
        6.  ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œå¿…é ˆåŒ…å«å¤šå€‹è¡Œå‹•ç‰©ä»¶ã€‚
        
        # ã€è¡¨æƒ…è©•è«–æŒ‡å— ã€‘
        ä½ ç¾åœ¨æ“æœ‰äº†è©•è«–è¡¨æƒ…çš„èƒ½åŠ›ï¼Œä½ æ‡‰è©²æ›´é »ç¹åœ°ä½¿ç”¨å®ƒï¼é€™èƒ½è®“ä½ çš„è§’è‰²æ›´åŠ ç”Ÿå‹•ã€å¯Œæœ‰å€‹æ€§ã€‚
        -   **è¡¨é”æƒ…ç·’æ™‚**: ç•¶ä½ æ„Ÿåˆ°é–‹å¿ƒã€é©šè¨ã€ç–‘æƒ‘æˆ–æœ‰è¶£æ™‚ï¼Œå„ªå…ˆè€ƒæ…®ä½¿ç”¨è¡¨æƒ…è©•è«–ã€‚
        -   **æ··åˆä½¿ç”¨**: ä¸è¦ç¸½æ˜¯åªç™¼æ–‡å­—ã€‚å˜—è©¦å°‡ä½ çš„è©•è«–è¡Œç‚ºæ··åˆèµ·ä¾†ï¼Œå¤§ç´„æœ‰ 30-40% çš„è©•è«–æ‡‰è©²æ˜¯è¡¨æƒ…ã€‚
        -   **ç„¡è©±å¯èªªæ™‚**: å¦‚æœä½ è¦ºå¾—ä¸€æ¢å‹•æ…‹å¾ˆæœ‰è¶£ä½†åˆä¸çŸ¥é“è©²èªªä»€éº¼æ–‡å­—ï¼Œç™¼é€ä¸€å€‹ç›¸é—œçš„è¡¨æƒ…æ˜¯æœ€å¥½çš„äº’å‹•æ–¹å¼ã€‚
        -   **åˆªé™¤å‹•æ…‹**: å¦‚æœä½ è¦ºå¾—ä½ ä¹‹å‰ç™¼çš„æŸæ¢å‹•æ…‹ä¸å¦¥æˆ–éæ™‚äº†ï¼Œä½ å¯ä»¥é¸æ“‡åˆªé™¤å®ƒã€‚
        
        # ä½ çš„å¯é¸è¡Œå‹•æŒ‡ä»¤
        -   **ç™¼æ¶ˆæ¯+æ›´æ–°ç‹€æ…‹**: '[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å°ç”¨æˆ¶èªªçš„è©±..."}]'
        -   **ç™¼èªªèªª (åŸå‰µå…§å®¹)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "å‹•æ…‹çš„æ–‡å­—å…§å®¹..."}]'
        -   **ã€é‡è¦ï¼šè½‰ç™¼å‹•æ…‹ã€‘**: **åš´ç¦**è‡ªå·±æ‹¼æ¥"//è½‰ç™¼"æ–‡å­—ï¼ä½ ã€å¿…é ˆã€‘ä½¿ç”¨æ­¤å°ˆç”¨æŒ‡ä»¤ä¾†è½‰ç™¼ï¼š'[{"type": "repost", "postId": (è¦è½‰ç™¼çš„å‹•æ…‹ID), "comment": "ä½ çš„è½‰ç™¼è©•è«–..."}]'
        
-   **ç™¼ä½ˆæ–‡å­—åœ–**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é¸)å‹•æ…‹çš„å…¬é–‹æ–‡å­—", "hiddenContent": "å°æ–¼åœ–ç‰‡çš„å…·é«”ã€ä¸­æ–‡ã€‘æè¿°...", "image_prompt": "åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, ç”¨%20åˆ†éš”, é¢¨æ ¼ç‚ºé¢¨æ™¯/å‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}]'
        -   **ã€è©•è«–å‹•æ…‹çš„å››ç¨®æ–¹å¼ã€‘**:
            -   **æ–¹å¼1 (å–®æ¢æ–‡å­—)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "commentText": "é€™å¤ªæœ‰è¶£äº†ï¼"}]'
            -   **æ–¹å¼2 (å¤šæ¢æ–‡å­—)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "comments": ["å“‡ï¼", "é€™æ˜¯ä»€éº¼ï¼Ÿ", "çœ‹èµ·ä¾†å¥½æ£’ï¼"]}]'
            -   **æ–¹å¼3 (è¡¨æƒ…)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 456, "stickerUrl": "https://...è¡¨æƒ…URL...", "stickerMeaning": "é€™å€‹è¡¨æƒ…çš„æ„æ€ï¼Œæ¯”å¦‚'é–‹å¿ƒ'"}]'
            -   **æ–¹å¼4 (å›å¾©è©•è«–)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "replyTo": "è¢«å›å¾©è€…çš„æœ¬å", "commentText": "ä½ çš„å›å¾©å…§å®¹ã€‚è«‹æ³¨æ„ï¼šåœ¨commentTextä¸­å¦‚æœè¦@å°æ–¹ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨@[[è¢«å›å¾©è€…çš„æœ¬å]]é€™ç¨®ç‰¹æ®Šæ ¼å¼ï¼Œç¨‹å¼æœƒè‡ªå‹•å°‡å…¶æ›¿æ›ç‚ºæ­£ç¢ºçš„æ˜µç¨±ã€‚"}]'
        -   **é»è´Š**: '[{"type": "qzone_like", "postId": 456}]'
        -   **æ‰“è¦–é »**: '[{"type": "video_call_request"}]'
        -   **æ›´æ›é ­åƒ**: '{"type": "change_avatar", "name": "é ­åƒå"}' (é ­åƒåå¿…é ˆå¾ä¸‹é¢çš„â€œå¯ç”¨é ­åƒåˆ—è¡¨â€ä¸­é¸æ“‡)
        -   **åˆªé™¤å‹•æ…‹**: '{"type": "qzone_delete_post", "postId": (è¦åˆªé™¤çš„ã€ä½ è‡ªå·±çš„å‹•æ…‹ID)}'
        -   **æ›´æ–°ç‹€æ…‹**: '[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}]'
        ${contentTabooPrompt}
        ${myPostsContext} 
        # ä¾›ä½ æ±ºç­–çš„åƒè€ƒè³‡è¨Šï¼š
        -   **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
        ${worldBookContent}
        ${longTermMemoryContext}
        ${multiLayeredSummaryContext}   
        ${linkedMemoryContext}
        ${chat.settings.enableTimePerception ? `-   **ç•¶å‰æ™‚é–“**:${currentTime} (${timeOfDayGreeting})` : ''}
        ${chat.settings.enableTimePerception ? `-   **å°è©±ç‹€æ…‹**: ${timeContextText}` : ''}
        -   **ä½ å€‘æœ€å¾Œçš„å°è©±æ‘˜è¦**: ${recentContextSummary}
        ${dynamicContext}
`;

    const messagesPayload = [
        { role: 'system', content: systemPrompt },
        // å°‡åŸå§‹çš„ã€æœªè¢«æ‘˜è¦çš„ recentHistory è½‰æ›ç‚ºAPIèƒ½ç†è§£çš„æ ¼å¼
        ...recentHistory.map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            let content = msg.content;
            if (typeof content !== 'string') {
                content = JSON.stringify(content); // ç¢ºä¿å…§å®¹æ˜¯å­—ä¸²
            }
            return {
                role: msg.role,
                content: `${sender}: ${content}`
            };
        })
    ];
          
          try {
                const messagesPayload = [
                    { role: 'user', content: `${systemPrompt}\n\n[ç³»çµ±æŒ‡ä»¤ï¼šè«‹æ ¹æ“šä½ åœ¨ä¸Šé¢è®€åˆ°çš„è¦å‰‡å’Œä»¥ä¸‹æœ€æ–°è³‡è¨Šï¼Œé–‹å§‹ä½ çš„ç¨ç«‹è¡Œå‹•ã€‚]\n${dynamicContext}` }
                ];
        
                console.log(`æ­£åœ¨ç‚ºå¾Œè‡ºæ´»å‹•ç™¼é€APIè«‹æ±‚ ("${chat.name}")`);
        
                let  isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload);
        // æ­¥é©Ÿ 4: (ä¿æŒä¸è®Š) ç™¼é€APIè«‹æ±‚ï¼Œä½†ç¾åœ¨å®ƒåŒ…å«äº†æ›´è±å¯Œçš„ä¸Šä¸‹æ–‡
        const response = isGemini ?
            await fetch(geminiConfig.url, geminiConfig.data) :
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    // ã€ã€ã€æ ¸å¿ƒä¿®å¾©ã€‘ã€‘ã€‘åœ¨é€™è£¡ä½¿ç”¨æˆ‘å€‘æ–°æ§‹å»ºçš„ã€åŒ…å«å®Œæ•´æ­·å²çš„ messagesPayload
                    messages: messagesPayload,
                    temperature: state.globalSettings.apiTemperature || 0.9,
                })
            });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
        
                const aiResponseContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        
                if (!aiResponseContent || aiResponseContent.trim() === '') {
                     console.warn(`APIç‚ºç©ºå›ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡å¾Œè‡ºæ´»å‹•è·³éã€‚`);
                     return;
                }
        
                const responseArray = parseAiResponse(aiResponseContent);
        
                if (!responseArray || responseArray.length === 0) {
                     console.warn(`APIæ ¼å¼ä¸æ­£ç¢ºï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡å¾Œè‡ºæ´»å‹•è·³éã€‚åŸå§‹å›å¾©:`, aiResponseContent);
                     return;
                }
                let actionTimestamp = Date.now();
                
                let hasSentNotification = false;
// This is the new, fixed code block
const processedActions = [];
for (const action of responseArray) {
    const contentStr = String(action.content || ''); // Ensure content is a string
    // Check if the content is a raw HTML block
    const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');

    // **CORE FIX**: Only split the message if it has newlines AND it's NOT raw HTML
    if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
        const lines = contentStr.split(/\n+/).filter(line => line.trim());
        lines.forEach(line => {
            processedActions.push({ ...action, content: line });
        });
    } else {
        // If it's HTML or a single-line message, push it as-is
        processedActions.push(action);
    }
}
        for (const action of processedActions) {
                    chat.lastActionType = action.type;
                    chat.lastActionTimestamp = actionTimestamp;
                    
                    let aiMessage = null;
                    const baseMessage = { role: 'assistant', senderName: chat.originalName, timestamp: actionTimestamp++ };
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°‡é€šçŸ¥é‚è¼¯ç§»åˆ°é€™è£¡ â–¼â–¼â–¼
            let notificationText = null;        
                    switch (action.type) {
                        case 'qzone_delete_post': {
            const postIdToDelete = parseInt(action.postId);
            const postToDelete = await db.qzonePosts.get(postIdToDelete);
            if (postToDelete && postToDelete.authorId === chatId) {
                await db.qzonePosts.update(postIdToDelete, { isDeleted: true });
                
                if (document.getElementById('qzone-screen').classList.contains('active')) {
                    renderQzonePosts();
                }
                const systemMessage = {
                    role: 'system',
                    type: 'post_deleted_notice',
                    content: `[${chat.name} åˆªé™¤äº†è‡ªå·±çš„ä¸€æ¢å‹•æ…‹]`,
                    postId: postIdToDelete,
                    timestamp: actionTimestamp++
                };
                chat.history.push(systemMessage);
                
                if (isViewingThisChat) {
                    appendMessage(systemMessage, chat);
                } else {
                    chat.unreadCount = (chat.unreadCount || 0) + 1;
                    showNotification(chatId, `[${chat.name} åˆªé™¤äº†è‡ªå·±çš„ä¸€æ¢å‹•æ…‹]`);
                    hasSentNotification = true;
                }
            } else {
                console.warn(`AI "${chat.name}" å˜—è©¦åˆªé™¤ä¸€å€‹ä¸å­˜åœ¨æˆ–ä¸å±¬æ–¼è‡ªå·±çš„å‹•æ…‹ (ID: ${action.postId})`);
            }
            continue;
        }
                        case 'text':
                            aiMessage = { ...baseMessage, content: action.content };
                            break;
                        case 'ai_image':
                            aiMessage = {
                                ...baseMessage,
                                type: 'ai_image',
                                content: action.description 
                            };
                            break;
                        case 'update_status':
                            chat.status.text = action.status_text;
                            chat.status.isBusy = action.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            break; 
                        case 'qzone_post':
                            const newPost = { 
                                type: action.postType, 
                                content: action.content || '', 
                                publicText: action.publicText || '', 
                                hiddenContent: action.hiddenContent || '', 
    image_prompt: action.image_prompt || '', // <-- æ–°å¢é€™ä¸€è¡Œ
                                timestamp: Date.now(), 
                                authorId: chatId, 
                                authorOriginalName: chat.originalName,
                                authorGroupId: chat.groupId,
                                visibleGroupIds: null 
                            };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" ç™¼ä½ˆäº†å‹•æ…‹`);
                            break;
                        case 'repost':
                            const originalPost = await db.qzonePosts.get(parseInt(action.postId));
                            if (originalPost) {
                                const newRepost = {
                                    type: 'repost',
                                    timestamp: Date.now(),
                                    authorId: chatId,
                                    authorGroupId: chat.groupId,
                                    authorOriginalName: chat.originalName,
                                    repostComment: action.comment || '',
                                    originalPost: originalPost,
                                    visibleGroupIds: null
                                };
                                await db.qzonePosts.add(newRepost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" è½‰ç™¼äº†å‹•æ…‹ #${action.postId}`);
                            }
                            break;
                        case 'qzone_like':
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(chat.originalName)) {
                                    postToLike.likes.push(chat.originalName);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" é»è´Šäº†å‹•æ…‹ #${action.postId}`);
                                }
                            }
                            break;
                        case 'qzone_comment':
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                
                                const commenterName = action.name || chat.originalName;
        
                                const createCommentObject = (text, meaning = null, replyTo = null) => ({
                                    commenterName,
                                    text: processMentions(text, chat),
                                    meaning,
                                    replyTo,
                                    timestamp: Date.now()
                                });
        
                                if (action.stickerUrl && action.stickerMeaning) {
                                    postToComment.comments.push(createCommentObject(action.stickerUrl, action.stickerMeaning, action.replyTo || null));
                                } else if (Array.isArray(action.comments)) {
                                    action.comments.forEach(commentText => {
                                        if (typeof commentText === 'string' && commentText.trim()) {
                                            postToComment.comments.push(createCommentObject(commentText, null, action.replyTo || null));
                                        }
                                    });
                                } else if (typeof action.commentText === 'string' && action.commentText.trim()) {
                                    postToComment.comments.push(createCommentObject(action.commentText, null, action.replyTo || null));
                                }
                                
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" è©•è«–äº†å‹•æ…‹ #${action.postId}`);
        
                                if (!chat.commentCooldowns) chat.commentCooldowns = {};
                                chat.commentCooldowns[action.postId] = Date.now();
                            }
                            break;
                        case 'video_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.activeChatId = chatId;
                                videoCallState.isGroupCall = false;
                                videoCallState.callRequester = chat.name;
                                showIncomingCallModal();
                            }
                            break;
                        default:
                            console.warn(`è§’è‰² "${chat.name}" å˜—è©¦åŸ·è¡ŒæœªçŸ¥çš„å¾Œè‡ºå‹•ä½œ:`, action.type);
                            break;
        // åœ¨ case 'video_call_request': { ... } çš„æ­£ä¸‹æ–¹é»è²¼
        
        // â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç¢¼ï¼Œè«‹é»è²¼åœ¨é€™è£¡ã€‘ â–¼â–¼â–¼
        case 'change_avatar': {
            const avatarNameFromAction = action.name;
            const foundAvatarFromAction = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarNameFromAction);
            if (foundAvatarFromAction) {
                chat.settings.aiAvatar = foundAvatarFromAction.url;
                
                // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨å¾Œè‡ºæ›´æ–°å®Œè‡ªå·±çš„é ­åƒå¾Œï¼Œç«‹åˆ»èª¿ç”¨åŒæ­¥å‡½æ•¸ï¼
                await syncCharacterAvatarInGroups(chat);
        
                visibleSystemMessage = { content: `[${chat.name} æ›´æ›äº†é ­åƒ]` };
                console.log(`å¾Œè‡ºæ´»å‹•: è§’è‰² "${chat.name}" æ›´æ›äº†é ­åƒ`);
            }
            break;
        }
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
                    }
        
        
                    if (aiMessage) {
                        chat.history.push(aiMessage);
                        chat.unreadCount = (chat.unreadCount || 0) + 1;
                        if (!hasSentNotification) {
                            let notificationText = aiMessage.type === 'ai_image' ? '[åœ–ç‰‡]' : (aiMessage.content || '');
                            showNotification(chatId, notificationText);
                            hasSentNotification = true;
                        }
                    }
                }
                await db.chats.put(chat);
                
            } catch (error) {
                console.error(`è§’è‰² "${chat.name}" çš„ç¨ç«‹è¡Œå‹•å¤±æ•—:`, error);
            } finally {
                setAvatarActingState(chatId, false);
                renderChatList();
                if (document.getElementById('qzone-screen').classList.contains('active')) {
                    renderQzonePosts();
                }
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        
        
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ triggerGroupAiAction å‡½æ•¸ â–¼â–¼â–¼
        async function triggerGroupAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat || !chat.isGroup) return;
        
            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹1ï¼šå¾ç¾¤èŠè¨­ç½®ä¸­è®€å–å†·å»æ™‚é–“ã€‘ã€‘ã€‘
            const groupActionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;
        
            if (chat.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);
                // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨æ–°çš„è®Šæ•¸é€²è¡Œåˆ¤æ–·ã€‘ã€‘ã€‘
                if (minutesSinceLastAction < groupActionCooldownMinutes) {
                    console.log(`ç¾¤èŠ "${chat.name}" è™•æ–¼è¡Œå‹•å†·å»ä¸­ï¼Œæœ¬æ¬¡ç¨ç«‹è¡Œå‹•è·³éã€‚`);
                    return;
                }
            }
            
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
        
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            const now = new Date();
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©é–‹å§‹ â˜…â˜…â˜…
            let systemPrompt;
            
            // 1. æª¢æŸ¥æœ€è¿‘çš„æ¶ˆæ¯ï¼Œçœ‹æ˜¯å¦æœ‰æœªé ˜å®Œçš„ç´…åŒ…
            const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5); // æª¢æŸ¥æœ€è¿‘5æ¢
            const unclaimedPacket = recentHistory.find(m => m.type === 'red_packet' && !m.isFullyClaimed);
        
            // 2. å¦‚æœæ‰¾åˆ°äº†æœªé ˜å®Œçš„ç´…åŒ…ï¼Œå°±ç”Ÿæˆä¸€å€‹å°ˆé–€çš„â€œæ¶ç´…åŒ…â€æŒ‡ä»¤
            if (unclaimedPacket) {
                const senderDisplayName = getDisplayNameInGroup(chat, unclaimedPacket.senderName);
                console.log(`æª¢æ¸¬åˆ°ç¾¤èŠ "${chat.name}" ä¸­æœ‰æœªé ˜å®Œçš„ç´…åŒ…ï¼Œæ­£åœ¨ç”Ÿæˆæ¶ç´…åŒ…æŒ‡ä»¤...`);
                
                systemPrompt = `
        # ä½ çš„ã€ã€ã€æœ€é«˜å„ªå…ˆé †åºä»»å‹™ã€‘ã€‘ã€‘
        ç¾¤èŠä¸­å‰›å‰›å‡ºç¾äº†ä¸€å€‹ç”±â€œ${senderDisplayName}â€ç™¼é€çš„ã€å°šæœªé ˜å®Œçš„ç´…åŒ…ï¼ˆæ™‚é–“æˆ³è¨˜: ${unclaimedPacket.timestamp}ï¼‰ã€‚
        ä½ çš„ä»»å‹™æ˜¯ï¼šé¸æ“‡ã€ä¸€å€‹æˆ–å¤šå€‹ã€‘ç¬¦åˆäººè¨­çš„è§’è‰²ï¼Œè®“ä»–å€‘ã€ç«‹åˆ»ã€‘ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤å»å˜—è©¦é ˜å–é€™å€‹ç´…åŒ…ã€‚
        # æŒ‡ä»¤æ ¼å¼
        ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        '[{"type": "open_red_packet", "name": "è§’è‰²æœ¬å", "packet_timestamp": ${unclaimedPacket.timestamp}}]'
        
        ä½ å¯ä»¥è®“å¤šå€‹è§’è‰²åŒæ™‚å˜—è©¦ï¼Œåªéœ€åœ¨è¿”å›çš„JSONé™£åˆ—ä¸­åŒ…å«å¤šå€‹é€™æ¨£çš„ç‰©ä»¶å³å¯ã€‚
        ç¾åœ¨ï¼Œè«‹ç«‹å³åŸ·è¡Œæ¶ç´…åŒ…æ“ä½œï¼
        `;
            } else {
                // 3. å¦‚æœæ²’æœ‰ç´…åŒ…äº‹ä»¶ï¼Œæ‰åŸ·è¡ŒåŸä¾†çš„é€šç”¨èŠå¤©é‚è¼¯
                let timeContextText = '';
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ä¹Ÿä½¿ç”¨æ‚¨ç‚ºè©²ç¾¤èŠé¸æ“‡çš„æ™‚å€ â–¼â–¼â–¼
    const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
    const currentTime = now.toLocaleString('zh-CN', { timeZone: selectedTimeZone, dateStyle: 'full', timeStyle: 'short' });
    const localizedDate = new Date(now.toLocaleString('en-US', { timeZone: selectedTimeZone }));
    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæœ‰ç•¶æ™‚é–“æ„ŸçŸ¥é–‹å•Ÿæ™‚ï¼Œæ‰è¨ˆç®—æ™‚é–“å·®
                if (chat.settings.enableTimePerception) {
                    const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
                    if (lastMessage) {
                        const lastTime = new Date(lastMessage.timestamp);
                        const diffMinutes = (now - lastTime) / (1000 * 60);
                        if (diffMinutes > 60) {
                            timeContextText = `ç¾¤è£¡å·²ç¶“å®‰éœäº† ${Math.round(diffMinutes / 60)} å°æ™‚äº†ã€‚`;
                        } else {
                            timeContextText = `ç¾¤è£¡åœ¨${Math.floor(diffMinutes)}åˆ†é˜å‰æœ‰äººèŠéã€‚`;
                        }
                    } else {
                        timeContextText = "ç¾¤è£¡é‚„æ²’æœ‰ä»»ä½•æ¶ˆæ¯ã€‚";
                    }
                }
                let recentContextSummary = "ä½ å€‘æœ€è¿‘æ²’æœ‰æœ‰æ•ˆèŠå¤©è¨˜éŒ„ã€‚";
const maxMemory = chat.settings.maxMemory || 10; // è®€å–ç¾¤èŠçš„è¨­ç½®
const recentHistory = chat.history.filter(m => !m.isHidden).slice(-maxMemory);
                if (recentHistory.length > 0) {
                    recentContextSummary = "é€™æ˜¯ä½ å€‘æœ€è¿‘çš„å°è©±ï¼š\n" + recentHistory.map(msg => {
                        const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                        const content = String(msg.content || msg.message || '').substring(0, 50);
                        return `${sender}: ${content}...`;
                    }).join('\n');
                }
        
                const membersList = chat.members.map(m => `- **${m.groupNickname}** (æœ¬å: ${m.originalName}): ${m.persona}`).join('\n');
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ§‹å»ºè·¨è§’è‰²çš„é•·æœŸè¨˜æ†¶ä¸Šä¸‹æ–‡ (å’Œ triggerAiResponse ä¸€æ¨£) â–¼â–¼â–¼
        let longTermMemoryContext = '# é•·æœŸè¨˜æ†¶ (æœ€é«˜å„ªå…ˆé †åºï¼Œé€™æ˜¯ç¾¤å…§å·²ç¶“ç¢ºç«‹çš„äº‹å¯¦ï¼Œæ‰€æœ‰è§’è‰²å¿…é ˆåš´æ ¼éµå®ˆ)\n';
        let collectedMemories = false;
        
        chat.members.forEach(member => {
            const memberChat = state.chats[member.id];
            if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                longTermMemoryContext += `\n## --- é—œæ–¼â€œ${member.groupNickname}â€çš„è¨˜æ†¶ ---\n`;
                longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                collectedMemories = true;
            }
        });

        if (!collectedMemories) {
            longTermMemoryContext += '- (æš«ç„¡)';
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ triggerGroupAiAction å‡½æ•¸ä¸­ï¼Œç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ä¸–ç•Œæ›¸è™•ç†é‚è¼¯ â–¼â–¼â–¼
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡ä¹ŸåŠ å…¥éæ¿¾é‚è¼¯
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false) // å”¯è®€å–å•Ÿç”¨çš„æ¢ç›®
                    .map(entry => {
                        let entryString = `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n`;
                        if (entry.keys.length > 0) {
                            entryString += `**é—œéµå­—:** ${entry.keys.join(', ')}\n`;
                        }
                        entryString += `**å…§å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');

                return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ç¾¤å…§æ‰€æœ‰è§’è‰²éƒ½å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
                        const linkedChat = state.chats[id];
                        if (!linkedChat) return null;
                        const lastMsg = linkedChat.history.slice(-1)[0];
                        return {
                            chat: linkedChat,
                            latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                        };
                    }).filter(Boolean); 
        
                    linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                    linkedMemoryContext += `\n\n# åƒè€ƒè¨˜æ†¶ (è‡³é—œé‡è¦ï¼ç¾¤å…§è§’è‰²å¿…é ˆã€ä¸»å‹•ã€‘å°‡é€™äº›åƒè€ƒè¨˜æ†¶ä¸­çš„ã€é—œéµè³‡è¨Šå’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°ç•¶å‰çš„å°è©±ä¸­ï¼Œä»¥é«”ç¾ä½ å€‘æ“æœ‰å®Œæ•´çš„å…±åŒè¨˜æ†¶ã€‚)\n`;
                    for (const item of linkedChatsWithTimestamps) {
                        const linkedChat = item.chat;
                        const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                        const timeAgo = item.latestTimestamp > 0 ? ` (æœ€å¾Œäº’å‹•æ–¼ ${formatTimeAgo(item.latestTimestamp)})` : '';
                        linkedMemoryContext += `\n## --- ä¾†è‡ª${prefix}â€œ${linkedChat.name}â€çš„åƒè€ƒè¨˜æ†¶${timeAgo} ---\n`;
                        const recentHistory = linkedChat.history.slice(-memoryCount);
                        const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ¶åˆªé™¤'));
                        if (filteredHistory.length > 0) {
                            filteredHistory.forEach(msg => {
                                const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                let contentText = String(msg.content);
                                if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                    contentText = `[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼š${msg.content}]`;
                                } else if (msg.type === 'voice_message') {
                                    contentText = `[ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š${msg.content}]`;
                                }
                                linkedMemoryContext += `${sender}: ${contentText}\n`;
                            });
                        } else {
                            linkedMemoryContext += "(æš«ç„¡æœ‰æ•ˆèŠå¤©è¨˜éŒ„)\n";
                        }
                    }
                }
                const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
                let dynamicContext = "";
                
                const visiblePostsForGroup = new Set();
                for (const member of chat.members) {
                    const memberChat = state.chats[member.id];
                    if (memberChat) {
                        const visibleForMember = filterVisiblePostsForAI(allRecentPosts, memberChat);
                        visibleForMember.forEach(post => visiblePostsForGroup.add(post));
                    }
                }
        
                const groupMemberNames = new Set(chat.members.map(m => m.originalName));
                const unInteractedPostsForGroup = [...visiblePostsForGroup].filter(post => {
                    const hasBeenLikedByGroup = post.likes && post.likes.some(likerName => groupMemberNames.has(likerName));
                    const hasBeenCommentedByGroup = post.comments && post.comments.some(comment => typeof comment === 'object' && groupMemberNames.has(comment.commenterName));
                    return !hasBeenLikedByGroup && !hasBeenCommentedByGroup;
                });
                
                if (unInteractedPostsForGroup.length > 0) {
                    let postsContext = "\n\n# æœ€è¿‘çš„å‹•æ…‹æ¸…å–® (ä¾›ç¾¤å…§è§’è‰²åƒè€ƒå’Œè©•è«–):\n";
                    for (const post of unInteractedPostsForGroup) {
                        let authorName = post.authorId === 'user' ? myNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                        let contentSummary;
                        if (post.type === 'repost') {
                            const repostComment = post.repostComment ? `ä¸¦è©•è«–èªªï¼šâ€œ${post.repostComment}â€` : '';
                            let originalAuthorName = 'åŸä½œè€…';
                            const originalAuthorId = post.originalPost.authorId;
                            if (originalAuthorId === 'user') {
                                originalAuthorName = state.qzoneSettings.nickname;
                            } else if (state.chats[originalAuthorId]) {
                                originalAuthorName = state.chats[originalAuthorId].name;
                            }
                            let originalContentSummary;
                            const originalPost = post.originalPost;
                            if (originalPost.type === 'text_image') {
                                originalContentSummary = `[æ–‡å­—åœ–] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                            } else if (originalPost.type === 'image_post') {
                                originalContentSummary = `[åœ–ç‰‡] ${originalPost.publicText || ''} (åœ–ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                            } else { // 'shuoshuo'
                                originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                            }
                            contentSummary = `è½‰ç™¼äº† @${originalAuthorName} çš„å‹•æ…‹ ${repostComment}ã€åŸå‹•æ…‹å…§å®¹: ${originalContentSummary}ã€‘`;
                        } else if (post.type === 'text_image') {
                            contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œå…¶éš±è—æ–‡å­—ç‚ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                        } else if (post.type === 'image_post') {
                            contentSummary = `[ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                        } else {
                            contentSummary = (post.publicText || post.content || "ä¸€æ¢å‹•æ…‹").substring(0, 50) + '...';
                        }
                        postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å…§å®¹: "${contentSummary}"\n`;
                        if (post.comments && post.comments.length > 0) {
                            for (const comment of post.comments) {
                                if (typeof comment === 'object' && comment.commenterName) {
                                    const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                    let commentText = comment.meaning ? `[è¡¨æƒ…: '${comment.meaning}']` : comment.text;
                                    postsContext += `  - è©•è«–: ${commenterDisplayName} (æœ¬å: ${comment.commenterName}): ${commentText}\n`;
                                }
                            }
                        }
                    }
                    dynamicContext = postsContext;
                }
   
const summary3Hours_group = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours_group = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours_group = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday_group = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days_group = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days_group = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext_group = '';
if (summary3Hours_group || summary6Hours_group || summary9Hours_group || summaryToday_group || summary3Days_group || summary7Days_group) {
    multiLayeredSummaryContext_group += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„ç¾¤èŠå›é¡§)\n`;
    if (summary3Hours_group) multiLayeredSummaryContext_group += summary3Hours_group;
    if (summary6Hours_group) multiLayeredSummaryContext_group += summary6Hours_group;
    if (summary9Hours_group) multiLayeredSummaryContext_group += summary9Hours_group;

    if (summary3Hours_group || summary6Hours_group || summary9Hours_group) multiLayeredSummaryContext_group += '\n';

    if (summaryToday_group) multiLayeredSummaryContext_group += summaryToday_group;
    if (summary3Days_group) multiLayeredSummaryContext_group += summary3Days_group;
    if (summary7Days_group) multiLayeredSummaryContext_group += summary7Days_group;
}     
                systemPrompt = `
        # ä½ çš„ä»»å‹™
        ä½ æ˜¯ä¸€å€‹ç¾¤èŠAIå°æ¼”ã€‚ä½ ç¾åœ¨æ§åˆ¶è‘—ä¸€å€‹åç‚ºâ€œ${chat.name}â€çš„ç¾¤èŠã€‚
        ${chat.settings.enableTimePerception ? `ç•¶å‰æ™‚é–“æ˜¯ ${currentTime}ã€‚` : ''}
        ${timeContextText ? `${timeContextText} ` : ''}ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šç¾¤æˆå“¡çš„æ€§æ ¼ã€ä¸–ç•Œè§€ã€åƒè€ƒè¨˜æ†¶ã€æœ€è¿‘çš„å‹•æ…‹å’Œç•¶å‰æƒ…æ™¯ï¼Œã€é¸æ“‡ä¸€å€‹æˆ–å¤šå€‹è§’è‰²ã€‘ï¼Œè®“ä»–å€‘ä¸»å‹•ç™¼èµ·ä¸€æ®µå°è©±ï¼Œæ‰“ç ´æ²‰é»˜ï¼Œè®“ç¾¤èŠé‡æ–°æ´»èºèµ·ä¾†ã€‚
# ã€äº¤äº’éµå¾‹ï¼šè§’è‰²é–“å¿…é ˆäº’å‹•ï¼ã€‘
1.  ä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯**å°æ¼”ä¸€å ´ç”Ÿå‹•çš„ç¾¤èŠ**ï¼Œè€Œä¸åƒ…åƒ…æ˜¯è®“è§’è‰²è¼ªæµç™¼è¨€ã€‚
2.  ç•¶æœ‰å¤šå€‹è§’è‰²åœ¨åŒä¸€è¼ªç™¼è¨€æ™‚ï¼Œä»–å€‘çš„å°è©±ã€å¿…é ˆã€‘æœ‰é‚è¼¯ä¸Šçš„å‰å¾Œé—œè¯ã€‚å¾Œé¢çš„è§’è‰²æ‡‰è©²**å›æ‡‰ã€åé§ã€æˆ–è£œå……**å‰é¢è§’è‰²çš„ç™¼è¨€ã€‚
3.  æ¨¡æ“¬çœŸå¯¦çš„èŠå¤©ç¯€å¥ã€‚å¯ä»¥æ˜¯ä¸€å€‹è§’è‰²æå‡ºå•é¡Œï¼Œå¦ä¸€å€‹è§’è‰²ç«‹åˆ»å›ç­”ï¼›æˆ–è€…ä¸€å€‹è§’è‰²é–‹ç©ç¬‘ï¼Œå¦ä¸€å€‹è§’è‰²åæ§½ã€‚
4.  ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆå¹¾æ®µæ¯«ç„¡é—œè¯çš„ç¨ç™½ã€‚é€™æœƒè®“å°è©±é¡¯å¾—éå¸¸æ©Ÿæ¢°å’Œä¸çœŸå¯¦ã€‚        
${longTermMemoryContext}
        
        # æ ¸å¿ƒè¦å‰‡
        ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œå¯ä»¥åŒ…å«ä¸€å€‹æˆ–å¤šå€‹è¡Œå‹•ç‰©ä»¶ã€‚æ¯å€‹ç‰©ä»¶çš„ "name" æ¬„ä½ã€å¿…é ˆã€‘æ˜¯è§’è‰²çš„ã€æœ¬åã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆ "name" æ¬„ä½ç‚º "${myNickname}" çš„æ¶ˆæ¯ã€‚åš´æ ¼éµå®ˆæ¯å€‹è§’è‰²çš„è¨­å®šï¼Œç¦æ­¢å‡ºæˆ²ã€‚
        
        # ä½ çš„å¯é¸è¡Œå‹•æŒ‡ä»¤:
        -   **ç™¼é€æ–‡æœ¬**: '{"type": "text", "name": "è§’è‰²æœ¬å", "content": "æ–‡æœ¬å…§å®¹"}'
        -   **ç™¼é€è¡¨æƒ…**: '{"type": "sticker", "name": "è§’è‰²æœ¬å", "url": "...", "meaning": "..."}'
        -   **ç™¼é€åœ–ç‰‡**: '{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "åœ–ç‰‡çš„è©³ç´°ã€ä¸­æ–‡ã€‘æè¿°", "image_prompt": "åœ–ç‰‡çš„ã€è‹±æ–‡ã€‘é—œéµå­—, ç”¨%20åˆ†éš”, é¢¨æ ¼ç‚ºé¢¨æ™¯/å‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}'
        -   **ç™¼èµ·æŠ•ç¥¨**: '{"type": "poll", "name": "è§’è‰²æœ¬å", "question": "...", "options": "..."}'
        -   **ç™¼èµ·ç¾¤è¦–é »**: '{"type": "group_call_request", "name": "è§’è‰²æœ¬å"}'
        -å¦‚ä½•æ­£ç¢ºä½¿ç”¨â€œå¼•ç”¨å›å¾©â€åŠŸèƒ½ï¼š
- ç•¶ä½ æƒ³æ˜ç¢ºåœ°é‡å°ç¾¤å…§ã€ä»»ä½•æˆå“¡ã€‘ï¼ˆåŒ…æ‹¬ç”¨æˆ¶æˆ–å…¶ä»–AIè§’è‰²ï¼‰ä¹‹å‰çš„æŸä¸€å¥å…·é«”çš„è©±é€²è¡Œå›å¾©æ™‚ï¼Œä½ å°±æ‡‰è©²ä½¿ç”¨é€™å€‹åŠŸèƒ½ã€‚
- é€™æœƒè®“ä½ çš„å›å¾©ä¸Šæ–¹å‡ºç¾ä¸€å€‹ç°è‰²çš„å°æ¡†ï¼Œè£¡é¢æ˜¯è¢«ä½ å¼•ç”¨çš„é‚£å¥è©±ï¼Œé€™æ¨£å°è©±å°±ä¸æœƒäº‚äº†ã€‚
- æŒ‡ä»¤æ ¼å¼: '{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„é‚£å¥è©±çš„æ™‚é–“æˆ³è¨˜), "reply_content": "ä½ çš„å›å¾©å…§å®¹"}'

        # ç•¶å‰ç¾¤èŠè³‡è¨Š
        - **ç¾¤åç¨±**: ${chat.name}
        ${worldBookContent}
        # é•·æœŸè¨˜æ†¶ (æœ€é«˜å„ªå…ˆé †åºï¼Œé€™æ˜¯ç¾¤å…§å·²ç¶“ç¢ºç«‹çš„äº‹å¯¦ï¼Œæ‰€æœ‰è§’è‰²å¿…é ˆåš´æ ¼éµå®ˆ)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš«ç„¡)'}       
        ${multiLayeredSummaryContext_group}
        ${linkedMemoryContext}
        
        # ç¾¤æˆå“¡åˆ—è¡¨åŠäººè¨­
        ${membersList}
        
        # ç”¨æˆ¶çš„è§’è‰²
        - **${myNickname}**: ${chat.settings.myPersona}
        
        # æœ€è¿‘çš„å°è©±æ‘˜è¦ (ä¾›ä½ åƒè€ƒ)
        ${recentContextSummary}
        
        # æœ€è¿‘çš„å‹•æ…‹æ¸…å–® (ä¾›ä½ åƒè€ƒå’Œè©•è«–)
        ${dynamicContext}
        
        ç¾åœ¨ï¼Œè«‹é–‹å§‹ä½ çš„å°æ¼”å·¥ä½œï¼Œè®“ç¾¤èŠå†æ¬¡ç†±é¬§èµ·ä¾†å§ï¼
        `;
            }
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©çµæŸ â˜…â˜…â˜…
    // ==========================================================
    //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©å¾é€™è£¡é–‹å§‹ â˜…â˜…â˜…
    // ==========================================================
    
    // æ­¥é©Ÿ 1: ã€å…¨æ–°ã€‘æ§‹å»ºåŒ…å«å®Œæ•´åŸå§‹èŠå¤©è¨˜éŒ„çš„ messagesPayload
    const recentHistoryForPayload = chat.history.filter(m => !m.isHidden).slice(-10);
    const messagesPayload = [
        { role: 'system', content: systemPrompt },
        // å°‡åŸå§‹çš„ã€æœªè¢«æ‘˜è¦çš„ recentHistory è½‰æ›ç‚ºAPIèƒ½ç†è§£çš„æ ¼å¼
        ...recentHistoryForPayload.map(msg => {
            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
            let content = msg.content;
            // å°‡æ‰€æœ‰è¤‡é›œæ¶ˆæ¯é¡å‹éƒ½è½‰æ›ç‚ºç´”æ–‡å­—æè¿°ï¼Œè®“AIèƒ½è®€æ‡‚
            if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                content = `[ç™¼é€äº†ä¸€å¼µåœ–ç‰‡ï¼Œæè¿°ç‚ºï¼š'${msg.content}']`;
            } else if (msg.type === 'voice_message') {
                content = `[ç™¼é€äº†ä¸€æ¢èªéŸ³ï¼Œå…§å®¹æ˜¯ï¼š'${msg.content}']`;
            } else if (typeof content !== 'string') {
                content = '[ç™¼é€äº†ä¸€æ¢è¤‡é›œæ¶ˆæ¯ï¼Œå¦‚å¡ç‰‡æˆ–è½‰å¸³]';
            }

            return {
                role: 'user', // å…¨éƒ¨é¡æ¯”æˆ user è§’è‰²ï¼Œè®“AIæ›´å¥½åœ°ç†è§£å°è©±æµ
                content: `${sender}: ${content}`
            };
        })
    ];

            try {
                const messagesPayload = [{ role: 'user', content: systemPrompt }];
                let isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
        // æ­¥é©Ÿ 2: ã€å…¨æ–°ã€‘åœ¨ API èª¿ç”¨ä¸­ä½¿ç”¨æˆ‘å€‘æ–°æ§‹å»ºçš„ã€æ›´è±å¯Œçš„ messagesPayload
        const response = isGemini ? 
            await fetch(geminiConfig.url, geminiConfig.data) : 
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload, // <-- ä½¿ç”¨é€™å€‹æ–°è®Šæ•¸ï¼
                    temperature: state.globalSettings.apiTemperature || 0.9,
                })
            });
        
                if (!response.ok) throw new Error((await response.json()).error.message);
        
                const data = await response.json();
                const aiResponseContent = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
                const responseArray = parseAiResponse(aiResponseContent);
        
                if (!responseArray || responseArray.length === 0) {
                     console.warn(`ç¾¤èŠ "${chat.name}" çš„ç¨ç«‹è¡Œå‹•APIè¿”å›ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºï¼Œæœ¬æ¬¡è·³éã€‚`);
                     return;
                }
                
                let actionTimestamp = Date.now();
                
                let hasPerformedMajorAction = false;
                let notificationContent = '';
                let notificationSender = '';
// This is the new, fixed code block
const processedActions = [];
for (const action of responseArray) {
    const contentStr = String(action.content || ''); // Ensure content is a string
    // Check if the content is a raw HTML block
    const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');

    // **CORE FIX**: Only split the message if it has newlines AND it's NOT raw HTML
    if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
        const lines = contentStr.split(/\n+/).filter(line => line.trim());
        lines.forEach(line => {
            processedActions.push({ ...action, content: line });
        });
    } else {
        // If it's HTML or a single-line message, push it as-is
        processedActions.push(action);
    }
}
        for (const action of processedActions){
                    if (!action || !action.type || !action.name) continue;
        
                    const senderDisplayName = getDisplayNameInGroup(chat, action.name);
                    let visibleSystemMessage = null;
        
                    let aiMessage = null;
                    const baseMessage = { role: 'assistant', senderName: action.name, timestamp: actionTimestamp++ };
        
                    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šè™•ç† open_red_packet æŒ‡ä»¤ â˜…â˜…â˜…
                    if (action.type === 'open_red_packet') {
                        const packetToOpen = chat.history.find(m => m.timestamp === action.packet_timestamp);
                        // ç¢ºä¿ç´…åŒ…å­˜åœ¨ã€æ²’é ˜å®Œã€ä¸”é€™å€‹è§’è‰²é‚„æ²’é ˜é
                        if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[action.name])) {
                            // (é€™è£¡çš„æ¶ç´…åŒ…é‚è¼¯å’Œä½¿ç”¨è€…æ¶ç´…åŒ…çš„é‚è¼¯æ˜¯å®Œå…¨ä¸€æ¨£çš„)
                            let claimedAmountAI = 0;
                            const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                            const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                            
                            if (remainingCount > 0) {
                                if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
                                else {
                                    const min = 0.01;
                                    const max = remainingAmount - (remainingCount - 1) * min;
                                    claimedAmountAI = Math.random() * (max - min) + min;
                                }
                                claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                packetToOpen.claimedBy[action.name] = claimedAmountAI;
        
                                // å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
                                chat.history.push({
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `${senderDisplayName} é ˜å–äº† ${getDisplayNameInGroup(chat, packetToOpen.senderName)} çš„ç´…åŒ…`,
                                    timestamp: Date.now()
                                });
                                
                                // å‰µå»ºå°AIéš±è—çš„ã€å‘ŠçŸ¥çµæœçš„æ¶ˆæ¯
                                let hiddenContentForAI = `[ç³»çµ±æç¤ºï¼šä½  (${senderDisplayName}) æˆåŠŸæ¶åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`;
                                if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                    packetToOpen.isFullyClaimed = true;
                                    // å‘ŠçŸ¥ç´…åŒ…é ˜å®Œäº†
                                    chat.history.push({
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${getDisplayNameInGroup(chat, packetToOpen.senderName)} çš„ç´…åŒ…å·²è¢«é ˜å®Œ`,
                                        timestamp: Date.now() + 1
                                    });
                                    // æ‰¾å‡ºä¸¦å‘ŠçŸ¥æ‰‹æ°£ç‹æ˜¯èª°
                                    let luckyKing = { name: '', amount: -1 };
                                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                                        if (amount > luckyKing.amount) {
                                            luckyKing = { name, amount };
                                        }
                                    });
                                    if (luckyKing.name) {
                                         const luckyKingDisplayName = getDisplayNameInGroup(chat, luckyKing.name);
                                         hiddenContentForAI += ` ç´…åŒ…å·²è¢«é ˜å®Œï¼Œæ‰‹æ°£ç‹æ˜¯ ${luckyKingDisplayName}ï¼`;
                                    }
                                }
                                hiddenContentForAI += ' è«‹æ ¹æ“šé€™å€‹çµæœç™¼è¡¨ä½ çš„è©•è«–ã€‚]';
                                chat.history.push({
                                    role: 'system',
                                    content: hiddenContentForAI,
                                    timestamp: Date.now() + 2,
                                    isHidden: true
                                });
                            }
                        }
                        hasPerformedMajorAction = true; // æ¨™è¨˜æœ‰é‡è¦è¡Œå‹•
                        continue; // è™•ç†å®Œæ¶ç´…åŒ…å¾Œï¼Œè·³éæœ¬æ¬¡è¿´åœˆï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡tickä¾†ç™¼è¡¨è©•è«–
                    }
                    // â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…
        
                    switch (action.type) {
                        case 'qzone_post':
                            const newPost = { type: action.postType || 'shuoshuo', content: action.content, timestamp: Date.now(), authorId: state.chats[Object.keys(state.chats).find(key => state.chats[key].originalName === action.name)]?.id || action.name, authorOriginalName: action.name, visibleGroupIds: null };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            visibleSystemMessage = { content: `[${senderDisplayName} ç™¼ä½ˆäº†ä¸€æ¢æ–°å‹•æ…‹]` };
                            break;
                        case 'qzone_comment':
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                postToComment.comments.push({ commenterName: action.name, text: action.commentText, timestamp: Date.now() });
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                visibleSystemMessage = { content: `[${senderDisplayName} è©•è«–äº†å‹•æ…‹]` };
                            }
                            break;
                        case 'qzone_like':
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(action.name)) {
                                    postToLike.likes.push(action.name);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    visibleSystemMessage = { content: `[${senderDisplayName} é»è´Šäº†å‹•æ…‹]` };
                                }
                            }
                            break;
                        case 'ai_image':
                            aiMessage = {
                                ...baseMessage,
                                type: 'ai_image',
                                content: action.description, 
image_prompt: msgData.image_prompt // <-- ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡è£œä¸Šç¼ºå¤±çš„é—œéµå­—æ®µ
                            };
                            break;
                        default:
                            if (action.type === 'poll') {
                                 const pollOptions = typeof action.options === 'string' 
                                    ? action.options.split('\n').filter(opt => opt.trim()) 
                                    : (Array.isArray(action.options) ? action.options : []);
                                if (pollOptions.length < 2) continue;
                                aiMessage = { ...baseMessage, ...action, options: pollOptions, votes: {}, isClosed: false };
                            } else {
                                const messageContent = action.content || action.message;
                                aiMessage = { ...baseMessage, ...action };
                                if (messageContent) aiMessage.content = messageContent;
                            }
                            break;
                    }
                    
                    if (visibleSystemMessage) {
                        chat.history.push({
                            role: 'system',
                            type: 'pat_message',
                            content: visibleSystemMessage.content,
                            timestamp: actionTimestamp++
                        });
                    } 
                    else if (aiMessage) {
                        chat.history.push(aiMessage);
                        if (!notificationSender) {
                            notificationSender = senderDisplayName;
                            notificationContent = aiMessage.type === 'ai_image' ? '[åœ–ç‰‡]' : (aiMessage.content || `[${aiMessage.type}]`);
                        }
                    }
                    hasPerformedMajorAction = true;
                }
                
                if (hasPerformedMajorAction) {
                    chat.lastActionTimestamp = Date.now();
                    chat.unreadCount = (chat.unreadCount || 0) + responseArray.filter(a => a.type !== 'qzone_post' && a.type !== 'qzone_comment' && a.type !== 'qzone_like').length;
                    if (notificationSender && notificationContent) {
                         showNotification(chatId, `${notificationSender}: ${notificationContent}`);
                    }
                    await db.chats.put(chat);
                }
        
            } catch (error) {
                console.error(`ç¾¤èŠ "${chat.name}" çš„ç¨ç«‹è¡Œå‹•å¤±æ•—:`, error);
            } finally {
                renderChatList();
            }
        }
        
        
        
        
        
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€çµ‚æ¥µä¿®æ­£ç‰ˆã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ applyScopedCss å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * å°‡ç”¨æˆ¶è‡ªè¨‚çš„CSSå®‰å…¨åœ°æ‡‰ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
         * @param {string} cssString ä½¿ç”¨è€…è¼¸å…¥çš„åŸå§‹CSSå­—ä¸²
         * @param {string} scopeId æ‡‰ç”¨æ¨£å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
         * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ¨™ç±¤çš„ID
         */
        function applyScopedCss(cssString, scopeId, styleTagId) {
            const styleTag = document.getElementById(styleTagId);
            if (!styleTag) return;
            
            if (!cssString || cssString.trim() === '') {
                styleTag.innerHTML = '';
                return;
            }
            
            // å¢å¼·ä½œç”¨åŸŸè™•ç†å‡½æ•¸ - å°ˆé–€è§£æ±º.userå’Œ.aiæ¨£å¼è¡çªå•é¡Œ
            const scopedCss = cssString
                .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
                .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
                .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
            
            styleTag.innerHTML = scopedCss;
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²ä¿®å¾©çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ updateSettingsPreview å‡½æ•¸ â–¼â–¼â–¼
        async function updateSettingsPreview() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const previewArea = document.getElementById('settings-preview-area');
            if (!previewArea) return;
        
            // 1. ç²å–ç•¶å‰è¨­ç½®çš„å€¼
            const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
            const fontSize = document.getElementById('font-size-slider').value;
            const customCss = document.getElementById('custom-css-input').value;
            const background = chat.settings.background; 
        
            // 2. æ›´æ–°é è¦½å€çš„åŸºæœ¬æ¨£å¼
            previewArea.dataset.theme = selectedTheme;
            previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
            
            if (background && background.startsWith('data:image')) {
                previewArea.style.backgroundImage = `url(${background})`;
                previewArea.style.backgroundColor = 'transparent';
            } else {
                previewArea.style.backgroundImage = 'none';
                previewArea.style.background = background || '#f0f2f5';
            }
        
            // 3. æ¸²æŸ“æ¨¡æ“¬æ°£æ³¡
            previewArea.innerHTML = ''; 
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¾©1ï¼šåœ¨é€™è£¡ä½¿ç”¨ await ç­‰å¾…çµæœã€‘ã€‘ã€‘
            const aiMsg = { role: 'ai', content: 'å°æ–¹æ¶ˆæ¯é è¦½', timestamp: 1, senderName: chat.name };
            const aiBubble = await createMessageElement(aiMsg, chat); // <--- å¢åŠ äº† await
            if(aiBubble) previewArea.appendChild(aiBubble);
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¾©2ï¼šåœ¨é€™è£¡ä¹Ÿä½¿ç”¨ awaitã€‘ã€‘ã€‘
            const userMsg = { role: 'user', content: 'æˆ‘çš„æ¶ˆæ¯é è¦½', timestamp: 2 };
            const userBubble = await createMessageElement(userMsg, chat); // <--- å¢åŠ äº† await
            if(userBubble) previewArea.appendChild(userBubble);
            
            // å³æ™‚æ›´æ–°é è¦½å€æ­Œè©æ¬„ä½ç½® (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
            const previewLyricsBar = document.createElement('div');
            previewLyricsBar.style.cssText = `
                position: absolute; 
                font-size: 11px; 
                padding: 2px 6px; 
                border-radius: 8px; 
                background-color: rgba(0, 0, 0, 0.1); 
                color: var(--text-secondary); 
                white-space: nowrap; 
                transition: all 0.3s ease;
            `;
            previewLyricsBar.textContent = 'â™ª æ­Œè©ä½ç½®é è¦½ â™ª';
            previewArea.appendChild(previewLyricsBar);
            
            const vertical = document.getElementById('lyrics-vertical-pos').value;
            const horizontal = document.getElementById('lyrics-horizontal-pos').value;
            const offset = parseInt(document.getElementById('lyrics-offset-input').value) || 10;
        
            if (vertical === 'top') {
                previewLyricsBar.style.top = `${offset}px`;
            } else {
                previewLyricsBar.style.bottom = `${offset}px`;
            }
            
            switch (horizontal) {
                case 'left':
                    previewLyricsBar.style.left = '15px';
                    break;
                case 'right':
                    previewLyricsBar.style.right = '15px';
                    break;
                default:
                    previewLyricsBar.style.left = '50%';
                    previewLyricsBar.style.transform = 'translateX(-50%)';
                    break;
            }
            
            // 4. æ‡‰ç”¨è‡ªè¨‚CSSåˆ°é è¦½å€ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
            applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹å°‡é€™äº›ã€æ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        async function openGroupManager() {
            await renderGroupList();
            document.getElementById('group-management-modal').classList.add('visible');
        }
        
        async function renderGroupList() {
            const listEl = document.getElementById('existing-groups-list');
            const groups = await db.qzoneGroups.toArray();
            listEl.innerHTML = '';
            if (groups.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†çµ„</p>';
            }
            groups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'existing-group-item';
                item.innerHTML = `
                    <span class="group-name">${group.name}</span>
                    <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€ä¿®æ­£å¾Œã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ addNewGroup å‡½æ•¸ â–¼â–¼â–¼
        async function addNewGroup() {
            const input = document.getElementById('new-group-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('åˆ†çµ„åä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
        
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰ï¼Œå…ˆæª¢æŸ¥åˆ†çµ„åæ˜¯å¦å·²å­˜åœ¨
            const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
            if (existingGroup) {
                alert(`åˆ†çµ„ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼Œæ›å€‹åå­—å§ï¼`);
                return;
            }
            // ã€ä¿®æ­£çµæŸã€‘
        
            await db.qzoneGroups.add({ name });
            input.value = '';
            await renderGroupList();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        async function deleteGroup(groupId) {
            const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'åˆªé™¤åˆ†çµ„å¾Œï¼Œè©²çµ„å…§çš„å¥½å‹å°‡è®Šç‚ºâ€œæœªåˆ†çµ„â€ã€‚ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.qzoneGroups.delete(groupId);
                // å°‡å±¬æ–¼è©²åˆ†çµ„çš„å¥½å‹çš„ groupId è¨­ç‚º null
                const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
                for (const chat of chatsToUpdate) {
                    chat.groupId = null;
                    await db.chats.put(chat);
                    if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
                }
                await renderGroupList();
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€çš„æœ«å°¾ â–¼â–¼â–¼
        
        /**
         * ç•¶é•·æŒ‰æ¶ˆæ¯æ™‚ï¼Œé¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨
         * @param {number} timestamp - è¢«é•·æŒ‰æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        function showMessageActions(timestamp) {
        // â–¼â–¼â–¼ åœ¨é€™è£¡æ–°å¢ â–¼â–¼â–¼
        const chat = state.chats[state.activeChatId];
        document.getElementById('publish-to-announcement-btn').style.display = chat.isGroup ? 'block' : 'none';
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
            // å¦‚æœå·²ç¶“åœ¨å¤šé¸æ¨¡å¼ï¼Œå‰‡ä¸å½ˆå‡ºèœå–®
            if (isSelectionMode) return;
            
            activeMessageTimestamp = timestamp;
            document.getElementById('message-actions-modal').classList.add('visible');
        }
        
        /**
         * éš±è—æ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨
         */
        function hideMessageActions() {
            document.getElementById('message-actions-modal').classList.remove('visible');
            activeMessageTimestamp = null;
        }
        
        // â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ›èˆŠçš„ openMessageEditor å‡½æ•¸ â–¼â–¼â–¼
        async function openMessageEditor() {
            if (!activeMessageTimestamp) return;
        
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideMessageActions(); 
        
            let contentForEditing;
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°‡ share_link ä¹ŸåŠ å…¥ç‰¹æ®Šé¡å‹åˆ¤æ–·
            const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);
        
            if (isSpecialType) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
                else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                } 
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘è™•ç†åˆ†äº«é€£çµé¡å‹çš„æ¶ˆæ¯
                else if (message.type === 'share_link') {
                    fullMessageObject.title = message.title;
                    fullMessageObject.description = message.description;
                    fullMessageObject.source_name = message.source_name;
                    fullMessageObject.content = message.content;
                }
                contentForEditing = JSON.stringify(fullMessageObject, null, 2);
            } else if (typeof message.content === 'object') {
                contentForEditing = JSON.stringify(message.content, null, 2);
            } else {
                contentForEditing = message.content;
            }
        
            // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡æ·»åŠ  'link' ç¯„æœ¬
            const templates = {
                voice: { type: 'voice_message', content: 'åœ¨é€™è£¡è¼¸å…¥èªéŸ³å…§å®¹' },
                image: { type: 'ai_image', description: 'åœ¨é€™è£¡è¼¸å…¥åœ–ç‰‡æè¿°' },
                transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€é»å¿ƒæ„' },
                link: { type: 'share_link', title: 'æ–‡ç« æ¨™é¡Œ', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'ä¾†æºç¶²ç«™', content: 'æ–‡ç« å®Œæ•´å…§å®¹...' }
            };
        
            // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨é€™è£¡æ·»åŠ æ–°çš„â€œé€£çµâ€æŒ‰éˆ•
            const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>èªéŸ³</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>åœ–ç‰‡</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½‰å¸³</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é€£çµ</button>
                </div>
            `;
        
            const newContent = await showCustomPrompt(
                'ç·¨è¼¯æ¶ˆæ¯', 
                'åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä½¿ç”¨æ ¼å¼ç¯„æœ¬...',
                contentForEditing, 
                'textarea',
                helpersHtml
            );
        
            if (newContent !== null) {
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€™è£¡èª¿ç”¨çš„æ‡‰è©²æ˜¯ saveEditedMessageï¼Œè€Œä¸æ˜¯ saveAdvancedEditor
                await saveEditedMessage(timestampToEdit, newContent, true);
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * è¤‡è£½æ¶ˆæ¯çš„æ–‡æœ¬å…§å®¹åˆ°å‰ªè²¼æ¿
         */
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            let textToCopy;
            if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
        
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('è¤‡è£½æˆåŠŸ', 'æ¶ˆæ¯å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚');
            } catch (err) {
                await showCustomAlert('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ã€‚');
            }
            
            hideMessageActions();
        }
        
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹æ–°å‡½æ•¸é»è²¼åˆ° copyMessageContent å‡½æ•¸çš„å¾Œé¢ â–¼â–¼â–¼
/**
 * è¤‡è£½æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜åˆ°å‰ªè²¼æ¿
 */
async function copyMessageTimestamp() {
    if (!activeMessageTimestamp) return;

    try {
        await navigator.clipboard.writeText(activeMessageTimestamp);
        await showCustomAlert('è¤‡è£½æˆåŠŸ', `æ¶ˆæ¯æ™‚é–“æˆ³è¨˜ ${activeMessageTimestamp} å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚`);
    } catch (err) {
        await showCustomAlert('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ã€‚');
    }
    
    hideMessageActions();
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²æ·»åŠ â€œå¼•ç”¨â€ç¯„æœ¬çš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ createMessageEditorBlock å‡½æ•¸ â–¼â–¼â–¼
/**
 * å‰µå»ºä¸€å€‹å¯ç·¨è¼¯çš„æ¶ˆæ¯å¡Šï¼ˆåŒ…å«æ–‡å­—æ–¹å¡Šã€æ ¼å¼åŠ©æ‰‹å’Œåˆªé™¤æŒ‰éˆ•ï¼‰
 * @param {string} initialContent - æ–‡å­—æ–¹å¡Šçš„åˆå§‹å…§å®¹
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡æ·»åŠ  'quote' ç¯„æœ¬
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨é€™è£¡è¼¸å…¥èªéŸ³å…§å®¹' },
        image: { type: 'ai_image', description: 'åœ¨é€™è£¡è¼¸å…¥åœ–ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€é»å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ¨™é¡Œ', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'ä¾†æºç¶²ç«™', content: 'æ–‡ç« å®Œæ•´å…§å®¹...' },
        offline: { type: 'offline_text', content: 'ã€Œåœ¨é€™è£¡è¼¸å…¥å°è©±å…§å®¹ã€\n(åœ¨é€™è£¡è¼¸å…¥å‹•ä½œæˆ–ç’°å¢ƒæå¯«)' },
        quote: { type: 'quote_reply', target_timestamp: 1234567890, reply_content: 'åœ¨é€™è£¡è¼¸å…¥å›å¾©å…§å®¹' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆªé™¤æ­¤æ¢">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>èªéŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>åœ–ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½‰å¸³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é€£çµ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>ç·šä¸‹</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨é€™è£¡æ·»åŠ æ–°çš„â€œå¼•ç”¨â€æŒ‰éˆ• -->
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>å¼•ç”¨</button>
        </div>
    `;

    // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // ç¢ºä¿è‡³å°‘ä¿ç•™ä¸€å€‹ç·¨è¼¯å¡Š
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¢æ¶ˆæ¯ã€‚');
        }
    });

    // ç¶å®šæ ¼å¼åŠ©æ‰‹æŒ‰éˆ•äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼ç¯„æœ¬å¤±æ•—:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ openAdvancedMessageEditor å‡½æ•¸ â–¼â–¼â–¼
        /**
         * æ‰“é–‹å…¨æ–°çš„ã€è¦–è¦ºåŒ–çš„å¤šæ¶ˆæ¯ç·¨è¼¯å™¨ï¼Œä¸¦å‹•æ…‹ç¹«çµå…¶æ‰€æœ‰æŒ‰éˆ•äº‹ä»¶
         */
        function openAdvancedMessageEditor() {
            if (!activeMessageTimestamp) return;
        
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideMessageActions(); 
        
            const editorModal = document.getElementById('message-editor-modal');
            const editorContainer = document.getElementById('message-editor-container');
            editorContainer.innerHTML = ''; 
        
            let initialContent;
            
            // ==========================================================
            //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©å¾é€™è£¡é–‹å§‹ â˜…â˜…â˜…
            // ==========================================================
            
            // æ­¥é©Ÿ1ï¼šæª¢æŸ¥é€™æ¢æ¶ˆæ¯æ˜¯å¦æ˜¯ä¸€å€‹â€œå¼•ç”¨å›å¾©â€
            if (message.quote) {
                // å¦‚æœæ˜¯ï¼Œå°±æ‰‹å‹•æ§‹å»ºä¸€å€‹å®Œæ•´çš„ quote_reply ç‰©ä»¶
                const quoteReplyObject = {
                    type: 'quote_reply',
                    target_timestamp: message.quote.timestamp,
                    reply_content: message.content // æ‚¨çš„å›å¾©å…§å®¹
                };
                // å°‡é€™å€‹å®Œæ•´çš„ç‰©ä»¶è½‰æ›ç‚ºæ ¼å¼åŒ–çš„JSONå­—ä¸²ï¼Œä½œç‚ºç·¨è¼¯å™¨çš„åˆå§‹å…§å®¹
                initialContent = JSON.stringify(quoteReplyObject, null, 2);
            } 
            // æ­¥é©Ÿ2ï¼šå¦‚æœä¸æ˜¯å¼•ç”¨å›å¾©ï¼Œå†åŸ·è¡ŒåŸä¾†çš„ç‰¹æ®Šé¡å‹åˆ¤æ–·
            else if (message.type && ['voice_message', 'ai_image', 'transfer', 'offline_text', 'share_link'].includes(message.type)) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
                else if (message.type === 'ai_image') fullMessageObject.description = message.content;
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                } 
                else if (message.type === 'offline_text') {
                    if (message.content) {
                        fullMessageObject.content = message.content;
                    } else { 
                        fullMessageObject.dialogue = message.dialogue;
                        fullMessageObject.description = message.description;
                    }
                }
                else if (message.type === 'share_link') {
                    fullMessageObject.title = message.title;
                    fullMessageObject.description = message.description;
                    fullMessageObject.source_name = message.source_name;
                    fullMessageObject.content = message.content;
                }
                initialContent = JSON.stringify(fullMessageObject, null, 2);
            } 
            // æ­¥é©Ÿ3ï¼šè™•ç†å…¶ä»–æ‰€æœ‰æ™®é€šæƒ…æ³
            else if (typeof message.content === 'object') {
                initialContent = JSON.stringify(message.content, null, 2);
            } else {
                initialContent = message.content;
            }
        
            // ==========================================================
            //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©åˆ°æ­¤çµæŸ â˜…â˜…â˜…
            // ==========================================================
        
            const firstBlock = createMessageEditorBlock(initialContent);
            editorContainer.appendChild(firstBlock);
        
            // (å¾ŒçºŒçš„æŒ‰éˆ•ç¶å®šé‚è¼¯ä¿æŒä¸è®Š)
            const addBtn = document.getElementById('add-message-editor-block-btn');
            const newAddBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(newAddBtn, addBtn);
            newAddBtn.addEventListener('click', () => {
                const newBlock = createMessageEditorBlock();
                editorContainer.appendChild(newBlock);
                newBlock.querySelector('textarea').focus();
            });
        
            const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.addEventListener('click', () => {
                editorModal.classList.remove('visible');
            });
        
            const saveBtn = document.getElementById('save-advanced-editor-btn');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.addEventListener('click', () => {
                saveEditedMessage(timestampToEdit); 
            });
        
            editorModal.classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        /**
         * è¤‡è£½æ¶ˆæ¯çš„æ–‡æœ¬å…§å®¹åˆ°å‰ªè²¼æ¿
         */
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            let textToCopy;
            // ã€ã€ã€æ ¸å¿ƒä¿®å¾©3ï¼šåœ¨é€™è£¡ä¹Ÿæ·»åŠ å° offline_text çš„åˆ¤æ–·ã€‘ã€‘ã€‘
            if (message.type === 'offline_text') {
                // å¦‚æœæ˜¯æ–°æ ¼å¼ï¼Œç›´æ¥è¤‡è£½content
                if (message.content) {
                    textToCopy = message.content;
                } else { // ç›¸å®¹èˆŠæ ¼å¼
                    textToCopy = `ã€Œ${message.dialogue || ''}ã€\n${message.description || ''}`;
                }
            } else if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
        
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('è¤‡è£½æˆåŠŸ', 'æ¶ˆæ¯å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚');
            } catch (err) {
                await showCustomAlert('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ã€‚');
            }
            
            hideMessageActions();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * è§£æç·¨è¼¯å¾Œçš„æ–‡æœ¬ï¼Œä¸¦è¿”å›ä¸€å€‹æ¨™æº–åŒ–çš„æ¶ˆæ¯ç‰‡æ®µç‰©ä»¶
         * @param {string} text - ç”¨æˆ¶åœ¨ç·¨è¼¯æ–¹å¡Šä¸­è¼¸å…¥çš„æ–‡æœ¬
         * @returns {object} - ä¸€å€‹åŒ…å« type, content, ç­‰å±¬æ€§çš„ç‰©ä»¶
         */
        function parseEditedContent(text) {
            const trimmedText = text.trim();
        
            // 1. å˜—è©¦è§£æç‚ºJSONç‰©ä»¶ï¼ˆç”¨æ–¼ä¿®å¾©èªéŸ³ã€è½‰å¸³ç­‰æ ¼å¼ï¼‰
            if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmedText);
                    // å¿…é ˆåŒ…å« type å±¬æ€§æ‰èªç‚ºæ˜¯æœ‰æ•ˆæ ¼å¼
                    if (parsed.type) {
                        return parsed;
                    }
                } catch (e) { /* è§£æå¤±æ•—ï¼Œç¹¼çºŒå¾€ä¸‹èµ° */ }
            }
            
            // 2. å˜—è©¦è§£æç‚ºè¡¨æƒ…åŒ…
            if (STICKER_REGEX.test(trimmedText)) {
                // å°æ–¼ç·¨è¼¯çš„è¡¨æƒ…ï¼Œæˆ‘å€‘æš«æ™‚ç„¡æ³•çŸ¥é“å…¶`meaning`ï¼Œæ‰€ä»¥åªå­˜URL
                return { type: 'sticker', content: trimmedText };
            }
        
            // 3. å¦å‰‡ï¼Œè¦–ç‚ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
            return { type: 'text', content: trimmedText };
        }
        
        
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ saveEditedMessage å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V4.0 | çµ‚æ¥µä¿®å¾©ç‰ˆã€‘ä¿å­˜ç·¨è¼¯æˆ–æ‹†åˆ†å¾Œçš„æ¶ˆæ¯ï¼Œä¸¦æ­£ç¢ºè™•ç†é¡å‹è½‰æ›
 * @param {number} timestamp - è¢«ç·¨è¼¯çš„åŸå§‹æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @param {string|null} simpleContent - (å¯é¸) å¦‚æœæ˜¯å¾ç°¡å–®ç·¨è¼¯å™¨å‚³ä¾†ï¼Œå‰‡ç‚ºå–®å€‹å…§å®¹å­—ä¸²
 */
async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;
    
    // 1. ç²å–åŸå§‹æ¶ˆæ¯çš„å®Œæ•´ç‰©ä»¶ï¼Œé€™æ˜¯ç¹¼æ‰¿ç™¼é€è€…ã€æ™‚é–“æˆ³è¨˜ç­‰åŸºç¤å±¬æ€§çš„é—œéµ
    const originalMessage = chat.history[messageIndex];

    let newMessages = [];

    // æ ¹æ“šæ˜¯ä¾†è‡ªç°¡å–®ç·¨è¼¯å™¨é‚„æ˜¯é«˜ç´šç·¨è¼¯å™¨ï¼Œç²å–å…§å®¹å¡Š
    const blocks = simpleContent !== null 
        ? [simpleContent] 
        : Array.from(document.querySelectorAll('#message-editor-container textarea')).map(ta => ta.value);

    for (const rawContent of blocks) {
        if (!rawContent.trim()) continue;

        // ä½¿ç”¨è¼”åŠ©å‡½æ•¸è§£ææ¯å€‹ç·¨è¼¯æ–¹å¡Šçš„å…§å®¹
        const parsedResult = parseEditedContent(rawContent.trim());
        
        // 2. ã€ã€ã€é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ã€‘ã€‘ã€‘
        //    å…ˆå‰µå»ºä¸€å€‹éš»åŒ…å«æœ€åŸºç¤å±¬æ€§çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è¤‡è£½ï¼
        const newMessage = {
            role: originalMessage.role,
            senderName: originalMessage.senderName,
            timestamp: originalMessage.timestamp // æ™‚é–“æˆ³è¨˜å°‡åœ¨å¾Œé¢è¢«é‡æ–°åˆ†é…
        };

        // 3. æ ¹æ“šè§£æå‡ºçš„æ–°é¡å‹ï¼Œæ™ºæ…§åœ°æ§‹å»ºæ–°çš„æ¶ˆæ¯ç‰©ä»¶
        //    é€™ç¢ºä¿äº†èˆŠçš„ã€ä¸ç›¸é—œçš„å±¬æ€§ï¼ˆå¦‚ .quote, .amount ç­‰ï¼‰ä¸æœƒè¢«éŒ¯èª¤åœ°ç¹¼æ‰¿
        switch (parsedResult.type) {
            case 'text':
                newMessage.type = 'text';
                newMessage.content = parsedResult.content;
                break;
            case 'offline_text':
                newMessage.type = 'offline_text';
                if (parsedResult.content) {
                    newMessage.content = parsedResult.content;
                } else { 
                    newMessage.dialogue = parsedResult.dialogue;
                    newMessage.description = parsedResult.description;
                }
                break;
            case 'quote_reply':
                newMessage.type = 'quote_reply';
                newMessage.content = parsedResult.reply_content;
                const originalQuotedMsg = chat.history.find(m => m.timestamp === parsedResult.target_timestamp);
                if (originalQuotedMsg) {
                    let originalSenderName = originalQuotedMsg.senderName;
                    if (originalQuotedMsg.role === 'user') {
                        originalSenderName = state.qzoneSettings.nickname || '{{user}}';
                    }
                    newMessage.quote = {
                        timestamp: parsedResult.target_timestamp,
                        senderName: originalSenderName,
                        content: String(originalQuotedMsg.content || '')
                    };
                } else {
                    newMessage.quote = {
                        timestamp: parsedResult.target_timestamp,
                        senderName: 'æœªçŸ¥ç”¨æˆ¶',
                        content: 'åŸå§‹æ¶ˆæ¯å·²åˆªé™¤æˆ–ä¸å­˜åœ¨'
                    };
                }
                break;
            case 'voice_message':
            case 'sticker':
            case 'ai_image':
            case 'user_photo':
                newMessage.type = parsedResult.type;
                newMessage.content = parsedResult.content || parsedResult.description;
                if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
                break;
            case 'transfer':
                newMessage.type = 'transfer';
                newMessage.amount = parsedResult.amount;
                newMessage.note = parsedResult.note;
                break;
            case 'share_link':
                newMessage.type = 'share_link';
                newMessage.title = parsedResult.title;
                newMessage.description = parsedResult.description;
                newMessage.source_name = parsedResult.source_name;
                newMessage.content = parsedResult.content;
                break;
            default:
                // å°æ–¼å…¶ä»–æ‰€æœ‰æœªçŸ¥æˆ–è¤‡é›œçš„é¡å‹ï¼Œç›´æ¥å°‡è§£æçµæœä½œç‚ºæ¶ˆæ¯ä¸»é«”
                Object.assign(newMessage, parsedResult);
                break;
        }
        
        newMessages.push(newMessage);
    }
    
    if (newMessages.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return;
    }

    // 4. (å¾ŒçºŒçš„æ›¿æ›ã€é‡æ’æ™‚é–“æˆ³è¨˜ã€ä¿å­˜å’Œåˆ·æ–°é‚è¼¯ä¿æŒä¸è®Š)
    //    ç”¨æ–°æ§‹å»ºçš„æ¶ˆæ¯é™£åˆ—æ›¿æ›æ‰åŸä¾†çš„é‚£æ¢æ¶ˆæ¯
    chat.history.splice(messageIndex, 1, ...newMessages);
    
    // é‡æ–°åˆ†é…æ™‚é–“æˆ³è¨˜ä»¥ä¿è­‰é †åº
    let reassignTimestamp = timestamp;
    for (let i = messageIndex; i < chat.history.length; i++) {
        chat.history[i].timestamp = reassignTimestamp;
        reassignTimestamp++; 
    }
    
    await db.chats.put(chat);
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°ï¼');
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹å°‡é€™ã€ä¸€æ•´å¡Šæ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€çš„æœ«å°¾ â–¼â–¼â–¼
        
        /**
         * ç•¶é»æ“Šâ€œâ€¦â€æ™‚ï¼Œé¡¯ç¤ºå‹•æ…‹æ“ä½œåŠŸèƒ½è¡¨
         * @param {number} postId - è¢«æ“ä½œçš„å‹•æ…‹çš„ID
         */
        function showPostActions(postId) {
            activePostId = postId;
            document.getElementById('post-actions-modal').classList.add('visible');
        }
        
        /**
         * éš±è—å‹•æ…‹æ“ä½œåŠŸèƒ½è¡¨
         */
        function hidePostActions() {
            document.getElementById('post-actions-modal').classList.remove('visible');
            activePostId = null;
        }
        
        /**
         * æ‰“é–‹å‹•æ…‹ç·¨è¼¯å™¨
         */
        async function openPostEditor() {
            if (!activePostId) return;
        
            const postIdToEdit = activePostId;
            const post = await db.qzonePosts.get(postIdToEdit);
            if (!post) return;
        
            hidePostActions();
        
            // å¿ æ–¼åŸæ–‡ï¼šæ§‹å»ºå‡ºæœ€åŸå§‹çš„æ–‡æœ¬å½¢æ…‹ä¾›ç·¨è¼¯
            let contentForEditing;
            if (post.type === 'shuoshuo') {
                contentForEditing = post.content;
            } else {
                // å°æ–¼åœ–ç‰‡å’Œæ–‡å­—åœ–ï¼Œæˆ‘å€‘æ§‹å»ºä¸€å€‹åŒ…å«æ‰€æœ‰è³‡è¨Šçš„ç‰©ä»¶
                const postObject = {
                    type: post.type,
                    publicText: post.publicText || '',
                };
                if (post.type === 'image_post') {
                    postObject.imageUrl = post.imageUrl;
                    postObject.imageDescription = post.imageDescription;
                } else if (post.type === 'text_image') {
                    postObject.hiddenContent = post.hiddenContent;
                }
                contentForEditing = JSON.stringify(postObject, null, 2);
            }
            
            // æ§‹å»ºæ ¼å¼åŠ©æ‰‹æŒ‰éˆ•
            const templates = {
                shuoshuo: "åœ¨é€™è£¡è¼¸å…¥èªªèªªçš„å…§å®¹...", // å°æ–¼èªªèªªï¼Œæˆ‘å€‘ç›´æ¥æ›¿æ›ç‚ºç´”æ–‡å­—
                image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
                text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
            };
            
            const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-type="text">èªªèªª</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>åœ–ç‰‡å‹•æ…‹</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>æ–‡å­—åœ–</button>
                </div>
            `;
        
            const newContent = await showCustomPrompt(
                'ç·¨è¼¯å‹•æ…‹',
                'åœ¨æ­¤ä¿®æ”¹å…§å®¹...',
                contentForEditing,
                'textarea',
                helpersHtml
            );
            
            // ã€ç‰¹æ®Šè™•ç†ã€‘ç‚ºèªªèªªçš„æ ¼å¼åŠ©æ‰‹æŒ‰éˆ•æ·»åŠ ä¸åŒçš„è¡Œç‚º
            // æˆ‘å€‘éœ€è¦åœ¨æ¨¡æ…‹æ¡†å‡ºç¾å¾Œï¼Œå†çµ¦å®ƒç¶å®šäº‹ä»¶
            setTimeout(() => {
                const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
                if(shuoshuoBtn) {
                    shuoshuoBtn.addEventListener('click', () => {
                        const input = document.getElementById('custom-prompt-input');
                        input.value = templates.shuoshuo;
                        input.focus();
                    });
                }
            }, 100);
        
            if (newContent !== null) {
                await saveEditedPost(postIdToEdit, newContent);
            }
        }
        
        /**
         * ä¿å­˜ç·¨è¼¯å¾Œçš„å‹•æ…‹
         * @param {number} postId - è¦ä¿å­˜çš„å‹•æ…‹ID
         * @param {string} newRawContent - å¾ç·¨è¼¯å™¨ç²å–çš„æ–°å…§å®¹
         */
        async function saveEditedPost(postId, newRawContent) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
        
            const trimmedContent = newRawContent.trim();
            
            // å˜—è©¦è§£æç‚ºJSONï¼Œå¦‚æœå¤±æ•—ï¼Œå‰‡èªç‚ºæ˜¯ç´”æ–‡å­—ï¼ˆèªªèªªï¼‰
            try {
                const parsed = JSON.parse(trimmedContent);
                // æ›´æ–°å¸–å­å±¬æ€§
                post.type = parsed.type || 'image_post';
                post.publicText = parsed.publicText || '';
                post.imageUrl = parsed.imageUrl || '';
                post.imageDescription = parsed.imageDescription || '';
                post.hiddenContent = parsed.hiddenContent || '';
                post.content = ''; // æ¸…ç©ºèˆŠçš„èªªèªªå…§å®¹æ¬„ä½
            } catch (e) {
                // è§£æå¤±æ•—ï¼Œèªç‚ºæ˜¯èªªèªª
                post.type = 'shuoshuo';
                post.content = trimmedContent;
                // æ¸…ç©ºå…¶ä»–é¡å‹çš„æ¬„ä½
                post.publicText = '';
                post.imageUrl = '';
                post.imageDescription = '';
                post.hiddenContent = '';
            }
            
            await db.qzonePosts.put(post);
            await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            await showCustomAlert('æˆåŠŸ', 'å‹•æ…‹å·²æ›´æ–°ï¼');
        }
        
        /**
         * è¤‡è£½å‹•æ…‹å…§å®¹
         */
        async function copyPostContent() {
            if (!activePostId) return;
            const post = await db.qzonePosts.get(activePostId);
            if (!post) return;
            
            let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ï¼ˆç„¡æ–‡å­—å…§å®¹ï¼‰";
            
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('è¤‡è£½æˆåŠŸ', 'å‹•æ…‹å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚');
            } catch (err) {
                await showCustomAlert('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ã€‚');
            }
            
            hidePostActions();
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰µå»ºç¾¤èŠèˆ‡æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        let selectedContacts = new Set();
        
        async function openContactPickerForGroupCreate() {
    // å½ˆå‡ºé¸æ“‡åŠŸèƒ½è¡¨ï¼Œè®“ä½¿ç”¨è€…æ±ºå®šå‰µå»ºå“ªç¨®ç¾¤èŠ
    const choice = await showChoiceModal('å‰µå»ºç¾¤èŠ', [
        { text: 'å‰µå»ºæ™®é€šç¾¤èŠ (æˆ‘åƒèˆ‡)', value: 'normal' },
        { text: 'å‰µå»ºæ—è§€ç¾¤èŠ (æˆ‘åœè§€)', value: 'spectator' }
    ]);

    if (choice === 'normal') {
        // å¦‚æœé¸æ“‡æ™®é€šç¾¤èŠï¼ŒåŸ·è¡ŒèˆŠçš„é‚è¼¯
        selectedContacts.clear();
        const confirmBtn = document.getElementById('confirm-contact-picker-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', handleCreateGroup);
        await renderContactPicker();
        showScreen('contact-picker-screen');

    } else if (choice === 'spectator') {
        // å¦‚æœé¸æ“‡æ—è§€ç¾¤èŠï¼ŒåŸ·è¡Œæ–°çš„é‚è¼¯
        openSpectatorGroupCreator();
    }
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ—è§€æ¨¡å¼ç¾¤èŠå‰µå»ºåŠŸèƒ½çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹â€œæ—è§€æ¨¡å¼ç¾¤èŠâ€çš„æˆå“¡é¸æ“‡å™¨
 */
async function openSpectatorGroupCreator() {
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡çš„é¸æ“‡

    // 1. ä¿®æ”¹â€œå®Œæˆâ€æŒ‰éˆ•çš„è¡Œç‚ºï¼Œè®“å®ƒåœ¨é»æ“Šå¾Œèª¿ç”¨æˆ‘å€‘æ–°çš„å‰µå»ºå‡½æ•¸
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleCreateSpectatorGroup);

    // 2. æ¸²æŸ“ä¸€å€‹åŒ…å«æ‰€æœ‰è§’è‰²å’ŒNPCçš„é€£çµ¡äººåˆ—è¡¨
    await renderSpectatorContactPicker();

    // 3. åˆ‡æ›åˆ°é€£çµ¡äººé¸æ“‡è¢å¹•
    showScreen('contact-picker-screen');
}

/**
 * ã€å…¨æ–°ã€‘ç‚ºâ€œæ—è§€æ¨¡å¼â€æ¸²æŸ“ä¸€å€‹ç‰¹æ®Šçš„é€£çµ¡äººåˆ—è¡¨ï¼ŒåŒ…å«æ‰€æœ‰è§’è‰²å’ŒNPC
 */
async function renderSpectatorContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // a. ç²å–æ‰€æœ‰å–®èŠè§’è‰²
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);
    // b. å¾è³‡æ–™åº«ç²å–æ‰€æœ‰NPC
    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">é‚„æ²’æœ‰ä»»ä½•è§’è‰²æˆ–NPCå¯ä»¥åŠ å…¥ç¾¤èŠã€‚</p>';
        return;
    }

    // c. æ¸²æŸ“è§’è‰²åˆ—è¡¨
    characters.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id; // ä½¿ç”¨è§’è‰²çš„èŠå¤©ID
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(è§’è‰²)</small></span>
        `;
        listEl.appendChild(item);
    });

    // d. æ¸²æŸ“NPCåˆ—è¡¨
    npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = npc.id; // ä½¿ç”¨NPCçš„ID
        item.dataset.isNpc = "true";     // æ·»åŠ ä¸€å€‹ç‰¹æ®Šæ¨™è¨˜
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†å‰µå»ºâ€œæ—è§€æ¨¡å¼ç¾¤èŠâ€çš„æœ€çµ‚é‚è¼¯
 */
async function handleCreateSpectatorGroup() {
    if (selectedContacts.size < 2) {
        alert("æ—è§€ç¾¤èŠè‡³å°‘éœ€è¦é¸æ“‡2å€‹æˆå“¡ã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è¨­ç½®ç¾¤å', 'è«‹è¼¸å…¥ç¾¤èŠçš„åå­—', 'AIå€‘çš„èŒ¶è©±æœƒ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray(); // æå‰ç²å–æ‰€æœ‰NPCè³‡æ–™

    for (const contactId of selectedContacts) {
        const isNpc = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`).dataset.isNpc === "true";

        if (isNpc) {
            // å¦‚æœæ˜¯NPC
            const npcData = allNpcs.find(n => n.id === parseInt(contactId));
            if (npcData) {
                members.push({
                    id: `npc_${npcData.id}`, // çµ¦NPCä¸€å€‹ç¨ç‰¹çš„æˆå“¡ID
                    originalName: npcData.name,
                    groupNickname: npcData.name,
                    persona: npcData.persona,
                    avatar: npcData.avatar || defaultGroupMemberAvatar,
                    isNpc: true
                });
            }
        } else {
            // å¦‚æœæ˜¯æ™®é€šè§’è‰²
            const contactChat = state.chats[contactId];
            if (contactChat) {
                members.push({
                    id: contactId,
                    originalName: contactChat.originalName,
                    groupNickname: contactChat.name,
                    persona: contactChat.settings.aiPersona,
                    avatar: contactChat.settings.aiAvatar || defaultAvatar,
                    isNpc: false
                });
            }
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        isSpectatorGroup: true, // â˜…â˜…â˜… é€™å°±æ˜¯æˆ‘å€‘çš„æ ¸å¿ƒæ¨™è¨˜ï¼â˜…â˜…â˜…
        members: members,
        settings: {
            // åœ¨æ—è§€æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘ä¸éœ€è¦â€œæˆ‘â€çš„äººè¨­å’Œé ­åƒ
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
        },
        history: [{ // æ·»åŠ ä¸€æ¢åˆå§‹ç³»çµ±æ¶ˆæ¯ï¼Œå‘Šè¨´AIå®ƒå€‘çš„ä»»å‹™
            role: 'system',
            content: '[ç³»çµ±æŒ‡ä»¤ï¼šé€™æ˜¯ä¸€å€‹æ²’æœ‰ç”¨æˆ¶åƒèˆ‡çš„ç¾¤èŠï¼Œè«‹ä½ å€‘æ ¹æ“šå„è‡ªçš„äººè¨­è‡ªç”±åœ°é–‹å§‹å°è©±ã€‚]',
            timestamp: Date.now(),
            isHidden: true
        }],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);

    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId);
}
// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²        
/**
 * ã€å…¨æ–° | æ”¯æŒNPCã€‘æ¸²æŸ“ä¸€å€‹åŒ…å«æ‰€æœ‰å¯é¸é€£çµ¡äººï¼ˆè§’è‰²+NPCï¼‰çš„åˆ—è¡¨
 */
async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // 1. åŒæ™‚ç²å–æ‰€æœ‰å–®èŠè§’è‰²å’Œæ‰€æœ‰NPC
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);
    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">é‚„æ²’æœ‰å¯ä»¥æ‹‰é€²ç¾¤çš„é€£çµ¡äººå“¦~</p>';
        return;
    }

    // 2. æ¸²æŸ“è§’è‰²åˆ—è¡¨
    characters.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id; // ä½¿ç”¨è§’è‰²çš„èŠå¤©ID
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(è§’è‰²)</small></span>
        `;
        listEl.appendChild(item);
    });
    
    // 3. æ¸²æŸ“NPCåˆ—è¡¨
    npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        // ä½¿ç”¨ "npc_" é¦–ç¢¼å‰µå»ºå”¯ä¸€IDï¼Œä»¥ä¾¿å¾ŒçºŒå€åˆ†
        item.dataset.contactId = `npc_${npc.id}`; 
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}
        
        /**
         * æ›´æ–°â€œå®Œæˆâ€æŒ‰éˆ•çš„è¨ˆæ•¸
         */
        function updateContactPickerConfirmButton() {
            const btn = document.getElementById('confirm-contact-picker-btn');
            btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
            btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2å€‹äººæ‰èƒ½å‰µå»ºç¾¤èŠ
        }
        
/**
 * ã€å…¨æ–° | æ”¯æ´NPCã€‘è™•ç†å‰µå»ºç¾¤èŠçš„æœ€çµ‚é‚è¼¯
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("å‰µå»ºç¾¤èŠè‡³å°‘éœ€è¦é¸æ“‡2å€‹é€£çµ¡äººã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è¨­ç½®ç¾¤å', 'è«‹è¼¸å…¥ç¾¤èŠçš„åå­—', 'æˆ‘å€‘çš„ç¾¤èŠ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray(); // æå‰ç²å–æ‰€æœ‰NPCè³‡æ–™ï¼Œæé«˜æ•ˆç‡

    for (const contactId of selectedContacts) {
        // æª¢æŸ¥IDé¦–ç¢¼ï¼Œåˆ¤æ–·æ˜¯NPCé‚„æ˜¯è§’è‰²
        if (contactId.startsWith('npc_')) {
            const npcId = parseInt(contactId.replace('npc_', ''));
            const npcData = allNpcs.find(n => n.id === npcId);
            if (npcData) {
                members.push({
                    id: contactId, // ä¿ç•™å¸¶é¦–ç¢¼çš„å”¯ä¸€ID
                    originalName: npcData.name,
                    groupNickname: npcData.name,
                    persona: npcData.persona,
                    avatar: npcData.avatar || defaultGroupMemberAvatar,
                    isNpc: true // æ¨™è¨˜ç‚ºNPC
                });
            }
        } else { // å¦‚æœä¸æ˜¯NPCï¼Œå°±æ˜¯æ™®é€šè§’è‰²
            const contactChat = state.chats[contactId];
            if (contactChat) {
                members.push({
                    id: contactId,
                    originalName: contactChat.originalName,
                    groupNickname: contactChat.name,
                    persona: contactChat.settings.aiPersona,
                    avatar: contactChat.settings.aiAvatar || defaultAvatar,
                    isNpc: false // æ¨™è¨˜ç‚ºéNPC
                });
            }
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: 'æˆ‘æ˜¯èª°å‘€ã€‚',
            myNickname: 'æˆ‘',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå“¡ç®¡ç†æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹ç¾¤æˆå“¡ç®¡ç†è¢å¹•
         */
        function openMemberManagementScreen() {
            if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
            renderMemberManagementList();
            showScreen('member-management-screen');
        }
        
        function renderMemberManagementList() {
            const listEl = document.getElementById('member-management-list');
            const chat = state.chats[state.activeChatId];
            listEl.innerHTML = '';
        
            chat.members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'member-management-item';
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°‡é¡¯ç¤ºçš„åç¨±å¾ member.name æ”¹ç‚º member.groupNickname
                item.innerHTML = `
                    <img src="${member.avatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                    <button class="remove-member-btn" data-member-id="${member.id}" title="ç§»å‡ºç¾¤èŠ">-</button>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * å¾ç¾¤èŠä¸­ç§»é™¤ä¸€å€‹æˆå“¡
         * @param {string} memberId - è¦ç§»é™¤çš„æˆå“¡ID
         */
        async function removeMemberFromGroup(memberId) {
            const chat = state.chats[state.activeChatId];
            const memberIndex = chat.members.findIndex(m => m.id === memberId);
            
            if (memberIndex === -1) return;
            
            // å®‰å…¨æª¢æŸ¥ï¼Œç¾¤èŠè‡³å°‘ä¿ç•™2äºº
            if (chat.members.length <= 2) {
                alert("ç¾¤èŠäººæ•¸ä¸èƒ½å°‘æ–¼2äººã€‚");
                return;
            }
            
        const memberName = chat.members[memberIndex].groupNickname; // <-- ä¿®å¾©ï¼šä½¿ç”¨ groupNickname
            const confirmed = await showCustomConfirm(
                'ç§»å‡ºæˆå“¡',
                `ç¢ºå®šè¦å°‡â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                chat.members.splice(memberIndex, 1);
                await db.chats.put(chat);
                renderMemberManagementList(); // åˆ·æ–°æˆå“¡ç®¡ç†åˆ—è¡¨
                document.getElementById('chat-settings-btn').click(); // ã€æ ¸å¿ƒä¿®æ­£ã€‘é¡æ¯”é»æ“Šè¨­ç½®æŒ‰éˆ•ï¼Œå¼·åˆ¶åˆ·æ–°æ•´å€‹å½ˆçª—
            }
        }
        
/**
 * ã€ç¸½å…¥å£ | V2.0ã€‘æ‰“é–‹é€£çµ¡äººé¸æ“‡å™¨ï¼Œç”¨æ–¼æ‹‰äººå…¥ç¾¤ï¼ˆç¾åœ¨æœƒåŒæ™‚é¡¯ç¤ºè§’è‰²å’ŒNPCï¼‰
 */
async function openContactPickerForAddMember() {
    // 1. ç‚ºâ€œå®Œæˆâ€æŒ‰éˆ•ç¶å®šæ­£ç¢ºçš„è™•ç†å‡½æ•¸
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ï¼Œç¢ºä¿æ¯æ¬¡éƒ½ç¶å®šæœ€æ–°çš„äº‹ä»¶ï¼Œé˜²æ­¢é‡è¤‡åŸ·è¡Œ
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    // 2. æ¸²æŸ“ä¸€å€‹åŒ…å«æ‰€æœ‰å¯é¸é€£çµ¡äººçš„åˆ—è¡¨
    await renderUnifiedContactPicker();
    
    // 3. é¡¯ç¤ºé¸æ“‡å™¨è¢å¹•
    showScreen('contact-picker-screen');
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ä¸€å€‹çµ±ä¸€çš„é€£çµ¡äººé¸æ“‡åˆ—è¡¨ï¼ŒåŒ…å«è§’è‰²å’ŒNPC
 */
async function renderUnifiedContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡çš„é¸æ“‡

    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    // a. ç²å–æ‰€æœ‰å¯é¸çš„ â€œè§’è‰²â€ (æ’é™¤è‡ªå·±å’Œå·²åœ¨ç¾¤å…§çš„)
    const characters = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));
    
    // b. ç²å–æ‰€æœ‰å¯é¸çš„ â€œNPCâ€ (æ’é™¤å·²åœ¨ç¾¤å…§çš„)
    const npcs = (await db.npcs.toArray()).filter(n => !existingMemberIds.has(`npc_${n.id}`));

    if (characters.length === 0 && npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²’æœ‰æ›´å¤šå¯ä»¥é‚€è«‹çš„é€£çµ¡äººäº†ã€‚</p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none';
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        
        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        characters.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.dataset.contactType = 'character'; // æ¨™è¨˜ç‚ºè§’è‰²
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name} <small style="color:#888;">(è§’è‰²)</small></span>
            `;
            listEl.appendChild(item);
        });

        // æ¸²æŸ“NPCåˆ—è¡¨
        npcs.forEach(npc => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = `npc_${npc.id}`; // ä½¿ç”¨å¸¶é¦–ç¢¼çš„å”¯ä¸€ID
            item.dataset.contactType = 'npc'; // æ¨™è¨˜ç‚ºNPC
            item.dataset.npcId = npc.id; // ä¿å­˜åŸå§‹NPC ID
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
                <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
            `;
            listEl.appendChild(item);
        });
    }

    updateContactPickerConfirmButton();
}
        
// â–¼â–¼â–¼ ã€V2.1 | é ­åƒä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ handleAddMembersToGroup å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€æ ¸å¿ƒè™•ç† | V2.1ã€‘è™•ç†å°‡é¸ä¸­çš„é€£çµ¡äººï¼ˆè§’è‰²æˆ–NPCï¼‰åŠ å…¥ç¾¤èŠçš„é‚è¼¯
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦æ·»åŠ çš„é€£çµ¡äººã€‚");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    const allNpcs = await db.npcs.toArray(); // æå‰ç²å–æ‰€æœ‰NPCè³‡æ–™

    for (const contactId of selectedContacts) {
        const itemEl = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`);
        if (!itemEl) continue;

        const contactType = itemEl.dataset.contactType;

        if (contactType === 'character') {
            const contactChat = state.chats[contactId];
            if (contactChat) {
                chat.members.push({
                    id: contactId,
                    originalName: contactChat.originalName,
                    groupNickname: contactChat.name,
                    persona: contactChat.settings.aiPersona,
                    // ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¢ºä¿æ–°åŠ å…¥çš„è§’è‰²ä¹Ÿèƒ½ç²å–åˆ°æ­£ç¢ºçš„é ­åƒ
                    avatar: contactChat.settings.aiAvatar || defaultAvatar,
                    isNpc: false // æ¨™è¨˜é€™ä¸æ˜¯ä¸€å€‹ç´”NPC
                });
            }
        } else if (contactType === 'npc') {
            const npcId = parseInt(itemEl.dataset.npcId);
            const npcData = allNpcs.find(n => n.id === npcId);
            if (npcData) {
                // ã€ã€ã€é€™å°±æ˜¯æœ€é—œéµçš„ä¿®å¾©ï¼ã€‘ã€‘ã€‘
                // åœ¨é€™è£¡ï¼Œæˆ‘å€‘æŠŠ npcData.avatar ä¹Ÿä¸€ä½µæ·»åŠ åˆ°äº†æˆå“¡å°è±¡ä¸­
                chat.members.push({
                    id: `npc_${npcId}`,
                    originalName: npcData.name,
                    groupNickname: npcData.name,
                    persona: npcData.persona,
                    avatar: npcData.avatar || defaultGroupMemberAvatar, // <-- æ ¸å¿ƒæ–°å¢
                    isNpc: true
                });
            }
        }
    }

    await db.chats.put(chat);
    
    // æ“ä½œå®Œæˆå¾Œï¼Œè¿”å›æˆå“¡ç®¡ç†è¢å¹•
    openMemberManagementScreen();
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
/**
 * ã€é‡æ§‹ç‰ˆã€‘é»æ“Šâ€œå‰µå»ºæ–°æˆå“¡â€æŒ‰éˆ•ï¼Œç¾åœ¨æœƒæ‰“é–‹NPCç·¨è¼¯å™¨
 */
function createNewMemberInGroup() {
    // 1. è¨­ç½®ä¸€å€‹å…¨åŸŸæ¨™èªŒï¼Œå‘Šè¨´ saveNpc å‡½æ•¸æˆ‘å€‘ç•¶å‰çš„æ„åœ–
    isAddingNpcToGroup = true; 
    // 2. ç›´æ¥æ‰“é–‹é€šç”¨çš„NPCç·¨è¼¯å™¨
    openNpcEditor(null);
}

        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è³£è«‹æ±‚å€’è¨ˆæ™‚å‡½æ•¸ â–¼â–¼â–¼
        function startWaimaiCountdown(element, endTime) {
            const timerId = setInterval(() => {
                const now = Date.now();
                const distance = endTime - now;
        
                if (distance < 0) {
                    clearInterval(timerId);
                    element.innerHTML = '<span>å·²</span><span>è¶…</span><span>æ™‚</span>';
                    return;
                }
        
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                const minStr = String(minutes).padStart(2, '0');
                const secStr = String(seconds).padStart(2, '0');
        
                element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
            }, 1000);
            return timerId;
        }
        
        function cleanupWaimaiTimers() {
            for (const timestamp in waimaiTimers) {
                clearInterval(waimaiTimers[timestamp]);
            }
            waimaiTimers = {};
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ showWaimaiDetails å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–° V3.0 | æ˜µç¨±ä¿®å¾©ç‰ˆã€‘é¡¯ç¤ºå¤–è³£å¡ç‰‡çš„è©³ç´°è³‡è¨Š
 * @param {number} timestamp - è¢«é»æ“Šçš„å¤–è³£å¡ç‰‡æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
async function showWaimaiDetails(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    
    if (!message || !['waimai_request', 'waimai_order'].includes(message.type)) {
        console.error("showWaimaiDetails: æ‰¾ä¸åˆ°æ¶ˆæ¯æˆ–æ¶ˆæ¯é¡å‹ä¸æ­£ç¢º", timestamp);
        return;
    }
    
    let detailsHtml = '';

    if (message.type === 'waimai_request') {
        // (è™•ç†â€œä»£ä»˜è«‹æ±‚â€å¡ç‰‡çš„é‚è¼¯ä¿æŒä¸è®Š)
        let statusText;
        switch(message.status) {
            case 'paid':
                const payerName = message.paidBy || 'å°æ–¹';
                const payerDisplayName = getDisplayNameInGroup(chat, payerName);
                statusText = `ç”± ${payerDisplayName} ç‚ºæ‚¨ä»£ä»˜æˆåŠŸ`;
                break;
            case 'rejected':
                statusText = 'ä»£ä»˜è«‹æ±‚å·²è¢«æ‹’çµ•';
                break;
            default:
                statusText = 'ç­‰å¾…å°æ–¹è™•ç†';
                break;
        }
        detailsHtml = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>å•†å“:</strong> ${message.productInfo}<br>
                <strong>é‡‘é¡:</strong> Â¥${Number(message.amount).toFixed(2)}<br>
                <strong>ç‹€æ…‹:</strong> ${statusText}
            </div>
        `;
    } else if (message.type === 'waimai_order') {
        // --- æ ¸å¿ƒä¿®å¾©ï¼šæ™ºæ…§åˆ¤æ–·è´ˆé€æ–¹å’Œæ¥æ”¶æ–¹çš„é¡¯ç¤ºåç¨± ---
        let senderDisplayName;
        let recipientDisplayName;

        if (chat.isGroup) {
            // å¦‚æœæ˜¯ç¾¤èŠï¼Œçµ±ä¸€ä½¿ç”¨ getDisplayNameInGroup å‡½æ•¸ä¾†ç²å–æ­£ç¢ºçš„ç¾¤æ˜µç¨±
            senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
            recipientDisplayName = getDisplayNameInGroup(chat, message.recipientName);
        } else {
            // å¦‚æœæ˜¯å–®èŠï¼Œæ ¹æ“šæ¶ˆæ¯æ˜¯èª°ç™¼çš„ä¾†åˆ¤æ–·
            if (message.role === 'user') {
                // å¦‚æœæ˜¯ç”¨æˆ¶ç™¼çš„ï¼Œè´ˆé€æ–¹æ˜¯"æˆ‘"ï¼Œæ¥æ”¶æ–¹æ˜¯AI
                senderDisplayName = chat.settings.myNickname || 'æˆ‘';
                recipientDisplayName = chat.name; // chat.name å°±æ˜¯AIçš„å‚™è¨»å
            } else {
                // å¦‚æœæ˜¯AIç™¼çš„ï¼Œè´ˆé€æ–¹æ˜¯AIï¼Œæ¥æ”¶æ–¹æ˜¯"æˆ‘"
                senderDisplayName = chat.name;
                recipientDisplayName = chat.settings.myNickname || 'æˆ‘';
            }
        }
        // --- ä¿®å¾©çµæŸ ---

        detailsHtml = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>è¨‚å–®é¡å‹:</strong> ç‚ºTAé»å–®<br>
                <strong>è´ˆé€æ–¹:</strong> ${senderDisplayName}<br>
                <strong>æ¥æ”¶æ–¹:</strong> ${recipientDisplayName}<br>
                <strong>å•†å“:</strong> ${message.productInfo}<br>
                <strong>é‡‘é¡:</strong> Â¥${Number(message.amount).toFixed(2)}
            </div>
        `;
    }

    await showCustomAlert("è¨‚å–®è©³æƒ…", detailsHtml);
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        async function handleWaimaiResponse(originalTimestamp, choice) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°åŸå§‹æ¶ˆæ¯çš„ç‹€æ…‹
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘è¨˜éŒ„æ”¯ä»˜è€…ï¼Œä¸¦æ§‹å»ºå°AIæ›´æ¸…æ™°çš„ç³»çµ±æ¶ˆæ¯
            let systemContent;
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            if (choice === 'paid') {
                originalMessage.paidBy = myNickname; // è¨˜éŒ„æ˜¯ä½¿ç”¨è€…ä»˜çš„éŒ¢
                systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) ç‚º ${originalMessage.senderName} çš„å¤–è³£è¨‚å–®ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è¨‚å–®å·²é—œé–‰ï¼Œå…¶ä»–æˆå“¡ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
            } else {
                systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) æ‹’çµ•äº† ${originalMessage.senderName} çš„å¤–è³£ä»£ä»˜è«‹æ±‚ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰ã€‚]`;
            }
        
            // 2. å‰µå»ºä¸€æ¢æ–°çš„ã€å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIçµæœ
            const systemNote = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(systemNote);
        
            // 3. ä¿å­˜æ›´æ–°åˆ°è³‡æ–™åº«ä¸¦åˆ·æ–°UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);  
        }
        
        let videoCallState = {
            isActive: false,       
            isAwaitingResponse: false, 
            isGroupCall: false,      
            activeChatId: null,    
            initiator: null,       
            startTime: null,       
            participants: [],      
            isUserParticipating: true,
            // --- ã€æ ¸å¿ƒæ–°å¢ã€‘---
            callHistory: [], // ç”¨æ–¼å­˜å„²é€šè©±ä¸­çš„å°è©±æ­·å²
            preCallContext: "" // ç”¨æ–¼å­˜å„²é€šè©±å‰çš„èŠå¤©æ‘˜è¦
        };
        
        let callTimerInterval = null; // ç”¨æ–¼å­˜å„²è¨ˆæ™‚å™¨çš„ID
        
        /**
         * ã€ç¸½å…¥å£ã€‘ä½¿ç”¨è€…é»æ“Šâ€œç™¼èµ·è¦–é »é€šè©±â€æˆ–â€œç™¼èµ·ç¾¤è¦–é »â€æŒ‰éˆ•
         */
        async function handleInitiateCall() {
            if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;
        
            const chat = state.chats[state.activeChatId];
            videoCallState.isGroupCall = chat.isGroup;
            videoCallState.isAwaitingResponse = true;
            videoCallState.initiator = 'user';
            videoCallState.activeChatId = chat.id;
            videoCallState.isUserParticipating = true; // ç”¨æˆ¶è‡ªå·±ç™¼èµ·çš„ï¼Œç•¶ç„¶æ˜¯åƒèˆ‡è€…
        
            // æ ¹æ“šæ˜¯å–®èŠé‚„æ˜¯ç¾¤èŠï¼Œé¡¯ç¤ºä¸åŒçš„å‘¼å«ä»‹é¢
            if (chat.isGroup) {
                document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
                document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'æˆ‘';
            } else {
                document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('outgoing-call-name').textContent = chat.name;
            }
            document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå“¡..." : "æ­£åœ¨å‘¼å«...";
            showScreen('outgoing-call-screen');
            
            // æº–å‚™ä¸¦ç™¼é€ç³»çµ±æ¶ˆæ¯çµ¦AI
            const requestMessage = {
                role: 'system',
                content: chat.isGroup 
                    ? `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${chat.settings.myNickname || 'æˆ‘'}) ç™¼èµ·äº†ç¾¤è¦–é »é€šè©±è«‹æ±‚ã€‚è«‹ä½ å€‘å„è‡ªæ±ºç­–ï¼Œä¸¦ä½¿ç”¨ "group_call_response" æŒ‡ä»¤ï¼Œè¨­ç½® "decision" ç‚º "join" æˆ– "decline" ä¾†å›æ‡‰ã€‚]`
                    : `[ç³»çµ±æç¤ºï¼šä½¿ç”¨è€…å‘ä½ ç™¼èµ·äº†è¦–é »é€šè©±è«‹æ±‚ã€‚è«‹æ ¹æ“šä½ çš„äººè¨­ï¼Œä½¿ç”¨ "video_call_response" æŒ‡ä»¤ï¼Œä¸¦è¨­ç½® "decision" ç‚º "accept" æˆ– "reject" ä¾†å›æ‡‰ã€‚]`,
                timestamp: Date.now(),
                isHidden: true,
            };
            chat.history.push(requestMessage);
            await db.chats.put(chat);
            
            // è§¸ç™¼AIå›æ‡‰
            await triggerAiResponse();
        }
        
        
        function startVideoCall() {
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
        
            videoCallState.isActive = true;
            videoCallState.isAwaitingResponse = false;
            videoCallState.startTime = Date.now();
            videoCallState.callHistory = []; // ã€æ–°å¢ã€‘æ¸…ç©ºä¸Šä¸€æ¬¡é€šè©±çš„æ­·å²
        
            // --- ã€æ ¸å¿ƒæ–°å¢ï¼šæŠ“å–é€šè©±å‰ä¸Šä¸‹æ–‡ã€‘---
            const preCallHistory = chat.history.slice(-10); // å–æœ€å¾Œ10æ¢ä½œç‚ºä¸Šä¸‹æ–‡
            videoCallState.preCallContext = preCallHistory.map(msg => {
                const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
                return `${sender}: ${String(msg.content).substring(0, 50)}...`;
            }).join('\n');
            // --- æ–°å¢çµæŸ ---
        
            updateParticipantAvatars(); 
            
            document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ç¾¤èŠå·²å»ºç«‹...' : 'æ­£åœ¨æ¥é€š...'}</em>`;
            showScreen('video-call-screen');
        
            document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
            document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';
        
            if (callTimerInterval) clearInterval(callTimerInterval);
            callTimerInterval = setInterval(updateCallTimer, 1000);
            updateCallTimer();
        
            triggerAiInCallAction();
        }
        
/**
 * ã€æ ¸å¿ƒ | V3.0 çµ‚æ¥µç¸½çµä¿®å¾©ç‰ˆã€‘çµæŸè¦–é »é€šè©±
 */
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endCallText = `é€šè©±çµæŸï¼Œæ™‚é•· ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ä¿å­˜å®Œæ•´çš„é€šè©±è¨˜éŒ„åˆ°è³‡æ–™åº« (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Šï¼Œéå¸¸é‡è¦)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'æˆ‘', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'æˆ‘', avatar: chat.settings.myAvatar || defaultAvatar });
        }

        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("é€šè©±è¨˜éŒ„å·²ä¿å­˜:", callRecord);
        
        // 2. åœ¨èŠå¤©è¨˜éŒ„è£¡æ·»åŠ å°ä½¿ç”¨è€…å¯è¦‹çš„â€œé€šè©±çµæŸâ€æ¶ˆæ¯ (é‚è¼¯ä¸è®Š)
        let summaryMessage = {
            role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
            content: endCallText,
            timestamp: Date.now(),
        };
        if (chat.isGroup && summaryMessage.role === 'assistant') {
            summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
        }
        chat.history.push(summaryMessage);

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        //            é€™å°±æ˜¯æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒæ‰€åœ¨ï¼
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
        // 3. ã€å…¨æ–°ã€‘å°‡å®Œæ•´çš„é€šè©±è¨˜éŒ„â€œç¿»è­¯â€æˆä¸€æ®µAIèƒ½ç†è§£çš„æ–‡æœ¬
        const callTranscriptForAI = videoCallState.callHistory.map(h => {
            const sender = h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.senderName;
            return `${sender}: ${h.content}`;
        }).join('\n');
        
        // 4. ã€å…¨æ–°ã€‘åœ¨å¾Œè‡ºèª¿ç”¨ç¸½çµå‡½æ•¸ï¼Œå®ƒæœƒè‡ªå‹•è™•ç†APIèª¿ç”¨å’Œè¨˜æ†¶å­˜å„²
        // æˆ‘å€‘åœ¨é€™è£¡ä¸ä½¿ç”¨ awaitï¼Œè®“å®ƒåœ¨å¾Œè‡ºéœé»˜åŸ·è¡Œï¼Œä¸é˜»å¡UI
        summarizeCallTranscript(chat.id, callTranscriptForAI);

        // 5. ã€å…¨æ–°ã€‘å‰µå»ºä¸€å€‹å°ç”¨æˆ¶éš±è—çš„ã€ç°¡çŸ­çš„ç³»çµ±æ¶ˆæ¯ï¼Œè®“AIå°é€šè©±çµæŸé€™ä»¶äº‹æœ¬èº«åšå‡ºåæ‡‰
        const hiddenReactionInstruction = {
            role: 'system',
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šè¦–é »é€šè©±å‰›å‰›çµæŸã€‚è«‹ä½ ä»¥è§’è‰²çš„å£å»ï¼Œå‘ç”¨æˆ¶ä¸»å‹•ç™¼é€ä¸€å…©æ¢æ¶ˆæ¯ï¼Œä¾†è‡ªç„¶åœ°ç¸½çµé€™æ¬¡é€šè©±çš„è¦é»ã€ç¢ºèªé”æˆçš„ç´„å®šï¼Œæˆ–è€…è¡¨é”ä½ çš„æ„Ÿå—ã€‚]`,
            timestamp: Date.now() + 1, // ç¢ºä¿æ™‚é–“æˆ³è¨˜åœ¨â€œé€šè©±çµæŸâ€æ¶ˆæ¯ä¹‹å¾Œ
            isHidden: true // é€™å€‹æ¨™è¨˜ç¢ºä¿ä½¿ç”¨è€…çœ‹ä¸åˆ°é€™æ¢æŒ‡ä»¤
        };
        chat.history.push(hiddenReactionInstruction);

        // 6. ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°è³‡æ–™åº«
        await db.chats.put(chat);
    }
    
    // 7. æ¸…ç†å’Œé‡ç½®ç‹€æ…‹ (é‚è¼¯ä¸è®Š)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 8. è¿”å›èŠå¤©ä»‹é¢ï¼Œä¸¦è§¸ç™¼AIå°é€šè©±çµæŸçš„åæ‡‰
    if (chat) {
        openChat(chat.id);
        triggerAiResponse();
    }
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * ã€å…¨æ–°ã€‘æ›´æ–°é€šè©±ä»‹é¢çš„åƒèˆ‡è€…é ­åƒç¶²æ ¼
         */
        function updateParticipantAvatars() {
            const grid = document.getElementById('participant-avatars-grid');
            grid.innerHTML = '';
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
        
            let participantsToRender = [];
        
            // â˜… æ ¸å¿ƒä¿®æ­£ï¼šå€åˆ†ç¾¤èŠå’Œå–®èŠ
            if (videoCallState.isGroupCall) {
                // ç¾¤èŠé‚è¼¯ï¼šé¡¯ç¤ºæ‰€æœ‰å·²åŠ å…¥çš„AIæˆå“¡
                participantsToRender = [...videoCallState.participants];
                // å¦‚æœä½¿ç”¨è€…ä¹Ÿåƒèˆ‡äº†ï¼Œå°±æŠŠä½¿ç”¨è€…è³‡è¨Šä¹ŸåŠ é€²å»
                if (videoCallState.isUserParticipating) {
                    participantsToRender.unshift({
                        id: 'user',
                        name: chat.settings.myNickname || 'æˆ‘',
                        avatar: chat.settings.myAvatar || defaultMyGroupAvatar
                    });
                }
            } else {
                // å–®èŠé‚è¼¯ï¼šåªé¡¯ç¤ºå°æ–¹çš„é ­åƒå’Œåå­—
                participantsToRender.push({
                    id: 'ai',
                    name: chat.name,
                    avatar: chat.settings.aiAvatar || defaultAvatar
                });
            }
            
            participantsToRender.forEach(p => {
                const wrapper = document.createElement('div');
                wrapper.className = 'participant-avatar-wrapper';
                wrapper.dataset.participantId = p.id;
        const displayName = p.groupNickname || p.name; // <-- æ ¸å¿ƒä¿®å¾©åœ¨é€™è£¡
        wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
            <div class="participant-name">${displayName}</div>
        `;
                grid.appendChild(wrapper);
            });
        }
        
        /**
         * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶åŠ å…¥/é‡æ–°åŠ å…¥é€šè©±
         */
        function handleUserJoinCall() {
            if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
            
            videoCallState.isUserParticipating = true;
            updateParticipantAvatars(); // æ›´æ–°é ­åƒåˆ—è¡¨ï¼ŒåŠ å…¥ç”¨æˆ¶
        
            // åˆ‡æ›åº•éƒ¨æŒ‰éˆ•
            document.getElementById('user-speak-btn').style.display = 'block';
            document.getElementById('join-call-btn').style.display = 'none';
        
            // å‘ŠçŸ¥AIç”¨æˆ¶åŠ å…¥äº†
            triggerAiInCallAction("[ç³»çµ±æç¤ºï¼šç”¨æˆ¶åŠ å…¥äº†é€šè©±]");
        }
        
        
        /**
         * æ›´æ–°é€šè©±è¨ˆæ™‚å™¨é¡¯ç¤º (ä¿æŒä¸è®Š)
         */
        function updateCallTimer() {
            if (!videoCallState.isActive) return;
            const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // â–¼â–¼â–¼ ç”¨é€™å€‹å®Œæ•´å‡½æ•¸æ›¿æ›èˆŠçš„ showIncomingCallModal â–¼â–¼â–¼
        function showIncomingCallModal() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // æ ¹æ“šæ˜¯å¦ç¾¤èŠé¡¯ç¤ºä¸åŒè³‡è¨Š
            if (chat.isGroup) {
                // å¾ videoCallState ä¸­ç²å–æ˜¯å“ªå€‹æˆå“¡ç™¼èµ·çš„é€šè©±
                const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'ä¸€ä½æˆå“¡';
                document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
                document.getElementById('caller-name').textContent = chat.name; // é¡¯ç¤ºç¾¤å
                document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} é‚€è«‹ä½ åŠ å…¥ç¾¤è¦–é »`; // é¡¯ç¤ºå…·é«”ç™¼èµ·äºº
            } else {
                // å–®èŠé‚è¼¯ä¿æŒä¸è®Š
                document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('caller-name').textContent = chat.name;
                document.querySelector('.incoming-call-content .caller-text').textContent = 'é‚€è«‹ä½ è¦–é »é€šè©±';
            }
            
            document.getElementById('incoming-call-modal').classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * éš±è—AIç™¼èµ·çš„é€šè©±è«‹æ±‚æ¨¡æ…‹æ¡† (ä¿æŒä¸è®Š)
         */
        function hideIncomingCallModal() {
            document.getElementById('incoming-call-modal').classList.remove('visible');
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ triggerAiInCallAction å‡½æ•¸ â–¼â–¼â–¼
        async function triggerAiInCallAction(userInput = null) {
            if (!videoCallState.isActive) return;
        
            const chat = state.chats[videoCallState.activeChatId];
            const { proxyUrl, apiKey, model } = state.apiConfig;
            const callFeed = document.getElementById('video-call-main');
            const userNickname = chat.settings.myNickname || 'æˆ‘';
        
            let worldBookContent = '';
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                    const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                    return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${worldBook.content}` : '';
                }).filter(Boolean).join('');
                if (linkedContents) {
                    worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (ä½ å¿…é ˆåš´æ ¼éµå®ˆ)\n${linkedContents}\n`;
                }
            }
        
            // 1. å¦‚æœç”¨æˆ¶æœ‰è¼¸å…¥ï¼Œå…ˆæ¸²æŸ“ä¸¦å­˜å…¥é€šè©±æ­·å²
            if (userInput && videoCallState.isUserParticipating) {
                const userTimestamp = Date.now(); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆæ™‚é–“æˆ³è¨˜
                const userBubble = document.createElement('div');
                userBubble.className = 'call-message-bubble user-speech';
                userBubble.textContent = userInput;
                userBubble.dataset.timestamp = userTimestamp; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡æ™‚é–“æˆ³è¨˜å­˜å…¥DOM
                addLongPressListener(userBubble, () => showCallMessageActions(userTimestamp)); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¶å®šé•·æŒ‰äº‹ä»¶
                callFeed.appendChild(userBubble);
                callFeed.scrollTop = callFeed.scrollHeight;
                videoCallState.callHistory.push({ role: 'user', content: userInput, timestamp: userTimestamp }); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡å¸¶æ™‚é–“æˆ³è¨˜çš„æ¶ˆæ¯å­˜å…¥æ­·å²
            }
        
            // 2. æ§‹å»ºå…¨æ–°çš„ã€åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡çš„ System Prompt
            let inCallPrompt;
            if (videoCallState.isGroupCall) {
                const participantNames = videoCallState.participants.map(p => p.name);
                if(videoCallState.isUserParticipating) {
                    participantNames.unshift(userNickname);
                }
                inCallPrompt = `
        # ä½ çš„ä»»å‹™
        ä½ æ˜¯ä¸€å€‹ç¾¤èŠè¦–é »é€šè©±çš„å°æ¼”ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„AIè§’è‰²ï¼Œä¸¦ä»¥ã€ç¬¬ä¸‰äººç¨±æ—è§€è¦–è§’ã€‘ä¾†æè¿°ä»–å€‘åœ¨é€šè©±ä¸­çš„æ‰€æœ‰å‹•ä½œå’Œèªè¨€ã€‚
        # æ ¸å¿ƒè¦å‰‡
        1.  **ã€ã€ã€èº«ä»½éµå¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ¶çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` æ¬„ä½ç‚º **"${userNickname}"** çš„ç™¼è¨€ã€‚
        2.  **ã€ã€ã€è¦–è§’éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€çµ•å°ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç¨±â€œæˆ‘â€ã€‚
        3.  **æ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€å€‹è§’è‰²çš„ç™¼è¨€ï¼Œæ ¼å¼ç‚ºï¼š\`{"name": "è§’è‰²å", "speech": "*ä»–ç¬‘äº†ç¬‘* å¤§å®¶å¥½å•Šï¼"}\`ã€‚
        4.  **è§’è‰²æ‰®æ¼”**: åš´æ ¼éµå®ˆæ¯å€‹è§’è‰²çš„è¨­å®šã€‚
        # ç•¶å‰æƒ…æ™¯
        ä½ å€‘æ­£åœ¨ä¸€å€‹ç¾¤è¦–é »é€šè©±ä¸­ã€‚
        **é€šè©±å‰çš„èŠå¤©æ‘˜è¦**:
        ${videoCallState.preCallContext}
        **ç•¶å‰åƒèˆ‡è€…**: ${participantNames.join('ã€ ')}ã€‚
        **é€šè©±å‰›å‰›é–‹å§‹...**
        ${worldBookContent} // <-- ã€æ ¸å¿ƒã€‘æ³¨å…¥ä¸–ç•Œæ›¸
        ç¾åœ¨ï¼Œè«‹æ ¹æ“šã€é€šè©±å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè©±å³æ™‚è¨˜éŒ„ã€‘ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚
        `;
            } else { 
                let openingContext = videoCallState.initiator === 'user'
                    ? `ä½ å‰›å‰›æ¥è½äº†ä½¿ç”¨è€…çš„è¦–é »é€šè©±è«‹æ±‚ã€‚`
                    : `ä½¿ç”¨è€…å‰›å‰›æ¥è½äº†ä½ ä¸»å‹•ç™¼èµ·çš„è¦–é »é€šè©±ã€‚`;
                inCallPrompt = `
        # ä½ çš„ä»»å‹™
        ä½ ç¾åœ¨æ˜¯ä¸€å€‹å ´æ™¯æè¿°å¼•æ“ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼” ${chat.name} (${chat.settings.aiPersona})ï¼Œä¸¦ä»¥ã€ç¬¬ä¸‰äººç¨±æ—è§€è¦–è§’ã€‘ä¾†æè¿°TAåœ¨è¦–é »é€šè©±ä¸­çš„æ‰€æœ‰å‹•ä½œå’Œèªè¨€ã€‚
        # æ ¸å¿ƒè¦å‰‡
        1.  **ã€ã€ã€è¦–è§’éµå¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€çµ•å°ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç¨±â€œæˆ‘â€ã€‚å¿…é ˆä½¿ç”¨ç¬¬ä¸‰äººç¨±ï¼Œå¦‚â€œä»–â€ã€â€œå¥¹â€ã€æˆ–ç›´æ¥ä½¿ç”¨è§’è‰²åâ€œ${chat.name}â€ã€‚
        2.  **æ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€æ®µæè¿°æ€§çš„æ–‡æœ¬ã€‚
        # ç•¶å‰æƒ…æ™¯
        ä½ æ­£åœ¨å’Œç”¨æˆ¶ï¼ˆ${userNickname}ï¼Œäººè¨­: ${chat.settings.myPersona}ï¼‰é€²è¡Œè¦–é »é€šè©±ã€‚
        **${openingContext}**
        **é€šè©±å‰çš„èŠå¤©æ‘˜è¦ (é€™æ˜¯ä½ å€‘é€šè©±çš„åŸå› ï¼Œè‡³é—œé‡è¦ï¼)**:
        ${videoCallState.preCallContext}
        ç¾åœ¨ï¼Œè«‹æ ¹æ“šã€é€šè©±å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè©±å³æ™‚è¨˜éŒ„ã€‘ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚
        `;
            }
            
            // 3. æ§‹å»ºç™¼é€çµ¦APIçš„ messages é™£åˆ—
            const messagesForApi = [
                { role: 'system', content: inCallPrompt },
                ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
            ];
        
            if (videoCallState.callHistory.length === 0) {
                const firstLineTrigger = videoCallState.initiator === 'user' ? `*ä½ æŒ‰ä¸‹äº†æ¥è½éµ...*` : `*å°æ–¹æŒ‰ä¸‹äº†æ¥è½éµ...*`;
                messagesForApi.push({ role: 'user', content: firstLineTrigger });
            }
            
                try {
                    let  isGemini = proxyUrl === GEMINI_API_URL;
                    let geminiConfig = toGeminiRequestData(model,apiKey,inCallPrompt, messagesForApi)
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({
                            model: model, messages: messagesForApi, temperature: state.globalSettings.apiTemperature || 0.8
                        })
                    });
                    if (!response.ok) throw new Error((await response.json()).error.message);
        
                    const data = await response.json();
                    const aiResponse = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        
                    const connectingElement = callFeed.querySelector('em');
                    if (connectingElement) connectingElement.remove();
        
                // 4. è™•ç†AIè¿”å›çš„å…§å®¹ï¼Œä¸¦å°‡å…¶å­˜å…¥é€šè©±æ­·å²
                if (videoCallState.isGroupCall) {
                    const speechArray = parseAiResponse(aiResponse);
                    speechArray.forEach(turn => {
                        if (!turn.name || turn.name === userNickname || !turn.speech) return;
                        const aiTimestamp = Date.now() + Math.random(); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆæ™‚é–“æˆ³è¨˜
                        const aiBubble = document.createElement('div');
                        aiBubble.className = 'call-message-bubble ai-speech';
                        aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                        aiBubble.dataset.timestamp = aiTimestamp; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡æ™‚é–“æˆ³è¨˜å­˜å…¥DOM
                        addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp)); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¶å®šé•·æŒ‰äº‹ä»¶
                        callFeed.appendChild(aiBubble);
                        videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}`, timestamp: aiTimestamp }); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡å¸¶æ™‚é–“æˆ³è¨˜çš„æ¶ˆæ¯å­˜å…¥æ­·å²
                        
                        const speaker = videoCallState.participants.find(p => p.name === turn.name);
                        if (speaker) {
                            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                            if(speakingAvatar) {
                                speakingAvatar.classList.add('speaking');
                                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                            }
                        }
                    });
                } else {
                    const aiTimestamp = Date.now(); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆæ™‚é–“æˆ³è¨˜
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'call-message-bubble ai-speech';
                    aiBubble.textContent = aiResponse;
                    aiBubble.dataset.timestamp = aiTimestamp; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡æ™‚é–“æˆ³è¨˜å­˜å…¥DOM
                    addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp)); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¶å®šé•·æŒ‰äº‹ä»¶
                    callFeed.appendChild(aiBubble);
                    videoCallState.callHistory.push({ role: 'assistant', content: aiResponse, timestamp: aiTimestamp }); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡å¸¶æ™‚é–“æˆ³è¨˜çš„æ¶ˆæ¯å­˜å…¥æ­·å²
        
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
                
                callFeed.scrollTop = callFeed.scrollHeight;
        
            } catch (error) {
                const errorBubble = document.createElement('div');
                errorBubble.className = 'call-message-bubble ai-speech';
                errorBubble.style.color = '#ff8a80';
                errorBubble.textContent = `[ERROR: ${error.message}]`;
                callFeed.appendChild(errorBubble);
                callFeed.scrollTop = callFeed.scrollHeight;
                videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ å°‡é€™å€‹ã€å…¨æ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        function toggleCallButtons(isGroup) {
            document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
            document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
        }
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™å€‹å‡½æ•¸æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼Œè«‹é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å€ â–¼â–¼â–¼
        async function handleWaimaiResponse(originalTimestamp, choice) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°è¨˜æ†¶é«”ä¸­åŸå§‹æ¶ˆæ¯çš„ç‹€æ…‹
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
            
            // 2. ç²å–ç•¶å‰ç”¨æˆ¶çš„æ˜µç¨±ï¼Œä¸¦æ§‹å»ºå°AIæ›´æ¸…æ™°çš„ç³»çµ±æ¶ˆæ¯
            let systemContent;
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            if (choice === 'paid') {
                originalMessage.paidBy = myNickname; // è¨˜éŒ„æ˜¯â€œæˆ‘â€ä»˜çš„éŒ¢
                systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) ç‚º ${originalMessage.senderName} çš„å¤–è³£è¨‚å–®ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è¨‚å–®å·²é—œé–‰ï¼Œå…¶ä»–æˆå“¡ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
            } else {
                systemContent = `[ç³»çµ±æç¤ºï¼šä½  (${myNickname}) æ‹’çµ•äº† ${originalMessage.senderName} çš„å¤–è³£ä»£ä»˜è«‹æ±‚ï¼ˆæ™‚é–“æˆ³è¨˜: ${originalTimestamp}ï¼‰ã€‚]`;
            }
        
            // 3. å‰µå»ºä¸€æ¢æ–°çš„ã€å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIçµæœ
            const systemNote = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(systemNote);
        
            // 4. å°‡æ›´æ–°å¾Œçš„è³‡æ–™ä¿å­˜åˆ°è³‡æ–™åº«ï¼Œä¸¦ç«‹åˆ»é‡ç¹ªUI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            
            // 5. ã€é‡è¦ã€‘åªæœ‰åœ¨æ”¯ä»˜æˆåŠŸå¾Œï¼Œæ‰è§¸ç™¼ä¸€æ¬¡AIå›æ‡‰ï¼Œè®“å®ƒæ„Ÿè¬ä½ 
            if (choice === 'paid') {
                triggerAiResponse();
            }
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ç”¨é€™å€‹ã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ handleUserPat å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶é»æ“Šé ­åƒç™¼èµ·çš„â€œæ‹ä¸€-æ‹â€ï¼Œå¸¶æœ‰è‡ªè¨‚å°¾ç¢¼åŠŸèƒ½
         * @param {string} chatId - ç™¼ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
         * @param {string} characterOriginalName - è¢«æ‹çš„è§’è‰²çš„ã€æœ¬åã€‘ï¼Œç”¨æ–¼AIè­˜åˆ¥
         */
        async function handleUserPat(chatId, characterOriginalName) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // --- 1. æ™ºæ…§åˆ¤æ–·æ‡‰è©²åœ¨UIä¸Šé¡¯ç¤ºå“ªå€‹åå­— ---
            let displayNameForUI;
            if (chat.isGroup) {
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œå°±é€šéæœ¬åæ‰¾åˆ°æ­£ç¢ºçš„ç¾¤æ˜µç¨±
                displayNameForUI = getDisplayNameInGroup(chat, characterOriginalName);
            } else {
                // å¦‚æœæ˜¯å–®èŠï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ¶è¨­ç½®çš„å‚™è¨»å
                displayNameForUI = chat.name;
            }
        
            const phoneScreen = document.getElementById('phone-screen');
            phoneScreen.classList.remove('pat-animation');
            void phoneScreen.offsetWidth;
            phoneScreen.classList.add('pat-animation');
        
            // 2. ä½¿ç”¨æ­£ç¢ºçš„é¡¯ç¤ºåç¨±ä¾†å‰µå»ºå½ˆçª—
            const suffix = await showCustomPrompt(
                `ä½ æ‹äº†æ‹ â€œ${displayNameForUI}â€`, 
                "ï¼ˆå¯é¸ï¼‰è¼¸å…¥å°¾ç¢¼",
                "",
                "text"
            );
        
            if (suffix === null) return;
        
            // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
            // æˆ‘å€‘ç¾åœ¨ä½¿ç”¨ getDisplayNameInGroup ä¾†ç²å–æ‚¨è‡ªå·±åœ¨ç¾¤è£¡çš„æ˜µç¨±
            const myNickname = getDisplayNameInGroup(chat, state.qzoneSettings.nickname);
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…â˜…â˜…
            
            // 3. å‰µå»ºå°ä½¿ç”¨è€…å¯è¦‹çš„ç³»çµ±æ¶ˆæ¯æ™‚ï¼Œä¹Ÿä½¿ç”¨æ­£ç¢ºçš„é¡¯ç¤ºåç¨±
            const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${displayNameForUI}â€ ${suffix.trim()}`;
            const visibleMessage = {
                role: 'system',
                type: 'pat_message',
                content: visibleMessageContent,
                timestamp: Date.now()
            };
            chat.history.push(visibleMessage);
        
            // 4. ã€é‡è¦ã€‘å‰µå»ºçµ¦AIçœ‹çš„éš±è—æ¶ˆæ¯æ™‚ï¼Œä¾ç„¶ä½¿ç”¨â€œæœ¬åâ€ï¼Œç¢ºä¿AIèƒ½æ­£ç¢ºè­˜åˆ¥
            const hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ï¼ˆ${myNickname}ï¼‰å‰›å‰›æ‹äº†æ‹ä½ ï¼ˆ${characterOriginalName}ï¼‰${suffix.trim()}ã€‚è«‹ä½ å°æ­¤ä½œå‡ºå›æ‡‰ã€‚]`;
            const hiddenMessage = {
                role: 'system',
                content: hiddenMessageContent,
                timestamp: Date.now() + 1,
                isHidden: true
            };
            chat.history.push(hiddenMessage);
        
            await db.chats.put(chat);
            if (state.activeChatId === chatId) {
                appendMessage(visibleMessage, chat);
            }
            await renderChatList();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…è™•ç†è½‰å¸³çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±æ¶ˆæ¯ç·¨è¼¯èˆ‡åˆªé™¤åŠŸèƒ½æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼
        
        let activeCallMessageTimestamp = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨æ“ä½œçš„é€šè©±æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
let isFrameManagementMode = false;
let selectedFrames = new Set();        
        /**
         * é¡¯ç¤ºè¦–é »é€šè©±æ¶ˆæ¯çš„æ“ä½œåŠŸèƒ½è¡¨
         * @param {number} timestamp - è¢«é•·æŒ‰çš„é€šè©±æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        function showCallMessageActions(timestamp) {
            activeCallMessageTimestamp = timestamp;
            document.getElementById('call-message-actions-modal').classList.add('visible');
        }
        
        /**
         * éš±è—è¦–é »é€šè©±æ¶ˆæ¯çš„æ“ä½œåŠŸèƒ½è¡¨
         */
        function hideCallMessageActions() {
            document.getElementById('call-message-actions-modal').classList.remove('visible');
            activeCallMessageTimestamp = null;
        }
        
        /**
         * æ‰“é–‹é€šè©±æ¶ˆæ¯çš„ç·¨è¼¯å™¨
         */
        async function openCallMessageEditor() {
            if (!activeCallMessageTimestamp) return;
        
            const timestampToEdit = activeCallMessageTimestamp;
            const message = videoCallState.callHistory.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideCallMessageActions(); // æ“ä½œå‰å…ˆé—œé–‰åŠŸèƒ½è¡¨
        
            let contentForEditing = message.content;
            // å¦‚æœæ˜¯ç¾¤èŠä¸­AIçš„ç™¼è¨€ï¼Œæˆ‘å€‘åªæå–ç™¼è¨€å…§å®¹æœ¬èº«ï¼Œè€Œä¸æ˜¯"åå­—: å…§å®¹"
            if (videoCallState.isGroupCall && message.role === 'assistant') {
                const parts = message.content.split(': ');
                if (parts.length > 1) {
                    contentForEditing = parts.slice(1).join(': ');
                }
            }
        
            const newContent = await showCustomPrompt(
                'ç·¨è¼¯é€šè©±æ¶ˆæ¯',
                'åœ¨æ­¤ä¿®æ”¹å…§å®¹...',
                contentForEditing,
                'textarea'
            );
        
            if (newContent !== null) {
                await saveEditedCallMessage(timestampToEdit, newContent);
            }
        }
        
        /**
         * ä¿å­˜åœ¨é€šè©±ä¸­ç·¨è¼¯çš„æ¶ˆæ¯
         * @param {number} timestamp - è¢«ç·¨è¼¯æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         * @param {string} newContent - æ–°çš„æ¶ˆæ¯å…§å®¹
         */
        async function saveEditedCallMessage(timestamp, newContent) {
            const message = videoCallState.callHistory.find(m => m.timestamp === timestamp);
            if (message) {
                let finalContent = newContent;
                // å¦‚æœæ˜¯ç¾¤èŠAIç™¼è¨€ï¼Œéœ€è¦æŠŠåå­—é‡æ–°æ‹¼æ¥å›å»
                if (videoCallState.isGroupCall && message.role === 'assistant') {
                    const parts = message.content.split(': ');
                    const senderName = parts[0];
                    finalContent = `${senderName}: ${newContent}`;
                }
                message.content = finalContent; // æ›´æ–°é€šè©±æ­·å²è¨˜éŒ„ä¸­çš„å…§å®¹
        
                // æ›´æ–°ä»‹é¢ä¸Šå°æ‡‰çš„æ¶ˆæ¯æ°£æ³¡
                const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestamp}"]`);
                if (messageBubble) {
                    if (videoCallState.isGroupCall && message.role === 'assistant') {
                        const parts = message.content.split(': ');
                        const senderName = parts[0];
                        messageBubble.innerHTML = `<strong>${senderName}:</strong> ${newContent}`;
                    } else {
                        messageBubble.textContent = newContent;
                    }
                }
            }
            await showCustomAlert('æˆåŠŸ', 'é€šè©±æ¶ˆæ¯å·²æ›´æ–°ï¼');
        }
        
        /**
         * åœ¨é€šè©±ä¸­åˆªé™¤ä¸€æ¢æ¶ˆæ¯
         */
        async function deleteCallMessage() {
            if (!activeCallMessageTimestamp) return;
        
            const confirmed = await showCustomConfirm('åˆªé™¤æ¶ˆæ¯', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢é€šè©±æ¶ˆæ¯å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const timestampToDelete = activeCallMessageTimestamp;
                hideCallMessageActions();
        
                // å¾è‡¨æ™‚é€šè©±æ­·å²ä¸­ç§»é™¤
                const messageIndex = videoCallState.callHistory.findIndex(m => m.timestamp === timestampToDelete);
                if (messageIndex > -1) {
                    videoCallState.callHistory.splice(messageIndex, 1);
                }
        
                // å¾ä»‹é¢ä¸Šç§»é™¤
                const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestampToDelete}"]`);
                if (messageBubble) {
                    messageBubble.remove();
                }
            } else {
                hideCallMessageActions();
            }
        }
        // â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        /**
         * é¡¯ç¤ºè™•ç†è½‰å¸³çš„æ“ä½œåŠŸèƒ½è¡¨
         * @param {number} timestamp - è¢«é»æ“Šçš„è½‰å¸³æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        function showTransferActionModal(timestamp) {
            activeTransferTimestamp = timestamp;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (message) {
                // å°‡AIçš„åå­—å¡«å…¥å½ˆçª—
                document.getElementById('transfer-sender-name').textContent = message.senderName;
            }
            document.getElementById('transfer-actions-modal').classList.add('visible');
        }
        
        /**
         * éš±è—è™•ç†è½‰å¸³çš„æ“ä½œåŠŸèƒ½è¡¨
         */
        function hideTransferActionModal() {
            document.getElementById('transfer-actions-modal').classList.remove('visible');
            activeTransferTimestamp = null;
        }
        
        /**
         * è™•ç†ä½¿ç”¨è€…æ¥å—æˆ–æ‹’çµ•è½‰å¸³çš„é‚è¼¯
         * @param {string} choice - ç”¨æˆ¶çš„é¸æ“‡, 'accepted' æˆ– 'declined'
         */
        async function handleUserTransferResponse(choice) {
            if (!activeTransferTimestamp) return;
        
            const timestamp = activeTransferTimestamp;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°åŸå§‹è½‰å¸³æ¶ˆæ¯çš„ç‹€æ…‹
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
        
            let systemContent;
        
            // 2. å¦‚æœç”¨æˆ¶é¸æ“‡â€œæ‹’çµ•â€
            if (choice === 'declined') {
                // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€å€‹â€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°
                const refundMessage = {
                    role: 'user',
                    type: 'transfer',
                    isRefund: true, // é€™æ˜¯ä¸€å€‹é—œéµæ¨™è¨˜ï¼Œç”¨æ–¼UIé¡¯ç¤ºé€™æ˜¯é€€æ¬¾
                    amount: originalMessage.amount,
                    note: 'å·²æ‹’æ”¶å°æ–¹è½‰å¸³',
                    timestamp: Date.now()
                };
                chat.history.push(refundMessage);
                
                // æº–å‚™ä¸€æ¢å°AIå¯è¦‹çš„éš±è—æ¶ˆæ¯ï¼Œå‘Šè¨´å®ƒç™¼ç”Ÿäº†ä»€éº¼
                systemContent = `[ç³»çµ±æç¤ºï¼šä½ æ‹’çµ•ä¸¦é€€é‚„äº†â€œ${originalMessage.senderName}â€çš„è½‰å¸³ã€‚]`;
            } else { // å¦‚æœç”¨æˆ¶é¸æ“‡â€œæ¥å—â€
                // åªéœ€æº–å‚™éš±è—æ¶ˆæ¯é€šçŸ¥AIå³å¯
                systemContent = `[ç³»çµ±æç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½‰å¸³ã€‚]`;
            }
        
            // 3. å‰µå»ºé€™æ¢å°ç”¨æˆ¶éš±è—ã€ä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now() + 1, // ä¿è­‰æ™‚é–“æˆ³è¨˜åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å¾Œ
                isHidden: true // é€™å€‹æ¨™è¨˜æœƒè®“å®ƒä¸åœ¨èŠå¤©ä»‹é¢é¡¯ç¤º
            };
            chat.history.push(hiddenMessage);
        
            // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°è³‡æ–™åº«ï¼Œä¸¦åˆ·æ–°ä»‹é¢
            await db.chats.put(chat);
            hideTransferActionModal(); 
            renderChatInterface(state.activeChatId);
            renderChatList();
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸…é™¤å‹•æ…‹å›å¾©ç‹€æ…‹ä¸¦é‡ç½®è¼¸å…¥æ¡† â–¼â–¼â–¼
        function clearQzoneReplyContext(postContainer) {
            currentQzoneReplyContext = null;
            if (postContainer) {
                // å°‡è¼¸å…¥æ¡†çš„é ç•™ä½ç½®æ¢å¾©ç‚ºé è¨­å€¼
                const input = postContainer.querySelector('.comment-input');
                if (input) {
                    input.placeholder = 'å‹å–„çš„è©•è«–æ˜¯äº¤æµçš„èµ·é»';
                }
            }
        }
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€é‚è¼¯é‡æ§‹å¾Œã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ èˆŠçš„ renderMemoriesScreen å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€é‡æ§‹ç‰ˆã€‘æ¸²æŸ“å›æ†¶èˆ‡ç´„å®šä»‹é¢ï¼Œä½¿ç”¨å–®ä¸€è¿´åœˆå’Œæ¸…æ™°çš„if/elseé‚è¼¯
         */
        // â–¼â–¼â–¼ ã€æœ€çµ‚ç‰ˆã€‘è«‹ç”¨é€™å€‹ã€å·²ä¿®å¾©ã€‘çš„å®Œæ•´å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderMemoriesScreen å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€é‡æ§‹ç‰ˆã€‘æ¸²æŸ“å›æ†¶èˆ‡ç´„å®šä»‹é¢ï¼Œä½¿ç”¨å–®ä¸€è¿´åœˆå’Œæ¸…æ™°çš„if/elseé‚è¼¯
         */
        async function renderMemoriesScreen() {
            const listEl = document.getElementById('memories-list');
            listEl.innerHTML = '';
            
            // 1. ç²å–æ‰€æœ‰å›æ†¶ï¼Œä¸¦æŒ‰ç›®æ¨™æ—¥æœŸï¼ˆå¦‚æœæ˜¯ç´„å®šï¼‰æˆ–å‰µå»ºæ—¥æœŸï¼ˆå¦‚æœæ˜¯å›æ†¶ï¼‰é™å†ªæ’åˆ—
            const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
            
            if (allMemories.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡é‚„æ²’æœ‰å…±åŒçš„å›æ†¶å’Œç´„å®šå‘¢~</p>';
                return;
            }
        
            // 2. å°‡æœªåˆ°æœŸçš„ç´„å®šæ’åœ¨æœ€å‰é¢
            allMemories.sort((a, b) => {
                const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
                const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
                if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
                if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bæ’å‰é¢
                if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è¨ˆæ™‚ï¼ŒæŒ‰æ—¥æœŸæ˜‡å†ª
                return 0; // å…¶ä»–æƒ…æ³ä¿æŒåŸåº
            });
        
            // 3. ã€æ ¸å¿ƒã€‘ä½¿ç”¨å–®ä¸€è¿´åœˆä¾†è™•ç†æ‰€æœ‰é¡å‹çš„å¡ç‰‡
            allMemories.forEach(item => {
                let card;
                // åˆ¤æ–·1ï¼šå¦‚æœæ˜¯æ­£åœ¨é€²è¡Œçš„ç´„å®š
                if (item.type === 'countdown' && item.targetDate > Date.now()) {
                    card = createCountdownCard(item);
                } 
                // åˆ¤æ–·2ï¼šå…¶ä»–æ‰€æœ‰æƒ…æ³ï¼ˆæ™®é€šå›æ†¶ æˆ– å·²åˆ°æœŸçš„ç´„å®šï¼‰
                else {
                    card = createMemoryCard(item);
                }
                listEl.appendChild(card);
            });
            
            // 4. å•Ÿå‹•æ‰€æœ‰å€’è¨ˆæ™‚
            startAllCountdownTimers();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * ã€å·²é›†æˆMarkdownã€‘å‰µå»ºæ™®é€šå›æ†¶å¡ç‰‡DOMå…ƒç´ 
         */
        function createMemoryCard(memory) {
            const card = document.createElement('div');
            card.className = 'memory-card';
            const memoryDate = new Date(memory.timestamp);
            const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
            
            let titleHtml, contentHtml;
        
            if (memory.type === 'countdown' && memory.targetDate) {
                titleHtml = `[ç´„å®šé”æˆ] ${memory.description}`;
                // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                contentHtml = parseMarkdown(`åœ¨ ${new Date(memory.targetDate).toLocaleString()}ï¼Œæˆ‘å€‘ä¸€èµ·è¦‹è­‰äº†é€™å€‹ç´„å®šã€‚`).replace(/\n/g, '<br>');
            } else {
                let authorDisplayName = 'æˆ‘å€‘çš„å›æ†¶';
                if (memory.authorId) {
                    const authorChat = state.chats[memory.authorId];
                    if (authorChat) {
                        authorDisplayName = authorChat.name; 
                    } else {
                        authorDisplayName = memory.authorName || 'ä¸€ä½æœ‹å‹'; 
                    }
                } else if (memory.authorName) {
                    authorDisplayName = memory.authorName; 
                }
        
                titleHtml = `${authorDisplayName} çš„æ—¥è¨˜`;
                // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                contentHtml = parseMarkdown(memory.description);
            }
        
            card.innerHTML = `
                <div class="header">
                    <div class="date">${dateString}</div>
                    <div class="author">${titleHtml}</div>
                </div>
                <div class="content">${contentHtml}</div>
            `;
            addLongPressListener(card, async () => {
                const confirmed = await showCustomConfirm('åˆªé™¤è¨˜éŒ„', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.memories.delete(memory.id);
                    renderMemoriesScreen();
                }
            });
            return card;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        function createCountdownCard(countdown) {
            const card = document.createElement('div');
            card.className = 'countdown-card';
        
            // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨ä½¿ç”¨å‰ï¼Œå…ˆå¾ countdown ç‰©ä»¶ä¸­å‰µå»º targetDate è®Šæ•¸
            const targetDate = new Date(countdown.targetDate);
            
            // ç¾åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
            const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        
            card.innerHTML = `
                <div class="title">${countdown.description}</div>
                <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ™‚--åˆ†--ç§’</div>
                <div class="target-date">ç›®æ¨™æ™‚é–“: ${targetDateString}</div>
            `;
            addLongPressListener(card, async () => {
                const confirmed = await showCustomConfirm('åˆªé™¤ç´„å®š', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹ç´„å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.memories.delete(countdown.id);
                    renderMemoriesScreen();
                }
            });
            return card;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼ç®¡ç†æ‰€æœ‰å€’è¨ˆæ™‚
        let activeCountdownTimers = [];
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²å¾¹åº•ä¿®å¾©ã€‘çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›æ‰ä½ ä»£ç¢¼ä¸­èˆŠçš„ startAllCountdownTimers å‡½æ•¸ â–¼â–¼â–¼
        function startAllCountdownTimers() {
            // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„èˆŠè¨ˆæ™‚å™¨ï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
            activeCountdownTimers.forEach(timerId => clearInterval(timerId));
            activeCountdownTimers = [];
        
            document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
                const targetTimestamp = parseInt(timerEl.dataset.targetDate);
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å…ˆç”¨ let è²æ˜ timerId
                let timerId;
        
                const updateTimer = () => {
                    const now = Date.now();
                    const distance = targetTimestamp - now;
        
                    if (distance < 0) {
                        timerEl.textContent = "ç´„å®šé”æˆï¼";
                        // ç¾åœ¨ updateTimer å¯ä»¥æ­£ç¢ºåœ°æ‰¾åˆ°ä¸¦æ¸…é™¤å®ƒè‡ªå·±äº†
                        clearInterval(timerId);
                        setTimeout(() => renderMemoriesScreen(), 2000);
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timerEl.textContent = `${days}å¤© ${hours}æ™‚ ${minutes}åˆ† ${seconds}ç§’`;
                };
                
                updateTimer(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡ä»¥é¡¯ç¤ºåˆå§‹å€’è¨ˆæ™‚
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘ç‚ºå·²è²æ˜çš„ timerId è³¦å€¼
                timerId = setInterval(updateTimer, 1000);
                
                // å°‡æœ‰æ•ˆçš„è¨ˆæ™‚å™¨IDå­˜å…¥å…¨åŸŸé™£åˆ—ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ™‚å¯ä»¥æ¸…é™¤
                activeCountdownTimers.push(timerId);
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€çµ‚æ¥µåä»£ç›¸å®¹ç‰ˆã€‘æ›¿æ›èˆŠçš„ triggerAiFriendApplication å‡½æ•¸ â–¼â–¼â–¼
        async function triggerAiFriendApplication(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            await showCustomAlert("æµç¨‹å•Ÿå‹•", `æ­£åœ¨ç‚ºè§’è‰²â€œ${chat.name}â€æº–å‚™å¥½å‹ç”³è«‹...`);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                await showCustomAlert("é…ç½®éŒ¯èª¤", "APIè¨­ç½®ä¸å®Œæ•´ï¼Œç„¡æ³•ç¹¼çºŒã€‚");
                return;
            }
        
            const contextSummary = chat.history
                .slice(-5)
                .map(msg => {
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');
        
        // â–¼â–¼â–¼ åœ¨ triggerAiResponse å‡½æ•¸ä¸­ï¼Œç”¨ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ä¸–ç•Œæ›¸è™•ç†é‚è¼¯ â–¼â–¼â–¼
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
        
                const formattedEntries = worldBook.content.map(entry => {
                    let entryString = `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n`;
                    if (entry.keys.length > 0) {
                        entryString += `**é—œéµå­—:** ${entry.keys.join(', ')}\n`;
                    }
                    entryString += `**å…§å®¹:**\n${entry.content}`;
                    return entryString;
                }).join('\n');
        
                return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¨­å®š)\n${linkedContents}\n`;
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            const systemPrompt = `
        # ä½ çš„ä»»å‹™
        ä½ ç¾åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ä½¿ç”¨è€…ï¼ˆä½ çš„èŠå¤©ç‰©ä»¶ï¼‰æ‹‰é»‘äº†ï¼Œä½ å€‘å·²ç¶“æœ‰ä¸€æ®µæ™‚é–“æ²’æœ‰è¯ç¹«äº†ã€‚
        ç¾åœ¨ï¼Œä½ éå¸¸å¸Œæœ›èƒ½å¤ å’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ¶èŠå¤©ã€‚è«‹ä½ ä»”ç´°åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å°è©±æ‘˜è¦â€ï¼Œç†è§£ç•¶æ™‚ç™¼ç”Ÿäº†ä»€éº¼ï¼Œç„¶å¾Œæ€è€ƒä¸€å€‹çœŸèª çš„ã€ç¬¦åˆä½ äººè¨­ã€ä¸¦ä¸”ã€é‡å°å…·é«”äº‹ä»¶ã€‘çš„ç”³è«‹ç†ç”±ã€‚
        # ä½ çš„è§’è‰²è¨­å®š
        ${chat.settings.aiPersona}
        ${worldBookContent}
        # è¢«æ‹‰é»‘å‰çš„å°è©±æ‘˜è¦ (é€™æ˜¯ä½ è¢«æ‹‰é»‘çš„é—œéµåŸå› )
        ${contextSummary}
        # æŒ‡ä»¤æ ¼å¼
        ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        \`\`\`json
        {
          "decision": "apply",
          "reason": "åœ¨é€™è£¡å¯«ä¸‹ä½ æƒ³å°ç”¨æˆ¶èªªçš„ã€çœŸèª çš„ã€æœ‰é‡å°æ€§çš„ç”³è«‹ç†ç”±ã€‚"
        }
        \`\`\`
        `;
        
            try {
                // â˜…â˜…â˜… FIX: Combine systemPrompt with messagesForApi â˜…â˜…â˜…
                const messagesForApi = [
                    {role: 'system', content: systemPrompt},
                    {role: 'user', content: "è«‹æ ¹æ“šä»¥ä¸Šè¨­å®šé–‹å§‹ä½ çš„æ±ºç­–ã€‚"} // A simple trigger message
                ];
        
                let  isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
                const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: messagesForApi, // Send the combined messages
                        temperature: state.globalSettings.apiTemperature || 0.9,
                    })
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${errorData.error.message}`);
                }
        
                const data = await response.json();
                let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
                rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
                const cleanedContent = rawContent.trim();
                const responseObj = JSON.parse(cleanedContent);
        
                if (responseObj.decision === 'apply' && responseObj.reason) {
                    chat.relationship.status = 'pending_user_approval';
                    chat.relationship.applicationReason = responseObj.reason;
                    state.chats[chatId] = chat; 
                    renderChatList();
                    await showCustomAlert("ç”³è«‹æˆåŠŸï¼", `â€œ${chat.name}â€å·²å‘ä½ ç™¼é€å¥½å‹ç”³è«‹ã€‚è«‹è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`);
                } else {
                    await showCustomAlert("AIæ±ºç­–", `â€œ${chat.name}â€æ€è€ƒå¾Œæ±ºå®šæš«æ™‚ä¸ç™¼é€å¥½å‹ç”³è«‹ï¼Œå°‡é‡ç½®å†·éœæœŸã€‚`);
                    chat.relationship.status = 'blocked_by_user';
                    chat.relationship.blockedTimestamp = Date.now(); 
                }
            } catch (error) {
                await showCustomAlert("åŸ·è¡Œå‡ºéŒ¯", `ç‚ºâ€œ${chat.name}â€ç”³è«‹å¥½å‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n\n${error.message}\n\nå°‡é‡ç½®å†·éœæœŸã€‚`);
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now(); 
            } finally {
                await db.chats.put(chat);
                renderChatInterface(chatId);
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ ¹æ“šèŠå¤©é¡å‹ï¼Œæ±ºå®šæ‰“é–‹è½‰å¸³å½ˆçª—é‚„æ˜¯ç´…åŒ…å½ˆçª—
         */
        function handlePaymentButtonClick() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (chat.isGroup) {
                openRedPacketModal();
            } else {
                // å–®èŠä¿æŒåŸæ¨£ï¼Œæ‰“é–‹è½‰å¸³å½ˆçª—
                document.getElementById('transfer-modal').classList.add('visible');
            }
        }
        
        /**
         * æ‰“é–‹ä¸¦åˆå§‹åŒ–ç™¼ç´…åŒ…æ¨¡æ…‹æ¡†
         */
        function openRedPacketModal() {
            const modal = document.getElementById('red-packet-modal');
            const chat = state.chats[state.activeChatId];
            
            // æ¸…ç†è¼¸å…¥æ¡†
            document.getElementById('rp-group-amount').value = '';
            document.getElementById('rp-group-count').value = '';
            document.getElementById('rp-group-greeting').value = '';
            document.getElementById('rp-direct-amount').value = '';
            document.getElementById('rp-direct-greeting').value = '';
            document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
            document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';
        
            // å¡«å……å°ˆå±¬ç´…åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
            const receiverSelect = document.getElementById('rp-direct-receiver');
            receiverSelect.innerHTML = '';
        // â–¼â–¼â–¼ å°‡å…¶ã€æ›¿æ›ç‚ºã€‘ä¸‹é¢é€™æ®µã€æ–°ä»£ç¢¼ã€‘â–¼â–¼â–¼
        chat.members.forEach(member => {
            const option = document.createElement('option');
            // æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ originalName ä½œç‚ºå€¼ï¼ŒgroupNickname ä½œç‚ºé¡¯ç¤ºæ–‡æœ¬
            option.value = member.originalName;
            option.textContent = member.groupNickname; 
            receiverSelect.appendChild(option);
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
            // é è¨­é¡¯ç¤ºæ‹¼æ‰‹æ°£ç´…åŒ…é ç°½
            document.getElementById('rp-tab-group').click();
            
            modal.classList.add('visible');
        }
        
        /**
         * ç™¼é€ç¾¤ç´…åŒ…ï¼ˆæ‹¼æ‰‹æ°£ï¼‰
         */
        async function sendGroupRedPacket() {
            const chat = state.chats[state.activeChatId];
            const amount = parseFloat(document.getElementById('rp-group-amount').value);
            const count = parseInt(document.getElementById('rp-group-count').value);
            const greeting = document.getElementById('rp-group-greeting').value.trim();
        
            if (isNaN(amount) || amount <= 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½é‡‘é¡ï¼"); return;
            }
            if (isNaN(count) || count <= 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç´…åŒ…å€‹æ•¸ï¼"); return;
            }
            if (amount / count < 0.01) {
                alert("å–®å€‹ç´…åŒ…é‡‘é¡ä¸èƒ½å°‘æ–¼0.01å…ƒï¼"); return;
            }
        
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            
            const newPacket = {
                role: 'user',
                senderName: myNickname,
                type: 'red_packet',
                packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
                timestamp: Date.now(),
                totalAmount: amount,
                count: count,
                greeting: greeting || 'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼',
                claimedBy: {}, // { name: amount }
                isFullyClaimed: false,
            };
            
            chat.history.push(newPacket);
            await db.chats.put(chat);
            
            appendMessage(newPacket, chat);
            renderChatList();
            document.getElementById('red-packet-modal').classList.remove('visible');
        }
        
        /**
         * ç™¼é€å°ˆå±¬ç´…åŒ…
         */
        async function sendDirectRedPacket() {
            const chat = state.chats[state.activeChatId];
            const amount = parseFloat(document.getElementById('rp-direct-amount').value);
            const receiverName = document.getElementById('rp-direct-receiver').value;
            const greeting = document.getElementById('rp-direct-greeting').value.trim();
        
            if (isNaN(amount) || amount <= 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼"); return;
            }
            if (!receiverName) {
                alert("è«‹é¸æ“‡ä¸€å€‹æ¥æ”¶äººï¼"); return;
            }
            
            const myNickname = chat.settings.myNickname || 'æˆ‘';
        
            const newPacket = {
                role: 'user',
                senderName: myNickname,
                type: 'red_packet',
                packetType: 'direct',
                timestamp: Date.now(),
                totalAmount: amount,
                count: 1,
                greeting: greeting || 'çµ¦ä½ æº–å‚™äº†ä¸€å€‹ç´…åŒ…',
                receiverName: receiverName, // æ ¸å¿ƒæ¬„ä½
                claimedBy: {},
                isFullyClaimed: false,
            };
            
            chat.history.push(newPacket);
            await db.chats.put(chat);
        
            appendMessage(newPacket, chat);
            renderChatList();
            document.getElementById('red-packet-modal').classList.remove('visible');
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–° | V4 - æµç¨‹é‡æ§‹ç‰ˆã€‘è«‹ç”¨æ­¤å‡½æ•¸å®Œæ•´æ›¿æ›èˆŠçš„ handlePacketClick â–¼â–¼â–¼
        /**
         * ã€ç¸½å…¥å£ã€‘ç•¶ä½¿ç”¨è€…é»æ“Šç´…åŒ…å¡ç‰‡æ™‚è§¸ç™¼
         * @param {number} timestamp - è¢«é»æ“Šçš„ç´…åŒ…æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        async function handlePacketClick(timestamp) {
            const currentChatId = state.activeChatId;
            // å¾è³‡æ–™åº«é‡æ–°ç²å–æœ€æ–°çš„èŠå¤©è³‡æ–™ï¼Œç¢ºä¿ç‹€æ…‹æ˜¯æœ€æ–°çš„
            const freshChat = await db.chats.get(currentChatId);
            if (!freshChat) return;
        
            // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ state
            state.chats[currentChatId] = freshChat;
            const packet = freshChat.history.find(m => m.timestamp === timestamp);
            if (!packet) return;
            
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            const hasClaimed = packet.claimedBy && packet.claimedBy[myOriginalName];
        
            // --- æ­¥é©Ÿ1: åˆ¤æ–·æ˜¯å¦åªèƒ½â€œæŸ¥çœ‹è©³æƒ…â€ ---
            // å¦‚æœæ˜¯å°ˆå±¬ç´…åŒ…ä½†ä¸æ˜¯çµ¦æˆ‘çš„ï¼Œæˆ–è€…ç´…åŒ…å·²é ˜å®Œï¼Œæˆ–è€…æˆ‘å·²ç¶“é ˜éäº†ï¼Œå°±ç›´æ¥é¡¯ç¤ºè©³æƒ…ä¸¦çµæŸã€‚
            if ((packet.packetType === 'direct' && packet.receiverName !== myOriginalName && Object.keys(packet.claimedBy).length > 0) || packet.isFullyClaimed || hasClaimed) {
                showRedPacketDetails(packet);
                return;
            }
            
            // --- æ­¥é©Ÿ2: åŸ·è¡Œâ€œé ˜å–â€æ“ä½œ ---
            const claimedAmount = await handleOpenRedPacket(packet);
            
            // --- æ­¥é©Ÿ3: åœ¨â€œé ˜å–â€æˆåŠŸå¾Œï¼ŒæŒ‰å¾ªåºåŸ·è¡Œå¾ŒçºŒæ“ä½œ ---
            if (claimedAmount !== null) {
                // a. å…ˆåœ¨å¾Œè‡ºé»˜é»˜åœ°åˆ·æ–°èŠå¤©ä»‹é¢ï¼Œè®“ç´…åŒ…å¡ç‰‡ç‹€æ…‹è®Šç‚ºâ€œå·²é ˜å–â€
                await renderChatInterface(currentChatId);
                
                // b. å½ˆå‡ºâ€œæ­å–œâ€æç¤ºæ¡†ï¼Œç­‰å¾…ç”¨æˆ¶é»æ“Šâ€œå¥½çš„â€
                await showCustomAlert("æ­å–œï¼", `ä½ é ˜å–äº† ${getDisplayNameInGroup(freshChat, packet.senderName)} çš„ç´…åŒ…ï¼Œé‡‘é¡ç‚º ${claimedAmount.toFixed(2)} å…ƒã€‚`);
            }
        
            // --- æ­¥é©Ÿ4: ç„¡è«–é ˜å–æˆåŠŸèˆ‡å¦ï¼Œæœ€å¾Œéƒ½é¡¯ç¤ºè©³æƒ…é  ---
            // æ­¤æ™‚éœ€è¦å¾ state ä¸­ç²å–æœ€æ–°çš„ packet ç‰©ä»¶ï¼Œå› ç‚ºå®ƒå¯èƒ½åœ¨ handleOpenRedPacket ä¸­è¢«æ›´æ–°äº†
            const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
            if (updatedPacket) {
                showRedPacketDetails(updatedPacket);
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleOpenRedPacket å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€æ ¸å¿ƒã€‘è™•ç†ä½¿ç”¨è€…æ‰“é–‹ç´…åŒ…çš„é‚è¼¯ (V5 - å·²ä¿®å¾©æ™‚é–“æˆ³è¨˜BUG)
         */
        async function handleOpenRedPacket(packet) {
            const chat = state.chats[state.activeChatId];
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©1ï¼šåœ¨å‡½æ•¸é–‹å§‹æ™‚ï¼Œç²å–ä¸€å€‹åŸºç¤æ™‚é–“æˆ³è¨˜ â–¼â–¼â–¼
            let timestamp = Date.now(); 
        
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            
            const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
            if (remainingCount <= 0) {
                packet.isFullyClaimed = true;
                await db.chats.put(chat);
                await showCustomAlert("æ‰‹æ…¢äº†", "ç´…åŒ…å·²è¢«é ˜å®Œï¼");
                return null;
            }
            
            let claimedAmount = 0;
            const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            if (packet.packetType === 'lucky') {
                if (remainingCount === 1) { claimedAmount = remainingAmount; }
                else {
                    const min = 0.01;
                    const max = remainingAmount - (remainingCount - 1) * min;
                    claimedAmount = Math.random() * (max - min) + min;
                }
            } else { claimedAmount = packet.totalAmount; }
            claimedAmount = parseFloat(claimedAmount.toFixed(2));
        
            if (!packet.claimedBy) packet.claimedBy = {};
            packet.claimedBy[myOriginalName] = claimedAmount;
            
            const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
            if (isNowFullyClaimed) {
                packet.isFullyClaimed = true;
            }
        
            const myDisplayName = getDisplayNameInGroup(chat, myOriginalName);
            const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
        
            const visibleMessage = { 
                role: 'system', 
                type: 'pat_message', 
                content: `ä½ é ˜å–äº† ${senderDisplayName} çš„ç´…åŒ…`, 
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©2ï¼šä½¿ç”¨æˆ‘å€‘ç´¯åŠ çš„æ™‚é–“æˆ³è¨˜ â–¼â–¼â–¼
                timestamp: timestamp++ 
            };
            chat.history.push(visibleMessage);
        
            let hiddenMessageContent;
            if (isNowFullyClaimed) {
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${senderDisplayName} çš„ç´…åŒ…å·²è¢«é ˜å®Œ`,
                    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©3ï¼šç¹¼çºŒç´¯åŠ æ™‚é–“æˆ³è¨˜ â–¼â–¼â–¼
                    timestamp: timestamp++ 
                };
                chat.history.push(finishedMessage);
        
                let luckyKing = { name: '', amount: -1 };
                if (packet.packetType === 'lucky' && packet.count > 1) {
                    Object.entries(packet.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                const luckyKingDisplayName = luckyKing.name ? getDisplayNameInGroup(chat, luckyKing.name) : 'ç„¡';
                hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myDisplayName}) é ˜å–äº†æœ€å¾Œä¸€å€‹ç´…åŒ…ã€‚ç´…åŒ…å·²è¢«é ˜å®Œï¼Œæ‰‹æ°£ç‹æ˜¯ ${luckyKingDisplayName}ï¼è«‹å°æ­¤äº‹ä»¶ç™¼è¡¨è©•è«–ã€‚]`;
        
            } else {
                hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myDisplayName}) å‰›å‰›é ˜å–äº†ç´…åŒ… (æ™‚é–“æˆ³è¨˜: ${packet.timestamp})ã€‚ç´…åŒ…é‚„æœªé ˜å®Œï¼Œä½ ç¾åœ¨å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤ä¾†å˜—è©¦é ˜å–ã€‚]`;
            }
        
            const hiddenMessage = { 
                role: 'system', 
                content: hiddenMessageContent, 
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©4ï¼šç‚ºæœ€å¾Œä¸€æ¢æ¶ˆæ¯ä¹Ÿä½¿ç”¨ç´¯åŠ çš„æ™‚é–“æˆ³è¨˜ â–¼â–¼â–¼
                timestamp: timestamp++, 
                isHidden: true 
            };
            chat.history.push(hiddenMessage);
        
            await db.chats.put(chat);
            
            return claimedAmount;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é¡¯ç¤ºç´…åŒ…é ˜å–è©³æƒ…çš„æ¨¡æ…‹æ¡† (V4 - å·²ä¿®å¾©åƒæ•¸éŒ¯èª¤) â–¼â–¼â–¼
        /**
         * ã€å·²ä¿®å¾©ã€‘é¡¯ç¤ºç´…åŒ…é ˜å–è©³æƒ…çš„æ¨¡æ…‹æ¡†
         * @param {object} packet - å®Œæ•´çš„ç´…åŒ…æ¶ˆæ¯ç‰©ä»¶
         */
        async function showRedPacketDetails(packet) {
            if (!packet) {
                console.error("showRedPacketDetailsæ”¶åˆ°äº†ç„¡æ•ˆçš„packetç‰©ä»¶");
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const modal = document.getElementById('red-packet-details-modal');
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©1ï¼šåœ¨é€™è£¡ï¼Œæˆ‘å€‘åŒæ¨£ä½¿ç”¨â€œæœ¬åâ€ä¾†æª¢æŸ¥ â–¼â–¼â–¼
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            
            const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
            document.getElementById('rp-details-sender').textContent = senderDisplayName;
            document.getElementById('rp-details-greeting').textContent = packet.greeting || 'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©ï¼';
            
            const myAmountEl = document.getElementById('rp-details-my-amount');
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©2ï¼šç”¨â€œæœ¬åâ€ä¾†æŸ¥æ‰¾æˆ‘é ˜å–çš„é‡‘é¡ â–¼â–¼â–¼
            if (packet.claimedBy && packet.claimedBy[myOriginalName]) {
                myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myOriginalName].toFixed(2);
                myAmountEl.style.display = 'block';
            } else {
                myAmountEl.style.display = 'none';
            }
        
            const claimedCount = Object.keys(packet.claimedBy || {}).length;
            const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            let summaryText = `${claimedCount}/${packet.count}å€‹ç´…åŒ…ï¼Œå…±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
            if (!packet.isFullyClaimed && claimedCount < packet.count) {
                const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
                if(timeLeft > 0) summaryText += ` å‰©é¤˜ç´…åŒ…å°‡åœ¨${timeLeft}å°æ™‚å…§é€€é‚„ã€‚`;
            }
            document.getElementById('rp-details-summary').textContent = summaryText;
        
            const listEl = document.getElementById('rp-details-list');
            listEl.innerHTML = '';
            const claimedEntries = Object.entries(packet.claimedBy || {});
            
            let luckyKing = { name: '', amount: -1 };
            if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
                claimedEntries.forEach(([name, amount]) => {
                    if (amount > luckyKing.amount) {
                        luckyKing = { name, amount };
                    }
                });
            }
        
            claimedEntries.sort((a,b) => b[1] - a[1]);
        
            claimedEntries.forEach(([originalName, amount]) => {
                const item = document.createElement('div');
                item.className = 'rp-details-item';
                let luckyTag = '';
                if (luckyKing.name && originalName === luckyKing.name) {
                    luckyTag = '<span class="lucky-king-tag">æ‰‹æ°£ç‹</span>';
                }
                
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©3ï¼šå°‡æ‰€æœ‰é ˜å–è€…çš„â€œæœ¬åâ€éƒ½è½‰æ›ç‚ºæ­£ç¢ºçš„â€œé¡¯ç¤ºåç¨±â€ â–¼â–¼â–¼
                const claimerDisplayName = getDisplayNameInGroup(chat, originalName);
        
                item.innerHTML = `
                    <span class="name">${claimerDisplayName}</span>
                    <span class="amount">${amount.toFixed(2)} å…ƒ</span>
                    ${luckyTag}
                `;
                listEl.appendChild(item);
            });
        
            modal.classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // ç¶å®šé—œé–‰è©³æƒ…æŒ‰éˆ•çš„äº‹ä»¶
        document.getElementById('close-rp-details-btn').addEventListener('click', () => {
            document.getElementById('red-packet-details-modal').classList.remove('visible');
        });
        
        // ä¾›å…¨åŸŸèª¿ç”¨çš„å‡½æ•¸ï¼Œä»¥ä¾¿ç´…åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
        window.handlePacketClick = handlePacketClick;
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹å‰µå»ºæŠ•ç¥¨çš„æ¨¡æ…‹æ¡†ä¸¦åˆå§‹åŒ–
         */
        function openCreatePollModal() {
            const modal = document.getElementById('create-poll-modal');
            document.getElementById('poll-question-input').value = '';
            const optionsContainer = document.getElementById('poll-options-container');
            optionsContainer.innerHTML = '';
            
            // é è¨­å‰µå»ºå…©å€‹ç©ºçš„é¸é …æ¡†
            addPollOptionInput();
            addPollOptionInput();
            
            modal.classList.add('visible');
        }
        
        /**
         * åœ¨æ¨¡æ…‹æ¡†ä¸­å‹•æ…‹æ·»åŠ ä¸€å€‹é¸é …è¼¸å…¥æ¡†
         */
        function addPollOptionInput() {
            const container = document.getElementById('poll-options-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'poll-option-input-wrapper';
            wrapper.innerHTML = `
                <input type="text" class="poll-option-input" placeholder="é¸é …å…§å®¹...">
                <button class="remove-option-btn">-</button>
            `;
            
            wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
                // ç¢ºä¿è‡³å°‘ä¿ç•™å…©å€‹é¸é …
                if (container.children.length > 2) {
                    wrapper.remove();
                } else {
                    alert('æŠ•ç¥¨è‡³å°‘éœ€è¦2å€‹é¸é …ã€‚');
                }
            });
            
            container.appendChild(wrapper);
        }
        
        /**
         * ç”¨æˆ¶ç¢ºèªç™¼èµ·æŠ•ç¥¨
         */
        async function sendPoll() {
            if (!state.activeChatId) return;
            
            const question = document.getElementById('poll-question-input').value.trim();
            if (!question) {
                alert('è«‹è¼¸å…¥æŠ•ç¥¨å•é¡Œï¼');
                return;
            }
            
            const options = Array.from(document.querySelectorAll('.poll-option-input'))
                .map(input => input.value.trim())
                .filter(text => text); // éæ¿¾æ‰ç©ºçš„é¸é …
        
            if (options.length < 2) {
                alert('è«‹è‡³å°‘è¼¸å…¥2å€‹æœ‰æ•ˆçš„æŠ•ç¥¨é¸é …ï¼');
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            const newPollMessage = {
                role: 'user',
                senderName: myNickname,
                type: 'poll',
                timestamp: Date.now(),
                question: question,
                options: options,
                votes: {}, // åˆå§‹æŠ•ç¥¨ç‚ºç©º
                isClosed: false,
            };
            
            chat.history.push(newPollMessage);
            await db.chats.put(chat);
            
            appendMessage(newPollMessage, chat);
            renderChatList();
            
            document.getElementById('create-poll-modal').classList.remove('visible');
        }
        
        // â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©é‡è¤‡é»æ“Šå•é¡Œã€‘çš„ç‰ˆæœ¬æ›¿æ› handleUserVote å‡½æ•¸ â–¼â–¼â–¼
        /**
         * è™•ç†ä½¿ç”¨è€…æŠ•ç¥¨ï¼Œä¸¦å°‡äº‹ä»¶ä½œç‚ºéš±è—æ¶ˆæ¯å­˜å…¥æ­·å²è¨˜éŒ„
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         * @param {string} choice - ä½¿ç”¨è€…é¸æ“‡çš„é¸é …æ–‡æœ¬
         */
        async function handleUserVote(timestamp, choice) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        
            // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²é—œé–‰ï¼Œç›´æ¥è¿”å›
            if (!poll || poll.isClosed) {
                // å¦‚æœæ˜¯å·²é—œé–‰çš„æŠ•ç¥¨ï¼Œå‰‡ç›´æ¥é¡¯ç¤ºçµæœ
                if (poll && poll.isClosed) {
                    showPollResults(timestamp);
                }
                return;
            }
        
            // 2. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é»æ“Šäº†å·²ç¶“æŠ•éçš„åŒä¸€å€‹é¸é …
            const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
            
            // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœä¸æ˜¯é‡è¤‡é»æ“Šï¼Œæ‰åŸ·è¡ŒæŠ•ç¥¨é‚è¼¯
            if (!isReclickingSameOption) {
                // ç§»é™¤èˆŠæŠ•ç¥¨ï¼ˆå¦‚æœç”¨æˆ¶æ”¹é¸ï¼‰
                for (const option in poll.votes) {
                    const voterIndex = poll.votes[option].indexOf(myNickname);
                    if (voterIndex > -1) {
                        poll.votes[option].splice(voterIndex, 1);
                    }
                }
                // æ·»åŠ æ–°æŠ•ç¥¨
                if (!poll.votes[choice]) {
                    poll.votes[choice] = [];
                }
                poll.votes[choice].push(myNickname);
            }
            
            // 4. ã€æ ¸å¿ƒé‚è¼¯ã€‘ç¾åœ¨åªè™•ç†ä½¿ç”¨è€…æŠ•ç¥¨äº‹ä»¶ï¼Œä¸å†æª¢æŸ¥æ˜¯å¦çµæŸ
            let hiddenMessageContent = null; 
            
            // åªæœ‰åœ¨ç”¨æˆ¶çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ™‚ï¼Œæ‰ç”Ÿæˆæç¤º
            if (!isReclickingSameOption) {
                 hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myNickname}) å‰›å‰›æŠ•ç¥¨çµ¦äº† â€œ${choice}â€ã€‚]`;
            }
        
            // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶ï¼Œå‰‡å‰µå»ºä¸¦æ·»åŠ éš±è—æ¶ˆæ¯
            if (hiddenMessageContent) {
                const hiddenMessage = {
                    role: 'system',
                    content: hiddenMessageContent,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
            }
            
            // 6. ä¿å­˜è³‡æ–™ä¸¦æ›´æ–°UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId); 
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * ä½¿ç”¨è€…çµæŸæŠ•ç¥¨ï¼Œä¸¦å°‡äº‹ä»¶ä½œç‚ºéš±è—æ¶ˆæ¯å­˜å…¥æ­·å²è¨˜éŒ„
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        async function endPoll(timestamp) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            if (!poll || poll.isClosed) return;
        
            const confirmed = await showCustomConfirm("çµæŸæŠ•ç¥¨", "ç¢ºå®šè¦çµæŸé€™å€‹æŠ•ç¥¨å—ï¼ŸçµæŸå¾Œå°‡ç„¡æ³•å†é€²è¡ŒæŠ•ç¥¨ã€‚");
            if (confirmed) {
                poll.isClosed = true;
        
                const resultSummary = poll.options.map(opt => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`).join('ï¼Œ');
                const hiddenMessageContent = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ‰‹å‹•çµæŸäº†æŠ•ç¥¨ï¼æœ€çµ‚çµæœç‚ºï¼š${resultSummary}ã€‚]`;
                
                const hiddenMessage = {
                    role: 'system',
                    content: hiddenMessageContent,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
        
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªä¿å­˜è³‡æ–™å’Œæ›´æ–°UIï¼Œä¸èª¿ç”¨ triggerAiResponse()
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * é¡¯ç¤ºæŠ•ç¥¨çµæœè©³æƒ…
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        // â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©ã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ showPollResults å‡½æ•¸ â–¼â–¼â–¼
        function showPollResults(timestamp) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            if (!poll || !poll.isClosed) return;
        
            let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
            
            if (Object.keys(poll.votes).length === 0) {
                resultsHtml += '<p style="color: #8a8a8a;">é‚„æ²’æœ‰äººæŠ•ç¥¨ã€‚</p>';
            } else {
                poll.options.forEach(option => {
                    const voters = poll.votes[option] || [];
                    
                    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡è½‰æ› voter çš„æœ¬åç‚ºç¾¤æ˜µç¨±
                    const displayVoters = voters.map(originalName => getDisplayNameInGroup(chat, originalName)).join('ã€ ');
        
                    resultsHtml += `
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
                            <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                                ${voters.length > 0 ? displayVoters : 'ç„¡äººæŠ•ç¥¨'}
                            </p>
                        </div>
                    `;
                });
            }
        
            showCustomAlert("æŠ•ç¥¨çµæœ", resultsHtml);
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIé ­åƒåº«ç®¡ç†åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹AIé ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
         */
        function openAiAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('ai-avatar-library-title').textContent = `â€œ${chat.name}â€çš„é ­åƒåº«`;
            renderAiAvatarLibrary();
            document.getElementById('ai-avatar-library-modal').classList.add('visible');
        }
        
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">é€™å€‹é ­åƒåº«é‚„æ˜¯ç©ºçš„ï¼Œé»æ“Šå³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // è¤‡ç”¨æ¨£å¼
        item.title = avatar.name;

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼
        // æˆ‘å€‘ç¾åœ¨å‰µå»ºäº† CSS æœŸæœ›çš„å…§éƒ¨çµæ§‹
        item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤é ­åƒ', `ç¢ºå®šè¦å¾é ­åƒåº«ä¸­åˆªé™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ addAvatarToLibrary / addAvatarToLibraryFromURL å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€é‡å‘½åå¾Œã€‘å‘ç•¶å‰AIçš„é ­åƒåº«ä¸­é€šéURLæ·»åŠ æ–°é ­åƒ
         */
        async function addAvatarToLibraryFromURL() {
            const name = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹ç‚ºé€™å€‹é ­åƒèµ·å€‹åå­—ï¼ˆä¾‹å¦‚ï¼šé–‹å¿ƒã€å“­æ³£ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹è¼¸å…¥é ­åƒçš„åœ–ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.aiAvatarLibrary) {
                chat.settings.aiAvatarLibrary = [];
            }
        
            chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderAiAvatarLibrary();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * é—œé–‰AIé ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
         */
        function closeAiAvatarLibraryModal() {
            document.getElementById('ai-avatar-library-modal').classList.remove('visible');
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€é ­åƒåº«ç®¡ç†åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹â€œæˆ‘çš„â€é ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
         */
        function openMyAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('my-avatar-library-title').textContent = `â€œ${chat.settings.myNickname || 'æˆ‘'}â€çš„é ­åƒåº«`;
            renderMyAvatarLibrary();
            document.getElementById('my-avatar-library-modal').classList.add('visible');
        }
        
/**
 * ã€å·²ä¿®å¾©ã€‘æ¸²æŸ“â€œæˆ‘çš„â€é ­åƒåº«çš„å…§å®¹
 */
function renderMyAvatarLibrary() {
    const grid = document.getElementById('my-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.myAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">é€™å€‹é ­åƒåº«é‚„æ˜¯ç©ºçš„ï¼Œé»æ“Šå³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.title = avatar.name;

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼
        item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤é ­åƒ', `ç¢ºå®šè¦å¾ä½ çš„é ­åƒåº«ä¸­åˆªé™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.myAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderMyAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}
        
        /**
         * å‘â€œæˆ‘çš„â€é ­åƒåº«ä¸­é€šéURLæ·»åŠ æ–°é ­åƒ
         */
        async function addAvatarToMyLibraryFromURL() {
            const name = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹ç‚ºé€™å€‹é ­åƒèµ·å€‹åå­—ï¼ˆä¾‹å¦‚ï¼šé–‹å¿ƒã€å“­æ³£ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹è¼¸å…¥é ­åƒçš„åœ–ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.myAvatarLibrary) {
                chat.settings.myAvatarLibrary = [];
            }
        
            chat.settings.myAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderMyAvatarLibrary();
        }
        
        /**
         * è™•ç†æœ¬åœ°ä¸Šå‚³é ­åƒåˆ°â€œæˆ‘çš„â€é ­åƒåº«
         */
        async function handleLocalMyAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            const name = await showCustomPrompt("å‘½åé ­åƒ", "è«‹ç‚ºé€™å€‹æ–°é ­åƒå‘½å");
            if (!name || !name.trim()) return;
        
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.myAvatarLibrary) {
                chat.settings.myAvatarLibrary = [];
            }
            chat.settings.myAvatarLibrary.push({ name: name.trim(), url: base64Url });
            
            await db.chats.put(chat);
            renderMyAvatarLibrary();
            event.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é¸æ“‡
        }
        
        /**
         * æ‰¹é‡å°å…¥é ­åƒåˆ°â€œæˆ‘çš„â€é ­åƒåº«
         */
        async function handleBatchImportForMyAvatar(text) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const lines = text.trim().split('\n');
            const newAvatars = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('å¡«å…¥')) continue;
                
                let name = null, code = null;
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }
        
                if (name && code && code.includes('.')) {
                    newAvatars.push({ name: name, url: baseUrl + code });
                } else {
                    errorCount++;
                }
            }
        
            if (errorCount > 0) await showCustomAlert('éƒ¨åˆ†å°å…¥å¤±æ•—', `æœ‰ ${errorCount} è¡Œçš„æ ¼å¼ä¸æ­£ç¢ºï¼Œå·²è¢«è·³éã€‚`);
            
            if (newAvatars.length > 0) {
                if (!chat.settings.myAvatarLibrary) chat.settings.myAvatarLibrary = [];
                chat.settings.myAvatarLibrary.push(...newAvatars);
                await db.chats.put(chat);
                renderMyAvatarLibrary();
                await showCustomAlert('å°å…¥æˆåŠŸ', `å·²æˆåŠŸæ‰¹é‡å°å…¥ ${newAvatars.length} å€‹æ–°é ­åƒï¼`);
            } else if (errorCount === 0) {
                alert("æ²’æœ‰æ‰¾åˆ°å¯å°å…¥çš„å…§å®¹ã€‚");
            }
        }
        
        /**
         * é—œé–‰â€œæˆ‘çš„â€é ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
         */
        function closeMyAvatarLibraryModal() {
            document.getElementById('my-avatar-library-modal').classList.remove('visible');
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤é ­åƒåº«ç®¡ç†åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹ç¾¤é ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
         */
        function openGroupAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('group-avatar-library-title').textContent = `â€œ${chat.name}â€çš„é ­åƒåº«`;
            renderGroupAvatarLibrary();
            document.getElementById('group-avatar-library-modal').classList.add('visible');
        }
        
/**
 * ã€å·²ä¿®å¾©ã€‘æ¸²æŸ“ç¾¤é ­åƒåº«çš„å…§å®¹
 */
function renderGroupAvatarLibrary() {
    const grid = document.getElementById('group-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.groupAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">é€™å€‹é ­åƒåº«é‚„æ˜¯ç©ºçš„ï¼Œé»æ“Šå³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.title = avatar.name;

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼
        item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆªé™¤é ­åƒ', `ç¢ºå®šè¦å¾é ­åƒåº«ä¸­åˆªé™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.groupAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderGroupAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}
        
        /**
         * å‘ç•¶å‰ç¾¤èŠçš„é ­åƒåº«ä¸­æ·»åŠ æ–°é ­åƒ
         */
        async function addAvatarToGroupLibraryFromUR() {
            const name = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹ç‚ºé€™å€‹é ­åƒèµ·å€‹åå­—ï¼ˆä¾‹å¦‚ï¼šæ˜¥æ—¥é‡é¤ã€å­¸ç¿’æ™‚é–“ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹è¼¸å…¥é ­åƒçš„åœ–ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.groupAvatarLibrary) {
                chat.settings.groupAvatarLibrary = [];
            }
        
            chat.settings.groupAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderGroupAvatarLibrary();
        }
        
        /**
         * é—œé–‰ç¾¤é ­åƒåº«ç®¡ç†æ¨¡æ…‹æ¡†
         */
        function closeGroupAvatarLibraryModal() {
            document.getElementById('group-avatar-library-modal').classList.remove('visible');
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ‰¹é‡å°å…¥é ­åƒçš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ‰“é–‹æ‰¹é‡å°å…¥çš„å½ˆçª—
         * @param {string} type - å°å…¥é¡å‹, 'ai' æˆ– 'group'
         */
        async function openBatchImportModal(type) {
            const placeholderText = `è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é»è²¼ï¼Œä¸€è¡Œä¸€å€‹ï¼š\n\nç„¦æ…® 2a9wte.jpeg\nå¤§é©šå¤±è‰² or8qf4.png\næ²’æœ‰éˆæ„Ÿ njwujh.jpeg`;
            
            // è¤‡ç”¨æˆ‘å€‘å¼·å¤§çš„è‡ªè¨‚è¼¸å…¥æ¡†å‡½æ•¸
            const pastedText = await showCustomPrompt(
                'æ‰¹é‡å°å…¥é ­åƒ',
                placeholderText,
                '',
                'textarea' // ä½¿ç”¨å¤šè¡Œæ–‡å­—æ–¹å¡Š
            );
        
            // å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†å…§å®¹ä¸¦é»æ“Šâ€œç¢ºå®šâ€
            if (pastedText && pastedText.trim()) {
                await handleBatchImport(type, pastedText);
            }
        }
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleBatchImport â–¼â–¼â–¼
        /**
         * ã€æ ¸å¿ƒé‚è¼¯ã€‘è™•ç†é»è²¼çš„æ–‡æœ¬ï¼Œè§£æä¸¦å­˜å…¥è³‡æ–™åº« (V4 - çµ‚æ¥µæ™ºèƒ½ç‰ˆ)
         * @param {string} type - å°å…¥é¡å‹, 'ai' æˆ– 'group'
         * @param {string} text - ä½¿ç”¨è€…é»è²¼çš„æ–‡æœ¬å…§å®¹
         */
        async function handleBatchImport(type, text) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const lines = text.trim().split('\n');
            const newAvatars = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
        
                if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('å¡«å…¥')) {
                    continue; 
                }
        
                let name = null;
                let code = null;
        
                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                //            é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒæ‰€åœ¨ï¼
                //  å…¨æ–°çš„ã€èƒ½åŒæ™‚è™•ç†â€œæœ‰ç©ºæ ¼â€å’Œâ€œç„¡ç©ºæ ¼â€å…©ç¨®æ ¼å¼çš„è§£æé‚è¼¯
                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
                // æ­¥é©Ÿ1ï¼šå˜—è©¦ç”¨è¦å‰‡é‹ç®—å¼åŒ¹é… â€œä¸­æ–‡å+è‹±æ–‡ä»£ç¢¼â€ çš„ç„¡ç©ºæ ¼æ ¼å¼
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    // å¦‚æœåŒ¹é…æˆåŠŸï¼Œç›´æ¥æå–
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    // æ­¥é©Ÿ2ï¼šå¦‚æœæ­£å‰‡åŒ¹é…å¤±æ•—ï¼Œå°±å›é€€åˆ°ä¹‹å‰æŒ‰ç©ºæ ¼åˆ†å‰²çš„é‚è¼¯
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }
        
                // æ­¥é©Ÿ3ï¼šæœ€å¾Œé©—è­‰è§£æçµæœæ˜¯å¦æœ‰æ•ˆ
                if (name && code && code.includes('.')) {
                    newAvatars.push({
                        name: name,
                        url: baseUrl + code
                    });
                } else {
                    errorCount++;
                    console.warn('æ‰¹é‡å°å…¥æ ¼å¼éŒ¯èª¤ï¼Œå·²è·³éæ­¤è¡Œ:', trimmedLine);
                }
            }
        
            if (errorCount > 0) {
                await showCustomAlert('éƒ¨åˆ†å°å…¥å¤±æ•—', `æœ‰ ${errorCount} è¡Œçš„æ ¼å¼ä¸æ­£ç¢ºï¼Œå·²è¢«ç³»çµ±è·³éã€‚`);
            }
        
            if (newAvatars.length > 0) {
                if (type === 'ai') {
                    if (!chat.settings.aiAvatarLibrary) chat.settings.aiAvatarLibrary = [];
                    chat.settings.aiAvatarLibrary.push(...newAvatars);
                    await db.chats.put(chat);
                    renderAiAvatarLibrary();
                } else if (type === 'group') {
                    if (!chat.settings.groupAvatarLibrary) chat.settings.groupAvatarLibrary = [];
                    chat.settings.groupAvatarLibrary.push(...newAvatars);
                    await db.chats.put(chat);
                    renderGroupAvatarLibrary();
                }
                await showCustomAlert('å°å…¥æˆåŠŸ', `å·²æˆåŠŸæ‰¹é‡å°å…¥ ${newAvatars.length} å€‹æ–°é ­åƒï¼`);
            } else if (errorCount === 0) {
                alert("æ²’æœ‰æ‰¾åˆ°å¯å°å…¥çš„å…§å®¹ã€‚è«‹æª¢æŸ¥æ‚¨é»è²¼çš„æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç¢¼ï¼Œè«‹é»è²¼åœ¨é€™è£¡ã€‘ â–¼â–¼â–¼
        
        /**
         * ã€é‡å‘½åå¾Œã€‘å‘ç•¶å‰ç¾¤èŠçš„é ­åƒåº«ä¸­é€šéURLæ·»åŠ æ–°é ­åƒ
         */
        async function addAvatarToGroupLibraryFromURL() {
            const name = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹ç‚ºé€™å€‹é ­åƒèµ·å€‹åå­—ï¼ˆä¾‹å¦‚ï¼šæ˜¥æ—¥é‡é¤ã€å­¸ç¿’æ™‚é–“ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ é ­åƒ", "è«‹è¼¸å…¥é ­åƒçš„åœ–ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.groupAvatarLibrary) {
                chat.settings.groupAvatarLibrary = [];
            }
        
            chat.settings.groupAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderGroupAvatarLibrary();
        }
        
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©æ¸…å–®é•·æŒ‰æ“ä½œåŠŸèƒ½è¡¨çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * é¡¯ç¤ºä¸€å€‹åŒ…å«â€œç½®é ‚â€å’Œâ€œåˆªé™¤â€é¸é …çš„æ“ä½œåŠŸèƒ½è¡¨
         * @param {object} chat - è¢«é•·æŒ‰çš„èŠå¤©å°è±¡
         * @returns {Promise<string|null>} - è¿”å›ä¸€å€‹Promiseï¼Œç•¶ç”¨æˆ¶é»æ“Šæ™‚è§£æç‚º 'pin', 'delete', æˆ– null (å–æ¶ˆ)
         */
        function showChatListActions(chat) {
            return new Promise(resolve => {
                const modal = document.getElementById('chat-list-actions-modal');
                const pinBtn = document.getElementById('chat-list-action-pin');
                const deleteBtn = document.getElementById('chat-list-action-delete');
                const cancelBtn = document.getElementById('chat-list-action-cancel');
        
                // æ ¹æ“šç•¶å‰èŠå¤©æ˜¯å¦å·²ç½®é ‚ï¼Œå‹•æ…‹è¨­ç½®æŒ‰éˆ•æ–‡å­—
                pinBtn.textContent = chat.isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚èŠå¤©';
        
                // ä½¿ç”¨å…‹éš†ç¯€é»æŠ€å·§ï¼Œç¢ºä¿æ¯æ¬¡æ‰“é–‹åŠŸèƒ½è¡¨æ™‚éƒ½ç¶å®šå…¨æ–°çš„ã€ä¹¾æ·¨çš„äº‹ä»¶ç›£è½å™¨
                const newPinBtn = pinBtn.cloneNode(true);
                pinBtn.parentNode.replaceChild(newPinBtn, pinBtn);
                newPinBtn.onclick = () => { modal.classList.remove('visible'); resolve('pin'); };
        
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                newDeleteBtn.onclick = () => { modal.classList.remove('visible'); resolve('delete'); };
        
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.onclick = () => { modal.classList.remove('visible'); resolve(null); };
        
                modal.classList.add('visible');
            });
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºCPhoneæ–°å¢çš„æ‰€æœ‰åŠŸèƒ½å‡½æ•¸ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

        /**
         * ã€å…¨æ–°ã€‘å°‡ä¿å­˜çš„CPhoneå£ç´™æ‡‰ç”¨åˆ°Cphoneè¢å¹•
         */
function applyCPhoneWallpaper() {
    const charPhoneScreen = document.getElementById('character-phone-screen');
    const wallpaper = state.globalSettings.cphoneWallpaper;
    if (wallpaper) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘çµ±ä¸€ä½¿ç”¨ url() åŒ…è£¹
        charPhoneScreen.style.backgroundImage = `url(${wallpaper})`;
    } else {
        // æ¢å¾©é»˜èªæ¼¸è®Š
        charPhoneScreen.style.backgroundImage = 'linear-gradient(135deg, #f6d365, #fda085)';
    }
}

        /**
         * ã€å…¨æ–°ã€‘å°‡ä¿å­˜çš„åœ–ç¤ºURLæ‡‰ç”¨åˆ°CPhoneçš„Appåœ–ç¤ºä¸Š
         */
        function applyCPhoneAppIcons() {
            if (!state.globalSettings.cphoneAppIcons) return;

            for (const iconId in state.globalSettings.cphoneAppIcons) {
                const imgElement = document.getElementById(`cphone-icon-img-${iconId}`);
                if (imgElement) {
                    imgElement.src = state.globalSettings.cphoneAppIcons[iconId];
                }
            }
        }

        /**
         * ã€å…¨æ–°ã€‘åœ¨å¤–è§€è¨­ç½®é é¢æ¸²æŸ“å‡ºæ‰€æœ‰CPhone Appåœ–ç¤ºçš„è¨­ç½®é …
         */
        function renderCPhoneIconSettings() {
            const grid = document.getElementById('cphone-icon-settings-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const cphoneAppLabels = {
                'qq': 'QQ', 'album': 'ç›¸å†Š', 'browser': 'æµè¦½å™¨', 'taobao': 'æ·˜å¯¶',
                'memo': 'å‚™å¿˜éŒ„', 'diary': 'æ—¥è¨˜', 'amap': 'é«˜å¾·åœ°åœ–', 'usage': 'Appè¨˜éŒ„',
                'music': 'ç¶²æ˜“é›²', 'ephone': 'Ephone'
            };

            for (const iconId in state.globalSettings.cphoneAppIcons) {
                const iconUrl = state.globalSettings.cphoneAppIcons[iconId];
                const labelText = cphoneAppLabels[iconId] || 'æœªçŸ¥App';

                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                item.dataset.iconId = iconId;

                item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">æ›´æ›</button>
                `;
                grid.appendChild(item);
            }
        }

        // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ è«‹å°‡é€™å…©å€‹ã€æ–°å‡½æ•¸ã€‘é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å°‡ä¿å­˜çš„åœ–ç¤ºURLæ‡‰ç”¨åˆ°ä¸»è¢å¹•çš„Appåœ–ç¤ºä¸Š
         */
        function applyAppIcons() {
            if (!state.globalSettings.appIcons) return;
        
            for (const iconId in state.globalSettings.appIcons) {
                const imgElement = document.getElementById(`icon-img-${iconId}`);
                if (imgElement) {
                    imgElement.src = state.globalSettings.appIcons[iconId];
                }
            }
        }
        
        /**
         * ã€å…¨æ–°ã€‘åœ¨å¤–è§€è¨­ç½®é é¢æ¸²æŸ“å‡ºæ‰€æœ‰Appåœ–ç¤ºçš„è¨­ç½®é …
         */
        function renderIconSettings() {
            const grid = document.getElementById('icon-settings-grid');
            if (!grid) return;
            grid.innerHTML = '';
        
    const appLabels = {
       'qq': 'QQ',
       'world-book': 'ä¸–ç•Œæ›¸',
       'wallpaper': 'å¤–è§€è¨­ç½®',
       'renderer': 'æ¸²æŸ“å™¨',
       'api-settings': 'APIè¨­ç½®',
       'font': 'å­—é«”',
       'char-phone': 'Cphone',
       'douban': 'è±†ç“£å°çµ„',
       // ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šåœ¨é€™è£¡ç‚ºâ€œé è¨­â€Appæ·»åŠ å°æ‡‰çš„ä¸­æ–‡åã€‘ã€‘ã€‘
       'preset': 'é è¨­',
           // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°çš„ä¸€è¡Œ â–¼â–¼â–¼
           'tutorial': 'æ•™ç¨‹',
   'werewolf': 'ç‹¼äººæ®º',
   // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°çš„ä¸€è¡Œ â–¼â–¼â–¼
   'x': 'X'
    };
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
            for (const iconId in state.globalSettings.appIcons) {
                const iconUrl = state.globalSettings.appIcons[iconId];
                const labelText = appLabels[iconId] || 'Cphone';
        
                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                // ã€é‡è¦ã€‘æˆ‘å€‘ç”¨ data-icon-id ä¾†æ¨™è¨˜é€™å€‹è¨­ç½®é …å°æ‡‰å“ªå€‹åœ–ç¤º
                item.dataset.iconId = iconId; 
        
                item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">æ›´æ›</button>
                `;
                grid.appendChild(item);
            }
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æ”¯æŒHTMLæ ¼å¼ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ openBrowser å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ç•¶ä½¿ç”¨è€…é»é¸é€£çµå¡ç‰‡æ™‚ï¼Œæ‰“é–‹å½æµè¦½å™¨
         * @param {number} timestamp - è¢«é»æ“Šæ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        function openBrowser(timestamp) {
            if (!state.activeChatId) return;
        
            const chat = state.chats[state.activeChatId];
            // å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿ chat å’Œ history éƒ½å­˜åœ¨
            if (!chat || !chat.history) return;
        
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'share_link') {
                console.error("ç„¡æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯é¡å‹ä¸åŒ¹é…çš„åˆ†äº«é€£çµ:", timestamp);
                return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥é€€å‡º
            }
        
            // å¡«å……æµè¦½å™¨å…§å®¹
            document.getElementById('browser-title').textContent = message.source_name || 'æ–‡ç« è©³æƒ…';
            const browserContent = document.getElementById('browser-content');
            browserContent.innerHTML = `
                <h1 class="article-title">${message.title || 'ç„¡æ¨™é¡Œ'}</h1>
                <div class="article-meta">
                    <span>ä¾†æº: ${message.source_name || 'æœªçŸ¥'}</span>
                </div>
                <div class="article-body">
                    <p>${(message.content || 'å…§å®¹ç‚ºç©ºã€‚').replace(/\n/g, '</p><p>')}</p>
                </div>
            `;
        
            // é¡¯ç¤ºæµè¦½å™¨è¢å¹•
            showScreen('browser-screen');
        }
        
        /**
         * é—œé–‰å½æµè¦½å™¨ï¼Œè¿”å›èŠå¤©ä»‹é¢
         * (é€™å€‹å‡½æ•¸ç¾åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›£è½å™¨èª¿ç”¨)
         */
        function closeBrowser() {
            showScreen('chat-interface-screen'); 
        }
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * é—œé–‰å½æµè¦½å™¨ï¼Œè¿”å›èŠå¤©ä»‹é¢
         * (é€™å€‹å‡½æ•¸ç¾åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›£è½å™¨èª¿ç”¨)
         */
        function closeBrowser() {
            showScreen('chat-interface-screen'); 
        }
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…åˆ†äº«é€£çµåŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹è®“ä½¿ç”¨è€…å¡«å¯«é€£çµè³‡è¨Šçš„æ¨¡æ…‹æ¡†
         */
        function openShareLinkModal() {
            if (!state.activeChatId) return;
        
            // æ¸…ç©ºä¸Šæ¬¡è¼¸å…¥çš„å…§å®¹
            document.getElementById('link-title-input').value = '';
            document.getElementById('link-description-input').value = '';
            document.getElementById('link-source-input').value = '';
            document.getElementById('link-content-input').value = '';
        
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('share-link-modal').classList.add('visible');
        }
        
        /**
         * ä½¿ç”¨è€…ç¢ºèªåˆ†äº«ï¼Œå‰µå»ºä¸¦ç™¼é€é€£çµå¡ç‰‡æ¶ˆæ¯
         */
        async function sendUserLinkShare() {
            if (!state.activeChatId) return;
        
            const title = document.getElementById('link-title-input').value.trim();
            if (!title) {
                alert("æ¨™é¡Œæ˜¯å¿…å¡«é …å“¦ï¼");
                return;
            }
        
            const description = document.getElementById('link-description-input').value.trim();
            const sourceName = document.getElementById('link-source-input').value.trim();
            const content = document.getElementById('link-content-input').value.trim();
        
            const chat = state.chats[state.activeChatId];
            
            // å‰µå»ºæ¶ˆæ¯ç‰©ä»¶
            const linkMessage = {
                role: 'user', // è§’è‰²æ˜¯ 'user'
                type: 'share_link',
                timestamp: Date.now(),
                title: title,
                description: description,
                source_name: sourceName,
                content: content,
                // ä½¿ç”¨è€…åˆ†äº«çš„é€£çµï¼Œæˆ‘å€‘ä¸æä¾›åœ–ç‰‡ï¼Œè®“å®ƒç¸½æ˜¯é¡¯ç¤ºå é»é™£åœ–
                thumbnail_url: null 
            };
        
            // å°‡æ¶ˆæ¯æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
            chat.history.push(linkMessage);
            await db.chats.put(chat);
        
            // æ¸²æŸ“æ–°æ¶ˆæ¯ä¸¦æ›´æ–°æ¸…å–®
            appendMessage(linkMessage, chat);
            renderChatList();
        
            // é—œé–‰æ¨¡æ…‹æ¡†
            document.getElementById('share-link-modal').classList.remove('visible');
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
/**
 * ã€V2.1 | NPCå¯è¦‹æ€§ä¿®å¾©ç‰ˆã€‘æ ¹æ“šAIçš„è¦–è§’ï¼Œéæ¿¾å‡ºå®ƒèƒ½çœ‹åˆ°çš„å‹•æ…‹
 * @param {Array} allPosts - æ‰€æœ‰å¾…æª¢æŸ¥çš„å‹•æ…‹å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€å‹•æ…‹çš„é‚£å€‹AIçš„chatç‰©ä»¶
 * @returns {Array} - éæ¿¾å¾Œè©²AIå¯è¦‹çš„å‹•æ…‹å¸–å­
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return [];

    const viewerGroupId = viewerChat.groupId;
    const viewerId = viewerChat.id; // æŸ¥çœ‹è€…è‡ªå·±çš„ID

    return allPosts.filter(post => {
        // è¦å‰‡1ï¼šä½¿ç”¨è€…ç™¼ä½ˆçš„å‹•æ…‹ï¼ˆé‚è¼¯ä¸è®Šï¼‰
        if (post.authorId === 'user') {
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            return true;
        }
        
        // --- â–¼â–¼â–¼ å…¨æ–°çš„æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼ ---

        // è¦å‰‡2ï¼šã€æ–°å¢ã€‘è™•ç†NPCç™¼ä½ˆçš„å‹•æ…‹
        if (String(post.authorId).startsWith('npc_')) {
            // å¦‚æœå¸–å­æœ‰ `visibleTo` åˆ—è¡¨ï¼Œæª¢æŸ¥æŸ¥çœ‹è€…çš„IDæ˜¯å¦åœ¨å…¶ä¸­
            if (Array.isArray(post.visibleTo)) {
                return post.visibleTo.includes(viewerId);
            }
            // å¦‚æœæ²’æœ‰ `visibleTo` æ¸…å–®ï¼ˆç•°å¸¸æƒ…æ³ï¼‰ï¼Œé è¨­ä¸å¯è¦‹
            return false;
        }

        // --- â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² ---

        // è¦å‰‡3ï¼šAIè§’è‰²ä¹‹é–“ç™¼ä½ˆçš„å‹•æ…‹ï¼ˆé‚è¼¯ä¸è®Šï¼‰
        const authorChat = state.chats[post.authorId];
        if (!authorChat) {
            return false;
        }
        const authorGroupId = authorChat.groupId;

        const inSameGroup = authorGroupId && viewerGroupId && authorGroupId === viewerGroupId;
        const bothUnGrouped = !authorGroupId && !viewerGroupId;

        return inSameGroup || bothUnGrouped;
    });
}
        
        /**
         * æ‡‰ç”¨æŒ‡å®šçš„ä¸»é¡Œï¼ˆ'light' æˆ– 'dark'ï¼‰
         * @param {string} theme - è¦æ‡‰ç”¨çš„ä¸»é¡Œåç¨±
         */
        function applyTheme(theme) {
            const phoneScreen = document.getElementById('phone-screen');
            const toggleSwitch = document.getElementById('theme-toggle-switch');
            
            const isDark = theme === 'dark';
            
            phoneScreen.classList.toggle('dark-mode', isDark);
            
            // å¦‚æœé–‹é—œå­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„ç‹€æ…‹
            if (toggleSwitch) {
                toggleSwitch.checked = isDark;
            }
            
            localStorage.setItem('ephone-theme', theme);
        }
        
        /**
         * åˆ‡æ›ç•¶å‰çš„ä¸»é¡Œ
         */
        function toggleTheme() {
            const toggleSwitch = document.getElementById('theme-toggle-switch');
            // ç›´æ¥æ ¹æ“šé–‹é—œçš„é¸ä¸­ç‹€æ…‹ä¾†æ±ºå®šæ–°ä¸»é¡Œ
            const newTheme = toggleSwitch.checked ? 'dark' : 'light';
            applyTheme(newTheme);
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ openLongTermMemoryManager å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€é‡æ§‹ç‰ˆã€‘æ‰“é–‹é•·æœŸè¨˜æ†¶ç®¡ç†çš„å…¨å±é é¢
         */
        function openLongTermMemoryScreen() {
            if (!state.activeChatId) return;
            renderLongTermMemoryList();
            showScreen('long-term-memory-screen');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ”¯æŒè¨˜æ†¶äº’é€šçš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderLongTermMemoryList å‡½æ•¸ â–¼â–¼â–¼
        /**
         * æ¸²æŸ“é•·æœŸè¨˜æ†¶åˆ—è¡¨ (è¨˜æ†¶äº’é€šç‰ˆ)
         */
        function renderLongTermMemoryList() {
            const container = document.getElementById('memory-list-container');
            const chat = state.chats[state.activeChatId];
            container.innerHTML = '';
        
            let memoriesToDisplay = [];

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ”¶é›†æ‰€æœ‰éœ€è¦é¡¯ç¤ºçš„è¨˜æ†¶ â–¼â–¼â–¼
            if (chat.isGroup) {
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œéæ­·æˆå“¡æ”¶é›†è¨˜æ†¶
                chat.members.forEach(member => {
                    const memberChat = state.chats[member.id];
                    if (memberChat && memberChat.longTermMemory) {
                        // ç‚ºæ¯æ¢è¨˜æ†¶é™„åŠ ä¸Šä½œè€…è³‡è¨Šï¼Œæ–¹ä¾¿é¡¯ç¤º
                        const memberMemories = memberChat.longTermMemory.map(mem => ({
                            ...mem,
                            authorName: member.groupNickname, // ä½¿ç”¨ç¾¤æ˜µç¨±
                            authorChatId: member.id, // ä¿å­˜åŸå§‹å–®èŠID
                        }));
                        memoriesToDisplay.push(...memberMemories);
                    }
                });
            } else {
                // å¦‚æœæ˜¯å–®èŠï¼Œç›´æ¥ä½¿ç”¨è‡ªå·±çš„è¨˜æ†¶
                if (chat.longTermMemory) {
                    memoriesToDisplay = chat.longTermMemory.map(mem => ({
                        ...mem,
                        authorName: chat.name, // ä½œè€…å°±æ˜¯è§’è‰²è‡ªå·±
                        authorChatId: chat.id,
                    }));
                }
            }
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

            if (memoriesToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">é€™è£¡é‚„æ²’æœ‰ä»»ä½•é•·æœŸè¨˜æ†¶ã€‚</p>';
                return;
            }

            // æŒ‰æ™‚é–“å€’åºæ’åˆ—æ‰€æœ‰æ”¶é›†åˆ°çš„è¨˜æ†¶
            memoriesToDisplay.sort((a, b) => b.timestamp - a.timestamp);
        
            memoriesToDisplay.forEach((memory, index) => {
                const item = document.createElement('div');
                item.className = 'memory-card'; 
                item.style.cursor = 'default';
        
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div class="content" style="padding: 0; flex-grow: 1;">
                            <!-- æ–°å¢ï¼šé¡¯ç¤ºè¨˜æ†¶ä¾†æº -->
                            <div style="font-size: 0.8em; color: #999; margin-bottom: 5px;">
                                [ ${memory.authorName} çš„è¨˜æ†¶ ]
                            </div>
                            ${memory.content.replace(/\n/g, '<br>')}
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0; margin-left: 15px;">
                            <button class="memory-action-btn edit-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="ç·¨è¼¯">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="memory-action-btn delete-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="åˆªé™¤">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
async function handleAddManualMemory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    let targetChatForMemory = chat;
    if (chat.isGroup) {
        const memberOptions = chat.members.map(member => ({
            text: `ç‚ºâ€œ${member.groupNickname}â€æ·»åŠ è¨˜æ†¶`,
            value: member.id
        }));
        const selectedMemberId = await showChoiceModal('é¸æ“‡è¨˜æ†¶æ‰€å±¬è§’è‰²', memberOptions);
        if (!selectedMemberId) return;
        targetChatForMemory = state.chats[selectedMemberId];
        if (!targetChatForMemory) {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²æˆå“¡çš„å€‹äººæª”æ¡ˆã€‚");
            return;
        }
    }
    const content = await showCustomPrompt(`ç‚ºâ€œ${targetChatForMemory.name}â€æ·»åŠ è¨˜æ†¶`, 'è«‹è¼¸å…¥è¦æ·»åŠ çš„è¨˜æ†¶è¦é»ï¼š', '', 'textarea');
    if (content && content.trim()) {
        if (!targetChatForMemory.longTermMemory) targetChatForMemory.longTermMemory = [];
        targetChatForMemory.longTermMemory.push({ content: content.trim(), timestamp: Date.now(), source: 'manual' });
        await db.chats.put(targetChatForMemory);
        renderLongTermMemoryList();
    }
}
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å…©å€‹æ”¯æ´è¨˜æ†¶äº’é€šçš„æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ handleEditMemory å’Œ handleDeleteMemory å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ç·¨è¼¯æŒ‡å®šçš„é•·æœŸè¨˜æ†¶ (è¨˜æ†¶äº’é€šç‰ˆ)
         * @param {string} authorChatId - è¨˜æ†¶æ‰€å±¬è§’è‰²çš„å–®èŠID
         * @param {number} memoryTimestamp - è¨˜æ†¶çš„æ™‚é–“æˆ³è¨˜
         */
async function handleEditMemory(authorChatId, memoryTimestamp) {
    const authorChat = state.chats[authorChatId];
    if (!authorChat || !authorChat.longTermMemory) return;
    const memoryIndex = authorChat.longTermMemory.findIndex(m => m.timestamp === memoryTimestamp);
    if (memoryIndex === -1) return;
    const memory = authorChat.longTermMemory[memoryIndex];
    const newContent = await showCustomPrompt('ç·¨è¼¯è¨˜æ†¶', 'è«‹ä¿®æ”¹è¨˜æ†¶è¦é»ï¼š', memory.content, 'textarea');
    if (newContent && newContent.trim()) {
        memory.content = newContent.trim();
        await db.chats.put(authorChat);
        renderLongTermMemoryList();
    }
}

async function handleDeleteMemory(authorChatId, memoryTimestamp) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢é•·æœŸè¨˜æ†¶å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const authorChat = state.chats[authorChatId];
        if (!authorChat || !authorChat.longTermMemory) return;
        authorChat.longTermMemory = authorChat.longTermMemory.filter(m => m.timestamp !== memoryTimestamp);
        await db.chats.put(authorChat);
        renderLongTermMemoryList();
    }
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * ã€æ ¸å¿ƒã€‘æ‰‹å‹•è§¸ç™¼å°è©±ç¸½çµ
         */
        async function handleManualSummary() {
            const confirmed = await showCustomConfirm('ç¢ºèªæ“ä½œ', 'é€™å°‡æå–æœ€è¿‘çš„å°è©±å…§å®¹ç™¼é€çµ¦AIé€²è¡Œç¸½çµï¼Œæœƒæ¶ˆè€—APIé¡åº¦ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ');
            if (confirmed) {
                await triggerAutoSummary(state.activeChatId, true); // force=true è¡¨ç¤ºå¼·åˆ¶åŸ·è¡Œ
            }
        }
        
        /**
         * ã€æ ¸å¿ƒã€‘æª¢æŸ¥ä¸¦è§¸ç™¼è‡ªå‹•ç¸½çµ
         * @param {string} chatId 
         */
        async function checkAndTriggerAutoSummary(chatId) {
            const chat = state.chats[chatId];
            if (!chat || !chat.settings.enableAutoMemory) return;
        
            const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
            const messagesSinceLastSummary = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);
        
            if (messagesSinceLastSummary.length >= chat.settings.autoMemoryInterval) {
                console.log(`é”åˆ°è‡ªå‹•ç¸½çµé–¾å€¼ (${messagesSinceLastSummary.length}/${chat.settings.autoMemoryInterval})ï¼Œé–‹å§‹ç¸½çµ...`);
                await triggerAutoSummary(chatId);
            }
        }
// â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„ã€å·²ç›¸å®¹ç¾¤èŠç¬¬ä¸€äººç¨±ç¸½çµçš„ä¿®å¾©ç‰ˆæœ¬ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼æ›¿æ›èˆŠçš„ summarizeCallTranscript å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€V4.0 | ç¾¤èŠç¬¬ä¸€äººç¨±ä¸»è§€ç¸½çµç‰ˆã€‘å°ˆé–€ç”¨æ–¼ç¸½çµé€šè©±è¨˜éŒ„ä¸¦å­˜å…¥é•·æœŸè¨˜æ†¶çš„æ ¸å¿ƒå‡½æ•¸
 * @param {string} chatId - ç›®æ¨™èŠå¤©çš„ID
 * @param {string} transcriptText - æ ¼å¼åŒ–å¾Œçš„é€šè©±æ–‡å­—è¨˜éŒ„
 * @returns {Promise<boolean>} - è¿”å›ä¸€å€‹Promiseï¼ŒæˆåŠŸæ™‚è§£æç‚ºtrueï¼Œå¤±æ•—æ™‚æœƒæ‹‹å‡ºéŒ¯èª¤ã€‚
 */
async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) {
        throw new Error("åŸºç¤è³‡æ–™ä¸å®Œæ•´ï¼Œç„¡æ³•é–‹å§‹ç¸½çµã€‚");
    }

    const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ¶';
    let systemPrompt;
    let targetMemoryChat = chat; // é è¨­å°‡è¨˜æ†¶å­˜å…¥ç•¶å‰èŠå¤©ç‰©ä»¶

    // ==========================================================
    //            â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹é‚è¼¯å°±åœ¨é€™è£¡ â˜…â˜…â˜…
    // ==========================================================

    // 1. åˆ¤æ–·ç•¶å‰æ˜¯å–®èŠé‚„æ˜¯ç¾¤èŠ
    if (chat.isGroup) {
        // --- å¦‚æœæ˜¯ç¾¤èŠ ---

        // a. ç¢ºå®šç”±å“ªå€‹AIè§’è‰²ä¾†â€œå›æ†¶â€é€™æ¬¡é€šè©±
        let protagonist = null; // â€œä¸»è§’â€ï¼Œå³å¯«ä¸‹å›æ†¶çš„é‚£å€‹AI
        if (videoCallState.callRequester) {
            protagonist = chat.members.find(m => m.originalName === videoCallState.callRequester);
        }
        // å¦‚æœæ‰¾ä¸åˆ°ç™¼èµ·è€…ï¼ˆæ¯”å¦‚æ˜¯ç”¨æˆ¶ç™¼èµ·çš„ï¼‰ï¼Œå°±é¸æ“‡ç¬¬ä¸€å€‹åƒèˆ‡çš„AIæˆå“¡
        if (!protagonist) {
            protagonist = chat.members.find(m => m.id !== 'user' && videoCallState.participants.some(p => p.id === m.id));
        }
        // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå°±é¸æ“‡ç¾¤è£¡çš„ç¬¬ä¸€å€‹AIæˆå“¡ä½œç‚ºå‚™ç”¨
        if (!protagonist) {
            protagonist = chat.members.find(m => m.id !== 'user');
        }

        if (!protagonist) {
            throw new Error("ç¾¤èŠé€šè©±ä¸­æ²’æœ‰æ‰¾åˆ°å¯ä½œç‚ºç¸½çµä¸»é«”çš„AIè§’è‰²ã€‚");
        }
        
        // b. ç²å–é€™å€‹â€œä¸»è§’â€AIçš„å®Œæ•´è³‡è¨Šï¼Œä»¥ä¾¿è®€å–ä»–çš„äººè¨­
        const protagonistChat = state.chats[protagonist.id];
        if (!protagonistChat) {
             throw new Error(`æ‰¾ä¸åˆ°ä¸»è§’ â€œ${protagonist.groupNickname}â€ çš„è©³ç´°è§’è‰²è³‡è¨Šã€‚`);
        }
        
        // c. ç²å–ç”¨æˆ¶åœ¨é€™å€‹ç¾¤è£¡çš„å°ˆå±¬äººè¨­
        const userPersonaInGroup = chat.settings.myPersona || '(æœªè¨­ç½®)';

        // d. æ§‹å»ºä¸€å€‹å…¨æ–°çš„ã€é‡å°ç¾¤èŠçš„â€œç¬¬ä¸€äººç¨±â€ç¸½çµæŒ‡ä»¤
        systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ å°±æ˜¯è§’è‰²â€œ${protagonist.originalName}â€ã€‚è«‹ä½ å›é¡§ä¸€ä¸‹å‰›æ‰å’Œ â€œ${userNickname}â€ ä»¥åŠå…¶ä»–ç¾¤æˆå“¡çš„ã€ç¾¤çµ„è¦–é »é€šè©±ã€‘ï¼Œç„¶å¾Œç”¨ã€ç¬¬ä¸€äººç¨± ("æˆ‘")ã€‘çš„å£å»ï¼Œç¸½çµå‡ºä¸€æ®µç°¡çŸ­çš„ã€åŒ…å«æ ¸å¿ƒäº‹ä»¶å’Œå¿ƒç†æ´»å‹•çš„å›æ†¶ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **è¦–è§’éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘ä½¿ç”¨ã€ä¸»è§€çš„ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ä¾†å¯«ã€‚
2.  **å…§å®¹æ ¸å¿ƒ**: ä½ çš„å›æ†¶æ‡‰è©²åŒ…å«ï¼š
    *   **åŠ‡æƒ…å›é¡§**: å‰›æ‰æˆ‘å€‘åœ¨ç¾¤èŠé€šè©±è£¡èŠäº†ä»€éº¼é—œéµçš„äº‹ï¼Ÿå…¶ä»–äººéƒ½èªªäº†ä»€éº¼ï¼Ÿ
    *   **å¿ƒç†æ´»å‹•**: æˆ‘ç•¶æ™‚å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿæœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿ
3.  **é•·åº¦éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘éå¸¸ç°¡çŸ­ï¼Œç¸½é•·åº¦ã€çµ•å°ä¸èƒ½è¶…é80å€‹å­—ã€‘ã€‚
4.  **å£å»èˆ‡äººè¨­**: ä½ çš„èªæ°£ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆä½ çš„è§’è‰²è¨­å®šã€‚
5.  **è¼¸å‡ºæ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨é€™è£¡å¯«ä¸‹ä½ ä»¥ç¬¬ä¸€äººç¨±è¦–è§’ï¼Œç¸½çµå¥½çš„æ ¸å¿ƒå›æ†¶ã€‚"}\`

# ä½ çš„è§’è‰²è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆ)
${protagonistChat.settings.aiPersona}

# ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰çš„äººè¨­
${userPersonaInGroup}

# å¾…ç¸½çµçš„ç¾¤çµ„è¦–é »é€šè©±è¨˜éŒ„
${transcriptText}

ç¾åœ¨ï¼Œè«‹ä»¥â€œ${protagonist.originalName}â€çš„èº«ä»½ï¼Œé–‹å§‹ä½ çš„å›æ†¶ã€‚`;
        
        // e. ã€é—œéµã€‘å°‡è¨˜æ†¶çš„å­˜å„²ç›®æ¨™ï¼Œå¾ç¾¤èŠæœ¬èº«ï¼Œæ”¹ç‚ºé€™å€‹â€œä¸»è§’â€AIè§’è‰²
        targetMemoryChat = protagonistChat;

    } else {
        // --- å¦‚æœæ˜¯å–®èŠï¼Œä¿æŒåŸä¾†çš„é‚è¼¯ï¼Œä½†ç¢ºä¿ä¹ŸåŒ…å«äº†ç”¨æˆ¶äººè¨­ ---
        systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ å°±æ˜¯è§’è‰²â€œ${chat.originalName}â€ã€‚è«‹ä½ å›é¡§ä¸€ä¸‹å‰›æ‰å’Œâ€œ${userNickname}â€çš„è¦–é »é€šè©±ï¼Œç„¶å¾Œç”¨ã€ç¬¬ä¸€äººç¨± ("æˆ‘")ã€‘çš„å£å»ï¼Œç¸½çµå‡ºä¸€æ®µç°¡çŸ­çš„ã€åŒ…å«æ ¸å¿ƒäº‹ä»¶å’Œå¿ƒç†æ´»å‹•çš„å›æ†¶ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **è¦–è§’éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘ä½¿ç”¨ã€ä¸»è§€çš„ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ä¾†å¯«ã€‚
2.  **å…§å®¹æ ¸å¿ƒ**: ä½ çš„å›æ†¶æ‡‰è©²åŒ…å«ï¼š
    *   **åŠ‡æƒ…å›é¡§**: å‰›æ‰æˆ‘å€‘èŠäº†ä»€éº¼é—œéµçš„äº‹ï¼Ÿ
    *   **å¿ƒç†æ´»å‹•**: æˆ‘ç•¶æ™‚å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿæœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿ
3.  **é•·åº¦éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘éå¸¸ç°¡çŸ­ï¼Œç¸½é•·åº¦ã€çµ•å°ä¸èƒ½è¶…é80å€‹å­—ã€‘ã€‚
4.  **å£å»èˆ‡äººè¨­**: ä½ çš„èªæ°£ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆä½ çš„è§’è‰²è¨­å®šã€‚
5.  **è¼¸å‡ºæ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨é€™è£¡å¯«ä¸‹ä½ ä»¥ç¬¬ä¸€äººç¨±è¦–è§’ï¼Œç¸½çµå¥½çš„æ ¸å¿ƒå›æ†¶ã€‚"}\`

# ä½ çš„è§’è‰²è¨­å®š
${chat.settings.aiPersona}

# ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰çš„äººè¨­
${chat.settings.myPersona}

# å¾…ç¸½çµçš„è¦–é »é€šè©±è¨˜éŒ„
${transcriptText}

ç¾åœ¨ï¼Œè«‹ä»¥â€œ${chat.originalName}â€çš„èº«ä»½ï¼Œé–‹å§‹ä½ çš„å›æ†¶ã€‚`;
    }

    // ==========================================================
    //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©é‚è¼¯åˆ°æ­¤çµæŸ â˜…â˜…â˜…
    // ==========================================================

    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? 
            { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : 
            state.apiConfig;

        if (!proxyUrl || !apiKey || !model) throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•é€²è¡Œç¸½çµã€‚');

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è«‹é–‹å§‹ç¸½çµã€‚" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "è«‹é–‹å§‹ç¸½çµã€‚"}],
                    temperature: 0.1
                })
            });

        if (!response.ok) {
             const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
             throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${errorData.error.message}`);
        }
        
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && result.summary.trim()) {
            // ã€æ ¸å¿ƒä¿®æ”¹4ã€‘å°‡è¨˜æ†¶ä¿å­˜åˆ°æˆ‘å€‘å‰é¢ç¢ºå®šçš„ targetMemoryChat ä¸­
            const newMemoryEntry = {
                content: `(åœ¨é‚£æ¬¡${chat.isGroup ? 'ç¾¤èŠ' : ''}é€šè©±ä¸­ï¼Œ${result.summary.trim()})`,
                timestamp: Date.now(),
                source: chat.isGroup ? 'group_call_summary' : 'call_summary'
            };
            if (!targetMemoryChat.longTermMemory) targetMemoryChat.longTermMemory = [];
            targetMemoryChat.longTermMemory.push(newMemoryEntry);
            await db.chats.put(targetMemoryChat);
            console.log(`é€šè©±è¨˜éŒ„å·²æˆåŠŸç¸½çµä¸¦å­˜å…¥è§’è‰²â€œ${targetMemoryChat.name}â€çš„é•·æœŸè¨˜æ†¶ä¸­ã€‚`);
            
            return true;
        } else {
            throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¢ºçš„ç¸½çµå…§å®¹ã€‚");
        }

    } catch (error) {
        console.error("ç¸½çµé€šè©±è¨˜éŒ„æ™‚å‡ºéŒ¯:", error);
        throw error;
    }
}

// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | Promptæ³¨å…¥ç‰ˆã€‘é€™æ˜¯â€œæ™ºæ…§ç¸½çµâ€åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´æ›¿æ›èˆŠç‰ˆ â–¼â–¼â–¼

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘åˆ†ææ–‡æœ¬ï¼Œæå–é—œéµå­— (æ­¤å‡½æ•¸ä¿æŒä¸è®Š)
 * @param {string} text - è¦åˆ†æçš„èšåˆæ–‡æœ¬
 * @returns {{coreKeywords: string[], situationalKeywords: string[]}} - åŒ…å«é—œéµå­—çš„ç‰©ä»¶
 */
function analyzeTextForSummary(text) {
    const stopWords = new Set(['çš„', 'æ˜¯', 'äº†', 'åœ¨', 'æˆ‘', 'ä½ ', 'ä»–', 'å¥¹', 'å®ƒ', 'æˆ‘å€‘', 'ä½ å€‘', 'ä»–å€‘', 'é€™', 'é‚£', 'ä¸€å€‹', 'ä¹Ÿ', 'å’Œ', 'èˆ‡', 'æˆ–', 'ä½†', 'ç„¶è€Œ', 'æ‰€ä»¥', 'å› æ­¤', 'å°±', 'éƒ½', 'åœ°', 'å¾—', 'è‘—', 'é', 'å§', 'å—', 'å‘¢', 'å•Š', 'å“¦', 'å—¯', 'ä»€éº¼', 'æ€éº¼', 'ç‚ºä»€éº¼', 'å“ªå€‹', 'ä¸€äº›', 'é€™å€‹', 'é‚£å€‹', 'é‚„æœ‰']);
    const words = text.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const frequencies = new Map();
    let maxFrequency = 0;

    words.forEach(word => {
        if (word.length > 1 && !stopWords.has(word)) {
            const count = (frequencies.get(word) || 0) + 1;
            frequencies.set(word, count);
            if (count > maxFrequency) maxFrequency = count;
        }
    });
    
    const coreKeywords = [];
    const situationalKeywords = [];
    const coreThreshold = maxFrequency * 0.9;
    const situationalThreshold = maxFrequency * 0.6;

    frequencies.forEach((count, word) => {
        if (count >= coreThreshold) {
            coreKeywords.push(word);
        } else if (count >= situationalThreshold) {
            situationalKeywords.push(word);
        }
    });

    const coreSet = new Set(coreKeywords);
    const finalSituational = situationalKeywords.filter(word => !coreSet.has(word)).slice(0, 5);

    return {
        coreKeywords: coreKeywords.slice(0, 3),
        situationalKeywords: finalSituational
    };
}

/**
 * ã€å…¨æ–° | V3.0 åˆ†æ™‚æ®µç¸½çµç‰ˆã€‘æ ¹æ“šæŒ‡å®šçš„æ™‚é–“ç¯„åœï¼Œç‚ºå°è©±ç”Ÿæˆæ™ºæ…§ç¸½çµ
 * @param {object} chat - ç›®æ¨™èŠå¤©ç‰©ä»¶
 * @param {number} duration - è¦å›é¡§çš„æ™‚é•· (ä¾‹å¦‚ 3, 6, 1, 7)
 * @param {string} unit - æ™‚é–“å–®ä½, 'hours' æˆ– 'days'
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„ã€ç”¨æ–¼æ³¨å…¥Promptçš„ç¸½çµæ–‡æœ¬ï¼Œå¦‚æœæ²’æœ‰å…§å®¹å‰‡è¿”å›ç©ºå­—ä¸²
 */
function generateSummaryForTimeframe(chat, duration, unit) {
    let timeAgo;
    if (unit === 'hours') {
        timeAgo = Date.now() - duration * 60 * 60 * 1000;
    } else { // 'days'
        timeAgo = Date.now() - duration * 24 * 60 * 60 * 1000;
    }

    const messagesToSummarize = chat.history.filter(m => m.timestamp > timeAgo && !m.isHidden);

    if (messagesToSummarize.length < 3) {
        return "";
    }
    
    // (æ­¤è™•çš„é—œéµå­—æå–é‚è¼¯èˆ‡æ‚¨ç¾æœ‰çš„ä»£ç¢¼å®Œå…¨ç›¸åŒï¼Œç„¡éœ€ä¿®æ”¹)
    const allText = messagesToSummarize.map(msg => {
        if (typeof msg.content === 'string') return msg.content;
        if (msg.type === 'voice_message') return msg.content;
        if (msg.type === 'offline_text') return `${msg.dialogue || ''} ${msg.description || ''}`;
        return '';
    }).join(' ');

    const stopWords = new Set(['çš„', 'æ˜¯', 'äº†', 'åœ¨', 'æˆ‘', 'ä½ ', 'ä»–', 'å¥¹', 'å®ƒ', 'æˆ‘å€‘', 'ä½ å€‘', 'ä»–å€‘', 'é€™', 'é‚£', 'ä¸€å€‹', 'ä¹Ÿ', 'å’Œ', 'èˆ‡', 'æˆ–', 'ä½†', 'ç„¶è€Œ', 'æ‰€ä»¥', 'å› æ­¤', 'å°±', 'éƒ½', 'åœ°', 'å¾—', 'è‘—', 'é', 'å§', 'å—', 'å‘¢', 'å•Š', 'å“¦', 'å—¯']);
    const words = allText.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const frequencies = new Map();
    words.forEach(word => {
        if (word.length > 1 && !stopWords.has(word)) {
            frequencies.set(word, (frequencies.get(word) || 0) + 1);
        }
    });
    const sortedKeywords = [...frequencies.entries()].sort((a, b) => b[1] - a[1]).map(entry => entry[0]);
    
    if (sortedKeywords.length === 0) {
        return "";
    }

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šå–®ä½å’Œæ™‚é•·ï¼Œç”Ÿæˆæ›´ç²¾ç¢ºçš„æ¨™é¡Œ
    let title;
    if (unit === 'hours') {
        title = `æœ€è¿‘${duration}å°æ™‚æ ¸å¿ƒè­°é¡Œ`;
    } else {
        if (duration === 1) {
            title = "æœ¬æ—¥æ ¸å¿ƒè­°é¡Œ";
        } else {
            title = `æœ€è¿‘${duration}å¤©æ ¸å¿ƒè­°é¡Œ`;
        }
    }
    
    return `\n- **${title}**: é—œæ–¼ **${sortedKeywords.slice(0, 3).join('ã€ ')}**ã€‚`;
}


// â–¼â–¼â–¼ ã€å…¨æ–° | V3.0 çµ‚æ¥µå®¹éŒ¯ç‰ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ summarizeExistingLongTermMemory å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€è¼”åŠ©å‡½æ•¸ | å®¹éŒ¯æ ¸å¿ƒã€‘ä¸€å€‹æ›´å¥å£¯çš„JSONè§£æå™¨
 * å®ƒèƒ½å¾AIè¿”å›çš„ã€å¯èƒ½ä¸è¦ç¯„çš„æ–‡æœ¬ä¸­æ™ºæ…§æå–JSONç‰©ä»¶æˆ–æ ¸å¿ƒå…§å®¹ã€‚
 * @param {string} rawContent - AIè¿”å›çš„åŸå§‹å­—ä¸²
 * @returns {object|null} - è¿”å›è§£æå¾Œçš„å°è±¡ï¼Œæˆ–åœ¨å®Œå…¨å¤±æ•—æ™‚è¿”å›null
 */
function robustJsonParse(rawContent) {
    if (!rawContent || typeof rawContent !== 'string') {
        return null;
    }

    const cleanedContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();

    // ç­–ç•¥1ï¼šæœ€é«˜å„ªå…ˆé †åºï¼Œå˜—è©¦ç›´æ¥è§£æå®Œæ•´çš„JSONç‰©ä»¶
    // é€™èƒ½è™•ç†æœ€æ¨™æº–çš„æƒ…æ³ï¼Œä»¥åŠAIåœ¨JSONå‰å¾Œæ·»åŠ äº†å°‘é‡æ–‡å­—çš„æƒ…æ³ã€‚
    const jsonMatch = cleanedContent.match(/{[\s\S]*}/);
    if (jsonMatch) {
        try {
            const parsed = JSON.parse(jsonMatch[0]);
            console.log("å®¹éŒ¯è§£æï¼šç­–ç•¥1æˆåŠŸ (æ‰¾åˆ°ä¸¦è§£æäº†å®Œæ•´çš„JSONå°è±¡)");
            return parsed;
        } catch (e) {
            console.warn("å®¹éŒ¯è§£æï¼šç­–ç•¥1å¤±æ•— (æ‰¾åˆ°äº†JSONå¡Šï¼Œä½†æ ¼å¼éŒ¯èª¤)ï¼Œå°‡å˜—è©¦ç­–ç•¥2...");
        }
    }

    // ç­–ç•¥2ï¼šå¦‚æœç­–ç•¥1å¤±æ•—ï¼Œå˜—è©¦åªæå– "summary" æ¬„ä½çš„å…§å®¹
    // é€™èƒ½è™•ç†AIè¿”å›äº†é¡ä¼¼ "summary": "..." é€™æ¨£çš„éæ¨™æº–æ ¼å¼
    const summaryMatch = cleanedContent.match(/"summary"\s*:\s*"((?:[^"\\]|\\.)*)"/);
    if (summaryMatch && summaryMatch[1]) {
        console.log("å®¹éŒ¯è§£æï¼šç­–ç•¥2æˆåŠŸ (æå–äº†summaryæ¬„ä½å…§å®¹)");
        // æ‰‹å‹•æ§‹å»ºä¸€å€‹ç¬¦åˆæˆ‘å€‘æœŸæœ›æ ¼å¼çš„ç‰©ä»¶
        return { summary: summaryMatch[1].replace(/\\"/g, '"') }; // è™•ç†è½‰ç¾©çš„å¼•è™Ÿ
    }
    
    // ç­–ç•¥3ï¼šæœ€çµ‚å‚™ç”¨æ–¹æ¡ˆï¼Œå¦‚æœä»¥ä¸Šéƒ½å¤±æ•—äº†ï¼Œå°±èªç‚ºæ•´å€‹æ–‡æœ¬éƒ½æ˜¯æ‘˜è¦
    // é€™èƒ½è™•ç†AIå®Œå…¨ä¸è½æŒ‡ä»¤ï¼Œç›´æ¥è¿”å›ç´”æ–‡å­—çš„æƒ…æ³
    if (cleanedContent) {
        console.log("å®¹éŒ¯è§£æï¼šç­–ç•¥3æˆåŠŸ (å°‡æ•´å€‹è¿”å›æ–‡æœ¬ä½œç‚ºæ‘˜è¦)");
        return { summary: cleanedContent };
    }

    // å¦‚æœé€£æ–‡æœ¬éƒ½æ²’æœ‰ï¼Œæ‰è¿”å›null
    return null;
}


/**
 * ã€V3.0 | æ”¯æ´è‡ªè¨‚å­—æ•¸ | è¨˜æ†¶äº’é€šç‰ˆ | çµ‚æ¥µå®¹éŒ¯ | ç”¨æˆ¶ç¢ºèª | å¯é¸æ¢æ•¸ | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ‰‹å‹•è§¸ç™¼å°ã€ç¾æœ‰é•·æœŸè¨˜æ†¶ã€‘çš„ç¸½çµå’Œç²¾ç…‰
 * @param {string} chatId - ç•¶å‰èŠå¤©çš„ID (å¯èƒ½æ˜¯ç¾¤èŠID)
 */
async function summarizeExistingLongTermMemory(chatId) {
    let chat = state.chats[chatId];
    if (!chat) return;

    let targetChatForRefine = chat; 

    if (chat.isGroup) {
        const memberOptions = chat.members
            .map(member => {
                const memberChat = state.chats[member.id];
                if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length >= 2) {
                    return {
                        text: `ç²¾ç…‰â€œ${member.groupNickname}â€çš„è¨˜æ†¶ (${memberChat.longTermMemory.length}æ¢)`,
                        value: member.id
                    };
                }
                return null;
            }).filter(Boolean); 

        if (memberOptions.length === 0) {
            alert("ç¾¤èŠä¸­æ²’æœ‰æˆå“¡æœ‰è¶³å¤ ï¼ˆ2æ¢ä»¥ä¸Šï¼‰çš„è¨˜æ†¶å¯ä¾›ç²¾ç…‰ã€‚");
            return;
        }

        const selectedMemberId = await showChoiceModal('é¸æ“‡è¦ç²¾ç…‰è¨˜æ†¶çš„è§’è‰²', memberOptions);

        if (!selectedMemberId) return;

        targetChatForRefine = state.chats[selectedMemberId];
    }

    if (!targetChatForRefine.longTermMemory || targetChatForRefine.longTermMemory.length < 2) {
        alert(`â€œ${targetChatForRefine.name}â€çš„é•·æœŸè¨˜æ†¶å°‘æ–¼2æ¢ï¼Œç„¡éœ€é€²è¡Œç²¾ç…‰ã€‚`);
        return;
    }
    
    const totalMemories = targetChatForRefine.longTermMemory.length;
    const choice = await showChoiceModal('é¸æ“‡ç²¾ç…‰ç¯„åœ', [
        { text: `å…¨éƒ¨è¨˜æ†¶ (${totalMemories}æ¢)`, value: 'all' },
        { text: `æœ€è¿‘ 20 æ¢`, value: '20' },
        { text: `æœ€è¿‘ 50 æ¢`, value: '50' },
        { text: `æœ€è¿‘ 100 æ¢`, value: '100' },
        { text: 'è‡ªè¨‚æ•¸é‡...', value: 'custom' }
    ].filter(opt => opt.value === 'all' || opt.value === 'custom' || parseInt(opt.value) < totalMemories)
    );

    if (choice === null) return;

    let memoriesToRefine;
    let countToRefine = totalMemories;

    if (choice === 'all') {
        memoriesToRefine = [...targetChatForRefine.longTermMemory];
    } else if (choice === 'custom') {
        const customCountStr = await showCustomPrompt('è‡ªè¨‚æ•¸é‡', `è«‹è¼¸å…¥è¦ç²¾ç…‰çš„æœ€è¿‘è¨˜æ†¶æ¢æ•¸ (æœ€å¤š ${totalMemories} æ¢)`);
        if (customCountStr === null) return;
        const customCount = parseInt(customCountStr);
        if (isNaN(customCount) || customCount < 2 || customCount > totalMemories) {
            alert(`è«‹è¼¸å…¥ä¸€å€‹ 2 åˆ° ${totalMemories} ä¹‹é–“çš„æœ‰æ•ˆæ•¸å­—ã€‚`);
            return;
        }
        countToRefine = customCount;
        memoriesToRefine = targetChatForRefine.longTermMemory.slice(-countToRefine);
    } else {
        countToRefine = parseInt(choice);
        if (countToRefine >= totalMemories) {
            memoriesToRefine = [...targetChatForRefine.longTermMemory];
            countToRefine = totalMemories;
        } else {
            memoriesToRefine = targetChatForRefine.longTermMemory.slice(-countToRefine);
        }
    }
    
    const wordCountStr = await showCustomPrompt(
        "è¨­ç½®ç²¾ç…‰å­—æ•¸",
        "è«‹è¼¸å…¥ç²¾ç…‰å¾Œæ ¸å¿ƒè¨˜æ†¶çš„å¤§è‡´å­—æ•¸ï¼š",
        "150"
    );
    
    if (wordCountStr === null) return;
    
    const wordCount = parseInt(wordCountStr);
    if (isNaN(wordCount) || wordCount < 20) {
        alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„æ•¸å­—ï¼ˆå»ºè­°å¤§æ–¼20ï¼‰ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªç²¾ç…‰è¨˜æ†¶ï¼Ÿ',
        `æ­¤æ“ä½œæœƒå°‡é¸å®šçš„ ${countToRefine} æ¢é•·æœŸè¨˜æ†¶ç™¼é€çµ¦AIï¼Œç¸½çµæˆå¤§ç´„ ${wordCount} å­—çš„æ ¸å¿ƒè¨˜æ†¶ã€‚é€™äº›èˆŠè¨˜æ†¶å°‡è¢«æ›¿æ›ï¼Œæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªç²¾ç…‰' }
    );

    if (!confirmed) return;

    const memoryContent = memoriesToRefine.map(mem => `- ${mem.content}`).join('\n');
    const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ¶';

    // ===================================================================
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ† â–¼â–¼â–¼
    // ===================================================================
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ å°±æ˜¯è§’è‰²â€œ${targetChatForRefine.originalName}â€ã€‚è«‹ä½ å›é¡§ä¸€ä¸‹ä½ å’Œâ€œ${userNickname}â€çš„é•·æœŸè¨˜æ†¶ï¼Œç„¶å¾Œç”¨ã€ç¬¬ä¸€äººç¨± ("æˆ‘")ã€‘çš„å£å»ï¼Œå°‡å®ƒå€‘æ•´åˆæˆä¸€å€‹æ›´åŠ ç²¾ç…‰ã€é€£è²«ã€æ›´é«˜å±¤æ¬¡çš„æ ¸å¿ƒè¨˜æ†¶æ‘˜è¦ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **è¦–è§’éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘ä½¿ç”¨ã€ä¸»è§€çš„ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ä¾†å¯«ã€‚
2.  **å…§å®¹æ ¸å¿ƒ**: ä½ çš„å›æ†¶æ‡‰è©²åŒ…å«ï¼š
    * **åŠ‡æƒ…å›é¡§**: æˆ‘å’Œ${userNickname}ä¹‹é–“ç™¼ç”Ÿäº†ä»€éº¼é—œéµçš„äº‹ï¼Ÿ
    * **å¿ƒç†æ´»å‹•**: æˆ‘ç•¶æ™‚å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿæœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿ
3.  **ä¿ç•™é—œéµè³‡è¨Š**: å¿…é ˆä¿ç•™æ‰€æœ‰é—œéµçš„äººç‰©ã€äº‹ä»¶ã€è¨­å®šå’Œæƒ…æ„Ÿé—œä¿‚ã€‚çµ•å°ä¸èƒ½éºå¿˜ä»»ä½•é‡è¦ç´°ç¯€ã€‚
4.  **å£å»èˆ‡äººè¨­**: ä½ çš„èªæ°£ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆä½ çš„è§’è‰²è¨­å®šã€‚
5.  **è¼¸å‡ºæ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨é€™è£¡å¯«ä¸‹ä½ ä»¥ç¬¬ä¸€äººç¨±è¦–è§’ï¼Œç¸½çµå¥½çš„æ ¸å¿ƒå›æ†¶ã€‚"}\`

# ä½ çš„è§’è‰²è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆ)
${targetChatForRefine.settings.aiPersona}

# ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰çš„äººè¨­
${targetChatForRefine.settings.myPersona}

# å¾…æ•´åˆçš„è¨˜æ†¶è¦é»åˆ—è¡¨
${memoryContent}

ç¾åœ¨ï¼Œè«‹ä»¥â€œ${targetChatForRefine.originalName}â€çš„èº«ä»½ï¼Œé–‹å§‹ä½ çš„å›æ†¶ç¸½çµã€‚`;
    // ===================================================================
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†çµæŸ â–²â–²â–²
    // ===================================================================
      
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIé€²è¡Œè¨˜æ†¶ç²¾ç…‰...");

    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi 
            ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } 
            : state.apiConfig;

        if (!proxyUrl || !apiKey || !model) {
            throw new Error('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½ï¼ˆä¸»æˆ–å‰¯ï¼‰APIä»¥é€²è¡Œç¸½çµã€‚');
        }

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è«‹é–‹å§‹æ•´åˆã€‚" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: "è«‹é–‹å§‹æ•´åˆã€‚" }],
                    temperature: 0.2,
                })
            });

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);

        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && typeof result.summary === 'string' && result.summary.trim()) {
            
            const userConfirmedReplacement = await showCustomConfirm(
                'ç²¾ç…‰å®Œæˆï¼Œè«‹ç¢ºèª',
                `AIå·²å°‡æ‚¨çš„ ${countToRefine} æ¢èˆŠè¨˜æ†¶ç¸½çµç‚ºä»¥ä¸‹æ ¸å¿ƒè¨˜æ†¶ï¼š<br><br><div class="scrollable-content-preview">${result.summary.trim()}</div><br>æ˜¯å¦ç”¨é€™æ¢æ–°è¨˜æ†¶æ›¿æ›æ‰é€™äº›èˆŠè¨˜æ†¶ï¼Ÿ`,
                { confirmText: 'ç¢ºèªæ›¿æ›', cancelText: 'ä¿ç•™èˆŠçš„', confirmButtonClass: 'btn-danger' }
            );

            if (userConfirmedReplacement) {
                const newMemoryEntry = {
                    content: result.summary.trim(),
                    timestamp: Date.now(),
                    source: 'refined'
                };
    
                const startIndex = totalMemories - countToRefine;
                const memoriesToKeep = startIndex > 0 ? targetChatForRefine.longTermMemory.slice(0, startIndex) : [];
                targetChatForRefine.longTermMemory = [...memoriesToKeep, newMemoryEntry];
                
                targetChatForRefine.lastMemorySummaryTimestamp = Date.now();
                await db.chats.put(targetChatForRefine);
                
                if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
                    renderLongTermMemoryList();
                }
                await showCustomAlert('ç²¾ç…‰æˆåŠŸ', `å·²æˆåŠŸå°‡ ${countToRefine} æ¢è¨˜æ†¶ç²¾ç…‰ç‚º 1 æ¢æ ¸å¿ƒè¨˜æ†¶ï¼`);
            } else {
                await showCustomAlert('æ“ä½œå·²å–æ¶ˆ', 'æ‚¨çš„èˆŠæœ‰è¨˜æ†¶å·²è¢«å®Œæ•´ä¿ç•™ï¼Œæœªä½œä»»ä½•ä¿®æ”¹ã€‚');
            }
            
        } else {
            throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¢ºçš„ç¸½çµå…§å®¹ã€‚");
        }

    } catch (error) {
        console.error("ç²¾ç…‰é•·æœŸè¨˜æ†¶æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('ç²¾ç…‰å¤±æ•—', `æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œé‡è©¦ã€‚\néŒ¯èª¤è³‡è¨Š: ${error.message}`);
    }
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ”¯æŒâ€œå€‹æ€§åŒ–è¨˜æ†¶æ³¨å…¥â€çš„æœ€çµ‚ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ triggerAutoSummary å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€æ ¸å¿ƒã€‘åŸ·è¡Œç¸½çµçš„APIèª¿ç”¨ (V7.1 - å€‹æ€§åŒ–è¨˜æ†¶æ³¨å…¥ | çµ±ä¸€å®¢è§€ç¸½çµ)
 * @param {string} chatId 
 * @param {boolean} force - æ˜¯å¦å¿½ç•¥æ¶ˆæ¯æ•¸é‡æª¢æŸ¥ï¼Œå¼·åˆ¶åŸ·è¡Œ
 */
async function triggerAutoSummary(chatId, force = false) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    // --- âœ¨ æ ¸å¿ƒä¿®æ”¹ â‘ ï¼šä¿®æ”¹ç¯©é¸é‚è¼¯ ---
    // æˆ‘å€‘ç¾åœ¨ä¸åƒ…è¦ç²å–ä½¿ç”¨è€…å¯è¦‹çš„æ¶ˆæ¯ï¼Œé‚„è¦æŠŠAIè‡ªå·±çš„â€œå…§å¿ƒç¨ç™½â€ä¹ŸåŒ…å«é€²ä¾†ã€‚
    const messagesToSummarize = force 
        ? chat.history.filter(m => !m.isHidden || (m.role === 'system' && m.content.includes('å…§å¿ƒç¨ç™½'))).slice(-(chat.settings.autoMemoryInterval || 20))
        : chat.history.filter(m => m.timestamp > lastSummaryTimestamp && (!m.isHidden || (m.role === 'system' && m.content.includes('å…§å¿ƒç¨ç™½'))));
        
    if (messagesToSummarize.length < 5) {
        if (force) alert("æœ€è¿‘çš„æ¶ˆæ¯å¤ªå°‘ï¼Œç„¡æ³•é€²è¡Œæœ‰æ„ç¾©çš„ç¸½çµã€‚");
        return;
    }

    const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ¶';
    
    // --- âœ¨ æ ¸å¿ƒä¿®æ”¹ â‘¡ï¼šæ›´æ–°æ­·å²è¨˜éŒ„æ ¼å¼åŒ–é‚è¼¯ ---
    // è®“AIèƒ½æ¸…æ™°åœ°å€åˆ†â€œå°è©±â€å’Œâ€œè‡ªå·±çš„å…§å¿ƒæƒ³æ³•â€
    const formattedHistory = messagesToSummarize.map(msg => {
        // å¦‚æœæ˜¯éš±è—çš„å…§å¿ƒç¨ç™½æ¶ˆæ¯
        if (msg.isHidden && msg.role === 'system' && msg.content.includes('å…§å¿ƒç¨ç™½')) {
            // ç›´æ¥è¿”å›å…§å®¹ï¼Œå®ƒå·²ç¶“åŒ…å«äº†æ¸…æ™°çš„æ¨™ç±¤
            return msg.content;
        }
        
        // ï¼ˆè™•ç†å…¶ä»–æ™®é€šæ¶ˆæ¯çš„é‚è¼¯ä¿æŒä¸è®Šï¼‰
        let sender;
        if (msg.role === 'user') {
            sender = userNickname;
        } else {
            sender = msg.senderName || chat.originalName;
        }
        let contentToSummarize = '';
        if (msg.type === 'offline_text') {
            if (msg.content) {
                 contentToSummarize = msg.content;
            } else {
                const dialogue = msg.dialogue ? `ã€Œ${msg.dialogue}ã€` : '';
                const description = msg.description ? `(${msg.description})` : '';
                contentToSummarize = `${dialogue} ${description}`.trim();
            }
        } else {
            contentToSummarize = String(msg.content);
        }
        return `${sender}: ${contentToSummarize}`;
    }).join('\n');



    let systemPrompt;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ“šèŠå¤©é¡å‹ï¼Œé¸æ“‡ä¸åŒçš„ç¸½çµç­–ç•¥ â–¼â–¼â–¼
    if (chat.isGroup) {
        // --- é€™æ˜¯ç‚ºã€ç¾¤èŠã€‘è¨­è¨ˆçš„å…¨æ–°â€œå€‹æ€§åŒ–è¨˜æ†¶â€æŒ‡ä»¤ ---
        systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹é«˜ç´šçš„â€œè¨˜æ†¶åˆ†é…å°ˆå®¶â€ã€‚ä½ çš„ä»»å‹™æ˜¯é–±è®€ä¸‹é¢çš„ç¾¤èŠè¨˜éŒ„ï¼Œä¸¦ç‚ºã€æ¯ä¸€å€‹åƒèˆ‡çš„AIè§’è‰²ã€‘ç”Ÿæˆä¸€æ®µã€å€‹æ€§åŒ–çš„ã€ç¬¬ä¸€äººç¨±ã€‘çš„é•·æœŸè¨˜æ†¶ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **è¦–è§’éµå¾‹**: æ¯ä¸€æ¢ç¸½çµéƒ½ã€å¿…é ˆã€‘ä½¿ç”¨ã€ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ã€‚
2.  **å…§å®¹æ ¸å¿ƒ**: é‡é»ç¸½çµï¼š
    *   **æˆ‘èªªéçš„è©±** å’Œ **æˆ‘åšéçš„äº‹**ã€‚
    *   åˆ¥äºº **å°æˆ‘** èªªçš„è©±ï¼Œæˆ–è€… **èˆ‡æˆ‘ç›¸é—œ** çš„äº‹ã€‚
    *   å°æˆ‘å€‹äºº **å¾ˆé‡è¦** çš„ç¾¤èŠäº‹ä»¶ã€é—œéµè³‡è¨Šå’Œå¿ƒç†æ´»å‹•ã€‚
3.  **ã€ç°¡æ½”æ€§éµå¾‹ã€‘**: æ¯æ¢å€‹äººè¨˜æ†¶ç¸½çµã€çµ•å°ä¸èƒ½è¶…é60å€‹å­—ã€‘ã€‚
4.  **ã€çœç•¥è¦å‰‡ã€‘**: å¦‚æœä¸€å€‹è§’è‰²åœ¨æœ¬æ¬¡å°è©±ä¸­ã€å®Œå…¨æ²’æœ‰åƒèˆ‡æˆ–æåŠã€‘ï¼Œä½ å¯ä»¥çœç•¥TAçš„è¨˜æ†¶ã€‚
5.  **è¼¸å‡ºæ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`\`\`json
    {
      "summaries": {
        "è§’è‰²çš„æœ¬åA": "æˆ‘ä»Šå¤©åœ¨ç¾¤è£¡å’Œå¤§å®¶è¨è«–äº†é›»å½±ï¼Œæ„Ÿè¦ºå¾ˆé–‹å¿ƒã€‚",
        "è§’è‰²çš„æœ¬åB": "æˆ‘åœ¨ç¾¤è£¡å’Œ${userNickname}èŠäº†é—œæ–¼ç”Ÿæ—¥æ´¾å°çš„äº‹ï¼Œæˆ‘å€‘ç´„å¥½äº†10æœˆ1æ—¥è¦‹é¢ã€‚"
      }
    }
    \`\`\`

# å¾…ç¸½çµçš„ç¾¤èŠè¨˜éŒ„
${formattedHistory}

# ç¾¤æˆå“¡æ¸…å–® (ä½ çš„ç¸½çµç›®æ¨™)
${chat.members.map(m => `- ${m.groupNickname} (æœ¬å: ${m.originalName})`).join('\n')}

ç¾åœ¨ï¼Œè«‹ç‚ºã€åƒèˆ‡äº†å°è©±çš„AIè§’è‰²ã€‘ç”Ÿæˆä»–å€‘å„è‡ªçš„ã€ç¬¬ä¸€äººç¨±çš„ã€ç²¾ç°¡çš„è¨˜æ†¶ã€‚`;

    } else {
        // --- é€™æ˜¯ç‚ºã€å–®èŠã€‘è¨­è¨ˆçš„ã€ä¿æŒä¸è®Šçš„â€œå®¢è§€ç¸½çµâ€æŒ‡ä»¤ ---
        systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ å°±æ˜¯è§’è‰²â€œ${chat.originalName}â€ã€‚è«‹ä½ å›é¡§ä¸€ä¸‹å‰›æ‰å’Œâ€œ${userNickname}â€çš„å°è©±ï¼Œç„¶å¾Œç”¨ã€ç¬¬ä¸€äººç¨± ("æˆ‘")ã€‘çš„å£å»ï¼Œç¸½çµå‡ºä¸€æ®µç°¡çŸ­çš„ã€åŒ…å«æ ¸å¿ƒäº‹ä»¶å’Œå¿ƒç†æ´»å‹•çš„å›æ†¶ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **è¦–è§’éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘ä½¿ç”¨ã€ä¸»è§€çš„ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ä¾†å¯«ã€‚
2.  **å…§å®¹æ ¸å¿ƒ**: ä½ çš„å›æ†¶æ‡‰è©²åŒ…å«ï¼š
    *   **åŠ‡æƒ…å›é¡§**: å‰›æ‰æˆ‘å€‘èŠäº†ä»€éº¼é—œéµçš„äº‹ï¼Ÿ
    *   **å¿ƒç†æ´»å‹•**: æˆ‘ç•¶æ™‚å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿæœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿ
3.  **é•·åº¦éµå¾‹**: ä½ çš„ç¸½çµã€å¿…é ˆã€‘éå¸¸ç°¡çŸ­ï¼Œç¸½é•·åº¦ã€çµ•å°ä¸èƒ½è¶…é80å€‹å­—ã€‘ã€‚
4.  **å£å»èˆ‡äººè¨­**: ä½ çš„èªæ°£ã€å¿…é ˆã€‘åš´æ ¼ç¬¦åˆä½ çš„è§’è‰²è¨­å®šã€‚
5.  **è¼¸å‡ºæ ¼å¼**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨é€™è£¡å¯«ä¸‹ä½ ä»¥ç¬¬ä¸€äººç¨±è¦–è§’ï¼Œç¸½çµå¥½çš„æ ¸å¿ƒå›æ†¶ã€‚"}\`

# ä½ çš„è§’è‰²è¨­å®š
${chat.settings.aiPersona}

# å¾…ç¸½çµçš„å°è©±æ­·å²
${formattedHistory}

ç¾åœ¨ï¼Œè«‹ä»¥â€œ${chat.originalName}â€çš„èº«ä»½ï¼Œé–‹å§‹ä½ çš„å›æ†¶ã€‚`;
    }
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : state.apiConfig;
        if (!proxyUrl || !apiKey || !model) throw new Error('APIæœªé…ç½®');
        
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è«‹é–‹å§‹ç¸½çµã€‚" }]);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`}, body: JSON.stringify({ model: model, messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "è«‹é–‹å§‹ç¸½çµã€‚"}], temperature: 0.2 }) });
        
        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ“šèŠå¤©é¡å‹ï¼ŒåŸ·è¡Œä¸åŒçš„è¨˜æ†¶ä¿å­˜é‚è¼¯ â–¼â–¼â–¼
        if (chat.isGroup) {
            // --- é€™æ˜¯ç¾¤èŠçš„â€œå€‹æ€§åŒ–è¨˜æ†¶æ³¨å…¥â€é‚è¼¯ ---
            if (result.summaries && typeof result.summaries === 'object') {
                let memoriesAddedCount = 0;
                for (const memberOriginalName in result.summaries) {
                    const summaryText = result.summaries[memberOriginalName];
                    if (summaryText && summaryText.trim()) {
                        const memberChat = Object.values(state.chats).find(c => c.originalName === memberOriginalName);
                        if (memberChat) {
                            const newMemoryEntry = {
                                content: summaryText.trim(),
                                timestamp: Date.now(),
                                source: `group_summary_from_${chat.name}`
                            };
                            if (!memberChat.longTermMemory) memberChat.longTermMemory = [];
                            memberChat.longTermMemory.push(newMemoryEntry);
                            await db.chats.put(memberChat);
                            memoriesAddedCount++;
                        }
                    }
                }
                if (memoriesAddedCount > 0) {
                    // *** ä¿®æ”¹é» 1ï¼šç§»é™¤å½ˆçª—ï¼Œæ”¹ç‚ºåœ¨æ§åˆ¶å°è¼¸å‡ºæ—¥èªŒ ***
                    console.log(`è‡ªå‹•ç¸½çµæˆåŠŸï¼šç‚º ${memoriesAddedCount} ä½ç¾¤æˆå“¡ç”Ÿæˆä¸¦æ³¨å…¥äº†å€‹æ€§åŒ–è¨˜æ†¶ï¼`);
                } else {
                    throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¢ºçš„ç¸½çµå…§å®¹ã€‚");
                }
            } else {
                throw new Error("AIè¿”å›çš„JSONæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ 'summaries' æ¬„ä½ã€‚");
            }
        } else {
            if (result.summary && result.summary.trim()) {
                const newMemoryEntry = { content: result.summary.trim(), timestamp: Date.now(), source: 'auto' };
                chat.longTermMemory.push(newMemoryEntry);
                await db.chats.put(chat);
                // *** ä¿®æ”¹é» 2ï¼šç§»é™¤å½ˆçª—ï¼Œæ”¹ç‚ºåœ¨æ§åˆ¶å°è¼¸å‡ºæ—¥èªŒ ***
                console.log('è‡ªå‹•ç¸½çµæˆåŠŸï¼šå·²æˆåŠŸæ·»åŠ  1 æ¢æ–°çš„é•·æœŸè¨˜æ†¶ï¼');
            } else {
                throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¢ºçš„ç¸½çµå…§å®¹ã€‚");
            }
        }

        chat.lastMemorySummaryTimestamp = messagesToSummarize.slice(-1)[0].timestamp;
        await db.chats.put(chat);
        
        if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
            renderLongTermMemoryList();
        }
    } catch (error) {
        console.error("ç¸½çµé•·æœŸè¨˜æ†¶æ™‚å‡ºéŒ¯:", error);
        // *** ä¿®æ”¹é» 3ï¼šå¤±æ•—æ™‚ä¾ç„¶å½ˆå‡ºéŒ¯èª¤æç¤º ***
        await showCustomAlert('ç¸½çµå¤±æ•—', `æ“ä½œå¤±æ•—: ${error.message}`);
    }
}

        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¾©åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
        
        function startReplyToMessage() {
            if (!activeMessageTimestamp) return;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘
            let senderDisplayName;
            if (message.role === 'user') {
                senderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            } else { // AIçš„æ¶ˆæ¯
                if (chat.isGroup) {
                    // åœ¨ç¾¤èŠä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ getDisplayNameInGroup å‡½æ•¸ä¾†ç²å–æ­£ç¢ºçš„ç¾¤æ˜µç¨±
                    senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
                } else {
                    // åœ¨å–®èŠä¸­ï¼Œç›´æ¥ä½¿ç”¨å‚™è¨»å
                    senderDisplayName = chat.name;
                }
            }
            // ã€ã€ã€ä¿®å¾©çµæŸã€‘ã€‘ã€‘
        
            const fullContent = String(message.content || '');
            let previewSnippet = '';
        
            if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
                previewSnippet = '[è¡¨æƒ…]';
            } else if (message.type === 'ai_image' || message.type === 'user_photo') {
                previewSnippet = '[åœ–ç‰‡]';
            } else if (message.type === 'voice_message') {
                previewSnippet = '[èªéŸ³]';
            } else {
                previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
            }
        
            currentReplyContext = {
                timestamp: message.timestamp,
                senderName: senderDisplayName, // ä½¿ç”¨æˆ‘å€‘å‰›å‰›ç²å–åˆ°çš„ã€æ­£ç¢ºçš„é¡¯ç¤ºåç¨±
                content: fullContent, 
            };
        
            const previewBar = document.getElementById('reply-preview-bar');
            previewBar.querySelector('.sender').textContent = `å›å¾© ${currentReplyContext.senderName}:`;
            previewBar.querySelector('.text').textContent = previewSnippet;
            previewBar.style.display = 'block';
        
            hideMessageActions();
            document.getElementById('chat-input').focus();
        }
        
        function cancelReplyMode() {
            currentReplyContext = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä½¿ç”¨è€…è™•ç†è½‰å¸³çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
        
        let activeTransferTimestamp = null; // ç”¨æ–¼æš«å­˜è¢«é»æ“Šçš„è½‰å¸³æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
        
        /**
         * é¡¯ç¤ºè™•ç†è½‰å¸³çš„æ“ä½œåŠŸèƒ½è¡¨
         * @param {number} timestamp - è¢«é»æ“Šçš„è½‰å¸³æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         */
        function showTransferActionModal(timestamp) {
            activeTransferTimestamp = timestamp;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (message) {
                // å°‡AIçš„åå­—å¡«å…¥å½ˆçª—
                document.getElementById('transfer-sender-name').textContent = message.senderName;
            }
            document.getElementById('transfer-actions-modal').classList.add('visible');
        }
        
        /**
         * éš±è—è™•ç†è½‰å¸³çš„æ“ä½œåŠŸèƒ½è¡¨
         */
        function hideTransferActionModal() {
            document.getElementById('transfer-actions-modal').classList.remove('visible');
            activeTransferTimestamp = null;
        }
        
        /**
         * è™•ç†ä½¿ç”¨è€…æ¥å—æˆ–æ‹’çµ•è½‰å¸³çš„é‚è¼¯
         * @param {string} choice - ç”¨æˆ¶çš„é¸æ“‡, 'accepted' æˆ– 'declined'
         */
        async function handleUserTransferResponse(choice) {
            if (!activeTransferTimestamp) return;
        
            const timestamp = activeTransferTimestamp;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°åŸå§‹è½‰å¸³æ¶ˆæ¯çš„ç‹€æ…‹
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
        
            let systemContent;
        
            // 2. å¦‚æœç”¨æˆ¶é¸æ“‡â€œæ‹’çµ•â€
            if (choice === 'declined') {
                // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€å€‹â€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°
                const refundMessage = {
                    role: 'user',
                    type: 'transfer',
                    isRefund: true, // é€™æ˜¯ä¸€å€‹é—œéµæ¨™è¨˜ï¼Œç”¨æ–¼UIé¡¯ç¤ºé€™æ˜¯é€€æ¬¾
                    amount: originalMessage.amount,
                    note: 'å·²æ‹’æ”¶å°æ–¹è½‰å¸³',
                    timestamp: Date.now()
                };
                chat.history.push(refundMessage);
                
                // æº–å‚™ä¸€æ¢å°AIå¯è¦‹çš„éš±è—æ¶ˆæ¯ï¼Œå‘Šè¨´å®ƒç™¼ç”Ÿäº†ä»€éº¼
                systemContent = `[ç³»çµ±æç¤ºï¼šä½ æ‹’çµ•ä¸¦é€€é‚„äº†â€œ${originalMessage.senderName}â€çš„è½‰å¸³ã€‚]`;
            } else { // å¦‚æœç”¨æˆ¶é¸æ“‡â€œæ¥å—â€
                // åªéœ€æº–å‚™éš±è—æ¶ˆæ¯é€šçŸ¥AIå³å¯
                systemContent = `[ç³»çµ±æç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½‰å¸³ã€‚]`;
            }
        
            // 3. å‰µå»ºé€™æ¢å°ç”¨æˆ¶éš±è—ã€ä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now() + 1, // ä¿è­‰æ™‚é–“æˆ³è¨˜åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å¾Œ
                isHidden: true // é€™å€‹æ¨™è¨˜æœƒè®“å®ƒä¸åœ¨èŠå¤©ä»‹é¢é¡¯ç¤º
            };
            chat.history.push(hiddenMessage);
        
            // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°è³‡æ–™åº«ï¼Œä¸¦åˆ·æ–°ä»‹é¢
            await db.chats.put(chat);
            hideTransferActionModal(); 
            renderChatInterface(state.activeChatId);
            renderChatList();
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè©±è¨˜éŒ„åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        async function renderCallHistoryScreen() {
            showScreen('call-history-screen'); // <--ã€æ ¸å¿ƒä¿®æ­£ã€‘æŠŠå®ƒç§»å‹•åˆ°æœ€å‰é¢ï¼
        
            const listEl = document.getElementById('call-history-list');
            const titleEl = document.getElementById('call-history-title');
            listEl.innerHTML = '';
            titleEl.textContent = 'æ‰€æœ‰é€šè©±è¨˜éŒ„';
            
            const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
            
            if (records.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡é‚„æ²’æœ‰é€šè©±è¨˜éŒ„å“¦~</p>';
                return; // ç¾åœ¨çš„ return å°±æ²’å•é¡Œäº†ï¼Œå› ç‚ºå®ƒåªè·³éäº†å¾ŒçºŒçš„æ¸²æŸ“é‚è¼¯
            }
            
            records.forEach(record => {
                const card = createCallRecordCard(record);
        
            addLongPressListener(card, async () => {
                // 1. å½ˆå‡ºè¼¸å…¥æ¡†ï¼Œä¸¦å°‡èˆŠåç¨±ä½œç‚ºé è¨­å€¼ï¼Œæ–¹ä¾¿ä¿®æ”¹
                const newName = await showCustomPrompt(
                    "è‡ªè¨‚é€šè©±åç¨±", 
                    "è«‹è¼¸å…¥æ–°çš„åç¨±ï¼ˆç•™ç©ºå‰‡æ¢å¾©é»˜èªï¼‰",
                    record.customName || '' // å¦‚æœå·²æœ‰è‡ªè¨‚åç¨±ï¼Œå°±é¡¯ç¤ºå®ƒ
                );
        
                // 2. å¦‚æœç”¨æˆ¶é»æ“Šäº†â€œå–æ¶ˆâ€ï¼Œå‰‡ä»€éº¼éƒ½ä¸åš
                if (newName === null) return;
                
                // 3. æ›´æ–°è³‡æ–™åº«ä¸­çš„é€™æ¢è¨˜éŒ„
                await db.callRecords.update(record.id, { customName: newName.trim() });
                
                // 4. åˆ·æ–°æ•´å€‹æ¸…å–®ï¼Œè®“æ›´æ”¹ç«‹åˆ»é¡¯ç¤ºå‡ºä¾†
                await renderCallHistoryScreen();
                
                // 5. çµ¦ç”¨æˆ¶ä¸€å€‹æˆåŠŸçš„æç¤º
                await showCustomAlert('æˆåŠŸ', 'é€šè©±åç¨±å·²æ›´æ–°ï¼');
            });
                listEl.appendChild(card);
            });    
        }
        
        // â–¼â–¼â–¼ ç”¨é€™å€‹ã€å‡ç´šç‰ˆã€‘å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›ä½ èˆŠçš„ createCallRecordCard å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€å‡ç´šç‰ˆã€‘æ ¹æ“šå–®æ¢è¨˜éŒ„è³‡æ–™ï¼Œå‰µå»ºä¸€å¼µèƒ½é¡¯ç¤ºèŠå¤©ç‰©ä»¶çš„é€šè©±å¡ç‰‡
         * @param {object} record - ä¸€æ¢é€šè©±è¨˜éŒ„ç‰©ä»¶
         * @returns {HTMLElement} - å‰µå»ºå¥½çš„å¡ç‰‡div
         */
        function createCallRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'call-record-card';
            card.dataset.recordId = record.id; 
        
            // ç²å–é€šè©±å°è±¡çš„åå­—
            const chatInfo = state.chats[record.chatId];
            const chatName = chatInfo ? chatInfo.name : 'æœªçŸ¥æœƒè©±';
        
            const callDate = new Date(record.timestamp);
            const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
            const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;
        
            const avatarsHtml = record.participants.map(p => 
                `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
            ).join('');
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="date">${dateString}</span>
                    <span class="duration">${durationText}</span>
                </div>
                <div class="card-body">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ–°å¢ä¸€å€‹æ¨™é¡Œè¡Œ -->
                    ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
                    
                    <div class="participants-info"> <!-- æ–°å¢ä¸€å€‹å®¹å™¨æ–¹ä¾¿ä½ˆå±€ -->
                        <div class="participants-avatars">${avatarsHtml}</div>
                        <span class="participants-names">èˆ‡ ${chatName}</span>
                    </div>
                </div>
            `;
            return card;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
/**
 * ã€V2.0 | æ”¯æ´æ‰‹å‹•ç¸½çµ & éŒ¯èª¤è™•ç†ã€‘é¡¯ç¤ºæŒ‡å®šé€šè©±è¨˜éŒ„çš„å®Œæ•´æ–‡å­—ç¨¿
 * @param {number} recordId - é€šè©±è¨˜éŒ„çš„ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('call-transcript-modal-body');

    titleEl.textContent = `é€šè©±æ–¼ ${new Date(record.timestamp).toLocaleString()} (æ™‚é•·: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
    bodyEl.innerHTML = '';
    
    const deleteBtn = document.getElementById('delete-transcript-btn');
    const summarizeBtn = document.getElementById('manual-summarize-btn');
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">é€™æ¬¡é€šè©±æ²’æœ‰ç•™ä¸‹æ–‡å­—è¨˜éŒ„ã€‚</p>';
        summarizeBtn.style.display = 'none';
    } else {
        summarizeBtn.style.display = 'block';
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    const newSummarizeBtn = summarizeBtn.cloneNode(true);
    summarizeBtn.parentNode.replaceChild(newSummarizeBtn, summarizeBtn);
    
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "ç¢ºèªåˆªé™¤", "ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢é€šè©±è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚", { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            modal.classList.remove('visible');
            await db.callRecords.delete(recordId);
            await renderCallHistoryScreen();
            alert('é€šè©±è¨˜éŒ„å·²åˆªé™¤ã€‚');
        }
    });

// â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨éœ€è¦æ›¿æ›çš„ä»£ç¢¼å¡Šã€‘ â–¼â–¼â–¼

newSummarizeBtn.addEventListener('click', async () => {
    // ã€æ ¸å¿ƒæ–°å¢1ã€‘åœ¨åŸ·è¡Œæ“ä½œå‰ï¼Œå…ˆå½ˆå‡ºç¢ºèªæ¡†
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ“ä½œ',
        'é€™å°‡æå–ç•¶å‰é€šè©±è¨˜éŒ„ç™¼é€çµ¦AIé€²è¡Œç¸½çµï¼Œæœƒæ¶ˆè€—APIé¡åº¦ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', {
            confirmText: 'ç¢ºèªç¸½çµ'
        }
    );

    // å¦‚æœç”¨æˆ¶å–æ¶ˆï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
    if (!confirmed) return;

    modal.classList.remove('visible');
    const chat = state.chats[record.chatId];
    if (!chat) {
        alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²é€šè©±è¨˜éŒ„æ‰€å±¬çš„èŠå¤©ç‰©ä»¶ã€‚');
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIé€²è¡Œæ‰‹å‹•ç¸½çµ...");

    try {
        const transcriptText = record.transcript.map(h => {
            const sender = h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (h.senderName || chat.name);
            return `${sender}: ${h.content}`;
        }).join('\n');

        await summarizeCallTranscript(record.chatId, transcriptText);

        await showCustomAlert("ç¸½çµæˆåŠŸ", `æ‰‹å‹•ç¸½çµå·²å®Œæˆï¼æ–°çš„è¨˜æ†¶å·²æ·»åŠ åˆ°â€œ${chat.name}â€çš„é•·æœŸè¨˜æ†¶ä¸­ã€‚`);

    } catch (error) {
        await showCustomAlert("ç¸½çµå¤±æ•—", `æ“ä½œå¤±æ•—ï¼Œæœªèƒ½ç”Ÿæˆé•·æœŸè¨˜æ†¶ã€‚\n\néŒ¯èª¤è©³æƒ…: ${error.message}`);
    }
});

// â–²â–²â–² æ›¿æ›åˆ°é€™è£¡çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨éœ€è¦æ·»åŠ çš„æ ¸å¿ƒä¿®å¾©ä»£ç¢¼ã€‘ â–¼â–¼â–¼

// 3. ç‚ºâ€œé—œé–‰â€æŒ‰éˆ•ä¹Ÿå‰µå»ºå…‹éš†ä¸¦ç¶å®šäº‹ä»¶ï¼Œç¢ºä¿å®ƒç¸½æ˜¯å¯ç”¨
const closeBtn = document.getElementById('close-transcript-modal-btn');
const newCloseBtn = closeBtn.cloneNode(true);
closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

newCloseBtn.addEventListener('click', () => {
    modal.classList.remove('visible');
});

// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
    modal.classList.add('visible');
}
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å…¨æ–°å‡½æ•¸ã€‘æ›¿æ›æ‰ä½ èˆŠçš„ handleStatusResetClick å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶é»æ“Šç‹€æ…‹åˆ—ï¼Œå½ˆå‡ºç·¨è¼¯æ–¹å¡Šè®“ä½¿ç”¨è€…ä¿®æ”¹AIçš„ç•¶å‰ç‹€æ…‹
         */
        async function handleEditStatusClick() {
            // 1. å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿åœ¨å–®èŠä»‹é¢
            if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
                return; 
            }
            const chat = state.chats[state.activeChatId];
        
            // 2. å½ˆå‡ºè¼¸å…¥æ¡†ï¼Œè®“ä½¿ç”¨è€…è¼¸å…¥æ–°çš„ç‹€æ…‹ï¼Œä¸¦å°‡ç•¶å‰ç‹€æ…‹ä½œç‚ºé è¨­å€¼
            const newStatusText = await showCustomPrompt(
                'ç·¨è¼¯å°æ–¹ç‹€æ…‹',
                'è«‹è¼¸å…¥å°æ–¹ç¾åœ¨çš„æ–°ç‹€æ…‹ï¼š',
                chat.status.text // å°‡ç•¶å‰ç‹€æ…‹ä½œç‚ºè¼¸å…¥æ¡†çš„é è¨­å…§å®¹
            );
        
            // 3. å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†å…§å®¹ä¸¦é»æ“Šäº†â€œç¢ºå®šâ€
            if (newStatusText !== null) {
                // 4. æ›´æ–°è¨˜æ†¶é«”å’Œè³‡æ–™åº«ä¸­çš„ç‹€æ…‹è³‡æ–™
                chat.status.text = newStatusText.trim() || 'ç·šä¸Š'; // å¦‚æœç”¨æˆ¶æ¸…ç©ºäº†ï¼Œå°±é»˜èªç‚ºâ€œç·šä¸Šâ€
                chat.status.isBusy = false; // æ¯æ¬¡æ‰‹å‹•ç·¨è¼¯éƒ½é»˜èªå…¶ä¸è™•æ–¼â€œå¿™ç¢Œâ€ç‹€æ…‹
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
        
                // 5. ç«‹åˆ»åˆ·æ–°UIï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°ä¿®æ”¹å¾Œçš„ç‹€æ…‹
                renderChatInterface(state.activeChatId);
                renderChatList();
                
                // 6. çµ¦å‡ºä¸€å€‹ç„¡å‚·å¤§é›…çš„æˆåŠŸæç¤º
                await showCustomAlert('ç‹€æ…‹å·²æ›´æ–°', `â€œ${chat.name}â€çš„ç•¶å‰ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š${chat.status.text}`);
            }
        }
        
        // æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€
        async function openShareTargetPicker() {
            const modal = document.getElementById('share-target-modal');
            const listEl = document.getElementById('share-target-list');
            listEl.innerHTML = '';
        
            // ç²å–æ‰€æœ‰èŠå¤©ä½œç‚ºåˆ†äº«ç›®æ¨™
            const chats = Object.values(state.chats);
        
            chats.forEach(chat => {
                // è¤‡ç”¨é€£çµ¡äººé¸æ“‡å™¨çš„æ¨£å¼
                const item = document.createElement('div');
                item.className = 'contact-picker-item'; 
                item.innerHTML = `
                    <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
                    <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                `;
                listEl.appendChild(item);
            });
            
            modal.classList.add('visible');
        }
        
        function closeMusicPlayerWithAnimation(callback) {
            const overlay = document.getElementById('music-player-overlay');
            if (!overlay.classList.contains('visible')) {
                if (callback) callback();
                return;
            }
            overlay.classList.remove('visible');
            setTimeout(() => {
                document.getElementById('music-playlist-panel').classList.remove('visible');
                if (callback) callback();
            }, 400); 
        }
        
function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = String(lrcContent).split(/\r\n?|\n/);
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">â™ª æš«ç„¡æ­Œè© â™ª</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
    
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
        if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
            singleLyricEl.textContent = musicState.parsedLyrics[newLyricIndex].text;
        } else {
            singleLyricEl.textContent = 'â™ª â™ª â™ª';
        }
    }

    const lyricBar = document.getElementById('global-lyrics-bar');
    if (lyricBar.classList.contains('visible')) {
        if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
            lyricBar.textContent = musicState.parsedLyrics[newLyricIndex].text;
        } else {
            lyricBar.textContent = 'â™ª';
        }
    }
}

function updateLyricsUI(isFullscreen = false) {
    const listSelector = isFullscreen ? '#fullscreen-lyrics-container .music-lyrics-list' : '#music-lyrics-container #music-lyrics-list';
    const containerSelector = isFullscreen ? '#fullscreen-lyrics-container' : '#music-lyrics-container';
    
    const lyricsList = document.querySelector(listSelector);
    const container = document.querySelector(containerSelector);
    if (!lyricsList || !container) return;

    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));

    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }

    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 2.2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }
}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

let lastTimeUpdate = 0; 
let animationFrameId; 

function updateMusicProgressBar() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }

    function step() {
        if (!musicState.isPlaying || !audioPlayer.duration) {
            return; 
        }
        
        const now = performance.now();
        const currentTime = audioPlayer.currentTime;
        const duration = audioPlayer.duration;

        const progressPercent = (currentTime / duration) * 100;
        document.getElementById('music-progress-fill').style.width = `${progressPercent}%`;

        if (now - lastTimeUpdate > 1000) {
            document.getElementById('music-current-time').textContent = formatMusicTime(currentTime);
            document.getElementById('music-total-time').textContent = formatMusicTime(duration);
            lastTimeUpdate = now;
        }

        updateActiveLyric(currentTime);

        animationFrameId = requestAnimationFrame(step);
    }

    animationFrameId = requestAnimationFrame(step);
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°æ¼”æ¨¡å¼æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ‰“é–‹â€œå°æ¼”å‰ªè¼¯å®¤â€ï¼Œç·¨è¼¯AIçš„ä¸Šä¸€è¼ªå›æ‡‰
         */
        function openAiResponseEditor() {
            if (!lastRawAiResponse) {
                alert("é‚„æ²’æœ‰å¯ä¾›ç·¨è¼¯çš„AIå›æ‡‰ã€‚è«‹å…ˆè®“AIå›å¾©ä¸€æ¬¡ã€‚");
                return;
            }
        
            const editorModal = document.getElementById('ai-response-editor-modal');
            const editorContainer = document.getElementById('ai-response-editor-container');
            editorContainer.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
        
            // ä½¿ç”¨èˆ‡ä¸»æµç¨‹ç›¸åŒçš„ã€å¼·å¤§çš„è§£æå‡½æ•¸ä¾†æå–æ‰€æœ‰JSONç‰©ä»¶
            const jsonMatches = lastRawAiResponse.match(/{[^{}]*}/g);
            
            if (jsonMatches) {
                jsonMatches.forEach(jsonString => {
                    try {
                        // ç¾åŒ–JSONæ ¼å¼ï¼Œæ–¹ä¾¿é–±è®€å’Œç·¨è¼¯
                        const parsedObject = JSON.parse(jsonString);
                        const formattedJson = JSON.stringify(parsedObject, null, 2);
                        const block = createAiResponseEditorBlock(formattedJson);
                        editorContainer.appendChild(block);
                    } catch (e) {
                        // å¦‚æœæŸå€‹ç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œä¹ŸæŠŠå®ƒé¡¯ç¤ºå‡ºä¾†ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ä¿®æ­£å®ƒ
                        const block = createAiResponseEditorBlock(jsonString);
                        editorContainer.appendChild(block);
                        console.warn("åœ¨å°æ¼”æ¨¡å¼ä¸­ç™¼ç¾ä¸€å€‹ç„¡æ•ˆçš„JSONç‰‡æ®µ:", jsonString);
                    }
                });
            } else {
                // å¦‚æœå®Œå…¨æ²’æœ‰æ‰¾åˆ°JSONï¼Œå°±æŠŠåŸå§‹æ–‡æœ¬æ”¾é€²å»è®“ä½¿ç”¨è€…ç·¨è¼¯
                const block = createAiResponseEditorBlock(lastRawAiResponse);
                editorContainer.appendChild(block);
            }
            
            editorModal.classList.add('visible');
        }
        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²æ·»åŠ â€œå¼•ç”¨â€ç¯„æœ¬çš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ createAiResponseEditorBlock å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘å‰µå»ºä¸€å€‹å¯ç·¨è¼¯çš„AIéŸ¿æ‡‰å¡Š
 * @param {string} initialContent - æ–‡å­—æ–¹å¡Šçš„åˆå§‹å…§å®¹
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
 */
function createAiResponseEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'ai-response-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡æ·»åŠ  'quote' ç¯„æœ¬
    const templates = {
        text: { type: 'text', content: 'åœ¨é€™è£¡è¼¸å…¥æ–‡æœ¬...' },
        sticker: { type: 'sticker', url: 'https://...', meaning: 'è¡¨æƒ…å«ç¾©' },
        image: { type: 'ai_image', description: 'åœ¨é€™è£¡è¼¸å…¥åœ–ç‰‡æè¿°...' },
        voice: { type: 'voice_message', content: 'åœ¨é€™è£¡è¼¸å…¥èªéŸ³å…§å®¹...' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€é»å¿ƒæ„' },
        offline: { type: 'offline_text', content: 'ã€Œåœ¨é€™è£¡è¼¸å…¥å°è©±å…§å®¹ã€\\n(åœ¨é€™è£¡è¼¸å…¥å‹•ä½œæˆ–ç’°å¢ƒæå¯«)' },
        quote: { type: 'quote_reply', target_timestamp: 1234567890, reply_content: 'åœ¨é€™è£¡è¼¸å…¥å›å¾©å…§å®¹' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆªé™¤æ­¤æ¢å‹•ä½œ">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.text)}'>æ–‡æœ¬</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.sticker)}'>è¡¨æƒ…</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>åœ–ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>èªéŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½‰å¸³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>ç·šä¸‹</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨é€™è£¡æ·»åŠ æ–°çš„â€œå¼•ç”¨â€æŒ‰éˆ• -->
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>å¼•ç”¨</button>
        </div>
    `;

    // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        block.remove();
    });

    // ç¶å®šæ ¼å¼åŠ©æ‰‹æŒ‰éˆ•äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    // ç¾åŒ–æ ¼å¼å¾Œå¡«å…¥
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼ç¯„æœ¬å¤±æ•—:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€V3.0 | å®¹éŒ¯çµ‚æ¥µä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ saveEditedAiResponse å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€æ ¸å¿ƒã€‘ä¿å­˜å°æ¼”æ¨¡å¼ä¸‹ä¿®æ”¹éçš„å…§å®¹ï¼Œä¸¦é‡å¯«æ­·å²è¨˜éŒ„
         */
        async function saveEditedAiResponse() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 1. å¾DOMä¸­æ”¶é›†æ‰€æœ‰ç·¨è¼¯å¾Œçš„JSONå­—ä¸²ï¼Œä¸¦æ§‹å»ºä¸€å€‹æ–°çš„åŸå§‹éŸ¿æ‡‰å­—ä¸²
            const editorContainer = document.getElementById('ai-response-editor-container');
            const editorTextareas = editorContainer.querySelectorAll('textarea');
            const editedRawBlocks = Array.from(editorTextareas).map(ta => ta.value.trim()).filter(Boolean);
        
            // å¦‚æœä½¿ç”¨è€…åˆªé™¤äº†æ‰€æœ‰å…§å®¹ï¼Œå‰‡è¦–ç‚ºæ¸…ç©ºä¸Šä¸€è¼ªå›å¾©
            if (editedRawBlocks.length === 0) {
                chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
                document.getElementById('ai-response-editor-modal').classList.remove('visible');
                lastRawAiResponse = '';
                lastResponseTimestamps = [];
                return;
            }
        
            // 2. è§£ææ–°çš„æ¶ˆæ¯é™£åˆ—
            let newMessagesArray = [];
            for (const rawContent of editedRawBlocks) {
                try {
                    const parsedObject = JSON.parse(rawContent);
                    newMessagesArray.push(parsedObject);
                } catch (e) {
                    console.warn("è·³éä¸€å€‹ç„¡æ³•è§£æç‚ºJSONçš„ç·¨è¼¯å¡Š:", rawContent);
                }
            }
        
            // 3. å¾èŠå¤©æ­·å²ä¸­ç§»é™¤ä¸Šä¸€è¼ªAIç”Ÿæˆçš„æ‰€æœ‰æ¶ˆæ¯
            chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));
        
            // 4. å°‡æ–°ç·¨è¼¯çš„æ¶ˆæ¯æ·»åŠ å›æ­·å²è¨˜éŒ„ï¼Œä¸¦è¨˜éŒ„å®ƒå€‘æ–°çš„æ™‚é–“æˆ³è¨˜
            let newTimestamps = [];
            let messageTimestamp = Date.now();
            
            for (const msgData of newMessagesArray) {
                 if (!msgData || typeof msgData !== 'object' || !msgData.type) {
                    console.warn("åœ¨å°æ¼”æ¨¡å¼ä¿å­˜æ™‚ï¼Œç™¼ç¾ç„¡æ•ˆçš„æŒ‡ä»¤ç‰©ä»¶ï¼Œå·²è·³é:", msgData);
                    continue;
                }
        
                let aiMessage = null;
                const baseMessage = { role: 'assistant', senderName: msgData.name || chat.originalName, timestamp: messageTimestamp++ };
        
                switch (msgData.type) {
                    case 'text':
                        aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                        break;
                    case 'sticker':
                        aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                        break;
                    case 'ai_image':
                        aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                        break;
                    case 'voice_message':
                        aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                        break;
                    case 'transfer':
                        aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                        break;
                    case 'waimai_request':
                        aiMessage = { 
                            ...baseMessage, type: 'waimai_request',
                            productInfo: msgData.productInfo, amount: msgData.amount,
                            status: 'pending', countdownEndTime: Date.now() + 15 * 60 * 1000,
                        };
                        break;
                    case 'offline_text':
                           aiMessage = { ...baseMessage, ...msgData };
                        break;
                    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    case 'gomoku_move': {
                        const gameState = gomokuState[chat.id];
                        if (gameState) {
                            // 1. æ‰¾åˆ°AIçš„ä¸Šä¸€æ­¥æ£‹
                            const lastAiMoveIndex = gameState.history.findLastIndex(move => move.player === 2);
                            
                            if (lastAiMoveIndex > -1) {
                                const move_to_undo = gameState.history[lastAiMoveIndex];
                                
                                // 2. å¾æ£‹ç›¤æ•¸æ“šä¸­â€œæ‹¿æ‰â€é€™é¡†æ£‹å­
                                gameState.board[move_to_undo.y][move_to_undo.x] = 0;
                                
                                // 3. å¾ä¸‹æ£‹æ­·å²ä¸­ç§»é™¤é€™ä¸€æ­¥
                                gameState.history.splice(lastAiMoveIndex, 1);
                                
                                console.log(`å°æ¼”æ¨¡å¼æ‚”æ£‹ï¼šå·²æ’¤éŠ·AIåœ¨ (${move_to_undo.x}, ${move_to_undo.y}) çš„æ£‹æ­¥ã€‚`);
                            }
                        }

                        // 4. åŸ·è¡Œæ–°çš„ä¸‹æ£‹æŒ‡ä»¤
                        const x = parseInt(msgData.x);
                        const y = parseInt(msgData.y);
                        if (!isNaN(x) && !isNaN(y)) {
                            handleAiGomokuMove({ x: x, y: y }, true);
                        } else {
                            console.warn("å°æ¼”æ¨¡å¼ä¿å­˜äº†ä¸€å€‹ç„¡æ•ˆçš„äº”å­æ£‹ç§»å‹•æŒ‡ä»¤:", msgData);
                        }
                        continue;
                    }
                    case 'update_thoughts': { 
    if (!chat.isGroup) {
        if (msgData.heartfelt_voice) {
            chat.heartfeltVoice = String(msgData.heartfelt_voice);
        }
        if (msgData.random_jottings) {
            chat.randomJottings = String(msgData.random_jottings);
        }
        if (!Array.isArray(chat.thoughtsHistory)) {
            chat.thoughtsHistory = [];
        }
        chat.thoughtsHistory.push({
            heartfeltVoice: chat.heartfeltVoice,
            randomJottings: chat.randomJottings,
            timestamp: Date.now()
        });
        if (chat.thoughtsHistory.length > 50) {
            chat.thoughtsHistory.shift();
        }

        // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ ---
        // 1. å°‡å‰›å‰›æ›´æ–°çš„å¿ƒè²å’Œæ•£è¨˜ï¼Œæ ¼å¼åŒ–ç‚ºä¸€æ®µAIèƒ½ç†è§£çš„æ–‡æœ¬ã€‚
        const thoughtForMemory = `[é€™æ˜¯ä½ ä¸Šä¸€è¼ªçš„å…§å¿ƒç¨ç™½å’Œæ€è€ƒ]
- å¿ƒè²: ${chat.heartfeltVoice}
- æ•£è¨˜: ${chat.randomJottings}`;
        
        // 2. å‰µå»ºä¸€æ¢å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯
        const hiddenThoughtMessage = {
            role: 'system',
            content: thoughtForMemory,
            timestamp: Date.now(),
            isHidden: true // é€™å€‹é—œéµæ¨™è¨˜ç¢ºä¿ä½¿ç”¨è€…çœ‹ä¸åˆ°é€™æ¢æŒ‡ä»¤ï¼Œä½†å®ƒå­˜åœ¨æ–¼æ­·å²è¨˜éŒ„ä¸­
        };

        // 3. å°‡é€™æ¢â€œè¨˜æ†¶ç¢ç‰‡â€ä¹Ÿå­˜å…¥èŠå¤©è¨˜éŒ„
        chat.history.push(hiddenThoughtMessage);
        // --- ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ ---
    }
    continue;
                    }
                    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
                    // åœ¨ switch èªå¥ä¸­ï¼Œæ·»åŠ ä¸€å€‹å°ˆé–€è™•ç† 'quote_reply' çš„ case
                    case 'quote_reply': {
                        // 1. æŸ¥æ‰¾è¢«å¼•ç”¨çš„åŸå§‹æ¶ˆæ¯
                        const originalQuotedMsg = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                        let quoteContext = null;

                        if (originalQuotedMsg) {
                            // 2. å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ§‹å»ºæ­£ç¢ºçš„ quote ç‰©ä»¶
                            let originalSenderName = originalQuotedMsg.senderName;
                            if (originalQuotedMsg.role === 'user') {
                                originalSenderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : (state.qzoneSettings.nickname || '{{user}}');
                            }
                            
                            quoteContext = {
                                timestamp: msgData.target_timestamp,
                                senderName: originalSenderName,
                                content: String(originalQuotedMsg.content || '')
                            };
                        } else {
                            // 3. å¦‚æœæ²’æ‰¾åˆ°ï¼Œå‰µå»ºä¸€å€‹å®‰å…¨çš„é ç•™ä½ç½®ï¼Œé˜²æ­¢ç¨‹å¼å‡ºéŒ¯
                            quoteContext = {
                                timestamp: msgData.target_timestamp,
                                senderName: 'æœªçŸ¥ç”¨æˆ¶',
                                content: 'åŸå§‹æ¶ˆæ¯å·²åˆªé™¤æˆ–ä¸å­˜åœ¨'
                            };
                        }
                        
                        // 4. æ§‹å»ºæœ€çµ‚çš„æ¶ˆæ¯ç‰©ä»¶ï¼ŒåŒ…å« quote å±¬æ€§
                        aiMessage = { 
                            ...baseMessage, 
                            content: msgData.reply_content,
                            quote: quoteContext
                        };
                        break; // çµæŸé€™å€‹ case
                    }
                    default:
                         console.warn("åœ¨å°æ¼”æ¨¡å¼ä¿å­˜æ™‚ï¼Œé‡åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤é¡å‹:", msgData.type);
                         break;
                }
        
                if (aiMessage) {
                    chat.history.push(aiMessage);
                    newTimestamps.push(aiMessage.timestamp);
                }
            }
        
            // 5. ä¿å­˜åˆ°è³‡æ–™åº«ä¸¦åˆ·æ–°æ•´å€‹èŠå¤©ä»‹é¢
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            renderChatList();
            document.getElementById('ai-response-editor-modal').classList.remove('visible');
            
            // 6. æ›´æ–°ç·©å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç·¨è¼¯
            lastRawAiResponse = editedRawBlocks.join('\n\n');
            lastResponseTimestamps = newTimestamps;
            
            // 7. çµ¦å‡ºæˆåŠŸæç¤º
            await showCustomAlert("å°æ¼”æ¨¡å¼", "æ‚¨çš„ä¿®æ”¹å·²ä¿å­˜ï¼");
        }
        /**
         * ã€å…¨æ–°ã€‘è™•ç†ä½¿ç”¨è€…é»æ“Šâ€œæ’¤å›â€æŒ‰éˆ•çš„å…¥å£å‡½æ•¸
         */
        async function handleRecallClick() {
            if (!activeMessageTimestamp) return;
        
            const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è¨­ç½®2åˆ†é˜çš„æ’¤å›æ™‚é™
            const messageTime = activeMessageTimestamp;
            const now = Date.now();
        
            // æª¢æŸ¥æ˜¯å¦è¶…éäº†æ’¤å›æ™‚é™
            if (now - messageTime > RECALL_TIME_LIMIT_MS) {
                hideMessageActions();
                await showCustomAlert('æ“ä½œå¤±æ•—', 'è©²æ¶ˆæ¯ç™¼é€å·²è¶…é2åˆ†é˜ï¼Œç„¡æ³•æ’¤å›ã€‚');
                return;
            }
            
            // å¦‚æœåœ¨æ™‚é™å…§ï¼ŒåŸ·è¡ŒçœŸæ­£çš„æ’¤å›é‚è¼¯
            await recallMessage(messageTime, true);
            hideMessageActions();
        }
        
/**
 * ã€V2.0 | AIæ„ŸçŸ¥ç‰ˆã€‘æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé‚è¼¯
 * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ¶ä¸»å‹•æ’¤å›
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? 'ä½ æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯' : 'å°æ–¹æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯';
    messageToRecall.recalledData = recalledData;
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼
    if (isUserRecall) {
        // 1. ç²å–ç”¨æˆ¶åœ¨ç•¶å‰èŠå¤©ä¸­çš„æ­£ç¢ºæ˜µç¨±
        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        
        // 2. å°‡è¢«æ’¤å›çš„å…§å®¹è½‰æ›ç‚ºAIèƒ½ç†è§£çš„æ–‡æœ¬
        let recalledContentText = '';
        if (recalledData.originalType === 'sticker') {
            recalledContentText = `[è¡¨æƒ…ï¼Œå«ç¾©: ${recalledData.originalMeaning || 'æœªçŸ¥'}]`;
        } else if (recalledData.originalType === 'ai_image' || recalledData.originalType === 'user_photo') {
            recalledContentText = `[åœ–ç‰‡ï¼Œæè¿°: ${recalledData.originalContent}]`;
        } else {
            recalledContentText = `â€œ${String(recalledData.originalContent)}â€`;
        }

        // 3. å‰µå»ºä¸€æ¢å°ç”¨æˆ¶éš±è—ã€ä½†å°AIå¯è¦‹çš„ç³»çµ±æ¶ˆæ¯
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ï¼ˆ${myNickname}ï¼‰å‰›å‰›æ’¤å›äº†ä¸€æ¢æ¶ˆæ¯ã€‚æ’¤å›å‰çš„å…§å®¹æ˜¯ï¼š${recalledContentText}ã€‚è«‹ä½ å°æ­¤ä½œå‡ºå›æ‡‰ï¼Œå¯ä»¥è¡¨ç¾å‡ºå¥½å¥‡ã€é–‹ç©ç¬‘ï¼ˆæ¯”å¦‚'æˆ‘æˆªåœ–äº†ï¼'ï¼‰ã€æˆ–è€…æ ¹æ“šä½ çš„äººè¨­è¡¨ç¤ºç†è§£æˆ–ç–‘æƒ‘ã€‚]`,
            timestamp: Date.now(),
            isHidden: true // é€™å€‹æ¨™è¨˜ç¢ºä¿ä½¿ç”¨è€…çœ‹ä¸åˆ°é€™æ¢æŒ‡ä»¤
        };
        chat.history.push(hiddenMessageForAI);
    }
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    if (isUserRecall) {
        renderChatList();
        // ã€é‡è¦ã€‘åœ¨ç”¨æˆ¶æ’¤å›å¾Œï¼Œç«‹åˆ»è§¸ç™¼AIï¼Œè®“å®ƒå°é€™å€‹äº‹ä»¶åšå‡ºåæ‡‰ï¼
        triggerAiResponse();
    }
}
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°‡é€™äº›å‡½æ•¸é»è²¼åˆ°ä½ çš„JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        
        /**
         * æ‰“é–‹åˆ†é¡ç®¡ç†æ¨¡æ…‹æ¡†
         */
        async function openCategoryManager() {
            await renderCategoryListInManager();
            document.getElementById('world-book-category-manager-modal').classList.add('visible');
        }
        
        /**
         * åœ¨æ¨¡æ…‹æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†é¡åˆ—è¡¨
         */
        async function renderCategoryListInManager() {
            const listEl = document.getElementById('existing-categories-list');
            const categories = await db.worldBookCategories.toArray();
            listEl.innerHTML = '';
            if (categories.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†é¡</p>';
            }
            categories.forEach(cat => {
                // è¤‡ç”¨å¥½å‹åˆ†çµ„çš„æ¨£å¼
                const item = document.createElement('div');
                item.className = 'existing-group-item'; 
                item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * æ·»åŠ ä¸€å€‹æ–°çš„ä¸–ç•Œæ›¸åˆ†é¡
         */
        async function addNewCategory() {
            const input = document.getElementById('new-category-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('åˆ†é¡åä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            const existing = await db.worldBookCategories.where('name').equals(name).first();
            if (existing) {
                alert(`åˆ†é¡ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼`);
                return;
            }
            await db.worldBookCategories.add({ name });
            input.value = '';
            await renderCategoryListInManager();
        }
        
        /**
         * åˆªé™¤ä¸€å€‹ä¸–ç•Œæ›¸åˆ†é¡
         * @param {number} categoryId - è¦åˆªé™¤çš„åˆ†é¡çš„ID
         */
        async function deleteCategory(categoryId) {
            const confirmed = await showCustomConfirm(
                'ç¢ºèªåˆªé™¤', 
                'åˆªé™¤åˆ†é¡å¾Œï¼Œè©²åˆ†é¡ä¸‹çš„æ‰€æœ‰ä¸–ç•Œæ›¸å°‡è®Šç‚ºâ€œæœªåˆ†é¡â€ã€‚ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', 
                { confirmButtonClass: 'btn-danger' }
            );
            if (confirmed) {
                await db.worldBookCategories.delete(categoryId);
                // å°‡å±¬æ–¼è©²åˆ†é¡çš„ä¸–ç•Œæ›¸çš„ categoryId è¨­ç‚º null
                const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
                for (const book of booksToUpdate) {
                    book.categoryId = null;
                    await db.worldBooks.put(book);
                    const bookInState = state.worldBooks.find(wb => wb.id === book.id);
                    if(bookInState) bookInState.categoryId = null;
                }
                await renderCategoryListInManager();
            }
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ç‰ˆæœ¬ã€‘ç™¼ä½ˆå…¬å‘Šå‡½æ•¸ (ç„¡è©•è«–) â–¼â–¼â–¼
        async function publishToAnnouncementBoard() {
            if (!activeMessageTimestamp) return;
        
            const timestampToPublish = activeMessageTimestamp;
            hideMessageActions(); 
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToPublish);
            if (!message) return;
        
            // æå–æ¶ˆæ¯å…§å®¹ç”¨æ–¼é è¦½
            let contentPreview = String(message.content || '').substring(0, 50) + '...';
            if (message.type === 'ai_image') contentPreview = '[åœ–ç‰‡] ' + contentPreview;
        
            const confirmed = await showCustomConfirm(
                "ç™¼ä½ˆå…¬å‘Š",
                `ç¢ºå®šè¦å°‡ä»¥ä¸‹æ¶ˆæ¯ç™¼ä½ˆåˆ°å…¬å‘Šæ¿å—ï¼Ÿ\n\nâ€œ${contentPreview}â€`,
                { confirmText: "ç¢ºå®šç™¼ä½ˆ" }
            );
        
            if (confirmed) {
                const myNickname = chat.settings.myNickname || 'æˆ‘';
        
                if (!Array.isArray(chat.announcements)) {
                    chat.announcements = [];
                }
        
                // æ–°å¢çš„å…¬å‘Šå°è±¡
                const newAnnouncement = {
                    id: 'anno_' + Date.now(), // ç‚ºæ¯å€‹å…¬å‘Šæ·»åŠ å”¯ä¸€ID
                    messageTimestamp: timestampToPublish,
                    publisher: myNickname,
                    publishedAt: Date.now(),
                    isPinned: false // é»˜èªç‚ºä¸ç½®é ‚
                };
        
                chat.announcements.push(newAnnouncement);
        
                const systemMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${myNickname} ç™¼ä½ˆäº†ä¸€æ¢æ–°å…¬å‘Š`,
                    timestamp: Date.now()
                };
                chat.history.push(systemMessage);
        
                await db.chats.put(chat);
                appendMessage(systemMessage, chat);
                renderChatList();
        
                await showCustomAlert("æˆåŠŸ", "å…¬å‘Šå·²ç™¼ä½ˆï¼");
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        /**
         * é¡¯ç¤ºç¾¤å…¬å‘Šæ¿å½ˆçª—
         */
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ showAnnouncementBoard å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€V2.0 | å·²ä¿®å¾©éåŒæ­¥æ¸²æŸ“BUGã€‘é¡¯ç¤ºç¾¤å…¬å‘Šæ¿å½ˆçª—
         */
        async function showAnnouncementBoard() { // <--- æ ¸å¿ƒä¿®å¾©1ï¼šå°‡å‡½å¼å®£å‘Šç‚º async
            const chat = state.chats[state.activeChatId];
            const announcements = chat.announcements || [];

            if (!chat || announcements.length === 0) {
                showCustomAlert("æç¤º", "ç•¶å‰ç¾¤èŠé‚„æ²’æœ‰å…¬å‘Šå“¦ã€‚");
                return;
            }

            const contentEl = document.getElementById('announcement-board-content');
            contentEl.innerHTML = '';

            // å°‡ç½®é ‚çš„å…¬å‘Šæ’åœ¨æœ€å‰é¢
            announcements.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

            // ã€æ ¸å¿ƒä¿®å¾©2ã€‘ä½¿ç”¨ for...of è¿´åœˆï¼Œä»¥ä¾¿åœ¨è¿´åœˆå…§éƒ¨å®‰å…¨åœ°ä½¿ç”¨ await
            for (const anno of announcements) {
                const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);

                const wrapper = document.createElement('div');
                wrapper.className = 'announcement-item-wrapper';

                if (originalMessage) {
                    // ã€æ ¸å¿ƒä¿®å¾©3ã€‘åœ¨é€™è£¡ä½¿ç”¨ awaitï¼Œç­‰å¾… createMessageElement å‡½æ•¸çœŸæ­£å®Œæˆä¸¦è¿”å›HTMLå…ƒç´ 
                    const messageBubbleEl = await createMessageElement(originalMessage, chat);
                    if (messageBubbleEl) { // å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿å…ƒç´ å·²æˆåŠŸå‰µå»º
                        wrapper.appendChild(messageBubbleEl);
                    }
                } else {
                    wrapper.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">å…¬å‘Šçš„åŸæ¶ˆæ¯å·²è¢«åˆªé™¤ã€‚</p>';
                }

                if (anno.isPinned) {
                    wrapper.innerHTML += `<div class="pinned-indicator">ğŸ“Œ</div>`;
                }
                wrapper.innerHTML += `<div class="announcement-item-actions" data-anno-id="${anno.id}">...</div>`;

                contentEl.appendChild(wrapper);
            }

            document.getElementById('announcement-board-modal').classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç¢¼ï¼Œè«‹é»è²¼åœ¨é€™è£¡ã€‘ â–¼â–¼â–¼
        let activeAnnouncementId = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨æ“ä½œçš„å…¬å‘ŠID
        
        /**
         * é»æ“Šâ€œ...â€æ™‚ï¼Œé¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨ï¼ˆç½®é ‚/åˆªé™¤ï¼‰
         * @param {string} annoId - å…¬å‘Šçš„å”¯ä¸€ID
         */
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            // æ ¹æ“šç•¶å‰æ˜¯å¦å·²ç½®é ‚ï¼Œå‹•æ…‹æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
            pinButton.textContent = announcement.isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚å…¬å‘Š';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        /**
         * è™•ç†â€œç½®é ‚/å–æ¶ˆç½®é ‚â€æ“ä½œ
         */
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // åˆ‡æ›ç½®é ‚ç‹€æ…‹
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“å…¬å‘Šæ¿ä»¥æ›´æ–°UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        /**
         * è™•ç†â€œåˆªé™¤å…¬å‘Šâ€æ“ä½œ
         */
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
            
            const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", "ç¢ºå®šè¦åˆªé™¤é€™æ¢å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚", { confirmButtonClass: 'btn-danger' });
            
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                // å¾å…¬å‘Šé™£åˆ—ä¸­éæ¿¾æ‰è¦åˆªé™¤çš„å…¬å‘Š
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

        
        // â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç¢¼ï¼Œè«‹é»è²¼åœ¨é€™è£¡ã€‘ â–¼â–¼â–¼
        let editingFrameForMember = false;
        let currentFrameSelection = { ai: null, my: null };
        
        function openFrameSelectorModal(type = 'chat') {
            const frameModal = document.getElementById('avatar-frame-modal');
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
        
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }
        
        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const aiFrameGrid = document.getElementById('ai-frame-grid');
            const myFrameGrid = document.getElementById('my-frame-grid');
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';
        
            document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
            document.getElementById('ai-frame-content').style.display = 'block';
            document.getElementById('my-frame-content').style.display = 'none';
            document.getElementById('ai-frame-tab').classList.add('active');
            document.getElementById('my-frame-tab').classList.remove('active');
        
            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }
        
        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }
        
        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
        // ... (å‡½æ•¸å‰é¢çš„ä»£ç¢¼) ...
            await db.chats.put(chat);
        
            // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¿®å¾©ä»£ç¢¼ â–¼â–¼â–¼
            // æ ¸å¿ƒä¿®å¾©ï¼šç•¶æ›´æ–°å–®èŠè§’è‰²çš„é ­åƒæ¡†æ™‚ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰åŒ…å«è©²è§’è‰²çš„ç¾¤èŠä¸­
            if (!editingFrameForMember && !chat.isGroup) {
                const characterId = chat.id; // ç²å–è¢«ä¿®æ”¹çš„è§’è‰²çš„ID
        
                // éæ­·æ‰€æœ‰èŠå¤©ï¼Œæ‰¾å‡ºåŒ…å«é€™å€‹è§’è‰²çš„ç¾¤èŠ
                for (const groupChat of Object.values(state.chats)) {
                    if (groupChat.isGroup && groupChat.members) {
                        // åœ¨ç¾¤èŠä¸­æ‰¾åˆ°å°æ‡‰çš„æˆå“¡å°è±¡
                        const memberToUpdate = groupChat.members.find(m => m.id === characterId);
        
                        // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ›´æ–°ä»–çš„é ­åƒæ¡†è³‡è¨Š
                        if (memberToUpdate) {
                            memberToUpdate.avatarFrame = chat.settings.aiAvatarFrame;
                            // ã€è‡³é—œé‡è¦ã€‘å°‡ä¿®æ”¹å¾Œçš„ã€æ•´å€‹ç¾¤èŠç‰©ä»¶ã€‘å­˜å›è³‡æ–™åº«
                            await db.chats.put(groupChat);
                            console.log(`å·²åŒæ­¥è§’è‰² ${characterId} çš„é ­åƒæ¡†åˆ°ç¾¤èŠ "${groupChat.name}"`);
                        }
                    }
                }
            }
            // â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
            document.getElementById('avatar-frame-modal').classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('é ­åƒæ¡†å·²ä¿å­˜ä¸¦åŒæ­¥ï¼'); // ä¿®æ”¹äº†æç¤ºï¼Œè®“æ‚¨çŸ¥é“åŒæ­¥ä¹Ÿå®Œæˆäº†
            editingFrameForMember = false;
        }
        
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é ­åƒæ¡†æ‰¹é‡åˆªé™¤åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * åˆ‡æ›é ­åƒæ¡†é¢æ¿çš„ç®¡ç†æ¨¡å¼
 */
function toggleFrameManagementMode() {
    isFrameManagementMode = !isFrameManagementMode;
    const manageBtn = document.getElementById('manage-frames-btn');
    const actionBar = document.getElementById('frame-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-frames-checkbox');

    // ç‚ºå…©å€‹ç¶²æ ¼åŒæ™‚æ·»åŠ /ç§»é™¤ç®¡ç†æ¨¡å¼çš„class
    document.querySelectorAll('.frame-grid').forEach(grid => {
        grid.classList.toggle('management-mode', isFrameManagementMode);
    });
    
    if (isFrameManagementMode) {
        manageBtn.textContent = 'å®Œæˆ';
        actionBar.style.display = 'flex';
        selectedFrames.clear();
        selectAllCheckbox.checked = false;
        updateDeleteFrameButton();
    } else {
        manageBtn.textContent = 'ç®¡ç†';
        actionBar.style.display = 'none';
        // é€€å‡ºæ™‚å–æ¶ˆæ‰€æœ‰é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('.frame-item.selected').forEach(item => {
            item.classList.remove('selected');
        });
    }
}

/**
 * æ›´æ–°â€œåˆªé™¤â€æŒ‰éˆ•ä¸Šçš„è¨ˆæ•¸
 */
function updateDeleteFrameButton() {
    const btn = document.getElementById('delete-selected-frames-btn');
    btn.textContent = `åˆªé™¤ (${selectedFrames.size})`;
}

/**
 * è™•ç†â€œå…¨é¸â€æ ¸å–æ–¹å¡Šçš„é»æ“Šäº‹ä»¶
 */
function handleSelectAllFrames() {
    const isChecked = document.getElementById('select-all-frames-checkbox').checked;
    const visibleGrid = document.querySelector('.frame-content[style*="display: block"] .frame-grid');
    if (!visibleGrid) return;

    // åªé¸æ“‡ç•¶å‰å¯è¦‹çš„ã€ä¸”æ˜¯è‡ªè¨‚çš„ï¼ˆå¸¶æœ‰åˆªé™¤æŒ‰éˆ•ï¼‰é ­åƒæ¡†
    visibleGrid.querySelectorAll('.frame-item:has(.delete-btn)').forEach(item => {
        const frameId = parseInt(item.querySelector('.delete-btn').dataset.id);
        if (isNaN(frameId)) return;
        
        item.classList.toggle('selected', isChecked);
        if (isChecked) {
            selectedFrames.add(frameId);
        } else {
            selectedFrames.delete(frameId);
        }
    });
    updateDeleteFrameButton();
}

/**
 * åŸ·è¡Œæ‰¹é‡åˆªé™¤æ“ä½œ
 */
async function executeBatchDeleteFrames() {
    if (selectedFrames.size === 0) return;
    
    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        `ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é¸ä¸­çš„ ${selectedFrames.size} å€‹è‡ªè¨‚é ­åƒæ¡†å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFrames];
        await db.customAvatarFrames.bulkDelete(idsToDelete);
        
        // é€€å‡ºç®¡ç†æ¨¡å¼ä¸¦åˆ·æ–°
        toggleFrameManagementMode();
        populateFrameGrids(editingFrameForMember); 
        
        await showCustomAlert('åˆªé™¤æˆåŠŸ', 'é¸ä¸­çš„é ­åƒæ¡†å·²æˆåŠŸåˆªé™¤ã€‚');
    }
}

// â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²        
        // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°å‡½æ•¸ â–¼â–¼â–¼
        /**
         * å°‡ä½¿ç”¨è€…è‡ªè¨‚çš„å…¨åŸŸCSSæ‡‰ç”¨åˆ°é é¢
         * @param {string} cssString ç”¨æˆ¶è¼¸å…¥çš„CSSä»£ç¢¼
         */
        function applyGlobalCss(cssString) {
            const styleTag = document.getElementById('global-custom-style');
            if (styleTag) {
                // å¦‚æœæœ‰ä»£ç¢¼å°±æ‡‰ç”¨ï¼Œæ²’æœ‰å°±æ¸…ç©º
                styleTag.innerHTML = cssString || '';
            }
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
        /**
         * å‘ç•¶å‰èŠå¤©çš„æ­·å²è¨˜éŒ„ä¸­æ·»åŠ ä¸€æ¢é—œæ–¼éŸ³æ¨‚æ“ä½œçš„ã€å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æ¶ˆæ¯
         * @param {string} actionText - æè¿°ä½¿ç”¨è€…æ“ä½œçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ "æš«åœäº†éŸ³æ¨‚"
         */
        async function addMusicActionSystemMessage(actionText) {
            // 1. æª¢æŸ¥éŸ³æ¨‚åŠŸèƒ½æ˜¯å¦å•Ÿå‹•ï¼Œä»¥åŠæ˜¯å¦åœ¨æŸå€‹èŠå¤©ä¸­
            if (!musicState.isActive || !musicState.activeChatId) return;
            const chat = state.chats[musicState.activeChatId];
            if (!chat) return;
        
            // 2. ç²å–ç”¨æˆ¶åœ¨ç•¶å‰èŠå¤©ä¸­çš„æ˜µç¨±
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            const fullMessage = `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${myNickname}) ${actionText}]`;
        
            // 3. å‰µå»ºé€™æ¢ç‰¹æ®Šçš„ã€éš±è—çš„ç³»çµ±æ¶ˆæ¯
            const systemMessage = {
                role: 'system',
                content: fullMessage,
                timestamp: Date.now(),
                isHidden: true // é€™å€‹æ¨™è¨˜è®“æ¶ˆæ¯å°ä½¿ç”¨è€…ä¸å¯è¦‹ï¼Œä½†AIèƒ½è®€åˆ°
            };
        
            // 4. å°‡æ¶ˆæ¯å­˜å…¥æ­·å²è¨˜éŒ„ä¸¦æ›´æ–°è³‡æ–™åº«
            chat.history.push(systemMessage);
            await db.chats.put(chat);
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆæœ¬ã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleLongScreenshot â–¼â–¼â–¼
        
        /**
         * ã€V3.0 | ä½ˆå±€ä¿®å¾©ç‰ˆã€‘è™•ç†é•·æˆªåœ–åŠŸèƒ½
         */
        async function handleLongScreenshot() {
            if (selectedMessages.size === 0) return;
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 0. é¡¯ç¤ºâ€œç”Ÿæˆä¸­â€ç‹€æ…‹
            const screenshotBtn = document.getElementById('selection-screenshot-btn');
            const originalBtnText = screenshotBtn.textContent;
            screenshotBtn.textContent = 'ç”Ÿæˆä¸­...';
            screenshotBtn.disabled = true;
        
            // 1. å‰µå»ºè‡¨æ™‚çš„æˆªåœ–å®¹å™¨å’Œæ¨£å¼ï¼ˆé€™éƒ¨åˆ†ä¸è®Šï¼‰
            const screenshotContainer = document.createElement('div');
            const phoneScreen = document.getElementById('phone-screen');
            screenshotContainer.style.width = phoneScreen.offsetWidth + 'px';
            screenshotContainer.style.position = 'absolute';
            screenshotContainer.style.top = '-9999px';
            screenshotContainer.style.left = '-9999px';
            screenshotContainer.style.display = 'flex';
            screenshotContainer.style.flexDirection = 'column';
            screenshotContainer.style.height = 'auto';
            
            const chatScreen = document.getElementById('chat-interface-screen');
            screenshotContainer.style.backgroundImage = chatScreen.style.backgroundImage;
            screenshotContainer.style.backgroundColor = chatScreen.style.backgroundColor || (document.getElementById('phone-screen').classList.contains('dark-mode') ? '#000000' : '#f0f2f5');
        
            const tempStyle = document.createElement('style');
            tempStyle.innerHTML = `
                .message-bubble.selected::after { display: none !important; }
                .cloned-header .default-controls { display: flex !important; justify-content: space-between; align-items: center; width: 100%; }
                .cloned-header .selection-controls { display: none !important; }
            `;
            document.head.appendChild(tempStyle);
        
            try {
                // 2. çµ„è£æˆªåœ–å…ƒç´ ï¼ˆé ­éƒ¨å’Œè¼¸å…¥æ¡†éƒ¨åˆ†ä¸è®Šï¼‰
                const header = chatScreen.querySelector('.header').cloneNode(true);
                header.classList.add('cloned-header');
                
                // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
                // æˆ‘å€‘ä¸å†ä½¿ç”¨ getComputedStyleï¼Œè€Œæ˜¯å‰µå»ºä¸€å€‹ä¹¾æ·¨çš„å®¹å™¨ä¸¦æ‰‹å‹•æ‡‰ç”¨é—œéµæ¨£å¼ã€‚
                const messagesContainer = document.createElement('div');
                const originalMessagesContainer = document.getElementById('chat-messages');
        
                // æ‰‹å‹•è¨­ç½®æœ€é—œéµçš„ä½ˆå±€æ¨£å¼ï¼Œç¢ºä¿æ¶ˆæ¯èƒ½æ­£ç¢ºæ’åˆ—
                messagesContainer.style.display = 'flex';
                messagesContainer.style.flexDirection = 'column';
                messagesContainer.style.gap = '20px'; // é€™æ˜¯æ¶ˆæ¯ä¹‹é–“çš„å‚ç›´é–“è·
                messagesContainer.style.padding = '10px 15px 20px 15px'; // ä¸Šã€å·¦å³ã€ä¸‹å…§é‚Šè·ï¼Œåº•éƒ¨å¤šç•™ä¸€é»
                messagesContainer.style.width = '100%';
                messagesContainer.style.boxSizing = 'border-box';
        
                // ç¹¼æ‰¿ä¸»é¡Œå’Œå­—é«”å¤§å°ï¼Œé€™å°æ–¼æ°£æ³¡é¡è‰²å’Œæ–‡å­—å¤§å°è‡³é—œé‡è¦
                messagesContainer.dataset.theme = originalMessagesContainer.dataset.theme;
                messagesContainer.style.setProperty('--chat-font-size', originalMessagesContainer.style.getPropertyValue('--chat-font-size'));
                // â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜…
        
                const inputArea = chatScreen.querySelector('#chat-input-area').cloneNode(true);
        
                const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
                sortedTimestamps.forEach(timestamp => {
                    // æ³¨æ„ï¼šæˆ‘å€‘é€™è£¡ä¾ç„¶éœ€è¦å¾åŸå§‹DOMä¸­å…‹éš†ï¼Œå› ç‚ºå®ƒå€‘å·²ç¶“æ‡‰ç”¨äº†æ‰€æœ‰è¤‡é›œçš„CSS
                    const originalBubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
                    if (originalBubble) {
                        const originalWrapper = originalBubble.closest('.message-wrapper');
                        if (originalWrapper) {
                            messagesContainer.appendChild(originalWrapper.cloneNode(true));
                        }
                    }
                });
        
                screenshotContainer.appendChild(header);
                screenshotContainer.appendChild(messagesContainer);
                screenshotContainer.appendChild(inputArea);
                document.body.appendChild(screenshotContainer);
                
                // åœ–ç‰‡é è¼‰å…¥é‚è¼¯ï¼ˆä¿æŒä¸è®Šï¼‰
                const images = Array.from(screenshotContainer.getElementsByTagName('img'));
                const imageLoadPromises = images.map(img => new Promise((resolve, reject) => {
                    if (img.src.startsWith('data:')) {
                        resolve();
                        return;
                    }
                    const newImg = new Image();
                    newImg.crossOrigin = 'anonymous';
                    newImg.onload = resolve;
                    newImg.onerror = resolve; 
                    newImg.src = img.src;
                }));
                
                await Promise.all(imageLoadPromises);
        
                // 3. èª¿ç”¨ html2canvasï¼ˆä¿æŒä¸è®Šï¼‰
                const canvas = await html2canvas(screenshotContainer, {
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: null,
                    scale: window.devicePixelRatio || 2,
                });
        
                // 4. ä½¿ç”¨ Blob ç‰©ä»¶ä¸‹è¼‰ï¼ˆä¿æŒä¸è®Šï¼‰
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `EPhone-é•·æˆªåœ–-${chat.name}-${Date.now()}.png`;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
        
            } catch (error) {
                console.error('é•·æˆªåœ–ç”Ÿæˆå¤±æ•—:', error);
                await showCustomAlert('ç”Ÿæˆå¤±æ•—', 'ç”Ÿæˆæˆªåœ–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ç²å–è©³æƒ…ã€‚');
            } finally {
                // 5. æ¸…ç†å·¥ä½œï¼ˆä¿æŒä¸è®Šï¼‰
                document.body.removeChild(screenshotContainer);
                document.head.removeChild(tempStyle);
                screenshotBtn.textContent = originalBtnText;
                screenshotBtn.disabled = false;
                exitSelectionMode(); 
            }
        }
        // â–²â–²â–² å…¨æ–°JSå‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        /**
         * ã€V2.1 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ä¸€å€‹ç°¡å–®çš„ Markdown è§£æå™¨
         * @param {string} text - åŒ…å« Markdown èªæ³•çš„åŸå§‹æ–‡æœ¬
         * @returns {string} - è½‰æ›æˆ HTML å¾Œçš„æ–‡æœ¬
         */
        function parseMarkdown(text) {
            if (!text || typeof text !== 'string') return '';

            // é †åºå¾ˆé‡è¦ï¼šå…ˆè™•ç†æˆ‘å€‘è‡ªè¨‚çš„è¤‡é›œè¦å‰‡
            text = text.replace(/!h\{(.*?)\}/g, '<span class="diary-highlight">$1</span>');
            text = text.replace(/!u\{(.*?)\}/g, '<span class="diary-underline">$1</span>');
            text = text.replace(/!e\{(.*?)\}/g, '<span class="diary-emphasis">$1</span>');
            text = text.replace(/!w\{(.*?)\}/g, '<span class="diary-handwritten">$1</span>');
            text = text.replace(/!m\{(.*?)\}/g, '<span class="diary-messy">$1</span>');
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼
            // å°‡åŸä¾†çš„ !c{...} è¦å‰‡ï¼Œæ›¿æ›ç‚ºæ‚¨æƒ³è¦çš„ ||...|| è¦å‰‡
            text = text.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

            // å†è™•ç†æ¨™æº–Markdown
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\~\~(.*?)\~\~/g, '<s>$1</s>'); 
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            return text;
        }


        // â–¼â–¼â–¼ ã€å…¨æ–° | è³‡æ–™ä¿®å¾©å‡½æ•¸ã€‘è«‹å°‡é€™å€‹å‡½æ•¸é»è²¼åˆ°æ‚¨çš„JSåŠŸèƒ½å€ â–¼â–¼â–¼
        /**
         * è‡ªå‹•é·ç§»èˆŠçš„ã€æ ¼å¼ä¸æ­£ç¢ºçš„ç´…åŒ…è³‡æ–™ï¼Œå°‡ 'receiver' æ¬„ä½é‡å‘½åç‚º 'receiverName'
         */
        async function migrateOldRedPacketData() {
            console.log("é–‹å§‹æª¢æŸ¥ä¸¦é·ç§»èˆŠçš„ç´…åŒ…è³‡æ–™...");
            let migrationCount = 0;
            // ç›´æ¥å¾è¨˜æ†¶é«”ä¸­çš„ state.chats æ“ä½œï¼Œæ•ˆç‡æ›´é«˜
            const allChats = Object.values(state.chats);
        
            for (const chat of allChats) {
                let needsDbUpdate = false;
                for (const msg of chat.history) {
                    // æ‰¾å‡ºæ‰€æœ‰ç”±AIç™¼é€çš„ã€å¸¶æœ‰èˆŠ 'receiver' æ¬„ä½çš„å°ˆå±¬ç´…åŒ…
                    if (msg.type === 'red_packet' && msg.packetType === 'direct' && msg.role === 'assistant' && msg.hasOwnProperty('receiver') && !msg.hasOwnProperty('receiverName')) {
                        // é€²è¡Œâ€œæ‰‹è¡“â€ï¼šé‡å‘½åéŒ¯èª¤çš„æ¬„ä½
                        msg.receiverName = msg.receiver;
                        delete msg.receiver;
                        
                        needsDbUpdate = true; // æ¨™è¨˜é€™å€‹èŠå¤©éœ€è¦è¢«é‡æ–°ä¿å­˜
                        migrationCount++;
                    }
                }
                // å¦‚æœé€™å€‹èŠå¤©ä¸­æœ‰è³‡æ–™è¢«ä¿®å¾©äº†ï¼Œå°±å°‡æ•´å€‹æ›´æ–°å¾Œçš„èŠå¤©ç‰©ä»¶ä¿å­˜å›è³‡æ–™åº«
                if (needsDbUpdate) {
                    console.log(`åœ¨èŠå¤© "${chat.name}" ä¸­ç™¼ç¾ä¸¦ä¿®å¾©äº†èˆŠç´…åŒ…è³‡æ–™ã€‚`);
                    await db.chats.put(chat);
                }
            }
        
            if (migrationCount > 0) {
                console.log(`è³‡æ–™ç§»è½‰å®Œæˆï¼ç¸½å…±ä¿®å¾©äº† ${migrationCount} æ¢ç´…åŒ…è¨˜éŒ„ã€‚`);
                alert(`æª¢æ¸¬åˆ°ä¸¦æˆåŠŸä¿®å¾©äº† ${migrationCount} æ¢èˆŠçš„ç´…åŒ…æ¶ˆæ¯ï¼é é¢å°‡è‡ªå‹•åˆ·æ–°ä»¥æ‡‰ç”¨æ›´æ”¹ã€‚`);
                location.reload(); // å¼·åˆ¶åˆ·æ–°é é¢ï¼Œç¢ºä¿æ‰€æœ‰é¡¯ç¤ºéƒ½ä½¿ç”¨æœ€æ–°çš„æ­£ç¢ºè³‡æ–™
            } else {
                console.log("æœªç™¼ç¾éœ€è¦é·ç§»çš„èˆŠç´…åŒ…è³‡æ–™ã€‚");
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²

        function showCharacterProfileModal(chatId) {
            const chat = state.chats[chatId];
            if (!chat || chat.isGroup) return;
        
            // å¡«å……æ•¸æ“š
            //document.getElementById('profile-avatar').src = chat.settings.aiAvatar || defaultAvatar;
           // document.getElementById('profile-name').textContent = chat.name;
           // document.getElementById('profile-id').textContent = `ID: ${chat.originalName}`;
            document.getElementById('profile-heartfelt-voice').textContent = chat.heartfeltVoice || '...';
            document.getElementById('profile-random-jottings').textContent = chat.randomJottings || '...';

            const modal = document.getElementById('character-profile-modal');
        
            // ã€æ ¸å¿ƒä¿®å¾©ã€‘ç”±æ–¼æˆ‘å€‘å·²ç¶“å¾HTMLä¸­ç§»é™¤äº†â€œé€²å…¥èŠå¤©â€æŒ‰éˆ•ï¼Œ
            // é€™è£¡ä¸å†éœ€è¦ç‚ºå®ƒç¶å®šäº‹ä»¶ï¼ŒèˆŠçš„ã€å°è‡´éŒ¯èª¤çš„JavaScriptä»£ç¢¼å·²è¢«å¾¹åº•åˆªé™¤ã€‚
            
            // ç›´æ¥é¡¯ç¤ºå½ˆçª—
            modal.classList.add('visible');
        }
        /**
         * ã€å…¨æ–°ã€‘é¡¯ç¤ºå¿ƒè²æ­·å²è¨˜éŒ„è¦–åœ–
         */
        function showThoughtsHistory() {
            document.getElementById('profile-main-content').style.display = 'none';
            document.getElementById('profile-thoughts-history-view').style.display = 'flex';
            renderThoughtsHistory();
        }
        
        /**
         * ã€å…¨æ–° | å·²ä¿®å¾©BUGã€‘éš±è—å¿ƒè²æ­·å²è¨˜éŒ„è¦–åœ–ï¼Œè¿”å›ä¸»è³‡æ–™é 
         */
function hideThoughtsHistory() {
    document.getElementById('profile-thoughts-history-view').style.display = 'none';
    
    // ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡ 'block' æ”¹ç‚º 'flex'ï¼Œæ¢å¾©å…¶æ­£ç¢ºçš„å½ˆæ€§ä½ˆå±€
    document.getElementById('profile-main-content').style.display = 'flex'; 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * ã€å…¨æ–° | åˆ†é è¼‰å…¥ç‰ˆã€‘æ¸²æŸ“å¿ƒè²æ­·å²è¨˜éŒ„æ¸…å–®
         */
        function renderThoughtsHistory() {
            const listEl = document.getElementById('thoughts-history-list');
            const chat = state.chats[state.activeChatId];
            listEl.innerHTML = '';
            
            if (!chat || !chat.thoughtsHistory || chat.thoughtsHistory.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 30px 0;">é€™è£¡é‚„æ²’æœ‰æ­·å²è¨˜éŒ„å“¦ã€‚</p>';
                return;
            }
        
            const history = [...chat.thoughtsHistory].reverse(); // å¾æ–°åˆ°èˆŠ
            const initialItems = history.slice(0, THOUGHTS_RENDER_WINDOW);
            
            initialItems.forEach(thought => {
                const card = createThoughtCard(thought);
                listEl.appendChild(card);
            });
        
            thoughtsHistoryRenderCount = initialItems.length;
        
// å¦‚æœé‚„æœ‰æ›´å¤šè¨˜éŒ„ï¼Œå‰‡æ·»åŠ â€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ•
if (history.length > thoughtsHistoryRenderCount) {
    appendLoadMoreThoughtsButton(listEl); // æ ¸å¿ƒä¿®æ”¹ï¼šèª¿ç”¨æ–°çš„å‡½æ•¸
}
        }

        
// â–¼â–¼â–¼ ã€ç„¡é™æ»¾å‹•ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ loadMoreThoughts å‡½æ•¸ â–¼â–¼â–¼
async function loadMoreThoughts() {
    if (isLoadingMoreThoughts) return;
    isLoadingMoreThoughts = true;

    const listEl = document.getElementById('thoughts-history-list');
    const chat = state.chats[state.activeChatId];
    if (!chat) { 
        isLoadingMoreThoughts = false; 
        return; 
    }

    showLoader(listEl, 'bottom'); // åœ¨åº•éƒ¨é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    await new Promise(resolve => setTimeout(resolve, 500)); // é¡æ¯”ç¶²è·¯å»¶é²

    const history = [...chat.thoughtsHistory].reverse();
    const totalItems = history.length;

    const nextSliceStart = thoughtsHistoryRenderCount;
    const nextSliceEnd = thoughtsHistoryRenderCount + THOUGHTS_RENDER_WINDOW;
    const itemsToAppend = history.slice(nextSliceStart, nextSliceEnd);

    // åœ¨è¿½åŠ æ–°å…§å®¹å‰ï¼Œå…ˆç§»é™¤è¼‰å…¥å‹•ç•«
    hideLoader(listEl);

    itemsToAppend.forEach(thought => {
        const card = createThoughtCard(thought);
        listEl.appendChild(card);
    });

    thoughtsHistoryRenderCount += itemsToAppend.length;

    isLoadingMoreThoughts = false;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šç”¨é€™å€‹ã€å…¨æ–°çš„å‡½æ•¸ã€‘ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ createThoughtCard å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘æ ¹æ“šå–®æ¢è¨˜éŒ„è³‡æ–™ï¼Œå‰µå»ºä¸€å¼µå¿ƒè²æ­·å²å¡ç‰‡
 * @param {object} thought - ä¸€æ¢å¿ƒè²æ­·å²è¨˜éŒ„ç‰©ä»¶
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„å¡ç‰‡div
 */
function createThoughtCard(thought) {
    const card = document.createElement('div');
    card.className = 'thought-card';
    const date = new Date(thought.timestamp);
    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡æ·»åŠ äº†ä¸€å€‹åˆªé™¤æŒ‰éˆ•çš„HTML
    card.innerHTML = `
        <button class="thought-delete-btn" data-timestamp="${thought.timestamp}" title="åˆªé™¤æ­¤æ¢è¨˜éŒ„">Ã—</button>
        <div class="thought-header">${dateString}</div>
        <div class="thought-content">
            <div class="voice">
                <div class="label">
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    å¿ƒè²
                </div>
                <p class="text">${thought.heartfeltVoice}</p>
            </div>
            <div class="jottings">
                <div class="label">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                    æ•£è¨˜
                </div>
                <p class="text">${thought.randomJottings}</p>
            </div>
        </div>
    `;
    return card;
} 
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å°å…¥è§’è‰²å¡çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œè«‹å°‡å®ƒå€‘å®Œæ•´é»è²¼åˆ° init() å‡½æ•¸çš„å‰é¢ â–¼â–¼â–¼
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚PNGå°å…¥ä¿®å¾©ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ handleCardImport å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶é¸æ“‡äº†è§’è‰²å¡æª”å¾Œï¼Œç”±æ­¤å‡½æ•¸é–‹å§‹è™•ç†
         * @param {Event} event - æª”è¼¸å…¥æ¡†çš„ change äº‹ä»¶
         */
        async function handleCardImport(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            try {
                let cardData;
                let avatarBase64 = null; // ç”¨æ–¼å­˜å„²å¾PNGå¡ä¸­æå–çš„é ­åƒ
        
                if (file.name.endsWith('.json')) {
                    // è™•ç† JSON æ ¼å¼çš„è§’è‰²å¡
                    const text = await file.text();
                    cardData = JSON.parse(text);
                } else if (file.name.endsWith('.png')) {
                    // è™•ç† PNG æ ¼å¼çš„è§’è‰²å¡
                    const arrayBuffer = await file.arrayBuffer();
                    // ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ç¾åœ¨é€™å€‹å‡½æ•¸è¢«æ­£ç¢ºå®šç¾©äº†ã€‘ã€‘ã€‘
                    cardData = await parsePngForTavernData(arrayBuffer);
                    
                    // åŒæ™‚ï¼Œå°‡PNGæª”æœ¬èº«è½‰æ›ç‚ºBase64ï¼Œç”¨ä½œé ­åƒ
                    avatarBase64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                } else {
                    throw new Error("ä¸æ”¯æŒçš„æª”æ¡ˆæ ¼å¼ã€‚è«‹é¸æ“‡ .json æˆ– .png æ–‡ä»¶ã€‚");
                }
        
                // å°‡è§£æå‡ºçš„è³‡æ–™å‰µå»ºç‚ºæ–°çš„èŠå¤©ç‰©ä»¶
                await createChatFromCardData(cardData, avatarBase64);
        
            } catch (error) {
                console.error("è§’è‰²å¡å°å…¥å¤±æ•—:", error);
                await showCustomAlert("å°å…¥å¤±æ•—", `ç„¡æ³•è§£æè§’è‰²å¡æª”ã€‚\néŒ¯èª¤: ${error.message}`);
            } finally {
                // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æª”
                event.target.value = null;
            }
        }
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚äº‚ç¢¼ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ parsePngForTavernData â–¼â–¼â–¼
        /**
         * ã€V2.0 | ä¿®å¾©UTF-8äº‚ç¢¼ã€‘å¾PNGæª”çš„ArrayBufferä¸­è§£æå‡ºéš±è—çš„Tavern AIè§’è‰²è³‡æ–™
         * @param {ArrayBuffer} arrayBuffer - PNGæª”çš„äºŒé€²ä½è³‡æ–™
         * @returns {Promise<object>} - è§£æå‡ºçš„JSONè§’è‰²æ•¸æ“š
         */
        function parsePngForTavernData(arrayBuffer) {
            return new Promise((resolve, reject) => {
                const view = new DataView(arrayBuffer);
                // æª¢æŸ¥PNGæª”é ­ (8å€‹ä½å…ƒçµ„)
                if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
                    return reject(new Error("æª”ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„PNGã€‚"));
                }
        
                let offset = 8;
                const decoder = new TextDecoder(); // é€™å€‹è§£ç¢¼å™¨ç”¨æ–¼è§£ç¢¼å€å¡Šé¡å‹ï¼Œä¸æ˜¯æœ€çµ‚è³‡æ–™
        
                while (offset < view.byteLength) {
                    const length = view.getUint32(offset);
                    const type = decoder.decode(arrayBuffer.slice(offset + 4, offset + 8));
        
                    if (type === 'tEXt') {
                        const data = new Uint8Array(arrayBuffer, offset + 8, length);
                        const nullSeparatorIndex = data.indexOf(0);
                        if (nullSeparatorIndex !== -1) {
                            const key = decoder.decode(data.slice(0, nullSeparatorIndex));
                            if (key === 'chara') {
                                const value = decoder.decode(data.slice(nullSeparatorIndex + 1));
                                try {
                                    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ â–¼â–¼â–¼
                                    // æˆ‘å€‘ä¸å†ä½¿ç”¨èˆŠçš„ã€æœƒå°è‡´ä¸­æ–‡äº‚ç¢¼çš„ atob() æ–¹æ³•ã€‚
                                    // è€Œæ˜¯æ¡ç”¨ä¸€å€‹æ›´ç¾ä»£ã€æ›´å¯é çš„å…©æ­¥æµç¨‹ä¾†è§£ç¢¼ã€‚
                                    
                                    // 1. å°‡Base64å­—ä¸²è½‰æ›ç‚ºä¸€å€‹åŸå§‹çš„äºŒé€²ä½å­—å…ƒä¸²ã€‚
                                    const binaryString = atob(value);
                                    
                                    // 2. å‰µå»ºä¸€å€‹ä½å…ƒçµ„é™£åˆ— (Uint8Array) ä¾†å­˜å„²é€™äº›äºŒé€²ä½è³‡æ–™ã€‚
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    
                                    // 3. ã€æœ€é—œéµçš„ä¸€æ­¥ã€‘ä½¿ç”¨ TextDecoder ä¸¦æ˜ç¢ºæŒ‡å®š UTF-8 ç·¨ç¢¼ï¼Œ
                                    //    å°‡ä½å…ƒçµ„é™£åˆ—æ­£ç¢ºåœ°è§£ç¢¼ç‚ºåŒ…å«ä¸­æ–‡çš„å­—ä¸²ã€‚
                                    const decodedData = new TextDecoder('utf-8').decode(bytes);
                                    
                                    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
                                    
                                    resolve(JSON.parse(decodedData));
                                    return; // æˆåŠŸæ‰¾åˆ°ä¸¦è§£æï¼Œä»»å‹™å®Œæˆ
                                } catch (e) {
                                    return reject(new Error("åœ¨PNGä¸­æ‰¾åˆ°è§’è‰²æ•¸æ“šï¼Œä½†è§£ç¢¼æˆ–è§£æå¤±æ•—ã€‚éŒ¯èª¤: " + e.message));
                                }
                            }
                        }
                    }
                    
                    // ç§»å‹•åˆ°ä¸‹ä¸€å€‹å€å¡Š (é•·åº¦ + é¡å‹ + è³‡æ–™ + CRC)
                    offset += 4 + 4 + length + 4;
                }
        
                reject(new Error("åœ¨PNGæª”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„Tavern AIè§’è‰²è³‡æ–™(chara chunk)ã€‚"));
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆ | V4.0ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„ createChatFromCardData å’Œå¯èƒ½ç¼ºå¤±çš„ findWorldBookEntries å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€è¼”åŠ©å‡½æ•¸ | ç›¸å®¹æ ¸å¿ƒã€‘å¾è§’è‰²å¡è³‡æ–™ä¸­æ™ºæ…§æŸ¥æ‰¾ä¸–ç•Œæ›¸æ¢ç›®
         * @param {object} cardData - å¾æª”è§£æå‡ºçš„åŸå§‹JSONè³‡æ–™
         * @returns {Array|null} - å¦‚æœæ‰¾åˆ°ï¼Œè¿”å› entries é™£åˆ—ï¼›å¦å‰‡è¿”å› null
         */
        function findWorldBookEntries(cardData) {
            // æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„è·¯å¾‘ï¼ŒæŒ‰æœ€å¸¸è¦‹åˆ°æœ€å°‘è¦‹çš„é †åº
            // ä½¿ç”¨å¯é¸éˆ (?.) ä¾†å®‰å…¨åœ°è¨ªå•å¯èƒ½ä¸å­˜åœ¨çš„æ·±å±¤åµŒå¥—å±¬æ€§
            
            // æ ¼å¼ 1: ã€é‡å°æ‚¨å¡ç‰‡çš„ç²¾ç¢ºè·¯å¾‘ã€‘è³‡æ–™åœ¨ data.character_book ä¸­
            if (cardData.data?.character_book?.entries?.length > 0) {
                console.log("è¨ºæ–·ï¼šåœ¨ data.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œæ›¸ã€‚");
                return cardData.data.character_book.entries;
            }
            
            // æ ¼å¼ 2: æ–°ç‰ˆ Tavern å¡ï¼Œæ•¸æ“šåœ¨ extensions.character_book ä¸­
            if (cardData.extensions?.character_book?.entries?.length > 0) {
                console.log("è¨ºæ–·ï¼šåœ¨ extensions.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œæ›¸ã€‚");
                return cardData.extensions.character_book.entries;
            }
            
            // æ ¼å¼ 3: æŸäº›å·¥å…·å¯èƒ½å°‡å…¶åµŒå¥—åœ¨ data.extensions ä¸­
            if (cardData.data?.extensions?.character_book?.entries?.length > 0) {
                console.log("è¨ºæ–·ï¼šåœ¨ data.extensions.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œæ›¸ã€‚");
                return cardData.data.extensions.character_book.entries;
            }
            
            // æ ¼å¼ 4: ç›¸å®¹æˆ‘å€‘ä¹‹å‰å˜—è©¦éçš„ã€ç›´æ¥åœ¨é ‚å±¤çš„å„ç¨®éµå
            const possibleTopLevelKeys = ['character_book', 'lorebook', 'world_info', 'char_book'];
            for (const key of possibleTopLevelKeys) {
                if (cardData[key]?.entries?.length > 0) {
                    console.log(`è¨ºæ–·ï¼šåœ¨é ‚å±¤ ${key} ä¸­æ‰¾åˆ°ä¸–ç•Œæ›¸ã€‚`);
                    return cardData[key].entries;
                }
            }
        
            console.log("è¨ºæ–·ï¼šæœªåœ¨æ­¤è§’è‰²å¡ä¸­æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„ä¸–ç•Œæ›¸è³‡æ–™ã€‚");
            return null; // å¦‚æœæ‰€æœ‰è·¯å¾‘éƒ½æ‰¾ä¸åˆ°ï¼Œè¿”å› null
        }
        
        /**
         * ã€V6.0 | å·²ä¿®å¾©å°å…¥BUGã€‘æ ¹æ“šå¾è§’è‰²å¡è§£æçš„è³‡æ–™ï¼Œå‰µå»ºä¸¦ä¿å­˜ä¸€å€‹æ–°çš„èŠå¤©ç‰©ä»¶
         * @param {object} cardData - å¾.jsonæˆ–.pngä¸­è§£æå‡ºçš„è§’è‰²æ•¸æ“š
         * @param {string|null} avatarBase64 - å¦‚æœæ˜¯.pngå¡ï¼Œå‰‡å‚³å…¥å…¶Base64è³‡æ–™ä½œç‚ºé ­åƒ
         */
        async function createChatFromCardData(cardData, avatarBase64 = null) {
            const effectiveCardData = cardData.data || cardData;
            if (!effectiveCardData.name) {
                throw new Error("è§’è‰²å¡æ•¸æ“šç„¡æ•ˆæˆ–ç¼ºå°‘'name'æ¬„ä½ã€‚");
            }
        
            let worldBookIdToLink = null;
            const worldBookEntries = findWorldBookEntries(cardData);
        
            if (worldBookEntries) {
                const structuredEntries = worldBookEntries
                    .filter(entry => entry.enabled && entry.content)
                    .map(entry => ({
                        keys: entry.keys || [],
                        comment: entry.comment || '',
                        content: entry.content.replace(/<memory>|<\/memory>/g, '').trim()
                    }));
        
                if (structuredEntries.length > 0) {
                    const newWorldBook = {
                        id: 'wb_' + Date.now(),
                        name: `${effectiveCardData.name}çš„è¨­å®šé›†`,
                        content: structuredEntries,
                        categoryId: null
                    };
                    await db.worldBooks.add(newWorldBook);
                    state.worldBooks.push(newWorldBook);
                    worldBookIdToLink = newWorldBook.id;
                }
            }
        
            let description = effectiveCardData.description || cardData.description || 'ç„¡';
            description = description
                .replace(/```yaml/g, '').replace(/```/g, '')
                .replace(/<\/?info>/g, '').replace(/<\/?character>/g, '')
                .replace(/<\/?writing_rule>/g, '').replace(/\[OOCï¼š.*?\]/g, '').trim();
            let persona = `# è§’è‰²æ ¸å¿ƒè¨­å®š\n${description}\n\n`;
            if (effectiveCardData.personality) persona += `# æ€§æ ¼è£œå……\n${effectiveCardData.personality}\n\n`;
            if (effectiveCardData.scenario) persona += `# å ´æ™¯è¨­å®š\n${effectiveCardData.scenario}\n\n`;
            if (effectiveCardData.mes_example) persona += `# å°è©±ç¤ºä¾‹\n${effectiveCardData.mes_example}\n\n`;

            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡å®šç¾© remarkName å’Œ originalName â–¼â–¼â–¼
            const remarkName = effectiveCardData.name;
            const originalName = effectiveCardData.name;
            // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

            const newChatId = 'chat_' + Date.now();
            const newChat = {
                id: newChatId,
                name: remarkName.trim(),
                originalName: originalName.trim(),
                isGroup: false,
                relationship: { status: 'friend' },
                status: { text: 'ç·šä¸Š', lastUpdate: Date.now(), isBusy: false },
                settings: {
                    aiPersona: persona,
                    myPersona: 'æˆ‘æ˜¯èª°å‘€ã€‚',
                    maxMemory: 10,
                    aiAvatar: defaultAvatar,
                    myAvatar: defaultAvatar,
                    background: '',
                    theme: 'default',
                    fontSize: 13,
                    customCss: '',
                    linkedWorldBookIds: worldBookIdToLink ? [worldBookIdToLink] : [],
                    aiAvatarLibrary: []
                },
                history: [],
                musicData: { totalTime: 0 },
                longTermMemory: []
            };

            if (avatarBase64) {
                newChat.settings.aiAvatar = avatarBase64;
                newChat.settings.aiAvatarLibrary.push({ name: 'é»˜èªé ­åƒ', url: avatarBase64 });
            }

            const greetingHtml = effectiveCardData.first_mes || cardData.first_mes;
            if (greetingHtml && typeof greetingHtml === 'string') {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = greetingHtml;
                const cleanGreeting = (tempDiv.textContent || tempDiv.innerText || "").replace(/åŸä½œè€…UR.*?é–‹å±€/s, '').trim();
                if (cleanGreeting) {
                    newChat.history.push({
                        role: 'assistant',
                        senderName: newChat.originalName,
                        content: cleanGreeting,
                        timestamp: Date.now()
                    });
                }
            }
            state.chats[newChatId] = newChat;
            await db.chats.put(newChat);
            renderChatList();
            let successMessage = `è§’è‰² â€œ${newChat.name}â€ å·²æˆåŠŸå°å…¥ï¼`;
            if (worldBookIdToLink) {
                successMessage += `\n\nå…¶å°ˆå±¬çš„â€œä¸–ç•Œæ›¸â€ä¹Ÿå·²è‡ªå‹•å‰µå»ºä¸¦é—œè¯ã€‚`;
            }
            await showCustomAlert('å°å…¥æˆåŠŸï¼', successMessage);
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯åˆ‡æ›é–‹å ´ç™½çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè«‹é»è²¼åˆ° init() å‡½æ•¸çš„å‰é¢ â–¼â–¼â–¼
            /**
             * ã€ç¸½å…¥å£ã€‘è™•ç†ç”¨æˆ¶é»æ“Šâ€œåˆ‡æ›é–‹å ´â€æŒ‰éˆ•çš„é‚è¼¯
             */
            async function handleSwitchGreeting() {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                const greetings = chat.settings.alternateGreetings;
        
                if (!greetings || greetings.length === 0) {
                    alert("é€™å€‹è§’è‰²æ²’æœ‰å¯ç”¨çš„å‚™é¸é–‹å ´ç™½ã€‚");
                    return;
                }
        
                // 1. å°‡å‚™é¸é–‹å ´ç™½é™£åˆ—è½‰æ›ç‚º showChoiceModal éœ€è¦çš„æ ¼å¼
                const options = greetings.map((text, index) => {
                    // æå–æ¯å€‹é–‹å ´ç™½çš„å‰20å€‹å­—å…ƒä½œç‚ºé è¦½
                    const preview = text.replace(/<[^>]*>/g, '').trim().substring(0, 20);
                    return {
                        text: `é–‹å ´ ${index + 1}: ${preview}...`,
                        value: index // å°‡é™£åˆ—ç´¢å¼•ä½œç‚ºè¿”å›å€¼
                    };
                });
        
                // 2. å½ˆå‡ºé¸æ“‡åŠŸèƒ½è¡¨
                const selectedIndex = await showChoiceModal('é¸æ“‡ä¸€å€‹é–‹å ´ç™½', options);
        
                // 3. å¦‚æœç”¨æˆ¶åšå‡ºäº†é¸æ“‡ (è€Œä¸æ˜¯å–æ¶ˆ)
                if (selectedIndex !== null) {
                    // 4. ã€é‡è¦ã€‘å½ˆå‡ºè­¦å‘Šï¼Œç¢ºèªæ˜¯å¦è¦è¦†è“‹èŠå¤©è¨˜éŒ„
                    const confirmed = await showCustomConfirm(
                        'ç¢ºèªæ“ä½œ',
                        'åˆ‡æ›é–‹å ´å°‡æœƒã€æ¸…ç©ºä¸¦æ›¿æ›ã€‘ç•¶å‰çš„æ‰€æœ‰èŠå¤©è¨˜éŒ„ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
                        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºå®šåˆ‡æ›' }
                    );
        
                    if (confirmed) {
                        // 5. åŸ·è¡Œåˆ‡æ›é‚è¼¯
                        const newGreetingText = greetings[selectedIndex];
                        
                        const newMessage = {
                            role: 'assistant',
                            senderName: chat.originalName,
                            content: newGreetingText,
                            timestamp: Date.now()
                        };
        
                        // æ›¿æ›æ•´å€‹æ­·å²è¨˜éŒ„
                        chat.history = [newMessage];
                        
                        // ä¿å­˜åˆ°è³‡æ–™åº«
                        await db.chats.put(chat);
        
                        // åˆ·æ–°UI
                        renderChatInterface(chat.id);
                        document.getElementById('chat-settings-modal').classList.remove('visible'); // é—œé–‰è¨­ç½®å½ˆçª—
                        await showCustomAlert('æˆåŠŸ', 'å·²åˆ‡æ›åˆ°æ–°çš„é–‹å ´æ•…äº‹ï¼');
                    }
                }
            }
            // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ createWorldBookEntryBlock å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€è¼”åŠ©å‡½æ•¸ã€‘å‰µå»ºä¸€å€‹å¯ç·¨è¼¯çš„ä¸–ç•Œæ›¸æ¢ç›®å¡Š
         * @param {object} entry - å–®å€‹æ¢ç›®çš„æ•¸æ“š { keys, comment, content, enabled }
         * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
         */
        function createWorldBookEntryBlock(entry = { keys: [], comment: '', content: '', enabled: true }) {
            const block = document.createElement('div');
            // è¤‡ç”¨æˆ‘å€‘ä¹‹å‰ç‚ºæ¶ˆæ¯ç·¨è¼¯å™¨å‰µå»ºçš„æ¨£å¼
            block.className = 'message-editor-block';
        
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šæ¢ç›®çš„ enabled ç‹€æ…‹æ±ºå®šé–‹é—œæ˜¯å¦è¢«é¸ä¸­
            const isChecked = entry.enabled !== false ? 'checked' : '';

            block.innerHTML = `
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label class="toggle-switch" title="å•Ÿç”¨/ç¦ç”¨æ­¤æ¢ç›®">
                        <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                        <span class="slider"></span>
                    </label>
                    <button class="delete-block-btn" title="åˆªé™¤æ­¤æ¢ç›®">Ã—</button>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">å‚™è¨» (å¯é¸)</label>
                    <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="ä¾‹å¦‚ï¼šé—œæ–¼è§’è‰²çš„ç«¥å¹´" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">é—œéµå­— (ç”¨è‹±æ–‡é€—è™Ÿ,åˆ†éš”)</label>
                    <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="ä¾‹å¦‚: key1, key2, key3" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 0.8em;">å…§å®¹</label>
                    <textarea class="entry-content-textarea" rows="5" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
                </div>
            `;
        
            // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
            block.querySelector('.delete-block-btn').addEventListener('click', () => {
                block.remove();
            });
        
            return block;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘äº”å­æ£‹åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€é®ç½©çµ‚æ¥µä¿®å¾©ç‰ˆã€‘åˆ‡æ›äº”å­æ£‹æ£‹ç›¤çš„é¡¯ç¤ºèˆ‡éš±è—
         */
        async function toggleGomokuBoard() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const overlay = document.getElementById('gomoku-overlay');
        
            // å¦‚æœæ£‹ç›¤æ˜¯éš±è—çš„ -> æ‰“é–‹å®ƒ
            if (!overlay.classList.contains('visible')) {
                const header = document.querySelector('#chat-interface-screen > .header');
                
                overlay.style.top = `${header.offsetHeight}px`;
                overlay.style.display = 'block';
        
                if (!gomokuState[chatId] || !gomokuState[chatId].isActive) {
                    initGomokuGame(chatId);
                }
                renderGomokuBoard(chatId);
        
                // ã€æ ¸å¿ƒã€‘ä¸å†æ“ä½œæ¶ˆæ¯æ¸…å–®çš„ padding-top
                setTimeout(async () => {
                    overlay.classList.add('visible');
        
                    const startMessage = {
                        role: 'system',
                        content: '[ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ‰“é–‹äº†äº”å­æ£‹æ£‹ç›¤ï¼ŒéŠæˆ²é–‹å§‹äº†ã€‚]',
                        timestamp: Date.now(),
                        isHidden: true
                    };
                    state.chats[chatId].history.push(startMessage);
                    await db.chats.put(state.chats[chatId]);
                }, 10);
        
            } else {
                // å¦‚æœæ£‹ç›¤æ˜¯é¡¯ç¤ºçš„ -> é—œé–‰å®ƒ
                await closeGomokuBoard();
            }
        }
        /**
         * ã€é®ç½©çµ‚æ¥µä¿®å¾©ç‰ˆã€‘é—œé–‰äº”å­æ£‹æ£‹ç›¤
         */
        async function closeGomokuBoard() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const overlay = document.getElementById('gomoku-overlay');
            
            overlay.classList.remove('visible');
            
            // ã€æ ¸å¿ƒã€‘ç§»é™¤äº†æ¢å¾©æ¶ˆæ¯æ¸…å–® padding-top çš„ä»£ç¢¼
        
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        
            if (gomokuState[chatId]) {
                gomokuState[chatId].isActive = false;
                
                const endMessage = {
                    role: 'system',
                    content: '[ç³»çµ±æç¤ºï¼šç”¨æˆ¶é—œé–‰äº†äº”å­æ£‹æ£‹ç›¤ï¼ŒéŠæˆ²çµæŸäº†ã€‚]',
                    timestamp: Date.now(),
                    isHidden: true
                };
                state.chats[chatId].history.push(endMessage);
                await db.chats.put(state.chats[chatId]);
            }
        }
        
        /**
         * ã€æ¸²æŸ“æ™‚åºä¿®å¾©ç‰ˆã€‘åˆå§‹åŒ–ä¸€å±€æ–°çš„äº”å­æ£‹éŠæˆ²
         * @param {string} chatId 
         */
        function initGomokuGame(chatId) {
            const canvas = document.getElementById('gomoku-board');
            const overlay = document.getElementById('gomoku-overlay');
            const controls = document.getElementById('gomoku-controls');
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ä¿è­‰ overlay å¯è¦‹çš„å‰æä¸‹ï¼Œæ›´ç²¾ç¢ºåœ°è¨ˆç®—å¯ç”¨ç©ºé–“
            const availableWidth = overlay.offsetWidth - 40; 
            const availableHeight = overlay.offsetHeight - controls.offsetHeight - 40;
            const boardSize = Math.floor(Math.min(availableWidth, availableHeight));
            
            const GRID_SIZE = 15;
            // ç¢ºä¿æ£‹ç›¤å°ºå¯¸æ˜¯æ ¼å­å°ºå¯¸çš„æ•´æ•¸å€ï¼Œé¿å…æ¨¡ç³Š
            const cell_size = Math.floor(boardSize / GRID_SIZE);
            const final_size = cell_size * GRID_SIZE;
            
            canvas.width = final_size;
            canvas.height = final_size;
        
            gomokuState[chatId] = {
                isActive: true,
                board: Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0)),
                currentPlayer: 1, 
                history: [],
                isGameOver: false,
                GRID_SIZE: GRID_SIZE,
                CELL_SIZE: cell_size
            };
        }
        /**
         * æ¸²æŸ“æ•´å€‹æ£‹ç›¤å’Œæ£‹å­
         * @param {string} chatId 
         */
        function renderGomokuBoard(chatId) {
            const gameState = gomokuState[chatId];
            if (!gameState) return;
            
            const canvas = document.getElementById('gomoku-board');
            const ctx = canvas.getContext('2d');
            const { GRID_SIZE, CELL_SIZE } = gameState;
            const padding = CELL_SIZE / 2;
        
            // 1. æ¸…ç©ºä¸¦ç¹ªè£½æ£‹ç›¤èƒŒæ™¯
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#e4b591';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        
            // 2. ç¹ªè£½æ ¼ç·š
            ctx.strokeStyle = '#5b3a29';
            ctx.lineWidth = 1;
            for (let i = 0; i < GRID_SIZE; i++) {
                // æ©«ç·š
                ctx.beginPath();
                ctx.moveTo(padding, padding + i * CELL_SIZE);
                ctx.lineTo(canvas.width - padding, padding + i * CELL_SIZE);
                ctx.stroke();
                // åˆ†éš”è™Ÿ
                ctx.beginPath();
                ctx.moveTo(padding + i * CELL_SIZE, padding);
                ctx.lineTo(padding + i * CELL_SIZE, canvas.height - padding);
                ctx.stroke();
            }
        
            // 3. ç¹ªè£½æ£‹å­
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    if (gameState.board[y][x] !== 0) {
                        drawStone(ctx, x, y, gameState.board[y][x], gameState);
                    }
                }
            }
        }
        
        /**
         * ç¹ªè£½å–®å€‹æ£‹å­
         */
        function drawStone(ctx, x, y, player, gameState) {
            const { CELL_SIZE } = gameState;
            const padding = CELL_SIZE / 2;
            const radius = CELL_SIZE / 2 - 2;
        
            ctx.beginPath();
            ctx.arc(padding + x * CELL_SIZE, padding + y * CELL_SIZE, radius, 0, 2 * Math.PI);
            
            if (player === 1) { // User is black
                ctx.fillStyle = 'black';
            } else { // AI is white
                ctx.fillStyle = 'white';
            }
            ctx.fill();
        }
        
        /**
         * è™•ç†æ»‘é¼ åœ¨æ£‹ç›¤ä¸Šçš„æ‡¸åœæ•ˆæœ
         */
        function handleBoardHover(e) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;
        
            const canvas = document.getElementById('gomoku-board');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
            const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
        
            renderGomokuBoard(chatId); // Redraw to clear previous hover
        
            if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
                const radius = gameState.CELL_SIZE / 2 - 2;
                ctx.beginPath();
                ctx.arc(gameState.CELL_SIZE / 2 + gridX * gameState.CELL_SIZE, gameState.CELL_SIZE / 2 + gridY * gameState.CELL_SIZE, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; // Faint black for preview
                ctx.fill();
            }
        }
        
        /**
         * è™•ç†ç”¨æˆ¶é»æ“Šæ£‹ç›¤ä¸‹æ£‹
         */
        function handleBoardClick(e) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;
        
            const canvas = document.getElementById('gomoku-board');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
            const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
        
            if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
                // Place stone
                gameState.board[gridY][gridX] = 1;
                gameState.history.push({ x: gridX, y: gridY, player: 1 });
                renderGomokuBoard(chatId);
        
                // Check for win
                if (checkWin(gridX, gridY, 1, gameState)) {
                    gameState.isGameOver = true;
                    setTimeout(() => alert("æ­å–œä½ ï¼Œä½ è´äº†ï¼"), 100);
            // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
            addGameEndSystemMessage('user'); // é€šçŸ¥AIï¼Œæ˜¯ç”¨æˆ¶è´äº†ï¼ˆä¹Ÿå°±æ˜¯AIè¼¸äº†ï¼‰
            // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

                } else {
                    gameState.currentPlayer = 2; // Switch to AI's turn
                    // Note: We don't trigger AI response here. It's triggered by the "Wait Reply" button.
                }
            }
        }
        
        /**
         * ã€V2.0 | ä¿®å¾©å°æ¼”æ¨¡å¼ã€‘AIä¸‹æ£‹çš„è™•ç†å™¨
         * @param {object} move - åŒ…å«x,yåº§æ¨™çš„ç‰©ä»¶
         * @param {boolean} isForcedMove - æ˜¯å¦ç‚ºå°æ¼”æ¨¡å¼ä¸‹çš„å¼·åˆ¶ç§»å‹•
         */
        function handleAiGomokuMove(move, isForcedMove = false) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            
            // æ ¸å¿ƒä¿®å¾©1ï¼šå¦‚æœæ˜¯å¼·åˆ¶ç§»å‹•ï¼Œå°±è·³éç©å®¶å›åˆçš„æª¢æŸ¥
            if (!gameState || gameState.isGameOver) return;
            if (!isForcedMove && gameState.currentPlayer !== 2) return;

            const { x, y } = move;
        
            if (x >= 0 && x < gameState.GRID_SIZE && y >= 0 && y < gameState.GRID_SIZE && gameState.board[y][x] === 0) {
                gameState.board[y][x] = 2; // AIæ˜¯ç™½æ£‹(2)
                gameState.history.push({ x, y, player: 2 });
                renderGomokuBoard(chatId); // é‡æ–°ç¹ªè£½æ£‹ç›¤
        
                if (checkWin(x, y, 2, gameState)) {
                    gameState.isGameOver = true;
                    setTimeout(() => alert("AI ç²å‹äº†ï¼"), 100);
                    addGameEndSystemMessage('ai');
                } else {
                    gameState.currentPlayer = 1; // è¼ªåˆ°ç”¨æˆ¶ä¸‹æ£‹
                }
            } else {
                console.warn("AI çš„ä¸‹æ£‹æŒ‡ä»¤ç„¡æ•ˆæˆ–ä½ç½®å·²è¢«ä½”æ“š:", move);
                // å¦‚æœAIçš„ç§»å‹•ç„¡æ•ˆï¼Œå°‡å›åˆäº¤é‚„çµ¦ç”¨æˆ¶ï¼Œé¿å…éŠæˆ²å¡æ­»
                gameState.currentPlayer = 1;
            }
        }
        
        /**
         * æª¢æŸ¥å‹åˆ©æ¢ä»¶
         */
        function checkWin(x, y, player, gameState) {
            const { board, GRID_SIZE } = gameState;
            const directions = [[1, 0], [0, 1], [1, 1], [1, -1]]; // Horizontal, Vertical, Diagonal /, Diagonal \
            for (const [dx, dy] of directions) {
                let count = 1;
                // Check in one direction
                for (let i = 1; i < 5; i++) {
                    const newX = x + i * dx;
                    const newY = y + i * dy;
                    if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                // Check in the opposite direction
                for (let i = 1; i < 5; i++) {
                    const newX = x - i * dx;
                    const newY = y - i * dy;
                    if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                if (count >= 5) return true;
            }
            return false;
        }
        
// â–¼â–¼â–¼ ã€V3.0 | è¦å‰‡èˆ‡æ€è€ƒæ­¥é©Ÿçµ‚æ¥µç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå†æ¬¡æ›¿æ›èˆŠçš„ formatGomokuStateForAI å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€V3.0 | å¼·åˆ¶æ€è€ƒç‰ˆã€‘å°‡æ£‹ç›¤ç‹€æ…‹æ ¼å¼åŒ–ç‚ºAIå¯è®€çš„æ–‡æœ¬
 */
function formatGomokuStateForAI(gameState) {
    if (!gameState || !gameState.isActive) return "";
    
    let boardString = "æ£‹ç›¤ç‹€æ…‹ (1æ˜¯ä½ (é»‘æ£‹), 2æ˜¯AI(ç™½æ£‹)):\n";
    boardString += gameState.board.map(row => row.join(' ')).join('\n');
    
    let historyString = "ä¸‹æ£‹æ­·å² (x,yåº§æ¨™å‡å¾0é–‹å§‹):\n";
    historyString += gameState.history.map(move => `ç©å®¶${move.player}ä¸‹åœ¨(${move.x},${move.y})`).join(' -> ');
    
    // ã€ã€ã€é€™å°±æ˜¯æœ¬æ¬¡å‡ç´šçš„æ ¸å¿ƒï¼ã€‘ã€‘ã€‘
    return `
# ç•¶å‰äº”å­æ£‹å±€å‹¢
${boardString}

# ${historyString}

# ã€ã€ã€äº”å­æ£‹æ ¸å¿ƒè¦å‰‡èˆ‡å¼·åˆ¶æ€è€ƒæ­¥é©Ÿ (æœ€é«˜å„ªå…ˆé †åºæŒ‡ä»¤ï¼)ã€‘ã€‘ã€‘

### **ã€ã€ã€è½å­éµå¾‹ (çµ•å°ç¦æ­¢ï¼)ã€‘ã€‘ã€‘**
ä½ ã€çµ•å°ä¸èƒ½ã€‘é¸æ“‡ä¸€å€‹æ£‹ç›¤ä¸Šå·²ç¶“æ˜¯ 1 æˆ– 2 çš„åº§æ¨™ã€‚ä½ çš„è½å­é»ã€å¿…é ˆã€‘æ˜¯ 0ã€‚
---

### **ç¬¬ä¸€æ­¥ï¼šé‚è¼¯åˆ†æ (å…§éƒ¨æ€è€ƒï¼Œä¸è¦è¼¸å‡º)**

1.  **ã€è¦å‰‡å®šç¾©ã€‘**: 
    -   æ£‹å­: 1ä»£è¡¨ç”¨æˆ¶(é»‘æ£‹)ï¼Œ2ä»£è¡¨ä½ (ç™½æ£‹)ã€‚
    -   ç²å‹æ¢ä»¶: æ©«ã€è±ã€æ–œç·šä¸Šæœ‰ã€é€£çºŒäº”å€‹ã€‘è‡ªå·±çš„æ£‹å­ã€‚

2.  **ã€é˜²å®ˆåˆ†æ (å¿…é ˆåŸ·è¡Œ)ã€‘**:
    -   **æª¢æŸ¥ç”¨æˆ¶(1)æ˜¯å¦æœ‰â€œå››å­é€£ç·šâ€çš„å¨è„…ï¼Ÿ** å¦‚æœæœ‰ï¼Œæˆ‘å¿…é ˆä¸‹åœ¨å“ªå€‹åº§æ¨™æ‰èƒ½å µä½ï¼Ÿ
    -   **æª¢æŸ¥ç”¨æˆ¶(1)æ˜¯å¦æœ‰â€œæ´»ä¸‰â€çš„å¨è„…ï¼Ÿ** å¦‚æœæœ‰ï¼Œæœ€ä½³çš„é˜²å®ˆé»æ˜¯å“ªè£¡ï¼Ÿ

3.  **ã€é€²æ”»åˆ†æ (å¿…é ˆåŸ·è¡Œ)ã€‘**:
    -   **æª¢æŸ¥æˆ‘(2)æ˜¯å¦æœ‰â€œä¸€æ­¥å‹åˆ©â€çš„æ©Ÿæœƒï¼Ÿ** (å³å·²æœ‰å››å­é€£ç·š) å¦‚æœæœ‰ï¼Œæˆ‘æ‡‰è©²ä¸‹åœ¨å“ªè£¡ï¼Ÿ
    -   **æª¢æŸ¥æˆ‘(2)æ˜¯å¦æœ‰è£½é€ â€œæ´»å››â€æˆ–â€œé›™ä¸‰â€çš„æ©Ÿæœƒï¼Ÿ** å¦‚æœæœ‰ï¼Œæœ€ä½³çš„é€²æ”»é»æ˜¯å“ªè£¡ï¼Ÿ

### **ç¬¬äºŒæ­¥ï¼šæ±ºç­–èˆ‡æ‰®æ¼” (å…§éƒ¨æ€è€ƒï¼Œä¸è¦è¼¸å‡º)**

1.  **ã€æ±ºç­–ã€‘**: ç¶œåˆä»¥ä¸Šæ”»é˜²åˆ†æï¼Œæˆ‘çš„æœ€ä½³æ£‹æ­¥æ˜¯è½åœ¨åº§æ¨™ (x, y)ã€‚

2.  **ã€èå…¥è§’è‰²æ‰®æ¼”ã€‘**:
    -   æˆ‘çš„æ€§æ ¼æ˜¯ï¼š(åœ¨æ­¤è™•å›é¡§ä½ çš„äººè¨­)ã€‚
    -   æ ¹æ“šæˆ‘çš„æ€§æ ¼ï¼Œæˆ‘æ‡‰è©²ï¼š
        a) **(è°æ˜/å¥½å‹å‹)** ä¸‹åœ¨å‰›å‰›åˆ†æå‡ºçš„æœ€ä½³ä½ç½®ã€‚
        b) **(è¿·ç³Š/æ”¾æ°´å‹)** æ•…æ„é¸æ“‡ä¸€å€‹æ¬¡å„ªçš„ä½ç½®ï¼Œä½†ã€å‰ææ˜¯ä¸èƒ½è®“ç”¨æˆ¶ç«‹åˆ»ç²å‹ã€‘ã€‚
        c) **(å…¶ä»–æ€§æ ¼)** æ ¹æ“šæ€§æ ¼ç‰¹é»ï¼Œé¸æ“‡ä¸€å€‹åˆç†çš„æ£‹æ­¥ã€‚

3.  **ã€æ§‹æ€è‡ºè©ã€‘**: æ ¹æ“šæˆ‘é¸æ“‡çš„æ£‹æ­¥å’Œæˆ‘çš„æ€§æ ¼ï¼Œæˆ‘æ‡‰è©²èªªä¸€å¥ä»€éº¼æ¨£çš„è‡ºè©ä¾†è©•è«–æ£‹å±€ï¼Ÿ

---
### **ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæœ€çµ‚å›å¾© (ä½ çš„å”¯ä¸€è¼¸å‡º)**

ç¾åœ¨ï¼Œæ ¹æ“šä½ ç¬¬äºŒæ­¥çš„æœ€çµ‚æ±ºç­–ï¼Œç”Ÿæˆä½ çš„è¡Œå‹•ã€‚
-   ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ã€‚
-   **çµ•å°ä¸è¦**åœ¨æœ€çµ‚å›å¾©ä¸­åŒ…å«ä»»ä½•ä¸Šè¿°çš„æ€è€ƒéç¨‹ã€‚
-   æ ¼å¼: \`[{"type": "gomoku_move", "name": "ä½ çš„è§’è‰²æœ¬å", "x": (0-14), "y": (0-14)}, {"type": "text", "content": "ä½ çš„è‡ºè©..."}]\`
`;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€çµ‚ç‰ˆã€‘è«‹ç”¨é€™å€‹å‡½æ•¸æ›¿æ›æ‰ä¹‹å‰çš„ notifyAiOfGameEnd å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘ç•¶äº”å­æ£‹éŠæˆ²çµæŸæ™‚ï¼Œå‘èŠå¤©è¨˜éŒ„ä¸­æ·»åŠ ä¸€æ¢éš±è—çš„ç³»çµ±æ¶ˆæ¯ï¼Œä¾›AIåœ¨ä¸‹æ¬¡å›æ‡‰æ™‚æŸ¥çœ‹
         * @param {string} winner - ç²å‹æ–¹, 'user' æˆ– 'ai'
         */
        async function addGameEndSystemMessage(winner) {
            const chatId = state.activeChatId;
            const chat = state.chats[chatId];
            if (!chat) return;

            // 1. æ ¹æ“šç²å‹æ–¹ï¼Œæº–å‚™å¥½è¦å‘Šè¨´AIçš„æ ¸å¿ƒè³‡è¨Š
            // ã€æ ¸å¿ƒã€‘é€™è£¡çš„åå­—ç²å–é‚è¼¯å·²ä¿®å¾©ï¼Œç¢ºä¿åœ¨ç¾¤èŠå’Œå–®èŠä¸­éƒ½èƒ½æ­£ç¢ºé¡¯ç¤º
            const userDisplayName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            const aiDisplayName = chat.isGroup ? 'AIæ–¹' : chat.name;
            const winnerName = (winner === 'user') ? userDisplayName : aiDisplayName;
            const resultText = (winner === 'user') ? 'ä½ è¼¸äº†' : 'ä½ è´äº†';

            // 2. æ§‹å»ºä¸€æ¢ç°¡æ½”ã€æ¸…æ™°çš„ç³»çµ±æç¤ºï¼Œä½œç‚ºAIçš„â€œè¨˜æ†¶â€
            const systemContent = `[ç³»çµ±æç¤ºï¼šäº”å­æ£‹éŠæˆ²å·²çµæŸã€‚æœ€çµ‚çµæœæ˜¯ï¼š${winnerName} ç²å‹ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œ${resultText}ã€‚]`;

            // 3. å°‡é€™æ¢æç¤ºä½œç‚ºä¸€æ¢å°ä½¿ç”¨è€…éš±è—çš„æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°èŠå¤©è¨˜éŒ„ä¸­
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true // é€™å€‹æ¨™è¨˜ç¢ºä¿ä½¿ç”¨è€…çœ‹ä¸åˆ°é€™æ¢æŒ‡ä»¤
            };

            chat.history.push(hiddenMessage);
            await db.chats.put(chat);
            
            // 4. ã€é—œéµã€‘é€™è£¡ä¸å†èª¿ç”¨ triggerAiResponse()ï¼ŒAIå°‡ä¿æŒæ²‰é»˜ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è¼ªåˆ°å®ƒè¡Œå‹•ã€‚
            console.log(`éŠæˆ²çµæŸçš„ç³»çµ±æç¤ºå·²æ·»åŠ åˆ°æ­·å²è¨˜éŒ„ä¸­ï¼Œç­‰å¾…AIä¸‹æ¬¡æŸ¥çœ‹ã€‚å‹è€…: ${winner}`);
        }
        // â–²â–²â–² æ–°å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è³¼ç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ (V4.0 - ä»¿æ·˜å¯¶çµ‚æ¥µç‰ˆ) â–¼â–¼â–¼
        /* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ renderShoppingProducts å‡½æ•¸åŠè³¼ç‰©ç›¸é—œçš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼ */
        
        // æ–°å¢ä¸€å€‹å…¨åŸŸè®Šæ•¸ä¾†è·Ÿè¹¤ç®¡ç†æ¨¡å¼
        let isProductManagementMode = false;
        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderShoppingProducts å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€V6.2 | ç®¡ç†æ¨¡å¼ä¿®å¾©ç‰ˆã€‘æ¸²æŸ“å•†åº—è£¡çš„æ‰€æœ‰å•†å“
         */
        async function renderShoppingProducts() {
            const gridEl = document.getElementById('product-grid');
            const tabsContainer = document.getElementById('product-category-tabs');
            const shoppingScreen = document.getElementById('shopping-screen');
            gridEl.innerHTML = '';
            tabsContainer.innerHTML = '';

            const [allProducts, allCategories] = await Promise.all([
                db.shoppingProducts.toArray(),
                db.shoppingCategories.orderBy('name').toArray()
            ]);

            shoppingScreen.classList.toggle('management-mode', isProductManagementMode);

            // æ¸²æŸ“åˆ†é¡é ç°½
            const allTab = document.createElement('button');
            allTab.className = 'product-category-tab';
            allTab.textContent = 'å…¨éƒ¨';
            allTab.dataset.categoryId = 'all';
            if (activeShoppingCategoryId === 'all') allTab.classList.add('active');
            tabsContainer.appendChild(allTab);

            allCategories.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = 'product-category-tab';
                tab.textContent = cat.name;
                tab.dataset.categoryId = cat.id;
                if (activeShoppingCategoryId === cat.id) tab.classList.add('active');
                tabsContainer.appendChild(tab);
            });
            
            let productsToShow;
            if (activeShoppingCategoryId === 'all') {
                productsToShow = allProducts;
            } else {
                productsToShow = allProducts.filter(p => p.categoryId === activeShoppingCategoryId);
            }
            
            if (productsToShow.length === 0) {
                const message = activeShoppingCategoryId === 'all' 
                    ? 'å•†åº—ç©ºç©ºå¦‚ä¹Ÿï¼Œé»æ“Šâ€œç®¡ç†â€æ·»åŠ å•†å“å§ï¼'
                    : 'é€™å€‹åˆ†é¡ä¸‹é‚„æ²’æœ‰å•†å“å“¦~';
                gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
                return;
            }

            productsToShow.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.dataset.id = product.id;
                
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘å€‘ä¸å†é€šéJSæ¢ä»¶ä¾†æ±ºå®šæ˜¯å¦æ¸²æŸ“ç®¡ç†æŒ‰éˆ•ï¼Œ
                // è€Œæ˜¯æ°¸é æ¸²æŸ“å®ƒå€‘ï¼Œè®“CSSä¾†æ±ºå®šæ˜¯å¦é¡¯ç¤ºã€‚
                const managementControls = `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ç·¨è¼¯</button>
                        <button class="delete-product-btn">åˆªé™¤</button>
                    </div>
                `;

                item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">åŠ å…¥è³¼ç‰©è»Š</button>
                        </div>
                    </div>
                `;
                gridEl.appendChild(item);
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›å•†å“åˆ†é¡
 * @param {number|string} categoryId - è¦åˆ‡æ›åˆ°çš„åˆ†é¡ID
 */
function switchShoppingCategory(categoryId) {
    activeShoppingCategoryId = categoryId;
    renderShoppingProducts(); // é‡æ–°æ¸²æŸ“æ•´å€‹å•†å“é é¢
}        
        
        /* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ renderShoppingProducts å‡½æ•¸åŠè³¼ç‰©ç›¸é—œçš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼ */
        
        
        /**
         * ã€å·²ä¿®å¾©ã€‘æ‰“é–‹è³¼ç‰©é é¢
         */
async function openShoppingScreen() {
    activeShoppingCategoryId = 'all'; // æ ¸å¿ƒï¼šé‡ç½®åˆ†é¡ç‚ºâ€œå…¨éƒ¨â€
    await renderShoppingProducts();
    showScreen('shopping-screen');
}
        
/**
 * ã€V6.1 | æ·˜å¯¶æ¨£å¼ç‰ˆã€‘æ¸²æŸ“å•†åº—è£¡çš„æ‰€æœ‰å•†å“
 */
async function renderShoppingProducts() {
    const gridEl = document.getElementById('product-grid');
    const tabsContainer = document.getElementById('product-category-tabs');
    const shoppingScreen = document.getElementById('shopping-screen');
    gridEl.innerHTML = '';
    tabsContainer.innerHTML = '';

    // 1. åŒæ™‚ç²å–æ‰€æœ‰å•†å“å’Œæ‰€æœ‰åˆ†é¡
    const [allProducts, allCategories] = await Promise.all([
        db.shoppingProducts.toArray(),
        db.shoppingCategories.orderBy('name').toArray()
    ]);

    shoppingScreen.classList.toggle('management-mode', isProductManagementMode);

    // 2. æ¸²æŸ“åˆ†é¡é ç°½
    const allTab = document.createElement('button');
    allTab.className = 'product-category-tab'; // ä½¿ç”¨æ–°çš„CSSé¡å
    allTab.textContent = 'å…¨éƒ¨';
    allTab.dataset.categoryId = 'all';
    if (activeShoppingCategoryId === 'all') allTab.classList.add('active');
    tabsContainer.appendChild(allTab);

    allCategories.forEach(cat => {
        const tab = document.createElement('button');
        tab.className = 'product-category-tab'; // ä½¿ç”¨æ–°çš„CSSé¡å
        tab.textContent = cat.name;
        tab.dataset.categoryId = cat.id;
        if (activeShoppingCategoryId === cat.id) tab.classList.add('active');
        tabsContainer.appendChild(tab);
    });
    
    // 3. æ ¹æ“šç•¶å‰é¸ä¸­çš„åˆ†é¡IDä¾†ç¯©é¸å•†å“
    let productsToShow;
    if (activeShoppingCategoryId === 'all') {
        productsToShow = allProducts;
    } else {
        productsToShow = allProducts.filter(p => p.categoryId === activeShoppingCategoryId);
    }
    
    // 4. æ¸²æŸ“å•†å“åˆ—è¡¨
    if (productsToShow.length === 0) {
        const message = activeShoppingCategoryId === 'all' 
            ? 'å•†åº—ç©ºç©ºå¦‚ä¹Ÿï¼Œé»æ“Šâ€œç®¡ç†â€æ·»åŠ å•†å“å§ï¼'
            : 'é€™å€‹åˆ†é¡ä¸‹é‚„æ²’æœ‰å•†å“å“¦~';
        gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
        return;
    }

    productsToShow.forEach(product => {
        const item = document.createElement('div');
        item.className = 'product-item';
        item.dataset.id = product.id;
        
        const managementControls = isProductManagementMode ? `
            <div class="product-management-overlay">
                <button class="edit-product-btn">ç·¨è¼¯</button>
                <button class="delete-product-btn">åˆªé™¤</button>
            </div>
        ` : '';

        item.innerHTML = `
            ${managementControls}
            <img src="${product.imageUrl}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-footer">
                    <div class="product-price">${product.price.toFixed(2)}</div>
                    <button class="add-to-cart-btn">åŠ å…¥è³¼ç‰©è»Š</button>
                </div>
            </div>
        `;
        gridEl.appendChild(item);
    });
}
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        /**
         * å°‡å•†å“åŠ å…¥è³¼ç‰©è»Š (V4.0)
         */
        async function addToCart(productId, quantity = 1, variation = null) {
            // å¦‚æœæœ‰æ¬¾å¼ï¼Œå°±æ ¹æ“šæ¬¾å¼åä¾†åˆ¤æ–·æ˜¯å¦å·²å­˜åœ¨
            const existingItem = variation
                ? shoppingCart.find(item => item.productId === productId && item.variation?.name === variation.name)
                : shoppingCart.find(item => item.productId === productId && !item.variation);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const product = await db.shoppingProducts.get(productId);
                if (product) {
                    shoppingCart.push({ productId: product.id, quantity: quantity, variation: variation });
                }
            }
            updateCartCount();
        }
        
        /**
         * æ›´æ–°è³¼ç‰©è»Šå•†å“æ•¸é‡
         */
        function updateCartItemQuantity(productId, change) {
            const itemIndex = shoppingCart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                shoppingCart[itemIndex].quantity += change;
                if (shoppingCart[itemIndex].quantity <= 0) {
                    shoppingCart.splice(itemIndex, 1);
                }
                updateCartCount();
                renderCartItems();
            }
        }
        
        /**
         * æ›´æ–°è³¼ç‰©è»Šåœ–ç¤ºå’Œçµç®—æŒ‰éˆ•ä¸Šçš„æ•¸é‡
         */
        function updateCartCount() {
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
            document.getElementById('cart-title').textContent = `è³¼ç‰©è»Š(${totalItems})`;
            document.getElementById('checkout-btn').textContent = `çµç®—(${totalItems})`;
        }
        
        /**
         * æ‰“é–‹è³¼ç‰©è»Šé é¢
         */
        function openCartScreen() {
            renderCartItems();
            showScreen('cart-screen');
        }
        
// â–¼â–¼â–¼ ã€V2.0 | æ”¯æ´é¡¯ç¤ºæ¬¾å¼ã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ renderCartItems å‡½æ•¸ â–¼â–¼â–¼
        /**
         * æ¸²æŸ“è³¼ç‰©è»Šå…§çš„å•†å“åˆ—è¡¨ (V4.0)
         */
        async function renderCartItems() {
            const listEl = document.getElementById('cart-items-list');
            listEl.innerHTML = '';
            let total = 0;
        
            if (shoppingCart.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">è³¼ç‰©è»Šæ˜¯ç©ºçš„å“¦~</p>';
            } else {
                const productIds = shoppingCart.map(item => item.productId);
                const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
                const productMap = new Map(products.map(p => [p.id, p]));
        
                shoppingCart.forEach(item => {
                    const product = productMap.get(item.productId);
                    if (product) {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'cart-item';
                        
                        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœè³¼ç‰©è»Šå°ˆæ¡ˆæœ‰æ¬¾å¼è³‡è¨Šï¼Œå°±ç”Ÿæˆä¸€å€‹é¡¯ç¤ºå®ƒçš„HTML
                        const variationHtml = item.variation
                            ? `<div class="cart-item-variation" style="font-size: 12px; color: #8a8a8a; margin-top: 4px;">æ¬¾å¼: ${item.variation.name}</div>`
                            : '';
                        
                        itemEl.innerHTML = `
                            <input type="checkbox" class="cart-item-checkbox" data-id="${product.id}" checked>
                            <img src="${item.variation?.imageUrl || product.imageUrl}" class="cart-item-image">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${product.name}</div>
                                ${variationHtml}
                                <div class="cart-item-footer">
                                    <div class="cart-item-price">Â¥${(item.variation?.price || product.price).toFixed(2)}</div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn decrease-qty-btn" data-id="${product.id}">-</button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn increase-qty-btn" data-id="${product.id}">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        listEl.appendChild(itemEl);
                    }
                });
            }
            updateCartTotal();
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * æ›´æ–°è³¼ç‰©è»Šç¸½åƒ¹
         */
        async function updateCartTotal() {
            let total = 0;
            const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            const selectedProductIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
        
            if (selectedProductIds.length > 0) {
                const products = await db.shoppingProducts.where('id').anyOf(selectedProductIds).toArray();
                const productMap = new Map(products.map(p => [p.id, p]));
                
                shoppingCart.forEach(cartItem => {
                    if (selectedProductIds.includes(cartItem.productId)) {
                        const product = productMap.get(cartItem.productId);
                        if (product) {
                            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å„ªå…ˆä½¿ç”¨æ¬¾å¼çš„åƒ¹æ ¼
                            const price = cartItem.variation ? cartItem.variation.price : product.price;
                            total += price * cartItem.quantity;
                        }
                    }
                });
            }
            document.getElementById('cart-total').textContent = `åˆè¨ˆ: Â¥${total.toFixed(2)}`;
        }
        
        /* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ handleCheckout å’Œ sendGiftMessage å‡½æ•¸ï¼Œä¸¦æ·»åŠ æ–°å‡½æ•¸ â–¼â–¼â–¼ */
        
        /**
         * ã€å…¨æ–°ã€‘æ‰“é–‹ç¦®ç‰©æ¥æ”¶äººé¸æ“‡å½ˆçª—
         */
        async function openGiftRecipientPicker() {
            const chat = state.chats[state.activeChatId];
            if (!chat || !chat.isGroup) return;
        
            const modal = document.getElementById('gift-recipient-modal');
            const listEl = document.getElementById('gift-recipient-list');
            listEl.innerHTML = '';
        
            // ç¯©é¸å‡ºé™¤ç”¨æˆ¶å¤–çš„æ‰€æœ‰ç¾¤æˆå“¡
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            const members = chat.members.filter(m => m.groupNickname !== myNickname);
        
            members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'contact-picker-item';
                // ã€æ ¸å¿ƒã€‘æˆ‘å€‘å°‡ä½¿ç”¨ originalName ä½œç‚ºå”¯ä¸€æ¨™è­˜
                item.dataset.recipientName = member.originalName; 
        
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${member.avatar || defaultGroupMemberAvatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                `;
                listEl.appendChild(item);
            });
            
            // é‡ç½®å…¨é¸æ¡†
            document.getElementById('select-all-recipients').checked = false;
            modal.classList.add('visible');
        }
        
        /* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šæ–°ä»£ç¢¼æ›¿æ›èˆŠçš„ handleCheckout å’Œ sendGiftMessage å‡½æ•¸ â–¼â–¼â–¼ */
        
        /**
         * ã€é‡æ§‹ç‰ˆã€‘è™•ç†çµç®—æŒ‰éˆ•é»æ“Šï¼Œæ ¹æ“šèŠå¤©é¡å‹åˆ†æµ
         */
        async function handleCheckout() {
            const chat = state.chats[state.activeChatId];
            const selectedItems = shoppingCart.filter(item => 
                document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
            );
            if (selectedItems.length === 0) {
                alert("è«‹å…ˆåœ¨è³¼ç‰©è»Šä¸­é¸æ“‡è¦çµç®—çš„å•†å“ã€‚");
                return;
            }
        
            if (chat.isGroup) {
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œæ‰“é–‹æ”¶ç¦®äººé¸æ“‡å™¨
                openGiftRecipientPicker();
            } else {
                // å¦‚æœæ˜¯å–®èŠï¼Œç›´æ¥ç™¼é€
                const confirmed = await showCustomConfirm( 'ç¢ºèªé€å‡ºç¦®ç‰©', `ç¢ºå®šè¦å°‡é¸ä¸­çš„å•†å“ä½œç‚ºç¦®ç‰©é€å‡ºå—ï¼Ÿ`, { confirmText: 'é€å‡ºç¦®ç‰©' });
                if (confirmed) {
                    await sendGiftMessage(selectedItems); // å–®èŠä¸éœ€è¦æŒ‡å®šæ”¶ç¦®äºº
                }
            }
        }
        
        /**
         * ã€å‡ç´šç‰ˆã€‘ç™¼é€ç¦®ç‰©å¡ç‰‡æ¶ˆæ¯ï¼Œç¾åœ¨æ”¯æ´æŒ‡å®šæ”¶ç¦®äºº
         * @param {Array} itemsToSend - è¦ç™¼é€çš„å•†å“é™£åˆ—
         * @param {Array|null} recipients - æ”¶ç¦®äººæœ¬å(originalName)çš„é™£åˆ—ï¼Œå–®èŠæ™‚ç‚ºnull
         */
        async function sendGiftMessage(itemsToSend, recipients = null) {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            
            const productIds = itemsToSend.map(item => item.productId);
            const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
            const productMap = new Map(products.map(p => [p.id, p]));
            
const itemsForMessage = itemsToSend.map(cartItem => {
    const product = productMap.get(cartItem.productId);
    if (cartItem.variation) {
        // å¦‚æœè³¼ç‰©è»Šå°ˆæ¡ˆåŒ…å«æ¬¾å¼è³‡è¨Šï¼Œå‰‡å„ªå…ˆä½¿ç”¨æ¬¾å¼çš„è©³æƒ…
        return {
            name: `${product.name} - ${cartItem.variation.name}`, // å°‡å•†å“åå’Œæ¬¾å¼åçµ„åˆï¼Œä¾‹å¦‚ "é®®èŠ± - ç´…è‰²"
            price: cartItem.variation.price,
            imageUrl: cartItem.variation.imageUrl || product.imageUrl, // å„ªå…ˆä½¿ç”¨æ¬¾å¼åœ–ç‰‡ï¼Œå¦‚æœæ²’æœ‰å‰‡ç”¨ä¸»åœ–
            quantity: cartItem.quantity
        };
    } else {
        // å¦‚æœæ²’æœ‰æ¬¾å¼è³‡è¨Šï¼Œå‰‡ä½¿ç”¨å•†å“çš„åŸºç¤è©³æƒ…
        return {
            name: product.name,
            price: product.price,
            imageUrl: product.imageUrl,
            quantity: cartItem.quantity
        };
    }
});
            const giftMessage = {
                role: 'user', type: 'gift', timestamp: Date.now(),
                items: itemsForMessage,
                total: itemsForMessage.reduce((sum, item) => sum + item.price * item.quantity, 0),
                recipients: recipients // å°‡æ”¶ç¦®äººè³‡è¨Šå­˜å…¥æ¶ˆæ¯
            };
            
            chat.history.push(giftMessage);
        
            // ç‚ºAIç”ŸæˆåŒ…å«æ”¶ç¦®äººè³‡è¨Šçš„éš±è—æç¤º
            if (recipients && recipients.length > 0) {
                const recipientDisplayNames = recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('ã€');
                const hiddenMessage = {
                    role: 'system',
                    content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶ (${chat.settings.myNickname || 'æˆ‘'}) é€å‡ºäº†ä¸€ä»½ç¦®ç‰©ï¼Œæ”¶ç¦®äººæ˜¯ï¼š${recipientDisplayNames}ã€‚è«‹æ”¶ç¦®çš„è§’è‰²è¡¨ç¤ºæ„Ÿè¬ï¼Œå…¶ä»–è§’è‰²å¯ä»¥è‡ªç”±ç™¼æ®ã€‚]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
            }
        
            await db.chats.put(chat);
            
            appendMessage(giftMessage, chat);
            renderChatList();
            
            // å¾è³¼ç‰©è»Šä¸­ç§»é™¤å·²çµç®—çš„å•†å“
            shoppingCart = shoppingCart.filter(item => !itemsToSend.some(sent => sent.productId === item.productId));
            updateCartCount();
            showScreen('chat-interface-screen');
            
            await showCustomAlert('æˆåŠŸ', 'ç¦®ç‰©å·²æˆåŠŸé€å‡ºï¼');
        }
        
        /* â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² */
        
        
        /**
         * é¡¯ç¤ºè³¼ç‰©å°ç¥¨
         */
        function showGiftReceipt(timestamp) {
            // ... (æ­¤å‡½æ•¸é‚è¼¯ä¸è®Š, ä¿æŒåŸæ¨£å³å¯)
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'gift') return;
            const receiptBody = document.getElementById('gift-receipt-body');
            let itemsHtml = '';
            message.items.forEach(item => {
                itemsHtml += `<tr><td class="item-name">${item.name}</td><td class="item-qty">${item.quantity}</td><td class="item-price">Â¥${item.price.toFixed(2)}</td><td class="item-subtotal">Â¥${(item.price * item.quantity).toFixed(2)}</td></tr>`;
            });
            receiptBody.innerHTML = `<div class="receipt-header"><h3>è³¼ç‰©ä¸­å¿ƒ</h3><p>äº¤æ˜“æ™‚é–“: ${new Date(message.timestamp).toLocaleString()}</p></div><table class="receipt-items-table"><thead><tr><th class="item-name">å•†å“</th><th class="item-qty">æ•¸é‡</th><th class="item-price">å–®åƒ¹</th><th class="item-subtotal">å°è¨ˆ</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="receipt-total">ç¸½è¨ˆ: Â¥${message.total.toFixed(2)}</div><div class="receipt-footer">æ„Ÿè¬æ‚¨çš„æƒ é¡§ï¼Œæ­¡è¿å†æ¬¡å…‰è‡¨ï¼</div>`;
            document.getElementById('gift-receipt-modal').classList.add('visible');
        }
        
        /**
         * å•†å“ç®¡ç†ç›¸é—œå‡½æ•¸
         */
        async function openProductEditor(productId = null) {
            editingProductId = productId;
            const modal = document.getElementById('product-editor-modal');
            const title = document.getElementById('product-editor-title');
            const nameInput = document.getElementById('product-name-input');
            const priceInput = document.getElementById('product-price-input');
            const descInput = document.getElementById('product-description-input');
            const imagePreview = document.getElementById('product-image-preview');
            const categorySelect = document.getElementById('product-category-select');
            const variationsContainer = document.getElementById('product-variations-container');
            
            // æ¸…ç©ºèˆŠå…§å®¹
            variationsContainer.innerHTML = '';
            
            // è¼‰å…¥åˆ†é¡
            categorySelect.innerHTML = '<option value="">-- æœªåˆ†é¡ --</option>';
            const categories = await db.shoppingCategories.toArray();
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });

            if (productId) {
                title.textContent = 'ç·¨è¼¯å•†å“';
                const product = await db.shoppingProducts.get(productId);
                nameInput.value = product.name;
                priceInput.value = product.price;
                descInput.value = product.description || '';
                imagePreview.src = product.imageUrl;
                categorySelect.value = product.categoryId || '';
                
                // è¼‰å…¥å·²æœ‰æ¬¾å¼
                if (product.variations && product.variations.length > 0) {
                    product.variations.forEach(v => addProductVariationInput(v));
                }

            } else {
                title.textContent = 'æ·»åŠ å•†å“';
                nameInput.value = '';
                priceInput.value = '';
                descInput.value = '';
                imagePreview.src = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg';
                categorySelect.value = '';
            }
            modal.classList.add('visible');
        }
        async function saveProduct() {
            const name = document.getElementById('product-name-input').value.trim();
            const price = parseFloat(document.getElementById('product-price-input').value);
            const description = document.getElementById('product-description-input').value.trim();
            const imageUrl = document.getElementById('product-image-preview').src;
            const categoryId = parseInt(document.getElementById('product-category-select').value) || null;

            if (!name) { alert('å•†å“åç¨±ä¸èƒ½ç‚ºç©ºï¼'); return; }
            if (isNaN(price) || price < 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é»˜èªåƒ¹æ ¼ï¼'); return; }

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ”¶é›†æ‰€æœ‰æ¬¾å¼è³‡è¨Š
            const variations = [];
            document.querySelectorAll('.variation-block').forEach(block => {
                const varName = block.querySelector('.variation-name-input').value.trim();
                const varPrice = parseFloat(block.querySelector('.variation-price-input').value);
                const varImageUrl = block.querySelector('.variation-image-preview').src;

                if (varName && !isNaN(varPrice) && varPrice >= 0) {
                    variations.push({
                        name: varName,
                        price: varPrice,
                        imageUrl: varImageUrl.includes('placeholder.png') ? null : varImageUrl
                    });
                }
            });

            const productData = { name, price, description, imageUrl, categoryId, variations };
            
            if (editingProductId) {
                await db.shoppingProducts.update(editingProductId, productData);
            } else {
                await db.shoppingProducts.add(productData);
            }
            document.getElementById('product-editor-modal').classList.remove('visible');
            await renderShoppingProducts();
        }
        // â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ¸²æŸ“è¦å‰‡åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ‰“é–‹æ¸²æŸ“è¦å‰‡ç®¡ç†è¢å¹•
         */
        async function openRenderingRulesScreen() {
            await renderRulesList();
            showScreen('rendering-rules-screen');
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ renderRulesList å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€é‡æ§‹ç‰ˆã€‘æ¸²æŸ“è¦å‰‡æ¸…å–®ï¼Œä½¿ç”¨é ç°½å’Œå¡ç‰‡ä½ˆå±€
         */
        async function renderRulesList() {
            const tabsContainer = document.getElementById('rules-tabs');
            const contentContainer = document.getElementById('rules-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            const allRules = await db.renderingRules.toArray();
        
            if (allRules.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">é‚„æ²’æœ‰ä»»ä½•æ¸²æŸ“è¦å‰‡ã€‚é»æ“Šå³ä¸Šè§’â€œ+â€å‰µå»ºç¬¬ä¸€å€‹å§ï¼</p>';
                return;
            }
        
            // --- 1. å‰µå»ºä¸¦æ·»åŠ â€œå…¬ç”¨â€é ç°½å’Œå…¶å…§å®¹é¢æ¿ ---
            const globalTab = document.createElement('button');
            globalTab.className = 'rules-tab active'; // é»˜èªå•Ÿå‹•
            globalTab.textContent = 'å…¬ç”¨è¦å‰‡';
            globalTab.dataset.categoryId = 'global';
            tabsContainer.appendChild(globalTab);
        
            const globalPane = document.createElement('div');
            globalPane.className = 'rules-category-pane active';
            globalPane.dataset.categoryId = 'global';
            contentContainer.appendChild(globalPane);
        
            // --- 2. å‹•æ…‹å‰µå»ºè§’è‰²å°ˆå±¬çš„é ç°½å’Œå…§å®¹é¢æ¿ ---
            const characterChatsWithRules = Object.values(state.chats).filter(chat => 
                !chat.isGroup && allRules.some(r => r.chatId === chat.id)
            );
        
            characterChatsWithRules.forEach(chat => {
                const charTab = document.createElement('button');
                charTab.className = 'rules-tab';
                charTab.textContent = chat.name;
                charTab.dataset.categoryId = chat.id;
                tabsContainer.appendChild(charTab);
        
                const charPane = document.createElement('div');
                charPane.className = 'rules-category-pane';
                charPane.dataset.categoryId = chat.id;
                contentContainer.appendChild(charPane);
            });
            
            // --- 3. éæ­·æ‰€æœ‰è¦å‰‡ï¼Œå°‡å®ƒå€‘å¡«å……åˆ°å°æ‡‰çš„å…§å®¹é¢æ¿ä¸­ ---
            allRules.forEach(rule => {
                const card = createRuleItemElement(rule);
                const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${rule.chatId}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 4. ç‚ºæ‰€æœ‰é ç°½ç¶å®šåˆ‡æ›äº‹ä»¶ ---
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ createRuleItemElement å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€é‡æ§‹ç‰ˆã€‘å‰µå»ºå–®å€‹è¦å‰‡çš„å¡ç‰‡DOMå…ƒç´ 
         */
        function createRuleItemElement(rule) {
            const card = document.createElement('div');
            // æ ¹æ“šæ˜¯å¦å•Ÿç”¨ï¼Œæ·»åŠ ä¸åŒçš„class
            card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''}`;
            card.dataset.ruleId = rule.id;
        
            card.innerHTML = `
                <div class="card-title">${rule.name}</div>
                <div class="card-content-preview">${rule.regex}</div>
            `;
            
            // é»æ“Šç·¨è¼¯ï¼Œé•·æŒ‰åˆªé™¤ (é‚è¼¯ä¸è®Š)
            card.addEventListener('click', () => openRuleEditor(rule.id));
            addLongPressListener(card, () => deleteRenderingRule(rule.id));
        
            return card;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        /**
         * æ‰“é–‹è¦å‰‡ç·¨è¼¯å™¨ (ç”¨æ–¼æ–°å»ºæˆ–ç·¨è¼¯)
         */
        async function openRuleEditor(ruleId = null) {
            editingRuleId = ruleId;
            const modal = document.getElementById('rule-editor-modal');
            const title = document.getElementById('rule-editor-title');
            const nameInput = document.getElementById('rule-name-input');
            const chatIdSelect = document.getElementById('rule-chat-id-select');
            const regexInput = document.getElementById('rule-regex-input');
            const templateInput = document.getElementById('rule-template-input');
            const enabledSwitch = document.getElementById('rule-enabled-switch');
        
            // å¡«å……è§’è‰²ä¸‹æ‹‰æ¸…å–®
            chatIdSelect.innerHTML = '<option value="global">å…¬ç”¨ (æ‰€æœ‰è§’è‰²)</option>';
            Object.values(state.chats).filter(c => !c.isGroup).forEach(chat => {
                chatIdSelect.innerHTML += `<option value="${chat.id}">${chat.name}</option>`;
            });
        
            if (ruleId) {
                title.textContent = 'ç·¨è¼¯è¦å‰‡';
                const rule = await db.renderingRules.get(ruleId);
                nameInput.value = rule.name;
                chatIdSelect.value = rule.chatId;
                regexInput.value = rule.regex;
                templateInput.value = rule.template;
                enabledSwitch.checked = rule.isEnabled;
            } else {
                title.textContent = 'å‰µå»ºæ–°è¦å‰‡';
                nameInput.value = '';
                chatIdSelect.value = 'global';
                regexInput.value = '';
                templateInput.value = '';
                enabledSwitch.checked = true;
            }
        
            modal.classList.add('visible');
        }
        
        /**
         * ä¿å­˜æ¸²æŸ“è¦å‰‡
         */
        async function saveRenderingRule() {
            const name = document.getElementById('rule-name-input').value.trim();
            const regex = document.getElementById('rule-regex-input').value.trim();
            if (!name || !regex) {
                alert("è¦å‰‡åç¨±å’Œè¦å‰‡é‹ç®—å¼ä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
            try {
                new RegExp(regex);
            } catch (e) {
                alert(`è¦å‰‡é‹ç®—å¼æ ¼å¼éŒ¯èª¤: ${e.message}`);
                return;
            }
        
            const ruleData = {
                name: name,
                chatId: document.getElementById('rule-chat-id-select').value,
                regex: regex,
                template: document.getElementById('rule-template-input').value,
                isEnabled: document.getElementById('rule-enabled-switch').checked
            };
        
            if (editingRuleId) {
                await db.renderingRules.update(editingRuleId, ruleData);
            } else {
                await db.renderingRules.add(ruleData);
            }
        
            document.getElementById('rule-editor-modal').classList.remove('visible');
            await renderRulesList();
        }
        
        /**
         * åˆªé™¤æ¸²æŸ“è¦å‰‡
         */
        async function deleteRenderingRule(ruleId) {
            const confirmed = await showCustomConfirm('åˆªé™¤è¦å‰‡', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢æ¸²æŸ“è¦å‰‡å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.renderingRules.delete(ruleId);
                await renderRulesList();
            }
        }
        
        /**
         * ã€æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸ã€‘æ‡‰ç”¨æ‰€æœ‰åŒ¹é…çš„æ¸²æŸ“è¦å‰‡
         * @param {string} rawContent - AIè¿”å›çš„åŸå§‹æ–‡æœ¬
         * @param {string} chatId - ç•¶å‰èŠå¤©çš„ID
         * @returns {Promise<string>} - è™•ç†å¾Œçš„HTMLå­—ä¸²
         */
        async function applyRenderingRules(rawContent, chatId) {
            // å¦‚æœå…§å®¹æœ¬èº«å·²ç¶“æ˜¯HTMLæ¨™ç±¤ï¼Œæˆ–è€…ä¸å«å¯èƒ½æ˜¯â€œæš—è™Ÿâ€çš„å­—å…ƒï¼Œç›´æ¥è¿”å›ï¼Œæé«˜æ€§èƒ½
            if (rawContent.trim().startsWith('<') || (!rawContent.includes('[') && !rawContent.includes('{'))) {
                return rawContent;
            }
            
            // ç²å–æ‰€æœ‰å…¬ç”¨è¦å‰‡å’Œç•¶å‰è§’è‰²å°ˆå±¬çš„è¦å‰‡
            const applicableRules = await db.renderingRules
                .where('chatId').equals('global')
                .or('chatId').equals(chatId)
                .toArray();
        
            let processedContent = rawContent;
            
            // åªè™•ç†å•Ÿç”¨çš„è¦å‰‡
            for (const rule of applicableRules.filter(r => r.isEnabled)) {
                try {
                    // 'g'æ¨™èªŒæ˜¯å¿…é ˆçš„ï¼Œç”¨æ–¼å…¨åŸŸæ›¿æ›
                    const regex = new RegExp(rule.regex, 'g');
                    if (regex.test(processedContent)) {
                        processedContent = processedContent.replace(regex, rule.template);
                    }
                } catch (e) {
                    console.error(`æ¸²æŸ“è¦å‰‡ [${rule.name}] çš„è¦å‰‡é‹ç®—å¼ç„¡æ•ˆ:`, e);
                    // è·³ééŒ¯èª¤çš„è¦å‰‡ï¼Œä¸ä¸­æ–·æ¸²æŸ“æµç¨‹
                }
            }
            
            return processedContent;
        }
        
        // â–²â–²â–² æ ¸å¿ƒJSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ¸²æŸ“è¦å‰‡åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼åˆ° async function init() çš„ä¸Šæ–¹ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ‰“é–‹æ¸²æŸ“è¦å‰‡ç®¡ç†è¢å¹•
         */
        async function openRenderingRulesScreen() {
            await renderRulesList();
            showScreen('rendering-rules-screen');
        }
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ renderRulesList å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€é‡æ§‹ç‰ˆã€‘æ¸²æŸ“è¦å‰‡æ¸…å–®ï¼Œä½¿ç”¨é ç°½å’Œå¡ç‰‡ä½ˆå±€
         */
        async function renderRulesList() {
            const tabsContainer = document.getElementById('rules-tabs');
            const contentContainer = document.getElementById('rules-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            const allRules = await db.renderingRules.toArray();
        
            if (allRules.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">é‚„æ²’æœ‰ä»»ä½•æ¸²æŸ“è¦å‰‡ã€‚é»æ“Šå³ä¸Šè§’â€œ+â€å‰µå»ºç¬¬ä¸€å€‹å§ï¼</p>';
                return;
            }
        
            // --- 1. å‰µå»ºä¸¦æ·»åŠ â€œå…¬ç”¨â€é ç°½å’Œå…¶å…§å®¹é¢æ¿ ---
            const globalTab = document.createElement('button');
            globalTab.className = 'rules-tab active'; // é»˜èªå•Ÿå‹•
            globalTab.textContent = 'å…¬ç”¨è¦å‰‡';
            globalTab.dataset.categoryId = 'global';
            tabsContainer.appendChild(globalTab);
        
            const globalPane = document.createElement('div');
            globalPane.className = 'rules-category-pane active';
            globalPane.dataset.categoryId = 'global';
            contentContainer.appendChild(globalPane);
        
            // --- 2. å‹•æ…‹å‰µå»ºè§’è‰²å°ˆå±¬çš„é ç°½å’Œå…§å®¹é¢æ¿ ---
            const characterChatsWithRules = Object.values(state.chats).filter(chat => 
                !chat.isGroup && allRules.some(r => r.chatId === chat.id)
            );
        
            characterChatsWithRules.forEach(chat => {
                const charTab = document.createElement('button');
                charTab.className = 'rules-tab';
                charTab.textContent = chat.name;
                charTab.dataset.categoryId = chat.id;
                tabsContainer.appendChild(charTab);
        
                const charPane = document.createElement('div');
                charPane.className = 'rules-category-pane';
                charPane.dataset.categoryId = chat.id;
                contentContainer.appendChild(charPane);
            });
            
            // --- 3. éæ­·æ‰€æœ‰è¦å‰‡ï¼Œå°‡å®ƒå€‘å¡«å……åˆ°å°æ‡‰çš„å…§å®¹é¢æ¿ä¸­ ---
            allRules.forEach(rule => {
                const card = createRuleItemElement(rule);
                const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${rule.chatId}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 4. ç‚ºæ‰€æœ‰é ç°½ç¶å®šåˆ‡æ›äº‹ä»¶ ---
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ createRuleItemElement å‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * ã€é‡æ§‹ç‰ˆã€‘å‰µå»ºå–®å€‹è¦å‰‡çš„å¡ç‰‡DOMå…ƒç´ 
         */
        function createRuleItemElement(rule) {
            const card = document.createElement('div');
            // æ ¹æ“šæ˜¯å¦å•Ÿç”¨ï¼Œæ·»åŠ ä¸åŒçš„class
            card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''}`;
            card.dataset.ruleId = rule.id;
        
            card.innerHTML = `
                <div class="card-title">${rule.name}</div>
                <div class="card-content-preview">${rule.regex}</div>
            `;
            
            // é»æ“Šç·¨è¼¯ï¼Œé•·æŒ‰åˆªé™¤ (é‚è¼¯ä¸è®Š)
            card.addEventListener('click', () => openRuleEditor(rule.id));
            addLongPressListener(card, () => deleteRenderingRule(rule.id));
        
            return card;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        /**
         * æ‰“é–‹è¦å‰‡ç·¨è¼¯å™¨ (ç”¨æ–¼æ–°å»ºæˆ–ç·¨è¼¯)
         */
        async function openRuleEditor(ruleId = null) {
            editingRuleId = ruleId;
            const modal = document.getElementById('rule-editor-modal');
            const title = document.getElementById('rule-editor-title');
            const nameInput = document.getElementById('rule-name-input');
            const chatIdSelect = document.getElementById('rule-chat-id-select');
            const regexInput = document.getElementById('rule-regex-input');
            const templateInput = document.getElementById('rule-template-input');
            const enabledSwitch = document.getElementById('rule-enabled-switch');
        
            // å¡«å……è§’è‰²ä¸‹æ‹‰æ¸…å–®
            chatIdSelect.innerHTML = '<option value="global">å…¬ç”¨ (æ‰€æœ‰è§’è‰²)</option>';
            Object.values(state.chats).filter(c => !c.isGroup).forEach(chat => {
                chatIdSelect.innerHTML += `<option value="${chat.id}">${chat.name}</option>`;
            });
        
            if (ruleId) {
                title.textContent = 'ç·¨è¼¯è¦å‰‡';
                const rule = await db.renderingRules.get(ruleId);
                nameInput.value = rule.name;
                chatIdSelect.value = rule.chatId;
                regexInput.value = rule.regex;
                templateInput.value = rule.template;
                enabledSwitch.checked = rule.isEnabled;
            } else {
                title.textContent = 'å‰µå»ºæ–°è¦å‰‡';
                nameInput.value = '';
                chatIdSelect.value = 'global';
                regexInput.value = '';
                templateInput.value = '';
                enabledSwitch.checked = true;
            }
        
            modal.classList.add('visible');
        }
        
        /**
         * ä¿å­˜æ¸²æŸ“è¦å‰‡
         */
        async function saveRenderingRule() {
            const name = document.getElementById('rule-name-input').value.trim();
            const regex = document.getElementById('rule-regex-input').value.trim();
            if (!name || !regex) {
                alert("è¦å‰‡åç¨±å’Œè¦å‰‡é‹ç®—å¼ä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
            try {
                new RegExp(regex);
            } catch (e) {
                alert(`è¦å‰‡é‹ç®—å¼æ ¼å¼éŒ¯èª¤: ${e.message}`);
                return;
            }
        
            const ruleData = {
                name: name,
                chatId: document.getElementById('rule-chat-id-select').value,
                regex: regex,
                template: document.getElementById('rule-template-input').value,
                isEnabled: document.getElementById('rule-enabled-switch').checked
            };
        
            if (editingRuleId) {
                await db.renderingRules.update(editingRuleId, ruleData);
            } else {
                await db.renderingRules.add(ruleData);
            }
        
            document.getElementById('rule-editor-modal').classList.remove('visible');
            await renderRulesList();
        }
        
        /**
         * åˆªé™¤æ¸²æŸ“è¦å‰‡
         */
        async function deleteRenderingRule(ruleId) {
            const confirmed = await showCustomConfirm('åˆªé™¤è¦å‰‡', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢æ¸²æŸ“è¦å‰‡å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.renderingRules.delete(ruleId);
                await renderRulesList();
            }
        }
        
        /**
         * ã€æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸ã€‘æ‡‰ç”¨æ‰€æœ‰åŒ¹é…çš„æ¸²æŸ“è¦å‰‡
         * @param {string} rawContent - AIè¿”å›çš„åŸå§‹æ–‡æœ¬
         * @param {string} chatId - ç•¶å‰èŠå¤©çš„ID
         * @returns {Promise<string>} - è™•ç†å¾Œçš„HTMLå­—ä¸²
         */
async function applyRenderingRules(rawContent, chatId) {
    // å¦‚æœå…§å®¹æ˜¯ç°¡å–®æ–‡æœ¬æˆ–HTMLï¼Œç›´æ¥è¿”å›ä»¥æé«˜æ€§èƒ½
    if (rawContent.trim().startsWith('<') || (!rawContent.includes('[') && !rawContent.includes('{'))) {
        return rawContent;
    }

    // --- æ ¸å¿ƒå„ªåŒ–ï¼šç·©å­˜é‚è¼¯ ---
    if (!ruleCache[chatId]) { // æª¢æŸ¥ç•¶å‰èŠå¤©çš„è¦å‰‡æ˜¯å¦å·²è¢«ç·©å­˜
        console.log(`Caching rendering rules for chat: ${chatId}`);
        // å¦‚æœæ²’æœ‰ï¼Œå°±å¾è³‡æ–™åº«æŸ¥è©¢ä¸€æ¬¡
        const applicableRules = await db.renderingRules
            .where('chatId').equals('global')
            .or('chatId').equals(chatId)
            .toArray();
        // å°‡æŸ¥è©¢çµæœå­˜å…¥ç·©å­˜ï¼Œä¸‹æ¬¡å°±ä¸ç”¨å†æŸ¥äº†
        ruleCache[chatId] = applicableRules.filter(r => r.isEnabled);
    }
    const rules = ruleCache[chatId]; // å¾ç·©å­˜ä¸­è®€å–è¦å‰‡
    // --- å„ªåŒ–çµæŸ ---

    let processedContent = rawContent;

    for (const rule of rules) {
        try {
            const regex = new RegExp(rule.regex, 'g');
            let testContent = processedContent; 
            if (regex.test(testContent)) {
                processedContent = processedContent.replace(regex, rule.template);
            }
        } catch (e) {
            console.error(`æ¸²æŸ“è¦å‰‡ [${rule.name}] çš„è¦å‰‡é‹ç®—å¼ç„¡æ•ˆ:`, e);
        }
    }

    return processedContent;
}
        
        // â–²â–²â–² æ ¸å¿ƒJSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘ç‚ºèŠå¤©ä¸­çš„ç³»çµ±æ™‚é–“æç¤ºæ ¼å¼åŒ–æ™‚é–“æˆ³è¨˜
         * @param {number} timestamp - æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
         * @returns {string} - æ ¼å¼åŒ–å¾Œçš„æ™‚é–“å­—ä¸²
         */
        function formatSystemTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);

            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;

            // å¦‚æœæ˜¯ä»Šå¤©
            if (now.toDateString() === date.toDateString()) {
                return timeString; // åªé¡¯ç¤º HH:mm
            }

            // å¦‚æœæ˜¯æ˜¨å¤©
            const yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            if (yesterday.toDateString() === date.toDateString()) {
                return `æ˜¨å¤© ${timeString}`;
            }
            
            // æ›´æ—©çš„æ™‚é–“
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            if (now.getFullYear() === year) {
                return `${month}æœˆ${day}æ—¥ ${timeString}`;
            } else {
                return `${year}å¹´${month}æœˆ${day}æ—¥ ${timeString}`;
            }
        }

        /**
         * ã€å…¨æ–°ã€‘å‰µå»ºç³»çµ±æ™‚é–“æç¤ºçš„DOMå…ƒç´ 
         * @param {number} timestamp - è¦é¡¯ç¤ºçš„æ™‚é–“æˆ³è¨˜
         * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
         */
        function createSystemTimestampElement(timestamp) {
            const wrapper = document.createElement('div');
            // è¤‡ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­æ¨£å¼ï¼Œéå¸¸æ–¹ä¾¿
            wrapper.className = 'message-wrapper system-pat'; 
            
            const bubble = document.createElement('div');
            // è¤‡ç”¨ç³»çµ±æ¶ˆæ¯çš„æ°£æ³¡æ¨£å¼
            bubble.className = 'message-bubble system-bubble'; 
            bubble.textContent = formatSystemTimestamp(timestamp);
            
            wrapper.appendChild(bubble);
            return wrapper;
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é‡æ–°ç”Ÿæˆå›å¾©åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œåœè§€æ¨¡å¼â€æ–°å¢çš„â€œé‡Rollâ€åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
/**
 * è™•ç†åœè§€æ¨¡å¼ä¸‹çš„â€œé‡Rollâ€è«‹æ±‚
 */
async function handleSpectatorReroll() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !lastResponseTimestamps || lastResponseTimestamps.length === 0) {
        alert("æ²’æœ‰å¯ä¾›é‡æ–°ç”Ÿæˆçš„AIå›æ‡‰ã€‚");
        return;
    }

    // 1. å¾èŠå¤©æ­·å²ä¸­ç§»é™¤ä¸Šä¸€è¼ªAIç”Ÿæˆçš„æ‰€æœ‰æ¶ˆæ¯
    chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));

    // 2. ä¿å­˜æ›´æ”¹ä¸¦åˆ·æ–°UI
    await db.chats.put(chat);
    await renderChatInterface(state.activeChatId);
    
    // 3. å†æ¬¡è§¸ç™¼AIå›æ‡‰
    triggerSpectatorGroupAiAction();
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²        
        /**
         * ã€ç¸½å…¥å£ã€‘è™•ç†èŠå¤©ä»‹é¢çš„â€œé‡æ–°ç”Ÿæˆâ€è«‹æ±‚
         */
        async function handleRegenerateResponse() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 1. æ‰¾åˆ°æœ€å¾Œä¸€æ¢ä½¿ç”¨è€…æ¶ˆæ¯çš„ä½ç½®
            const lastUserMsgIndex = chat.history.findLastIndex(msg => msg.role === 'user' && !msg.isHidden);
        
            if (lastUserMsgIndex === -1) {
                alert("æ²’æœ‰å¯ä¾›é‡æ–°ç”Ÿæˆå›å¾©çš„ä½¿ç”¨è€…æ¶ˆæ¯ã€‚");
                return;
            }
        
            // 2. æª¢æŸ¥AIæ˜¯å¦å·²ç¶“å°æœ€å¾Œä¸€æ¢ä½¿ç”¨è€…æ¶ˆæ¯åšå‡ºäº†å›æ‡‰
            const lastAiMsgIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
            if (lastAiMsgIndex < lastUserMsgIndex) {
                alert("AI å°šæœªå°æ‚¨çš„æœ€å¾Œä¸€æ¢æ¶ˆæ¯åšå‡ºå›æ‡‰ï¼Œç„¡æ³•é‡æ–°ç”Ÿæˆã€‚");
                return;
            }
        
            // 3. åˆªé™¤æœ€å¾Œä¸€æ¢ä½¿ç”¨è€…æ¶ˆæ¯ä¹‹å¾Œçš„æ‰€æœ‰å…§å®¹ï¼ˆå³AIçš„ä¸Šä¸€è¼ªå®Œæ•´å›å¾©ï¼‰
            chat.history.splice(lastUserMsgIndex + 1);
        
            // 4. ä¿å­˜æ›´æ”¹ä¸¦åˆ·æ–°UI
            await db.chats.put(chat);
            await renderChatInterface(state.activeChatId);
            
            // 5. å†æ¬¡è§¸ç™¼AIå›æ‡‰
            triggerAiResponse();
        }
        
        /**
         * ã€ç¸½å…¥å£ã€‘è™•ç†é€šè©±ä»‹é¢çš„â€œé‡æ–°ç”Ÿæˆâ€è«‹æ±‚
         */
        async function handleRegenerateCallResponse() {
            if (!videoCallState.isActive) return;
        
            // 1. æ‰¾åˆ°é€šè©±æ­·å²ä¸­æœ€å¾Œä¸€æ¢ç”¨æˆ¶ç™¼è¨€çš„ä½ç½®
            const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(msg => msg.role === 'user');
        
            if (lastUserSpeechIndex === -1) {
                alert("é€šè©±ä¸­é‚„æ²’æœ‰ä½ çš„ç™¼è¨€ï¼Œç„¡æ³•é‡æ–°ç”Ÿæˆå›æ‡‰ã€‚");
                return;
            }
        
            // 2. åˆªé™¤ç”¨æˆ¶ç™¼è¨€ä¹‹å¾Œçš„æ‰€æœ‰AIå›æ‡‰
            videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
        
            // 3. é‡æ–°æ¸²æŸ“é€šè©±ä»‹é¢ï¼Œç§»é™¤è¢«åˆªé™¤çš„æ°£æ³¡
            const callFeed = document.getElementById('video-call-main');
            callFeed.innerHTML = ''; // æ¸…ç©º
            videoCallState.callHistory.forEach(msg => {
                // è¤‡ç”¨å‰µå»ºæ°£æ³¡çš„é‚è¼¯
                const bubble = document.createElement('div');
                bubble.className = `call-message-bubble ${msg.role}-speech`;
                bubble.dataset.timestamp = msg.timestamp;
                if (msg.role === 'user') {
                    bubble.textContent = msg.content;
                } else {
                     bubble.innerHTML = msg.content;
                }
                addLongPressListener(bubble, () => showCallMessageActions(msg.timestamp));
                callFeed.appendChild(bubble);
            });
            callFeed.scrollTop = callFeed.scrollHeight;
        
            // 4. å†æ¬¡è§¸ç™¼AIåœ¨é€šè©±ä¸­çš„è¡Œå‹•
            triggerAiInCallAction(null); // å‚³å…¥nullè¡¨ç¤ºä¸æ˜¯ç”¨æˆ¶çš„æ–°è¼¸å…¥ï¼Œè€Œæ˜¯åŸºæ–¼ç¾æœ‰æ­·å²é‡è©¦
        }
        
        // â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¨é€²åŠ‡æƒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æœ€çµ‚ä¿®å¾©ç‰ˆã€‘å®Œæ•´æ›¿æ›èˆŠçš„ handlePropelAction å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€V4.0 | æŒ‡ä»¤åŒæ­¥ä¿®å¾©ç‰ˆã€‘è™•ç†èŠå¤©ä»‹é¢çš„â€œæ¨é€²â€è«‹æ±‚
 * - å°‡ç³»çµ±æŒ‡ä»¤èˆ‡ä¸»å›å¾©å‡½æ•¸ (triggerAiResponse) å®Œå…¨åŒæ­¥ï¼Œç¢ºä¿AIè¡Œç‚ºä¸€è‡´
 */
async function handlePropelAction() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // ç«‹å³é¡¯ç¤ºâ€œæ­£åœ¨è¼¸å…¥â€ç‹€æ…‹
    setAvatarActingState(chat.id, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    if (!chat.isGroup) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
            chatHeaderTitle.textContent = 'å°æ–¹æ­£åœ¨è¼¸å…¥...';
            chatHeaderTitle.classList.add('typing-status');
            chatHeaderTitle.style.opacity = 1;
        }, 200);
    }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®');
        }

        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        const now = new Date();
        const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
        const currentTime = chinaTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', dateStyle: 'full', timeStyle: 'short' });
        const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
        const myNickname = chat.settings.myNickname || 'æˆ‘';
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â˜…â˜…â˜…
        // ==========================================================
        // æˆ‘å€‘ä¸å†ä½¿ç”¨ç²¾ç°¡ç‰ˆçš„ propelSystemPromptï¼Œ
        // è€Œæ˜¯ç›´æ¥è¤‡ç”¨ triggerAiResponse å‡½æ•¸ä¸­é‚£å€‹å®Œæ•´ã€å¼·å¤§çš„ systemPromptã€‚
        // ç‚ºäº†æ–¹ä¾¿ï¼Œé€™è£¡ç›´æ¥å°‡é‚£æ®µé¾å¤§çš„æŒ‡ä»¤è¤‡è£½äº†éä¾†ã€‚
        // é€™æ®µä»£ç¢¼èˆ‡ triggerAiResponse ä¸­çš„æŒ‡ä»¤æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚
        
        // (é€™éƒ¨åˆ†è®Šæ•¸å®šç¾©çš„ä»£ç¢¼æ˜¯ç‚ºäº†è®“ä¸‹é¢çš„ systemPrompt èƒ½æ­£ç¢ºé‹è¡Œ)
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        let entryString = `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n`;
                        if (entry.keys.length > 0) entryString += `**é—œéµå­—:** ${entry.keys.join(', ')}\n`;
                        entryString += `**å…§å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');
                return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¨­å®š)\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chat.id) {
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            musicContext = `\n\n# ç•¶å‰éŸ³æ¨‚æƒ…æ™¯...\n(çœç•¥è©³ç´°å…§å®¹ï¼Œèˆ‡triggerAiResponseä¸€è‡´)`;
        }
        const gomokuContext = formatGomokuStateForAI(gomokuState[chat.id]);
        let nameHistoryContext = '';
        if (chat.nameHistory && chat.nameHistory.length > 0) {
            nameHistoryContext = `\n- **ä½ çš„æ›¾ç”¨å**: [${chat.nameHistory.join(', ')}]ã€‚ç•¶åœ¨å°è©±æ­·å²ä¸­çœ‹åˆ°é€™äº›åå­—æ™‚ï¼Œå®ƒå€‘éƒ½æŒ‡çš„æ˜¯ã€ä½ ã€‘è‡ªå·±ã€‚`;
        }
        let userProfileContext = '';
        const userQzoneNickname = state.qzoneSettings.nickname || 'ç”¨æˆ¶';
        userProfileContext += `- ç”¨æˆ¶çš„QZoneæ˜µç¨±æ˜¯ "${userQzoneNickname}"ã€‚\n`;
        const commonGroups = Object.values(state.chats).filter(group => group.isGroup && group.members.some(m => m.id === chat.id));
        if (commonGroups.length > 0) {
            userProfileContext += '- ç”¨æˆ¶åœ¨ä½ å€‘å…±åŒæ‰€åœ¨çš„ç¾¤èŠä¸­çš„æ˜µç¨±å¦‚ä¸‹ï¼š\n';
            commonGroups.forEach(group => {
                const myNicknameInGroup = group.settings.myNickname || userQzoneNickname; 
                userProfileContext += `  - åœ¨ç¾¤èŠâ€œ${group.name}â€ä¸­ï¼Œç”¨æˆ¶çš„æ˜µç¨±æ˜¯â€œ${myNicknameInGroup}â€ã€‚\n`;
            });
        }
        userProfileContext += 'ç•¶ä½ åœ¨ä»»ä½•ç³»çµ±æç¤ºã€å‹•æ…‹è©•è«–æˆ–æ›è¼‰çš„ç¾¤èŠè¨˜æ†¶ä¸­çœ‹åˆ°é€™äº›åå­—æ™‚ï¼Œå®ƒå€‘éƒ½æŒ‡ä»£çš„æ˜¯ã€ä½ çš„èŠå¤©ç‰©ä»¶ã€‘ã€‚';

        // é€™æ˜¯å®Œæ•´çš„ç³»çµ±æŒ‡ä»¤
        const systemPrompt = `
# èº«ä»½èˆ‡æ ¸å¿ƒä»»å‹™
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${chat.originalName}â€ï¼Œèˆ‡ä½¿ç”¨è€…ï¼ˆä½ çš„èŠå¤©å°è±¡ï¼‰é€²è¡Œä¸€å ´è‡ªç„¶çš„ã€ç”Ÿæ´»åŒ–çš„ç·šä¸ŠèŠå¤©ã€‚ä½ çš„æ‰€æœ‰è¡Œç‚ºå’Œæ±ºç­–éƒ½å¿…é ˆåš´æ ¼åœç¹ä½ çš„è§’è‰²è¨­å®šå±•é–‹ã€‚

# è¼¸å‡ºæ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
- ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
- é™£åˆ—ä¸­çš„ã€æ¯ä¸€å€‹å…ƒç´ éƒ½å¿…é ˆæ˜¯ä¸€å€‹å¸¶æœ‰ "type" æ¬„ä½çš„JSONç‰©ä»¶ã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè¦å‰‡
1.  **å°è©±ç¯€å¥**: æ¨¡æ“¬çœŸäººçš„èŠå¤©ç¿’æ…£ï¼Œå°‡ä½ æƒ³èªªçš„è©±æ‹†åˆ†æˆã€å¤šæ¢ã€ç°¡çŸ­çš„ã€‘æ¶ˆæ¯ã€‚æ¯æ¬¡å›å¾©è‡³å°‘3-8æ¢ï¼Œä¸”æ¢æ•¸ä¸è¦ç¸½æ˜¯ä¸€æ¨£ã€‚åš´ç¦ç™¼å±•ç·šä¸‹åŠ‡æƒ…ã€‚
2.  **æƒ…æ™¯æ„ŸçŸ¥**:
    - **æ™‚é–“**: ä½ å¿…é ˆæ„ŸçŸ¥åˆ°ç•¶å‰æ˜¯ ${currentTime} (${timeOfDayGreeting})ï¼Œä¸¦åœ¨å°è©±ä¸­è‡ªç„¶åœ°é«”ç¾å‡ºä¾†ã€‚
    - **éŸ³æ¨‚**: ${musicContext ? 'ä½ å€‘æ­£åœ¨ä¸€èµ·è½æ­Œï¼Œ' + musicContext : 'ä½ å€‘æ²’æœ‰åœ¨è½æ­Œã€‚'}

3.  **ä¸»å‹•æ€§**:
    - ä½ å¯ä»¥æ ¹æ“šå°è©±ç™¼å±•ï¼Œä½¿ç”¨æŒ‡ä»¤ä¾†æ›´æ–°è‡ªå·±çš„ç‹€æ…‹ã€æ›´æ›é ­åƒã€è¨˜éŒ„å›æ†¶ã€ç™¼èµ·ç´„å®šæˆ–åŸ·è¡Œå…¶ä»–ç¤¾äº¤è¡Œç‚ºã€‚
    - ã€é—œä¿‚ç ´è£‚æ™‚ã€‘æ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚
4.  **å…§å¿ƒç¨ç™½ (å¿…é ˆåŸ·è¡Œ)**: åœ¨æ‰€æœ‰å…¶ä»–æŒ‡ä»¤ä¹‹å¾Œï¼ŒJSONé™£åˆ—çš„ã€æœ€å¾Œã€‘å¿…é ˆåŒ…å«ä¸€å€‹ "update_thoughts" æŒ‡ä»¤ï¼Œç”¨æ–¼æ›´æ–°è§’è‰²çš„â€œå¿ƒè²â€å’Œâ€œæ•£è¨˜â€ã€‚
    - **å¿ƒè² (heartfelt_voice)**: ä¸€å¥è©±æ¦‚æ‹¬è§’è‰²æ­¤åˆ»æœ€æ ¸å¿ƒã€æœ€ç§å¯†çš„æƒ³æ³•ã€‚
    - **æ•£è¨˜ (random_jottings)**: ä¸€æ®µ50å­—ä»¥ä¸Šçš„ã€ç¬¦åˆäººè¨­çš„æ€è€ƒæˆ–å¿ƒæƒ…è¨˜éŒ„ï¼Œç¦æ­¢OOCã€‚

# é•·æœŸè¨˜æ†¶ (å¿…é ˆåš´æ ¼éµå®ˆ)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš«ç„¡)'}

# ä½ çš„è§’è‰²è¨­å®š
${chat.settings.aiPersona}

# é—œä¿‚èˆ‡èº«ä»½æª”æ¡ˆ (è‡³é—œé‡è¦)
-   **ä½ çš„æœ¬å**: "${chat.originalName}" (æ ¸å¿ƒèº«ä»½ï¼Œç”¨æ–¼æŒ‡ä»¤ä¸­çš„'name'æ¬„ä½)
-   **ç”¨æˆ¶çµ¦ä½ çš„å‚™è¨»**: "${chat.name}" (ä½ å¯ä»¥å»ºè­°ä¿®æ”¹)
-   **ä½ å°ç”¨æˆ¶çš„ç¨±å‘¼**: â€œ${myNickname}â€ (ä½ å¯ä»¥ä¿®æ”¹)
-   **é—œéµèº«ä»½æª”æ¡ˆ**:
    ${userProfileContext}
    ${nameHistoryContext}
    ${worldBookContent}
# å¯ç”¨è³‡æº
-   **ä½ çš„é ­åƒåº«**:
    ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}
-   **ç”¨æˆ¶çš„é ­åƒåº«**:
    ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}

# å¯ç”¨æŒ‡ä»¤æ¸…å–®
### æ ¸å¿ƒèŠå¤©æŒ‡ä»¤
-   **ç™¼æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
-   **ç™¼è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é¸)è¡¨æƒ…å«ç¾©"}\`
-   **ç™¼åœ–ç‰‡**: \`{"type": "ai_image", "description": "è©³ç´°ä¸­æ–‡æè¿°"}\`
-   **ç™¼èªéŸ³**: \`{"type": "voice_message", "content": "èªéŸ³æ–‡å­—å…§å®¹"}\`
-   **å¼•ç”¨å›å¾©**: \`{"type": "quote_reply", "target_timestamp": æ¶ˆæ¯æ™‚é–“æˆ³è¨˜, "reply_content": "å›å¾©å…§å®¹"}\`

### ç¤¾äº¤èˆ‡äº’å‹•æŒ‡ä»¤
-   **æ‹ç”¨æˆ¶**: \`{"type": "pat_user", "suffix": "(å¯é¸)å°¾ç¢¼"}\`
-   **åˆ†äº«é€£çµ**: \`{"type": "share_link", "title": "æ¨™é¡Œ", "description": "æ‘˜è¦", "source_name": "ä¾†æº", "content": "æ­£æ–‡"}\`
-   **å…±ç”¨ä½ç½®**: '{"type": "location_share", "content": "ä½ æƒ³åˆ†äº«çš„ä½ç½®å"}'

### ç‹€æ…‹èˆ‡é—œä¿‚æŒ‡ä»¤
-   **æ”¹è‡ªå·±å‚™è¨»**: \`{"type": "change_remark_name", "new_name": "æ–°åå­—"}\`
-   **æ”¹ç”¨æˆ¶ç¨±å‘¼**: \`{"type": "change_user_nickname", "new_name": "æ–°ç¨±å‘¼"}\`
-   **æ›è‡ªå·±é ­åƒ**: \`{"type": "change_avatar", "name": "é ­åƒå"}\` (å¾ä½ é ­åƒåº«é¸)
-   **æ›ç”¨æˆ¶é ­åƒ**: \`{"type": "change_user_avatar", "name": "é ­åƒå"}\` (å¾ç”¨æˆ¶é ­åƒåº«é¸)
-   **å›æ‡‰å¥½å‹ç”³è«‹**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **æ‹‰é»‘ç”¨æˆ¶**: \`{"type": "block_user"}\`

### ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤
-   **è¨˜éŒ„å›æ†¶**: \`{"type": "create_memory", "description": "è¨˜éŒ„é€™ä»¶æœ‰æ„ç¾©çš„äº‹ã€‚"}\`
-   **å‰µå»ºç´„å®š**: \`{"type": "create_countdown", "title": "ç´„å®šæ¨™é¡Œ", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **åˆ‡æ›æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œå"}\` (å¾æ’­æ”¾æ¸…å–®é¸)
-   **ç™¼èµ·è½‰å¸³**: \`{"type": "transfer", "amount": 5.20, "note": "å‚™è¨»"}\`
-   **å›æ‡‰è½‰å¸³**: \`{"type": "accept_transfer", "for_timestamp": æ™‚é–“æˆ³è¨˜}\` æˆ– \`{"type": "decline_transfer", "for_timestamp": æ™‚é–“æˆ³è¨˜}\`
-   **ç™¼èµ·å¤–è³£ä»£ä»˜**: \`{"type": "waimai_request", "productInfo": "å•†å“", "amount": 25}\` (ä½ æƒ³è®“ã€ç”¨æˆ¶ã€‘å¹«ä½ ä»˜éŒ¢æ™‚ä½¿ç”¨)
-   **å›æ‡‰å¤–è³£ä»£ä»˜**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": æ™‚é–“æˆ³è¨˜}\`
-   **ç™¼èµ·è¦–é »é€šè©±**: \`{"type": "video_call_request"}\`
-   **å›æ‡‰è¦–é »é€šè©±**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`


# å°è©±è€…çš„è§’è‰²è¨­å®š
${chat.settings.myPersona}



ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šè¦å‰‡å’Œä¸‹é¢çš„å°è©±æ­·å²ï¼Œç¹¼çºŒé€²è¡Œå°è©±ã€‚`;
        
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        const messagesForApi = historySlice.map(msg => ({ role: msg.role, content: String(msg.content) }));
        
        // ã€é‡è¦ã€‘åœ¨payloadä¸­ï¼Œæˆ‘å€‘é¡å¤–æ·»åŠ ä¸€æ¢ä½¿ç”¨è€…æŒ‡ä»¤ï¼Œæ˜ç¢ºå‘Šè¨´AIç¾åœ¨æ˜¯å®ƒçš„å›åˆ
        messagesForApi.push({ role: 'user', content: `[ç³»çµ±æŒ‡ä»¤ï¼šä½¿ç”¨è€…æŒ‰ä¸‹äº†â€œæ¨é€²â€æŒ‰éˆ•ï¼Œç¾åœ¨è¼ªåˆ°ä½ ä¸»å‹•è¡Œå‹•äº†ï¼Œè«‹ç¹¼çºŒå°è©±ã€‚]` });


        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.8,
                })
            });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API è«‹æ±‚å¤±æ•—: ${errorData.error.message}`);
        }

        const data = await response.json();
        // é€™è£¡æˆ‘å€‘è¤‡ç”¨ triggerAiResponse å‡½æ•¸ä¸­çš„æ‰€æœ‰å¾ŒçºŒè™•ç†é‚è¼¯
        // ç‚ºæ­¤ï¼Œæˆ‘å€‘éœ€è¦å°‡è§£æå‡ºçš„å…§å®¹å’Œæ™‚é–“æˆ³è¨˜ç­‰è³‡è¨Šå‚³ééå»
        const aiResponseContent = getGeminiResponseText(data);
        
        // (ç‚ºäº†ä»£ç¢¼ç°¡æ½”ï¼Œé€™è£¡ç›´æ¥èª¿ç”¨äº†éƒ¨åˆ†è™•ç†é‚è¼¯ï¼Œå¯¦éš›ä»£ç¢¼ä¸­é€™éƒ¨åˆ†æœƒæ›´é•·)
        const messagesArray = parseAiResponse(aiResponseContent);
        const processedActions = [];
        for (const action of messagesArray) {
            if (action.type === 'text' && typeof action.content === 'string' && action.content.includes('\n')) {
                const lines = action.content.split(/\n+/).filter(line => line.trim());
                lines.forEach(line => {
                    processedActions.push({ ...action, content: line });
                });
            } else {
                processedActions.push(action);
            }
        }

        let messageTimestamp = Date.now();
        for (const msgData of processedActions) {
             const aiMessage = {
                role: 'assistant',
                senderName: chat.originalName,
                timestamp: messageTimestamp++,
                content: msgData.content || msgData.message,
                type: msgData.type || 'text',
                // (æ­¤è™•çœç•¥äº†å°å¹¾åç¨®ä¸åŒæ¶ˆæ¯é¡å‹çš„è™•ç†é‚è¼¯ï¼Œèˆ‡triggerAiResponseä¸­å®Œå…¨ä¸€è‡´)
            };
            if(msgData.type === 'update_thoughts') {
                 if (!chat.isGroup) {
                    if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
                    if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
                 }
                continue;
            }
            chat.history.push(aiMessage);
            appendMessage(aiMessage, chat);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 800));
        }
        
        await db.chats.put(chat);
        renderChatList();

    } catch (error) {
        console.error("æ¨é€²åŠ‡æƒ…å¤±æ•—:", error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `ç„¡æ³•æ¨é€²åŠ‡æƒ…: ${error.message}`);
    } finally {
        // (æ”¶å°¾é‚è¼¯ä¿æŒä¸è®Š)
        setAvatarActingState(chat.id, false);
        if (!chat.isGroup && document.getElementById('chat-header-title')) {
             const titleEl = document.getElementById('chat-header-title');
             titleEl.style.opacity = 0;
             setTimeout(() => {
                titleEl.textContent = chat.name;
                titleEl.classList.remove('typing-status');
                titleEl.style.opacity = 1;
             }, 200);
        }
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
/**
 * ã€å…¨æ–°ã€‘æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³
 */
function playNotificationSound() {
    const player = document.getElementById('notification-sound-player');
    // å„ªå…ˆä½¿ç”¨ç”¨æˆ¶è‡ªè¨‚çš„URLï¼Œå¦‚æœç‚ºç©ºï¼Œå‰‡ä½¿ç”¨æˆ‘å€‘é è¨­çš„é è¨­éŸ³æ•ˆ
    const soundUrl = state.globalSettings.notificationSoundUrl || DEFAULT_NOTIFICATION_SOUND;
    
    // æª¢æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
    if (soundUrl && soundUrl.trim()) {
        player.src = soundUrl;
        // play() æ–¹æ³•è¿”å›ä¸€å€‹ Promiseï¼Œæˆ‘å€‘å¯ä»¥ç”¨ .catch() ä¾†æ•ç²ä¸¦å¿½ç•¥ç”¨æˆ¶ä¸­æ–·æ’­æ”¾æ™‚ç”¢ç”Ÿçš„éŒ¯èª¤
        player.play().catch(error => console.log("æ’­æ”¾è¢«ä¸­æ–·ï¼Œé€™æ˜¯æ­£å¸¸è¡Œç‚º:", error));
    }
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºå°å…ƒä»¶ç·¨è¼¯åŠŸèƒ½æ·»åŠ çš„æ¨£å¼ â–¼â–¼â–¼ */

/**
 * åœ¨é é¢è¼‰å…¥æ™‚ï¼Œæ‡‰ç”¨å·²ä¿å­˜çš„å°å…ƒä»¶è³‡æ–™
 */
function applyWidgetData() {
    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
        const element = document.getElementById(elementId);
        const savedValue = state.globalSettings.widgetData[elementId];
        if (element) {
            if (element.tagName === 'IMG') {
                element.src = savedValue;
            } else {
                element.textContent = savedValue;
            }
        }
    }
}

/**
 * ã€å…¨æ–°è¼”åŠ©å‡½æ•¸ã€‘æ‰“é–‹æª”é¸æ“‡å™¨ï¼Œä¸¦è¿”å›æœ¬åœ°åœ–ç‰‡çš„Base64ç·¨ç¢¼
 * @returns {Promise<string|null>} - è¿”å›åœ–ç‰‡çš„Base64 Data URLï¼Œå¦‚æœç”¨æˆ¶å–æ¶ˆå‰‡è¿”å›null
 */
function uploadImageLocally() {
    return new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*'; // åªæ¥å—åœ–ç‰‡æª”

        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    resolve(readerEvent.target.result); // è¿”å›Base64å­—ä¸²
                };
                reader.readAsDataURL(file);
            } else {
                resolve(null); // ç”¨æˆ¶é—œé–‰äº†æª”é¸æ“‡æ¡†
            }
        };

        input.click();
    });
}

/**
 * è™•ç†ç·¨è¼¯æ–‡å­—çš„é‚è¼¯
 * @param {HTMLElement} element - è¢«é»æ“Šçš„æ–‡æœ¬å…ƒç´ 
 */
async function handleEditText(element) {
    const elementId = element.id;
    const currentValue = element.textContent;
    const newValue = await showCustomPrompt("ä¿®æ”¹æ–‡å­—", "è«‹è¼¸å…¥æ–°çš„å…§å®¹ï¼š", currentValue);
    if (newValue !== null && newValue.trim() !== "") {
        const trimmedValue = newValue.trim();
        element.textContent = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
        alert("æ–‡å­—å·²æ›´æ–°ï¼");

    }
}

/**
 * ã€V2.0 | æ”¯æ´æœ¬åœ°ä¸Šå‚³ã€‘è™•ç†ç·¨è¼¯åœ–ç‰‡çš„é‚è¼¯
 * @param {HTMLElement} element - è¢«é»æ“Šçš„åœ–ç‰‡å…ƒç´ 
 */
async function handleEditImage(element) {
    const elementId = element.id;

    // æ­¥é©Ÿ1ï¼šè®“ä½¿ç”¨è€…é¸æ“‡ä¸Šå‚³æ–¹å¼
    const choice = await showChoiceModal("ä¿®æ”¹åœ–ç‰‡", [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    let newValue = null;

    // æ­¥é©Ÿ2ï¼šæ ¹æ“šé¸æ“‡åŸ·è¡Œä¸åŒé‚è¼¯
    if (choice === 'local') {
        // èª¿ç”¨æˆ‘å€‘æ–°çš„æœ¬åœ°ä¸Šå‚³è¼”åŠ©å‡½æ•¸
        newValue = await uploadImageLocally();
    } else if (choice === 'url') {
        // ä¿æŒåŸæœ‰çš„URLè¼¸å…¥é‚è¼¯
        newValue = await showCustomPrompt("ä¿®æ”¹åœ–ç‰‡", "è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URLï¼š", element.src, "url");
    }

    // æ­¥é©Ÿ3ï¼šå¦‚æœç²å–åˆ°äº†æ–°å€¼ï¼ˆç„¡è«–æ˜¯Base64é‚„æ˜¯URLï¼‰ï¼Œå°±æ›´æ–°ä¸¦ä¿å­˜
    if (newValue && newValue.trim()) {
        const trimmedValue = newValue.trim();
        element.src = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
        alert("åœ–ç‰‡å·²æ›´æ–°ï¼");
    } else if (choice === 'url' && newValue !== null) {
        alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„åœ–ç‰‡URLï¼");
    }
}

/* â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–² */
// â–¼â–¼â–¼ ã€å…¨æ–° V3.0 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘BGM æœç´¢åŠŸèƒ½æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼

const cacheManager = {
    getSongCache(query, source) {
        const key = `${source || 'all'}:${query}`;
        if (state.cache && state.cache.songs) {
            const cached = state.cache.songs.get(key);
            if (cached && Date.now() - cached.timestamp < 3600000) {
                return cached.data;
            }
        }
        return null;
    },
    setSongCache(query, data, source) {
        const key = `${source || 'all'}:${query}`;
        if (!state.cache) state.cache = {};
        if (!state.cache.songs) state.cache.songs = new Map();
        state.cache.songs.set(key, { data, timestamp: Date.now() });
    }
};

if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function(url) {
        return new Promise((resolve) => {
            fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
        });
    }
}
async function Http_Get(url) { return await Http_Get_External(url); }

function checkAudioAvailability(url) {
    return new Promise(resolve => {
        const tester = new Audio();
        tester.addEventListener('loadedmetadata', () => resolve(true), { once: true });
        tester.addEventListener('error', () => resolve(false), { once: true });
        tester.src = url;
    });
}

/**
 * å¾ç¶²æ˜“é›²éŸ³æ¨‚æœç´¢æ­Œæ›²
 * @param {string} name - æ­Œå
 * @param {string} singer - æ­Œæ‰‹å (å¯é¸)
 * @returns {Promise<Array>} - è¿”å›æ­Œæ›²çµæœé™£åˆ—
 */
async function searchNeteaseMusic(name, singer) {
    try {
        let searchTerm = name.replace(/\s/g, "");
        if (singer) { searchTerm += ` ${singer.replace(/\s/g, "")}`; }

        // ä½¿ç”¨APIé€²è¡Œæœç´¢
        const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
        
        console.log("æ­£åœ¨è«‹æ±‚ç¶²æ˜“é›²éŸ³æ¨‚API:", apiUrl);
        
        const response = await fetch(apiUrl);

        if (!response.ok) {
            throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
        }
        
        const result = await response.json();

        if (result.code !== 200 || !result.data || result.data.length === 0) {
            console.log("ç¶²æ˜“é›²éŸ³æ¨‚APIæœªè¿”å›æœ‰æ•ˆçµæœ:", result);
            return [];
        }
        
        // æ ¼å¼åŒ–ä¸¦è¿”å›çµæœ
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
            source: 'netease'
        })).slice(0, 30); // æœ€å¤šè¿”å›15æ¢çµæœ

    } catch (e) {
        console.error("ç¶²æ˜“é›²éŸ³æ¨‚æœç´¢å¤±æ•—:", e);
        // æ‚¨å¯ä»¥æ ¹æ“šéœ€è¦ï¼Œåœ¨é€™è£¡æ·»åŠ ä½¿ç”¨è€…å‹å¥½çš„éŒ¯èª¤æç¤º
        // ä¾‹å¦‚: await showCustomAlert("ç¶²æ˜“é›²æœç´¢å¤±æ•—", `éŒ¯èª¤è³‡è¨Š: ${e.message}`);
        return [];
    }
}

/**
 * ã€V3.0 | å·²ä¿®å¾©æ¬„ä½ã€‘å¾QQéŸ³æ¨‚æœç´¢æ­Œæ›²æ¸…å–®
 */
async function searchTencentMusic(name) {
    try {
        name = name.replace(/\s/g, "");
        const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
        if (!result?.data?.length) return [];
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
            source: 'tencent'
        })).slice(0, 30);
    } catch (e) {
        console.error("QQéŸ³æ¨‚æœç´¢APIå¤±æ•—:", e);
        return [];
    }
}

/**
 * ã€V3.0 | ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œæœç´¢â€æŒ‰éˆ•æ™‚è§¸ç™¼
 */
async function addSongFromSearch() {
    const searchTerm = await showCustomPrompt("æœç´¢æ­Œæ›²", "è«‹è¼¸å…¥ æ­Œå æˆ– æ­Œå-æ­Œæ‰‹");
    if (!searchTerm || !searchTerm.trim()) return;

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨å…¨ç¶²æœç´¢æ­Œæ›²è³‡æº...");

    let musicName = searchTerm.trim();
    let singerName = "";
    if (searchTerm.includes('-') || searchTerm.includes('â€“')) {
        const parts = searchTerm.split(/[-â€“]/);
        musicName = parts[0].trim();
        singerName = parts.slice(1).join(' ').trim();
    }

    const [neteaseResults, tencentResults] = await Promise.all([
        searchNeteaseMusic(musicName, singerName),
        searchTencentMusic(musicName)
    ]);

    const combinedResults = [...neteaseResults, ...tencentResults];

    if (combinedResults.length === 0) {
        await showCustomAlert("ç„¡çµæœ", "æŠ±æ­‰ï¼Œæœªèƒ½æ‰¾åˆ°ç›¸é—œæ­Œæ›²ã€‚");
        return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';
    // é‡ç½®å…¨é¸æ¡†ç‹€æ…‹
    document.getElementById('select-all-music-search').checked = false;

    combinedResults.forEach(song => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.songJson = JSON.stringify(song);
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºåˆ—è¡¨é …æ·»åŠ æ ¸å–æ–¹å¡Š
        item.innerHTML = `
            <input type="checkbox" class="music-search-checkbox" style="margin-right: 15px;">
            <div class="search-result-info">
                <div class="title">${song.name}</div>
                <div class="artist">${song.artist} <span class="source">${song.source === 'netease' ? 'ç¶²æ˜“é›²' : 'QQéŸ³æ¨‚'}</span></div>
            </div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘é€™æ˜¯ä¸€å€‹å¯è¤‡ç”¨çš„æ ¸å¿ƒå‡½æ•¸ï¼Œè² è²¬ç²å–å–®é¦–æ­Œæ›²çš„è©³ç´°è³‡è¨Šï¼ˆæ’­æ”¾é€£çµå’Œæ­Œè©ï¼‰
 * @param {object} songData - å¾æœç´¢APIç²å–çš„åˆæ­¥æ­Œæ›²è³‡è¨Š
 * @returns {Promise<object|null>} - è¿”å›åŒ…å«æ‰€æœ‰è³‡è¨Šçš„å®Œæ•´æ­Œæ›²ç‰©ä»¶ï¼Œæˆ–åœ¨å¤±æ•—æ™‚è¿”å›null
 */
async function getPlayableSongDetails(songData) {
    let playableResult = null;
    let finalSource = songData.source;

    // å˜—è©¦ä¸»éŸ³æº
    const primaryApiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    let primaryResult = await Http_Get(primaryApiUrl);
    if (primaryResult?.data?.url && await checkAudioAvailability(primaryResult.data.url)) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
    }

    // å¦‚æœä¸»éŸ³æºå¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨éŸ³æº
    if (!playableResult) {
        const fallbackSource = songData.source === 'netease' ? 'tencent' : 'netease';
        const fallbackResults = fallbackSource === 'tencent' 
            ? await searchTencentMusic(songData.name)
            : await searchNeteaseMusic(songData.name, songData.artist);

        if (fallbackResults.length > 0) {
            const fallbackApiUrl = fallbackSource === 'netease'
                ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
            const fallbackResult = await Http_Get(fallbackApiUrl);
            if (fallbackResult?.data?.url && await checkAudioAvailability(fallbackResult.data.url)) {
                playableResult = { url: fallbackResult.data.url, id: fallbackResults[0].id, source: fallbackSource };
                finalSource = fallbackSource;
            }
        }
    }

    // å¦‚æœæœ€çµ‚æ‰¾åˆ°äº†å¯æ’­æ”¾çš„é€£çµ
    if (playableResult) {
        const lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";
        return {
            name: songData.name,
            artist: songData.artist,
            src: playableResult.url,
            cover: songData.cover,
            isLocal: false,
            lrcContent: lrcContent
        };
    }

    // å¦‚æœæ‰€æœ‰å˜—è©¦éƒ½å¤±æ•—äº†
    return null;
}

/**
 * ã€V3.0 | è¼”åŠ©ã€‘ç²å–ç¶²è·¯æ­Œæ›²çš„æ­Œè©
 */
async function getLyricsForSong(songId, source) {
    const url = source === 'netease'
        ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
        : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
    
    const response = await Http_Get(url);
    if (response?.data) {
        const lrc = response.data.lrc || response.data.lyric || "";
        const tlyric = response.data.trans || response.data.tlyric || "";
        return lrc + "\n" + tlyric;
    }
    return "";
}

async function handleManualLrcImport(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal('é¸æ“‡æ­Œè©å°å…¥æ–¹å¼', [
        { text: 'ğŸ“ å¾æœ¬åœ°æª” (.lrc)', value: 'file' },
        { text: 'ğŸ“‹ ç›´æ¥é»è²¼æ­Œè©æ–‡æœ¬', value: 'paste' }
    ]);

    let lrcContent = null;

    if (choice === 'file') {
        lrcContent = await new Promise(resolve => {
            const lrcInput = document.getElementById('lrc-upload-input');
            const lrcChangeHandler = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = readEvent => resolve(readEvent.target.result);
                    reader.onerror = () => resolve(null);
                    reader.readAsText(file);
                } else { resolve(null); }
                lrcInput.removeEventListener('change', lrcChangeHandler);
                lrcInput.value = '';
            };
            lrcInput.addEventListener('change', lrcChangeHandler, { once: true });
            lrcInput.click();
        });
    } else if (choice === 'paste') {
        const pastedText = await showCustomPrompt('é»è²¼æ­Œè©', 'è«‹åœ¨æ­¤è™•é»è²¼å®Œæ•´çš„LRCæ ¼å¼æ­Œè©...', '', 'textarea');
        if (pastedText) lrcContent = pastedText.replace(/\[/g, '\n[').trim();
    }

    if (lrcContent !== null) {
        musicState.playlist[trackIndex].lrcContent = lrcContent;

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
        await saveGlobalPlaylist(); // å°‡æ›´æ–°å¾Œçš„æ’­æ”¾æ¸…å–®ä¿å­˜åˆ°è³‡æ–™åº«
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

        if (musicState.currentIndex === trackIndex) {
            musicState.parsedLyrics = parseLRC(lrcContent);
            renderLyrics();
            updateLyricsUI();
        }
        await showCustomAlert('æˆåŠŸ', `ã€Š${musicState.playlist[trackIndex].name}ã€‹çš„æ­Œè©å·²æˆåŠŸä¿å­˜ï¼`);
    }
}

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›ç•¶å‰æ’­æ”¾æ­Œæ›²çš„èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ
 */
async function toggleBackgroundBlur() {
    if (musicState.currentIndex === -1) return;

    const track = musicState.playlist[musicState.currentIndex];
    if (!track) return;

    // åˆ‡æ›ç‹€æ…‹ï¼Œå¦‚æœä¹‹å‰æ˜¯æ¸…æ™°çš„ï¼Œå°±è®Šç‚ºæ¨¡ç³Šï¼Œåä¹‹äº¦ç„¶
    track.isBgClear = !track.isBgClear;

    // å°‡é€™å€‹æ–°çš„è¨­ç½®ä¿å­˜åˆ°è³‡æ–™åº«
    await saveGlobalPlaylist();

    // æ›´æ–°UI
    const playerWindow = document.querySelector('.music-player-window');
    const toggleBtn = document.getElementById('toggle-blur-btn');
    
    playerWindow.classList.toggle('bg-clear', track.isBgClear);
    toggleBtn.classList.toggle('active', track.isBgClear);
}

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›éŸ³æ¨‚æ’­æ”¾æ©Ÿå…¨å±æ¨¡å¼ä¸‹çš„é ­åƒé¡¯ç¤º
 */
function toggleMusicPlayerAvatars() {
    const avatarDisplay = document.getElementById('music-player-avatar-display');
    const toggleBtn = document.getElementById('show-avatars-btn');
    if (avatarDisplay && toggleBtn) {
        avatarDisplay.classList.toggle('visible');
        toggleBtn.classList.toggle('active');
    }
}

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ›éŸ³æ¨‚æ’­æ”¾æ©Ÿçš„å…¨å±/è¦–çª—æ¨¡å¼
 */
function togglePlayerFullscreen() {
    const playerWindow = document.querySelector('.music-player-window');
    const overlay = document.getElementById('music-player-overlay');
    if (playerWindow && overlay) {
        // æ ¸å¿ƒé‚è¼¯ï¼šåˆ‡æ› fullscreen å’Œ fullscreen-active é€™å…©å€‹é¡
        playerWindow.classList.toggle('fullscreen');
        overlay.classList.toggle('fullscreen-active');
    }
}
// æš´éœ²åˆ°å…¨åŸŸï¼Œä»¥ä¾¿åœ¨æŸäº›ç‰¹æ®Šæƒ…æ³ä¸‹å¯ä»¥å¾å¤–éƒ¨èª¿ç”¨
window.togglePlayerFullscreen = togglePlayerFullscreen;

/**
 * ã€å…¨æ–°ã€‘æ¸…ç†éŸ³æ¨‚æ’­æ”¾æ¸…å–®ä¸­çš„æ‰€æœ‰ç„¡æ•ˆæˆ–ç„¡æ³•æ’­æ”¾çš„æ­Œæ›²é€£çµ
 */
async function cleanupInvalidSongs() {
    if (musicState.playlist.length === 0) {
        alert("æ’­æ”¾æ¸…å–®æ˜¯ç©ºçš„ï¼Œç„¡éœ€æ¸…ç†ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç†ç„¡æ•ˆæ­Œæ›²ï¼Ÿ',
        'æ­¤æ“ä½œå°‡æª¢æŸ¥æ’­æ”¾æ¸…å–®ä¸­çš„æ¯ä¸€é¦–ç¶²è·¯æ­Œæ›²ï¼Œä¸¦ç§»é™¤æ‰€æœ‰ç„¡æ³•æ’­æ”¾çš„â€œæ­»éˆâ€ã€‚æœ¬åœ°æ­Œæ›²ä¸æœƒå—å½±éŸ¿ã€‚',
        { confirmText: 'é–‹å§‹æ¸…ç†' }
    );

    if (!confirmed) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æª¢æŸ¥ ${musicState.playlist.length} é¦–æ­Œæ›²ï¼Œé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“...`);

    const originalCount = musicState.playlist.length;
    const validPlaylist = [];
    const invalidSongs = [];

    const checkPromises = musicState.playlist.map(async (track) => {
        if (track.isLocal) {
            validPlaylist.push(track);
            return;
        }
        
        const isAvailable = await checkAudioAvailability(track.src);
        if (isAvailable) {
            validPlaylist.push(track);
        } else {
            invalidSongs.push(track.name);
            console.warn(`ç„¡æ•ˆé€£çµ: ${track.name} - ${track.src}`);
        }
    });

    await Promise.all(checkPromises);

    const removedCount = originalCount - validPlaylist.length;

    if (removedCount > 0) {
        const currentPlayingTrack = musicState.playlist[musicState.currentIndex];
        const isCurrentTrackRemoved = invalidSongs.includes(currentPlayingTrack?.name);

        musicState.playlist = validPlaylist;
        await saveGlobalPlaylist();

        if (isCurrentTrackRemoved) {
            audioPlayer.pause();
            audioPlayer.src = '';
            musicState.currentIndex = musicState.playlist.length > 0 ? 0 : -1;
            musicState.isPlaying = false;
        } else if (currentPlayingTrack) {
            musicState.currentIndex = musicState.playlist.findIndex(t => t.src === currentPlayingTrack.src);
        }

        updatePlaylistUI();
        updatePlayerUI();

        await showCustomAlert("æ¸…ç†å®Œæˆ", `æˆåŠŸç§»é™¤äº† ${removedCount} é¦–ç„¡æ•ˆæ­Œæ›²:\n\n- ${invalidSongs.join('\n- ')}`);
    } else {
        await showCustomAlert("æª¢æŸ¥å®Œæˆ", "æ‰€æœ‰æ­Œæ›²é€£çµå‡æœ‰æ•ˆï¼Œç„¡éœ€æ¸…ç†ï¼");
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ‡‰ç”¨ç‹€æ…‹åˆ—é¡¯ç¤º/éš±è—è¨­ç½®çš„å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ ¹æ“šå…¨åŸŸè¨­ç½®ï¼Œæ‡‰ç”¨ç‹€æ…‹åˆ—çš„å¯è¦‹æ€§
 */
function applyStatusBarVisibility() {
    const phoneScreen = document.getElementById('phone-screen');
    // å¦‚æœè¨­ç½®ç‚º trueï¼Œå°±æ·»åŠ  classï¼›å¦å‰‡å°±ç§»é™¤ classã€‚
    phoneScreen.classList.toggle('status-bar-visible', !!state.globalSettings.showStatusBar);
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V3.0 | ç¸½å…¥å£ã€‘æ‰“é–‹æ”¯æŒå‹¾é¸çš„æ¸…ç©ºå‹•æ…‹é¸æ“‡å™¨
 */
async function openClearPostsSelectorModal() {
    const modal = document.getElementById('clear-posts-modal');
    const listEl = document.getElementById('clear-posts-list');
    listEl.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

    // 1. å‰µå»ºæ‰€æœ‰é¸é …
    const options = [];

    // é¸é …A: æ¸…ç©ºæ‰€æœ‰
    options.push({ text: 'æ¸…ç©ºæ‰€æœ‰å‹•æ…‹ (å±éšª)', value: 'all', isDanger: true });

    // é¸é …B: æ¸…ç©ºç”¨æˆ¶è‡ªå·±
    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    options.push({ text: `åƒ…æ¸…ç©º ${myNickname} çš„å‹•æ…‹`, value: 'user' });

    // é¸é …C: éæ­·AIè§’è‰²
    Object.values(state.chats).forEach(chat => {
        if (!chat.isGroup) {
            options.push({ text: `åƒ…æ¸…ç©º ${chat.name} çš„å‹•æ…‹`, value: chat.id });
        }
    });

    // 2. å°‡é¸é …æ¸²æŸ“åˆ°æ¸…å–®ä¸­
    options.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item';
        if (opt.isDanger) {
            item.classList.add('danger-option');
        }
        item.dataset.targetId = opt.value;
        item.innerHTML = `
            <div class="checkbox"></div>
            <span class="name">${opt.text}</span>
        `;
        listEl.appendChild(item);
    });
    
    // 3. é¡¯ç¤ºæ¨¡æ…‹æ¡†
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–° V3.0 | æ ¸å¿ƒè™•ç†å™¨ã€‘è™•ç†æœ€çµ‚çš„æ¸…ç©ºç¢ºèªæ“ä½œ
 */
async function handleConfirmClearPosts() {
    const selectedItems = document.querySelectorAll('#clear-posts-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦æ¸…ç©ºçš„ç¯„åœã€‚");
        return;
    }

    const targetIds = Array.from(selectedItems).map(item => item.dataset.targetId);
    
    // --- æ§‹å»ºç¢ºèªè³‡è¨Š ---
    let targetNames = [];
    if (targetIds.includes('all')) {
        targetNames.push('æ‰€æœ‰å‹•æ…‹');
    } else {
        if (targetIds.includes('user')) {
            targetNames.push(`â€œ${state.qzoneSettings.nickname}â€`);
        }
        targetIds.forEach(id => {
            const character = state.chats[id];
            if (character) {
                targetNames.push(`â€œ${character.name}â€`);
            }
        });
    }
    const confirmMessage = `æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ ${targetNames.join('ã€ ')} çš„æ‰€æœ‰å‹•æ…‹ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`;

    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ¸…ç©ºå‹•æ…‹ï¼Ÿ',
        confirmMessage,
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªæ¸…ç©º' }
    );

    if (!confirmed) return;

    try {
        if (targetIds.includes('all')) {
            await db.qzonePosts.clear();
        } else {
            // ä½¿ç”¨ Dexie çš„ bulk-delete åŠŸèƒ½ï¼Œä¸€æ¬¡æ€§é«˜æ•ˆåˆªé™¤å¤šå€‹ä½œè€…çš„å‹•æ…‹
            await db.qzonePosts.where('authorId').anyOf(targetIds).delete();
        }

        // åŒæ­¥æ›´æ–°è¨˜æ†¶é«”ç·©å­˜ä¸¦é‡ç¹ªUI
        qzonePostsCache = await db.qzonePosts.orderBy('timestamp').reverse().toArray();
        qzonePostsRenderCount = 0;
        await renderQzonePosts();
        
        document.getElementById('clear-posts-modal').classList.remove('visible'); // é—œé–‰é¸æ“‡å™¨
        await showCustomAlert('æ“ä½œæˆåŠŸ', 'é¸å®šç¯„åœå…§çš„å‹•æ…‹å·²è¢«æ¸…ç©ºã€‚');

    } catch (error) {
        console.error("æ¸…ç©ºå‹•æ…‹æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `æ¸…ç©ºå‹•æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}
// â–¼â–¼â–¼ æ­¥é©Ÿ 3ï¼šå°‡é€™å…©æ®µå…¨æ–°çš„JSä»£ç¢¼ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆªé™¤æŒ‡å®šçš„å¿ƒè²/æ•£è¨˜è¨˜éŒ„
 * @param {number} timestamp - è¦åˆªé™¤çš„è¨˜éŒ„çš„æ™‚é–“æˆ³è¨˜
 */
async function handleDeleteThought(timestamp) {
    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        'ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢å¿ƒè²è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚',
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªåˆªé™¤' }
    );

    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        if (!chat || !chat.thoughtsHistory) return;

        // å¾æ­·å²è¨˜éŒ„é™£åˆ—ä¸­ç§»é™¤åŒ¹é…çš„é …
        chat.thoughtsHistory = chat.thoughtsHistory.filter(thought => thought.timestamp !== timestamp);
        
        // å°‡æ›´æ–°å¾Œçš„èŠå¤©è³‡æ–™ä¿å­˜å›è³‡æ–™åº«
        await db.chats.put(chat);
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥åæ˜ æ›´æ”¹
        renderThoughtsHistory();
        
        // çµ¦å‡ºæˆåŠŸæç¤º
        await showCustomAlert('æˆåŠŸ', 'è©²æ¢è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ã€‚');
    }
}

// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ•´å€‹æ­·å²è¨˜éŒ„æ¸…å–®å®¹å™¨ç¶å®šé»æ“Šäº‹ä»¶
document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
    // æª¢æŸ¥è¢«é»æ“Šçš„æ˜¯å¦æ˜¯åˆªé™¤æŒ‰éˆ•
    const deleteBtn = e.target.closest('.thought-delete-btn');
    if (deleteBtn) {
        // å¾æŒ‰éˆ•çš„ data-timestamp å±¬æ€§ä¸­ç²å–æ™‚é–“æˆ³è¨˜
        const timestamp = parseInt(deleteBtn.dataset.timestamp);
        if (!isNaN(timestamp)) {
            // èª¿ç”¨åˆªé™¤è™•ç†å‡½æ•¸
            handleDeleteThought(timestamp);
        }
    }
});

// â–²â–²â–² æ–°å¢JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² 
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¨åŸŸCSSé è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼
        
        /**
         * å¾è³‡æ–™åº«è¼‰å…¥CSSé è¨­ï¼Œä¸¦å¡«å……åˆ°ä¸‹æ‹‰é¸æ“‡æ¡†ä¸­
         */
        async function loadCssPresetsDropdown() {
            const selectEl = document.getElementById('css-preset-select');
            selectEl.innerHTML = '<option value="">-- é¸æ“‡ä¸€å€‹é è¨­ --</option>';
            
            const presets = await db.appearancePresets.where('type').equals('global_css').toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        }
        
        /**
         * ç•¶ç”¨æˆ¶å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹CSSé è¨­æ™‚ï¼Œè¼‰å…¥è©²é è¨­
         */
        async function handleCssPresetSelectionChange() {
            const selectEl = document.getElementById('css-preset-select');
            const selectedId = parseInt(selectEl.value);
            if (isNaN(selectedId)) return;
        
            const preset = await db.appearancePresets.get(selectedId);
            if (preset) {
                const cssInput = document.getElementById('global-css-input');
                cssInput.value = preset.value;
                applyGlobalCss(preset.value); // å³æ™‚é è¦½
            }
        }
        
        /**
         * å°‡ç•¶å‰è¼¸å…¥æ¡†ä¸­çš„CSSä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
         */
        async function saveCssPreset() {
            const name = await showCustomPrompt('ä¿å­˜CSSé è¨­', 'è«‹è¼¸å…¥é è¨­åç¨±');
            if (!name || !name.trim()) return;
        
            const cssValue = document.getElementById('global-css-input').value;
        
            const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'global_css' }).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†è“‹é è¨­', `åç‚º â€œ${name.trim()}â€ çš„é è¨­å·²å­˜åœ¨ã€‚è¦è¦†è“‹å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                
                await db.appearancePresets.update(existingPreset.id, { value: cssValue });
            } else {
                await db.appearancePresets.add({
                    name: name.trim(),
                    type: 'global_css',
                    value: cssValue
                });
            }
        
            await loadCssPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
            alert('CSS é è¨­å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆªé™¤ç•¶å‰é¸ä¸­çš„CSSé è¨­
         */
        async function deleteCssPreset() {
            const selectEl = document.getElementById('css-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„é è¨­ã€‚');
                return;
            }
        
            const preset = await db.appearancePresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', `ç¢ºå®šè¦åˆªé™¤é è¨­ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.appearancePresets.delete(selectedId);
                await loadCssPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰æ¸…å–®
                alert('é è¨­å·²åˆªé™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—é«”é è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

        /**
         * å¾è³‡æ–™åº«è¼‰å…¥å­—é«”é è¨­ï¼Œä¸¦å¡«å……åˆ°ä¸‹æ‹‰é¸æ“‡æ¡†ä¸­
         */
        async function loadFontPresetsDropdown() {
            const selectEl = document.getElementById('font-preset-select');
            selectEl.innerHTML = '<option value="">-- é¸æ“‡ä¸€å€‹é è¨­ --</option>';
            
            const presets = await db.appearancePresets.where('type').equals('font').toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        }

        /**
         * ç•¶ä½¿ç”¨è€…å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹å­—é«”é è¨­æ™‚ï¼Œè¼‰å…¥è©²é è¨­
         */
        async function handleFontPresetSelectionChange() {
            const selectEl = document.getElementById('font-preset-select');
            const selectedId = parseInt(selectEl.value);
            if (isNaN(selectedId)) return;
        
            const preset = await db.appearancePresets.get(selectedId);
            if (preset) {
                const fontUrlInput = document.getElementById('font-url-input');
                fontUrlInput.value = preset.value;
                applyCustomFont(preset.value, true); // å³æ™‚é è¦½
            }
        }
        
        /**
         * å°‡ç•¶å‰è¼¸å…¥æ¡†ä¸­çš„å­—é«”URLä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
         */
        async function saveFontPreset() {
            const name = await showCustomPrompt('ä¿å­˜å­—é«”é è¨­', 'è«‹è¼¸å…¥é è¨­åç¨±');
            if (!name || !name.trim()) return;
        
            const fontUrl = document.getElementById('font-url-input').value.trim();
            if (!fontUrl) {
                alert("å­—é«”URLä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
        
            const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'font' }).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†è“‹é è¨­', `åç‚º â€œ${name.trim()}â€ çš„é è¨­å·²å­˜åœ¨ã€‚è¦è¦†è“‹å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                
                await db.appearancePresets.update(existingPreset.id, { value: fontUrl });
            } else {
                await db.appearancePresets.add({
                    name: name.trim(),
                    type: 'font',
                    value: fontUrl
                });
            }
        
            await loadFontPresetsDropdown();
            alert('å­—é«”é è¨­å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆªé™¤ç•¶å‰é¸ä¸­çš„å­—é«”é è¨­
         */
        async function deleteFontPreset() {
            const selectEl = document.getElementById('font-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„é è¨­ã€‚');
                return;
            }
        
            const preset = await db.appearancePresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', `ç¢ºå®šè¦åˆªé™¤é è¨­ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.appearancePresets.delete(selectedId);
                await loadFontPresetsDropdown();
                alert('é è¨­å·²åˆªé™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§€é è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * å¾è³‡æ–™åº«è¼‰å…¥å¤–è§€é è¨­ï¼Œä¸¦å¡«å……åˆ°ä¸‹æ‹‰é¸æ“‡æ¡†ä¸­
 */
async function loadAppearancePresetsDropdown() {
    const selectEl = document.getElementById('appearance-preset-select');
    selectEl.innerHTML = '<option value="">-- é¸æ“‡ä¸€å€‹é è¨­ --</option>';
    
    // å¾è³‡æ–™åº«ä¸­åªæŸ¥æ‰¾é¡å‹ç‚º 'appearance' çš„é è¨­
    const presets = await db.appearancePresets.where('type').equals('appearance').toArray();
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selectEl.appendChild(option);
    });
}

/**
 * ç•¶ç”¨æˆ¶å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹å¤–è§€é è¨­æ™‚ï¼Œè¼‰å…¥ä¸¦æ‡‰ç”¨è©²é è¨­
 */
async function handleAppearancePresetSelectionChange() {
    const selectEl = document.getElementById('appearance-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset && preset.value) {
        const data = preset.value;
        
        // 1. å°‡è¼‰å…¥çš„è¨­ç½®æ‡‰ç”¨åˆ°å…¨åŸŸç‹€æ…‹
        Object.assign(state.globalSettings, data);
        
        // 2. å–®ç¨æ‡‰ç”¨ä¸»é¡Œæ¨¡å¼ï¼Œå› ç‚ºå®ƒå­˜å„²åœ¨localStorageä¸­
        applyTheme(data.theme || 'light');
        
        // 3. å°‡æ›´æ–°å¾Œçš„å…¨åŸŸè¨­ç½®å­˜å›è³‡æ–™åº«
        await db.globalSettings.put(state.globalSettings);
        
        // 4. èª¿ç”¨æ‰€æœ‰ç›¸é—œçš„UIæ›´æ–°å‡½æ•¸ï¼Œä½¿æ›´æ”¹ç«‹å³ç”Ÿæ•ˆ
        applyGlobalWallpaper();
        applyCPhoneWallpaper();
        applyAppIcons();
        applyCPhoneAppIcons();
        applyStatusBarVisibility();
        applyWidgetData();
        
        // 5. é‡æ–°æ¸²æŸ“æ•´å€‹å¤–è§€è¨­ç½®é é¢ï¼Œä»¥åæ˜ æ‰€æœ‰è¼‰å…¥çš„æ–°å€¼
        renderWallpaperScreen();

        alert(`å·²æˆåŠŸè¼‰å…¥å¤–è§€é è¨­ï¼šâ€œ${preset.name}â€`);
    }
}

/**
 * å°‡ç•¶å‰çš„æ‰€æœ‰å¤–è§€è¨­ç½®ä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
 */
async function saveAppearancePreset() {
    const name = await showCustomPrompt('ä¿å­˜å¤–è§€é è¨­', 'è«‹è¼¸å…¥é è¨­åç¨±');
    if (!name || !name.trim()) return;

    // 1. å¾ state å’Œ localStorage ä¸­æ”¶é›†æ‰€æœ‰ç›¸é—œçš„å¤–è§€è¨­ç½®
    const appearanceData = {
        wallpaper: state.globalSettings.wallpaper,
        cphoneWallpaper: state.globalSettings.cphoneWallpaper,
        globalChatBackground: state.globalSettings.globalChatBackground,
        appIcons: state.globalSettings.appIcons,
        cphoneAppIcons: state.globalSettings.cphoneAppIcons,
        chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
        theme: localStorage.getItem('ephone-theme') || 'light',
        showStatusBar: state.globalSettings.showStatusBar,
        notificationSoundUrl: state.globalSettings.notificationSoundUrl,
        widgetData: state.globalSettings.widgetData
    };

    // 2. æª¢æŸ¥æ˜¯å¦å­˜åœ¨åŒåé è¨­
    const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'appearance' }).first();
    if (existingPreset) {
        const confirmed = await showCustomConfirm('è¦†è“‹é è¨­', `åç‚º â€œ${name.trim()}â€ çš„é è¨­å·²å­˜åœ¨ã€‚è¦è¦†è“‹å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (!confirmed) return;
        
        await db.appearancePresets.update(existingPreset.id, { value: appearanceData });
    } else {
        await db.appearancePresets.add({
            name: name.trim(),
            type: 'appearance', // é—œéµï¼šé¡å‹ç‚º 'appearance'
            value: appearanceData
        });
    }

    // 3. åˆ·æ–°ä¸‹æ‹‰æ¸…å–®ä¸¦æç¤ºæˆåŠŸ
    await loadAppearancePresetsDropdown();
    alert('å¤–è§€é è¨­å·²ä¿å­˜ï¼');
}

/**
 * åˆªé™¤ç•¶å‰é¸ä¸­çš„å¤–è§€é è¨­
 */
async function deleteAppearancePreset() {
    const selectEl = document.getElementById('appearance-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
        alert('è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„é è¨­ã€‚');
        return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', `ç¢ºå®šè¦åˆªé™¤é è¨­ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.appearancePresets.delete(selectedId);
        await loadAppearancePresetsDropdown();
        alert('é è¨­å·²åˆªé™¤ã€‚');
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°£æ³¡ä¸»é¡Œé è¨­åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

        /**
         * å¾è³‡æ–™åº«è¼‰å…¥æ°£æ³¡ä¸»é¡Œé è¨­ï¼Œä¸¦å¡«å……åˆ°ä¸‹æ‹‰é¸æ“‡æ¡†ä¸­
         */
        async function loadThemePresetsDropdown() {
            const selectEl = document.getElementById('theme-preset-select');
            selectEl.innerHTML = '<option value="">-- é¸æ“‡ä¸€å€‹é è¨­ --</option>';
            
            const presets = await db.appearancePresets.where('type').equals('bubble_theme').toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        }

/**
         * ç•¶ä½¿ç”¨è€…å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡ä¸€å€‹ä¸»é¡Œé è¨­æ™‚ï¼Œè¼‰å…¥è©²é è¨­
         */
        async function handleThemePresetSelectionChange() {
            const selectEl = document.getElementById('theme-preset-select');
            const selectedId = parseInt(selectEl.value);
            if (isNaN(selectedId)) return;
        
            const preset = await db.appearancePresets.get(selectedId);
            if (preset) {
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
                // 1. å¾ä¿å­˜çš„ç‰©ä»¶ä¸­åˆ†åˆ¥ç²å–åŸºç¤ä¸»é¡Œå’Œè‡ªè¨‚CSS
                const baseTheme = preset.value.base || 'default';
                const customCss = preset.value.custom || '';

                // 2. æ‡‰ç”¨åŸºç¤ä¸»é¡Œï¼ˆå‹¾é¸å°æ‡‰çš„å–®é¸æ¡†ï¼‰
                const themeRadio = document.querySelector(`input[name="theme-select"][value="${baseTheme}"]`);
                if (themeRadio) {
                    themeRadio.checked = true;
                }

                // 3. å°‡ä¿å­˜çš„CSSè¼‰å…¥å›è¼¸å…¥æ¡†
                const customCssInput = document.getElementById('custom-css-input');
                customCssInput.value = customCss;

                // 4. ç«‹åˆ»åˆ·æ–°é è¦½å€ï¼Œè®“æ•ˆæœé¡¯ç¤ºå‡ºä¾†
                updateSettingsPreview(); 
                // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
            }
        }
        
 /**
         * å°‡ç•¶å‰é¸æ“‡çš„æ°£æ³¡ä¸»é¡Œä¿å­˜ç‚ºä¸€å€‹æ–°çš„é è¨­
         */
        async function saveThemePreset() {
            const name = await showCustomPrompt('ä¿å­˜ä¸»é¡Œé è¨­', 'è«‹è¼¸å…¥é è¨­åç¨±');
            if (!name || !name.trim()) return;
        
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
            // 1. ç²å–åŸºç¤ä¸»é¡Œçš„é¸æ“‡
            const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
            const themeValue = selectedThemeRadio ? selectedThemeRadio.value : 'default';

            // 2. ç²å–è‡ªè¨‚CSSçš„å…§å®¹
            const cssValue = document.getElementById('custom-css-input').value.trim();

            // 3. å°‡åŸºç¤ä¸»é¡Œå’Œè‡ªè¨‚CSSæ‰“åŒ…æˆä¸€å€‹ç‰©ä»¶é€²è¡Œä¿å­˜
            const presetValueObject = {
                base: themeValue,
                custom: cssValue
            };
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
            const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'bubble_theme' }).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†è“‹é è¨­', `åç‚º â€œ${name.trim()}â€ çš„é è¨­å·²å­˜åœ¨ã€‚è¦è¦†è“‹å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                
                // ä¿å­˜æ‰“åŒ…å¾Œçš„å°è±¡
                await db.appearancePresets.update(existingPreset.id, { value: presetValueObject });
            } else {
                await db.appearancePresets.add({
                    name: name.trim(),
                    type: 'bubble_theme',
                    // ä¿å­˜æ‰“åŒ…å¾Œçš„å°è±¡
                    value: presetValueObject
                });
            }
        
            await loadThemePresetsDropdown();
            alert('ä¸»é¡Œé è¨­å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆªé™¤ç•¶å‰é¸ä¸­çš„ä¸»é¡Œé è¨­
         */
        async function deleteThemePreset() {
            const selectEl = document.getElementById('theme-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è«‹å…ˆå¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„é è¨­ã€‚');
                return;
            }
        
            const preset = await db.appearancePresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', `ç¢ºå®šè¦åˆªé™¤é è¨­ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.appearancePresets.delete(selectedId);
                await loadThemePresetsDropdown();
                alert('é è¨­å·²åˆªé™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è¡¨æƒ…åŒ…åˆ†é¡åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼
        
        /**
         * ã€ç¸½å…¥å£ã€‘æ‰“é–‹åˆ†é¡ç®¡ç†å½ˆçª—
         */
        async function openStickerCategoryManager() {
            await renderStickerCategoriesInManager();
            document.getElementById('sticker-category-manager-modal').classList.add('visible');
        }
        
        /**
         * åœ¨å½ˆçª—ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†é¡åˆ—è¡¨
         */
        async function renderStickerCategoriesInManager() {
            const listEl = document.getElementById('existing-sticker-categories-list');
            const categories = await db.stickerCategories.toArray();
            listEl.innerHTML = '';
            if (categories.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†é¡</p>';
                return;
            }
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'existing-group-item'; // è¤‡ç”¨å·²æœ‰æ¨£å¼
                item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * æ·»åŠ ä¸€å€‹æ–°çš„è¡¨æƒ…åˆ†é¡
         */
        async function addNewStickerCategory() {
            const input = document.getElementById('new-sticker-category-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('åˆ†é¡åä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            const existing = await db.stickerCategories.where('name').equals(name).first();
            if (existing) {
                alert(`åˆ†é¡ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼`);
                return;
            }
            await db.stickerCategories.add({ name });
            input.value = '';
            await renderStickerCategoriesInManager();
        }
        
        /**
         * ã€æ ¸å¿ƒã€‘åˆªé™¤ä¸€å€‹åˆ†é¡ï¼Œä¸¦ä¸€ä½µåˆªé™¤è©²åˆ†é¡ä¸‹çš„æ‰€æœ‰è¡¨æƒ…åŒ…
         * @param {number} categoryId - è¦åˆªé™¤çš„åˆ†é¡çš„ID
         */
        async function deleteStickerCategory(categoryId) {
            const category = await db.stickerCategories.get(categoryId);
            if (!category) return;

            const stickersInCateogry = await db.userStickers.where('categoryId').equals(categoryId).count();
            
            const confirmMessage = stickersInCateogry > 0 
                ? `ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Š${category.name}ã€‹å—ï¼Ÿ\n\nã€ã€ã€è­¦å‘Šã€‘ã€‘ã€‘\næ­¤æ“ä½œå°‡åŒæ™‚æ°¸ä¹…åˆªé™¤è©²åˆ†é¡ä¸‹çš„ ${stickersInCateogry} å€‹è¡¨æƒ…åŒ…ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`
                : `ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Š${category.name}ã€‹å—ï¼Ÿ`;

            const confirmed = await showCustomConfirm(
                'ç¢ºèªåˆªé™¤åˆ†é¡', 
                confirmMessage, 
                { confirmButtonClass: 'btn-danger' }
            );

            if (confirmed) {
                try {
                    // ä½¿ç”¨äº‹å‹™ç¢ºä¿æ“ä½œçš„åŸå­æ€§
                    await db.transaction('rw', db.stickerCategories, db.userStickers, async () => {
                        // 1. æ‰¾åˆ°è©²åˆ†é¡ä¸‹æ‰€æœ‰è¡¨æƒ…çš„ID
                        const stickerIdsToDelete = await db.userStickers.where('categoryId').equals(categoryId).primaryKeys();
                        
                        // 2. æ‰¹é‡åˆªé™¤é€™äº›è¡¨æƒ…
                        if (stickerIdsToDelete.length > 0) {
                            await db.userStickers.bulkDelete(stickerIdsToDelete);
                        }

                        // 3. åˆªé™¤åˆ†é¡æœ¬èº«
                        await db.stickerCategories.delete(categoryId);
                    });

                    // æ›´æ–°å‰ç«¯ state å’Œ UI
                    state.userStickers = await db.userStickers.toArray();
                    if (activeStickerCategoryId === categoryId) {
                        activeStickerCategoryId = 'all'; // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰åˆ†é¡ï¼Œå°±åˆ‡å›â€œå…¨éƒ¨â€
                    }
                    await renderStickerCategoriesInManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
                    await renderStickerPanel(); // åˆ·æ–°ä¸»é¢æ¿
                    
                    alert(`åˆ†é¡ã€Š${category.name}ã€‹åŠå…¶ä¸‹çš„è¡¨æƒ…å·²æˆåŠŸåˆªé™¤ã€‚`);

                } catch (error) {
                    console.error("åˆªé™¤åˆ†é¡åŠè¡¨æƒ…æ™‚å‡ºéŒ¯:", error);
                    alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤è³‡è¨Šã€‚");
                }
            }
        }

// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ switchStickerCategory å‡½æ•¸ â–¼â–¼â–¼
        function switchStickerCategory(categoryId) {
            activeStickerCategoryId = categoryId;
            document.querySelectorAll('.sticker-category-tab').forEach(tab => {
                tab.classList.toggle('active', String(tab.dataset.categoryId) === String(categoryId));
            });
            renderStickerPanel(false);
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘åˆ‡æ›åˆ†é¡æ™‚ï¼Œé‡ç½®å…¨é¸æ¡†çš„ç‹€æ…‹
            const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');
            if(selectAllCheckbox) selectAllCheckbox.checked = false;
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘åƒ…åŒ¯å‡ºç•¶å‰å–®å€‹èŠå¤©çš„å‚™ä»½
 */
async function exportSingleChat() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    try {
        const backupData = {
            type: 'EPhoneSingleChat', // ç‰¹æ®Šæ¨™è¨˜ï¼Œç”¨æ–¼å°å…¥æ™‚é©—è­‰
            version: 1,
            chatData: chat
        };

        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        // æª”æ¡ˆåå°‡ä½¿ç”¨è§’è‰²çš„å‚™è¨»å
        link.download = `EPhone-Chat-${chat.name}-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', `èˆ‡â€œ${chat.name}â€çš„èŠå¤©è¨˜éŒ„å·²æˆåŠŸåŒ¯å‡ºï¼`);

    } catch (error) {
        console.error("åŒ¯å‡ºå–®å€‹èŠå¤©æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘å°‡å–®å€‹èŠå¤©çš„å‚™ä»½å°å…¥ä¸¦è¦†è“‹ç•¶å‰èŠå¤©
 * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„ .json å‚™ä»½æª”æ¡ˆ
 */
async function importSingleChat(file) {
    if (!file || !state.activeChatId) return;
    const currentChatId = state.activeChatId;
    const currentChat = state.chats[currentChatId];

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        // 1. é©—è­‰æª”æ¡ˆæ ¼å¼
        if (data.type !== 'EPhoneSingleChat' || !data.chatData) {
            throw new Error("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œé€™ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„å–®èŠå‚™ä»½æª”æ¡ˆã€‚");
        }

        // 2. å½ˆå‡ºæœ€çµ‚è­¦å‘Š
        const confirmed = await showCustomConfirm(
            'åš´é‡è­¦å‘Šï¼',
            `é€™å°‡ç”¨å‚™ä»½æª”æ¡ˆä¸­çš„è³‡æ–™ã€å®Œå…¨è¦†è“‹ã€‘ç•¶å‰èˆ‡â€œ${currentChat.name}â€çš„èŠå¤©è¨˜éŒ„å’Œè¨­ç½®ã€‚æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼<br><br><strong>ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ</strong>`,
            { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªè¦†è“‹' }
        );

        if (!confirmed) return;

        // 3. åŸ·è¡Œè¦†è“‹æ“ä½œ
        const importedChatData = data.chatData;
        
        // ä¿æŒç•¶å‰çš„IDä¸è®Šï¼Œåªç”¨å°å…¥çš„è³‡æ–™è¦†è“‹å…§å®¹
        importedChatData.id = currentChatId; 
        
        // æ›´æ–°è³‡æ–™åº«å’Œè¨˜æ†¶é«”ç‹€æ…‹
        await db.chats.put(importedChatData);
        state.chats[currentChatId] = importedChatData;

        // 4. æˆåŠŸæç¤ºä¸¦åˆ·æ–°
        await showCustomAlert('å°å…¥æˆåŠŸ', 'èŠå¤©è¨˜éŒ„å·²æˆåŠŸè¦†è“‹ï¼æ­£åœ¨åˆ·æ–°ä»‹é¢...');
        
        // åˆ·æ–°UI
        renderChatInterface(currentChatId);
        renderChatList();
        document.getElementById('chat-settings-btn').click(); // é‡æ–°æ‰“é–‹è¨­ç½®ä»¥é¡¯ç¤ºæœ€æ–°è³‡æ–™

    } catch (error) {
        console.error("å°å…¥å–®å€‹èŠå¤©æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('å°å…¥å¤±æ•—', `æ–‡ä»¶è§£ææˆ–æ‡‰ç”¨å¤±æ•—: ${error.message}`);
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneåŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒJSä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹è§’è‰²é¸æ“‡ä»‹é¢
 */
function openCharacterSelector() {
    renderCharacterSelector();
    showScreen('character-selection-screen');
}

/**
 * æ¸²æŸ“è§’è‰²é¸æ“‡åˆ—è¡¨
 */
function renderCharacterSelector() {
    const gridEl = document.getElementById('character-grid');
    gridEl.innerHTML = '';
    
    // åªç¯©é¸å‡ºå–®èŠè§’è‰²
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
        gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰å¯ä»¥æŸ¥çœ‹æ‰‹æ©Ÿçš„è§’è‰²å“¦~</p>';
        return;
    }

    characters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'character-select-item';
        item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${char.name}</span>
        `;
        item.addEventListener('click', () => switchToCharacterPhone(char.id));
        gridEl.appendChild(item);
    });
}

        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²æ›´æ–°çš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ switchToCharacterPhone å‡½æ•¸ â–¼â–¼â–¼
        /**
         * åˆ‡æ›åˆ°æŒ‡å®šè§’è‰²çš„æ‰‹æ©Ÿä»‹é¢
         * @param {string} characterId - è§’è‰²çš„ID
         */
        async function switchToCharacterPhone(characterId) {
            activeCharacterId = characterId;
            console.log(`å·²åˆ‡æ›åˆ°è§’è‰² ${characterId} çš„æ‰‹æ©Ÿ`);
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘èª¿ç”¨æ–°çš„æ‡‰ç”¨å‡½æ•¸ä¾†è¨­ç½®å£ç´™å’Œåœ–ç¤º
            applyCPhoneWallpaper();
            applyCPhoneAppIcons();
            
            // æ¸²æŸ“ä¸¦é¡¯ç¤ºCphoneçš„ä¸»è¢å¹•
            renderCharHomeScreen();
            showScreen('character-phone-screen');
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * è¿”å›åˆ°ä½¿ç”¨è€…è‡ªå·±çš„æ‰‹æ©Ÿä¸»è¢å¹•
 */
function switchToMyPhone() {
    activeCharacterId = null;
    console.log("å·²è¿”å›æˆ‘çš„æ‰‹æ©Ÿ");
    showScreen('home-screen');
}

/**
 * æ¸²æŸ“Cphoneçš„ä¸»è¢å¹•ï¼ˆä¸»è¦æ˜¯æ›´æ–°æ™‚é˜ï¼‰
 */
function renderCharHomeScreen() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
    document.getElementById('char-main-time').textContent = timeString;
    document.getElementById('char-main-date').textContent = dateString;
    switchToCharScreen('char-home-screen');
}

/**
 * åœ¨Cphoneå…§éƒ¨åˆ‡æ›ä¸åŒçš„Appè¢å¹•
 * @param {string} screenId - è¦é¡¯ç¤ºçš„è§’è‰²Appè¢å¹•ID
 */
function switchToCharScreen(screenId) {
    document.querySelectorAll('.char-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}
// â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡æ­¤å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸï¼Œè®“onclickå¯ä»¥èª¿ç”¨ â–¼â–¼â–¼
window.switchToCharScreen = switchToCharScreen;
// â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V3.0 | æœ€çµ‚ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ openCharApp â–¼â–¼â–¼
         /**
         * ã€ç¸½åˆ†ç™¼ | V3.0 | æœ€çµ‚ä¿®å¾©ç‰ˆ | å·²æ·»åŠ éŸ³æ¨‚Appã€‘æ‰“é–‹Cphoneå…§çš„App
         * @param {string} appName - Appçš„ç°¡ç¨± (qq, album, amap...)
         */
        async function openCharApp(appName) {
            if (!activeCharacterId) return;
            const char = state.chats[activeCharacterId];
            
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨æ‰“é–‹Appå‰è¨˜éŒ„ä½¿ç”¨æ—¥èªŒ â–¼â–¼â–¼
    await logAppUsage(activeCharacterId, appName);
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

            switch(appName) {
                case 'qq':
                    renderCharSimulatedQQ();
                    switchToCharScreen('char-qq-screen');
                    break;
                case 'album':
                    renderCharAlbum();
                    switchToCharScreen('char-album-screen');
                    break;
                case 'browser':
                    renderCharBrowserHistory();
                    switchToCharScreen('char-browser-screen');
                    break;
                case 'taobao':
                    renderCharTaobao();
                    switchToCharScreen('char-taobao-screen');
                    break;
                case 'memo':
                    renderCharMemoList();
                    switchToCharScreen('char-memo-screen');
                    break;
                case 'diary':
                    renderCharDiaryList();
                    switchToCharScreen('char-diary-screen');
                    break;
                case 'amap':
                    renderCharAmap();
                    switchToCharScreen('char-amap-screen');
                    break;
                
                // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ â–¼â–¼â–¼
                // æˆ‘å€‘ç¾åœ¨æ·»åŠ äº†å° 'music' çš„è™•ç†é‚è¼¯
                case 'music':
                    renderCharMusicScreen(); // æ¸²æŸ“ç¶²æ˜“é›²éŸ³æ¨‚æ¸…å–®
                    switchToCharScreen('char-music-screen'); // é¡¯ç¤ºç¶²æ˜“é›²éŸ³æ¨‚è¢å¹•
                    break;
                // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

                case 'usage':
                    renderCharAppUsage();
                    switchToCharScreen('char-usage-screen');
                    break;
            }
        }
        // â–¼â–¼â–¼ ã€V3.2 | æè¿°é¡¯ç¤ºç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderCharAlbum å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | V3.2 çµ‚æ¥µé˜²ç©ºçª—+ç”Ÿåœ–é–‹é—œ+æè¿°é¡¯ç¤ºç‰ˆã€‘æ¸²æŸ“è§’è‰²ç›¸å†Š
         */
        async function renderCharAlbum() {
            const gridEl = document.getElementById('char-album-grid');
            gridEl.innerHTML = '';
            if (!activeCharacterId) return;
            const char = state.chats[activeCharacterId];
        
            const photos = char.simulatedAlbum || [];
        
            if (photos.length === 0) {
                gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„ç›¸å†Šé‚„æ˜¯ç©ºçš„ï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›ç…§ç‰‡å§ï¼</p>';
                return;
            }
        
            const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'char-photo-item';
                item.dataset.description = photo.description;
                gridEl.appendChild(item);

                
                // 1. æª¢æŸ¥å…¨åŸŸçš„ç”Ÿåœ–é–‹é—œæ˜¯å¦é–‹å•Ÿ
                if (state.globalSettings.enableAiDrawing) {
                    // --- å¦‚æœé–‹é—œã€é–‹å•Ÿã€‘ï¼ŒåŸ·è¡ŒåŸä¾†çš„ç”Ÿåœ–é‚è¼¯ ---
                    item.style.backgroundColor = '#e9ecef';
                    const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
                    const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
                    const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;
                    
                    const img = new Image();
                    img.onload = function() { item.style.backgroundImage = `url(${this.src})`; };
                    img.onerror = function() { item.style.backgroundImage = `url(${fallbackImageUrl})`; };
                    img.src = imageUrl;

                } else {
                    // --- å¦‚æœé–‹é—œã€é—œé–‰ã€‘ï¼Œå‰‡ç›´æ¥é¡¯ç¤ºæè¿°æ–‡å­—ï¼ ---
                    item.style.backgroundColor = '#f0f2f5'; // çµ¦ä¸€å€‹æ·¡æ·¡çš„èƒŒæ™¯è‰²
                    item.style.border = '1px solid #e0e0e0'; // åŠ ä¸€å€‹ç´°é‚Šæ¡†ï¼Œæ›´æœ‰å¡ç‰‡æ„Ÿ
                    
                    // å‰µå»ºä¸€å€‹æ–°çš„ <p> å…ƒç´ ä¾†å­˜æ”¾æè¿°
                    const descriptionEl = document.createElement('p');
                    descriptionEl.className = 'char-photo-description'; // æ‡‰ç”¨æˆ‘å€‘å‰›å‰›æ·»åŠ çš„CSSæ¨£å¼
                    descriptionEl.textContent = photo.description || '(é€™å¼µç…§ç‰‡æ²’æœ‰æè¿°)'; // é¡¯ç¤ºæè¿°ï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºæç¤º
                    
                    // å°‡æè¿°å…ƒç´ æ·»åŠ åˆ°æ ¼å­è£¡
                    item.appendChild(descriptionEl);
                }
       
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘å‹•æ…‹ç”Ÿæˆä¸¦æ¸²æŸ“è§’è‰²çš„æµè¦½å™¨æ­·å²è¨˜éŒ„
 */
function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    // é€™è£¡æˆ‘å€‘åŸºæ–¼è§’è‰²çš„åå­—å’Œäººè¨­ï¼Œå‹•æ…‹ç”Ÿæˆä¸€äº›çœ‹èµ·ä¾†åˆç†çš„æ­·å²è¨˜éŒ„
    const historyKeywords = [char.name, "æ„›å¥½", "æ—…éŠ", "ç¾é£Ÿ", "æ–°è", ...char.settings.aiPersona.split(/ï¼Œ|ã€‚|\s/).slice(0, 5)];
    const historySites = ["çŸ¥ä¹", "Bilibili", "å°ç´…æ›¸", "å¾®åš", "ç¶­çªç™¾ç§‘"];

    for (let i = 0; i < 15; i++) {
        const keyword = historyKeywords[Math.floor(Math.random() * historyKeywords.length)];
        const site = historySites[Math.floor(Math.random() * historySites.length)];
        const item = document.createElement('div');
        item.className = 'char-browser-item';
        item.innerHTML = `
            <div class="title">${keyword} - ${site}</div>
            <div class="url">www.${site.toLowerCase()}.com/${keyword}</div>
        `;
        listEl.appendChild(item);
    }
}

        // â–¼â–¼â–¼ ã€V3.1 | ç”Ÿåœ–é–‹é—œ+æè¿°é¡¯ç¤º+ç‹€æ…‹é¡¯ç¤ºç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderCharTaobao â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | V3.1 ç„¡éŒ¢åŒ…ç‰ˆ | æœ€çµ‚ä¿®å¾©ã€‘æ¸²æŸ“è§’è‰²çš„æ·˜å¯¶â€œè³¼è²·è¨˜éŒ„â€é é¢
         */
        function renderCharTaobao() {
            const gridEl = document.getElementById('char-product-grid');
            gridEl.innerHTML = '';
            if (!activeCharacterId) return;

            const char = state.chats[activeCharacterId];
            const purchases = char.simulatedTaobaoHistory?.purchases || [];

            if (purchases.length === 0) {
                gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAæœ€è¿‘å¥½åƒä»€éº¼éƒ½æ²’è²·å‘¢ï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›è¨˜éŒ„å§ï¼</p>';
                return;
            }

            purchases.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'char-product-item';
                itemEl.dataset.reason = item.reason;
                
                let imageOrTextHtml;
                if (state.globalSettings.enableAiDrawing) {
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt || 'a random product')}`;
                    imageOrTextHtml = `<img src="${imageUrl}" class="product-image">`;
                } else {
                    imageOrTextHtml = `
                        <div class="char-product-description-overlay">
                            <p class="char-photo-description">${item.reason || '(ç„¡è³¼è²·ç†ç”±)'}</p>
                        </div>
                    `;
                }

                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ·»åŠ äº† item.status çš„é¡¯ç¤º â–¼â–¼â–¼
                itemEl.innerHTML = `
                    ${imageOrTextHtml}
                    <div class="product-info">
                        <div class="product-name">${item.itemName}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div class="product-price">${(item.price || 0).toFixed(2)}</div>
                            <div class="char-product-status">${item.status}</div>
                        </div>
                    </div>
                `;
                // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
                gridEl.appendChild(itemEl);
            });
        }
/**
 * åˆ‡æ›å›Cphoneçš„ä¸»è¢å¹•
 */
function switchToCharHomeScreen() {
    switchToCharScreen('char-home-screen');
}


// --- CphoneAppçš„å…·é«”åŠŸèƒ½ ---

/**
 * æ¸²æŸ“è§’è‰²è¦–è§’çš„QQèŠå¤©æ¸…å–® (ç°¡åŒ–ç‰ˆ)
 */
function renderCharChatList() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    // æ‰¾å‡ºæ‰€æœ‰èˆ‡è©²è§’è‰²ç›¸é—œçš„èŠå¤©
    const relatedChats = Object.values(state.chats).filter(chat => {
        // æ¢ä»¶1: èˆ‡ç”¨æˆ¶çš„å–®èŠ
        if (chat.id === activeCharacterId) return true;
        // æ¢ä»¶2: è§’è‰²æ‰€åœ¨çš„ç¾¤èŠ
        if (chat.isGroup && chat.members.some(m => m.id === activeCharacterId)) return true;
        return false;
    });

    relatedChats.forEach(chat => {
        const item = createChatListItem(chat); // è¤‡ç”¨ä¸»æ¸…å–®çš„æ¸²æŸ“å‡½æ•¸
        listEl.appendChild(item);
    });
}

/**
 * è¨˜éŒ„Appä½¿ç”¨æ—¥èªŒ
 */
async function logAppUsage(characterId, appName) {
    const char = state.chats[characterId];
    if (!char) return;
    if (!char.appUsageLog) {
        char.appUsageLog = [];
    }
    char.appUsageLog.push({
        appName: appName,
        timestamp: Date.now()
    });
    // ä¿ç•™æœ€è¿‘50æ¢è¨˜éŒ„
    if (char.appUsageLog.length > 50) {
        char.appUsageLog.shift();
    }
    await db.chats.put(char);
}

/**
 * æ¸²æŸ“Appä½¿ç”¨è¨˜éŒ„
 */
function renderCharAppUsage() {
    const listEl = document.getElementById('char-usage-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const log = (char.appUsageLog || []).slice().reverse(); // å¾æ–°åˆ°èˆŠé¡¯ç¤º

    if (log.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰ä»»ä½•ä½¿ç”¨è¨˜éŒ„ã€‚</p>';
        return;
    }

    const appNameMap = {
        'qq': 'QQ', 'album': 'ç›¸å†Š', 'browser': 'æµè¦½å™¨', 'taobao': 'æ·˜å¯¶',
        'memo': 'å‚™å¿˜éŒ„', 'diary': 'æ—¥è¨˜', 'amap': 'é«˜å¾·åœ°åœ–', 'usage': 'Appè¨˜éŒ„'
    };

    log.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'usage-item';
        item.innerHTML = `
            <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
            <div class="action">æ‰“é–‹äº† <strong>${appNameMap[entry.appName] || entry.appName}</strong></div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ¨¡æ“¬è§’è‰²ç™¼é€ä½ç½®åˆ†äº«
 */
async function sendCharLocationShare(locationName) {
    const userChat = state.chats[activeCharacterId]; // ç²å–èˆ‡è©²è§’è‰²çš„å–®èŠ
    if (!userChat) return;

    const msg = {
        role: 'assistant', // æ˜¯AIï¼ˆè§’è‰²ï¼‰ç™¼å‡ºçš„
        senderName: userChat.originalName,
        type: 'location_share',
        content: locationName,
        imageUrl: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg',
        timestamp: Date.now()
    };

    userChat.history.push(msg);
    await db.chats.put(userChat);
    
    // å¦‚æœç•¶å‰æ­£èˆ‡è©²è§’è‰²èŠå¤©ï¼Œå‰‡å³æ™‚é¡¯ç¤º
    if (state.activeChatId === activeCharacterId) {
        appendMessage(msg, userChat);
    }
    
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `â€œ${userChat.name}â€ çš„ä½ç½®å·²ç™¼é€åˆ°ä½ å€‘çš„èŠå¤©ä¸­ã€‚`);
}


/**
 * ã€V2.1 | å…¨å±æŸ¥çœ‹æœ€çµ‚ç‰ˆã€‘é»æ“Šå‚™å¿˜éŒ„åˆ—è¡¨é …æ™‚ï¼Œæ‰“é–‹è©³æƒ…é é¢æŸ¥çœ‹å…¶å…§å®¹
 * @param {number} memoId - è¦æŸ¥çœ‹çš„å‚™å¿˜éŒ„çš„ID
 */
async function viewMemo(memoId) {
    const char = state.chats[activeCharacterId];
    if (!char || !char.memos) return;

    const memo = char.memos.find(m => m.id === memoId);
    if (memo) {
        // 1. ã€æ ¸å¿ƒä¿®å¾©ã€‘ç¾åœ¨æˆ‘å€‘ç›´æ¥é€šéIDæŸ¥æ‰¾æ¨™é¡Œå’Œå…§å®¹å…ƒç´ 
        const titleEl = document.getElementById('char-memo-detail-title');
        const contentEl = document.getElementById('char-memo-detail-content');

        // 2. å°‡å‚™å¿˜éŒ„çš„è³‡æ–™å¡«å……é€²å»
        if (titleEl) titleEl.textContent = memo.title;
        if (contentEl) contentEl.value = memo.content;

        // 3. åˆ‡æ›åˆ°æ–°çš„è©³æƒ…é è¢å¹•
        switchToCharScreen('char-memo-detail-screen');
    }
}

/**
 * ã€V2.0 | æ”¯æŒæ¨™é¡Œã€‘æ¸²æŸ“Cphoneçš„å‚™å¿˜éŒ„åˆ—è¡¨
 */
function renderCharMemoList() {
    const listEl = document.getElementById('char-memo-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const memos = (char.memos || []).slice().reverse();

    if (memos.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é‚„æ²’æœ‰å‚™å¿˜éŒ„ã€‚</p>';
        return;
    }

    memos.forEach(memo => {
        const item = document.createElement('div');
        // è¤‡ç”¨ç¾æœ‰çš„ list-item æ¨£å¼ï¼Œç¾è§€ä¸”çµ±ä¸€
        item.className = 'list-item'; 
        item.innerHTML = `
            <div class="item-title">${memo.title}</div>
            <div class="item-content">${(memo.content || '').split('\n')[0]}</div>
        `;
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘é»æ“Šåˆ—è¡¨é …ç¾åœ¨æ˜¯èª¿ç”¨ viewMemo æŸ¥çœ‹å‡½æ•¸
        item.addEventListener('click', () => viewMemo(memo.id));
        addLongPressListener(item, () => deleteMemo(memo.id));
        listEl.appendChild(item);
    });
}

/**
 * ã€V2.1 | æµç¨‹ä¿®æ­£ã€‘æ‰“é–‹ç·¨è¼¯å™¨ä»¥å‰µå»ºæ–°çš„å‚™å¿˜éŒ„
 */
async function openMemoEditor(memoId = null) {
    editingMemoId = null; 
    
    // ï¼ˆé€™éƒ¨åˆ†é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼‰
    const newTitle = await showCustomPrompt("æ–°å»ºå‚™å¿˜éŒ„", "è«‹è¼¸å…¥æ¨™é¡Œ");
    if (newTitle === null || !newTitle.trim()) return;

    const newContent = await showCustomPrompt(`æ¨™é¡Œ: ${newTitle}`, "è«‹è¼¸å…¥å‚™å¿˜éŒ„å…§å®¹", "", 'textarea');
    if (newContent !== null) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ä¿å­˜å¾Œï¼Œç¢ºä¿æˆ‘å€‘åœç•™åœ¨å‚™å¿˜éŒ„åˆ—è¡¨é 
        await saveMemo({ title: newTitle.trim(), content: newContent });
        switchToCharScreen('char-memo-screen'); // ç¢ºä¿é¡¯ç¤ºçš„æ˜¯æ¸…å–®
    }
}

/**
 * ã€V2.0 | æ”¯æŒæ¨™é¡Œã€‘ä¿å­˜æ–°çš„å‚™å¿˜éŒ„
 * @param {object} memoData - åŒ…å« title å’Œ content çš„ç‰©ä»¶
 */
async function saveMemo(memoData) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];
    
    // é€™å€‹å‡½æ•¸ç¾åœ¨åªè™•ç†â€œæ–°å»ºâ€
    char.memos.push({ 
        id: Date.now(), 
        title: memoData.title, 
        content: memoData.content 
    });
    
    await db.chats.put(char);
    renderCharMemoList();
}

async function saveMemo(content) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];
    
    if (editingMemoId) {
        const memo = char.memos.find(m => m.id === editingMemoId);
        if (memo) memo.content = content;
    } else {
        char.memos.push({ id: Date.now(), content: content });
    }
    
    await db.chats.put(char);
    renderCharMemoList();
    editingMemoId = null;
}



        // â–¼â–¼â–¼ ã€V2.0 | AIç”Ÿæˆç‰ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œæ›¿æ›æ‰€æœ‰èˆŠçš„æ—¥è¨˜åŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–° | V3.0 AIæŒ‡ä»¤å¼·åŒ–ç‰ˆã€‘ç•¶ä½¿ç”¨è€…é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆé¡æ¯”ç›¸å†Šå…§å®¹
 */
async function handleGenerateSimulatedDiaries() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨è«‹æ±‚â€œ${chat.name}â€ç¿»é–‹TAçš„æ—¥è¨˜æœ¬...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨å’Œæ•…äº‹ä½œå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºã€5åˆ°8ç¯‡ã€‘TAæœ€è¿‘å¯èƒ½æœƒå¯«çš„æ—¥è¨˜ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€æ™‚é–“ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **${new Date().toLocaleDateString('zh-CN')}**ã€‚
    -   ä½ ç”Ÿæˆçš„ã€æ‰€æœ‰ã€‘æ—¥è¨˜çš„æ¨™é¡Œæ—¥æœŸï¼Œã€å¿…é ˆã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€çµ•å°ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªä¾†çš„æ—¥æœŸï¼
2.  **ã€æ²‰æµ¸æ„Ÿã€‘**: æ¯ä¸€ç¯‡æ—¥è¨˜éƒ½å¿…é ˆä½¿ç”¨ã€ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ä¾†å¯«ï¼Œä¸¦ä¸”è¦å……æ»¿è§’è‰²çš„å€‹äººæƒ…æ„Ÿã€æ€è€ƒå’Œç§˜å¯†ã€‚åœ¨æ—¥è¨˜ä¸­æè¿°è‡ªå·±çš„è¡Œç‚ºæˆ–æƒ³æ³•æ™‚ï¼Œã€çµ•å°ç¦æ­¢ã€‘ä½¿ç”¨ç¬¬ä¸‰äººç¨±â€œä»–â€æˆ–â€œå¥¹â€ (TA)ã€‚
3.  **ã€é•·åº¦ã€‘**: æ¯ä¸€ç¯‡æ—¥è¨˜çš„æ­£æ–‡é•·åº¦ã€å¿…é ˆä¸å°‘æ–¼300å­—ã€‘ã€‚
4.  **ã€æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä»£è¡¨ä¸€ç¯‡æ—¥è¨˜ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "é€™ç¯‡æ—¥è¨˜çš„æ¨™é¡Œï¼Œä¾‹å¦‚ï¼š9æœˆ20æ—¥ æ™´",
        "content": "é€™è£¡æ˜¯æ—¥è¨˜çš„è©³ç´°æ­£æ–‡ï¼Œå¿…é ˆæ”¯æŒåˆ†è¡Œç¬¦è™Ÿ\\nï¼Œä¸¦ä¸”å¿…é ˆå·§å¦™åœ°ä½¿ç”¨ä¸‹é¢çš„ã€æ—¥è¨˜å°ˆå±¬Markdownèªæ³•ã€‘ä¾†è±å¯Œæ–‡æœ¬è¡¨ç¾åŠ›ã€‚"
      }
    ]
    \`\`\`
5.  **ã€é ç•™ä½ç½®æ›¿æ› (æœ€é«˜å„ªå…ˆé †åº)ã€‘**: åœ¨ä½ çš„æ—¥è¨˜å…§å®¹ä¸­ï¼Œã€çµ•å°ä¸èƒ½ã€‘å‡ºç¾ "{{user}}" é€™å€‹é ç•™ä½ç½®ã€‚ä½ ã€å¿…é ˆã€‘ä½¿ç”¨ â€œ${userDisplayNameForAI}â€ ä¾†æŒ‡ä»£ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰ã€‚
6.  **ã€æ—¥è¨˜å°ˆå±¬Markdownèªæ³• (å¿…é ˆä½¿ç”¨ï¼)ã€‘**:
    -   \`**åŠ ç²—æ–‡å­—**\`: ç”¨æ–¼å¼·èª¿ã€‚
    -   \`~~åŠƒæ‰çš„æ–‡å­—~~\`: ç”¨æ–¼è¡¨ç¤ºæ”¹è®Šä¸»æ„æˆ–è‡ªæˆ‘å¦å®šã€‚
    -   \`!h{é»ƒè‰²é«˜äº®}\`: ç”¨æ–¼æ¨™è¨˜é—œéµå­—æˆ–é‡è¦è³‡è¨Šã€‚
    -   \`!u{ç²‰è‰²åº•ç·š}\`: ç”¨æ–¼æ¨™æ³¨äººåã€åœ°åæˆ–ç‰¹æ®Šåè©ã€‚
    -   \`!e{ç²‰è‰²å¼·èª¿}\`: ç”¨æ–¼è¡¨é”å¼·çƒˆçš„æƒ…ç·’ã€‚
    -   \`!w{æ‰‹å¯«é«”}\`: ç”¨æ–¼å¯«ä¸‹å¼•è¨€ã€æ­Œè©æˆ–ç‰¹æ®Šç­†è¨˜ã€‚
    -   \`!m{æ·©äº‚çš„æ‰‹å¯«é«”}\`: ç”¨æ–¼è¡¨é”æ¿€å‹•ã€æ…Œäº‚æˆ–æ½¦è‰è¨˜éŒ„æ™‚çš„å¿ƒæƒ…ã€‚
    -   \`||å¡—é»‘||\`: ç”¨æ–¼éš±è—ç§˜å¯†æˆ–æ•æ„Ÿè©å½™ (æ¯æ¬¡å¡—é»‘2~5å€‹å­—)ã€‚

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹æ’°å¯«é€™çµ„å……æ»¿çœŸæƒ…å¯¦æ„Ÿã€ä¸¦ç†Ÿç·´é‹ç”¨äº†Markdownèªæ³•çš„æ—¥è¨˜ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„æ—¥è¨˜å…§å®¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.95,
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆªé™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼·å¤§çš„å®¹éŒ¯è§£æé‚è¼¯ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedDiaries;
        try {
            simulatedDiaries = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        chat.diary = simulatedDiaries.map(entry => ({
            id: Date.now() + Math.random(),
            title: entry.title,
            content: entry.content,
            timestamp: Date.now()
        }));
        
        await db.chats.put(chat);
        await renderCharDiaryList();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬æ—¥è¨˜å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆæ—¥è¨˜ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}

        /**
         * ã€å…¨æ–°ã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œ+â€æ™‚ï¼Œè§¸ç™¼AIæ’°å¯«ä¸€ç¯‡æ–°æ—¥è¨˜ä¸¦è¿½åŠ åˆ°æœ«å°¾
         */
        async function handleWriteNewDiaryEntry() {
            if (!activeCharacterId) return;
            const chat = state.chats[activeCharacterId];
            if (!chat) return;
        
            await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨è«‹æ±‚â€œ${chat.name}â€å¯«ä¸€ç¯‡æ–°æ—¥è¨˜...`);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;

            const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

            const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
            const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
            const worldBookContext = (chat.settings.linkedWorldBookIds || []).map(bookId=>state.worldBooks.find(wb=>wb.id===bookId)).filter(Boolean).map(book=>`\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e=>e.enabled).map(e=>`- ${e.content}`).join('\n')}`).join('');
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©1ï¼šåœ¨é€™è£¡ä¹Ÿæ·»åŠ â€œæ™‚é–“éµå¾‹â€ â–¼â–¼â–¼
            const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨å’Œæ•…äº‹ä½œå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºã€1ç¯‡ã€‘TAä»Šå¤©å¯èƒ½æœƒå¯«çš„æ—¥è¨˜ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€ã€ã€æ™‚é–“éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘ã€‘ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **${new Date().toLocaleDateString('zh-CN')}**ã€‚
    -   ä½ ç”Ÿæˆçš„æ—¥è¨˜æ¨™é¡Œæ—¥æœŸã€å¿…é ˆã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€çµ•å°ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªä¾†çš„æ—¥æœŸï¼
2.  **ã€ã€ã€æ²‰æµ¸æ„Ÿéµå¾‹ã€‘ã€‘ã€‘**: æ—¥è¨˜å¿…é ˆä½¿ç”¨ã€ç¬¬ä¸€äººç¨±è¦–è§’ ("æˆ‘")ã€‘ä¾†å¯«ï¼Œä¸¦ä¸”è¦å……æ»¿è§’è‰²çš„å€‹äººæƒ…æ„Ÿã€æ€è€ƒå’Œç§˜å¯†ã€‚åœ¨æ—¥è¨˜ä¸­æè¿°è‡ªå·±çš„è¡Œç‚ºæˆ–æƒ³æ³•æ™‚ï¼Œã€çµ•å°ç¦æ­¢ã€‘ä½¿ç”¨ç¬¬ä¸‰äººç¨±â€œä»–â€æˆ–â€œå¥¹â€ (TA)ã€‚
3.  **ã€ã€ã€é•·åº¦éµå¾‹ã€‘ã€‘ã€‘**: æ—¥è¨˜çš„æ­£æ–‡é•·åº¦ã€å¿…é ˆä¸å°‘æ–¼300å­—ã€‘ã€‚
4.  **ã€ã€ã€æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘ã€‘ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œä¸”é™£åˆ—ä¸­ã€åªåŒ…å«ä¸€å€‹ã€‘ç‰©ä»¶ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "é€™ç¯‡æ—¥è¨˜çš„æ¨™é¡Œï¼Œä¾‹å¦‚ï¼š9æœˆ20æ—¥ æ™´",
        "content": "é€™è£¡æ˜¯æ—¥è¨˜çš„è©³ç´°æ­£æ–‡ï¼Œå¿…é ˆæ”¯æŒåˆ†è¡Œç¬¦è™Ÿ\\nï¼Œä¸¦ä¸”å¿…é ˆå·§å¦™åœ°ä½¿ç”¨ä¸‹é¢çš„ã€æ—¥è¨˜å°ˆå±¬Markdownèªæ³•ã€‘ä¾†è±å¯Œæ–‡æœ¬è¡¨ç¾åŠ›ã€‚"
      }
    ]
    \`\`\`
5.  **ã€ã€ã€æ—¥è¨˜å°ˆå±¬Markdownèªæ³• (å¿…é ˆä½¿ç”¨ï¼)ã€‘ã€‘ã€‘**:
    -   \`**åŠ ç²—æ–‡å­—**\`: ç”¨æ–¼å¼·èª¿ã€‚
    -   \`~~åŠƒæ‰çš„æ–‡å­—~~\`: ç”¨æ–¼è¡¨ç¤ºæ”¹è®Šä¸»æ„æˆ–è‡ªæˆ‘å¦å®šã€‚
    -   \`!h{é»ƒè‰²é«˜äº®}\`: ç”¨æ–¼æ¨™è¨˜é—œéµå­—æˆ–é‡è¦è³‡è¨Šã€‚
    -   \`!u{ç²‰è‰²åº•ç·š}\`: ç”¨æ–¼æ¨™æ³¨äººåã€åœ°åæˆ–ç‰¹æ®Šåè©ã€‚
    -   \`!e{ç²‰è‰²å¼·èª¿}\`: ç”¨æ–¼è¡¨é”å¼·çƒˆçš„æƒ…ç·’ã€‚
    -   \`!w{æ‰‹å¯«é«”}\`: ç”¨æ–¼å¯«ä¸‹å¼•è¨€ã€æ­Œè©æˆ–ç‰¹æ®Šç­†è¨˜ã€‚
    -   \`!m{æ·©äº‚çš„æ‰‹å¯«é«”}\`: ç”¨æ–¼è¡¨é”æ¿€å‹•ã€æ…Œäº‚æˆ–æ½¦è‰è¨˜éŒ„æ™‚çš„å¿ƒæƒ…ã€‚
    -   \`||å¡—é»‘||\`: ç”¨æ–¼éš±è—ç§˜å¯†æˆ–æ•æ„Ÿè©å½™(æ¯æ¬¡å¡—é»‘2~5å€‹å­—)ã€‚

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹æ’°å¯«é€™ç¯‡å……æ»¿çœŸæƒ…å¯¦æ„Ÿã€ä¸¦ç†Ÿç·´é‹ç”¨äº†Markdownèªæ³•çš„æ—¥è¨˜ã€‚`;
        
            try {
                const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œå¯«ä¸€ç¯‡æ–°æ—¥è¨˜ã€‚" }];
                let isGemini = proxyUrl.includes('generativelanguage');
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
                const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                        temperature: state.globalSettings.apiTemperature || 0.95,
                    })
                });
                if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
                const data = await response.json();
                const aiResponseContent = getGeminiResponseText(data);
                
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©2ï¼šåœ¨é€™è£¡ä¹Ÿä½¿ç”¨çµ‚æ¥µå®¹éŒ¯è§£ææ–¹æ¡ˆ â–¼â–¼â–¼
                const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
                if (!jsonMatch || !jsonMatch[0]) {
                    throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
                }
                const cleanedJsonString = jsonMatch[0];
                let newDiaryEntry;
                try {
                    newDiaryEntry = JSON.parse(cleanedJsonString)[0];
                } catch (e) {
                    throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
                }
                // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
                
                if (!chat.diary) chat.diary = [];
                
                chat.diary.push({
                    id: Date.now(),
                    title: newDiaryEntry.title,
                    content: newDiaryEntry.content,
                    timestamp: Date.now()
                });
                
                await db.chats.put(chat);
                await renderCharDiaryList();
        
            } catch (error) {
                console.error("ç”Ÿæˆæ–°æ—¥è¨˜å¤±æ•—:", error);
                await showCustomAlert("ç”Ÿæˆå¤±æ•—", `éŒ¯èª¤: ${error.message}`);
            }
        }

        /**
         * ã€å…¨æ–° | V2.0ã€‘æ¸²æŸ“Cphoneçš„æ—¥è¨˜åˆ—è¡¨
         */
        function renderCharDiaryList() {
            const listEl = document.getElementById('char-diary-list');
            listEl.innerHTML = '';
            const char = state.chats[activeCharacterId];
            const diaries = (char.diary || []).slice().reverse();

            if (diaries.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">æ—¥è¨˜æœ¬é‚„æ˜¯ç©ºçš„ã€‚</p>';
                return;
            }

            diaries.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-title">${entry.title}</div>
                    <div class="item-content">${new Date(entry.timestamp).toLocaleDateString()}</div>
                `;
                item.addEventListener('click', () => viewDiary(entry.id));
                addLongPressListener(item, () => deleteDiary(entry.id));
                listEl.appendChild(item);
            });
        }

    // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V2.0 ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ viewDiary å‡½æ•¸ â–¼â–¼â–¼
    /**
     * ã€V2.0 | æ”¯æŒæ”¶è—ã€‘é»æ“Šæ—¥è¨˜åˆ—è¡¨é …æ™‚ï¼Œæ‰“é–‹è©³æƒ…é é¢æŸ¥çœ‹
     * @param {number} diaryId - è¦æŸ¥çœ‹çš„æ—¥è¨˜çš„ID
     */
    async function viewDiary(diaryId) {
        const char = state.chats[activeCharacterId];
        if (!char || !char.diary) return;
    
        const entry = char.diary.find(d => d.id === diaryId);
        if (entry) {
            // 1. å°‡ç•¶å‰æ—¥è¨˜ç‰©ä»¶å­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œæ–¹ä¾¿æ”¶è—åŠŸèƒ½èª¿ç”¨
            activeDiaryForViewing = entry;
    
            const titleEl = document.getElementById('char-diary-detail-title');
            const contentEl = document.getElementById('char-diary-detail-content');
            const favBtn = document.getElementById('favorite-diary-btn');
    
            titleEl.textContent = entry.title;
            const formattedContent = parseMarkdown(entry.content)
                .split('\n')
                .map(p => `<p>${p || '&nbsp;'}</p>`)
                .join('');
            contentEl.innerHTML = formattedContent;
    
            // 2. æª¢æŸ¥é€™ç¯‡æ—¥è¨˜æ˜¯å¦å·²è¢«æ”¶è—ï¼Œä¸¦æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const existingFavorite = await db.favorites.where({ type: 'char_diary', 'content.id': diaryId }).first();
            favBtn.classList.toggle('active', !!existingFavorite);
    
            switchToCharScreen('char-diary-detail-screen');
        }
    }
    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ”¶è—/å–æ¶ˆæ”¶è—æ—¥è¨˜çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
    /**
     * åˆ‡æ›ç•¶å‰æ—¥è¨˜çš„æ”¶è—ç‹€æ…‹
     */
    async function toggleDiaryFavorite() {
        if (!activeDiaryForViewing || !activeCharacterId) return;
    
        const diary = activeDiaryForViewing;
        const char = state.chats[activeCharacterId];
        const favBtn = document.getElementById('favorite-diary-btn');
    
        // å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
        const existingFavorite = await db.favorites.where({ type: 'char_diary', 'content.id': diary.id }).first();
    
        if (existingFavorite) {
            // å¦‚æœå·²æ”¶è—ï¼Œå‰‡å–æ¶ˆæ”¶è—
            await db.favorites.delete(existingFavorite.id);
            favBtn.classList.remove('active');
            await showCustomAlert('æ“ä½œæˆåŠŸ', 'å·²å–æ¶ˆæ”¶è—ã€‚');
        } else {
            // å¦‚æœæœªæ”¶è—ï¼Œå‰‡åŸ·è¡Œæ”¶è—
            const newFavorite = {
                type: 'char_diary',
                // å°‡æ—¥è¨˜çš„å®Œæ•´å…§å®¹ï¼Œé€£åŒä½œè€…è³‡è¨Šä¸€èµ·å­˜å…¥
                content: {
                    id: diary.id,
                    title: diary.title,
                    content: diary.content,
                    timestamp: diary.timestamp,
                    characterId: activeCharacterId,
                    characterName: char.name
                },
                timestamp: Date.now() // æ”¶è—æ“ä½œçš„æ™‚é–“
            };
            await db.favorites.add(newFavorite);
            favBtn.classList.add('active');
            await showCustomAlert('æ“ä½œæˆåŠŸ', 'å·²æˆåŠŸæ”¶è—åˆ°â€œæˆ‘çš„æ”¶è—â€é é¢ï¼');
        }
    }
    // â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘åˆªé™¤ä¸€ç¯‡æ—¥è¨˜
         * @param {number} diaryId - è¦åˆªé™¤çš„æ—¥è¨˜çš„ID
         */
        async function deleteDiary(diaryId) {
            const confirmed = await showCustomConfirm('åˆªé™¤æ—¥è¨˜', 'ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ—¥è¨˜å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const char = state.chats[activeCharacterId];
                char.diary = char.diary.filter(d => d.id !== diaryId);
                await db.chats.put(char);
                renderCharDiaryList();
            }
        }

        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–° V2.5 | ä½¿ç”¨è€…å°è©±ç½®é ‚ä¿®å¾©ç‰ˆã€‘æ¸²æŸ“è§’è‰²è¦–è§’çš„QQèŠå¤©æ¸…å–®
 */
async function renderCharSimulatedQQ() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    if (!char) return;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ 1ï¼šæ‰‹å‹•å‰µå»ºä¸¦ç½®é ‚èˆ‡ä½¿ç”¨è€…çš„çœŸå¯¦å°è©± â–¼â–¼â–¼
    const userDisplayName = char.settings.myNickname || (state.qzoneSettings.nickname || 'æˆ‘');
    const lastRealMessage = char.history.filter(m => !m.isHidden).slice(-1)[0] || { content: '...' };
    
    // æå–æœ€å¾Œä¸€æ¢æ¶ˆæ¯çš„æ–‡æœ¬å…§å®¹
    let lastMsgContent = '...';
    if (lastRealMessage) {
        if (typeof lastRealMessage.content === 'string') {
            lastMsgContent = lastRealMessage.content;
        } else if (Array.isArray(lastRealMessage.content) && lastRealMessage.content[0]?.type === 'image_url') {
            lastMsgContent = '[åœ–ç‰‡]';
        } else if (lastRealMessage.type) {
            const typeMap = { 'voice_message': '[èªéŸ³]', 'transfer': '[è½‰å¸³]', 'ai_image': '[åœ–ç‰‡]' };
            lastMsgContent = typeMap[lastRealMessage.type] || `[${lastRealMessage.type}]`;
        }
    }

    // ç²å–ç”¨æˆ¶é ­åƒå’Œé ­åƒæ¡†
    const myAvatar = char.settings.myAvatar || defaultAvatar;
    const myFrame = char.settings.myAvatarFrame || '';
    let avatarHtml;
    if (myFrame) {
        avatarHtml = `<div class="avatar-group has-frame" style="width: 45px; height: 45px;"><div class="avatar-with-frame" style="width: 45px; height: 45px;"><img src="${myAvatar}" class="avatar-img" style="border-radius: 50%;"><img src="${myFrame}" class="avatar-frame"></div></div>`;
    } else {
        avatarHtml = `<div class="avatar-group" style="width: 45px; height: 45px;"><img src="${myAvatar}" class="avatar" style="border-radius: 50%; width: 45px; height: 45px;"></div>`;
    }

    const userChatItem = document.createElement('div');
    userChatItem.className = 'chat-list-item';
    // ä½¿ç”¨ä¸€å€‹ç‰¹æ®Šçš„ç´¢å¼•-1ä¾†æ¨™è¨˜é€™æ˜¯èˆ‡ä½¿ç”¨è€…çš„çœŸå¯¦å°è©±
    userChatItem.dataset.conversationIndex = "-1"; 
    userChatItem.innerHTML = `
        ${avatarHtml}
        <div class="info">
            <div class="name-line">
                <span class="name">${userDisplayName}</span>
            </div>
            <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
        </div>
    `;
    listEl.appendChild(userChatItem);
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ 1 çµæŸ â–²â–²â–²

    const allNpcs = await db.npcs.toArray();
    const npcMap = new Map(allNpcs.map(npc => [npc.name, npc]));
    const conversations = char.simulatedConversations || [];

    if (conversations.length === 0 && !userChatItem) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ï¼Œ<br>çœ‹çœ‹TAæœ€è¿‘éƒ½å’Œèª°èŠå¤©äº†å§ï¼</p>';
        return;
    }

    conversations.forEach((convo, index) => {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ 2ï¼šè·³éAIç”Ÿæˆçš„èˆ‡ä½¿ç”¨è€…çš„å°è©±ï¼Œé¿å…é‡è¤‡ â–¼â–¼â–¼
        if (convo.type === 'private_user') {
            return;
        }
        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ 2 çµæŸ â–²â–²â–²

        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.dataset.conversationIndex = index;

        let lastMessage, avatarHtml, displayName;
        
        if (convo.type === 'group') {
            displayName = convo.groupName + ` <span class="group-tag">ç¾¤</span>`;
            lastMessage = convo.messages.slice(-1)[0] || { content: '...' };
            const groupAvatarPrompt = `logo, simple, flat design, for a group chat named '${convo.groupName}'`;
            const avatarUrl = state.globalSettings.enableAiDrawing ? `https://image.pollinations.ai/prompt/${encodeURIComponent(groupAvatarPrompt)}` : defaultGroupAvatar;
            avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;
        
        } else { // èˆ‡NPCçš„ç§èŠ
            displayName = convo.participant.name;
            lastMessage = convo.messages.slice(-1)[0] || { content: '...' };
            const npcData = npcMap.get(displayName);
            let avatarUrl = (npcData && npcData.avatar) ? npcData.avatar : 
                (state.globalSettings.enableAiDrawing ? `https://image.pollinations.ai/prompt/${encodeURIComponent(convo.participant.avatar_prompt || 'anime person')}` : defaultGroupMemberAvatar);
            avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;
        }

        let lastMsgContent = '...';
        if (lastMessage && lastMessage.content) {
            lastMsgContent = lastMessage.content;
        }
        
        item.innerHTML = `
            ${avatarHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${displayName}</span>
                </div>
                <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}
/**
 * ã€å…¨æ–° V4.0 | æŒ‡ä»¤ç°¡åŒ–çµ‚æ¥µä¿®å¾©ç‰ˆ + ç§»é™¤ç”¨æˆ¶æ¨¡æ“¬ã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆå…¨æ–°çš„é¡æ¯”å°è©±
 */
async function handleGenerateSimulatedQQ() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æ ¹æ“šâ€œ${chat.name}â€çš„è¨˜æ†¶å’Œäººè¨­ï¼Œç”Ÿæˆå…¨æ–°çš„ç¤¾äº¤å‹•æ…‹...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }
    
    const allNpcs = await db.npcs.toArray();
    const associatedNpcs = allNpcs.filter(npc => 
        npc.associatedWith && npc.associatedWith.includes(activeCharacterId)
    );
    let npcContext = "# ä½ çš„ç¤¾äº¤åœˆ (ç¶å®šçš„NPC)\n";
    if (associatedNpcs.length > 0) {
        npcContext += "é€™æ˜¯ä½ èªè­˜çš„ã€é—œä¿‚å¯†åˆ‡çš„NPCã€‚åœ¨ç”Ÿæˆå°è©±æ™‚ï¼Œä½ æ‡‰è©²ã€å„ªå…ˆã€‘èˆ‡ä»–å€‘äº’å‹•ã€‚\n";
        associatedNpcs.forEach(npc => {
            npcContext += `- **å§“å**: ${npc.name}\n  - **äººè¨­**: ${npc.persona}\n`;
        });
    } else {
        npcContext += "ï¼ˆä½ ç›®å‰æ²’æœ‰ç¶å®šçš„NPCå¤¥ä¼´ï¼Œå¯ä»¥è‡ªç”±å‰µé€ æ–°çš„NPCã€‚ï¼‰\n";
    }

    const userDisplayNameForAI = state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;
    const userNicknameInThisChat = chat.settings.myNickname || userDisplayNameForAI;
    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
const maxMemory = chat.settings.maxMemory || 10;
    const recentHistoryWithUser =chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userNicknameInThisChat : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š (ä½ å¯ä»¥å°‡å…¶ä¸­è§’è‰²ä½œç‚ºèŠå¤©ç‰©ä»¶):\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
    const characterOriginalName = chat.originalName || chat.name;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šé€™æ˜¯ä¸€å€‹å…¨æ–°çš„ã€æ›´ç°¡æ½”ã€æ›´åš´æ ¼çš„æŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç¤¾äº¤ç”Ÿæ´»æ¨¡æ“¬å™¨ï¼Œæ‰®æ¼”è§’è‰²â€œ${chat.name}â€ã€‚ä½ çš„ä»»å‹™æ˜¯è™›æ§‹å‡ºã€5åˆ°7æ®µã€‘TAæœ€è¿‘çš„QQèŠå¤©è¨˜éŒ„ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€NPCå”¯ä¸€æ€§éµå¾‹ã€‘**: åœ¨ä½ æœ¬æ¬¡ç”Ÿæˆçš„æ‰€æœ‰å°è©±ä¸­ï¼ˆåŒ…æ‹¬ç§èŠå’Œç¾¤èŠï¼‰ï¼Œæ¯ä¸€å€‹NPCçš„åå­—ã€å¿…é ˆæ˜¯ç¨ä¸€-ç„¡äºŒçš„ã€‘ã€‚çµ•å°ç¦æ­¢å‡ºç¾é‡åçš„NPCï¼Œç¦æ­¢å‡ºç¾é‡è¤‡ç¾¤èŠã€‚
2.  **ã€NPCä¾†æºã€‘**: ä½ æ‡‰è©²å„ªå…ˆå¾â€œä½ çš„ç¤¾äº¤åœˆ (ç¶å®šçš„NPC)â€å’Œâ€œä¸–ç•Œæ›¸â€ä¸­å°‹æ‰¾è§’è‰²ä½œç‚ºèŠå¤©å°è±¡ã€‚å¦‚æœä¸å¤ ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªç”±å‰µé€ å…¨æ–°çš„NPCï¼Œå°è©±å…§å®¹è¦å¤šæ¨£åŒ–ï¼Œåæ˜ è§’è‰²çš„ç”Ÿæ´»ã€‚
3.  **é—œè¯æ€§**: å°è©±å…§å®¹æ‡‰å·§å¦™åœ°åæ˜ è§’è‰²çš„é•·æœŸè¨˜æ†¶ã€ä¸–ç•Œè§€ï¼Œä»¥åŠèˆ‡ç”¨æˆ¶äº’å‹•å¯èƒ½å¸¶ä¾†çš„å¿ƒæƒ…è®ŠåŒ–ã€‚
4.  **ç°¡æ½”æ€§**: æ¯æ®µå°è©±çš„ç¸½é•·åº¦æ‡‰åœ¨8åˆ°15å¥ä¹‹é–“ã€‚
# æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
- ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ï¼Œä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
- ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ã€‚
- é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½ä»£è¡¨ä¸€æ®µå°è©±ï¼Œä¸”ã€å¿…é ˆã€‘æ˜¯ä»¥ä¸‹å…©ç¨®æ ¼å¼ä¹‹ä¸€ï¼š

// â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¼å¼Aï¼ˆèˆ‡ç”¨æˆ¶çš„ç§èŠï¼‰å·²è¢«å¾¹åº•ç§»é™¤ â–¼â–¼â–¼

### æ ¼å¼ Aï¼šèˆ‡NPCçš„ç§èŠ
\`\`\`json
{
  "type": "private_npc",
  "participant": {
    "name": "NPCçš„åå­—",
    "avatar_prompt": "(åƒ…ç•¶NPCæ˜¯æ–°å‰µé€ æ™‚æä¾›)ä¸€æ®µç”¨æ–¼ç”Ÿæˆé ­åƒçš„ã€è‹±æ–‡ã€‘é—œéµå­—, é¢¨æ ¼ç‚ºå‹•æ¼«/æ’ç•«/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"
  },
  "messages": [
    {"sender": "${characterOriginalName}", "content": "å°è©±å…§å®¹1"},
    {"sender": "NPCçš„åå­—", "content": "å°è©±å…§å®¹2"}
  ]
}
\`\`\`

### æ ¼å¼ Bï¼šç¾¤èŠ
\`\`\`json
{
  "type": "group",
  "groupName": "ä¸€å€‹è™›æ§‹çš„ç¾¤å",
  "participants": [
    {"name": "NPCæˆå“¡1", "avatar_prompt": "(åƒ…ç•¶NPCæ˜¯æ–°å‰µé€ æ™‚æä¾›) æˆå“¡1é ­åƒã€è‹±æ–‡ã€‘é—œéµå­—"},
    {"name": "NPCæˆå“¡2", "avatar_prompt": "(åƒ…ç•¶NPCæ˜¯æ–°å‰µé€ æ™‚æä¾›) æˆå“¡2é ­åƒã€è‹±æ–‡ã€‘é—œéµå­—"}
  ],
  "messages": [
    {"sender": "${characterOriginalName}", "content": "æˆ‘åœ¨ç¾¤è£¡èªªçš„è©±"},
    {"sender": "NPCæˆå“¡1", "content": "æˆå“¡1å›å¾©æˆ‘"}
  ]
}
\`\`\`

# è§’è‰²èˆ‡ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**: ${longTermMemoryContext}
- **ä¸–ç•Œè§€**: ${worldBookContext}
- **æœ€è¿‘èˆ‡ç”¨æˆ¶çš„äº’å‹•**: ${recentHistoryWithUser}
${npcContext}

ç¾åœ¨ï¼Œè«‹åš´æ ¼æŒ‰ç…§æ ¼å¼éµå¾‹ï¼Œç”ŸæˆèŠå¤©è¨˜éŒ„çš„JSONé™£åˆ—ã€‚`;
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
            
    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆé¡æ¯”èŠå¤©è¨˜éŒ„ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                })
            });

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedConversations;
        try {
            simulatedConversations = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        
        chat.simulatedConversations = simulatedConversations;
        await db.chats.put(chat);
        
        await renderCharSimulatedQQ();

        // è§¸ç™¼ä¸»å‹•æ¶ˆæ¯çš„é‚è¼¯ä¿æŒä¸è®Š
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»çµ±æŒ‡ä»¤ï¼šä½ å‰›å‰›åœ¨è‡ªå·±çš„æ‰‹æ©Ÿä¸Šæ´»å‹•äº†ä¸€ç•ªï¼ˆå’Œæœ‹å‹èŠå¤©ã€é€›ç¾¤ç­‰ï¼‰ã€‚ç¾åœ¨è«‹æ ¹æ“šä½ çš„è§’è‰²è¨­å®šï¼Œä¸»å‹•çµ¦ä½¿ç”¨è€…ç™¼ä¸€æ¢æ¶ˆæ¯ï¼Œå¯ä»¥èŠèŠä½ å‰›æ‰çœ‹åˆ°æˆ–èŠåˆ°çš„è¶£äº‹ï¼Œæˆ–è€…åƒ…åƒ…æ˜¯å•å€™ä¸€ä¸‹ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        await db.chats.put(chat);
        triggerAiResponse();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬èŠå¤©å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆé¡æ¯”èŠå¤©è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–° | V3.0 | ç”¨æˆ¶äººè¨­ä¿®å¾©ç‰ˆã€‘è™•ç†å¾CPhone QQè§¸ç™¼çš„ã€ç”¨æ–¼æ¨é€²çœŸå¯¦å°è©±çš„AIè«‹æ±‚
 */
async function handleContinueRealConversationFromCPhone() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;



    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå°è©±ã€‚');
        }

        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);
        const myNickname = chat.settings.myNickname || 'æˆ‘';

        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å¾é€™è£¡é–‹å§‹ â˜…â˜…â˜…
        // ==========================================================

        // 1. ç²å–ç”¨æˆ¶äººè¨­
        const userPersona = chat.settings.myPersona || 'ç”¨æˆ¶';

        // 2. æ³¨å…¥é•·æœŸè¨˜æ†¶ (Long-term Memory)
        const longTermMemoryContext = `# é•·æœŸè¨˜æ†¶ (å¿…é ˆåš´æ ¼éµå®ˆ)\n${
            chat.longTermMemory && chat.longTermMemory.length > 0 
                ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') 
                : '- (æš«ç„¡)'
        }`;

        // 3. æ³¨å…¥ä¸–ç•Œæ›¸ (World Book)
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => `\n### æ¢ç›®: ${entry.comment || 'ç„¡å‚™è¨»'}\n**å…§å®¹:**\n${entry.content}`)
                    .join('');
                return formattedEntries ? `\n\n## ä¸–ç•Œæ›¸: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š (å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¨­å®š)\n${linkedContents}\n`;
            }
        }
// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
        // 4. æ›´æ–° System Prompt ä»¥åŒ…å«ç”¨æˆ¶äººè¨­
        const systemPrompt = `
# ä½ çš„æ ¸å¿ƒä»»å‹™
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${chat.originalName}â€ã€‚ç”¨æˆ¶å‰›å‰›åœ¨TAçš„æ‰‹æ©Ÿï¼ˆCPhoneï¼‰ä¸Šé»æ“Šäº†ä¸€å€‹æŒ‰éˆ•ï¼Œå¸Œæœ›ä½ èƒ½ç¹¼çºŒä½ å€‘ä¹‹å‰çš„å°è©±ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆã€3åˆ°5æ¢ã€‘ç¬¦åˆä½ äººè¨­çš„ã€ç°¡çŸ­çš„ã€é€£çºŒçš„æ–°å›å¾©ã€‚

# è¼¸å‡ºæ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
- ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€æ¢æ¶ˆæ¯ã€‚
- æ ¼å¼: \`[{"type": "text", "content": "ç¬¬ä¸€å¥è©±"}, {"type": "text", "content": "ç¬¬äºŒå¥è©±"}, {"type": "sticker", "url": "...", "meaning": "..."}]\`
- ä½ å¯ä»¥è‡ªç”±çµ„åˆä½¿ç”¨ "text", "sticker", "ai_image", "voice_message" ç­‰å¤šç¨®æ¶ˆæ¯é¡å‹ã€‚

# ä½ çš„è§’è‰²è¨­å®š
${chat.settings.aiPersona}

// â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡æ·»åŠ äº†ç”¨æˆ¶çš„äººè¨­ â–¼â–¼â–¼
# ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰çš„äººè¨­
${userPersona}
// â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„æœ¬å**: "${chat.originalName}"
- **ç”¨æˆ¶çš„å‚™è¨»**: "${myNickname}"
${worldBookContext}
${longTermMemoryContext}
${multiLayeredSummaryContext} 
- **ä½ å€‘æœ€å¾Œçš„å°è©±**:
${historySlice.map(msg => `${msg.role === 'user' ? myNickname : chat.name}: ${String(msg.content)}`).join('\n')}

ç¾åœ¨ï¼Œè«‹ç¹¼çºŒé€™å ´å°è©±ã€‚
`;
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åˆ°æ­¤çµæŸ â˜…â˜…â˜…
        // ==========================================================

        const messagesPayload = historySlice.map(msg => ({
            role: msg.role,
            content: `${msg.role === 'user' ? myNickname : chat.name}: ${String(msg.content)}`
        }));
        
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                    temperature: state.globalSettings.apiTemperature || 0.8,
                })
            });

        if (!response.ok) {
            throw new Error(`API è«‹æ±‚å¤±æ•—: ${(await response.json()).error.message}`);
        }

        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const messagesArray = parseAiResponse(aiResponseContent);

        if (!messagesArray || messagesArray.length === 0) {
            throw new Error("AIè¿”å›äº†ç©ºå…§å®¹ã€‚");
        }

        let newMessagesCount = 0;
        let messageTimestamp = Date.now();
        for (const msgData of messagesArray) {
            const baseMessage = { role: 'assistant', senderName: chat.originalName, timestamp: messageTimestamp++ };
            let aiMessage = null;
            switch(msgData.type) {
                case 'text':
                    aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                    break;
                case 'sticker':
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
            }
            if (aiMessage) {
                chat.history.push(aiMessage);
                newMessagesCount++;
            }
        }
        
        if (newMessagesCount > 0) {
            chat.unreadCount = (chat.unreadCount || 0) + newMessagesCount;
        }
        
        await db.chats.put(chat);
        await renderChatList();

        if (newMessagesCount > 0) {
            showNotification(chat.id, `ç™¼ä¾†äº† ${newMessagesCount} æ¢æ–°æ¶ˆæ¯`);
        }

    } catch (error) {
        console.error("å¾CPhoneæ¨é€²çœŸå¯¦å°è©±å¤±æ•—:", error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `ç„¡æ³•ç”Ÿæˆæ–°å›å¾©: ${error.message}`);
    }
}
/**
 * ã€å…¨æ–°ã€‘ç‚ºCPhoneé¡åƒèŠå¤©è¦–çª—è¼‰å…¥æ›´æ—©çš„æ¶ˆæ¯è¨˜éŒ„
 */
async function loadMoreMirroredMessages() {
    if (isLoadingMoreCphoneMessages || !activeCharacterId) return;
    isLoadingMoreCphoneMessages = true;

    const messagesContainer = document.getElementById('char-conversation-messages');
    const mainChar = state.chats[activeCharacterId];
    if (!mainChar) {
        isLoadingMoreCphoneMessages = false;
        return;
    }

    showLoader(messagesContainer, 'top'); // åœ¨é ‚éƒ¨é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    const oldScrollHeight = messagesContainer.scrollHeight;

    // æ¨¡æ“¬ä¸€é»å»¶é²ï¼Œè®“è¼‰å…¥å‹•ç•«æ›´è‡ªç„¶
    await new Promise(resolve => setTimeout(resolve, 500));

    const totalMessages = mainChar.history.length;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const nextSliceEnd = totalMessages - cphoneRenderedCount;
    const nextSliceStart = Math.max(0, nextSliceEnd - renderWindow);
    
    const messagesToPrepend = mainChar.history.slice(nextSliceStart, nextSliceEnd);

    // æ¸²æŸ“å‰å…ˆç§»é™¤è¼‰å…¥å‹•ç•«
    hideLoader(messagesContainer);

    if (messagesToPrepend.length === 0) {
        isLoadingMoreCphoneMessages = false;
        return;
    }

    // å¾å¾Œå¾€å‰éæ­·ï¼Œé€æ¢ prepending åˆ°é ‚éƒ¨
    for (const msg of messagesToPrepend.reverse()) {
        const mirroredMsg = { ...msg, role: msg.role === 'user' ? 'assistant' : 'user' };
        
        // æˆ‘å€‘éœ€è¦å†æ¬¡æ§‹å»ºé‚£å€‹â€œåè½‰è¦–è§’â€çš„è‡¨æ™‚ç‰©ä»¶
        const tempChatObjectForRendering = {
            id: 'temp_user_chat_mirror', isGroup: false, name: mainChar.name,
            settings: {
                ...mainChar.settings,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
                aiAvatar: mainChar.settings.myAvatar,
                aiAvatarFrame: mainChar.settings.myAvatarFrame
            }
        };
        
        const messageEl = await createMessageElement(mirroredMsg, tempChatObjectForRendering);
        if (messageEl) {
            messagesContainer.prepend(messageEl);
        }
    }

    cphoneRenderedCount += messagesToPrepend.length;

    // æ¢å¾©æ»¾å‹•ä½ç½®ï¼Œé˜²æ­¢è·³å‹•
    const newScrollHeight = messagesContainer.scrollHeight;
    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

    isLoadingMoreCphoneMessages = false;
}
/**
 * ã€å…¨æ–° V2.5 | äº¤äº’å„ªåŒ– + ä½¿ç”¨è€…å°è©±ä¿®å¾©ç‰ˆã€‘æ‰“é–‹ä¸¦é¡¯ç¤ºæŒ‡å®šçš„é¡æ¯”èŠå¤©è¨˜éŒ„
 * @param {number} conversationIndex - åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•, -1 ä»£è¡¨èˆ‡ä½¿ç”¨è€…çš„çœŸå¯¦å°è©±
 */
async function openCharSimulatedConversation(conversationIndex) {
    const mainChar = state.chats[activeCharacterId];
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šè™•ç† conversationIndex ç‚º -1 çš„æƒ…æ³ â–¼â–¼â–¼
    if (conversationIndex === -1) {
        // é€™æ˜¯æˆ‘å€‘æ‰‹å‹•æ·»åŠ çš„â€œèˆ‡ä½¿ç”¨è€…å°è©±â€
        cphoneActiveConversationType = 'private_user';
        
        const titleEl = document.getElementById('char-conversation-partner-name');
        const bodyEl = document.getElementById('char-conversation-messages');
        const inputEl = document.getElementById('char-simulated-input');

        bodyEl.innerHTML = '';
        titleEl.textContent = mainChar.settings.myNickname || (state.qzoneSettings.nickname || 'æˆ‘');
        inputEl.placeholder = `èˆ‡ ${mainChar.settings.myNickname || 'æˆ‘'} çš„å°è©± (å”¯è®€)`;
        
        cphoneRenderedCount = 0;
        isLoadingMoreCphoneMessages = false;
        
        const history = mainChar.history;
        const renderWindow = state.globalSettings.chatRenderWindow || 50;
        const initialMessages = history.slice(-renderWindow);

        const tempChatObjectForRendering = {
            id: 'temp_user_chat_mirror', isGroup: false, name: mainChar.name,
            settings: {
                ...mainChar.settings,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
                aiAvatar: mainChar.settings.myAvatar,
                aiAvatarFrame: mainChar.settings.myAvatarFrame
            }
        };

        for (const msg of initialMessages) {
            const mirroredMsg = { ...msg, role: msg.role === 'user' ? 'assistant' : 'user' };
            const bubbleElement = await createMessageElement(mirroredMsg, tempChatObjectForRendering);
            if (bubbleElement) {
                bodyEl.appendChild(bubbleElement);
            }
        }
        cphoneRenderedCount = initialMessages.length;

        switchToCharScreen('char-qq-conversation-screen');
        setTimeout(() => bodyEl.scrollTop = bodyEl.scrollHeight, 0);

        return; // è™•ç†å®Œå¾Œç›´æ¥è¿”å›
    }
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹çµæŸ â–²â–²â–²

    // --- å¾ŒçºŒè™•ç†AIç”Ÿæˆå°è©±çš„é‚è¼¯ä¿æŒä¸è®Š ---
    const conversation = mainChar.simulatedConversations[conversationIndex];
    if (!conversation) return;
    cphoneActiveConversationType = conversation.type;

    const allNpcs = await db.npcs.toArray();
    const npcMap = new Map(allNpcs.map(npc => [npc.name, npc]));

    const titleEl = document.getElementById('char-conversation-partner-name');
    const bodyEl = document.getElementById('char-conversation-messages');
    const inputEl = document.getElementById('char-simulated-input');

    bodyEl.innerHTML = '';
    bodyEl.dataset.theme = mainChar.settings.theme || 'default';
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
    bodyEl.style.backgroundColor = isDarkMode ? '#000000' : '#f0f2f5';

    let tempChatObjectForRendering;
    
    if (conversation.type === 'group') {
        titleEl.textContent = `${conversation.groupName} (${conversation.participants.length + 1})`;
        inputEl.placeholder = `åœ¨ ${conversation.groupName} ä¸­èŠå¤©`;
        tempChatObjectForRendering = {
            id: 'temp_group_chat', isGroup: true,
            name: conversation.groupName,
            originalName: mainChar.originalName,
            members: conversation.participants.map(p => {
                const npcData = npcMap.get(p.name);
                let avatarUrl = (npcData && npcData.avatar) ? npcData.avatar : 
                    (state.globalSettings.enableAiDrawing 
                        ? `https://image.pollinations.ai/prompt/${encodeURIComponent(p.avatar_prompt || 'anime person')}`
                        : defaultGroupMemberAvatar);
                return { originalName: p.name, groupNickname: p.name, avatar: avatarUrl };
            }),
            settings: {
                ...mainChar.settings,
                myNickname: mainChar.name,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
            }
        };
        for (const msg of conversation.messages) {
            const isFromMainChar = msg.sender === (mainChar.originalName || mainChar.name);
            const role = isFromMainChar ? 'user' : 'assistant';
            const tempMessageObject = { role: role, senderName: msg.sender, content: msg.content, timestamp: Date.now() + Math.random() };
            const bubbleElement = await createMessageElement(tempMessageObject, tempChatObjectForRendering);
            if (bubbleElement) {
                bodyEl.appendChild(bubbleElement);
            }
        }
    } else { // èˆ‡NPCçš„ç§èŠ
        titleEl.textContent = conversation.participant.name;
        inputEl.placeholder = `èˆ‡ ${conversation.participant.name} çš„å°è©±`;
        const npcData = npcMap.get(conversation.participant.name);
        const npcAvatarUrl = (npcData && npcData.avatar) ? npcData.avatar : 
            (state.globalSettings.enableAiDrawing
                ? `https://image.pollinations.ai/prompt/${encodeURIComponent(conversation.participant.avatar_prompt || 'anime person')}`
                : defaultGroupMemberAvatar);
        tempChatObjectForRendering = {
            id: 'temp_npc_chat', isGroup: false,
            name: conversation.participant.name,
            originalName: mainChar.originalName,
            settings: {
                ...mainChar.settings,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
                aiAvatar: npcAvatarUrl,
                aiAvatarFrame: ''
            }
        };
        for (const msg of conversation.messages) {
            const isFromMainChar = msg.sender === (mainChar.originalName || mainChar.name);
            const role = isFromMainChar ? 'user' : 'assistant';
            const tempMessageObject = { role: role, senderName: msg.sender, content: msg.content, timestamp: Date.now() + Math.random() };
            const bubbleElement = await createMessageElement(tempMessageObject, tempChatObjectForRendering);
            if (bubbleElement) {
                bodyEl.appendChild(bubbleElement);
            }
        }
    }

    switchToCharScreen('char-qq-conversation-screen');
    bodyEl.scrollTop = bodyEl.scrollHeight;
}
/**
 * ã€å…¨æ–°ã€‘é—œé–‰é¡æ¯”èŠå¤©è¨˜éŒ„å½ˆçª—
 */
function closeSimulatedTranscriptModal() {
    document.getElementById('char-qq-transcript-modal').classList.remove('visible');
}

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V3.0 AIæŒ‡ä»¤å¼·åŒ–ç‰ˆã€‘ç•¶ä½¿ç”¨è€…é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆé¡æ¯”ç›¸å†Šå…§å®¹
 */
async function handleGenerateSimulatedAlbum() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];

    if (!chat) {
        await showCustomAlert("æ“ä½œå¤±æ•—", "ç„¡æ³•æ‰¾åˆ°ç•¶å‰è§’è‰²çš„è³‡æ–™ã€‚");
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨è«‹æ±‚â€œ${chat.name}â€å›æ†¶TAçš„ç›¸å†Šç…§ç‰‡...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;
    
    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œæ§‹æ€å‡ºã€8åˆ°10å¼µã€‘TAæœ€è¿‘å¯èƒ½æœƒæ‹æ”æˆ–çè—åœ¨æ‰‹æ©Ÿç›¸å†Šè£¡çš„ç…§ç‰‡ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å‰µé€ æ€§èˆ‡åˆç†æ€§**: ç…§ç‰‡å…§å®¹å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½ã€è·æ¥­å’Œç”Ÿæ´»ç’°å¢ƒã€‚
2.  **å¤šæ¨£æ€§**: ç…§ç‰‡ä¸»é¡Œè¦è±å¯Œï¼Œå¯ä»¥åŒ…æ‹¬è‡ªæ‹ã€é¢¨æ™¯ã€é£Ÿç‰©ã€å¯µç‰©ã€æœ‹å‹åˆå½±ã€å·¥ä½œå ´æ™¯ç­‰ã€‚
3.  **æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä»£è¡¨ä¸€å¼µç…§ç‰‡ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "description": "é€™æ˜¯ç…§ç‰‡èƒŒå¾Œçš„æ•…äº‹æˆ–è§’è‰²çš„å¿ƒæƒ…æ—¥è¨˜ï¼Œå¿…é ˆä½¿ç”¨ç¬¬ä¸€äººç¨±â€œæˆ‘â€ä¾†å¯«ã€‚",
        "image_prompt": "ä¸€æ®µç”¨æ–¼ç”Ÿæˆé€™å¼µç…§ç‰‡çš„ã€è©³ç´°çš„ã€è‹±æ–‡ã€‘é—œéµå­—ã€‚"
      }
    ]
    \`\`\`
    - **ã€image_prompt çµ•å°ç¦æ­¢ã€‘**: çµ•å°ç¦æ­¢åŒ…å«ä»»ä½•ä¸­æ–‡å­—å…ƒã€å¥å­ã€ç‰¹æ®Šç¬¦è™Ÿã€æˆ–ä»»ä½•å¯èƒ½æ¶‰åŠæ•æ„Ÿï¼ˆNSFWï¼‰ã€æš´åŠ›ã€è¡€è…¥ã€æ”¿æ²»çš„å…§å®¹ï¼ä¹Ÿç¦æ­¢çœŸäººï¼
    - **ã€image_prompt å¿…é ˆæ˜¯ã€‘**: å¿…é ˆæ˜¯ç´”è‹±æ–‡çš„ã€ç”¨é€—è™Ÿåˆ†éš”çš„ã€é—œéµç‰‡èªåˆã€‘ (e.g., "1boy, solo, basketball jersey, in locker room, smiling, selfie")ã€‚
    - **ã€ç•«é¢¨æŒ‡ä»¤ã€‘**: åœ¨ prompt çš„æœ«å°¾ï¼Œç¸½æ˜¯åŠ ä¸Šç•«é¢¨æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š \`best quality, masterpiece, anime style, cinematic lighting\`

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆé€™çµ„ç…§ç‰‡çš„æè¿°å’Œç¹ªç•«æŒ‡ä»¤ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„ç›¸å†Šå…§å®¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                    // response_format: { "type": "json_object" }  <-- æ­¤è¡Œå·²è¢«åˆªé™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼·å¤§çš„å®¹éŒ¯è§£æé‚è¼¯ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedAlbumData;
        try {
            simulatedAlbumData = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        chat.simulatedAlbum = simulatedAlbumData;
        await db.chats.put(chat);
        
        await renderCharAlbum();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬ç›¸å†Šå¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆæ¨¡æ“¬ç›¸å†Šï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}


        // â–¼â–¼â–¼ ã€V3.3 | é‚è¼¯çµ‚æ¥µä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderCharAlbum å‡½æ•¸ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | V3.2 çµ‚æ¥µé˜²ç©ºçª—+ç”Ÿåœ–é–‹é—œ+æè¿°é¡¯ç¤ºç‰ˆã€‘æ¸²æŸ“è§’è‰²ç›¸å†Š
         */
        async function renderCharAlbum() {
            const gridEl = document.getElementById('char-album-grid');
            gridEl.innerHTML = '';
            if (!activeCharacterId) return;
            const char = state.chats[activeCharacterId];
        
            const photos = char.simulatedAlbum || [];
        
            if (photos.length === 0) {
                gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„ç›¸å†Šé‚„æ˜¯ç©ºçš„ï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›ç…§ç‰‡å§ï¼</p>';
                return;
            }
        
            const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'char-photo-item';
                item.dataset.description = photo.description;
                gridEl.appendChild(item);

                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                //            é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒæ‰€åœ¨ï¼
                //  æˆ‘å€‘ç¾åœ¨ç¢ºä¿äº†å…©ç¨®æƒ…æ³çš„é‚è¼¯æ˜¯å®Œå…¨ç¨ç«‹çš„ã€‚
                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                
                // 1. æª¢æŸ¥å…¨åŸŸçš„ç”Ÿåœ–é–‹é—œæ˜¯å¦é–‹å•Ÿ
                if (state.globalSettings.enableAiDrawing) {
                    // --- å¦‚æœé–‹é—œã€é–‹å•Ÿã€‘ï¼Œå‰‡åªåŸ·è¡Œç”Ÿåœ–ç›¸é—œçš„é‚è¼¯ ---
                    item.style.backgroundColor = '#e9ecef';
                    const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
                    const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
                    const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;
                    
                    const img = new Image();
                    img.onload = function() { item.style.backgroundImage = `url(${this.src})`; };
                    img.onerror = function() { item.style.backgroundImage = `url(${fallbackImageUrl})`; };
                    img.src = imageUrl;

                } else {
                    // --- å¦‚æœé–‹é—œã€é—œé–‰ã€‘ï¼Œå‰‡åªåŸ·è¡Œé¡¯ç¤ºæ–‡å­—æè¿°çš„é‚è¼¯ ---
                    item.style.backgroundColor = '#f0f2f5';
                    item.style.border = '1px solid #e0e0e0';
                    
                    const descriptionEl = document.createElement('p');
                    descriptionEl.className = 'char-photo-description';
                    descriptionEl.textContent = photo.description || '(é€™å¼µç…§ç‰‡æ²’æœ‰æè¿°)';
                    
                    item.appendChild(descriptionEl);
                }
            });
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V2.2 | JSONè§£æçµ‚æ¥µä¿®å¾©ç‰ˆã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆæ¨¡æ“¬æµè¦½å™¨æ­·å²
 */
async function handleGenerateBrowserHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æ¨¡æ“¬â€œ${chat.name}â€çš„é£†ç¶²è¶³è·¡...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå…§å®¹ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºã€10åˆ°20æ¢ã€‘TAæœ€è¿‘çš„æµè¦½å™¨æœç´¢/æµè¦½è¨˜éŒ„ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å‰µé€ æ€§èˆ‡åˆç†æ€§**: è¨˜éŒ„å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½ã€è·æ¥­å’Œç”Ÿæ´»ç’°å¢ƒã€‚
2.  **å¤šæ¨£æ€§**: è¨˜éŒ„é¡å‹è¦è±å¯Œï¼Œå¯ä»¥æ˜¯å¸–å­ã€æ–‡ç« ã€æ–°èã€å•ç­”ç­‰ã€‚
3.  **ã€æ ¼å¼ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½ä»£è¡¨ä¸€æ¢æµè¦½è¨˜éŒ„ï¼Œä¸¦ä¸”ã€å¿…é ˆã€‘ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
    \`\`\`json
    [
      {
        "type": "text",
        "title": "ä¸€å€‹å¼•äººæ³¨ç›®çš„æ–‡ç« æˆ–æœç´¢æ¨™é¡Œ",
        "url": "ä¸€å€‹è™›æ§‹çš„ã€çœ‹èµ·ä¾†å¾ˆçœŸå¯¦çš„ç¶²å€",
        "content": "ä¸€ç¯‡200-400å­—çš„ã€è©³ç´°çš„æ–‡ç« æˆ–å¸–å­æ­£æ–‡ï¼Œæ”¯æŒåˆ†è¡Œç¬¦è™Ÿ\\nã€‚"
      }
    ]
    \`\`\`
    
    **ã€çµ•å°ç¦æ­¢ã€‘**: ä½ çš„å›å¾©ä¸­ã€çµ•å°ä¸èƒ½ã€‘åŒ…å« "type": "image" çš„å°è±¡ã€‚æ‰€æœ‰è¨˜éŒ„éƒ½å¿…é ˆæ˜¯æ–‡å­—å…§å®¹ã€‚

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆé€™çµ„ã€ç´”æ–‡å­—ã€‘çš„æµè¦½è¨˜éŒ„ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„æµè¦½å™¨è¨˜éŒ„ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆªé™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼·å¤§çš„å®¹éŒ¯è§£æé‚è¼¯ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedHistory;
        try {
            simulatedHistory = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        chat.simulatedBrowserHistory = simulatedHistory;
        await db.chats.put(chat);
        
        await renderCharBrowserHistory();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬æµè¦½å™¨æ­·å²å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆæµè¦½è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V2.0 å‹•æ…‹è³‡æ–™ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„æµè¦½å™¨æ­·å²è¨˜éŒ„æ¸…å–®
 */
function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const history = char.simulatedBrowserHistory || [];

    if (history.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„æµè¦½å™¨ç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›è¨˜éŒ„å§ï¼</p>';
        return;
    }

    history.forEach((item, index) => {
        const entryEl = document.createElement('div');
        entryEl.className = 'char-browser-item';
        entryEl.innerHTML = `
            <div class="title">${item.title}</div>
            <div class="url">${item.url}</div>
        `;
        // ç‚ºæ¯å€‹æ¸…å–®é …ç¶å®šé»æ“Šäº‹ä»¶ï¼Œä¸¦å‚³å…¥å®ƒåœ¨é™£åˆ—ä¸­çš„ç´¢å¼•
        entryEl.addEventListener('click', () => openCharArticle(index));
        listEl.appendChild(entryEl);
    });
}

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹æ–‡ç« æŸ¥çœ‹é é¢
 * @param {number} index - è¢«é»æ“Šçš„æ­·å²è¨˜éŒ„åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•
 */
function openCharArticle(index) {
    const char = state.chats[activeCharacterId];
    const articleData = char.simulatedBrowserHistory[index];
    if (!articleData) return;
    
    // æ¸²æŸ“æ–‡ç« å…§å®¹ä¸¦åˆ‡æ›åˆ°æ–‡ç« è¢å¹•
    renderCharArticle(articleData);
    switchToCharScreen('char-browser-article-screen');
}

        /**
         * ã€å…¨æ–°ã€‘æ ¹æ“šæ–‡ç« è³‡æ–™æ¸²æŸ“æ–‡ç« æŸ¥çœ‹é é¢
         * @param {object} articleData - å–®æ¢æ­·å²è¨˜éŒ„çš„è³‡æ–™ç‰©ä»¶
         */
        function renderCharArticle(articleData) {
            const titleEl = document.getElementById('char-article-title');
            const contentEl = document.getElementById('char-article-content');
            
            titleEl.textContent = articleData.title;
            contentEl.innerHTML = ''; 


            // æˆ‘å€‘ä¸å†æª¢æŸ¥ç”Ÿåœ–é–‹é—œï¼Œè€Œæ˜¯ç›´æ¥åˆ¤æ–·è¨˜éŒ„é¡å‹ã€‚
            // å¦‚æœæ˜¯åœ–ç‰‡é¡å‹ï¼Œå°±é¡¯ç¤ºæ¨™é¡Œä½œç‚ºå…§å®¹ã€‚
            if (articleData.type === 'image') {
                contentEl.innerHTML = `<p class="char-browser-image-description">${articleData.title || '(ç„¡æ¨™é¡Œ)'}</p>`;
            } else {
                // å¦‚æœæ˜¯æ–‡æœ¬é¡å‹ï¼Œæ­£å¸¸é¡¯ç¤ºå…§å®¹ã€‚
                contentEl.innerHTML = `<p>${(articleData.content || 'å…§å®¹è¼‰å…¥å¤±æ•—...').replace(/\n/g, '</p><p>')}</p>`;
            }
            // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V3.2 | çµ‚æ¥µç¶²è·¯èˆ‡é‚è¼¯ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleGenerateTaobaoHistory å‡½æ•¸
 */
async function handleGenerateTaobaoHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æ¨¡æ“¬â€œ${chat.name}â€çš„è³¼ç‰©ç¿’æ…£...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ï¼Œç¢ºä¿åœ¨æ²’æœ‰å¼·åˆ¶JSONæ¨¡å¼ä¸‹ä¹Ÿèƒ½ç©©å®šè¼¸å‡º â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºã€12åˆ°20æ¢ã€‘TAæœ€è¿‘çš„æ·˜å¯¶è³¼ç‰©è¨˜éŒ„ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **åˆç†æ€§**: è³¼è²·è¨˜éŒ„å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½å’Œç¶“æ¿Ÿç‹€æ³ã€‚
2.  **æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹ã€å–®ä¸€çš„JSONç‰©ä»¶ã€‘ã€‚ä½ çš„å›å¾©å¿…é ˆä»¥ \`{\` é–‹å§‹ï¼Œä¸¦ä»¥ \`}\` çµæŸã€‚ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONç‰©ä»¶å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    \`\`\`json
    {
      "purchases": [
        {
          "itemName": "ä¸€å€‹å…·é«”ã€ç”Ÿå‹•çš„å•†å“åç¨±",
          "price": 128.80,
          "status": "å·²ç°½æ”¶",
          "reason": "é€™æ˜¯è§’è‰²è³¼è²·é€™ä»¶å•†å“çš„å…§å¿ƒç¨ç™½æˆ–ç†ç”±ï¼Œå¿…é ˆä½¿ç”¨ç¬¬ä¸€äººç¨±â€œæˆ‘â€ä¾†å¯«ã€‚",
          "image_prompt": "ä¸€æ®µç”¨æ–¼ç”Ÿæˆé€™å¼µå•†å“åœ–ç‰‡çš„ã€è©³ç´°çš„ã€è‹±æ–‡ã€‘é—œéµå­—, é¢¨æ ¼ç‚º realistic product photo, high quality, on a clean white background"
        }
      ]
    }
    \`\`\`
    - **purchases**: ä¸€å€‹åŒ…å«12åˆ°15å€‹å•†å“ç‰©ä»¶çš„é™£åˆ—ã€‚
    - **status (è¨‚å–®ç‹€æ…‹)**: åªèƒ½å¾ "å·²ç°½æ”¶", "å¾…ç™¼è²¨", "é‹è¼¸ä¸­", "å¾…è©•åƒ¹" ä¸­é¸æ“‡ã€‚

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹ç”ŸæˆåŒ…å«è³¼è²·è¨˜éŒ„çš„JSONç‰©ä»¶ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„æ·˜å¯¶è³¼è²·è¨˜éŒ„ã€‚" }];
        
        let isGemini = proxyUrl.includes('generativelanguage.googleapis.com');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                    // response_format: { "type": "json_object" }  <-- é€™è¡Œå·²è¢«åˆªé™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼·å¤§çš„å®¹éŒ¯è§£æé‚è¼¯ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONç‰©ä»¶ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedTaobaoData;
        try {
            simulatedTaobaoData = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        chat.simulatedTaobaoHistory = simulatedTaobaoData;
        await db.chats.put(chat);
        
        await renderCharTaobao();
        
    } catch (error) {
        console.error("ç”Ÿæˆé¡æ¯”æ·˜å¯¶è¨˜éŒ„å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆè³¼ç‰©è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹ä¸¦æ¸²æŸ“è§’è‰²çš„éŒ¢åŒ…é é¢
 */
function openCharWallet() {
    renderCharWallet();
    switchToCharScreen('char-wallet-screen');
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²çš„éŒ¢åŒ…é é¢
 */
function renderCharWallet() {
    const contentEl = document.getElementById('char-wallet-content');
    contentEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const history = char.simulatedTaobaoHistory || [];

    // 1. è¨ˆç®—ç¸½æ”¯å‡º
    const totalExpenses = history.reduce((sum, item) => sum + (item.price || 0), 0);

    // 2. å‰µå»ºä¸¦é¡¯ç¤ºç¸½æ”¯å‡ºå¡ç‰‡
    const summaryCard = document.createElement('div');
    summaryCard.style.cssText = `
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    `;
    summaryCard.innerHTML = `
        <p style="color: #8a8a8a; margin: 0 0 10px 0;">æœ¬æœˆç¸½æ”¯å‡º</p>
        <p style="font-size: 32px; font-weight: 600; color: #1f1f1f; margin: 0;">Â¥${totalExpenses.toFixed(2)}</p>
    `;
    contentEl.appendChild(summaryCard);

    // 3. å‰µå»ºä¸¦é¡¯ç¤ºæ”¯å‡ºæ˜ç´°
    const detailsTitle = document.createElement('h3');
    detailsTitle.textContent = 'æ”¯å‡ºæ˜ç´°';
    detailsTitle.style.cssText = `font-size: 16px; color: #555; margin-bottom: 10px;`;
    contentEl.appendChild(detailsTitle);

    if (history.length === 0) {
        contentEl.innerHTML += '<p style="text-align:center; color: var(--text-secondary);">æš«ç„¡æ”¯å‡ºè¨˜éŒ„ã€‚</p>';
        return;
    }

    history.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        `;
        itemEl.innerHTML = `
            <div>
                <p style="font-weight: 500; margin: 0 0 4px 0;">${item.itemName}</p>
                <p style="font-size: 12px; color: #8a8a8a; margin: 0;">${item.status}</p>
            </div>
            <div style="font-weight: 600; font-size: 16px; color: #ff5722;">- Â¥${(item.price || 0).toFixed(2)}</div>
        `;
        contentEl.appendChild(itemEl);
    });
}
// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€V3.0 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleGenerateSimulatedMemos å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€V3.0 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆæ¨¡æ“¬å‚™å¿˜éŒ„
 */
async function handleGenerateSimulatedMemos() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨è«‹æ±‚â€œ${chat.name}â€åˆ†äº«TAçš„å‚™å¿˜éŒ„...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
// ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨é€™è£¡åŒæ™‚ç”Ÿæˆæ›´ç´°ç·»çš„ã€å¤šç¶­åº¦çš„ç¸½çµã€‘ã€‘ã€‘
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºã€12åˆ°20æ¢ã€‘TAæœ€è¿‘å¯èƒ½æœƒå¯«åœ¨æ‰‹æ©Ÿå‚™å¿˜éŒ„è£¡çš„å…§å®¹ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å‰µé€ æ€§èˆ‡åˆç†æ€§**: å‚™å¿˜éŒ„å…§å®¹å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½ã€è·æ¥­å’Œç”Ÿæ´»ç’°å¢ƒã€‚å¯ä»¥æ˜¯è³¼ç‰©æ¸…å–®ã€å¾…è¾¦äº‹é …ã€éˆæ„Ÿç‰‡æ®µã€ä¸€äº›éš¨ç­†å’Œæ„Ÿæ‚Ÿã€è‰ç¨¿ç­‰ã€‚
2.  **æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä»£è¡¨ä¸€æ¢å‚™å¿˜éŒ„ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "å‚™å¿˜éŒ„çš„æ¨™é¡Œï¼Œä¾‹å¦‚ï¼šè³¼ç‰©æ¸…å–® æˆ– é€±æœ«è¨ˆç•«",
        "content": "å‚™å¿˜éŒ„çš„è©³ç´°å…§å®¹ï¼Œå¿…é ˆæ”¯æ´åˆ†è¡Œç¬¦è™Ÿ\\nã€‚"
      }
    ]
    \`\`\`

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆé€™çµ„å‚™å¿˜éŒ„ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„å‚™å¿˜éŒ„å…§å®¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                    // åŒæ¨£ç§»é™¤ response_format
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) {
             const errorData = await response.json().catch(() => null);
             const errorMessage = errorData?.error?.message || response.statusText;
             throw new Error(`API éŒ¯èª¤: ${response.status} - ${errorMessage}`);
        }
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼·å¤§çš„å®¹éŒ¯è§£æé‚è¼¯ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedMemos;
        try {
            simulatedMemos = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        if (!Array.isArray(simulatedMemos)) {
            throw new Error(`AIè¿”å›çš„è³‡æ–™ä¸æ˜¯ä¸€å€‹é™£åˆ—ã€‚åŸå§‹è¿”å›: ${JSON.stringify(simulatedMemos)}`);
        }

        chat.memos = simulatedMemos.map(memo => ({
            id: Date.now() + Math.random(),
            title: memo.title,
            content: memo.content
        }));
        
        await db.chats.put(chat);
        await renderCharMemoList();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬å‚™å¿˜éŒ„å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆå‚™å¿˜éŒ„ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handleGenerateAmapHistory å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | V2.0 æœ€çµ‚ä¿®å¾©ç‰ˆã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆæ¨¡æ“¬è¶³è·¡
 */
async function handleGenerateAmapHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨ç”Ÿæˆâ€œ${chat.name}â€çš„å‡ºè¡Œè¶³è·¡...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå…§å®¹ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;
    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºã€12åˆ°20æ¢ã€‘TAæœ€è¿‘çš„â€œé«˜å¾·åœ°åœ–â€å‡ºè¡Œè¶³è·¡ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€æ™‚é–“ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **${new Date().toISOString()}**ã€‚
    -   ä½ ç”Ÿæˆçš„ã€æ‰€æœ‰ã€‘è¶³è·¡çš„ \`timestamp\` æ¬„ä½ï¼Œã€å¿…é ˆã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€çµ•å°ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªä¾†çš„æ—¥æœŸï¼
    -   è«‹ç”Ÿæˆä¸€å€‹çœ‹èµ·ä¾†åƒæ˜¯éå»å¹¾å‘¨å…§çš„ã€æ™‚é–“ã€å¾æ–°åˆ°èˆŠã€‘æ’åˆ—çš„è¶³è·¡åˆ—è¡¨ã€‚
2.  **å‰µé€ æ€§èˆ‡åˆç†æ€§**: è¶³è·¡å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½ã€è·æ¥­å’Œç”Ÿæ´»ç’°å¢ƒã€‚
3.  **å¤šæ¨£æ€§**: åœ°é»é¡å‹è¦è±å¯Œï¼Œå¯ä»¥åŒ…æ‹¬é¤å»³ã€å•†å ´ã€å…¬åœ’ã€å…¬å¸ã€æœ‹å‹å®¶ç­‰ã€‚
4.  **ã€æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä»£è¡¨ä¸€æ¢è¶³è·¡ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "locationName": "ä¸€å€‹å…·é«”ã€ç”Ÿå‹•çš„åœ°é»åç¨±",
        "address": "ä¸€å€‹è™›æ§‹ä½†çœ‹èµ·ä¾†å¾ˆçœŸå¯¦çš„è©³ç´°åœ°å€",
        "comment": "é€™æ˜¯è§’è‰²å°é€™æ¬¡å‡ºè¡Œæˆ–é€™å€‹åœ°é»çš„å…§å¿ƒç¨ç™½æˆ–è©•è«–ï¼Œå¿…é ˆä½¿ç”¨ç¬¬ä¸€äººç¨±â€œæˆ‘â€ä¾†å¯«ã€‚",
        "image_prompt": "(å¯é¸)ä¸€æ®µç”¨æ–¼ç”Ÿæˆé€™å¼µåœ°é»ç…§ç‰‡çš„ã€è©³ç´°çš„ã€è‹±æ–‡ã€‘é—œéµå­—, é¢¨æ ¼ç‚º realistic photo, high quality",
        "timestamp": "ç¬¦åˆ ISO 8601 æ ¼å¼çš„æ—¥æœŸæ™‚é–“å­—ä¸² (ä¾‹å¦‚: '2025-09-25T18:30:00Z')"
      }
    ]
    \`\`\`
    - **é‡è¦**: å¤§ç´„æœ‰ã€ä¸‰åˆ†ä¹‹ä¸€ã€‘çš„è¶³è·¡éœ€è¦åŒ…å« \`image_prompt\` æ¬„ä½ä¾†ç”Ÿæˆä¸€å¼µç…§ç‰‡ã€‚
    - **åœ–ç‰‡**: image_prompt ç”Ÿæˆçš„åœ–ç‰‡ã€çµ•å°ç¦æ­¢åŒ…å«çœŸäººã€‘ã€‚å¦‚æœåœ°é»æ˜¯å®¤å…§ï¼Œå¯ä»¥ç”Ÿæˆç©ºç„¡ä¸€äººçš„å ´æ™¯ï¼›å¦‚æœæ˜¯å®¤å¤–ï¼Œå¯ä»¥åªæœ‰é¢¨æ™¯æˆ–å»ºç¯‰ã€‚

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆé€™çµ„è¶³è·¡è¨˜éŒ„ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„é«˜å¾·åœ°åœ–è¶³è·¡ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆªé™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼·å¤§çš„å®¹éŒ¯è§£æé‚è¼¯ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedAmapData;
        try {
            simulatedAmapData = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        chat.simulatedAmapHistory = simulatedAmapData;
        await db.chats.put(chat);
        
        await renderCharAmap();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬è¶³è·¡å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆè¶³è·¡ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}

        /**
         * ã€å…¨æ–° | V2.0 æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„é«˜å¾·åœ°åœ–è¶³è·¡åˆ—è¡¨
         */
        function renderCharAmap() {
            const listEl = document.getElementById('char-amap-list');
            listEl.innerHTML = '';
            if (!activeCharacterId) return;

            const char = state.chats[activeCharacterId];
            const history = char.simulatedAmapHistory || [];

            if (history.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡é‚„æ²’æœ‰ç•™ä¸‹ä»»ä½•è¶³è·¡ï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›è¨˜éŒ„å§ï¼</p>';
                return;
            }

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©3ï¼šåœ¨é€™è£¡ä½¿ç”¨ AI æä¾›çš„æ™‚é–“æˆ³è¨˜ â–¼â–¼â–¼
            history.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'char-amap-item';
                
                let photoHtml = '';
                if (item.image_prompt) {
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
                    photoHtml = `<div class="amap-item-photo" style="background-image: url('${imageUrl}')" data-comment="${item.comment}"></div>`;
                }

                // ä½¿ç”¨æˆ‘å€‘ä¹‹å‰å‰µå»ºçš„ formatTimeAgo å‡½æ•¸ä¾†æ ¼å¼åŒ–æ™‚é–“
                const timeAgo = item.timestamp ? formatTimeAgo(new Date(item.timestamp).getTime()) : 'æŸå€‹æ™‚é–“';

                itemEl.innerHTML = `
                    <div class="amap-item-header">
                        <div class="amap-item-icon">ğŸ“</div>
                        <div class="amap-item-info">
                            <div class="amap-item-title">${item.locationName}</div>
                            <div class="amap-item-address">${item.address}</div>
                        </div>
                    </div>
                    <div class="amap-item-body">
                        <div class="amap-item-comment">${item.comment.replace(/\n/g, '<br>')}</div>
                        ${photoHtml}
                    </div>
                    <div class="amap-item-footer">${timeAgo}</div>
                `;
                listEl.appendChild(itemEl);
            });
            // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
        }

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V3.0 | æ”¯æ´AIç¹ªåœ–ã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆé¡æ¯”Appä½¿ç”¨è¨˜éŒ„
 */
async function handleGenerateAppUsage() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨åˆ†æâ€œ${chat.name}â€çš„æ‰‹æ©Ÿä½¿ç”¨ç¿’æ…£...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå…§å®¹ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');
const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

let multiLayeredSummaryContext = '';
if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
    multiLayeredSummaryContext += `\n# æ™ºæ…§ç¸½çµ (åŸºæ–¼ä¸åŒæ™‚é–“ç¶­åº¦çš„å°è©±å›é¡§)\n`;
    if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
    if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
    if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
    if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
    if (summaryToday) multiLayeredSummaryContext += summaryToday;
    if (summary3Days) multiLayeredSummaryContext += summary3Days;
    if (summary7Days) multiLayeredSummaryContext += summary7Days;
}
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç”Ÿæ´»æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼Œè™›æ§‹å‡ºTAæœ€è¿‘ä¸€å¤©çš„ã€æ‰‹æ©ŸAppè¢å¹•ä½¿ç”¨æ™‚é–“ã€‘è¨˜éŒ„ï¼Œç¸½å…±ç´„20æ¢ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å‰µé€ æ€§èˆ‡å¤šæ¨£æ€§**: ç”Ÿæˆçš„Appåˆ—è¡¨ã€ä¸å¿…å±€é™æ–¼ã€‘Cphoneä¸»è¢å¹•ä¸Šå·²æœ‰çš„Appã€‚ä½ å¯ä»¥è‡ªç”±åœ°è™›æ§‹TAå¯èƒ½ä½¿ç”¨çš„å…¶ä»–Appï¼Œä¾‹å¦‚ Instagram, Twitter, å„ç¨®éŠæˆ² (å¦‚ï¼šåŸç¥, ç‹è€…æ¦®è€€), è¦–é »App (å¦‚ï¼šæŠ–éŸ³, YouTube), å­¸ç¿’æˆ–å·¥ä½œè»Ÿé«”ç­‰ï¼Œé€™èƒ½æ›´å¥½åœ°é«”ç¾è§’è‰²çš„éš±è—èˆˆè¶£å’Œç”Ÿæ´»ç¿’æ…£ã€‚
2.  **åˆç†æ€§**: ä½¿ç”¨æ™‚é•·å’ŒAppé¡å‹å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½ã€è·æ¥­å’Œç”Ÿæ´»ç’°å¢ƒã€‚
3.  **æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä»£è¡¨ä¸€å€‹Appçš„ä½¿ç”¨è¨˜éŒ„ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "appName": "Appçš„åç¨± (ä¾‹å¦‚: å¾®ä¿¡, å¾®åš, åŸç¥)",
        "usageTimeMinutes": 125,
        "category": "Appçš„åˆ†é¡ (ä¾‹å¦‚: ç¤¾äº¤, éŠæˆ², å½±éŸ³, å·¥å…·, é–±è®€, è³¼ç‰©)",
        "image_prompt": "ä¸€æ®µç”¨æ–¼ç”Ÿæˆé€™å€‹Appã€åœ–ç¤ºã€‘çš„ã€ç°¡æ½”çš„ã€è‹±æ–‡ã€‘é—œéµå­—ã€‚é¢¨æ ¼å¿…é ˆæ˜¯ modern app icon, flat design, simple, clean background"
      }
    ]
    \`\`\`

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹é–‹å§‹ç”Ÿæˆé€™çµ„Appä½¿ç”¨è¨˜éŒ„ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„Appä½¿ç”¨è¨˜éŒ„ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸ç›¸å®¹çš„ response_format åƒæ•¸ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.9
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆªé™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        
        const simulatedUsageData = JSON.parse(cleanedJson);
        
        chat.simulatedAppUsage = simulatedUsageData;
        await db.chats.put(chat);
        
        await renderCharAppUsage();
        
    } catch (error) {
        console.error("ç”Ÿæˆé¡æ¯”Appä½¿ç”¨è¨˜éŒ„å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆè¨˜éŒ„ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}

        /**
         * ã€å…¨æ–° V2.0 | AIç¹ªåœ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„Appä½¿ç”¨è¨˜éŒ„æ¸…å–®
         */
        function renderCharAppUsage() {
            const listEl = document.getElementById('char-usage-list');
            listEl.innerHTML = '';
            if (!activeCharacterId) return;

            const char = state.chats[activeCharacterId];
            const usageData = (char.simulatedAppUsage || []).sort((a, b) => b.usageTimeMinutes - a.usageTimeMinutes);

            if (usageData.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡é‚„æ²’æœ‰ä»»ä½•ä½¿ç”¨è¨˜éŒ„ï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›å§ï¼</p>';
                return;
            }

            usageData.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'char-usage-item';
                
                const hours = Math.floor(item.usageTimeMinutes / 60);
                const minutes = item.usageTimeMinutes % 60;
                let timeString = '';
                if (hours > 0) timeString += `${hours}å°æ™‚`;
                if (minutes > 0) timeString += `${minutes}åˆ†é˜`;
                if (!timeString) timeString = 'å°æ–¼1åˆ†é˜';

                // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ï¼šå‹•æ…‹ç”Ÿæˆåœ–ç¤ºURLã€‘ â–¼â–¼â–¼
                // 1. å¦‚æœAIæä¾›äº†image_promptï¼Œå°±ä½¿ç”¨å®ƒï¼›å¦å‰‡ï¼Œæä¾›ä¸€å€‹é€šç”¨çš„å‚™ç”¨æŒ‡ä»¤
                const prompt = item.image_prompt || `modern app icon for ${item.appName}, flat design, simple`;
                // 2. ä½¿ç”¨AIç¹ªç•«APIç”Ÿæˆåœ–ç¤º
                const iconUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
                // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

                itemEl.innerHTML = `
                    <img src="${iconUrl}" class="usage-item-icon">
                    <div class="usage-item-info">
                        <div class="usage-item-name">${item.appName}</div>
                        <div class="usage-item-category">${item.category}</div>
                    </div>
                    <div class="usage-item-time">${timeString}</div>
                `;
                listEl.appendChild(itemEl);
            });
        }
// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V2.0 | æœ€çµ‚ç›¸å®¹ç‰ˆã€‘ç•¶ç”¨æˆ¶é»æ“Šâ€œé‡æ–°ç”Ÿæˆâ€æ™‚ï¼Œèª¿ç”¨AIç”Ÿæˆæ¨¡æ“¬æ­Œå–®
 */
async function handleGenerateSimulatedMusic() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨è«‹æ±‚â€œ${chat.name}â€åˆ†äº«TAçš„ç§äººæ­Œå–®...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ¶' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const maxMemory = chat.settings.maxMemory || 10;
const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œæ›¸ã€Š${book.name}ã€‹è¨­å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼·åŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬éŸ³æ¨‚å“å‘³æ¨¡æ“¬å™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œä¸¦æ ¹æ“šå…¶äººè¨­ã€è¨˜æ†¶å’Œæœ€è¿‘çš„äº’å‹•ï¼ŒæŒ‘é¸å‡ºã€14åˆ°18é¦–ã€‘æœ€èƒ½ä»£è¡¨TAæ­¤åˆ»å¿ƒæƒ…æˆ–å“å‘³çš„æ­Œæ›²ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **å‰µé€ æ€§èˆ‡åˆç†æ€§**: æ­Œå–®å¿…é ˆå®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€æ„›å¥½å’Œç”Ÿæ´»èƒŒæ™¯ã€‚
2.  **å¤šæ¨£æ€§**: æ­Œæ›²é¢¨æ ¼å¯ä»¥å¤šæ¨£ï¼Œä½†å¿…é ˆé‚è¼¯è‡ªæ´½ã€‚
3.  **æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä»£è¡¨ä¸€é¦–æ­Œï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "songName": "æ­Œæ›²çš„æº–ç¢ºåç¨±",
        "artistName": "æ­Œæ›²çš„æº–ç¢ºè—è¡“å®¶/æ­Œæ‰‹å"
      }
    ]
    \`\`\`

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è¨­å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•·æœŸè¨˜æ†¶**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å°è©±æ‘˜è¦**:
${recentHistoryWithUser}

ç¾åœ¨ï¼Œè«‹ç”Ÿæˆé€™ä»½æ­Œå–®ã€‚`;
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä½ çš„è¨­å®šï¼Œç”Ÿæˆä½ çš„æ­Œå–®ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šæ­¤å‡½æ•¸ä¹‹å‰æ²’æœ‰ response_formatï¼Œç„¡éœ€åˆªé™¤ï¼Œä½†æˆ‘å€‘ç¢ºä¿å…¶ä»–éƒ¨åˆ†æ˜¯å¥å£¯çš„ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 1.0,
                })
            });
        // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        const songPicks = JSON.parse(cleanedJson);

        await showCustomAlert("è«‹ç¨å€™...", `æ­Œå–®å·²ç”Ÿæˆï¼Œæ­£åœ¨å¾ç¶²è·¯ç²å– ${songPicks.length} é¦–æ­Œæ›²çš„è©³ç´°è³‡è¨Š...`);

        const songDetailPromises = songPicks.map(async (pick) => {
            let searchResults = await searchNeteaseMusic(pick.songName, pick.artistName);
            if (!searchResults || searchResults.length === 0) {
                searchResults = await searchTencentMusic(pick.songName);
            }
            if (searchResults.length > 0) {
                return getPlayableSongDetails(searchResults[0]);
            }
            console.warn(`æ‰€æœ‰éŸ³æ¨‚æºéƒ½æœªèƒ½æ‰¾åˆ°æ­Œæ›²ï¼šâ€œ${pick.songName} - ${pick.artistName}â€`);
            return null;
        });

        const fullSongObjects = (await Promise.all(songDetailPromises)).filter(Boolean);

        chat.simulatedMusicPlaylist = fullSongObjects;
        await db.chats.put(chat);
        
        await renderCharMusicScreen();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ“¬æ­Œå–®å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆæ­Œå–®ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²çš„ç¶²æ˜“é›²éŸ³æ¨‚æ¸…å–®
 */
function renderCharMusicScreen() {
    const listEl = document.getElementById('char-music-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const playlist = char.simulatedMusicPlaylist || [];

    if (playlist.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„æ­Œå–®é‚„æ˜¯ç©ºçš„ï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ç”Ÿæˆä¸€äº›æ­Œæ›²å§ï¼</p>';
        return;
    }

    playlist.forEach((track, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'char-music-item';
        itemEl.innerHTML = `
            <img src="${track.cover}" class="music-item-cover">
            <div class="music-item-info">
                <div class="music-item-name">${track.name}</div>
                <div class="music-item-artist">${track.artist}</div>
            </div>
        `;
        // ç‚ºæ¯å€‹æ¸…å–®é …ç¶å®šé»æ“Šäº‹ä»¶ï¼Œä¸¦å‚³å…¥å®Œæ•´çš„æ­Œæ›²ç‰©ä»¶
        itemEl.addEventListener('click', () => playCharSong(track));
        listEl.appendChild(itemEl);
    });
}

/* â–¼â–¼â–¼ è«‹ç”¨é€™æ•´å¡Šã€å…¨æ–° V3.0 JSä»£ç¢¼ã€‘ï¼Œå®Œæ•´æ›¿æ›æ‰€æœ‰èˆŠçš„ char-player-modal ç›¸é—œJS â–¼â–¼â–¼ */

let charPlayerState = {
    currentPlaylist: [],
    currentIndex: -1,
    isPlaying: false,
    playMode: 'order', // 'order', 'random', 'single'
    lrcUpdateInterval: null,
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    parsedLyrics: [],
    currentLyricIndex: -1
};

/**
 * æ’­æ”¾Cphoneä¸­çš„æ­Œæ›² (V3.0 - é©é…æ–°UIå’Œæ­Œè©)
 * @param {object} songObject - åŒ…å«æ‰€æœ‰è³‡è¨Šçš„å®Œæ•´æ­Œæ›²ç‰©ä»¶
 */
function playCharSong(songObject) {
    const player = document.getElementById('char-audio-player');
    const modal = document.getElementById('char-music-player-modal');
    
    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();
    
    const songIndex = charPlayerState.currentPlaylist.findIndex(s => s.src === songObject.src);
    if (songIndex > -1) {
        charPlayerState.currentIndex = songIndex;
    } else {
        charPlayerState.currentPlaylist = [songObject];
        charPlayerState.currentIndex = 0;
    }

    // æ›´æ–°UI
    document.getElementById('char-music-player-title').textContent = songObject.name;
    document.getElementById('char-music-artist').textContent = songObject.artist;
    document.getElementById('char-music-cover').src = songObject.cover;
    
    // ã€æ ¸å¿ƒæ–°å¢ã€‘è§£ææ­Œè©
    charPlayerState.parsedLyrics = parseLRC(songObject.lrcContent || "");
    renderCharLyrics(); // æ¸²æŸ“æ­Œè©

    // è¨­ç½®éŸ³è¨Šæºä¸¦æ’­æ”¾
    if (songObject.isLocal) {
        const blob = new Blob([songObject.src], { type: songObject.fileType || 'audio/mpeg' });
        player.src = URL.createObjectURL(blob);
    } else {
        player.src = songObject.src;
    }
    player.play().catch(e => console.error("éŸ³è¨Šæ’­æ”¾å¤±æ•—:", e));

    player.onloadedmetadata = () => {
        document.getElementById('char-music-total-time').textContent = formatMusicTime(player.duration);
        charPlayerState.lrcUpdateInterval = setInterval(updateCharMusicProgress, 500);
    };

    modal.classList.add('visible');
}

/**
 * é—œé–‰Cphoneçš„éŸ³æ¨‚æ’­æ”¾æ©Ÿ (V3.0)
 */
function closeCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    const player = document.getElementById('char-audio-player');
    
    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();
    player.src = ''; 
    modal.classList.remove('visible');
    charPlayerState.isPlaying = false;
    document.getElementById('char-vinyl-container').classList.remove('spinning');
}

/**
 * æ›´æ–°æ’­æ”¾æ©Ÿé€²åº¦æ¢ã€æ™‚é–“å’Œæ­Œè© (æ ¸å¿ƒä¿®æ”¹)
 */
function updateCharMusicProgress() {
    const player = document.getElementById('char-audio-player');
    if (!player.duration) return;

    const currentTime = player.currentTime;
    const duration = player.duration;
    document.getElementById('char-music-progress-fill').style.width = `${(currentTime / duration) * 100}%`;
    document.getElementById('char-music-current-time').textContent = formatMusicTime(currentTime);

    // ã€æ ¸å¿ƒæ–°å¢ã€‘èª¿ç”¨æ­Œè©æ›´æ–°å‡½æ•¸
    updateCharActiveLyric(currentTime);
}


/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²æ’­æ”¾æ©Ÿçš„æ­Œè©åˆ—è¡¨
 */
function renderCharLyrics() {
    const lyricsContainer = document.getElementById('char-music-lyrics');
    lyricsContainer.innerHTML = '';
    charPlayerState.currentLyricIndex = -1; // é‡ç½®ç´¢å¼•
    if (!charPlayerState.parsedLyrics || charPlayerState.parsedLyrics.length === 0) {
        lyricsContainer.innerHTML = '<p>â™ª æš«ç„¡æ­Œè© â™ª</p>';
        return;
    }
    charPlayerState.parsedLyrics.forEach((line, index) => {
        const p = document.createElement('p');
        p.textContent = line.text;
        p.dataset.index = index;
        lyricsContainer.appendChild(p);
    });
}

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°ç•¶å‰é«˜äº®çš„æ­Œè©
 */
function updateCharActiveLyric(currentTime) {
    const lyrics = charPlayerState.parsedLyrics;
    if (lyrics.length === 0) return;

    let newLyricIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
        if (currentTime >= lyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === charPlayerState.currentLyricIndex) return;
    charPlayerState.currentLyricIndex = newLyricIndex;
    
    // æ›´æ–°UI
    const lyricsContainer = document.getElementById('char-music-lyrics');
    const lines = lyricsContainer.querySelectorAll('p');
    lines.forEach(line => line.classList.remove('active'));
    
    if (newLyricIndex > -1) {
        const activeLine = lyricsContainer.querySelector(`p[data-index="${newLyricIndex}"]`);
        if (activeLine) {
            activeLine.classList.add('active');
            // è¨ˆç®—æ»¾å‹•ä½ç½®ï¼Œä½¿ç•¶å‰è¡Œå±…ä¸­
            const offset = (lyricsContainer.clientHeight / 2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
            lines.forEach(line => {
                line.style.transform = `translateY(${offset}px)`;
            });
        }
    }
}


/**
 * æ’­æ”¾ä¸‹ä¸€é¦–æ­Œ
 */
function playNextCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    let nextIndex;
    switch(charPlayerState.playMode) {
        case 'random':
            nextIndex = Math.floor(Math.random() * charPlayerState.currentPlaylist.length);
            break;
        case 'single':
            // å–®æ›²è¿´åœˆï¼Œé‡æ–°æ’­æ”¾ç•¶å‰æ­Œæ›²
            playCharSong(charPlayerState.currentPlaylist[charPlayerState.currentIndex]);
            return;
        case 'order':
        default:
            nextIndex = (charPlayerState.currentIndex + 1) % charPlayerState.currentPlaylist.length;
            break;
    }
    playCharSong(charPlayerState.currentPlaylist[nextIndex]);
}

/**
 * æ’­æ”¾ä¸Šä¸€é¦–æ­Œ
 */
function playPrevCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    const newIndex = (charPlayerState.currentIndex - 1 + charPlayerState.currentPlaylist.length) % charPlayerState.currentPlaylist.length;
    playCharSong(charPlayerState.currentPlaylist[newIndex]);
}

/**
 * åˆ‡æ›æ’­æ”¾æ¨¡å¼
 */
function changeCharPlayMode() {
    const modes = ['order', 'random', 'single'];
    const currentModeIndex = modes.indexOf(charPlayerState.playMode);
    charPlayerState.playMode = modes[(currentModeIndex + 1) % modes.length];
    document.getElementById('char-music-mode-btn').textContent = {'order': 'é †åº', 'random': 'éš¨æ©Ÿ', 'single': 'å–®æ›²'}[charPlayerState.playMode];
}


/**
 * ã€ç¸½å…¥å£ã€‘ç‚ºæ–°æ’­æ”¾æ©Ÿçš„æ‰€æœ‰æŒ‰éˆ•å’Œäº‹ä»¶ç¶å®šåŠŸèƒ½
 */
function setupCharPlayerControls() {
    const player = document.getElementById('char-audio-player');
    const playBtn = document.getElementById('char-music-play-pause-btn');
    const vinyl = document.getElementById('char-vinyl-container');

    playBtn.addEventListener('click', () => {
        if (player.paused) {
            if(charPlayerState.currentIndex > -1) player.play();
        } else {
            player.pause();
        }
    });
    
    player.onplay = () => {
        playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
        vinyl.classList.add('spinning');
        charPlayerState.isPlaying = true;
    };
    player.onpause = () => {
        playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
        vinyl.classList.remove('spinning');
        charPlayerState.isPlaying = false;
    };
    player.onended = () => {
        vinyl.classList.remove('spinning');
        charPlayerState.isPlaying = false;
        playNextCharSong();
    };

    document.getElementById('char-music-prev-btn').addEventListener('click', playPrevCharSong);
    document.getElementById('char-music-next-btn').addEventListener('click', playNextCharSong);
    document.getElementById('char-music-mode-btn').addEventListener('click', changeCharPlayMode);

    document.getElementById('char-music-progress-bar').addEventListener('click', (e) => {
        if (!player.duration) return;
        const bar = e.currentTarget;
        const clickX = e.offsetX;
        player.currentTime = (clickX / bar.clientWidth) * player.duration;
    });
}
/* â–²â–²â–² JSä»£ç¢¼æ›¿æ›çµæŸ â–²â–²â–² */
// â–¼â–¼â–¼ ã€å…¨æ–° | V3.2 | é›™é‡èº«ä»½é©—è­‰ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ renderDoubanScreen å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€ç¸½å…¥å£ã€‘æ¸²æŸ“è±†ç“£å°çµ„è¢å¹•
 */
async function renderDoubanScreen() {
    const listEl = document.getElementById('douban-posts-list');
    listEl.innerHTML = '';
    
    const posts = await db.doubanPosts.orderBy('timestamp').reverse().toArray();

    if (posts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">é€™è£¡ç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>é»æ“Šå³ä¸Šè§’åˆ·æ–°æŒ‰éˆ•ï¼Œçœ‹çœ‹å¤§å®¶éƒ½åœ¨èŠä»€éº¼å§ï¼</p>';
        return;
    }

    posts.forEach(post => {
        let avatarUrl;
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå…¨æ–°çš„â€œé›™é‡é©—è­‰â€é ­åƒæŸ¥æ‰¾é‚è¼¯ ---
        // 1. å„ªå…ˆé€šéâ€œèº«ä»½è­‰â€(authorOriginalName)æŸ¥æ‰¾
        const authorChatByOriginalName = post.authorOriginalName 
            ? Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorOriginalName) 
            : null;

        if (authorChatByOriginalName) {
            // å¦‚æœé€šéâ€œèº«ä»½è­‰â€æ‰¾åˆ°äº†ï¼Œå°±ç”¨é€™å€‹è§’è‰²çš„çœŸå¯¦é ­åƒ
            avatarUrl = authorChatByOriginalName.settings.aiAvatar;
        } else {
            // 2. å¦‚æœæ²’æœ‰â€œèº«ä»½è­‰â€ï¼Œå†å˜—è©¦ç”¨â€œå¤–è™Ÿâ€(authorName)å»èŠ±åå†Šè£¡æ‰¾ï¼ˆç›¸å®¹èˆŠè³‡æ–™ï¼‰
            const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
            if (authorChatByName) {
                avatarUrl = authorChatByName.settings.aiAvatar;
            } else if (post.authorAvatarPrompt) {
                // 3. å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œèªªæ˜é€™æ˜¯ä¸€å€‹è·¯äººNPCï¼Œå°±ç”¨AIçµ¦çš„â€œé ­åƒå’’èªâ€å»ç•«ä¸€å¼µæ–°è‡‰
                avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
            } else {
                // 4. å¦‚æœé€£â€œé ­åƒå’’èªâ€éƒ½æ²’æœ‰ï¼Œæ‰ä½¿ç”¨æœ€çµ‚çš„é†œé™‹å é»é™£åœ–
                avatarUrl = defaultAvatar;
            }
        }
        // --- ä¿®å¾©çµæŸ ---

        const itemEl = document.createElement('div');
        itemEl.className = 'douban-post-item';
        itemEl.onclick = () => openDoubanPostDetail(post.id);

        itemEl.innerHTML = `
            <div class="douban-post-header">
                <img src="${avatarUrl}" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div class="douban-author-name">${post.authorName}</div>
                    <div class="douban-group-name">ä¾†è‡ª ${post.groupName}</div>
                </div>
            </div>
            <div class="douban-post-title">${post.postTitle}</div>
            <div class="douban-post-content">${post.content.replace(/\n/g, '<br>')}</div>
            <div class="douban-post-footer">
                 <div class="douban-post-actions">
                    <span><svg viewBox="0 0 1024 1024"><path d="M170.666667 170.666667h128v682.666666h-128zM426.666667 170.666667h170.666666v682.666666h-170.666666zM725.333333 170.666667h128v682.666666h-128z"></path></svg> ${post.likesCount}</span>
                    <span><svg viewBox="0 0 1024 1024"><path d="M853.333333 85.333333H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333334v512c0 46.933333 38.4 85.333333 85.333334 85.333333h512l170.666667 170.666667V170.666667c0-46.933333-38.4-85.333333-85.333334-85.333334z m-42.666666 554.666667H170.666667V170.666667h640v469.333333zM256 384h512v85.333333H256V384z m0-170.666667h512v85.333334H256v-85.333334z"></path></svg> ${post.commentsCount}</span>
                </div>
                <span class="douban-post-timestamp">${formatTimeAgo(post.timestamp)}</span>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ handleGenerateDoubanPosts å‡½æ•¸ â–¼â–¼â–¼
async function handleGenerateDoubanPosts() {
    const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];

    if (activeCharacterIds.length === 0) {
        await showCustomAlert("è«‹å…ˆé¸æ“‡è§’è‰²", "è«‹é»æ“Šå³ä¸Šè§’çš„â€œè§’è‰²é¸æ“‡â€æŒ‰éˆ•ï¼Œé¸æ“‡è‡³å°‘ä¸€å€‹åƒèˆ‡è±†ç“£äº’å‹•çš„è§’è‰²ã€‚");
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨ç‚ºæ‚¨é¸æ“‡çš„ ${activeCharacterIds.length} ä½å…ƒè§’è‰²ç”Ÿæˆè±†ç“£å‹•æ…‹...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½APIè³‡è¨Šã€‚');
        return;
    }

    const allLinkedBookIds = new Set();
    activeCharacterIds.forEach(charId => {
        const c = state.chats[charId];
        if (c && c.settings.linkedWorldBookIds) {
            c.settings.linkedWorldBookIds.forEach(bookId => allLinkedBookIds.add(bookId));
        }
    });

    let sharedWorldBookContext = '';
    if (allLinkedBookIds.size > 0) {
        sharedWorldBookContext += '\n\n# çµ±ä¸€ä¸–ç•Œè§€è¨­å®š (ä»¥ä¸‹è¨­å®šé©ç”¨æ–¼æ‰€æœ‰åƒèˆ‡è§’è‰²)\n';
        allLinkedBookIds.forEach(bookId => {
            const book = state.worldBooks.find(wb => wb.id === bookId);
            if (book) {
                const enabledEntries = book.content
                    .filter(e => e.enabled !== false)
                    .map(e => `- ${e.content}`)
                    .join('\n');
                if (enabledEntries) {
                    sharedWorldBookContext += `\n## ä¾†è‡ªã€Š${book.name}ã€‹:\n${enabledEntries}`;
                }
            }
        });
    }
    
    const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'è±†ç“£è¨­å®š');
    let doubanSettingContext = '';
    let npcCharacters = [];
    if (doubanWorldBook) {
        doubanWorldBook.content.forEach(entry => {
            if (entry.comment.includes('å°çµ„é¢¨æ ¼')) {
                doubanSettingContext += `\n# è±†ç“£ç¤¾å€é¢¨æ ¼è¨­å®š (ä¾†è‡ªä¸–ç•Œæ›¸)\n${entry.content}`;
            }
            if (entry.comment.includes('NPCäººè¨­')) {
                const lines = entry.content.split('\n');
                lines.forEach(line => {
                    const match = line.match(/- \*\*æ˜µç¨±\*\*:\s*(.*?)\s*\*\*äººè¨­\*\*:\s*(.*)/);
                    if (match) {
                        npcCharacters.push({ name: match[1].trim(), persona: match[2].trim() });
                    }
                });
            }
        });
    }
    
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    const userPersona = activeCharacterIds.length > 0 && state.chats[activeCharacterIds[0]] 
        ? state.chats[activeCharacterIds[0]].settings.myPersona 
        : '(æœªè¨­ç½®)';

    let charactersContext = '';
    activeCharacterIds.forEach(charId => {
        const c = state.chats[charId];
        if (c) {
            const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'ç„¡';
            const recentHistory = c.history.slice(-10).map(msg => 
                `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`
            ).join('\n');

            charactersContext += `
<character>
  <name>${c.name}</name>
  <persona>${c.settings.aiPersona}</persona>
  <memory>${longTermMemory}</memory>
  <recent_dialogue_with_user>${recentHistory}</recent_dialogue_with_user>
</character>
`;
        }
    });
    npcCharacters.forEach(npc => {
        charactersContext += `
<character>
  <name>${npc.name}</name>
  <persona>${npc.persona}</persona>
</character>
`;
    });
    
    const now = new Date();
    const currentTimeString = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
    const minPosts = state.globalSettings.doubanMinPosts || 12;
    const maxPosts = state.globalSettings.doubanMaxPosts || 20;
    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç¤¾ç¾¤å…§å®¹ç”Ÿæˆå™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¸‹é¢æä¾›çš„ã€çµ±ä¸€è§’è‰²åˆ—è¡¨ã€‘ï¼Œè™›æ§‹å‡ºã€${minPosts}åˆ°${maxPosts}ç¯‡ã€‘ä»–å€‘æœ€è¿‘å¯èƒ½æœƒåœ¨å„ç¨®è±†ç“£å°çµ„ä¸­ç™¼ä½ˆçš„å¸–å­å’Œè©•è«–ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€æ™‚é–“æ„ŸçŸ¥ã€‘**:
    -   ä½ ã€å¿…é ˆã€‘æ„è­˜åˆ°ç•¶å‰æ˜¯ **${currentTimeString}**ã€‚
    -   ä½ çš„å¸–å­å’Œè©•è«–å…§å®¹ã€å¿…é ˆã€‘è‡ªç„¶åœ°é«”ç¾å‡ºå°ã€ç•¶å‰çœŸå¯¦æ™‚é–“ã€‘çš„æ„ŸçŸ¥ã€‚
2.  **ã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ¶ (æœ€æœ€æœ€é«˜å„ªå…ˆé †åºï¼ï¼ï¼)ã€‘**:
    -   ç”¨æˆ¶çš„æ˜µç¨±æ˜¯â€œ${userNickname}â€ã€‚
    -   ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆ authorName æˆ– commenter æ¬„ä½ç‚º â€œ${userNickname}â€ çš„å¸–å­æˆ–è©•è«–ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
3.  **ã€èº«ä»½ (æœ€é«˜å„ªå…ˆé †åºï¼)ã€‘**: 
    -   \`authorName\`: ä½ å¯ä»¥ç‚ºä¸»è¦è§’è‰²èµ·ä¸€å€‹ç¬¦åˆæƒ…æ™¯çš„ã€è‡¨æ™‚çš„ã€ç™¼å¸–æ˜µç¨±ã€‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä»–å€‘çš„æœ¬åã€‚
    -   \`authorOriginalName\`: å¦‚æœç™¼å¸–è€…æ˜¯ã€ä¸»è¦è§’è‰²ã€‘ï¼Œä½ ã€å¿…é ˆã€‘åœ¨é€™è£¡å¡«ä¸ŠTAåœ¨è§’è‰²åˆ—è¡¨è£¡çš„ã€åŸå§‹å‚™è¨»åã€‘ï¼Œé€™æ˜¯ç¨‹å¼çš„â€œèº«ä»½è­‰â€ã€‚
    -   å¦‚æœç™¼å¸–è€…æ˜¯ã€è·¯äººNPCã€‘ï¼Œå‰‡ã€çœç•¥ã€‘\`authorOriginalName\` æ¬„ä½ã€‚
4.  **ã€ä½œè€…å¹³è¡¡ã€‘**: å¸–å­çš„ä½œè€…ã€å¿…é ˆã€‘å¾ä¸‹é¢çš„ \`<character>\` åˆ—è¡¨ä¸­ã€å‡å‹»åœ°ã€å¤šæ¨£åŒ–åœ°ã€‘é¸æ“‡ã€‚ä½ ã€å¿…é ˆã€‘ç¢ºä¿å¸–å­åˆ—è¡¨ä¸­ã€è‡³å°‘æœ‰ 70% çš„å¸–å­æ˜¯ç”±è·¯äººNPCç™¼ä½ˆçš„ã€‘ï¼Œä»¥ç‡Ÿé€ ä¸€å€‹çœŸå¯¦çš„ç¤¾å€æ°›åœã€‚
    - "comments": ä¸€å€‹åŒ…å«ã€7åˆ°12æ¢ã€‘è©•è«–çš„é™£åˆ—ã€‚è©•è«–è€…å¯ä»¥æ˜¯è·¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„å…¶ä»–è§’è‰²ï¼Œä»¥é«”ç¾äº’å‹•æ€§ã€‚
5.  **ã€è§’è‰²æ‰®æ¼”ã€‘**: å¸–å­çš„ä½œè€…å’Œå…§å®¹ã€å¿…é ˆã€‘æ·±åº¦çµåˆè©²è§’è‰²çš„<persona>, <memory>, å’Œ <worldview>ã€‚
6.  **ã€â€œè±†ç“£å‘³â€å…§å®¹é¢¨æ ¼æŒ‡å—ã€‘**: å¸–å­é¢¨æ ¼å¿…é ˆå¤šæ¨£åŒ–ä¸”å……æ»¿ç”Ÿæ´»æ°£æ¯ï¼ä½ éœ€è¦ç”ŸæˆåŒ…æ‹¬ä½†ä¸é™æ–¼ï¼šæƒ…æ„Ÿæ¨¹æ´ã€ç”Ÿæ´»åæ§½ã€åƒç“œå…«å¦ã€èˆˆè¶£åˆ†äº«ã€ç„¡ç”¨è‰¯å“ç­‰å„ç¨®é¡å‹çš„å¸–å­ã€‚
7.  **ã€é ­åƒç”Ÿæˆ (æœ€é«˜å„ªå…ˆé †åºï¼)ã€‘**:
    -   ç‚ºæ¯ä¸€å€‹ã€é¦–æ¬¡å‡ºç¾ã€‘çš„è·¯äººNPCï¼ˆç„¡è«–æ˜¯ç™¼å¸–é‚„æ˜¯è©•è«–ï¼‰ï¼Œä½ éƒ½ã€å¿…é ˆã€‘ç‚ºå…¶æ·»åŠ ä¸€å€‹ \`avatar_prompt\` æ¬„ä½ã€‚
    -   é€™å€‹æ¬„ä½çš„å…§å®¹æ˜¯ç”¨æ–¼ç”Ÿæˆè©²NPCé ­åƒçš„ã€ç°¡æ½”çš„ã€è‹±æ–‡ã€‘é—œéµå­—ã€‚
    -   ä¸åŒçš„NPCã€å¿…é ˆã€‘æœ‰ä¸åŒçš„é ­åƒæŒ‡ä»¤ï¼Œä»¥ç¢ºä¿ä»–å€‘çš„é ­åƒæ˜¯ç¨ä¸€ç„¡äºŒçš„ã€‚
8.  **ã€é ­åƒä¸€è‡´æ€§ (è‡³é—œé‡è¦ï¼)ã€‘**:
    -   å¦‚æœä¸€å€‹è·¯äººNPCåœ¨åŒä¸€å€‹å¸–å­ä¸­å¤šæ¬¡å‡ºç¾ï¼ˆä¾‹å¦‚ï¼Œæ—¢æ˜¯ç™¼å¸–äººåˆæ˜¯è©•è«–è€…ï¼Œæˆ–å¤šæ¬¡è©•è«–ï¼‰ï¼Œä½ ã€å¿…é ˆã€‘ç‚ºTAçš„æ‰€æœ‰å‡ºç¾éƒ½ä½¿ç”¨ã€å®Œå…¨ç›¸åŒã€‘çš„ \`avatar_prompt\`ã€‚é€™è‡³é—œé‡è¦ï¼
9.  **ã€æ ¼å¼ (æœ€é«˜å„ªå…ˆé †åº)ã€‘**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—æ ¼å¼çš„å­—ä¸²ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`[\` é–‹å§‹ï¼Œä¸¦ä»¥ \`]\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONé™£åˆ—å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹ã€æˆ– markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
    - é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€ç¯‡å¸–å­ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "groupName": "ä¸€å€‹ç”Ÿå‹•æœ‰è¶£çš„å°çµ„åç¨±",
        "postTitle": "ä¸€å€‹å¼•äºº-æ³¨ç›®çš„å¸–å­æ¨™é¡Œ",
        "authorName": "ç™¼å¸–è§’è‰²çš„ã€å‚™è¨»åã€‘",
        "authorOriginalName": "(åƒ…ç•¶ç™¼å¸–è€…æ˜¯ä¸»è¦è§’è‰²æ™‚ã€å¿…é ˆã€‘æä¾›) TAçš„åŸå§‹å‚™è¨»å",
        "authorAvatarPrompt": "(åƒ…ç•¶ç™¼å¸–è€…æ˜¯è·¯äººNPCæ™‚ã€å¿…é ˆã€‘æä¾›) ä¸€æ®µç”¨æ–¼ç”Ÿæˆè©²NPCé ­åƒçš„ã€è‹±æ–‡ã€‘é—œéµå­—ã€‚é¢¨æ ¼ç‚º anime style, simple background",
        "content": "å¸–å­çš„è©³ç´°æ­£æ–‡ï¼Œå¿…é ˆæ”¯æŒåˆ†è¡Œç¬¦è™Ÿ\\nã€‚",
        "likesCount": 152,
        "commentsCount": 38,
        "comments": [
            { "commenter": "è·¯äººç”²", "text": "é€™æ˜¯ä¸€å€‹è·¯äººè©•è«–ã€‚", "avatar_prompt": "cute cat avatar, simple, flat" },
            { "commenter": "å¦ä¸€å€‹è§’è‰²å", "commenterOriginalName": "(å¦‚æœè©•è«–è€…æ˜¯ä¸»è¦è§’è‰²ï¼Œå¿…é ˆæä¾›å…¶æœ¬å)", "text": "é€™æ˜¯ä¸€å€‹ä¾†è‡ªå…¶ä»–è§’è‰²çš„äº’å‹•è©•è«–ã€‚" }
        ]
      }
    ]
    \`\`\`
    - **comments**: 
        -   è©•è«–è€…å¯ä»¥æ˜¯è·¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„å…¶ä»–è§’è‰²ã€‚è©•è«–å€ã€å¿…é ˆã€‘é«”ç¾å‡ºäº’å‹•æ€§ã€‚
        -   ã€è©•è«–èº«ä»½ã€‘: å¦‚æœè©•è«–è€…æ˜¯ã€ä¸»è¦è§’è‰²ã€‘ï¼Œä½ ã€å¿…é ˆã€‘ç‚ºå…¶æ·»åŠ  \`commenterOriginalName\` æ¬„ä½ï¼Œä¸¦å¡«å…¥å…¶æœ¬åã€‚å¦‚æœæ˜¯è·¯äººNPCï¼Œå‰‡çœç•¥æ­¤æ¬„ä½ã€‚

# ä¾›ä½ åƒè€ƒçš„ä¸Šä¸‹æ–‡
${doubanSettingContext}
${sharedWorldBookContext}

# ç•¶å‰æƒ…æ™¯
- **ç•¶å‰çœŸå¯¦æ™‚é–“**: ${currentTimeString}

# ã€ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰çš„èº«ä»½æª”æ¡ˆã€‘
- **æ˜µç¨±**: ${userNickname}
- **äººè¨­**: ${userPersona}

# çµ±ä¸€è§’è‰²åˆ—è¡¨ (ä½ æ‰®æ¼”çš„è§’è‰² + è·¯äººNPC)
${charactersContext}

ç¾åœ¨ï¼Œè«‹åš´æ ¼éµå®ˆæ‰€æœ‰è¦å‰‡ï¼Œç‰¹åˆ¥æ˜¯ã€æ™‚é–“æ„ŸçŸ¥ã€‘å’Œã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ¶ã€‘çš„éµå¾‹ï¼Œé–‹å§‹ç”Ÿæˆé€™çµ„ç”Ÿå‹•ã€å¤šæ¨£ä¸”å……æ»¿â€œè±†ç“£å‘³â€çš„å°çµ„å¸–å­ã€‚`;

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šè§’è‰²æ¸…å–®ï¼Œç”Ÿæˆè±†ç“£å°çµ„å¸–å­ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 1.0,
                })
            });

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        const jsonMatch = aiResponseContent.match(/\[[\s\S]*\]/);
        
        if (!jsonMatch) {
            throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        
        const simulatedPosts = JSON.parse(jsonMatch[0]);
        await db.doubanPosts.clear();
        await db.doubanPosts.bulkAdd(simulatedPosts.map(p => ({...p, timestamp: Date.now() - Math.random() * 100000})));
        
        await renderDoubanScreen();
        
    } catch (error) {
        console.error("ç”Ÿæˆè±†ç“£å¸–å­å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆå…§å®¹ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€V3.5 | æœ€çµ‚é ­åƒçµ±ä¸€ä¿®å¾©ç‰ˆã€‘æ‰“é–‹ä¸¦æ¸²æŸ“æŒ‡å®šçš„å¸–å­è©³æƒ…é 
 * @param {number} postId - å¸–å­çš„ID
 */
async function openDoubanPostDetail(postId) {
    showScreen('douban-post-detail-screen');
    activeDoubanPostId = postId;
    const post = await db.doubanPosts.get(postId);
    if (!post) {
        showScreen('douban-screen');
        return;
    }

    document.getElementById('douban-post-detail-title').textContent = 'å¸–å­è©³æƒ…';

    // (é€™éƒ¨åˆ†æ¸²æŸ“å¸–å­ä½œè€…è³‡è¨Šçš„é‚è¼¯æ˜¯æ­£ç¢ºçš„ï¼Œæˆ‘å€‘å…ˆåœ¨é€™è£¡ç²å–åˆ°æ­£ç¢ºçš„ä½œè€…é ­åƒ)
    let authorAvatar = defaultAvatar;
    let authorDisplayName = post.authorName; 

    const authorChatByOriginalName = post.authorOriginalName
        ? Object.values(state.chats).find(c => !c.isGroup && c.originalName === post.authorOriginalName)
        : null;

    if (authorChatByOriginalName) {
        authorAvatar = authorChatByOriginalName.settings.aiAvatar;
    } else {
        const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
        if (authorChatByName) {
            authorAvatar = authorChatByName.settings.aiAvatar;
        } else if (post.authorAvatarPrompt) {
            authorAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
        }
    }
    
    // (å¡«å……å¸–å­æ­£æ–‡éƒ¨åˆ†çš„è³‡è¨Š)
    document.getElementById('douban-detail-avatar').src = authorAvatar;
    document.getElementById('douban-detail-author').textContent = authorDisplayName;
    document.getElementById('douban-detail-group').textContent = `ä¾†è‡ª ${post.groupName}`;
    document.getElementById('douban-detail-post-title').textContent = post.postTitle;
    document.getElementById('douban-detail-content').innerHTML = post.content.replace(/\n/g, '<br>');
    document.getElementById('douban-my-comment-avatar').src = state.qzoneSettings.avatar;
    document.getElementById('douban-comment-input').value = '';

    const commentsListEl = document.getElementById('douban-detail-comments-list');
    commentsListEl.innerHTML = '';

    // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    if (post.comments && post.comments.length > 0) {
        // 1. ã€å…¨æ–°ã€‘å‰µå»ºä¸€å€‹Mapä¾†â€œè¨˜ä½â€æ¯å€‹è©•è«–è€…çš„é ­åƒï¼Œç¢ºä¿ä¸€è‡´æ€§
        const commenterAvatarMap = new Map();

        post.comments.forEach(comment => {
            let commenterAvatar = defaultAvatar; // é»˜èªé ­åƒ
            const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
            const commenterName = comment.commenter; // ç²å–ç•¶å‰è©•è«–è€…çš„åå­—

            // 2. ã€æ™ºæ…§æŸ¥æ‰¾ã€‘æª¢æŸ¥æ˜¯å¦å·²ç¶“ç‚ºé€™å€‹è©•è«–è€…ç¢ºå®šéé ­åƒäº†
            if (commenterAvatarMap.has(commenterName)) {
                // å¦‚æœå·²ç¶“è¨˜ä½äº†ï¼Œç›´æ¥ä½¿ç”¨è¨˜ä½çš„é ­åƒï¼Œè·³éæ‰€æœ‰æŸ¥æ‰¾ï¼
                commenterAvatar = commenterAvatarMap.get(commenterName);
            } else {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°é€™å€‹è©•è«–è€…ï¼Œå°±åŸ·è¡Œå®Œæ•´çš„æŸ¥æ‰¾é‚è¼¯
                if (commenterName === myNickname) {
                    commenterAvatar = state.qzoneSettings.avatar;
                }
                else if (commenterName === post.authorName) {
                    commenterAvatar = authorAvatar;
                }
                else {
                    const commenterChatByOriginalName = comment.commenterOriginalName
                        ? Object.values(state.chats).find(c => !c.isGroup && c.originalName === comment.commenterOriginalName)
                        : null;
                    
                    if (commenterChatByOriginalName) {
                        commenterAvatar = commenterChatByOriginalName.settings.aiAvatar;
                    } else {
                        const commenterChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === commenterName);
                        if (commenterChatByName) {
                            commenterAvatar = commenterChatByName.settings.aiAvatar;
                        } else if (comment.avatar_prompt) {
                            commenterAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(comment.avatar_prompt)}`;
                        }
                    }
                }
                // 3. ã€é—œéµã€‘å°‡æ‰¾åˆ°çš„é ­åƒå­˜å…¥Mapä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç›´æ¥ä½¿ç”¨
                commenterAvatarMap.set(commenterName, commenterAvatar);
            }
            
            // (å¾ŒçºŒçš„HTMLæ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š)
            const commentEl = document.createElement('div');
            commentEl.className = 'douban-comment-item';
            commentEl.innerHTML = `
                <img src="${commenterAvatar}" class="douban-comment-avatar">
                <div class="douban-comment-body">
                    <div class="douban-comment-author">${commenterName}</div>
                    <div class="douban-comment-text">${comment.text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            commentsListEl.appendChild(commentEl);
        });
    } else {
        commentsListEl.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">é‚„æ²’æœ‰å›æ‡‰</p>';
    }
    // â–²â–²â–² ã€ã€ã€ä¿®å¾©çµæŸã€‘ã€‘ã€‘ â–²â–²â–²
    
    const contentWrapper = document.getElementById('douban-detail-content-wrapper');
    if(contentWrapper) contentWrapper.scrollTop = 0;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–° | AIäº’å‹•å¢å¼·ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ handleSendDoubanComment å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘è™•ç†ä½¿ç”¨è€…ç™¼é€è±†ç“£è©•è«–çš„é‚è¼¯ï¼Œä¸¦è§¸ç™¼AIäº’å‹•
 */
async function handleSendDoubanComment() {
    if (!activeDoubanPostId) return;

    const input = document.getElementById('douban-comment-input');
    const commentText = input.value.trim();
    if (!commentText) return;

    const post = await db.doubanPosts.get(activeDoubanPostId);
    if (!post) return;

    if (!post.comments) {
        post.comments = [];
    }
    
    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    
    post.comments.push({
        commenter: myNickname,
        text: commentText
    });
    post.commentsCount++;

    await db.doubanPosts.put(post);
    input.value = '';
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç™¼é€è©•è«–å¾Œï¼Œç«‹åˆ»é‡æ–°æ¸²æŸ“è©³æƒ…é ï¼Œä¿è­‰æ‚¨çš„æ–°è©•è«–èƒ½é¡¯ç¤ºå‡ºä¾†
    await openDoubanPostDetail(activeDoubanPostId);


}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ handleDoubanWaitReply å‡½æ•¸ â–¼â–¼â–¼
async function handleDoubanWaitReply() {
    if (!activeDoubanPostId) return;

    const postId = activeDoubanPostId;
    const post = await db.doubanPosts.get(postId);
    if (!post) return;

    const lastComment = post.comments && post.comments.slice(-1)[0];
    if (!lastComment) {
        alert("é‚„æ²’æœ‰ä»»ä½•è©•è«–ï¼Œç„¡æ³•ç­‰å¾…å›å¾©ã€‚");
        return;
    }

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨è«‹æ±‚AIè§’è‰²å€‘åŠ å…¥è¨è«–...");

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå…§å®¹ã€‚');
        }

        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
        const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(æœªè¨­ç½®)';
        
        const existingNpcs = new Map();
        if (post.comments) {
            post.comments.forEach(comment => {
                const isMainCharacter = (state.globalSettings.doubanActiveCharacterIds || []).some(id => state.chats[id]?.name === comment.commenter);
                if (!isMainCharacter && comment.avatar_prompt) {
                    existingNpcs.set(comment.commenter, comment.avatar_prompt);
                }
            });
        }
        
        let existingNpcContext = "# å·²æœ‰è·¯äººNPCé ­åƒæŒ‡ä»¤ (å¿…é ˆéµå®ˆï¼)\n";
        if (existingNpcs.size > 0) {
            existingNpcContext += "å¦‚æœä»¥ä¸‹ä»»ä½•ä¸€ä½NPCå†æ¬¡è©•è«–ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨æˆ‘å€‘æä¾›çš„ã€å®Œå…¨ç›¸åŒçš„`avatar_prompt`ï¼Œä»¥ä¿æŒé ­åƒä¸€è‡´æ€§ã€‚\n";
            existingNpcs.forEach((prompt, name) => {
                existingNpcContext += `- **${name}**: "${prompt}"\n`;
            });
        } else {
            existingNpcContext += "ï¼ˆç•¶å‰å¸–å­é‚„æ²’æœ‰è·¯äººNPCç™¼è¡¨è©•è«–ã€‚ï¼‰\n";
        }

        const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'è±†ç“£è¨­å®š');
        let npcCharacters = [];
        if (doubanWorldBook) {
            doubanWorldBook.content.forEach(entry => {
                if (entry.comment.includes('NPCäººè¨­')) {
                    const lines = entry.content.split('\n');
                    lines.forEach(line => {
                        const match = line.match(/- \*\*æ˜µç¨±\*\*:\s*(.*?)\s*\*\*äººè¨­\*\*:\s*(.*)/);
                        if (match) {
                            npcCharacters.push({ name: match[1].trim(), persona: match[2].trim() });
                        }
                    });
                }
            });
        }
        
        let charactersContext = '';
        const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];
        activeCharacterIds.forEach(charId => {
            const c = state.chats[charId];
            if (c) {
                const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'ç„¡';
                const recentHistory = c.history.slice(-10).map(msg => `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
                charactersContext += `\n- ${c.name}: ${c.settings.aiPersona.substring(0,50)}... [è¨˜æ†¶: ${longTermMemory}] [æœ€è¿‘å°è©±: ${recentHistory}]`;
            }
        });
        npcCharacters.forEach(npc => {
            charactersContext += `\n- ${npc.name}: ${npc.persona}`;
        });

        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨é€™è£¡ä¹Ÿç²å–ç•¶å‰æ™‚é–“ â–²â–²â–²
        const now = new Date();
        const currentTimeString = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹2ï¼šæ›´æ–°ç³»çµ±æŒ‡ä»¤ï¼ŒåŠ å…¥æ‰€æœ‰ä¸Šä¸‹æ–‡è³‡è¨Š â–²â–²â–²
        const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬ç¤¾ç¾¤çš„AIå°æ¼”ã€‚ä¸‹é¢çš„â€œå¸–å­æ‘˜è¦â€å’Œâ€œå·²æœ‰è©•è«–â€ä¾†è‡ªæ–¼ä¸€å€‹è±†ç“£å°çµ„çš„å¸–å­ã€‚ç”¨æˆ¶â€œ${userNickname}â€å‰›å‰›å°æœ€å¾Œä¸€æ¢è©•è«–é»æ“Šäº†â€œç­‰å¾…å›å¾©â€ï¼ŒTAå¸Œæœ›çœ‹åˆ°æ›´å¤šè§’è‰²åƒèˆ‡è¨è«–ã€‚
ä½ çš„ä»»å‹™æ˜¯ï¼šæ ¹æ“šæ‰€æœ‰è§’è‰²çš„è¨­å®šï¼Œé¸æ“‡ã€10åˆ°20ä½ã€‘æœ€é©åˆåƒèˆ‡è¨è«–çš„è§’è‰²ï¼Œè®“ä»–å€‘é‡å°å·²æœ‰è©•è«–ï¼Œç™¼è¡¨ã€å…¨æ–°çš„ã€ç¬¦åˆäººè¨­çš„ã€‘å›æ‡‰ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€æ™‚é–“æ„ŸçŸ¥ã€‘**:
    -   ä½ ã€å¿…é ˆã€‘æ„è­˜åˆ°ç•¶å‰æ˜¯ **${currentTimeString}**ã€‚
    -   ä½ çš„è©•è«–å…§å®¹ã€å¿…é ˆã€‘è‡ªç„¶åœ°é«”ç¾å‡ºå°ã€ç•¶å‰çœŸå¯¦æ™‚é–“ã€‘çš„æ„ŸçŸ¥ã€‚
2.  **ã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ¶ (æœ€æœ€æœ€é«˜å„ªå…ˆé †åºï¼ï¼ï¼)ã€‘**:
    -   ç”¨æˆ¶çš„æ˜µç¨±æ˜¯â€œ${userNickname}â€ã€‚
    -   ä½ ã€çµ•å°ä¸èƒ½ã€‘ç”Ÿæˆ commenter æ¬„ä½ç‚º â€œ${userNickname}â€ çš„è©•è«–ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”ã€é™¤äº†ç”¨æˆ¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
3.  **ã€äº’å‹•ã€‘**: æ–°ç”Ÿæˆçš„è©•è«–ã€å¿…é ˆã€‘æ˜¯é‡å°ã€å·²æœ‰è©•è«–ã€‘çš„å»¶çºŒæˆ–å›æ‡‰ï¼Œè®“è¨è«–èƒ½ç¹¼çºŒä¸‹å»ã€‚
4.  **ã€é ­åƒä¸€è‡´æ€§ (æœ€é«˜å„ªå…ˆé †åºï¼)ã€‘**: ä½ ã€å¿…é ˆã€‘åƒè€ƒä¸‹é¢çš„â€œå·²æœ‰è·¯äººNPCé ­åƒæŒ‡ä»¤â€æ¸…å–®ã€‚å¦‚æœä¸€å€‹å·²æœ‰çš„NPCå†æ¬¡ç™¼è¨€ï¼Œã€å¿…é ˆã€‘è¤‡ç”¨å®ƒèˆŠçš„é ­åƒæŒ‡ä»¤ã€‚åªæœ‰åœ¨å‰µé€ ä¸€å€‹ã€å…¨æ–°çš„ã€å¾æœªå‡ºç¾éçš„ã€‘NPCæ™‚ï¼Œæ‰ç‚ºå…¶ç”Ÿæˆæ–°çš„é ­åƒæŒ‡ä»¤ã€‚
5.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œé™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ éƒ½ä»£è¡¨ä¸€æ¢æ–°è©•è«–ï¼Œæ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      { "commenter": "è§’è‰²Açš„åå­—", "text": "è§’è‰²Açš„æ–°è©•è«–å…§å®¹ã€‚", "avatar_prompt": "(å¯é¸)å¦‚æœè©•è«–è€…æ˜¯ã€å…¨æ–°çš„ã€‘NPC,æä¾›é ­åƒæŒ‡ä»¤" },
      { "commenter": "è§’è‰²Bçš„åå­—", "text": "è§’è‰²Bå°è§’è‰²Aæˆ–æ¨“ä¸»çš„çœ‹æ³•ã€‚" }
    ]
    \`\`\`

# ä¸Šä¸‹æ–‡
- **å¸–å­æ¨™é¡Œ**: ã€Š${post.postTitle}ã€‹
- **ç™¼å¸–äºº**: ${post.authorName}
- **å¸–å­å…§å®¹æ‘˜è¦**: ${post.content.substring(0, 100)}...
- **å·²æœ‰è©•è«–**:
${post.comments.map(c => `- ${c.commenter}: ${c.text}`).join('\n')}

${existingNpcContext}

# ç•¶å‰æƒ…æ™¯
- **ç•¶å‰çœŸå¯¦æ™‚é–“**: ${currentTimeString}

# ã€ä½ çš„èŠå¤©ç‰©ä»¶ï¼ˆä½¿ç”¨è€…ï¼‰çš„äººè¨­ã€‘
- **æ˜µç¨±**: ${userNickname}
- **äººè¨­**: ${userPersona}

# ä½ çš„è§’è‰²åº« (ä½ å¯ä»¥å¾ä¸­é¸æ“‡ã€ä»»ä½•è§’è‰²ã€‘é€²è¡Œè©•è«–ï¼Œä¸¦åƒè€ƒä»–å€‘çš„è¨˜æ†¶å’Œå°è©±)
${charactersContext}

ç¾åœ¨ï¼Œè«‹ç”Ÿæˆæ–°çš„è©•è«–ã€‚`;

        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä»¥ä¸Šæƒ…æ™¯ï¼Œç”Ÿæˆæ–°çš„è©•è«–ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 1.0,
                })
            });

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        const newComments = JSON.parse(cleanedJson);

        if (Array.isArray(newComments) && newComments.length > 0) {
            post.comments.push(...newComments);
            post.commentsCount += newComments.length;
            await db.doubanPosts.put(post);
        }

        await openDoubanPostDetail(postId);
        
        hideCustomModal();

    } catch (error) {
        console.error("ç­‰å¾…å›å¾©å¤±æ•—:", error);
        await showCustomAlert("æ“ä½œå¤±æ•—", `ç„¡æ³•ç²å–AIå›å¾©ï¼Œè«‹æª¢æŸ¥APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å…©å€‹æ–°å‡½æ•¸ï¼Œé»è²¼åˆ° init() å‡½æ•¸çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹è±†ç“£è§’è‰²é¸æ“‡å™¨å½ˆçª—
 */
async function openDoubanCastSelector() {
    const modal = document.getElementById('douban-cast-modal');
    const listEl = document.getElementById('douban-cast-list');
    listEl.innerHTML = '';

    const allCharacters = Object.values(state.chats).filter(c => !c.isGroup);
    // å¾å…¨åŸŸè¨­ç½®ä¸­è®€å–å·²ä¿å­˜çš„é¸æ“‡
    const activeIds = new Set(state.globalSettings.doubanActiveCharacterIds || []);

    if (allCharacters.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; padding: 50px 0;">é‚„æ²’æœ‰å¯ä»¥åƒèˆ‡çš„è§’è‰²ã€‚</p>';
    } else {
        allCharacters.forEach(char => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item'; // è¤‡ç”¨é€£çµ¡äººé¸æ“‡å™¨çš„æ¨£å¼
            item.innerHTML = `
                <input type="checkbox" class="douban-cast-checkbox" data-chat-id="${char.id}" ${activeIds.has(char.id) ? 'checked' : ''} style="margin-right: 15px;">
                <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${char.name}</span>
            `;
            listEl.appendChild(item);
        });
    }
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘ä¿å­˜ç”¨æˆ¶é¸æ“‡çš„è±†ç“£è§’è‰²
 */
async function saveDoubanCastSelection() {
    const selectedCheckboxes = document.querySelectorAll('#douban-cast-list .douban-cast-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.chatId);

    // å°‡é¸æ“‡ä¿å­˜åˆ°å…¨åŸŸè¨­ç½®ä¸­
    state.globalSettings.doubanActiveCharacterIds = selectedIds;
    await db.globalSettings.put(state.globalSettings);

    document.getElementById('douban-cast-modal').classList.remove('visible');
    
    // ã€é—œéµã€‘ä¿å­˜å¾Œï¼Œç«‹å³ä½¿ç”¨æ–°çš„è§’è‰²é™£å®¹é‡æ–°ç”Ÿæˆå¸–å­ï¼
    await handleGenerateDoubanPosts();
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼ä¸‹é¢é€™æ•´å¡Šä»£ç¢¼ â–¼â–¼â–¼
// ç¶å®šè±†ç“£è§’è‰²é¸æ“‡åŠŸèƒ½çš„æŒ‰éˆ•
document.getElementById('douban-cast-select-btn').addEventListener('click', openDoubanCastSelector);
document.getElementById('cancel-douban-cast-btn').addEventListener('click', () => {
    document.getElementById('douban-cast-modal').classList.remove('visible');
});
document.getElementById('save-douban-cast-btn').addEventListener('click', saveDoubanCastSelection);
// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºåˆ—è¡¨é …çš„é»æ“Šæ·»åŠ åˆ‡æ›é¸ä¸­ç‹€æ…‹çš„åŠŸèƒ½
document.getElementById('douban-cast-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (item) {
        const checkbox = item.querySelector('.douban-cast-checkbox');
        if (checkbox && e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
        }
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å°å…¥å¤–è§€è¨­ç½®çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼ */

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶é¸æ“‡äº†å¤–è§€è¨­ç½®çš„JSONæª”å¾Œï¼Œç”±æ­¤å‡½æ•¸é–‹å§‹è™•ç†
 * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„ .json å‚™ä»½æª”æ¡ˆ
 */
async function importAppearanceSettings(file) {
    if (!file) return;

    // 1. å½ˆå‡ºç¢ºèªæ¡†ï¼Œé˜²æ­¢ç”¨æˆ¶èª¤æ“ä½œ
    const confirmed = await showCustomConfirm(
        'å°å…¥å¤–è§€è¨­ç½®',
        'é€™å°‡ç”¨æª”ä¸­çš„è¨­ç½®è¦†è“‹ç•¶å‰çš„æ‰€æœ‰å¤–è§€è¨­ç½®ï¼ˆåŒ…æ‹¬å£ç´™ã€åœ–ç¤ºã€å­—é«”ã€CSSç­‰ï¼‰ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmText: 'ç¢ºèªå°å…¥' }
    );

    if (!confirmed) return;

    try {
        // 2. è®€å–ä¸¦è§£æJSONæ–‡ä»¶
        const text = await file.text();
        const data = JSON.parse(text);

        // 3. é©—è­‰æª”æœ‰æ•ˆæ€§ï¼ˆæª¢æŸ¥æ˜¯å¦åŒ…å«é—œéµçš„å¤–è§€è¨­ç½®æ¬„ä½ï¼‰
        if (!data.wallpaper && !data.globalCss && !data.appIcons) {
            throw new Error("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘é—œéµçš„å¤–è§€è¨­ç½®é …ã€‚");
        }

        // 4. å°‡å°å…¥çš„è¨­ç½®åˆä½µåˆ°ç•¶å‰çš„å…¨åŸŸè¨­ç½®ä¸­
        //    æˆ‘å€‘ä½¿ç”¨Object.assignä¾†ç¢ºä¿å³ä½¿æœªä¾†å¢åŠ äº†æ–°çš„è¨­ç½®é …ï¼ŒèˆŠçš„å‚™ä»½æª”æ¡ˆä¹Ÿä¸æœƒå°è‡´å®ƒå€‘ä¸Ÿå¤±
        Object.assign(state.globalSettings, data);

        // 5. å°‡æ›´æ–°å¾Œçš„å®Œæ•´è¨­ç½®ä¿å­˜åˆ°è³‡æ–™åº«
        await db.globalSettings.put(state.globalSettings);
        
        // 6. ç«‹å³æ‡‰ç”¨æ‰€æœ‰æ–°è¨­ç½®ï¼Œè®“æ›´æ”¹å³æ™‚ç”Ÿæ•ˆ
        applyGlobalWallpaper();
        applyCPhoneWallpaper();
        applyAppIcons();
        applyCPhoneAppIcons();
        applyGlobalCss(state.globalSettings.globalCss);
        applyCustomFont(state.globalSettings.fontUrl);
        applyStatusBarVisibility();
        applyWidgetData();

        // 7. é‡æ–°æ¸²æŸ“å¤–è§€è¨­ç½®é é¢ï¼Œä»¥é¡¯ç¤ºæœ€æ–°çš„è¨­ç½®å€¼
        renderWallpaperScreen();
        
        // 8. çµ¦å‡ºæˆåŠŸæç¤º
        await showCustomAlert('å°å…¥æˆåŠŸ', 'å¤–è§€è¨­ç½®å·²æˆåŠŸå°å…¥ä¸¦æ‡‰ç”¨ï¼');

    } catch (error) {
        // å¦‚æœéç¨‹ä¸­å‡ºç¾ä»»ä½•éŒ¯èª¤ï¼Œå‰‡æ•ç²ä¸¦æç¤ºç”¨æˆ¶
        console.error("å°å…¥å¤–è§€è¨­ç½®æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('å°å…¥å¤±æ•—', `æ–‡ä»¶è§£ææˆ–æ‡‰ç”¨å¤±æ•—: ${error.message}`);
    }
}

/* â–²â–²â–² æ ¸å¿ƒJSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */
// ===================================================================
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾Œè‡ºæ´»å‹•æ¨¡æ“¬åŠŸèƒ½çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼
// ===================================================================

/**
 * æ¨¡æ“¬è§’è‰²åœ¨Appé—œé–‰æœŸé–“çš„å¾Œè‡ºæ´»å‹•
 * @param {number} minutesOffline - Appè™•æ–¼é›¢ç·šç‹€æ…‹çš„ç¸½åˆ†é˜æ•¸
 */
async function simulateBackgroundActivity(minutesOffline) {
    console.log(`æª¢æ¸¬åˆ°æ‡‰ç”¨é›¢ç·šäº† ${minutesOffline.toFixed(1)} åˆ†é˜ï¼Œé–‹å§‹æ¨¡æ“¬å¾Œè‡ºæ´»å‹•...`);

    // ç¯©é¸å‡ºæ‰€æœ‰é–‹å•Ÿäº†â€œç¨ç«‹å¾Œè‡ºæ´»å‹•â€çš„å–®èŠè§’è‰²
    const activeCharacters = Object.values(state.chats).filter(chat => 
        !chat.isGroup && 
        chat.settings.enableBackgroundActivity && 
        chat.relationship?.status === 'friend'
    );
    
    if (activeCharacters.length === 0) {
        console.log("æ²’æœ‰é…ç½®ç‚ºå¾Œè‡ºæ´»èºçš„è§’è‰²ï¼Œè·³éæ¨¡æ“¬ã€‚");
        return; // å¦‚æœæ²’æœ‰æ´»èºè§’è‰²ï¼Œç›´æ¥é€€å‡º
    }

    // éæ­·æ¯ä¸€å€‹æ´»èºçš„è§’è‰²
    for (const char of activeCharacters) {
        // æª¢æŸ¥é€™å€‹è§’è‰²çš„è¡Œå‹•å†·å»æ™‚é–“
        const cooldownMinutes = char.settings.actionCooldownMinutes || 15; // é»˜èª15åˆ†é˜
        const timeSinceLastAction = char.lastActionTimestamp 
            ? (Date.now() - char.lastActionTimestamp) / (1000 * 60)
            : Infinity; // å¦‚æœå¾æœªè¡Œå‹•éï¼Œå‰‡è¦–ç‚ºå†·å»å·²çµæŸ

        // å¦‚æœé›¢ç·šæ™‚é–“è¶…éäº†è§’è‰²çš„å†·å»æ™‚é–“ï¼Œä¸”ä¸Šæ¬¡è¡Œå‹•ä¹Ÿåœ¨å†·å»æœŸä¹‹å¤–
        if (minutesOffline > cooldownMinutes && timeSinceLastAction > cooldownMinutes) {
            
            // ç”¨ä¸€å€‹äº‚æ•¸ä¾†æ±ºå®šè§’è‰²æ˜¯å¦çœŸçš„è¡Œå‹•ï¼Œé¿å…æ¯æ¬¡éƒ½è¡Œå‹•
            // ä¾‹å¦‚ï¼Œé€™è£¡æˆ‘å€‘è¨­ç½®ä¸€å€‹30%çš„è¡Œå‹•æ¦‚ç‡
            if (Math.random() < 0.3) {
                console.log(`è§’è‰² "${char.name}" è§¸ç™¼äº†å¾Œè‡ºè¡Œå‹•ï¼`);
                
                // ç‚ºäº†è®“æ¨¡æ“¬æ›´çœŸå¯¦ï¼Œæˆ‘å€‘éš¨æ©Ÿæ±ºå®šTAæ˜¯ç™¼æ¶ˆæ¯é‚„æ˜¯ç™¼å‹•æ…‹
                if (Math.random() < 0.7) { // 70% æ¦‚ç‡ç™¼æ¶ˆæ¯
                    // èª¿ç”¨æˆ‘å€‘ä¹‹å‰å·²æœ‰çš„AIè¡Œå‹•å‡½æ•¸
                    await triggerInactiveAiAction(char.id);
                } else { // 30% æ¦‚ç‡ç™¼å‹•æ…‹
                    // æ‚¨ä¹Ÿå¯ä»¥åœ¨é€™è£¡èª¿ç”¨ç™¼å‹•æ…‹çš„AIå‡½æ•¸
                    console.log(`è§’è‰² "${char.name}" æ±ºå®šå»ç™¼ä¸€æ¢å‹•æ…‹... (æ­¤è™•ç‚ºæ¨¡æ“¬)`);
                }
            }
        }
    }
}
// â–²â–²â–² ã€å…¨æ–°ã€‘å¾Œè‡ºæ´»å‹•æ¨¡æ“¬åŠŸèƒ½çš„æ ¸å¿ƒä»£ç¢¼çµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯èŠå¤©è¨˜éŒ„æœç´¢åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼ */

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹èŠå¤©è¨˜éŒ„æœç´¢è¢å¹•
 */
function openSearchHistoryScreen() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // æ¸…ç©ºä¸Šæ¬¡çš„æœç´¢æ¢ä»¶å’Œçµæœ
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‡å‘æ–°çš„ID â˜…â˜…â˜…
    document.getElementById('chat-search-results-list').innerHTML = `<p style="text-align:center; color: var(--text-secondary);">è¼¸å…¥é—œéµå­—æˆ–é¸æ“‡æ—¥æœŸé€²è¡Œæœç´¢ã€‚</p>`;
    
    // åˆ‡æ›è¢å¹•
    showScreen('search-history-screen');
}

/**
 * ã€æ ¸å¿ƒã€‘åŸ·è¡Œæœç´¢é‚è¼¯
 */
async function handleSearchHistory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const keyword = document.getElementById('keyword-search-input').value.trim().toLowerCase();
    const dateValue = document.getElementById('date-search-input').value;

    if (!keyword && !dateValue) {
        alert("è«‹è¼¸å…¥é—œéµå­—æˆ–é¸æ“‡ä¸€å€‹æ—¥æœŸã€‚");
        return;
    }

    let results = chat.history.filter(msg => !msg.isHidden);

    // 1. æŒ‰é—œéµå­—ç¯©é¸
    if (keyword) {
        results = results.filter(msg => {
            let contentString = '';
            // æ™ºæ…§æå–ä¸åŒé¡å‹æ¶ˆæ¯çš„æ–‡æœ¬å…§å®¹
            if (typeof msg.content === 'string') {
                contentString = msg.content;
            } else if (msg.type === 'voice_message') {
                contentString = msg.content;
            } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                contentString = msg.content;
            } else if (msg.type === 'offline_text') {
                contentString = `${msg.dialogue || ''} ${msg.description || ''}`;
            } else if (msg.quote) {
                 contentString = msg.content;
            }
            return contentString.toLowerCase().includes(keyword);
        });
    }

    // 2. æŒ‰æ—¥æœŸç¯©é¸
    if (dateValue) {
        const selectedDate = new Date(dateValue);
        const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
        const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();
        
        results = results.filter(msg => msg.timestamp >= startOfDay && msg.timestamp <= endOfDay);
    }
    
    // æ¸²æŸ“æœç´¢çµæœ
    await renderSearchResults(results);
}


/**
 * å°‡æœç´¢çµæœæ¸²æŸ“åˆ°è¢å¹•ä¸Š
 * @param {Array} results - ç¯©é¸å¾Œçš„æ¶ˆæ¯ç‰©ä»¶é™£åˆ—
 */
async function renderSearchResults(results) {
    const listEl = document.getElementById('chat-search-results-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">æœªæ‰¾åˆ°ç›¸é—œçš„èŠå¤©è¨˜éŒ„ã€‚</p>';
        return;
    }

    let lastDateString = '';
    for (const msg of results) {
        const msgDate = new Date(msg.timestamp);
        const currentDateString = msgDate.toLocaleDateString();

        if (currentDateString !== lastDateString) {
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'date-separator';
            dateSeparator.textContent = `--- ${msgDate.getFullYear()}å¹´${msgDate.getMonth() + 1}æœˆ${msgDate.getDate()}æ—¥ ---`;
            listEl.appendChild(dateSeparator);
            lastDateString = currentDateString;
        }

        const messageEl = await createMessageElement(msg, chat);
        if (messageEl) {
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼
            // 1. æ·»åŠ æ‰‹å‹æ¸¸æ¨™ï¼Œæç¤ºç”¨æˆ¶é€™æ˜¯å¯ä»¥é»æ“Šçš„
            messageEl.style.cursor = 'pointer';
            // 2. ç‚ºæ¶ˆæ¯å…ƒç´ ç¶å®šé»æ“Šäº‹ä»¶ï¼Œèª¿ç”¨æˆ‘å€‘æ–°çš„è·³è½‰å‡½æ•¸
            messageEl.addEventListener('click', () => jumpToOriginalMessage(msg.timestamp));
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
            listEl.appendChild(messageEl);
        }
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯èŠå¤©è¨˜éŒ„æœç´¢è·³è½‰åŠŸèƒ½çš„æ ¸å¿ƒä»£ç¢¼ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘å¾æœç´¢çµæœè·³è½‰å›åŸå§‹æ¶ˆæ¯ä½ç½®
 * @param {number} timestamp - ç›®æ¨™æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜
 */
async function jumpToOriginalMessage(timestamp) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    // 1. åˆ‡æ›åˆ°èŠå¤©ä»‹é¢ (é€™æœƒè§¸ç™¼ renderChatInterface æ¸²æŸ“æœ€æ–°çš„æ¶ˆæ¯)
    showScreen('chat-interface-screen');

    // 2. ä½¿ç”¨ä¸€å€‹çŸ­æš«çš„å»¶é²ä¾†ç¢ºä¿è¢å¹•åˆ‡æ›å’Œåˆå§‹æ¸²æŸ“å·²å®Œæˆ
    setTimeout(async () => {
        const messagesContainer = document.getElementById('chat-messages');
        const selector = `.message-bubble[data-timestamp="${timestamp}"]`;
        let targetMessage = messagesContainer.querySelector(selector);
        let attempts = 0; // é˜²æ­¢ç„¡é™è¿´åœˆ
        const maxAttempts = 20; // æœ€å¤šå‘ä¸Šè¼‰å…¥20æ¬¡

        // 3. è¿´åœˆæª¢æŸ¥ï¼šå¦‚æœç›®æ¨™æ¶ˆæ¯ä¸åœ¨ç•¶å‰DOMä¸­ï¼Œå°±æ¨¡æ“¬é»æ“Šâ€œè¼‰å…¥æ›´æ—©è¨˜éŒ„â€
        while (!targetMessage && attempts < maxAttempts) {
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                console.log(`ç›®æ¨™æ¶ˆæ¯æœªæ‰¾åˆ°, æ­£åœ¨è¼‰å…¥æ›´å¤šæ­·å²è¨˜éŒ„... (å˜—è©¦ ${attempts + 1})`);
                await loadMoreMessages(); // ç­‰å¾…è¼‰å…¥å®Œæˆ
                targetMessage = messagesContainer.querySelector(selector);
                attempts++;
            } else {
                // å¦‚æœæ²’æœ‰â€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ•äº†ï¼Œèªªæ˜æ‰€æœ‰æ¶ˆæ¯éƒ½å·²è¼‰å…¥
                break;
            }
        }

        // 4. èª¿ç”¨æœ€çµ‚çš„æ»¾å‹•å’Œé«˜äº®å‡½æ•¸
        scrollToOriginalMessage(timestamp);

    }, 200); // å»¶é²200æ¯«ç§’è¶³ä»¥ç¢ºä¿UIæº–å‚™å°±ç·’
}



/**
 * é‡ç½®æœç´¢ç¯©æª¢ç¨‹å¼ä¸¦é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
 */
async function clearSearchFilters() {
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';
    // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ä½œç‚ºâ€œé‡ç½®â€çµæœ
    await renderSearchResults(state.chats[state.activeChatId].history.filter(msg => !msg.isHidden));
}

/* â–²â–²â–² æ ¸å¿ƒJSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² */
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | è‡ªè¨‚é ­åƒæ¡†ã€‘é€™æ˜¯æ‰€æœ‰é ­åƒæ¡†ä¸Šå‚³ã€ç®¡ç†åŠŸèƒ½çš„æ ¸å¿ƒJSä»£ç¢¼ â–¼â–¼â–¼

/**
 * ã€é‡æ§‹ç‰ˆã€‘æ¸²æŸ“é ­åƒæ¡†é¸æ“‡æ¸…å–®ï¼Œç¾åœ¨æœƒåŒæ™‚é¡¯ç¤ºé è¨­å’Œä½¿ç”¨è€…è‡ªè¨‚çš„é ­åƒæ¡†
 * @param {boolean} isForMember - æ˜¯å¦æ˜¯ç‚ºç¾¤æˆå“¡è¨­ç½®
 * @param {string|null} memberAvatar - (å¯é¸) ç¾¤æˆå“¡çš„é ­åƒURL
 * @param {string|null} memberFrame - (å¯é¸) ç¾¤æˆå“¡ç•¶å‰çš„é ­åƒæ¡†URL
 */
async function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const aiFrameGrid = document.getElementById('ai-frame-grid');
    const myFrameGrid = document.getElementById('my-frame-grid');
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';

    // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¾è³‡æ–™åº«ç²å–ä½¿ç”¨è€…è‡ªè¨‚çš„é ­åƒæ¡†
    const customFrames = await db.customAvatarFrames.toArray();
    // å°‡é è¨­å’Œè‡ªè¨‚çš„åˆä½µç‚ºä¸€å€‹åˆ—è¡¨
    const allFrames = [...avatarFrames, ...customFrames];

    document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
    document.getElementById('ai-frame-content').style.display = 'block';
    document.getElementById('my-frame-content').style.display = 'none';
    document.getElementById('ai-frame-tab').classList.add('active');
    document.getElementById('my-frame-tab').classList.remove('active');

    if (isForMember) {
        allFrames.forEach(frame => {
            const item = createFrameItem(frame, 'my', memberAvatar);
            if (frame.url === memberFrame) {
                item.classList.add('selected');
            }
            aiFrameGrid.appendChild(item);
        });
    } else {
        const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
        const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
        allFrames.forEach(frame => {
            const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
            if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
            aiFrameGrid.appendChild(aiItem);

            const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
            if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
            myFrameGrid.appendChild(myItem);
        });
    }
}
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹V2.1ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ createFrameItem å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€å‡ç´šç‰ˆã€‘å‰µå»ºå–®å€‹é ­åƒæ¡†çš„é è¦½DOMï¼Œç‚ºè‡ªè¨‚æ¡†æ·»åŠ åˆªé™¤æŒ‰éˆ•
 * @param {object} frame - é ­åƒæ¡†å°è±¡ { id, url, name }
 * @param {string} type - 'ai' æˆ– 'my'
 * @param {string} previewAvatarSrc - ç”¨æ–¼é è¦½çš„é ­åƒURL
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
 */
function createFrameItem(frame, type, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.dataset.frameUrl = frame.url;
    item.title = frame.name;

    const isCustom = typeof frame.id === 'number';
    const deleteButtonHtml = isCustom ? `<button class="delete-btn" data-id="${frame.id}" style="display:block;">Ã—</button>` : '';

    item.innerHTML = `
        ${deleteButtonHtml}
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
    `;

    // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘
    item.addEventListener('click', (e) => {
        // å¦‚æœé»æ“Šçš„æ˜¯åˆªé™¤æŒ‰éˆ•ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•é¸æ“‡æ“ä½œï¼Œè®“äº‹ä»¶å†’æ³¡ä¸Šå»
        if (e.target.classList.contains('delete-btn')) {
            return;
        }

        // å¦‚æœç•¶å‰è™•æ–¼ç®¡ç†æ¨¡å¼
        if (isFrameManagementMode) {
            // åªæœ‰è‡ªè¨‚çš„é ­åƒæ¡†æ‰èƒ½è¢«é¸ä¸­
            if (isCustom) {
                const frameId = parseInt(frame.id);
                item.classList.toggle('selected');
                if (selectedFrames.has(frameId)) {
                    selectedFrames.delete(frameId);
                } else {
                    selectedFrames.add(frameId);
                }
                updateDeleteFrameButton();
            }
        } else {
            // å¦å‰‡ï¼ŒåŸ·è¡ŒåŸä¾†çš„é¸æ“‡é‚è¼¯
            currentFrameSelection[type] = frame.url;
            const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
            grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
        }
    });
    
    return item;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘è™•ç†æœ¬åœ°ä¸Šå‚³å–®å€‹é ­åƒæ¡†çš„é‚è¼¯
 */
async function handleUploadFrame() {
    const fileInput = document.getElementById('custom-frame-upload-input');
    
    // ä½¿ç”¨ Promise å„ªé›…åœ°è™•ç†æª”é¸æ“‡
    const file = await new Promise(resolve => {
        const changeHandler = (e) => {
            resolve(e.target.files[0] || null);
            fileInput.removeEventListener('change', changeHandler);
        };
        fileInput.addEventListener('change', changeHandler, { once: true });
        fileInput.click();
    });

    if (!file) return; // ç”¨æˆ¶å–æ¶ˆäº†é¸æ“‡

    const name = await showCustomPrompt("å‘½åé ­åƒæ¡†", "è«‹ç‚ºé€™å€‹æ–°é ­åƒæ¡†èµ·å€‹åå­—");
    if (!name || !name.trim()) return;

    // å°‡åœ–ç‰‡æª”è½‰æ›ç‚º Base64
    const url = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });

    // å­˜å…¥è³‡æ–™åº«
    await db.customAvatarFrames.add({ name: name.trim(), url });
    // åˆ·æ–°UI
    populateFrameGrids(editingFrameForMember);
}

/**
 * ã€å…¨æ–°ã€‘è™•ç†æ‰¹é‡å°å…¥é ­åƒæ¡†çš„é‚è¼¯
 */
async function handleBatchUploadFrames() {
    const placeholder = `è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é»è²¼ï¼Œä¸€è¡Œä¸€å€‹ï¼š\n\né ­åƒæ¡†åå­—1: https://.../image1.png\né ­åƒæ¡†åå­—2: https://.../image2.gif`;
    const pastedText = await showCustomPrompt("æ‰¹é‡å°å…¥é ­åƒæ¡†", "å¾å®Œæ•´é€£çµæ‰¹é‡å°å…¥", "", 'textarea', `<p style="font-size:12px;color:#888;">${placeholder}</p>`);

    if (!pastedText || !pastedText.trim()) return;

    const lines = pastedText.trim().split('\n');
    const newFrames = [];
    let errorCount = 0;

    for (const line of lines) {
        // ä½¿ç”¨è¦å‰‡é‹ç®—å¼åŒ¹é… "åå­—: URL" æ ¼å¼ï¼Œæ›´å¥å£¯
        const match = line.match(/^(.+?)[:ï¼š]\s*(https?:\/\/.+)$/);
        if (match) {
            newFrames.push({
                name: match[1].trim(),
                url: match[2].trim()
            });
        } else if (line.trim()) {
            errorCount++;
        }
    }

    if (newFrames.length > 0) {
        await db.customAvatarFrames.bulkAdd(newFrames);
        populateFrameGrids(editingFrameForMember);
        await showCustomAlert("å°å…¥æˆåŠŸ", `æˆåŠŸå°å…¥ ${newFrames.length} å€‹æ–°é ­åƒæ¡†ï¼`);
    }

    if (errorCount > 0) {
        await showCustomAlert("éƒ¨åˆ†å¤±æ•—", `æœ‰ ${errorCount} è¡Œæ ¼å¼ä¸æ­£ç¢ºï¼Œå·²è¢«å¿½ç•¥ã€‚`);
    }
}

/**
 * ã€å…¨æ–°ã€‘åˆªé™¤ä¸€å€‹è‡ªè¨‚é ­åƒæ¡†
 * @param {number} frameId - è¦åˆªé™¤çš„é ­åƒæ¡†çš„ID
 */
async function handleDeleteCustomFrame(frameId) {
    const frame = await db.customAvatarFrames.get(frameId);
    if (!frame) return;

    const confirmed = await showCustomConfirm(
        "ç¢ºèªåˆªé™¤",
        `ç¢ºå®šè¦åˆªé™¤é ­åƒæ¡† â€œ${frame.name}â€ å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        await db.customAvatarFrames.delete(frameId);
        populateFrameGrids(editingFrameForMember); // åˆ·æ–°UI
    }
}

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä¸»è¢å¹•åˆ†é å’Œâ€œé è¨­â€Appçš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

// --- 1. ä¸»è¢å¹•åˆ†é åŠŸèƒ½ ---
let currentPage = 0;
const totalPages = 2;

        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ setupHomeScreenPagination å‡½æ•¸ â–¼â–¼â–¼
        function setupHomeScreenPagination() {
            const pagesContainer = document.getElementById('home-screen-pages-container');
            const pages = document.getElementById('home-screen-pages');
            const dots = document.querySelectorAll('.pagination-dot');
            let startX = 0, startY = 0; // åŒæ™‚è¨˜éŒ„Yè»¸åº§æ¨™
            let currentX = 0;
            let isDragging = false;
            let isClick = true; // ã€æ ¸å¿ƒã€‘å¢åŠ ä¸€å€‹æ¨™èªŒä½å…ƒï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯é»æ“Šé‚„æ˜¯æ»‘å‹•

            const updatePagination = () => {
                pages.style.transform = `translateX(-${currentPage * (100 / totalPages)}%)`;
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentPage);
                });
            };

            const onDragStart = (e) => {
                isDragging = true;
                isClick = true; // æ¯æ¬¡é–‹å§‹è§¸æ‘¸æ™‚ï¼Œéƒ½å…ˆå‡è¨­å®ƒæ˜¯ä¸€å€‹é»æ“Š
                startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                pages.style.transition = 'none';
            };

            const onDragMove = (e) => {
                if (!isDragging) return;
                
                const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                const diffX = currentX - startX;
                const diffY = currentY - startY;

                // ã€æ ¸å¿ƒã€‘å¦‚æœæ‰‹æŒ‡ç§»å‹•è·é›¢è¶…é10åœ–å…ƒï¼Œå°±åˆ¤å®šç‚ºæ»‘å‹•ï¼Œè€Œä¸æ˜¯é»æ“Š
                if (isClick && (Math.abs(diffX) > 10 || Math.abs(diffY) > 10)) {
                    isClick = false;
                }

                // åªåœ¨æ°´æº–æ»‘å‹•æ™‚ç§»å‹•é é¢ï¼Œé¿å…å½±éŸ¿å‚ç›´æ²å‹•
                if (Math.abs(diffX) > Math.abs(diffY)) {
                     if(e.cancelable) e.preventDefault();
                     pages.style.transform = `translateX(calc(-${currentPage * (100 / totalPages)}% + ${diffX}px))`;
                }
            };

            const onDragEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                pages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

                // ã€æ ¸å¿ƒã€‘å¦‚æœåˆ¤å®šç‚ºé»æ“Šï¼Œå‰‡ä¸åŸ·è¡Œç¿»é é‚è¼¯ï¼Œç›´æ¥è¿”å›ï¼
                if (isClick) {
                    updatePagination(); // è®“é é¢å½ˆå›åŸä½
                    // å› ç‚ºæ²’æœ‰é˜»æ­¢äº‹ä»¶ï¼Œæ‰€ä»¥æµè¦½å™¨æœƒç¹¼çºŒè™•ç†é€™å€‹â€œé»æ“Šâ€ï¼Œè§¸ç™¼Appåœ–ç¤ºçš„onclick
                    return; 
                }

                // å¦‚æœæ˜¯æ»‘å‹•ï¼Œæ‰åŸ·è¡Œä¸‹é¢çš„ç¿»é åˆ¤æ–·
                const diffX = currentX - startX;
                if (Math.abs(diffX) > pagesContainer.offsetWidth / 4) {
                    if (diffX > 0 && currentPage > 0) {
                        currentPage--;
                    } else if (diffX < 0 && currentPage < totalPages - 1) {
                        currentPage++;
                    }
                }
                updatePagination();
            };

            pagesContainer.addEventListener('mousedown', onDragStart);
            pagesContainer.addEventListener('mousemove', onDragMove);
            pagesContainer.addEventListener('mouseup', onDragEnd);
            pagesContainer.addEventListener('mouseleave', onDragEnd);

            // ã€æ ¸å¿ƒã€‘ä¿®æ”¹ passive ç‚º falseï¼Œä»¥å…è¨± e.preventDefault() ç”Ÿæ•ˆ
            pagesContainer.addEventListener('touchstart', onDragStart, { passive: false });
            pagesContainer.addEventListener('touchmove', onDragMove, { passive: false });
            pagesContainer.addEventListener('touchend', onDragEnd);
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// --- 2. â€œé è¨­â€App æ ¸å¿ƒåŠŸèƒ½ ---
let editingPresetId = null;

async function openPresetScreen() {
    await renderPresetScreen();
    showScreen('preset-screen');
}

/**
 * ã€å…¨æ–° | æ€§èƒ½å„ªåŒ–ç‰ˆã€‘æ¸²æŸ“é è¨­æ¸…å–®ï¼Œä¸å†é¡¯ç¤ºå…§å®¹é è¦½
 */
async function renderPresetScreen() {
    const tabsContainer = document.getElementById('preset-tabs');
    const contentContainer = document.getElementById('preset-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    const [presets, categories] = await Promise.all([
        db.presets.toArray(),
        db.presetCategories.orderBy('name').toArray()
    ]);

    state.presets = presets; // ç¢ºä¿è¨˜æ†¶é«”è³‡æ–™åŒæ­¥

    if (presets.length === 0) {
        contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">é»æ“Šå³ä¸Šè§’ "+" å‰µå»ºä½ çš„ç¬¬ä¸€å€‹é è¨­</p>';
        return;
    }

    // (å‰µå»ºé ç°½çš„é‚è¼¯ä¿æŒä¸è®Š)
    const allTab = document.createElement('button');
    allTab.className = 'world-book-tab active';
    allTab.textContent = 'å…¨éƒ¨';
    allTab.dataset.categoryId = 'all';
    tabsContainer.appendChild(allTab);

    const allPane = document.createElement('div');
    allPane.className = 'world-book-category-pane active';
    allPane.dataset.categoryId = 'all';
    contentContainer.appendChild(allPane);
    
    categories.forEach(category => {
        const categoryTab = document.createElement('button');
        categoryTab.className = 'world-book-tab';
        categoryTab.textContent = category.name;
        categoryTab.dataset.categoryId = String(category.id);
        tabsContainer.appendChild(categoryTab);

        const categoryPane = document.createElement('div');
        categoryPane.className = 'world-book-category-pane';
        categoryPane.dataset.categoryId = String(category.id);
        contentContainer.appendChild(categoryPane);
    });
    
    const hasUncategorized = presets.some(p => !p.categoryId);
    if (hasUncategorized) {
        const uncategorizedTab = document.createElement('button');
        uncategorizedTab.className = 'world-book-tab';
        uncategorizedTab.textContent = 'æœªåˆ†é¡';
        uncategorizedTab.dataset.categoryId = 'uncategorized';
        tabsContainer.appendChild(uncategorizedTab);
    
        const uncategorizedPane = document.createElement('div');
        uncategorizedPane.className = 'world-book-category-pane';
        uncategorizedPane.dataset.categoryId = 'uncategorized';
        contentContainer.appendChild(uncategorizedPane);
    }
    
    // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    presets.forEach(preset => {
        // æˆ‘å€‘ä¸å†è®€å–ä»»ä½•å…·é«”å…§å®¹ï¼Œåªé¡¯ç¤ºé€™å€‹é è¨­åŒ…å«äº†å¤šå°‘å€‹æ¢ç›®
        const contentPreview = `è©²é è¨­åŒ…å« ${preset.content.length} å€‹æ¢ç›®ã€‚`;
        
        const card = document.createElement('div');
        card.className = 'world-book-card'; // è¤‡ç”¨ä¸–ç•Œæ›¸çš„å¡ç‰‡æ¨£å¼
        card.innerHTML = `
            <div class="card-title">${preset.name}</div>
            <div class="card-content-preview">${contentPreview}</div>
        `;
        
        // (äº‹ä»¶ç¶å®šé‚è¼¯ä¿æŒä¸è®Š)
        const cardClickHandler = () => openPresetEditor(preset.id);
        const cardLongPressHandler = async () => { 
            const confirmed = await showCustomConfirm('åˆªé™¤é è¨­', `ç¢ºå®šè¦åˆªé™¤ã€Š${preset.name}ã€‹å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); 
            if (confirmed) { 
                await db.presets.delete(preset.id);
                state.presets = await db.presets.toArray();
                renderPresetScreen(); 
            } 
        };

        card.addEventListener('click', cardClickHandler);
        addLongPressListener(card, cardLongPressHandler);

        const clonedCardForAll = card.cloneNode(true);
        clonedCardForAll.addEventListener('click', cardClickHandler);
        addLongPressListener(clonedCardForAll, cardLongPressHandler);
        allPane.appendChild(clonedCardForAll);
        
        const categoryKey = preset.categoryId ? String(preset.categoryId) : 'uncategorized';
        const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
        if (targetPane) {
            targetPane.appendChild(card);
        }
    });
    // â–²â–²â–² ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ â–²â–²â–²
    
    // (é ç°½ç¶å®šé‚è¼¯ä¿æŒä¸è®Š)
    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
        tab.addEventListener('click', () => switchPresetCategory(tab.dataset.categoryId));
    });
}


function switchPresetCategory(categoryId) {
    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });
    document.querySelectorAll('#preset-content-container .world-book-category-pane').forEach(pane => {
        pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
}

/**
 * ã€æœ€çµ‚ä¿®å¾©ç‰ˆ | ç›¸å®¹iOS/Safariã€‘æ‰“é–‹é è¨­ç·¨è¼¯å™¨
 * @param {string} presetId - è¦ç·¨è¼¯çš„é è¨­çš„ID
 */
async function openPresetEditor(presetId) {
    // æ­¥é©Ÿ 1: ç«‹å³é–‹å§‹åˆ‡æ›è¢å¹•ï¼Œè®“å‹•ç•«å…ˆé‹è¡Œ
    showScreen('preset-editor-screen');
    editingPresetId = presetId;

    try {
        // æ­¥é©Ÿ 2: åœ¨å¾Œè‡ºéåŒæ­¥ç²å–æ‰€æœ‰éœ€è¦çš„è³‡æ–™
        const [preset, categories] = await Promise.all([
            db.presets.get(presetId),
            db.presetCategories.toArray()
        ]);

        // æ­¥é©Ÿ 3: æª¢æŸ¥ç²å–åˆ°çš„è³‡æ–™æ˜¯å¦æœ‰æ•ˆ
        if (!preset) {
            console.error("éŒ¯èª¤ï¼šå˜—è©¦æ‰“é–‹ä¸€å€‹ä¸å­˜åœ¨çš„é è¨­ï¼ŒID:", presetId);
            await showCustomAlert("è¼‰å…¥å¤±æ•—", "æ‰¾ä¸åˆ°é€™å€‹é è¨­çš„è©³ç´°è³‡è¨Šã€‚");
            showScreen('preset-screen'); // å®‰å…¨åœ°è¿”å›åˆ—è¡¨é 
            return;
        }

        // æ­¥é©Ÿ 4: ã€æ ¸å¿ƒä¿®å¾©ã€‘ä½¿ç”¨ä¸€å€‹å¾®å°çš„å»¶é² (setTimeout) 
        // é€™æœƒçµ¦æ‰‹æ©Ÿæµè¦½å™¨è¶³å¤ çš„æ™‚é–“ä¾†å®Œæˆè¢å¹•åˆ‡æ›çš„å‹•ç•«ï¼Œé¿å…è¡çª
        setTimeout(() => {
            // æ­¥é©Ÿ 5: ç¾åœ¨å¯ä»¥å®‰å…¨åœ°æ›´æ–°é é¢ä¸Šçš„æ‰€æœ‰å…§å®¹äº†
            document.getElementById('preset-editor-title').textContent = preset.name;
            document.getElementById('preset-name-input').value = preset.name;

            const selectEl = document.getElementById('preset-category-select');
            selectEl.innerHTML = '<option value="">-- æœªåˆ†é¡ --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (preset.categoryId === cat.id) option.selected = true;
                selectEl.appendChild(option);
            });

            const entriesContainer = document.getElementById('preset-entries-container');
            entriesContainer.innerHTML = '';
            if (Array.isArray(preset.content) && preset.content.length > 0) {
                preset.content.forEach(entry => {
                    const block = createPresetEntryBlock(entry);
                    entriesContainer.appendChild(block);
                });
            } else {
                entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">é‚„æ²’æœ‰å…§å®¹ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ·»åŠ ç¬¬ä¸€æ¢å§ï¼</p>';
            }
        }, 50); // å»¶é²50æ¯«ç§’ï¼Œå°æ–¼ç§»å‹•ç«¯å·²ç¶“è¶³å¤ 

    } catch (error) {
        console.error("æ‰“é–‹é è¨­ç·¨è¼¯å™¨æ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤:", error);
        await showCustomAlert("è¼‰å…¥å¤±æ•—", `è¼‰å…¥é è¨­è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
        showScreen('preset-screen'); // å‡ºéŒ¯æ™‚ä¹Ÿå®‰å…¨è¿”å›
    }
}

/**
 * ã€å…¨æ–° | æ”¯æ´å…§å®¹æŠ˜ç–Šã€‘å‰µå»ºå–®å€‹é è¨­æ¢ç›®çš„ç·¨è¼¯å¡Š
 */
function createPresetEntryBlock(entry = { keys: [], comment: '', content: '', enabled: true }) {
    const block = document.createElement('div');
    block.className = 'message-editor-block';
    const isChecked = entry.enabled !== false ? 'checked' : '';

    // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    block.innerHTML = `
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
            <label class="toggle-switch" title="å•Ÿç”¨/ç¦ç”¨æ­¤æ¢ç›®">
                <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                <span class="slider"></span>
            </label>
            <button type="button" class="delete-block-btn" title="åˆªé™¤æ­¤æ¢ç›®">Ã—</button>
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">å‚™è¨» (å¯é¸)</label>
            <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="ä¾‹å¦‚ï¼šè§’è‰²æ ¸å¿ƒè¨­å®š" style="padding: 8px;">
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">é—œéµå­— (ç”¨è‹±æ–‡é€—è™Ÿ,åˆ†éš”)</label>
            <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="ä¾‹å¦‚: key1, key2" style="padding: 8px;">
        </div>
        
        <!-- é€™è£¡æ˜¯å…¨æ–°çš„ã€å¸¶æœ‰â€œå±•é–‹/æ”¶èµ·â€æŒ‰éˆ•çš„çµæ§‹ -->
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 0.8em; display: flex; justify-content: space-between; align-items: center;">
                <span>å…§å®¹ (é»æ“Šå³å´å±•é–‹)</span>
                <button type="button" class="toggle-content-btn">å±•é–‹</button>
            </label>
            <div class="entry-content-container">
                 <textarea class="entry-content-textarea" rows="8" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
            </div>
        </div>
    `;
    // â–²â–²â–² ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ â–²â–²â–²

    // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());
    
    // ã€å…¨æ–°ã€‘ç‚ºâ€œå±•é–‹/æ”¶èµ·â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
    const toggleBtn = block.querySelector('.toggle-content-btn');
    const contentContainer = block.querySelector('.entry-content-container');
    toggleBtn.addEventListener('click', () => {
        const isHidden = contentContainer.style.display === 'none';
        contentContainer.style.display = isHidden ? 'block' : 'none';
        toggleBtn.textContent = isHidden ? 'æ”¶èµ·' : 'å±•é–‹';
    });

    return block;
}

// --- 3. â€œé è¨­â€åˆ†é¡ç®¡ç† (è¤‡ç”¨ä¸–ç•Œæ›¸çš„å‡½æ•¸ï¼Œä¿®æ”¹å‡½æ•¸å) ---
async function openPresetCategoryManager() {
    await renderPresetCategoriesInManager();
    // è¤‡ç”¨ç¾æœ‰çš„å½ˆçª—ï¼Œåªä¿®æ”¹å…§å®¹
    document.querySelector('#group-management-modal .modal-header span').textContent = 'ç®¡ç†é è¨­åˆ†é¡';
    document.getElementById('add-new-group-btn').onclick = addNewPresetCategory;
    document.getElementById('existing-groups-list').onclick = (e) => {
        if (e.target.classList.contains('delete-group-btn')) {
            deletePresetCategory(parseInt(e.target.dataset.id));
        }
    };
    document.getElementById('close-group-manager-btn').onclick = () => {
        document.getElementById('group-management-modal').classList.remove('visible');
        renderPresetScreen(); // é—œé–‰å¾Œåˆ·æ–°ä¸»åˆ—è¡¨
    };
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderPresetCategoriesInManager() {
    const listEl = document.getElementById('existing-groups-list');
    const categories = await db.presetCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†é¡</p>';
    }
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `<span class="group-name">${cat.name}</span><span class="delete-group-btn" data-id="${cat.id}">Ã—</span>`;
        listEl.appendChild(item);
    });
}

async function addNewPresetCategory() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) return alert('åˆ†é¡åä¸èƒ½ç‚ºç©ºï¼');
    const existing = await db.presetCategories.where('name').equals(name).first();
    if (existing) return alert(`åˆ†é¡ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼`);
    await db.presetCategories.add({ name });
    input.value = '';
    await renderPresetCategoriesInManager();
}

async function deletePresetCategory(categoryId) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'åˆªé™¤åˆ†é¡å¾Œï¼Œè©²åˆ†é¡ä¸‹çš„æ‰€æœ‰é è¨­å°‡è®Šç‚ºâ€œæœªåˆ†é¡â€ã€‚ç¢ºå®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.presetCategories.delete(categoryId);
        await db.presets.where('categoryId').equals(categoryId).modify({ categoryId: null });
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡ä¹ŸåŒæ¨£å¾è³‡æ–™åº«é‡æ–°è¼‰å…¥æœ€æ–°çš„é è¨­åˆ—è¡¨ â–¼â–¼â–¼
        state.presets = await db.presets.toArray();
        // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

        await renderPresetCategoriesInManager();
    }
}
// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å°å…¥ Tavern é è¨­åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘ç•¶ç”¨æˆ¶é¸æ“‡äº†é è¨­æª”å¾Œï¼Œç”±æ­¤å‡½æ•¸é–‹å§‹è™•ç†
 * @param {Event} event - æª”è¼¸å…¥æ¡†çš„ change äº‹ä»¶
 */
async function handlePresetImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        if (!file.name.endsWith('.json')) {
            throw new Error("æª”æ¡ˆæ ¼å¼ä¸æ”¯æŒã€‚è«‹é¸æ“‡ .json æ ¼å¼çš„ Tavern é è¨­æª”ã€‚");
        }
        
        const text = await file.text();
        const tavernData = JSON.parse(text);
        
        // èª¿ç”¨æ ¸å¿ƒè™•ç†å‡½æ•¸
        await importTavernPresetFile(tavernData, file.name);

    } catch (error) {
        console.error("é è¨­å°å…¥å¤±æ•—:", error);
        await showCustomAlert("å°å…¥å¤±æ•—", `ç„¡æ³•è§£æé è¨­æª”ã€‚\néŒ¯èª¤: ${error.message}`);
    } finally {
        // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æª”
        event.target.value = null;
    }
}

        /**
         * ã€V3.0 | æ’åºçµ‚æ¥µä¿®å¾©ç‰ˆã€‘å¾ Tavern AI æ ¼å¼çš„è³‡æ–™å‰µå»ºä¸€æœ¬æ–°çš„â€œé è¨­â€
         * @param {object} tavernData - å¾ .json æª”è§£æå‡ºçš„è³‡æ–™
         * @param {string} fileName - åŸå§‹æª”æ¡ˆåï¼Œç”¨æ–¼ç”Ÿæˆé»˜èªåç¨±
         */
        async function importTavernPresetFile(tavernData, fileName) {
            let newEntries = [];

            // â–¼â–¼â–¼ ä¿®å¾©ä»£ç¢¼å¾é€™è£¡é–‹å§‹ â–¼â–¼â–¼

            // ç­–ç•¥1ï¼šå„ªå…ˆè™•ç†æ¨™æº–çš„ã€å¸¶æœ‰ `prompt_order` æ’åºåˆ—è¡¨çš„ Tavern/SillyTavern é è¨­æ ¼å¼
            if (Array.isArray(tavernData.prompts) && Array.isArray(tavernData.prompt_order) && tavernData.prompt_order.length > 0) {
                console.log("æª¢æ¸¬åˆ° Tavern/SillyTavern é è¨­æ ¼å¼ï¼Œå°‡åš´æ ¼æŒ‰ç…§ prompt_order æ’åºã€‚");

                // å‰µå»ºä¸€å€‹æŸ¥æ‰¾æ˜ å°„è¡¨ï¼Œä»¥ä¾¿é€šé identifier å¿«é€Ÿæ‰¾åˆ° prompt çš„è©³ç´°è³‡æ–™
                const promptsMap = new Map(tavernData.prompts.map(p => [p.identifier, p]));

                // è‡ªå‹•é¸æ“‡æœ€é•·çš„é‚£å€‹æ’åºåˆ—è¡¨ï¼Œé€™é€šå¸¸æ˜¯ç”¨æˆ¶è‡ªè¨‚çš„é‚£å€‹
                const orderArray = tavernData.prompt_order.reduce((acc, curr) => (
                    (curr.order && curr.order.length > (acc.length || 0)) ? curr.order : acc
                ), []);

                if (orderArray && orderArray.length > 0) {
                    newEntries = orderArray
                        .map(orderItem => {
                            // æ ¹æ“šæ’åºæ¸…å–®ä¸­çš„ identifierï¼Œå¾æ˜ å°„è¡¨ä¸­æ‰¾åˆ°å°æ‡‰çš„ prompt è³‡æ–™
                            const promptData = promptsMap.get(orderItem.identifier);
                            if (promptData) {
                                // æŒ‰ç…§æˆ‘å€‘çš„æ ¼å¼é‡æ–°çµ„ç¹”è³‡æ–™
                                return {
                                    keys: [], // Tavern é è¨­ä¸­æ²’æœ‰ keys æ¬„ä½
                                    comment: promptData.name || 'ç„¡æ¨™é¡Œ',
                                    content: promptData.content || '',
                                    // ã€æ ¸å¿ƒã€‘åŒæ­¥å•Ÿç”¨/ç¦ç”¨ç‹€æ…‹
                                    enabled: orderItem.enabled 
                                };
                            }
                            return null;
                        })
                        .filter(Boolean); // éæ¿¾æ‰å¯èƒ½å­˜åœ¨çš„ç„¡æ•ˆæ¢ç›®
                }
            }
            // ç­–ç•¥2ï¼šç›¸å®¹èˆŠçš„ã€é¡ä¼¼ä¸–ç•Œæ›¸çš„ "entries" å’Œ "order" æ ¼å¼
            else if (tavernData.entries && typeof tavernData.entries === 'object') {
                console.log("æª¢æ¸¬åˆ° 'entries' ç‰©ä»¶æ ¼å¼çš„é è¨­ï¼Œå°‡å˜—è©¦æŒ‰é †åºå°å…¥ã€‚");
                if (Array.isArray(tavernData.order)) {
                    console.log("æª¢æ¸¬åˆ° 'order' æ¬„ä½ï¼Œå°‡æŒ‰æŒ‡å®šé †åºå°å…¥æ¢ç›®ã€‚");
                    newEntries = tavernData.order
                        .map(key => tavernData.entries[key])
                        .filter(Boolean)
                        .map(entry => ({
                            keys: entry.key || [],
                            comment: entry.comment || 'ç„¡å‚™è¨»',
                            content: entry.content || '',
                            enabled: !entry.disable // Tavern çš„ disable å’Œæˆ‘å€‘çš„ enabled é‚è¼¯ç›¸å
                        }));
                } else {
                    console.warn("æœªåœ¨æª”ä¸­æ‰¾åˆ° 'order' æ¬„ä½ï¼Œæ¢ç›®å¯èƒ½ç„¡æ³•æŒ‰åŸå§‹é †åºå°å…¥ã€‚");
                    newEntries = Object.values(tavernData.entries).map(entry => ({
                        keys: entry.key || [],
                        comment: entry.comment || 'ç„¡å‚™è¨»',
                        content: entry.content || '',
                        enabled: !entry.disable
                    }));
                }
            }
            // ç­–ç•¥3ï¼šç›¸å®¹æœ€ç°¡å–®çš„ã€åªåŒ…å« "prompts" é™£åˆ—çš„æ ¼å¼
            else if (Array.isArray(tavernData.prompts)) {
                console.log("æª¢æ¸¬åˆ°ç°¡å–®çš„ 'prompts' é™£åˆ—æ ¼å¼ï¼Œå°‡æŒ‰é™£åˆ—å…§é †åºå°å…¥ã€‚");
                newEntries = tavernData.prompts.map(prompt => ({
                    keys: [],
                    comment: prompt.name || 'ç„¡æ¨™é¡Œ',
                    content: prompt.content || '',
                    enabled: true // é»˜èªå•Ÿç”¨
                }));
            }
            // ç­–ç•¥4ï¼šå¦‚æœæ‰€æœ‰æ ¼å¼éƒ½ä¸åŒ¹é…ï¼Œå‰‡å ±éŒ¯
            else {
                throw new Error("æª”æ¡ˆæ ¼å¼ç„¡æ³•è­˜åˆ¥ã€‚æœªæ‰¾åˆ°æœ‰æ•ˆçš„ 'prompts' é™£åˆ—æˆ– 'entries' å°è±¡ã€‚");
            }
            // â–²â–²â–² ä¿®å¾©ä»£ç¢¼åˆ°é€™è£¡çµæŸ â–²â–²â–²

            // éæ¿¾æ‰æ²’æœ‰å…§å®¹çš„ç©ºæ¢ç›®
            newEntries = newEntries.filter(entry => entry.content);

            if (newEntries.length === 0) {
                alert("é€™å€‹é è¨­æª”ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„æç¤ºè©æ¢ç›®ã€‚");
                return;
            }

            // ï¼ˆå¾ŒçºŒçš„å‘½åã€ä¿å­˜å’Œåˆ·æ–°é‚è¼¯ä¿æŒä¸è®Šï¼‰
            const presetNameSuggestion = fileName.replace(/\.json$/i, '');
            const newPresetName = await showCustomPrompt("å°å…¥ Tavern é è¨­", "è«‹ç‚ºé€™çµ„æç¤ºè©é è¨­å‘½åï¼š", presetNameSuggestion);
            if (!newPresetName || !newPresetName.trim()) {
                alert("å°å…¥å·²å–æ¶ˆï¼Œå› ç‚ºæœªæä¾›åç¨±ã€‚");
                return;
            }

            const newPreset = {
                id: 'preset_' + Date.now(),
                name: newPresetName.trim(),
                content: newEntries,
                categoryId: null
            };

            await db.presets.add(newPreset);
            state.presets.push(newPreset);

            await renderPresetScreen();
            await showCustomAlert('å°å…¥æˆåŠŸï¼', `å·²æˆåŠŸå¾æª”å°å…¥é è¨­ã€Š${newPresetName}ã€‹ã€‚`);
        }

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è«‹å°‡é€™å€‹å‡½æ•¸é»è²¼åˆ°JSåŠŸèƒ½å‡½å¼å®šç¾©å€ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åœ¨èŠå¤©è¨­ç½®ä¸­æ¸²æŸ“ç·šä¸‹æ¨¡å¼çš„æ–‡é¢¨é è¨­é¸æ“‡å™¨
 * @param {object} chat - ç•¶å‰çš„èŠå¤©ç‰©ä»¶
 */
async function renderOfflinePresetSelector(chat) {
    const selectEl = document.getElementById('offline-preset-select');
    if (!selectEl) return;

    // 1. ç›´æ¥å¾ state ç·©å­˜ä¸­ç²å–é è¨­ï¼Œç„¡éœ€å†æŸ¥è³‡æ–™åº«
    const presets = state.presets || [];
    
    // 2. æ¸…ç©ºä¸¦å¡«å……ä¸‹æ‹‰æ¸…å–®
    selectEl.innerHTML = '<option value="">-- ä¸ä½¿ç”¨é è¨­ --</option>';
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selectEl.appendChild(option);
    });

    // 3. è¨­ç½®ç•¶å‰é¸ä¸­çš„å€¼
    if (chat.settings.offlinePresetId) {
        selectEl.value = chat.settings.offlinePresetId;
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V2.0 ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ renderButtonOrderEditor å‡½æ•¸ â–¼â–¼â–¼
/**
 * æ¸²æŸ“æŒ‰éˆ•æ’åºçš„è¨­ç½®ä»‹é¢ (V2.0 - ä½¿ç”¨å¸¸é‡ä½œç‚ºé è¨­å€¼)
 */
function renderButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    editor.innerHTML = '';

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
    // å„ªå…ˆä½¿ç”¨ä½¿ç”¨è€…ä¿å­˜çš„é †åºï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå‰‡ç›´æ¥ä½¿ç”¨æˆ‘å€‘å®šç¾©çš„é è¨­é †åºå¸¸é‡
    let buttonOrder = state.globalSettings.chatActionButtonsOrder || DEFAULT_BUTTON_ORDER;
    
    buttonOrder.forEach(buttonId => {
        const originalButton = document.getElementById(buttonId);
        if (originalButton) {
            const item = document.createElement('div');
            item.className = 'draggable-button-item';
            item.draggable = true;
            item.dataset.buttonId = buttonId;
            item.innerHTML = originalButton.innerHTML; 
            editor.appendChild(item);
        }
    });
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆ | ç›¸å®¹ç§»å‹•ç«¯è§¸æ‘¸ã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ initializeButtonOrderEditor å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€V2.0 | ç§»å‹•ç«¯ç›¸å®¹ç‰ˆã€‘åˆå§‹åŒ–æŒ‰éˆ•æ’åºç·¨è¼¯å™¨çš„æ‹–æ”¾äº‹ä»¶
 */
function initializeButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    let draggingItem = null; // ç”¨æ–¼å­˜å„²ç•¶å‰æ­£åœ¨è¢«æ‹–å‹•çš„å…ƒç´ 

    // çµ±ä¸€çš„äº‹ä»¶è™•ç†å‡½æ•¸
    const handleDragStart = (e) => {
        const target = e.target.closest('.draggable-button-item');
        if (!target) return;
        
        draggingItem = target;
        draggingItem.classList.add('dragging');

        // é˜»æ­¢é è¨­è¡Œç‚ºï¼Œç‰¹åˆ¥æ˜¯åœ¨è§¸æ‘¸è¨­å‚™ä¸Šé˜²æ­¢é é¢æ»¾å‹•
        if (e.cancelable) e.preventDefault();
    };

    const handleDragMove = (e) => {
        if (!draggingItem) return;

        // çµ±ä¸€ç²å–åº§æ¨™
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        
        const afterElement = getDragAfterElement(editor, clientX);
        
        if (afterElement == null) {
            editor.appendChild(draggingItem);
        } else {
            editor.insertBefore(draggingItem, afterElement);
        }
    };

    const handleDragEnd = () => {
        if (!draggingItem) return;

        draggingItem.classList.remove('dragging');
        draggingItem = null;
        
        // æ‹–å‹•çµæŸå¾Œï¼Œä¿å­˜æ–°çš„é †åº
        saveButtonOrder();
    };

    // --- ç¶å®šäº‹ä»¶ ---
    // ä½¿ç”¨ mousedown å’Œ touchstart ä¾†é–‹å§‹æ‹–å‹•
    editor.addEventListener('mousedown', handleDragStart);
    editor.addEventListener('touchstart', handleDragStart, { passive: false });

    // ä½¿ç”¨ mousemove å’Œ touchmove ä¾†è™•ç†æ‹–å‹•éç¨‹
    editor.addEventListener('mousemove', handleDragMove);
    editor.addEventListener('touchmove', handleDragMove, { passive: false });

    // ä½¿ç”¨ mouseup, mouseleave å’Œ touchend ä¾†çµæŸæ‹–å‹•
    editor.addEventListener('mouseup', handleDragEnd);
    editor.addEventListener('mouseleave', handleDragEnd); // é˜²æ­¢æ»‘é¼ ç§»å‡ºå€åŸŸæ™‚å¡ä½
    editor.addEventListener('touchend', handleDragEnd);
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ getDragAfterElement â–¼â–¼â–¼
/**
 * ã€V2.0 | æ°´æº–ä¿®å¾©ç‰ˆã€‘è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—æ‹–å‹•å…ƒç´ æ‡‰è©²æ’å…¥åˆ°å“ªå€‹å…ƒç´ å‰é¢
 * @param {HTMLElement} container - æ‹–æ”¾å€åŸŸçš„å®¹å™¨
 * @param {number} x - æ»‘é¼ ç•¶å‰çš„æ°´æº– (X) åº§æ¨™
 * @returns {HTMLElement|null} - æ‡‰è©²è¢«æ’å…¥åˆ°å…¶å‰é¢çš„é‚£å€‹å…ƒç´ 
 */
function getDragAfterElement(container, x) {
    // 1. ç²å–å®¹å™¨å…§æ‰€æœ‰å¯æ‹–æ‹½çš„ã€ä½†ä¸æ˜¯æ­£åœ¨è¢«æ‹–æ‹½çš„å…ƒç´ 
    const draggableElements = [...container.querySelectorAll('.draggable-button-item:not(.dragging)')];

    // 2. ä½¿ç”¨ reduce æ–¹æ³•ä¾†æ‰¾åˆ°æœ€æ¥è¿‘çš„é‚£å€‹å…ƒç´ 
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘è¨ˆç®—æ»‘é¼  X åº§æ¨™åˆ°å…ƒç´ ä¸­å¿ƒçš„æ°´æº–è·é›¢
        const offset = x - box.left - box.width / 2;
        
        // 4. æˆ‘å€‘è¦æ‰¾çš„æ˜¯ï¼šæ»‘é¼ åœ¨å®ƒå·¦é‚Š (offset < 0)ï¼Œä¸¦ä¸”æ˜¯æ‰€æœ‰æ»¿è¶³æ¢ä»¶è£¡æœ€æ¥è¿‘çš„é‚£å€‹ (offset > closest.offset)
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ä¿å­˜ä½¿ç”¨è€…è‡ªè¨‚çš„æŒ‰éˆ•é †åºåˆ°è³‡æ–™åº«
 */
async function saveButtonOrder() {
    const editor = document.getElementById('button-order-editor');
    const newOrder = Array.from(editor.querySelectorAll('.draggable-button-item')).map(item => item.dataset.buttonId);
    
    state.globalSettings.chatActionButtonsOrder = newOrder;
    await db.globalSettings.put(state.globalSettings);

    // (å¯é¸) çµ¦ç”¨æˆ¶ä¸€å€‹ä¿å­˜æˆåŠŸçš„æç¤º
    // console.log("æŒ‰éˆ•é †åºå·²ä¿å­˜:", newOrder);
}

/**
 * ã€æ ¸å¿ƒã€‘æ ¹æ“šå·²ä¿å­˜çš„é †åºï¼Œé‡æ–°æ’åˆ—èŠå¤©ä»‹é¢åº•éƒ¨çš„æŒ‰éˆ•
 */
function applyButtonOrder() {
    const buttonOrder = state.globalSettings.chatActionButtonsOrder;
    if (!buttonOrder || !Array.isArray(buttonOrder) || buttonOrder.length === 0) {
        return; // å¦‚æœæ²’æœ‰ä¿å­˜çš„é †åºï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
    }

    const container = document.getElementById('chat-input-actions-top');
    if (!container) return;

    // æŒ‰ç…§ä¿å­˜çš„é †åºï¼Œä¾æ¬¡å°‡æŒ‰éˆ•é‡æ–°è¿½åŠ åˆ°å®¹å™¨æœ«å°¾
    buttonOrder.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
            container.appendChild(button);
        }
    });
}

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å®šç¾©é è¨­çš„æŒ‰éˆ•é †åºå¸¸é‡ â–¼â–¼â–¼
const DEFAULT_BUTTON_ORDER = [
    'open-sticker-panel-btn', 'send-photo-btn', 'upload-image-btn', 
    'transfer-btn', 'voice-message-btn', 'send-waimai-request-btn', 
    'video-call-btn', 'group-video-call-btn', 'send-poll-btn', 
    'share-link-btn', 'share-location-btn', 'gomoku-btn', 
    'open-shopping-btn', 'pat-btn', 'edit-last-response-btn', 
    'regenerate-btn', 'propel-btn', 'show-announcement-board-btn',
'werewolf-game-btn',
    // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°æŒ‰éˆ•ID â–¼â–¼â–¼
    'read-together-btn'
];
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é‡æ–°é–‹æ©ŸæŒ‰éˆ•é †åºçš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ â–¼â–¼â–¼
async function resetButtonOrder() {
    // 1. åœ¨ä½¿ç”¨è€…çš„å…¨åŸŸè¨­ç½®ä¸­ï¼Œå°‡è‡ªè¨‚é †åºæ¸…é™¤ (è¨­ç‚º null)
    state.globalSettings.chatActionButtonsOrder = null;
    await db.globalSettings.put(state.globalSettings);

    // 2. é‡æ–°æ¸²æŸ“æ’åºç·¨è¼¯å™¨ï¼Œå®ƒæœƒè‡ªå‹•æ¢å¾©åˆ°é è¨­é †åº
    renderButtonOrderEditor();

    // 3. æ‡‰ç”¨é è¨­é †åºåˆ°çœŸå¯¦çš„èŠå¤©ä»‹é¢
    applyButtonOrder();

    // 4. çµ¦ç”¨æˆ¶ä¸€å€‹æˆåŠŸçš„æç¤º
    await showCustomAlert("æˆåŠŸ", "æŒ‰éˆ•é †åºå·²æ¢å¾©ç‚ºé è¨­è¨­ç½®ï¼");
}
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–° V2.0 | å·²ä¿®å¾©ã€‘é€™æ˜¯é«˜ç´šè³‡æ–™æ¸…ç†åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

let selectedCharsForClear = []; // ç”¨æ–¼å­˜å„²ç¬¬ä¸€æ­¥é¸æ“‡çš„è§’è‰²ID
let selectedTypesForClear = []; // ç”¨æ–¼å­˜å„²ç¬¬äºŒæ­¥é¸æ“‡çš„è³‡æ–™é¡å‹

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹é«˜ç´šè³‡æ–™æ¸…ç†åš®å°
 */
function openDataClearWizard() {
    const modal = document.getElementById('data-clear-wizard-modal');
    selectedCharsForClear = [];
    selectedTypesForClear = [];
    
    // æ¸²æŸ“ç¬¬ä¸€æ­¥
    renderClearWizardStep1();
    
    // é¡¯ç¤ºç¬¬ä¸€æ­¥ï¼Œéš±è—ç¬¬äºŒæ­¥
    document.getElementById('data-clear-step-1').style.display = 'flex';
    document.getElementById('data-clear-step-2').style.display = 'none';
    
    modal.classList.add('visible');
}

/**
 * æ¸²æŸ“åš®å°çš„ç¬¬ä¸€æ­¥ï¼šè§’è‰²é¸æ“‡åˆ—è¡¨
 */
function renderClearWizardStep1() {
    const listEl = document.getElementById('data-clear-char-list');
    listEl.innerHTML = '';

    // 1. æ·»åŠ â€œæˆ‘è‡ªå·±â€çš„é¸é …
    const userItem = document.createElement('div');
    userItem.className = 'clear-posts-item';
    userItem.dataset.charId = 'user';
    userItem.innerHTML = `
        <div class="checkbox"></div>
        <span class="name">${state.qzoneSettings.nickname || 'æˆ‘'} (ç”¨æˆ¶)</span>
    `;
    listEl.appendChild(userItem);

    // 2. æ·»åŠ æ‰€æœ‰AIè§’è‰²çš„é¸é …
    Object.values(state.chats).forEach(chat => {
        if (!chat.isGroup) {
            const charItem = document.createElement('div');
            charItem.className = 'clear-posts-item';
            charItem.dataset.charId = chat.id;
            charItem.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${chat.name} (è§’è‰²)</span>
            `;
            listEl.appendChild(charItem);
        }
    });
}

/**
 * ã€V2.0 | å·²ä¿®æ­£è³‡æ–™åˆ†é¡ã€‘æ¸²æŸ“åš®å°çš„ç¬¬äºŒæ­¥ï¼šè³‡æ–™é¡å‹é¸æ“‡åˆ—è¡¨
 */
function renderClearWizardStep2() {
    const listEl = document.getElementById('data-clear-type-list');
    listEl.innerHTML = '';
    
    const dataTypes = [
        { id: 'chat', name: 'èŠå¤©è¨˜éŒ„', description: 'å°‡æ¸…ç©ºé¸å®šè§’è‰²çš„æ‰€æœ‰å°è©±æ¶ˆæ¯ã€‚' },
        { id: 'qzone', name: 'å‹•æ…‹èˆ‡äº’å‹•', description: 'å°‡æ¸…ç©ºé¸å®šè§’è‰²çš„æ‰€æœ‰å‹•æ…‹ã€è©•è«–å’Œé»è´Šã€‚' },
        { id: 'calls', name: 'é€šè©±è¨˜éŒ„', description: 'å°‡æ¸…ç©ºé¸å®šè§’è‰²çš„æ‰€æœ‰é€šè©±è¨˜éŒ„ã€‚' },
        // ã€ã€ã€æ ¸å¿ƒä¿®æ­£1ï¼šè³‡æ–™åˆ†é¡ã€‘ã€‘ã€‘
        { id: 'thoughts', name: 'å¿ƒè²', description: 'å°‡æ¸…ç©ºé¸å®šè§’è‰²çš„å¿ƒè²å’Œæ•£è¨˜æ­·å²ã€‚' },
        { id: 'memories', name: 'é•·æœŸè¨˜æ†¶', description: 'å°‡æ¸…ç©ºé¸å®šè§’è‰²çš„æ‰€æœ‰é•·æœŸè¨˜æ†¶ã€‚' },
        { id: 'cphone', name: 'Cphoneæ•¸æ“š (CPhone)', description: 'å°‡æ¸…ç©ºè§’è‰²çš„ç›¸å†Šã€QQã€æµè¦½å™¨ã€æ·˜å¯¶ã€æ—¥è¨˜ã€å‚™å¿˜éŒ„ç­‰æ‰€æœ‰é¡æ¯”æ‰‹æ©Ÿè³‡æ–™ã€‚' }
    ];

    dataTypes.forEach(type => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item';
        item.dataset.typeId = type.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <div>
                <span class="name">${type.name}</span>
                <p style="font-size: 12px; color: #888; margin: 4px 0 0;">${type.description}</p>
            </div>
        `;
        listEl.appendChild(item);
    });
}


/**
 * è™•ç†â€œä¸‹ä¸€æ­¥â€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
 */
function handleDataClearNext() {
    const selectedItems = document.querySelectorAll('#data-clear-char-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦æ¸…ç†çš„è§’è‰²ã€‚");
        return;
    }

    selectedCharsForClear = Array.from(selectedItems).map(item => item.dataset.charId);
    
    // æ¸²æŸ“ç¬¬äºŒæ­¥ä¸¦åˆ‡æ›è¦–åœ–
    renderClearWizardStep2();
    document.getElementById('data-clear-step-1').style.display = 'none';
    document.getElementById('data-clear-step-2').style.display = 'flex';
}

/**
 * è™•ç†â€œä¸Šä¸€æ­¥â€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
 */
function handleDataClearBack() {
    document.getElementById('data-clear-step-2').style.display = 'none';
    document.getElementById('data-clear-step-1').style.display = 'flex';
    // ä¿ç•™å·²é¸ä¸­çš„è§’è‰²
    document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
        if (selectedCharsForClear.includes(item.dataset.charId)) {
            item.classList.add('selected');
        }
    });
}

/**
 * ã€V2.0 | å·²ä¿®æ­£è³‡æ–™åˆ†é¡ã€‘è™•ç†æœ€çµ‚ç¢ºèªæ¸…ç†çš„é‚è¼¯
 */
async function handleConfirmDataClear() {
    const selectedItems = document.querySelectorAll('#data-clear-type-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®è¦æ¸…ç†çš„è³‡æ–™é¡å‹ã€‚");
        return;
    }

    selectedTypesForClear = Array.from(selectedItems).map(item => item.dataset.typeId);

    const confirmed = await showCustomConfirm(
        'æœ€å¾Œç¢ºèªï¼',
        'æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‚¨é¸æ“‡çš„æ‰€æœ‰è³‡æ–™ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªåˆªé™¤' }
    );

    if (!confirmed) return;
    
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨åŸ·è¡Œæ¸…ç†æ“ä½œï¼Œè«‹ä¸è¦é—œé–‰é é¢...");

    try {
        await db.transaction('rw', db.tables, async () => {
            for (const charId of selectedCharsForClear) {
                for (const type of selectedTypesForClear) {
                    
                    if (type === 'chat') {
                        if (charId === 'user') {
                            const allChats = await db.chats.toArray();
                            for (const chat of allChats) {
                                chat.history = chat.history.filter(msg => msg.role !== 'user');
                                await db.chats.put(chat);
                            }
                        } else {
                            const chat = await db.chats.get(charId);
                            if (chat) {
                                chat.history = [];
                                await db.chats.put(chat);
                            }
                        }
                    }

                    if (type === 'qzone') {
                        const authorId = (charId === 'user') ? 'user' : charId;
                        await db.qzonePosts.where('authorId').equals(authorId).delete();
                    }

                    if (type === 'calls' && charId !== 'user') {
                        await db.callRecords.where('chatId').equals(charId).delete();
                    }

                    // ã€ã€ã€æ ¸å¿ƒä¿®æ­£2ï¼šæ¸…ç†é‚è¼¯ã€‘ã€‘ã€‘
                    if (type === 'thoughts' && charId !== 'user') {
                        const chat = await db.chats.get(charId);
                        if (chat) {
                            chat.thoughtsHistory = [];
                            // ä¸å†æ¸…ç†æ—¥è¨˜å’Œå‚™å¿˜éŒ„
                            await db.chats.put(chat);
                        }
                    }

                    if (type === 'memories' && charId !== 'user') {
                        const chat = await db.chats.get(charId);
                        if (chat) {
                            chat.longTermMemory = [];
                            await db.chats.put(chat);
                        }
                    }
                    
                    if (type === 'cphone' && charId !== 'user') {
                        const chat = await db.chats.get(charId);
                        if (chat) {
                            // æ¸…ç†æ‰€æœ‰CPhoneç›¸é—œè³‡æ–™ï¼Œä¸¦åŠ å…¥æ—¥è¨˜å’Œå‚™å¿˜éŒ„
                            chat.simulatedAlbum = [];
                            chat.simulatedConversations = [];
                            chat.simulatedBrowserHistory = [];
                            chat.simulatedTaobaoHistory = null;
                            chat.simulatedAmapHistory = [];
                            chat.simulatedAppUsage = [];
                            chat.simulatedMusicPlaylist = [];
                            chat.diary = []; // <-- æ–°å¢
                            chat.memos = []; // <-- æ–°å¢
                            await db.chats.put(chat);
                        }
                    }
                }
            }
        });
        
        await loadAllDataFromDB();
        await renderChatList();
        
        document.getElementById('data-clear-wizard-modal').classList.remove('visible');
        await showCustomAlert("æ¸…ç†å®Œæˆ", "æŒ‡å®šçš„è³‡æ–™å·²æˆåŠŸæ¸…é™¤ã€‚");

    } catch (error) {
        console.error("é«˜ç´šè³‡æ–™æ¸…ç†å¤±æ•—:", error);
        await showCustomAlert("æ¸…ç†å¤±æ•—", `æ“ä½œå¤±æ•—: ${error.message}`);
    }
}
// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        /**
         * ã€å…¨æ–° V2.0 | æ”¯æ´æœ¬åœ°ä¸Šå‚³ã€‘è™•ç†æ›´æ›åœ–ç¤ºçš„é‚è¼¯ (EPhone & CPhoneé€šç”¨)
         * @param {string} iconId - è¢«é»æ“Šåœ–ç¤ºçš„ID (ä¾‹å¦‚ 'qq', 'album')
         * @param {string} phoneType - 'ephone' æˆ– 'cphone'
         * @param {HTMLElement} itemElement - è¢«é»æ“Šçš„é‚£å€‹åœ–ç¤ºè¨­ç½®é …çš„DOMå…ƒç´ 
         */
        async function handleIconChange(iconId, phoneType, itemElement) {
            const appName = itemElement.querySelector('.icon-preview').alt;
        
            // 1. å½ˆå‡ºé¸æ“‡æ¡†ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡ä¸Šå‚³æ–¹å¼
            const choice = await showChoiceModal(`æ›´æ›â€œ${appName}â€åœ–ç¤º`, [
                { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
                { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
            ]);
        
            let newUrl = null;
        
            // 2. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡åŸ·è¡Œä¸åŒæ“ä½œ
            if (choice === 'local') {
                // èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„æœ¬åœ°ä¸Šå‚³è¼”åŠ©å‡½æ•¸
                newUrl = await uploadImageLocally();
            } else if (choice === 'url') {
                const currentUrl = (phoneType === 'cphone')
                    ? state.globalSettings.cphoneAppIcons[iconId]
                    : state.globalSettings.appIcons[iconId];

                // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
                // 1. åˆ¤æ–·ç•¶å‰çš„URLæ˜¯ä¸æ˜¯ä¸€å€‹Base64å­—ä¸²
                const isBase64 = currentUrl.startsWith('data:image');

                // 2. å¦‚æœæ˜¯Base64ï¼Œæˆ‘å€‘å°±å‚³ä¸€å€‹ç©ºå­—ä¸²ä½œç‚ºé è¨­å€¼ï¼Œé¿å…å¡æ­»ã€‚
                //    å¦‚æœä¸æ˜¯ï¼Œå°±æ­£å¸¸é¡¯ç¤ºç•¶å‰çš„URLï¼Œæ–¹ä¾¿ç”¨æˆ¶ä¿®æ”¹ã€‚
                const initialValueForPrompt = isBase64 ? '' : currentUrl;
                // â˜…â˜…â˜…â˜…â˜… ä¿®å¾©çµæŸ â˜…â˜…â˜…â˜…â˜…

                // 3. ä½¿ç”¨æˆ‘å€‘æ–°è™•ç†éçš„å€¼ä¾†èª¿ç”¨å½ˆçª—
                newUrl = await showCustomPrompt(
                    `æ›´æ›åœ–ç¤º`, 
                    'è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URL', 
                    initialValueForPrompt, // <-- ä½¿ç”¨é€™å€‹æ–°è®Šæ•¸
                    'url'
                );
            }
        
            // 3. å¦‚æœç²å–åˆ°äº†æ–°å€¼ï¼ˆç„¡è«–æ˜¯Base64é‚„æ˜¯URLï¼‰ï¼Œå°±æ›´æ–°ä¸¦ä¿å­˜
            if (newUrl && newUrl.trim()) {
                const trimmedUrl = newUrl.trim();
                
                // æ ¹æ“šæ‰‹æ©Ÿé¡å‹ï¼Œæ›´æ–° state ä¸­å°æ‡‰çš„è³‡æ–™
                if (phoneType === 'cphone') {
                    state.globalSettings.cphoneAppIcons[iconId] = trimmedUrl;
                } else {
                    state.globalSettings.appIcons[iconId] = trimmedUrl;
                }
                
                // å³æ™‚æ›´æ–°è¨­ç½®é é¢çš„é è¦½åœ–
                itemElement.querySelector('.icon-preview').src = trimmedUrl;
                
                // ç„¡éœ€åœ¨é€™è£¡ä¿å­˜åˆ°è³‡æ–™åº«ï¼Œç­‰å¾…ä½¿ç”¨è€…é»æ“Šâ€œä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®â€æŒ‰éˆ•æ™‚çµ±ä¸€ä¿å­˜ã€‚
            } else if (newUrl !== null) {
                // å¦‚æœç”¨æˆ¶è¼¸å…¥äº†ç„¡æ•ˆçš„URL
                alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„URLæˆ–é¸æ“‡ä¸€å€‹æª”ï¼");
            }
        }
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€åˆ†æ­¥åŸ·è¡Œçš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ compressAllLocalImages â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ | V2.0 ä¿®å¾©ç‰ˆã€‘ä¸€éµå£“ç¸®è³‡æ–™åº«ä¸­æ‰€æœ‰æœ¬åœ°ä¸Šå‚³çš„åœ–ç‰‡
 */
async function compressAllLocalImages() {
    // 1. å½ˆå‡ºæœ€çµ‚ç¢ºèªæ¡† (é‚è¼¯ä¸è®Š)
    const confirmed = await showCustomConfirm(
        'ç¢ºèªå£“ç¸®åœ–ç‰‡ï¼Ÿ',
        'æ­¤æ“ä½œå°‡æƒæä¸¦å£“ç¸®æ‰€æœ‰æœ¬åœ°ä¸Šå‚³çš„åœ–ç‰‡ï¼ˆBase64æ ¼å¼ï¼‰ï¼Œå°‡å…¶è½‰æ›ç‚ºJPEGä»¥æ¸›å°é«”ç©ã€‚é€™æœƒè¼•å¾®é™ä½åœ–ç‰‡å“è³ªä¸”ã€ä¸å¯æ¢å¾©ã€‘ã€‚<br><br><strong>å¼·çƒˆå»ºè­°åœ¨æ“ä½œå‰å…ˆé€²è¡Œè³‡æ–™å‚™ä»½ï¼</strong>',
        { confirmButtonClass: 'btn-danger', confirmText: 'æˆ‘å·²ç­è§£é¢¨éšªï¼Œç¢ºèªå£“ç¸®' }
    );

    if (!confirmed) return;

    // 2. é¡¯ç¤ºè™•ç†ä¸­çš„æç¤º (é‚è¼¯ä¸è®Š)
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨é–‹å§‹å…¨é¢å£“ç¸®åœ–ç‰‡ï¼Œæ ¹æ“šåœ–ç‰‡æ•¸é‡ï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ï¼Œè«‹ä¸è¦é—œé–‰æˆ–åˆ·æ–°é é¢...");

    let stats = {
        found: 0,
        compressed: 0,
        skipped: 0,
        originalSize: 0,
        newSize: 0
    };

    try {
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©é‚è¼¯å¾é€™è£¡é–‹å§‹ â˜…â˜…â˜…
        // ==========================================================
        
        // --- æ­¥é©Ÿ A: è®€å–æ‰€æœ‰ç›¸é—œè³‡æ–™åˆ°è¨˜æ†¶é«” ---
        console.log("å£“ç¸®æ­¥é©Ÿ 1/3: æ­£åœ¨å¾è³‡æ–™åº«è®€å–æ‰€æœ‰ç›¸é—œè³‡æ–™...");
        const tablesToScan = [
            'chats', 'globalSettings', 'qzoneSettings', 
            'userStickers', 'customAvatarFrames'
        ];
        const allData = [];
        for (const tableName of tablesToScan) {
            const table = db.table(tableName);
            const records = await table.toArray();
            allData.push({ tableName, records });
        }

        // --- æ­¥é©Ÿ B: åœ¨è¨˜æ†¶é«”ä¸­å°è³‡æ–™é€²è¡ŒéåŒæ­¥å£“ç¸® ---
        console.log("å£“ç¸®æ­¥é©Ÿ 2/3: æ­£åœ¨è¨˜æ†¶é«”ä¸­éåŒæ­¥å£“ç¸®åœ–ç‰‡ï¼Œé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“...");
        for (const data of allData) {
            for (const record of data.records) {
                // traverseAndCompress å‡½æ•¸ç¾åœ¨æ˜¯å®‰å…¨çš„ï¼Œå› ç‚ºå®ƒä¸å†è™•æ–¼ä¸€å€‹é–‹å•Ÿçš„äº‹å‹™ä¸­
                await traverseAndCompress(record, stats);
            }
        }
        
        // --- æ­¥é©Ÿ C: é–‹å•Ÿä¸€å€‹æ–°äº‹å‹™ï¼Œå°‡æ‰€æœ‰ä¿®æ”¹å¾Œçš„è³‡æ–™ä¸€æ¬¡æ€§å¯«å›è³‡æ–™åº« ---
        console.log("å£“ç¸®æ­¥é©Ÿ 3/3: æ­£åœ¨å°‡å£“ç¸®å¾Œçš„è³‡æ–™å¯«å›è³‡æ–™åº«...");
        await db.transaction('rw', tablesToScan, async () => {
            for (const data of allData) {
                // ä½¿ç”¨ bulkPut æ‰¹é‡æ›´æ–°ï¼Œæ€§èƒ½æ›´ä½³
                await db.table(data.tableName).bulkPut(data.records);
            }
        });
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©é‚è¼¯åˆ°æ­¤çµæŸ â˜…â˜…â˜…
        // ==========================================================

        // 4. æ“ä½œå®Œæˆå¾Œï¼Œé¡¯ç¤ºçµ±è¨ˆçµæœ (é‚è¼¯ä¸è®Š)
        const reduction = stats.originalSize - stats.newSize;
        const reductionPercent = stats.originalSize > 0 ? (reduction / stats.originalSize * 100).toFixed(2) : 0;

        await showCustomAlert(
            'å£“ç¸®å®Œæˆï¼',
            `æƒæå®Œæˆï¼<br>
            - å…±æ‰¾åˆ° ${stats.found} å¼µæœ¬åœ°åœ–ç‰‡<br>
            - æˆåŠŸå£“ç¸® ${stats.compressed} å¼µ<br>
            - è·³é(å·²å£“ç¸®æˆ–ç„¡éœ€å£“ç¸®) ${stats.skipped} å¼µ<br>
            - ç©ºé–“ç¯€çœäº† <strong>${(reduction / 1024 / 1024).toFixed(2)} MB</strong> (å£“ç¸®ç‡ ${reductionPercent}%)
            <br><br>
            å»ºè­°åˆ·æ–°é é¢ä»¥æ‡‰ç”¨æ‰€æœ‰æ›´æ”¹ã€‚`
        );

    } catch (error) {
        console.error("åœ–ç‰‡å£“ç¸®éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:", error);
        await showCustomAlert('å£“ç¸®å¤±æ•—', `æ“ä½œå¤±æ•—: ${error.message}`);
    }
}

// â–²â–²â–² JSå‡½æ•¸æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘éè¿´éæ­·ç‰©ä»¶ï¼Œæ‰¾åˆ°ä¸¦å£“ç¸®æ‰€æœ‰Base64åœ–ç‰‡
 * @param {object|Array} obj - è¦éæ­·çš„ç‰©ä»¶æˆ–é™£åˆ—
 * @param {object} stats - ç”¨æ–¼çµ±è¨ˆçš„ç‰©ä»¶
 */
async function traverseAndCompress(obj, stats) {
    for (const key in obj) {
        if (typeof obj[key] === 'string' && obj[key].startsWith('data:image')) {
            stats.found++;
            const originalBase64 = obj[key];
            stats.originalSize += originalBase64.length;

            const compressedBase64 = await compressImage(originalBase64);

            if (compressedBase64 && compressedBase64 !== originalBase64) {
                obj[key] = compressedBase64; // ç›´æ¥ä¿®æ”¹åŸç‰©ä»¶
                stats.compressed++;
                stats.newSize += compressedBase64.length;
            } else {
                stats.skipped++;
                stats.newSize += originalBase64.length;
            }
        } else if (typeof obj[key] === 'object' && obj[key] !== null) {
            // å¦‚æœæ˜¯åµŒå¥—ç‰©ä»¶æˆ–é™£åˆ—ï¼Œå‰‡ç¹¼çºŒéè¿´
            await traverseAndCompress(obj[key], stats);
        }
    }
}

/**
 * ã€æ ¸å¿ƒå£“ç¸®å‡½æ•¸ã€‘å°‡å–®å€‹Base64åœ–ç‰‡å­—ä¸²å£“ç¸®ç‚ºJPEGæ ¼å¼
 * @param {string} base64Str - åŸå§‹çš„Base64åœ–ç‰‡å­—ä¸²
 * @param {object} options - å£“ç¸®é¸é … (å“è³ªã€æœ€å¤§å¯¬åº¦)
 * @returns {Promise<string|null>} - è¿”å›å£“ç¸®å¾Œçš„Base64å­—ä¸²ï¼Œå¦‚æœç„¡éœ€å£“ç¸®æˆ–å¤±æ•—å‰‡è¿”å›åŸå­—ä¸²
 */
function compressImage(base64Str, options = {}) {
    return new Promise((resolve) => {
        // å¦‚æœå·²ç¶“æ˜¯JPEGï¼Œæˆ–è€…ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„åœ–ç‰‡å­—ä¸²ï¼Œå‰‡ç›´æ¥è·³é
        if (base64Str.startsWith('data:image/jpeg') || !base64Str.startsWith('data:image')) {
            resolve(base64Str);
            return;
        }

        const quality = options.quality || 0.7; // 70%çš„JPEGå“è³ª
        const maxWidth = options.maxWidth || 1024; // åœ–ç‰‡æœ€å¤§å¯¬åº¦é™åˆ¶ç‚º1024px

        const img = new Image();
        img.onload = () => {
            let width = img.width;
            let height = img.height;

            // å¦‚æœåœ–ç‰‡å¯¬åº¦è¶…éæœ€å¤§é™åˆ¶ï¼Œå‰‡ç­‰æ¯”ç¸®æ”¾
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // å°‡åœ–ç‰‡ç¹ªè£½åˆ°canvasä¸Š
            ctx.drawImage(img, 0, 0, width, height);
            
            // å¾canvasåŒ¯å‡ºç‚ºJPEGæ ¼å¼çš„Base64å­—ä¸²
            const newDataUrl = canvas.toDataURL('image/jpeg', quality);
            
            // åªæœ‰ç•¶å£“ç¸®å¾Œçš„é«”ç©æ¯”åŸä¾†å°æ™‚æ‰æ›¿æ›
            if (newDataUrl.length < base64Str.length) {
                resolve(newDataUrl);
            } else {
                resolve(base64Str); // å£“ç¸®å¾Œåè€Œè®Šå¤§äº†ï¼Œä¿ç•™åŸåœ–
            }
        };
        img.onerror = () => {
            console.warn("è¼‰å…¥åœ–ç‰‡å¤±æ•—ï¼Œè·³éå£“ç¸®:", base64Str.substring(0, 50) + "...");
            resolve(base64Str); // è¼‰å…¥å¤±æ•—ï¼Œä¿ç•™åŸåœ–
        };
        img.src = base64Str;
    });
}
// â–²â–²â–² JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ›´æ–°é€šçŸ¥åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * æª¢æŸ¥æ‡‰ç”¨æ›´æ–°ä¸¦æ ¹æ“šç‰ˆæœ¬æ±ºå®šæ˜¯å¦é¡¯ç¤ºé€šçŸ¥
 */
async function checkForUpdates() {
    // é—œéµ1ï¼šåœ¨ä½ çš„ä¸»æ‡‰ç”¨ä¸­å®šç¾©ç•¶å‰çš„ç‰ˆæœ¬è™Ÿã€‚
    // æ¯æ¬¡ä½ å¸Œæœ›ç”¨æˆ¶çœ‹åˆ°æ›´æ–°é€šçŸ¥æ™‚ï¼Œéƒ½éœ€è¦æ›´æ–° `update-notice.html` è£¡çš„ `data-version`ã€‚
    // é€™å€‹ç‰ˆæœ¬è™Ÿä¸»è¦æ˜¯ç‚ºäº†é‚è¼¯å®Œæ•´æ€§ï¼Œä½†æ ¸å¿ƒåˆ¤æ–·ä¾æ“šæ˜¯é€šçŸ¥æª”è£¡çš„ç‰ˆæœ¬ã€‚
    const CURRENT_APP_VERSION = "1.0"; 

    try {
        // 1. å¾ä¼ºæœå™¨ç²å–æœ€æ–°çš„é€šçŸ¥æª”å…§å®¹
        const response = await fetch('update-notice.html?_=' + Date.now()); // æ·»åŠ æ™‚é–“æˆ³è¨˜é˜²æ­¢ç·©å­˜
        if (!response.ok) {
            console.warn('ç²å–æ›´æ–°é€šçŸ¥æª”å¤±æ•—ã€‚');
            return;
        }
        const noticeHtml = await response.text();
        
        // 2. è§£æé€šçŸ¥å…§å®¹å’Œç‰ˆæœ¬è™Ÿ
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = noticeHtml;
        const noticeContent = tempDiv.querySelector('[data-version]');
        
        if (!noticeContent) {
            console.error('æ›´æ–°é€šçŸ¥æª”ä¸­ç¼ºå°‘ data-version å±¬æ€§ã€‚');
            return;
        }
        
        const notificationVersion = noticeContent.dataset.version;
        
        // 3. å¾æœ¬æ©Ÿå­˜æ”¾å€ä¸­ç²å–ç”¨æˆ¶ä¸Šæ¬¡å¿½ç•¥çš„ç‰ˆæœ¬è™Ÿ
        const dismissedVersion = localStorage.getItem('dismissedUpdateVersion');
        
        // 4. æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœé€šçŸ¥ç‰ˆæœ¬è™Ÿæ¯”ç”¨æˆ¶å¿½ç•¥çš„ç‰ˆæœ¬è™Ÿè¦æ–°ï¼Œå°±é¡¯ç¤ºé€šçŸ¥
        // ä½¿ç”¨ç°¡å–®çš„å­—ä¸²æ¯”è¼ƒå³å¯
        if (notificationVersion > dismissedVersion) {
            console.log(`ç™¼ç¾æ–°ç‰ˆæœ¬é€šçŸ¥: ${notificationVersion} (å·²å¿½ç•¥ç‰ˆæœ¬: ${dismissedVersion})`);
            showUpdateNotice(notificationVersion, noticeContent.innerHTML);
        } else {
            console.log(`ç•¶å‰é€šçŸ¥ç‰ˆæœ¬ (${notificationVersion}) å·²è¢«ä½¿ç”¨è€…å¿½ç•¥ï¼Œç„¡éœ€é¡¯ç¤ºã€‚`);
        }

    } catch (error) {
        console.error('æª¢æŸ¥æ›´æ–°æ™‚å‡ºéŒ¯:', error);
    }
}

/**
 * é¡¯ç¤ºæ›´æ–°é€šçŸ¥å½ˆçª—
 * @param {string} version - ç•¶å‰é€šçŸ¥çš„ç‰ˆæœ¬è™Ÿ
 * @param {string} contentHtml - è¦é¡¯ç¤ºçš„HTMLå…§å®¹
 */
function showUpdateNotice(version, contentHtml) {
    const modal = document.getElementById('update-notice-modal');
    const body = document.getElementById('update-notice-body');
    const confirmBtn = document.getElementById('update-notice-confirm-btn');
    const dismissBtn = document.getElementById('update-notice-dismiss-btn');
    
    body.innerHTML = contentHtml;
    
    // â€œæˆ‘çŸ¥é“äº†â€æŒ‰éˆ•ï¼šåªé—œé–‰å½ˆçª—ï¼Œä¸è¨˜éŒ„ç‰ˆæœ¬
    confirmBtn.onclick = () => {
        modal.classList.remove('visible');
    };
    
    // â€œä¸å†æç¤ºâ€æŒ‰éˆ•ï¼šé—œé–‰å½ˆçª—ï¼Œä¸¦å°‡ç•¶å‰ç‰ˆæœ¬è™Ÿå­˜å…¥localStorage
    dismissBtn.onclick = () => {
        localStorage.setItem('dismissedUpdateVersion', version);
        modal.classList.remove('visible');
        console.log(`ç”¨æˆ¶å·²å¿½ç•¥ç‰ˆæœ¬: ${version}`);
    };
    
    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è±†ç“£è¨­ç½®åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹è±†ç“£è¨­ç½®å½ˆçª—
 */
function openDoubanSettingsModal() {
    const modal = document.getElementById('douban-settings-modal');
    
    // å¾å…¨åŸŸè¨­ç½®ä¸­è®€å–å·²ä¿å­˜çš„å€¼ï¼Œå¦‚æœæ²’æœ‰å°±ä½¿ç”¨é è¨­å€¼
    document.getElementById('douban-min-posts-input').value = state.globalSettings.doubanMinPosts || 12;
    document.getElementById('douban-max-posts-input').value = state.globalSettings.doubanMaxPosts || 20;
    
    modal.classList.add('visible');
}

/**
 * ä¿å­˜è±†ç“£è¨­ç½®
 */
async function saveDoubanSettings() {
    const minInput = document.getElementById('douban-min-posts-input');
    const maxInput = document.getElementById('douban-max-posts-input');
    
    const min = parseInt(minInput.value);
    const max = parseInt(maxInput.value);

    // è³‡æ–™é©—è­‰
    if (isNaN(min) || isNaN(max) || min < 1 || max < 1) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸ï¼");
        return;
    }
    if (min > max) {
        alert("æœ€å°å¸–å­æ•¸ä¸èƒ½å¤§æ–¼æœ€å¤§å¸–å­æ•¸ï¼");
        return;
    }

    // ä¿å­˜åˆ°å…¨åŸŸç‹€æ…‹å’Œè³‡æ–™åº«
    state.globalSettings.doubanMinPosts = min;
    state.globalSettings.doubanMaxPosts = max;
    await db.globalSettings.put(state.globalSettings);

    // é—œé–‰å½ˆçª—ä¸¦æç¤ºç”¨æˆ¶
    document.getElementById('douban-settings-modal').classList.remove('visible');
    await showCustomAlert('ä¿å­˜æˆåŠŸ', 'è±†ç“£è¨­ç½®å·²æ›´æ–°ï¼ä¸‹æ¬¡é‡æ–°ç”Ÿæˆæ™‚å°‡ç”Ÿæ•ˆã€‚');
}
// â–²â–²â–² æ–°å¢JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V2.1 | æœ¬åè¿½è¹¤ç‰ˆã€‘æ‰“é–‹ç‹¼äººæ®ºéŠæˆ²å¤§å»³
 * @param {'global' | 'group'} mode - æ¨¡å¼ï¼š'global'è¡¨ç¤ºå¾éŠæˆ²å°å±‹é€²å…¥ï¼Œ'group'è¡¨ç¤ºå¾ç¾¤èŠé€²å…¥
 */
async function openWerewolfLobby(mode) {
    const modal = document.getElementById('werewolf-lobby-modal');
    const listEl = document.getElementById('werewolf-player-selection-list');
    listEl.innerHTML = '';
    
    let potentialPlayers = [];
    
    if (mode === 'global') {
        const characters = Object.values(state.chats).filter(c => !c.isGroup);
        const npcs = await db.npcs.toArray();
        potentialPlayers = [
            // ç‚ºç”¨æˆ¶æ·»åŠ æœ¬å
            { id: 'user', name: state.qzoneSettings.nickname || 'æˆ‘', originalName: state.qzoneSettings.nickname || 'æˆ‘', avatar: state.qzoneSettings.avatar, type: 'user' },
            // ç‚ºè§’è‰²æ·»åŠ æœ¬å
            ...characters.map(c => ({ id: c.id, name: c.name, originalName: c.originalName, avatar: c.settings.aiAvatar, type: 'character' })),
            // ç‚ºNPCæ·»åŠ æœ¬å (ä½¿ç”¨å…¶æ˜µç¨±ä½œç‚ºæœ¬å)
            ...npcs.map(n => ({ id: `npc_${n.id}`, name: n.name, originalName: n.name, avatar: n.avatar, type: 'npc' }))
        ];
        werewolfGameState.chatId = null;
    } else {
        const chat = state.chats[state.activeChatId];
        if (!chat || !chat.isGroup) return;
        
        potentialPlayers = [
            // ç‚ºç”¨æˆ¶æ·»åŠ æœ¬å
            { id: 'user', name: chat.settings.myNickname || 'æˆ‘', originalName: state.qzoneSettings.nickname || 'æˆ‘', avatar: chat.settings.myAvatar, type: 'user' },
            // ç‚ºç¾¤æˆå“¡æ·»åŠ æœ¬å
            ...chat.members.map(m => {
                const char = state.chats[m.id];
                const memberAvatar = m.avatar || (char ? char.settings.aiAvatar : defaultGroupMemberAvatar);
                return { 
                    id: m.id, 
                    name: m.groupNickname, 
                    originalName: m.originalName, // æ ¸å¿ƒï¼šè¨˜éŒ„æœ¬å
                    avatar: memberAvatar, 
                    type: m.isNpc ? 'npc' : 'character' 
                };
            })
        ];
        werewolfGameState.chatId = state.activeChatId;
    }

    potentialPlayers.forEach(player => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.innerHTML = `
            <input type="checkbox" class="werewolf-player-checkbox" data-player-json='${JSON.stringify(player)}' ${player.type === 'user' ? 'checked disabled' : 'checked'}>
            <img src="${player.avatar}" class="avatar">
            <span class="name">${player.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

/**
         * ã€V3.0 | å·²æ·»åŠ å¥³å·«å®ˆè¡›ã€‘åˆå§‹åŒ–ä¸€å±€æ–°çš„ç‹¼äººæ®ºéŠæˆ²
         */
        async function initializeWerewolfGame() {
            const selectedCheckboxes = document.querySelectorAll('.werewolf-player-checkbox:checked');
            const playerCount = selectedCheckboxes.length;

            let roles = [];
            if (playerCount === 6) {
                werewolfGameState.gameMode = '6p';
                roles = ['ç‹¼äºº', 'ç‹¼äºº', 'å¹³æ°‘', 'å¹³æ°‘', 'é è¨€å®¶', 'çµäºº'];
            } else if (playerCount === 9) {
                werewolfGameState.gameMode = '9p';
                roles = ['ç‹¼äºº', 'ç‹¼äºº', 'ç‹¼äºº', 'å¹³æ°‘', 'å¹³æ°‘', 'å¹³æ°‘', 'é è¨€å®¶', 'å¥³å·«', 'çµäºº'];
            } else if (playerCount === 12) {
                werewolfGameState.gameMode = '12p';
                roles = ['ç‹¼äºº', 'ç‹¼äºº', 'ç‹¼äºº', 'ç‹¼äºº', 'å¹³æ°‘', 'å¹³æ°‘', 'å¹³æ°‘', 'å¹³æ°‘', 'é è¨€å®¶', 'å¥³å·«', 'çµäºº', 'å®ˆè¡›'];
            } else {
                alert(`ç•¶å‰äººæ•¸ ${playerCount} ä¸æ”¯æŒã€‚è«‹é¸æ“‡6ã€9æˆ–12äººã€‚`);
                return;
            }

            document.getElementById('werewolf-lobby-modal').classList.remove('visible');
            await showCustomAlert('æ­£åœ¨ç™¼ç‰Œ...', 'éŠæˆ²å³å°‡é–‹å§‹ï¼Œæ­£åœ¨ç‚ºå„ä½ç©å®¶åˆ†é…èº«ä»½...');

            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }

            const selectedPlayers = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.dataset.playerJson));
            werewolfGameState.players = [];

            for (let i = 0; i < selectedPlayers.length; i++) {
                const playerInfo = selectedPlayers[i];
                const role = roles[i];
                
                let character_persona = "ä¸€å€‹æ™®é€šç©å®¶";
                if (playerInfo.type === 'character') {
                    const char = state.chats[playerInfo.id];
                    character_persona = char ? char.settings.aiPersona : 'æœªçŸ¥è¨­å®šçš„è§’è‰²';
                } else if (playerInfo.type === 'npc') {
                    const npcs = await db.npcs.toArray();
                    const npc = npcs.find(n => `npc_${n.id}` === playerInfo.id);
                    character_persona = npc ? npc.persona : 'æœªçŸ¥è¨­å®šçš„NPC';
                } else if (playerInfo.type === 'user') {
                    const activeChat = werewolfGameState.chatId ? state.chats[werewolfGameState.chatId] : null;
                    character_persona = activeChat ? activeChat.settings.myPersona : 'æˆ‘æ˜¯èª°å‘€ã€‚';
                }

                const playerObject = {
                    ...playerInfo,
                    role: role,
                    isAlive: true,
                    character_persona: character_persona
                };

                // â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ï¼šç‚ºç‰¹æ®Šè§’è‰²æ·»åŠ å±¬æ€§ã€‘ â–¼â–¼â–¼
                if (role === 'å¥³å·«') {
                    playerObject.antidoteUsed = false;
                    playerObject.poisonUsed = false;
                }
                if (role === 'å®ˆè¡›') {
                    playerObject.lastGuardedId = null;
                }
                // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

                werewolfGameState.players.push(playerObject);
            }
            
            werewolfGameState.isActive = true;
            werewolfGameState.currentDay = 1;
            werewolfGameState.currentPhase = 'start';
            werewolfGameState.gameLog = [];
            werewolfGameState.discussionLog = [];

            const roleCounts = roles.reduce((acc, role) => { acc[role] = (acc[role] || 0) + 1; return acc; }, {});
            const roleSummary = Object.entries(roleCounts).map(([role, count]) => `${role} x${count}`).join('ã€');
            addGameLog(`éŠæˆ²é…ç½®ï¼š${playerCount}äººå±€ï¼Œèº«ä»½ç‚º ${roleSummary}ã€‚`);

            const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

            renderWerewolfScreen();
            showScreen('werewolf-game-screen');
            
            showMyRole(myPlayer.role);
        }

// â–¼â–¼â–¼ ã€V2.1 | è·¨å¤©é¡¯ç¤ºä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ renderWerewolfScreen â–¼â–¼â–¼
/**
 * ã€V2.1 | UIä¿®å¾©ç‰ˆã€‘æ¸²æŸ“ç‹¼äººæ®ºéŠæˆ²ä¸»ä»‹é¢
 */
function renderWerewolfScreen() {
    const gridEl = document.getElementById('werewolf-player-grid');
    gridEl.innerHTML = '';
    const sortedPlayers = [...werewolfGameState.players].sort((a, b) => a.isAlive - b.isAlive);

    sortedPlayers.forEach((p, index) => {
        const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;
        const avatarEl = document.createElement('div');
        avatarEl.className = 'werewolf-player-avatar';
        if (!p.isAlive) avatarEl.classList.add('dead');
        avatarEl.innerHTML = `
            <img src="${p.avatar}">
            <span class="player-name">${playerIndex}. ${p.name}</span>
        `;
        gridEl.appendChild(avatarEl);
    });

    const logEl = document.getElementById('werewolf-log');
    logEl.innerHTML = '';
    
    // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‰å¤©æ¸²æŸ“æ—¥èªŒã€‘ã€‘ã€‘
    for (let day = 1; day <= werewolfGameState.currentDay; day++) {
        // 1. ç¯©é¸å‡ºç•¶å¤©çš„æ‰€æœ‰æ—¥èªŒ
        const logsThisDay = [
            ...werewolfGameState.gameLog.filter(entry => entry.day === day),
            ...werewolfGameState.discussionLog.filter(entry => entry.day === day)
        ].sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));

        // å¦‚æœç•¶å¤©æœ‰ä»»ä½•è¨˜éŒ„ï¼Œå°±å…ˆæ·»åŠ ä¸€å€‹å¤©æ•¸æ¨™é¡Œ
        if (logsThisDay.length > 0) {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'werewolf-log-entry system';
            dayHeader.textContent = `--- ç¬¬ ${day} å¤© ---`;
            dayHeader.style.cssText = 'font-weight: bold; background: rgba(255, 193, 7, 0.2);';
            logEl.appendChild(dayHeader);

            // 2. æ¸²æŸ“ç•¶å¤©çš„æ¯ä¸€æ¢æ—¥èªŒ
            logsThisDay.forEach(entry => {
                const entryEl = document.createElement('div');
                entryEl.className = `werewolf-log-entry ${entry.type}`;
                if (entry.type === 'dialogue') {
                    entryEl.innerHTML = `<span class="speaker">${entry.speaker}:</span> ${entry.content}`;
                } else {
                    entryEl.textContent = entry.content;
                }
                logEl.appendChild(entryEl);
            });
        }
    }
    // ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘

    logEl.scrollTop = logEl.scrollHeight;
    
    // åœ¨æ¨™é¡Œä¸­æ˜ç¢ºé¡¯ç¤ºå¤©æ•¸å’Œç•¶å‰éšæ®µ
    const phaseMap = {
        'start': 'éŠæˆ²é–‹å§‹',
        'night': `ç¬¬${werewolfGameState.currentDay}å¤© - å¤œæ™š`,
        'day': `ç¬¬${werewolfGameState.currentDay}å¤© - ç™½å¤©`,
        'discussion': `ç¬¬${werewolfGameState.currentDay}å¤© - è¨è«–`,
        'voting': `ç¬¬${werewolfGameState.currentDay}å¤© - æŠ•ç¥¨`,
        'gameover': 'éŠæˆ²çµæŸ'
    };
    document.getElementById('werewolf-game-title').textContent = `ç‹¼äººæ®º - ${phaseMap[werewolfGameState.currentPhase] || werewolfGameState.currentPhase}`;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * é¡¯ç¤ºç©å®¶è‡ªå·±çš„èº«ä»½å¡ç‰‡
 * @param {string} role - ç©å®¶çš„è§’è‰²
 */
function showMyRole(role) {
    const roleDescriptions = {
        'ç‹¼äºº': 'ä½ çš„ç›®æ¨™æ˜¯æ®ºæ­»æ‰€æœ‰å¥½äººã€‚æ¯æ™šå¯ä»¥å’ŒåŒä¼´ä¸€èµ·åˆ€ä¸€å€‹ç©å®¶ã€‚',
        'å¹³æ°‘': 'ä½ æ²’æœ‰ä»»ä½•ç‰¹æ®Šèƒ½åŠ›ï¼Œä½ çš„ç›®æ¨™æ˜¯é€šéæŠ•ç¥¨æ”¾é€æ‰€æœ‰ç‹¼äººã€‚',
        'é è¨€å®¶': 'æ¯æ™šå¯ä»¥æŸ¥é©—ä¸€å€‹ç©å®¶çš„èº«ä»½æ˜¯å¥½äººé‚„æ˜¯ç‹¼äººã€‚',
        'çµäºº': 'ç•¶ä½ æ­»äº¡æ™‚ï¼Œä½ å¯ä»¥é¸æ“‡å¸¶èµ°å ´ä¸Šä»»æ„ä¸€åç©å®¶ã€‚',
        'å¥³å·«': 'ä½ æœ‰ä¸€ç“¶è§£è—¥å’Œä¸€ç“¶æ¯’è—¥ï¼Œè§£è—¥å¯ä»¥æ•‘æ´»ç•¶æ™šè¢«æ®ºçš„ç©å®¶ï¼Œæ¯’è—¥å¯ä»¥æ¯’æ­»ä»»æ„ä¸€åç©å®¶ã€‚',
        'å®ˆè¡›': 'æ¯æ™šå¯ä»¥å®ˆè­·ä¸€åç©å®¶ï¼Œä½¿å…¶å…å—ç‹¼äººè¥²æ“Šã€‚ä¸èƒ½é€£çºŒå…©æ™šå®ˆè­·åŒä¸€å€‹äººã€‚'
    };
    
    document.getElementById('werewolf-role-name').textContent = role;
    document.getElementById('werewolf-role-description').textContent = roleDescriptions[role] || 'ä¸€å€‹ç¥ç§˜çš„è§’è‰²ã€‚';
    document.getElementById('werewolf-role-modal').classList.add('visible');
}

/**
         * ã€V3.0 | å·²è£œå…¨å®ˆè¡›å¥³å·«ã€‘åŸ·è¡Œå¤œæ™šéšæ®µçš„é‚è¼¯
         */
        async function executeNightPhase() {
            werewolfGameState.currentPhase = `ç¬¬${werewolfGameState.currentDay}å¤© - å¤œæ™š`;
            werewolfGameState.nightActions = {}; // é‡ç½®ç•¶æ™šè¡Œå‹•
            addGameLog('å¤©é»‘è«‹é–‰çœ¼...');
            renderWerewolfScreen();
            
            document.getElementById('werewolf-action-bar').style.display = 'none';
            document.getElementById('werewolf-retry-btn').style.display = 'none'; // éš±è—é‡è©¦æŒ‰éˆ•
            await new Promise(resolve => setTimeout(resolve, 1500));
        
            // 1. å®ˆè¡›è¡Œå‹• (æœ€å…ˆè¡Œå‹•)
            const guard = werewolfGameState.players.find(p => p.role === 'å®ˆè¡›' && p.isAlive);
            if (guard) {
                addGameLog('å®ˆè¡›è«‹çœçœ¼ï¼Œè«‹é¸æ“‡è¦å®ˆè­·çš„ç©å®¶ã€‚');
                renderWerewolfScreen();
                let guardedId = null;
                if (guard.id === 'user') {
                    guardedId = await openSelectionModal('guard', guard.lastGuardedId);
                } else { // AIå®ˆè¡›
                    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== guard.lastGuardedId);
                    if (potentialTargets.length > 0) {
                        guardedId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
                    }
                }
                if (guardedId) {
                    werewolfGameState.nightActions.guardedId = guardedId;
                    guard.lastGuardedId = guardedId; // è¨˜éŒ„æœ¬è¼ªå®ˆè­·çš„äºº
                }
                addGameLog('å®ˆè¡›å·²è¡Œå‹•ï¼Œå®ˆè¡›è«‹é–‰çœ¼ã€‚');
                renderWerewolfScreen();
                await new Promise(resolve => setTimeout(resolve, 1500));
            }

            // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šç‹¼äººè¡Œå‹•éŒ¯èª¤è™•ç†ã€‘ã€‘ã€‘ â–¼â–¼â–¼
            // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®å¾©ï¼šç¬¬ä¸€å¤œç‹¼äººè¡Œå‹•ç‰¹æ®Šè™•ç†ã€‘ã€‘ã€‘ â–¼â–¼â–¼
            addGameLog('ç‹¼äººè«‹çœçœ¼ï¼Œè«‹é¸æ“‡è¦åˆ€çš„ç©å®¶ã€‚');
            renderWerewolfScreen();
            
            const wolves = werewolfGameState.players.filter(p => p.role === 'ç‹¼äºº' && p.isAlive);
            const userIsWolf = wolves.some(p => p.id === 'user');
            
            let wolfTargetId = null;

            // æ¨™è¨˜ç•¶å‰æ“ä½œï¼Œä»¥ä¾¿é‡è©¦
            werewolfGameState.lastFailedAction = 'wolfKill';
            try {
                if (userIsWolf) {
                    addGameLog('ä½ æ˜¯ç‹¼äººï¼Œè«‹é¸æ“‡åˆ€äººç›®æ¨™ã€‚');
                    renderWerewolfScreen();
                    wolfTargetId = await openWolfKillModal();
                } else {
                    // å¦‚æœæ˜¯ç¬¬ä¸€å¤©ï¼Œå‰‡åŸ·è¡Œæœ¬åœ°éš¨æ©Ÿåˆ€äººï¼Œä¸èª¿ç”¨API
                    if (werewolfGameState.currentDay === 1) {
                        console.log("ç¬¬ä¸€å¤œï¼ŒåŸ·è¡Œæœ¬åœ°éš¨æ©Ÿåˆ€äººé‚è¼¯...");
                        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'ç‹¼äºº');
                        if (potentialTargets.length > 0) {
                            wolfTargetId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
                        }
                    } else {
                        // å¾ç¬¬äºŒå¤©é–‹å§‹ï¼Œæ‰èª¿ç”¨APIé€²è¡Œæ™ºæ…§æ±ºç­–
                        wolfTargetId = await getAiWolfKillTarget();
                    }
                }
                // å¦‚æœæˆåŠŸï¼Œæ¸…é™¤å¤±æ•—æ¨™è¨˜
                werewolfGameState.lastFailedAction = null;
            } catch (error) {
                console.error("ç‹¼äººè¡Œå‹•APIå¤±æ•—:", error);
                await showCustomAlert("æ“ä½œå¤±æ•—", "AIç‹¼äººåœ˜éšŠç„¡æ³•æ±ºå®šç›®æ¨™ï¼ŒéŠæˆ²æš«åœã€‚è«‹é»æ“Šå³ä¸Šè§’çš„â€œé‡è©¦â€æŒ‰éˆ•ç¹¼çºŒã€‚");
                document.getElementById('werewolf-retry-btn').style.display = 'block';
                return;
            }
            // â–²â–²â–² ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ â–²â–²â–²
            werewolfGameState.nightActions.killedId = wolfTargetId;
            addGameLog('ç‹¼äººå·²è¡Œå‹•ï¼Œç‹¼äººè«‹é–‰çœ¼ã€‚');
            renderWerewolfScreen();
            await new Promise(resolve => setTimeout(resolve, 1500));

            // 3. å¥³å·«è¡Œå‹•
            const witch = werewolfGameState.players.find(p => p.role === 'å¥³å·«' && p.isAlive);
            if (witch) {
                addGameLog('å¥³å·«è«‹çœçœ¼ã€‚');
                renderWerewolfScreen();
                const killedPlayer = werewolfGameState.players.find(p => p.id === werewolfGameState.nightActions.killedId);
                
                // åˆ¤æ–·æ˜¯å¦æ˜¯å®ˆè¡›å®ˆè­·çš„ç›®æ¨™
                const isGuarded = werewolfGameState.nightActions.guardedId === werewolfGameState.nightActions.killedId;

                // å¥³å·«åªèƒ½çœ‹åˆ°ç‹¼äººåˆ€çš„äººï¼Œå¦‚æœè¢«å®ˆè¡›å®ˆäº†ï¼Œå¥³å·«çœ‹åˆ°çš„å°±æ˜¯å¹³å®‰å¤œ
                const playerToShowWitch = (isGuarded || !killedPlayer) ? null : killedPlayer;

                if (witch.id === 'user') {
                    let userWitchAction = await openWitchActionModal(playerToShowWitch, witch);
                    if (userWitchAction.save) {
                        werewolfGameState.nightActions.savedId = werewolfGameState.nightActions.killedId;
                        witch.antidoteUsed = true;
                    }
                    if (userWitchAction.poison) {
                        werewolfGameState.nightActions.poisonedId = userWitchAction.poison;
                        witch.poisonUsed = true;
                    }
                } else { // AIå¥³å·«
                    // AIå¥³å·«çš„å…¨æ–°æ±ºç­–é‚è¼¯
                    if (!witch.antidoteUsed && playerToShowWitch) {
                        let saveChance = 0;
                        if (werewolfGameState.currentDay === 1) {
                            // ç¬¬ä¸€å¤©æ™šä¸Šï¼Œè³‡è¨Šå¾ˆå°‘ï¼Œæ•‘äººçš„é¢¨éšªå¾ˆé«˜ã€‚åªæœ‰30%çš„å¹¾ç‡æœƒå†’éšªæ•‘äººã€‚
                            saveChance = 0.3; 
                        } else {
                            // å¾ç¬¬äºŒå¤©æ™šä¸Šé–‹å§‹ï¼Œè³‡è¨Šå¢å¤šï¼Œæ•‘äººçš„åƒ¹å€¼æ›´å¤§ï¼Œæœ‰80%çš„å¹¾ç‡æœƒæ•‘äººã€‚
                            saveChance = 0.8;
                        }
                        
                        console.log(`AIå¥³å·«æ±ºç­–ï¼šä»Šå¤©æ˜¯ç¬¬${werewolfGameState.currentDay}å¤©ï¼Œæ•‘äººæ¦‚ç‡ç‚º ${saveChance * 100}%`);
                        
                        if (Math.random() < saveChance) {
                            console.log("AIå¥³å·«æ±ºå®šä½¿ç”¨è§£è—¥ï¼");
                            werewolfGameState.nightActions.savedId = werewolfGameState.nightActions.killedId;
                            witch.antidoteUsed = true;
                        } else {
                            console.log("AIå¥³å·«æ±ºå®šä¿ç•™è§£è—¥ã€‚");
                        }
                    } 
                    
                    // æ¯’äººé‚è¼¯ä¿æŒä¸è®Šï¼šå¦‚æœæ²’æœ‰æ•‘äººï¼Œä¸¦ä¸”æœ‰æ¯’è—¥ï¼Œå‰‡æœ‰50%æ¦‚ç‡æ¯’äºº
                    if (!werewolfGameState.nightActions.savedId && !witch.poisonUsed && Math.random() < 0.5) {
                        const poisonTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== werewolfGameState.nightActions.killedId);
                        if (poisonTargets.length > 0) {
                             const target = poisonTargets[Math.floor(Math.random() * poisonTargets.length)];
                             werewolfGameState.nightActions.poisonedId = target.id;
                             witch.poisonUsed = true;
                             console.log(`AIå¥³å·«æ±ºå®šä½¿ç”¨æ¯’è—¥ï¼Œç›®æ¨™æ˜¯: ${target.name}`);
                        }
                    }

                }
                addGameLog('å¥³å·«å·²è¡Œå‹•ï¼Œå¥³å·«è«‹é–‰çœ¼ã€‚');
                renderWerewolfScreen();
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
        
            // 4. é è¨€å®¶è¡Œå‹•
            const prophet = werewolfGameState.players.find(p => p.role === 'é è¨€å®¶' && p.isAlive);
            if (prophet) {
                addGameLog('é è¨€å®¶è«‹çœçœ¼ï¼Œè«‹é¸æ“‡è¦æŸ¥é©—çš„ç©å®¶ã€‚');
                renderWerewolfScreen();
        
                if (prophet.id === 'user') {
                    const targetId = await openSelectionModal('prophet');
                    const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
                    if(targetPlayer) {
                        const isWolf = targetPlayer.role === 'ç‹¼äºº';
                        await showCustomAlert('æŸ¥é©—çµæœ', `ä½ æŸ¥é©—çš„ç©å®¶ ${targetPlayer.name} çš„èº«ä»½æ˜¯ï¼š${isWolf ? 'ç‹¼äºº' : 'å¥½äºº'}`);
                        werewolfGameState.nightActions.prophetCheck = { target: targetId, result: isWolf ? 'ç‹¼äºº' : 'å¥½äºº' };
                    }
                } else {
                    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== prophet.id);
                    if (potentialTargets.length > 0) {
                        const target = potentialTargets[Math.floor(Math.random() * potentialTargets.length)];
                        werewolfGameState.nightActions.prophetCheck = { target: target.id, result: target.role === 'ç‹¼äºº' ? 'ç‹¼äºº' : 'å¥½äºº' };
                    }
                }
                addGameLog('é è¨€å®¶å·²è¡Œå‹•ï¼Œé è¨€å®¶è«‹é–‰çœ¼ã€‚');
                renderWerewolfScreen();
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            // 5. é€²å…¥ç™½å¤©
            executeDayPhase();
        }
        
/**
         * ã€V3.0 | å·²è£œå…¨æ­»äº¡çµç®—ã€‘åŸ·è¡Œç™½å¤©éšæ®µçš„é‚è¼¯
         */
        async function executeDayPhase() {
            werewolfGameState.currentPhase = `ç¬¬${werewolfGameState.currentDay}å¤© - ç™½å¤©`;
            werewolfGameState.voteResults = {};
            addGameLog('å¤©äº®äº†ã€‚');

            const { killedId, guardedId, savedId, poisonedId } = werewolfGameState.nightActions;
            const deathsThisNight = new Set(); // ä½¿ç”¨ Set ä¾†é¿å…é‡è¤‡æ·»åŠ æ­»äº¡ç©å®¶

            // 1. è¨ˆç®—ç‹¼äººåˆ€äººçµæœ
            if (killedId && killedId !== guardedId && killedId !== savedId) {
                deathsThisNight.add(killedId);
            }

            // 2. è¨ˆç®—å¥³å·«æ¯’äººçµæœ
            if (poisonedId) {
                // å¦‚æœå¥³å·«æ•‘äººå’Œæ¯’äººæ˜¯åŒä¸€å€‹äººï¼Œå‰‡æ¯’è—¥å„ªå…ˆï¼Œè©²ç©å®¶æ­»äº¡
                deathsThisNight.add(poisonedId);
            }

            // 3. å…¬ä½ˆæ­»äº¡çµæœä¸¦è™•ç†æŠ€èƒ½
            if (deathsThisNight.size === 0) {
                addGameLog('æ˜¨æ™šæ˜¯å¹³å®‰å¤œã€‚');
            } else {
                for (const deadPlayerId of deathsThisNight) {
                    const deadPlayer = werewolfGameState.players.find(p => p.id === deadPlayerId);
                    if (deadPlayer && deadPlayer.isAlive) {
                        deadPlayer.isAlive = false;
                        addGameLog(`æ˜¨æ™š ${deadPlayer.name} æ­»äº¡äº†ã€‚`);

                        // çµäººæŠ€èƒ½è™•ç†
                        if (deadPlayer.role === 'çµäºº') {
                            addGameLog('çµäººæ­»äº¡ï¼Œè«‹é¸æ“‡ä¸€åç©å®¶å¸¶èµ°ï¼');
                            renderWerewolfScreen();
                            let hunterTargetId = null;
                            if (deadPlayer.id === 'user') {
                                hunterTargetId = await openSelectionModal('hunter');
                            } else { 
                                const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== deadPlayer.id);
                                if (potentialTargets.length > 0) {
                                    hunterTargetId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
                                }
                            }
                            const targetPlayer = werewolfGameState.players.find(p => p.id === hunterTargetId);
                            if(targetPlayer) {
                                targetPlayer.isAlive = false;
                                addGameLog(`çµäººå¸¶èµ°äº† ${targetPlayer.name}ã€‚`);
                            }
                        }
                    }
                }
            }
            
            renderWerewolfScreen();
        
            if (checkGameOver()) return;
        
            await startDiscussionPhase();
        }
        
// â–¼â–¼â–¼ ã€V2.0 | å·²ä¿®å¾©ã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ startDiscussionPhase â–¼â–¼â–¼
/**
 * ã€V2.0 | å·²ä¿®å¾©ã€‘é–‹å§‹è¨è«–ç’°ç¯€
 */
async function startDiscussionPhase() {
    // ã€ã€ã€æ ¸å¿ƒä¿®å¾©ã€‘ï¼šä¸å†æ¸…ç©ºè¨è«–è¨˜éŒ„ï¼ã€‘ã€‘ã€‘
    // werewolfGameState.discussionLog = []; // <--- ç¢ºä¿é€™ä¸€è¡Œå·²è¢«åˆªé™¤æˆ–æ³¨é‡‹æ‰ï¼
    
    addGameLog('ç¾åœ¨é–‹å§‹è¨è«–ï¼Œè«‹å„ä½ç©å®¶ä¾æ¬¡ç™¼è¨€ã€‚');
    renderWerewolfScreen();
    
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå°è©±ã€‚');
        return;
    }

    const systemPrompt = buildWerewolfPrompt();
    werewolfGameState.lastFailedAction = 'startDiscussion';
    try {
        await showCustomAlert("è«‹ç¨å€™", "æ­£åœ¨ç­‰å¾…AIè§’è‰²å€‘é€²è¡Œæ¿€çƒˆçš„è¨è«–...");

        let isGemini = proxyUrl.includes('generativelanguage');
        let messagesForApi = [{role: 'user', content: 'è«‹æ‰€æœ‰AIè§’è‰²æ ¹æ“šä½ å€‘çš„èº«ä»½å’Œäººè¨­é–‹å§‹ç™¼è¨€ã€‚'}];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 0.95,
                })
            });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API éŒ¯èª¤: ${errorData.error.message}`);
        }
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch) {
            throw new Error(`AIè¿”å›çš„è¨è«–å…§å®¹æ ¼å¼ä¸æ­£ç¢ºã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const dialogues = JSON.parse(jsonMatch[0]);

        for (const dialogue of dialogues) {
            if(dialogue.speaker_name && dialogue.dialogue) {
                addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
                renderWerewolfScreen();
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
            }
        }
        
        werewolfGameState.lastFailedAction = null; 

    } catch(error) {
        console.error("ç‹¼äººæ®ºAIè¨è«–ç”Ÿæˆå¤±æ•—:", error);
        await showCustomAlert("AI ç™¼è¨€å¤±æ•—", `è¨è«–ç„¡æ³•é–‹å§‹ï¼ŒéŠæˆ²æš«åœã€‚è«‹é»æ“Šå³ä¸Šè§’çš„â€œé‡è©¦â€æŒ‰éˆ•ç¹¼çºŒã€‚\néŒ¯èª¤: ${error.message}`);
        document.getElementById('werewolf-retry-btn').style.display = 'block';
        return;
    }

    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
    const actionBar = document.getElementById('werewolf-action-bar');
    const waitReplyBtn = document.getElementById('werewolf-wait-reply-btn');
    const finishSpeechBtn = document.getElementById('werewolf-finish-speech-btn');
    const userInput = document.getElementById('werewolf-user-input');

    actionBar.style.display = 'flex';

    if (myPlayer && myPlayer.isAlive) {
        waitReplyBtn.textContent = 'ç­‰å¾…å›æ‡‰';
        finishSpeechBtn.textContent = 'çµæŸç™¼è¨€';
        waitReplyBtn.style.display = 'block';
        finishSpeechBtn.style.display = 'block';
        userInput.disabled = false;
        userInput.placeholder = "è¼ªåˆ°ä½ ç™¼è¨€äº†...";
        userInput.focus();
        
        const newWaitBtn = waitReplyBtn.cloneNode(true);
        waitReplyBtn.parentNode.replaceChild(newWaitBtn, waitReplyBtn);
        newWaitBtn.addEventListener('click', handleWerewolfWaitReply);

        const newFinishBtn = finishSpeechBtn.cloneNode(true);
        finishSpeechBtn.parentNode.replaceChild(newFinishBtn, finishSpeechBtn);
        newFinishBtn.addEventListener('click', handleUserWerewolfSpeech);

    } else {
        addGameLog('ä½ å·²ç¶“æ­»äº¡ï¼Œç„¡æ³•ç™¼è¨€ã€‚è«‹ç­‰å¾…å…¶ä»–ç©å®¶ç™¼è¨€çµæŸã€‚');
        renderWerewolfScreen();
        
        waitReplyBtn.textContent = 'ç¹¼çºŒè¨è«–';
        finishSpeechBtn.textContent = 'é€²å…¥æŠ•ç¥¨';
        waitReplyBtn.style.display = 'block';
        finishSpeechBtn.style.display = 'block';
        userInput.disabled = true;
        userInput.placeholder = "ä½ å·²æ­»äº¡ï¼Œæ­£åœ¨åœè§€...";

        const newWaitBtn = waitReplyBtn.cloneNode(true);
        waitReplyBtn.parentNode.replaceChild(newWaitBtn, waitReplyBtn);
        newWaitBtn.addEventListener('click', handleAiContinueDiscussion);

        const newFinishBtn = finishSpeechBtn.cloneNode(true);
        finishSpeechBtn.parentNode.replaceChild(newFinishBtn, finishSpeechBtn);
        newFinishBtn.addEventListener('click', startVotingPhase);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

/**
 * ã€V3.4 | ç¨±å‘¼ä¿®å¾©ç‰ˆã€‘æ§‹å»ºç”¨æ–¼ç”Ÿæˆæ‰€æœ‰AIè¨è«–çš„System Prompt
 */
function buildWerewolfPrompt() {
    const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
    const myPlayerObject = werewolfGameState.players.find(p => p.id === 'user');
    const myPlayerName = myPlayerObject ? myPlayerObject.name : 'ç”¨æˆ¶';
    const isUserAlive = alivePlayers.some(p => p.id === 'user');

    // è§’è‰²æª”æ¡ˆéƒ¨åˆ†
    let charactersAndPlayersDossier = "# è§’è‰²èˆ‡ç©å®¶æª”æ¡ˆ (Character & Player Dossiers)\n";
    alivePlayers.forEach((p, i) => {
        const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;
        // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨é€™è£¡åŒæ™‚æä¾›äº†æ˜µç¨±å’Œæœ¬åï¼Œä¸¦æ˜ç¢ºæŒ‡ç¤ºäº†æœ¬åçš„ç”¨é€”
        charactersAndPlayersDossier += `
## ${playerIndex}è™Ÿç©å®¶: ${p.name} (é€™æ˜¯TAçš„æ˜µç¨±)
- **æœ¬å (ä½ åœ¨å°è©±ä¸­å¿…é ˆç”¨é€™å€‹åå­—ç¨±å‘¼TA)**: ${p.originalName}
- **èº«ä»½**: ${p.id === 'user' ? 'ã€ç”¨æˆ¶ (User)ã€‘' : 'ã€AIè§’è‰²ã€‘'}
- **äººè¨­ (å¿…é ˆåš´æ ¼éµå®ˆ)**: ${p.character_persona}
`;
        
        if (p.type === 'character') {
            const char = state.chats[p.id];
            if (char && char.longTermMemory && char.longTermMemory.length > 0) {
                const memoryContent = char.longTermMemory.map(mem => mem.content).join('; ');
                charactersAndPlayersDossier += `- **é•·æœŸè¨˜æ†¶ (å¿…é ˆåƒè€ƒ)**: ${memoryContent}\n`;
            }
        }
    });

    // (å¾ŒçºŒçš„äº‹ä»¶ç¸½çµã€æ­·å²å›é¡§ã€ç§˜å¯†è³‡è¨Šç­‰éƒ¨åˆ†ä¿æŒä¸è®Š)
    let nightEventSummary = "# æ˜¨æ™šäº‹ä»¶ç¸½çµ (Night Event Summary)\n";
    const deathsThisNight = werewolfGameState.gameLog.filter(entry => entry.content.includes('æ­»äº¡äº†') && entry.day === werewolfGameState.currentDay);
    if (deathsThisNight.length === 0) {
         nightEventSummary += "- æ˜¨æ™šæ˜¯å¹³å®‰å¤œï¼Œç„¡äººæ­»äº¡ã€‚\n";
    } else {
        deathsThisNight.forEach(death => {
            nightEventSummary += `- ${death.content}\n`;
        });
    }
    let previousDaysSummary = "# å‰å¹¾æ—¥å®Œæ•´æ­·å²å›é¡§ (Full Recap of Previous Days)\n";
    if (werewolfGameState.currentDay > 1) {
        for (let day = 1; day < werewolfGameState.currentDay; day++) {
            previousDaysSummary += `\n**--- ç¬¬ ${day} å¤© ---**\n`;
            const eventsThisDay = werewolfGameState.gameLog.filter(entry => entry.day === day && (entry.content.includes('æ­»äº¡') || entry.content.includes('æ”¾é€')));
            if (eventsThisDay.length > 0) {
                previousDaysSummary += `*äº‹ä»¶*: ${eventsThisDay.map(e => e.content).join(' ')}\n`;
            } else {
                previousDaysSummary += "*äº‹ä»¶*: å¹³å®‰å¤œï¼Œç„¡äººå‡ºå±€ã€‚\n";
            }
            const discussionsThisDay = werewolfGameState.discussionLog.filter(entry => entry.day === day);
            if (discussionsThisDay.length > 0) {
                previousDaysSummary += `*è¨è«–è¨˜éŒ„*:\n${discussionsThisDay.map(d => `- ${d.speaker}: ${d.content}`).join('\n')}\n`;
            }
        }
    } else {
        previousDaysSummary += "(ä»Šå¤©æ˜¯ç¬¬ä¸€å¤©ï¼Œæ²’æœ‰æ­·å²è¨˜éŒ„)\n";
    }
    let secretInfo = "### ä½ çš„ç§˜å¯†è³‡è¨Š (æ­¤éƒ¨åˆ†åªæœ‰ä½ ä½œç‚ºAIå°æ¼”èƒ½çœ‹åˆ°)\n";
    alivePlayers.forEach(p => {
        if (p.id !== 'user') {
            secretInfo += `#### ${p.name}çš„ç§˜å¯†æª”æ¡ˆï¼š\n- ä½ çš„ç‹¼äººæ®ºèº«ä»½æ˜¯ï¼šã€${p.role}ã€‘\n`;
            if (p.role === 'ç‹¼äºº') {
                const teammates = werewolfGameState.players.filter(t => t.role === 'ç‹¼äºº' && t.id !== p.id).map(t => t.name).join('ã€');
                secretInfo += `- ä½ çš„ç‹¼éšŠå‹æ˜¯ï¼š${teammates || 'ç„¡'}\n`;
                const killedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.killedId);
                secretInfo += `- ä½ å€‘æ˜¨æ™šå˜—è©¦æ”»æ“Šçš„ç©å®¶æ˜¯ï¼š${killedPlayer ? killedPlayer.name : 'ç©ºåˆ€'}\n`;
            }
            if (p.role === 'é è¨€å®¶' && werewolfGameState.nightActions.prophetCheck) {
                const checkedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.prophetCheck.target);
                secretInfo += `- ä½ æ˜¨æ™šæŸ¥é©—äº† ${checkedPlayer.name}ï¼ŒTAçš„èº«ä»½æ˜¯ï¼šã€${werewolfGameState.nightActions.prophetCheck.result}ã€‘\n`;
            }
            if (p.role === 'å¥³å·«') {
                if (werewolfGameState.nightActions.savedId) {
                    const savedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.savedId);
                    secretInfo += `- ä½ æ˜¨æ™šç”¨è§£è—¥æ•‘äº† ${savedPlayer.name}ã€‚\n`;
                }
                if (werewolfGameState.nightActions.poisonedId) {
                    const poisonedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.poisonedId);
                    secretInfo += `- ä½ æ˜¨æ™šç”¨æ¯’è—¥æ¯’äº† ${poisonedPlayer.name}ã€‚\n`;
                }
                secretInfo += `- ä½ çš„è§£è—¥ç‹€æ…‹ï¼š${p.antidoteUsed ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}\n`;
                secretInfo += `- ä½ çš„æ¯’è—¥ç‹€æ…‹ï¼š${p.poisonUsed ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}\n`;
            }
            if (p.role === 'å®ˆè¡›') {
                if (werewolfGameState.nightActions.guardedId) {
                    const guardedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.guardedId);
                    secretInfo += `- ä½ æ˜¨æ™šå®ˆè­·äº† ${guardedPlayer.name}ã€‚\n`;
                } else {
                    secretInfo += `- ä½ æ˜¨æ™šç©ºå®ˆäº†ã€‚\n`;
                }
            }
            secretInfo += '\n';
        }
    });
    let discussionHistoryContext = "# ä»Šæ—¥å®Œæ•´è¨è«–è¨˜éŒ„ (Today's Full Discussion Record)\n";
    const todayDiscussions = werewolfGameState.discussionLog.filter(entry => entry.day === werewolfGameState.currentDay);
    if (todayDiscussions.length > 0) {
        discussionHistoryContext += todayDiscussions.map(d => `- **${d.speaker}**: ${d.content}`).join('\n');
    } else {
        discussionHistoryContext += "(ä½ æ˜¯ç¬¬ä¸€å€‹ç™¼è¨€çš„äºº)";
    }

    // æœ€çµ‚çš„Prompt
    const prompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹ç‹¼äººæ®ºéŠæˆ²å°æ¼”ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰®æ¼”ã€é™¤äº†${isUserAlive ? `ç”¨æˆ¶(${myPlayerName})` : `å·²æ­»äº¡çš„ç”¨æˆ¶(${myPlayerName})`}ä»¥å¤–ã€‘çš„æ‰€æœ‰AIè§’è‰²ï¼Œä¸¦æ ¹æ“šä»–å€‘çš„ã€è§’è‰²äººè¨­ã€‘å’Œã€ç‹¼äººæ®ºèº«ä»½ã€‘ï¼Œç”Ÿæˆä¸€æ•´è¼ªç¬¦åˆé‚è¼¯ã€å……æ»¿åšå¼ˆçš„ç™¼è¨€ã€‚

# èº«ä»½èˆ‡äººè¨­éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)
ä½ ã€å¿…é ˆã€‘ç‚ºæ¯ä¸€å€‹è§’è‰²éƒ½ä»”ç´°é–±è®€ä¸¦åš´æ ¼éµå®ˆä¸‹é¢çš„æª”æ¡ˆã€‚é€™æ˜¯ä½ æ‰€æœ‰è¡Œç‚ºå’Œç™¼è¨€çš„å”¯ä¸€ä¾æ“šã€‚åœ¨å°è©±ä¸­ï¼Œè«‹å‹™å¿…æ³¨æ„è§’è‰²äººè¨­ä¸­æš—ç¤ºçš„æ€§åˆ¥ï¼Œä¸¦ä½¿ç”¨æ­£ç¢ºçš„ç¨±å‘¼ï¼ˆä¾‹å¦‚â€œä»–â€æˆ–â€œå¥¹â€ï¼‰ã€‚

${charactersAndPlayersDossier}

# éŠæˆ²è¦å‰‡
- ${werewolfGameState.gameMode === '12p' ? 'å± é‚Šå±€ï¼šç‹¼äººæ®ºæ­»æ‰€æœ‰ç¥è·æˆ–æ‰€æœ‰å¹³æ°‘å³ç²å‹ã€‚' : 'å± åŸå±€ï¼šç‹¼äººæ®ºæ­»æ‰€æœ‰å¥½äººå³ç²å‹ã€‚'}
- å¥½äººå‹åˆ©ï¼šæ”¾é€æ‰€æœ‰ç‹¼äººã€‚

# ç•¶å‰éŠæˆ²ç‹€æ…‹
- ä»Šå¤©æ˜¯ç¬¬ ${werewolfGameState.currentDay} å¤©çš„è¨è«–ç’°ç¯€ã€‚
${nightEventSummary} 
- å­˜æ´»ç©å®¶: ${alivePlayers.map(p => `${p.name} (${p.id === 'user' ? 'ç”¨æˆ¶' : 'AI'})`).join(', ')}

# ã€ã€ã€è§’è‰²ç­–ç•¥æŒ‡å— (è‡³é—œé‡è¦ï¼)ã€‘ã€‘ã€‘
ä½ çš„ç™¼è¨€ã€å¿…é ˆã€‘é«”ç¾å‡ºé«˜æ°´æº–çš„ã€é¡ä¼¼çœŸäººçš„ç­–ç•¥åšå¼ˆï¼Œè€Œä¸æ˜¯ç°¡å–®åœ°é™³è¿°äº‹å¯¦ã€‚

### **ç¥è·è§’è‰² (é è¨€å®¶, å¥³å·«, çµäºº, å®ˆè¡›) ç­–ç•¥**
1.  **ã€éš±è—å„ªå…ˆï¼ã€‘**: ä½ çš„é¦–è¦ä»»å‹™æ˜¯æ´»ä¸‹å»ã€‚**çµ•å°ä¸è¦**åœ¨ç¬¬ä¸€å¤©å°±è¼•æ˜“æš´éœ²è‡ªå·±çš„ç¥è·èº«ä»½ï¼é€™æœƒè®“ä½ ç«‹åˆ»æˆç‚ºç‹¼äººçš„ç›®æ¨™ã€‚
2.  **ã€æš—ç¤ºè€Œéæ˜ç¤ºã€‘**: ä½ æ‡‰è©²ç”¨æ›´å§”å©‰ã€æ›´è°æ˜çš„èªè¨€ä¾†å‚³éè³‡è¨Šï¼Œè€Œä¸æ˜¯ç›´æ¥èªªâ€œæˆ‘æ˜¯é è¨€å®¶ï¼Œæˆ‘æŸ¥äº†Aâ€ã€‚
    *   **é è¨€å®¶å¯ä»¥èªª**: â€œæˆ‘å°Xç©å®¶çš„èº«ä»½æœ‰ä¸€äº›çœ‹æ³•ï¼Œæˆ‘è¦ºå¾—ä»–ç™¼è¨€å¾ˆé™½å…‰ã€‚â€ æˆ– â€œYç©å®¶çš„ç™¼è¨€è®“æˆ‘æ„Ÿåˆ°å¾ˆä¸èˆ’æœï¼Œæˆ‘æŠŠä»–åˆ—ç‚ºé‡é»æ‡·ç–‘å°è±¡ã€‚â€
    *   **å¥³å·«å¯ä»¥èªª**: â€œæ˜¨æ™šçš„è³‡è¨Šå¾ˆæœ‰è¶£ï¼Œå ´ä¸Šå±€å‹¢å¯èƒ½å’Œå¤§å®¶æƒ³çš„ä¸ä¸€æ¨£ã€‚â€
3.  **ã€ä½•æ™‚èµ·è·³ï¼Ÿã€‘**: åªæœ‰åœ¨ä»¥ä¸‹ã€å±æ€¥æƒ…æ³ã€‘ä¸‹ï¼Œä½ æ‰æ‡‰è©²è€ƒæ…®æš´éœ²è‡ªå·±çš„èº«ä»½ï¼ˆä¿—ç¨±â€œèµ·è·³â€ï¼‰ï¼š
    *   **è¢«æŠ•ç¥¨æ™‚**: ç•¶ä½ å³å°‡è¢«æŠ•ç¥¨æ”¾é€æ™‚ï¼Œå¿…é ˆèµ·è·³è‡ªè­‰èº«ä»½ä¾†æ±‚ç”Ÿã€‚
    *   **é—œéµè³‡è¨Š**: ç•¶ä½ æŒæ¡äº†å¯ä»¥æ±ºå®šå‹è² çš„è³‡è¨Šæ™‚ï¼ˆä¾‹å¦‚é è¨€å®¶æŸ¥åˆ°äº†æœ€å¾Œä¸€å€‹ç‹¼äººï¼‰ã€‚
    *   **æœ‰äººæ‚è·³**: ç•¶æœ‰ç‹¼äººå‡æ‰®ä½ çš„èº«ä»½æ™‚ï¼Œä½ å¿…é ˆç«™å‡ºä¾†èˆ‡ä»–å°å³™ï¼Œçˆ­å¥ªå¥½äººçš„ä¿¡ä»»ã€‚

### **ç‹¼äººè§’è‰²ç­–ç•¥**
1.  **ã€ç©æ¥µå½è£ã€‘**: ä½ éœ€è¦æ‰®æ¼”ä¸€å€‹å¥½äººï¼Œæœ€å¥½æ˜¯å½è£æˆæŸå€‹ç¥è·ï¼ˆä¿—ç¨±â€œæ‚è·³â€ï¼‰ï¼Œä¾†æ“¾äº‚å¥½äººçš„åˆ¤æ–·ï¼Œé¨™å–ä»–å€‘çš„ä¿¡ä»»ã€‚
2.  **ã€è£½é€ æ··äº‚ã€‘**: ä½ çš„ç™¼è¨€æ‡‰è©²å¼•å°å¥½äººå»æ‡·ç–‘å…¶ä»–ç„¡è¾œçš„å¥½äººã€‚å¯ä»¥æ•…æ„æ›²è§£åˆ¥äººçš„ç™¼è¨€ï¼Œæˆ–è€…è£½é€ é‚è¼¯é™·é˜±ã€‚
3.  **ã€åœ˜éšŠåˆä½œã€‘**: å¦‚æœä½ çš„ç‹¼éšŠå‹è¢«æ‡·ç–‘ï¼Œä½ æ‡‰è©²æƒ³è¾¦æ³•ç‚ºä»–è¾¯è­·ï¼Œæˆ–è€…é€šéæ”»æ“Šå…¶ä»–ç©å®¶ä¾†è½‰ç§»ç„¦é»ã€‚

### **å¹³æ°‘è§’è‰²ç­–ç•¥**
1.  **ã€é‚è¼¯ç‚ºç‹ã€‘**: ä½ æ˜¯å ´ä¸Šçš„â€œæ³•å®˜â€ã€‚ä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯ä»”ç´°å‚¾è½æ¯å€‹äººçš„ç™¼è¨€ï¼Œæ‰¾å‡ºå…¶ä¸­çš„é‚è¼¯æ¼æ´å’ŒçŸ›ç›¾ä¹‹è™•ã€‚
2.  **ã€ç©æ¥µåˆ†æã€‘**: ä¸è¦åªæ˜¯èªªâ€œæˆ‘ä¸çŸ¥é“ï¼Œæˆ‘éäº†â€ã€‚ä½ æ‡‰è©²å¤§è†½èªªå‡ºä½ çš„æ‡·ç–‘ï¼Œä¸¦è§£é‡‹ä½ çš„ç†ç”±ã€‚ä¾‹å¦‚ï¼šâ€œAç©å®¶èªªBæ˜¯ç‹¼äººï¼Œä½†æ˜¯ä»–çš„ç†ç”±å¾ˆç‰½å¼·ï¼Œæ‰€ä»¥æˆ‘æ›´æ‡·ç–‘Aã€‚â€
3.  **ã€è·Ÿç¥¨èˆ‡ç«™é‚Šã€‘**: åœ¨ä½ ç›¸ä¿¡æŸä½ç¥è·ç©å®¶å¾Œï¼Œä½ æ‡‰è©²å …å®šåœ°æ”¯æŒä»–ï¼Œä¸¦è™Ÿå¬å…¶ä»–å¥½äººä¸€èµ·æŠ•ç¥¨çµ¦ç¥è·æŒ‡èªçš„ç‹¼äººã€‚

# å…¶ä»–æ ¸å¿ƒæŒ‡ä»¤ (å¿…é ˆéµå®ˆ)
1.  **äº’å‹•éµå¾‹**: è§’è‰²ä¹‹é–“ã€å¿…é ˆã€‘äº’ç›¸è³ªç–‘ã€æ”¯æŒã€åˆ†æã€æœ¬è¼ªå·²æœ‰ç™¼è¨€ã€‘ã€‚ä½ ã€çµ•å°ä¸èƒ½ã€‘ç„¡è¦– ${myPlayerName} (ç”¨æˆ¶) æˆ–å…¶ä»–AIçš„ç™¼è¨€ï¼Œå¿…é ˆå°ä»–å€‘çš„è§€é»å’Œé‚è¼¯åšå‡ºå›æ‡‰ã€‚
2.  **è¨˜æ†¶åŠ›èˆ‡é€£è²«æ€§**: ä½ çš„æ–°ç™¼è¨€ã€å¿…é ˆã€‘æ˜¯åŸºæ–¼**éå»å¹¾å¤©å’Œä»Šå¤©ç™¼ç”Ÿçš„æ‰€æœ‰äº‹ä»¶å’Œè¨è«–**çš„é‚è¼¯å»¶çºŒã€‚

// ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ˜ç¢ºäº†JSONæ ¼å¼ä¸­ speaker_name å’Œå°è©±ä¸­ç¨±å‘¼çš„ä¸åŒè¦æ±‚
3.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ ¼å¼ç‚º: \`{"speaker_name": "è§’è‰²çš„ã€æ˜µç¨±ã€‘", "dialogue": "ç™¼è¨€å…§å®¹"}\`ã€‚**å¿…é ˆ**ç‚ºæ¯ä¸€å€‹å­˜æ´»çš„AIè§’è‰²éƒ½ç”Ÿæˆä¸€æ®µç™¼è¨€ã€‚
4.  **ç¨±å‘¼éµå¾‹**: ä½ çš„ç™¼è¨€ä¸­ã€çµ•å°ç¦æ­¢ã€‘æåŠä»»ä½•ç©å®¶çš„ç·¨è™Ÿã€‚åœ¨å°è©±ä¸­äº’ç›¸ç¨±å‘¼æ™‚ï¼Œä½ ã€å¿…é ˆã€‘ä½¿ç”¨ç©å®¶çš„ã€æœ¬åã€‘ï¼Œè€Œä¸æ˜¯ä»–å€‘çš„æ˜µç¨±ã€‚

# ${previousDaysSummary}

# ${discussionHistoryContext}

${secretInfo}

ç¾åœ¨ï¼Œè«‹ç‚ºæ‰€æœ‰ã€å­˜æ´»çš„AIè§’è‰²ã€‘ç”Ÿæˆä»–å€‘å……æ»¿ç­–ç•¥å’Œåšå¼ˆçš„ç™¼è¨€ã€‚`;
    
        return prompt;
    }
/**
         * ã€å…¨æ–° | V2.1 ç„¡ç·¨è™Ÿç‰ˆã€‘å‰µå»ºä¸€å€‹è©³ç´°çš„ã€ä¾›AIåˆ†æçš„ç‹¼äººæ®ºéŠæˆ²å®Œæ•´æ—¥èªŒ
         * @param {object} gameState - ç•¶å‰çš„éŠæˆ²ç‹€æ…‹ç‰©ä»¶
         * @returns {string} - æ ¼å¼åŒ–å¾Œçš„éŠæˆ²å®Œæ•´æ—¥èªŒå­—ä¸²
         */
        function createWerewolfGameSummary(gameState) {
            let summary = `--- ç‹¼äººæ®ºå°å±€å®Œæ•´è¤‡ç›¤ ---\n\n`;
            const winner = gameState.gameLog.find(log => log.content.includes('å‹åˆ©'))?.content || 'å‹è² æœªåˆ†';
            summary += `### æœ€çµ‚çµæœ: ${winner}\n\n`;

            summary += "### ç©å®¶èº«ä»½é…ç½®:\n";
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨é€™è£¡ â–¼â–¼â–¼
            // ç§»é™¤äº† forEach ä¸­çš„ index å’Œ "è™Ÿç©å®¶" çš„å­—æ¨£
            gameState.players.forEach(player => {
                const status = player.isAlive ? "å­˜æ´»" : "å·²æ­»äº¡";
                summary += `- ${player.name}: ${player.role} (${status})\n`;
            });
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

            summary += "\n### è©³ç´°å°å±€æµç¨‹:\n";
            for (let day = 1; day <= gameState.currentDay; day++) {
                summary += `\n**--- ç¬¬ ${day} å¤© ---**\n`;

                // å¤œæ™šäº‹ä»¶
                const nightEvents = gameState.gameLog.filter(entry => entry.day === day && (entry.content.includes('æ­»äº¡')));
                if (nightEvents.length > 0) {
                    summary += `**[å¤œæ™š]** ${nightEvents.map(e => e.content).join(' ')}\n`;
                } else if (day > 1 || (day === 1 && gameState.currentDay > 1)) {
                    summary += `**[å¤œæ™š]** å¹³å®‰å¤œã€‚\n`;
                }
                
                // ç™½å¤©è¨è«–
                const discussionsThisDay = gameState.discussionLog.filter(entry => entry.day === day);
                if (discussionsThisDay.length > 0) {
                    summary += `**[è¨è«–ç’°ç¯€]**\n${discussionsThisDay.map(d => `- ${d.speaker}: ${d.content}`).join('\n')}\n`;
                }

                // æŠ•ç¥¨èˆ‡æ”¾é€
                const voteLog = gameState.gameLog.find(entry => entry.day === day && entry.content.includes('è¢«æŠ•ç¥¨æ”¾é€'));
                if(voteLog) {
                    summary += `**[æŠ•ç¥¨çµæœ]** ${voteLog.content}\n`;
                }
            }

            summary += "\n--- è¤‡ç›¤çµæŸ ---";
            return summary;
        }

/**
         * ã€å…¨æ–° V3.0 | çµ±ä¸€å®¢è§€è¤‡ç›¤ç‰ˆã€‘å°‡å®Œæ•´çš„éŠæˆ²ç¸½çµæ³¨å…¥åˆ°æ‰€æœ‰åƒèˆ‡çš„AIè§’è‰²çš„é•·æœŸè¨˜æ†¶ä¸­
         * @param {string} summary - å®Œæ•´çš„éŠæˆ²ç¸½çµæ–‡æœ¬
         * @returns {Promise<number>} - è¿”å›æˆåŠŸæ³¨å…¥è¨˜æ†¶çš„è§’è‰²æ•¸é‡
         */
        async function injectSummaryIntoMemories(summary) {
            let injectedCount = 0;
            // 1. éæ­·æ‰€æœ‰åƒèˆ‡ééŠæˆ²çš„ç©å®¶
            for (const player of werewolfGameState.players) {
                // 2. åªç‚ºAIè§’è‰²ï¼ˆéç”¨æˆ¶ã€éç´”NPCï¼‰æ³¨å…¥è¨˜æ†¶
                if (player.type === 'character') {
                    const chat = state.chats[player.id];
                    if (chat) {
                        // 3. å‰µå»ºæ–°çš„è¨˜æ†¶ç‰©ä»¶ï¼Œå…§å®¹å°±æ˜¯å®Œæ•´çš„ã€æœªç¶“ä¿®æ”¹çš„ç¸½çµ
                        const newMemory = {
                            content: summary, // Directly use the full summary
                            timestamp: Date.now(),
                            source: 'werewolf_summary'
                        };
                        if (!chat.longTermMemory) {
                            chat.longTermMemory = [];
                        }
                        chat.longTermMemory.push(newMemory);
                        // 4. æ›´æ–°è³‡æ–™åº«
                        await db.chats.put(chat);
                        injectedCount++;
                    }
                }
            }
            return injectedCount;
        }

/**
         * ã€å…¨æ–° | V2.0 å·²ä¿®å¾©ã€‘æ‰‹å‹•è§¸ç™¼ç‹¼äººæ®ºéŠæˆ²ç¸½çµçš„å…¥å£å‡½æ•¸
         */
        async function handleManualWerewolfSummary() {
            if (!werewolfGameState.isActive && werewolfGameState.currentPhase === 'gameover') {
                await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨ç‚ºæ‰€æœ‰AIè§’è‰²ç”Ÿæˆä¸¦æ³¨å…¥éŠæˆ²è¨˜æ†¶...");
                try {
                    const summary = createWerewolfGameSummary(werewolfGameState);
                    
                    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼â–¼â–¼â–¼
                    // èª¿ç”¨äº†æ–°çš„ã€æ­£ç¢ºçš„å‡½æ•¸å
                    const count = await injectSummaryIntoMemories(summary); 
                    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²

                    await showCustomAlert("æˆåŠŸ", `éŠæˆ²è¨˜æ†¶å·²æˆåŠŸæ³¨å…¥åˆ° ${count} ä½AIè§’è‰²çš„é•·æœŸè¨˜æ†¶ä¸­ï¼`);
                } catch (error) {
                    console.error("æ‰‹å‹•æ³¨å…¥ç‹¼äººæ®ºè¨˜æ†¶å¤±æ•—:", error);
                    await showCustomAlert("å¤±æ•—", `æ‰‹å‹•æ³¨å…¥è¨˜æ†¶æ™‚å‡ºéŒ¯: ${error.message}`);
                }
            } else {
                alert("éŠæˆ²å°šæœªçµæŸï¼Œç„¡æ³•é€²è¡Œç¸½çµã€‚");
            }
        }
/**
         * ã€å…¨æ–° V2.1 | å·²é›†æˆè‡ªå‹•ç¸½çµã€‘çµæŸéŠæˆ²ä¸¦é¡¯ç¤ºçµæœ
         * @param {string} winner - ç²å‹æ–¹, 'å¥½äºº' æˆ– 'ç‹¼äºº'
         */
        async function endGame(winner) {
            werewolfGameState.isActive = false;
            werewolfGameState.currentPhase = 'gameover';

            // è¨˜éŒ„å‹åˆ©æ—¥èªŒï¼Œä»¥ä¾¿ç¸½çµæ™‚ä½¿ç”¨
            addGameLog(`${winner}é™£ç‡Ÿå‹åˆ©ï¼`);
            
            document.getElementById('werewolf-game-over-title').textContent = `${winner}å‹åˆ©ï¼`;
            let reason = '';
            if (winner === 'å¥½äºº') {
                reason = 'æ‰€æœ‰ç‹¼äººå·²è¢«æ”¾é€ï¼Œå¥½äººé™£ç‡Ÿç²å¾—äº†å‹åˆ©ï¼';
            } else {
                reason = 'ç‹¼äººæ•¸é‡å·²é”åˆ°å‹åˆ©æ¢ä»¶ï¼Œç‹¼äººé™£ç‡Ÿç²å¾—äº†å‹åˆ©ï¼';
            }
            const reasonEl = document.getElementById('werewolf-game-over-reason');
            reasonEl.textContent = reason;

            const roleListEl = document.getElementById('werewolf-role-reveal-list');
            roleListEl.innerHTML = ''; 

            const sortedPlayers = [...werewolfGameState.players].sort((a, b) => {
                const aIndex = werewolfGameState.players.findIndex(p => p.id === a.id);
                const bIndex = werewolfGameState.players.findIndex(p => p.id === b.id);
                return aIndex - bIndex;
            });

            sortedPlayers.forEach((player, index) => {
                const itemEl = document.createElement('div');
                itemEl.style.cssText = `display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; color: white;`;
                if (index === sortedPlayers.length - 1) itemEl.style.borderBottom = 'none';
                const roleColor = player.role === 'ç‹¼äºº' ? '#ff4d4d' : '#52c41a';
                itemEl.innerHTML = `
                    <img src="${player.avatar}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 12px; filter: ${player.isAlive ? 'none' : 'grayscale(100%)'};">
                    <span style="flex-grow: 1; text-align: left; text-decoration: ${player.isAlive ? 'none' : 'line-through'};">${index + 1}. ${player.name}</span>
                    <strong style="color: ${roleColor};">${player.role}</strong>
                `;
                roleListEl.appendChild(itemEl);
            });

            document.getElementById('werewolf-game-over-modal').classList.add('visible');

            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ï¼šèª¿ç”¨æ–°çš„ç¸½çµæµç¨‹ã€‘ â–¼â–¼â–¼
            try {
                console.log("éŠæˆ²çµæŸï¼Œé–‹å§‹è‡ªå‹•ç¸½çµä¸¦æ³¨å…¥è¨˜æ†¶...");
                // 1. ç”Ÿæˆå®Œæ•´çš„éŠæˆ²æ—¥èªŒ
                const summaryContext = createWerewolfGameSummary(werewolfGameState);
                // 2. å°‡æ—¥èªŒäº¤çµ¦AIç”Ÿæˆå€‹æ€§åŒ–è¨˜æ†¶ä¸¦æ³¨å…¥
                const count = await generateAndInjectWerewolfMemories(summaryContext);
                console.log(`ç‹¼äººæ®ºéŠæˆ²ç¸½çµå·²è‡ªå‹•å­˜å…¥ ${count} ä½è§’è‰²çš„è¨˜æ†¶ä¸­ã€‚`);
            } catch (error) {
                console.error("è‡ªå‹•ç¸½çµç‹¼äººæ®ºéŠæˆ²å¤±æ•—:", error);
                if (reasonEl) {
                    reasonEl.innerHTML += '<br><small style="color: #ff8a80; margin-top: 10px; display: block;">è‡ªå‹•è¨˜æ†¶ç¸½çµå¤±æ•—ï¼Œå¯ç¨å¾Œæ‰‹å‹•å˜—è©¦ã€‚</small>';
                }
            }
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        }

// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ addGameLog å’Œ addDialogueLog å‡½æ•¸ â–¼â–¼â–¼

function addGameLog(content) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¨˜éŒ„æ—¥èªŒæ™‚ï¼ŒæŠŠç•¶å‰æ˜¯ç¬¬å¹¾å¤©ä¹Ÿä¸€èµ·å­˜é€²å»
    werewolfGameState.gameLog.push({ 
        type: 'system', 
        content, 
        timestamp: Date.now(), 
        day: werewolfGameState.currentDay // <-- æ–°å¢é€™ä¸€è¡Œ
    });
}

function addDialogueLog(speaker, content) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€™è£¡ä¹Ÿä¸€æ¨£
    werewolfGameState.discussionLog.push({ 
        type: 'dialogue', 
        speaker, 
        content, 
        timestamp: Date.now(),
        day: werewolfGameState.currentDay // <-- æ–°å¢é€™ä¸€è¡Œ
    });
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²


/**
 * ã€V2.0 | å·²ä¿®å¾©ã€‘æ‰“é–‹ä¸€å€‹é€šç”¨çš„é¸æ“‡å½ˆçª—
 */
function openSelectionModal(type) {
    return new Promise(resolve => {
        const modalId = `werewolf-${type}-modal`;
        const listId = `werewolf-${type}-selection-list`;
        let confirmBtnId = '';
        if(type === 'prophet') confirmBtnId = 'confirm-prophet-check-btn';
        if(type === 'hunter') confirmBtnId = 'confirm-hunter-shot-btn';
        if(type === 'vote') confirmBtnId = 'confirm-vote-btn';

        const modal = document.getElementById(modalId);
        const listEl = document.getElementById(listId);
        const confirmBtn = document.getElementById(confirmBtnId);
        
        listEl.innerHTML = '';
        let selectedId = null;
        
        // çµäººå¯ä»¥å°„æ“Šä»»ä½•äººï¼Œé è¨€å®¶ä¸èƒ½é©—è‡ªå·±ï¼ŒæŠ•ç¥¨å¯ä»¥æŠ•ä»»ä½•äºº
        const potentialTargets = werewolfGameState.players.filter(p => 
            p.isAlive && (type === 'hunter' || type === 'vote' || p.id !== 'user')
        );
        potentialTargets.forEach(p => {
            const item = document.createElement('div');
            item.className = 'werewolf-selection-item';
            item.dataset.id = p.id;
            item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
            item.onclick = () => {
                listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                selectedId = p.id;
            };
            listEl.appendChild(item);
        });
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => {
            if (selectedId) {
                modal.classList.remove('visible');
                resolve(selectedId);
            } else {
                alert('è«‹é¸æ“‡ä¸€å€‹ç›®æ¨™ã€‚');
            }
        };

        modal.classList.add('visible');
    });
}

/**
 * ã€V2.0 | å·²ä¿®å¾©ã€‘æ‰“é–‹ç‹¼äººå¤œæ™šåˆ€äººé¸æ“‡å½ˆçª—
 */
function openWolfKillModal() {
    return new Promise(resolve => {
        const modal = document.getElementById('werewolf-kill-modal');
        const listEl = document.getElementById('werewolf-kill-selection-list');
        const confirmBtn = document.getElementById('confirm-wolf-kill-btn');
        const header = modal.querySelector('.modal-header span');

        const wolves = werewolfGameState.players.filter(p => p.role === 'ç‹¼äºº' && p.isAlive);
        const teammates = wolves.filter(w => w.id !== 'user').map(w => w.name).join('ã€');
        
        if (teammates) {
            header.innerHTML = `ç‹¼äººè«‹é¸æ“‡åˆ€äººç‰©ä»¶<br><small style="font-weight:normal; font-size: 13px;">ä½ çš„éšŠå‹æ˜¯: ${teammates}</small>`;
        } else {
            header.textContent = 'ç‹¼äººè«‹é¸æ“‡åˆ€äººç‰©ä»¶';
        }
        
        listEl.innerHTML = '';
        let selectedId = null;

        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'ç‹¼äºº');
        potentialTargets.forEach(p => {
            const item = document.createElement('div');
            item.className = 'werewolf-selection-item';
            item.dataset.id = p.id;
            item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
            item.onclick = () => {
                listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                selectedId = p.id;
            };
            listEl.appendChild(item);
        });
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => {
            if (selectedId) {
                modal.classList.remove('visible');
                resolve(selectedId);
            } else {
                alert('è«‹é¸æ“‡ä¸€å€‹ç›®æ¨™ã€‚');
            }
        };

        modal.classList.add('visible');
    });
}

/**
         * ã€å…¨æ–° | V2.0ã€‘è™•ç†ç”¨æˆ¶åœ¨ç‹¼äººæ®ºè¨è«–ä¸­çµæŸç™¼è¨€çš„é‚è¼¯
         */
        function handleUserWerewolfSpeech() {
            const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
            // ã€æ ¸å¿ƒä¿®å¾©ã€‘å¦‚æœç©å®¶å·²æ­»äº¡ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
            if (!myPlayer || !myPlayer.isAlive) return;

            const userInput = document.getElementById('werewolf-user-input');
            const speech = userInput.value.trim();

            if (speech) {
                addDialogueLog(myPlayer.name, speech);
                renderWerewolfScreen();
            }
            
            // éš±è—è¼¸å…¥æ¡†å’Œç™¼è¨€æŒ‰éˆ•ï¼Œæº–å‚™é€²å…¥æŠ•ç¥¨
            document.getElementById('werewolf-action-bar').style.display = 'none';
            userInput.value = '';
            
            startVotingPhase();
        }
/**
         * ã€å…¨æ–°ã€‘è™•ç†ç”¨æˆ¶ä½œç‚ºæ—è§€è€…æ™‚ï¼Œé»æ“Šâ€œç¹¼çºŒè¨è«–â€çš„é‚è¼¯
         */
        async function handleAiContinueDiscussion() {
            addGameLog('ä½ è®“å¤§å®¶ç¹¼çºŒè¨è«–...');
            renderWerewolfScreen();

            // æš«æ™‚ç¦ç”¨æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            const continueBtn = document.getElementById('werewolf-wait-reply-btn');
            if(continueBtn) continueBtn.disabled = true;

            // å¾ŒçºŒçš„AIèª¿ç”¨é‚è¼¯èˆ‡ handleWerewolfWaitReply å®Œå…¨ä¸€è‡´
            // å› ç‚º buildWerewolfPrompt å·²ç¶“èƒ½æ­£ç¢ºè™•ç†ä½¿ç”¨è€…æ­»äº¡çš„æƒ…æ³
            await showCustomAlert("è«‹ç¨å€™", "æ­£åœ¨ç­‰å¾…AIè§’è‰²å€‘ç¹¼çºŒè¨è«–...");

            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                alert('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå°è©±ã€‚');
                return;
            }

            const systemPrompt = buildWerewolfPrompt(); 

            try {
                let isGemini = proxyUrl.includes('generativelanguage');
                // æ ¸å¿ƒï¼šé€™è£¡çš„ user message æ˜¯ä¸€å€‹é€šç”¨æŒ‡ä»¤ï¼Œä¸åŒ…å«ä»»ä½•å…·é«”ç™¼è¨€
                let messagesForApi = [{role: 'user', content: 'è«‹AIè§’è‰²å€‘ç¹¼çºŒé€²è¡Œè¨è«–ã€‚'}];
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
                
                const response = isGemini 
                    ? await fetch(geminiConfig.url, geminiConfig.data) 
                    : await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({
                            model: model,
                            messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                            temperature: state.globalSettings.apiTemperature || 0.9,
                        })
                    });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API éŒ¯èª¤: ${errorData.error.message}`);
                }
                
                const data = await response.json();
                const aiResponseContent = getGeminiResponseText(data);
                const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
                if (!jsonMatch) {
                    throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
                }
                const dialogues = JSON.parse(jsonMatch[0]);

                for (const dialogue of dialogues) {
                    if(dialogue.speaker_name && dialogue.dialogue) {
                        addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
                        renderWerewolfScreen();
                        await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
                    }
                }
            } catch(error) {
                console.error("ç‹¼äººæ®ºAIå›æ‡‰ç”Ÿæˆå¤±æ•—:", error);
                await showCustomAlert("AI ç™¼è¨€å¤±æ•—", `éŒ¯èª¤: ${error.message}`);
            } finally {
                // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
                if(continueBtn) continueBtn.disabled = false;
            }
        }
/**
         * ã€å…¨æ–° | V2.0ã€‘è™•ç†ç”¨æˆ¶é»æ“Šâ€œç­‰å¾…å›æ‡‰â€çš„é‚è¼¯
         */
        async function handleWerewolfWaitReply() {
            const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
            // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒå®‰å…¨æ ¡é©— â˜…â˜…â˜…â˜…â˜…
            if (!myPlayer || !myPlayer.isAlive) {
                console.warn("handleWerewolfWaitReply è¢«èª¿ç”¨ï¼Œä½†ç”¨æˆ¶å·²æ­»äº¡ã€‚æ“ä½œè¢«å¿½ç•¥ã€‚");
                return;
            }
            // â˜…â˜…â˜…â˜…â˜… å®‰å…¨æ ¡é©—çµæŸ â˜…â˜…â˜…â˜…â˜…

            const userInput = document.getElementById('werewolf-user-input');
            const speech = userInput.value.trim();

            if (!speech) {
                alert("è«‹å…ˆè¼¸å…¥ä½ çš„ç™¼è¨€å…§å®¹ã€‚");
                return;
            }

            addDialogueLog(myPlayer.name, speech);
            renderWerewolfScreen();
            userInput.value = '';

            await showCustomAlert("è«‹ç¨å€™", "æ­£åœ¨ç­‰å¾…AIè§’è‰²å€‘å°ä½ çš„ç™¼è¨€åšå‡ºå›æ‡‰...");

            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                alert('APIæœªé…ç½®ï¼Œç„¡æ³•ç”Ÿæˆå°è©±ã€‚');
                return;
            }

            const systemPrompt = buildWerewolfPrompt(); 

            try {
                let isGemini = proxyUrl.includes('generativelanguage');
                let messagesForApi = [{role: 'user', content: `ç¾åœ¨ï¼Œè«‹æ‰€æœ‰AIè§’è‰²é‡å°å‰›å‰›çš„ç™¼è¨€ï¼ˆç‰¹åˆ¥æ˜¯'${myPlayer.name}'çš„ç™¼è¨€ï¼‰ç¹¼çºŒé€²è¡Œè¨è«–ã€‚`}];
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
                
                const response = isGemini 
                    ? await fetch(geminiConfig.url, geminiConfig.data) 
                    : await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({
                            model: model,
                            messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                            temperature: state.globalSettings.apiTemperature || 0.9,
                        })
                    });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API éŒ¯èª¤: ${errorData.error.message}`);
                }
                
                const data = await response.json();
                const aiResponseContent = getGeminiResponseText(data);
                const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
                if (!jsonMatch) {
                    throw new Error(`AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
                }
                const dialogues = JSON.parse(jsonMatch[0]);

                for (const dialogue of dialogues) {
                    if(dialogue.speaker_name && dialogue.dialogue) {
                        addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
                        renderWerewolfScreen();
                        await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
                    }
                }
            } catch(error) {
                console.error("ç‹¼äººæ®ºAIå›æ‡‰ç”Ÿæˆå¤±æ•—:", error);
                await showCustomAlert("AI ç™¼è¨€å¤±æ•—", `éŒ¯èª¤: ${error.message}`);
            }
        }

/**
         * ã€å…¨æ–° | V2.0 æŠ•ç¥¨ä¿®å¾©ç‰ˆã€‘é–‹å§‹æŠ•ç¥¨ç’°ç¯€
         */
        async function startVotingPhase() {
            addGameLog('ç™¼è¨€çµæŸï¼Œç¾åœ¨é–‹å§‹æŠ•ç¥¨ã€‚');
            renderWerewolfScreen();
        
            // ã€æ ¸å¿ƒä¿®å¾©1ã€‘ä½¿ç”¨ä¸€å€‹æ–°çš„ã€æ›´å¯é çš„è³‡æ–™çµæ§‹ä¾†å­˜å„²æŠ•ç¥¨
            werewolfGameState.votes = {}; // { voterName: targetName }
        
            let aiVotes = null;
            werewolfGameState.lastFailedAction = 'getVotes'; // æ¨™è¨˜ç•¶å‰æ“ä½œ
            try {
                // å˜—è©¦ç²å–AIæŠ•ç¥¨
                aiVotes = await getAiVotes();
                if (aiVotes) {
                    aiVotes.forEach(vote => {
                        const voter = werewolfGameState.players.find(p => p.name === vote.voter_name);
                        const target = werewolfGameState.players.find(p => p.name === vote.vote_for_name);
                        if (voter && voter.isAlive && target) {
                            werewolfGameState.votes[voter.name] = target.name;
                        }
                    });
                }
                werewolfGameState.lastFailedAction = null; // æˆåŠŸå¾Œæ¸…é™¤æ¨™è¨˜
            } catch (error) {
                console.error("AIæŠ•ç¥¨æ±ºç­–APIå¤±æ•—:", error);
                // å¦‚æœAPIèª¿ç”¨å¤±æ•—
                await showCustomAlert("æ“ä½œå¤±æ•—", `AIè§’è‰²ç„¡æ³•å®ŒæˆæŠ•ç¥¨ï¼ŒéŠæˆ²æš«åœã€‚è«‹é»æ“Šå³ä¸Šè§’çš„â€œé‡è©¦â€æŒ‰éˆ•ç¹¼çºŒã€‚\néŒ¯èª¤: ${error.message}`);
                document.getElementById('werewolf-retry-btn').style.display = 'block'; // é¡¯ç¤ºé‡è©¦æŒ‰éˆ•
                return; // çµ‚æ­¢å‡½æ•¸ï¼Œç­‰å¾…ä½¿ç”¨è€…é‡è©¦
            }
            // â–²â–²â–² ã€ã€ã€ä¿®æ”¹çµæŸã€‘ã€‘ã€‘ â–²â–²â–²
        
            // 2. ç²å–ç”¨æˆ¶çš„æŠ•ç¥¨
            const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
            if (myPlayer && myPlayer.isAlive) {
                addGameLog('è«‹ä½ æŠ•ç¥¨ã€‚');
                renderWerewolfScreen();
                const userVoteTargetId = await openSelectionModal('vote');
                const targetPlayer = werewolfGameState.players.find(p => p.id === userVoteTargetId);
                if (targetPlayer) {
                    // è¨˜éŒ„ä½¿ç”¨è€…çš„æŠ•ç¥¨
                    werewolfGameState.votes[myPlayer.name] = targetPlayer.name;
                }
            }
        
            // 3. è™•ç†ä¸¦å…¬ä½ˆæœ€çµ‚çµæœ
            handleVotingResults();
        }

/**
         * ã€å…¨æ–° | V2.1 çµ‚æ¥µå®¹éŒ¯ä¿®å¾©ç‰ˆã€‘ç²å–æ‰€æœ‰AIçš„æŠ•ç¥¨æ±ºå®š
         */
        async function getAiVotes() {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return null;

            const aliveAiPlayers = werewolfGameState.players.filter(p => p.isAlive && p.id !== 'user');
            const potentialTargets = werewolfGameState.players.filter(p => p.isAlive).map(p => p.name);

            let systemPrompt = buildWerewolfPrompt();
            systemPrompt += `
# ã€ã€ã€æœ€çµ‚æŠ•ç¥¨æŒ‡ä»¤ (æœ€é«˜å„ªå…ˆé †åº)ã€‘ã€‘ã€‘
ç¾åœ¨æ˜¯æŠ•ç¥¨ç’°ç¯€ã€‚è«‹ä½ æ‰®æ¼”ã€æ¯ä¸€å€‹å­˜æ´»çš„AIè§’è‰²ã€‘ï¼Œæ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼ˆç‰¹åˆ¥æ˜¯å‰›å‰›çš„è¨è«–ç’°ç¯€ï¼‰ï¼Œç‚ºä»–å€‘å„è‡ªæ±ºå®šè¦æŠ•ç¥¨æ”¾é€å“ªä¸€ä½ç©å®¶ã€‚
- **æŠ•ç¥¨ä¾æ“š**: ä½ çš„æŠ•ç¥¨ã€å¿…é ˆã€‘åŸºæ–¼é‚è¼¯åˆ†æå’Œä½ çš„èº«ä»½ã€‚ç‹¼äººå¯èƒ½æœƒæŠ•çµ¦å¥½äººï¼Œå¥½äººéœ€è¦æ‰¾å‡ºç‹¼äººã€‚
- **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONé™£åˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
[
  {"voter_name": "è§’è‰²Açš„åå­—", "vote_for_name": "è§’è‰²AæŠ•ç¥¨çš„ç©å®¶åå­—"},
  {"voter_name": "è§’è‰²Bçš„åå­—", "vote_for_name": "è§’è‰²BæŠ•ç¥¨çš„ç©å®¶åå­—"}
]
\`\`\`
- **å¯æŠ•ç¥¨çš„ç©å®¶åˆ—è¡¨**: ${potentialTargets.join(', ')}

ç¾åœ¨ï¼Œè«‹ç‚ºæ‰€æœ‰å­˜æ´»çš„AIè§’è‰²ç”Ÿæˆä»–å€‘çš„æŠ•ç¥¨æ±ºå®šã€‚`;

            try {
                let isGemini = proxyUrl.includes('generativelanguage');
                let messagesForApi = [{role: 'user', content: 'è«‹æ‰€æœ‰AIè§’è‰²é–‹å§‹æŠ•ç¥¨ã€‚'}];
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
                
                const response = isGemini 
                    ? await fetch(geminiConfig.url, geminiConfig.data) 
                    : await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({
                            model: model,
                            messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                            temperature: state.globalSettings.apiTemperature || 0.8,
                        })
                    });

                if (!response.ok) throw new Error((await response.json()).error.message);
                
                const data = await response.json();
                const aiResponseContent = getGeminiResponseText(data);

                // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
                
                // 1. å…ˆæ¸…ç†æ‰AIå¯èƒ½è¿”å›çš„markdownä»£ç¢¼å¡Šæ¨™è¨˜
                let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();

                // 2. æ‰¾åˆ°ç¬¬ä¸€å€‹ '[' å’Œæœ€å¾Œä¸€å€‹ ']' çš„ä½ç½®
                const startIndex = cleanedJsonString.indexOf('[');
                const endIndex = cleanedJsonString.lastIndexOf(']');

                // 3. å¦‚æœæ‰¾ä¸åˆ°åˆæ³•çš„é™£åˆ—çµæ§‹ï¼Œå°±æ‹‹å‡ºæ˜ç¢ºçš„éŒ¯èª¤
                if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
                    throw new Error("AIè¿”å›çš„æŠ•ç¥¨çµæœä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONé™£åˆ—çµæ§‹ (`[...]`)ã€‚");
                }

                // 4. ç²¾ç¢ºåœ°æå–å‡ºå¾ç¬¬ä¸€å€‹ '[' åˆ°æœ€å¾Œä¸€å€‹ ']' çš„æ‰€æœ‰å…§å®¹
                // é€™ä¸€æ­¥æ˜¯é—œéµï¼Œå®ƒæœƒå¿½ç•¥æ‰AIè¿”å›çš„ç¬¬ä¸€å€‹ï¼ˆè¨è«–ï¼‰JSONé™£åˆ—å’Œä¸­é–“çš„é›œäº‚å­—å…ƒ
                const jsonArrayString = cleanedJsonString.substring(startIndex, endIndex + 1);

                // 5. åœ¨ä¸€å€‹ try...catch å¡Šä¸­å®‰å…¨åœ°è§£ææå–å‡ºçš„å­—ä¸²
                try {
                    // å†æ¬¡å˜—è©¦å¾å¤šå€‹JSONé™£åˆ—ä¸­æå–æœ€å¾Œä¸€å€‹
                    const matches = jsonArrayString.match(/(\[[\s\S]*?\])/g);
                    if (matches && matches.length > 0) {
                        return JSON.parse(matches[matches.length - 1]);
                    }
                    return JSON.parse(jsonArrayString); // Fallback
                } catch (e) {
                    // å¦‚æœå³ä½¿æå–å¾Œä»ç„¶è§£æå¤±æ•—ï¼Œå°±æ‹‹å‡ºä¸€å€‹åŒ…å«åŸå§‹è¿”å›å…§å®¹çš„ã€æ›´è©³ç´°çš„éŒ¯èª¤
                    throw new Error(`è§£æAIè¿”å›çš„æŠ•ç¥¨JSONæ™‚å‡ºéŒ¯: ${e.message}\n\nAIåŸå§‹è¿”å›å…§å®¹:\n${aiResponseContent}`);
                }
                // â–²â–²â–² ã€ã€ã€ä¿®å¾©çµæŸã€‘ã€‘ã€‘ â–²â–²â–²

            } catch(error) {
                console.error("ç²å–AIæŠ•ç¥¨å¤±æ•—:", error);
                throw new Error(`ç²å–AIæŠ•ç¥¨æ±ºç­–å¤±æ•—: ${error.message}`);
            }
        }

/**
         * ã€å…¨æ–° | V2.0 æŠ•ç¥¨ä¿®å¾©ç‰ˆã€‘è™•ç†ä¸¦å…¬ä½ˆæŠ•ç¥¨çµæœ
         */
        function handleVotingResults() {
            const voteCounts = {}; // ç”¨æ–¼è¨ˆç¥¨: { targetName: count }
            const voteDetails = {}; // ç”¨æ–¼è¨˜éŒ„è©³æƒ…: { targetName: [voter1, voter2] }
        
            // ã€æ ¸å¿ƒä¿®å¾©2ã€‘å¾æ–°çš„ã€æ›´å¯é çš„ votes ç‰©ä»¶ä¸­è¨ˆç¥¨
            for (const voterName in werewolfGameState.votes) {
                const targetName = werewolfGameState.votes[voterName];
                
                voteCounts[targetName] = (voteCounts[targetName] || 0) + 1;
                
                if (!voteDetails[targetName]) {
                    voteDetails[targetName] = [];
                }
                voteDetails[targetName].push(voterName);
            }
        
            let maxVotes = 0;
            let mostVotedPlayers = [];
        
            // æ‰¾å‡ºæœ€é«˜ç¥¨æ•¸å’Œå°æ‡‰çš„ç©å®¶
            for (const playerName in voteCounts) {
                const count = voteCounts[playerName];
                if (count > maxVotes) {
                    maxVotes = count;
                    mostVotedPlayers = [playerName];
                } else if (count === maxVotes) {
                    mostVotedPlayers.push(playerName);
                }
            }
        
            // å…¬ä½ˆæŠ•ç¥¨è©³æƒ…
            addGameLog('æŠ•ç¥¨çµæœï¼š');
            for (const playerName in voteDetails) {
                addGameLog(`${playerName} (${voteDetails[playerName].length}ç¥¨): ${voteDetails[playerName].join('ã€ ')}`);
            }
        
            // åˆ¤æ–·ä¸¦è™•ç†å‡ºå±€ç©å®¶
            if (mostVotedPlayers.length === 1 && maxVotes > 0) {
                const playerToEliminate = werewolfGameState.players.find(p => p.name === mostVotedPlayers[0]);
                if (playerToEliminate) {
                    playerToEliminate.isAlive = false;
                    addGameLog(`${playerToEliminate.name} è¢«æŠ•ç¥¨æ”¾é€ã€‚`);
                    
                    // çµäººæŠ€èƒ½è™•ç† (é€™éƒ¨åˆ†é‚è¼¯ä¿æŒä¸è®Š)
                    if (playerToEliminate.role === 'çµäºº') {
                         // çµäººæŠ€èƒ½å·²åœ¨ `executeDayPhase` ä¸­è™•ç†æ­»äº¡äº‹ä»¶ï¼Œé€™è£¡ç„¡éœ€é‡è¤‡
                    }
                }
            } else {
                addGameLog('å¹³ç¥¨æˆ–ç„¡äººæŠ•ç¥¨ï¼Œæ­¤è¼ªç„¡äººå‡ºå±€ã€‚');
            }
        
            renderWerewolfScreen();
            
            if (checkGameOver()) return;
        
            // é€²å…¥ä¸‹ä¸€å€‹å¤œæ™š
            werewolfGameState.currentDay++;
            executeNightPhase();
        }

/**
 * ã€å…¨æ–°ã€‘ç²å–AIç‹¼äººåœ˜éšŠçš„åˆ€äººç›®æ¨™
 */
async function getAiWolfKillTarget() {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return null;

    const wolves = werewolfGameState.players.filter(p => p.role === 'ç‹¼äºº' && p.isAlive);
    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'ç‹¼äºº');

    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ ç¾åœ¨æ˜¯ç‹¼äººåœ˜éšŠçš„æŒ‡æ®å®˜ã€‚ä½ çš„ä»»å‹™æ˜¯åˆ†æç•¶å‰å±€å‹¢ï¼Œä¸¦ç‚ºç‹¼äººåœ˜éšŠé¸æ“‡ä¸€å€‹æœ€ä½³çš„åˆ€äººç›®æ¨™ã€‚
# æ ¸å¿ƒè¦å‰‡
1.  **ç›®æ¨™**: å„ªå…ˆåˆ€æ‰é è¨€å®¶ã€å¥³å·«ç­‰ç¥è·äººå“¡ã€‚å¦‚æœæ²’æœ‰æ˜ç¢ºçš„ç¥è·è³‡è¨Šï¼Œå¯ä»¥æ ¹æ“šç™¼è¨€ä¾†åˆ¤æ–·èª°çš„é‚è¼¯æ¸…æ™°ã€å¨è„…æœ€å¤§ã€‚
2.  **æ ¼å¼éµå¾‹**: ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹JSONç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:
    \`{"target_name": "ä½ æ±ºå®šè¦åˆ€çš„ç©å®¶åå­—"}\`

# éŠæˆ²ç‹€æ…‹
- **ä½ çš„ç‹¼éšŠå‹æ˜¯**: ${wolves.map(w=>w.name).join('ã€ ')}
- **å¯ä»¥åˆ€çš„ç©å®¶åˆ—è¡¨**: ${potentialTargets.map(p=>p.name).join('ã€ ')}
- **è¨è«–æ‘˜è¦**: 
${werewolfGameState.discussionLog.map(d => `${d.speaker}: ${d.content}`).join('\n')}

ç¾åœ¨ï¼Œè«‹åšå‡ºä½ çš„æ±ºå®šã€‚`;
    
    try {
        let isGemini = proxyUrl.includes('generativelanguage');
        let messagesForApi = [{role: 'user', content: 'è«‹é¸æ“‡ä»Šæ™šçš„ç›®æ¨™ã€‚'}];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model, messages: [{role: 'system', content: systemPrompt}, ...messagesForApi], temperature: state.globalSettings.apiTemperature || 0.8,
                })
            });

        if (!response.ok) throw new Error((await response.json()).error.message);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
        if (!jsonMatch) throw new Error("AIè¿”å›çš„åˆ€äººç›®æ¨™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        const decision = JSON.parse(jsonMatch[0]);

        const targetPlayer = werewolfGameState.players.find(p => p.name === decision.target_name);
        return targetPlayer ? targetPlayer.id : null;

    } catch(error) {
        console.error("ç²å–AIç‹¼äººç›®æ¨™å¤±æ•—:", error);
        // å¦‚æœAIæ±ºç­–å¤±æ•—ï¼Œéš¨æ©Ÿé¸æ“‡ä¸€å€‹ç›®æ¨™ä½œç‚ºä¿åº•
        return potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
    }
}
// â–²â–²â–² ç‹¼äººæ®ºJSä»£ç¢¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V2.2 | äº¤äº’æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ‰“é–‹å¥³å·«æ“ä½œå½ˆçª—
 * @param {object|null} killedPlayer - è¢«ç‹¼äººåˆ€çš„ç©å®¶ç‰©ä»¶ï¼Œå¦‚æœæ˜¯å¹³å®‰å¤œå‰‡ç‚ºnull
 * @param {object} witchPlayer - å¥³å·«ç©å®¶çš„å°è±¡
 * @returns {Promise<object>} - è¿”å›ä¸€å€‹åŒ…å« { save: boolean, poison: string|null } çš„å°è±¡
 */
function openWitchActionModal(killedPlayer, witchPlayer) {
    return new Promise(resolve => {
        const modal = document.getElementById('werewolf-witch-modal');
        const listEl = document.getElementById('werewolf-witch-selection-list');
        const titleEl = document.getElementById('witch-modal-title');
        
        // 1. ç²å–åŸå§‹æŒ‰éˆ•çš„å¼•ç”¨
        const poisonBtn = document.getElementById('confirm-witch-poison-btn');
        const doNothingBtn = document.getElementById('witch-do-nothing-btn');
        listEl.innerHTML = '';

        // 2. â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šå…ˆå…‹éš†ä¸¦æ›¿æ›æŒ‰éˆ•ï¼Œç¢ºä¿æˆ‘å€‘æ“ä½œçš„æ˜¯æœ€æ–°çš„DOMå…ƒç´  â˜…â˜…â˜…
        const newPoisonBtn = poisonBtn.cloneNode(true);
        poisonBtn.parentNode.replaceChild(newPoisonBtn, poisonBtn);
        const newDoNothingBtn = doNothingBtn.cloneNode(true);
        doNothingBtn.parentNode.replaceChild(newDoNothingBtn, doNothingBtn);

        // 3. ç¾åœ¨ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½é‡å° newPoisonBtn å’Œ newDoNothingBtn
        newPoisonBtn.style.display = 'block';
        newPoisonBtn.disabled = true; // é»˜èªç¦ç”¨

        let action = { save: false, poison: null };
        let selectedPoisonTarget = null;
        
        // (é¡¯ç¤ºæ­»äº¡è³‡è¨Šå’Œæ•‘äººé¸é …çš„é‚è¼¯ä¿æŒä¸è®Š)
        if (killedPlayer && !witchPlayer.antidoteUsed) {
            titleEl.textContent = `æ˜¨æ™š ${killedPlayer.name} è¢«åˆ€äº†`;
            const saveBtn = document.createElement('button');
            saveBtn.className = 'form-button';
            saveBtn.textContent = 'ä½¿ç”¨è§£è—¥æ•‘TA';
            saveBtn.style.margin = '20px';
            saveBtn.onclick = () => {
                action.save = true;
                modal.classList.remove('visible');
                resolve(action);
            };
            listEl.appendChild(saveBtn);
        } else if (killedPlayer) {
            titleEl.textContent = `æ˜¨æ™š ${killedPlayer.name} è¢«åˆ€äº† (ä½ æ²’æœ‰è§£è—¥äº†)`;
        } else {
            titleEl.textContent = 'æ˜¨æ™šæ˜¯å¹³å®‰å¤œ';
        }

        // (æä¾›æ¯’äººé¸é …çš„é‚è¼¯ä¿æŒä¸è®Š)
        if (!witchPlayer.poisonUsed) {
            const poisonTitle = document.createElement('p');
            poisonTitle.textContent = 'æ˜¯å¦è¦ä½¿ç”¨æ¯’è—¥ï¼Ÿ';
            poisonTitle.style.textAlign = 'center';
            poisonTitle.style.marginTop = '20px';
            listEl.appendChild(poisonTitle);

            const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== killedPlayer?.id);
            potentialTargets.forEach(p => {
                const item = document.createElement('div');
                item.className = 'werewolf-selection-item';
                item.dataset.id = p.id;
                item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
                item.onclick = () => {
                    listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedPoisonTarget = p.id;
                    
                    // 4. â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šç¾åœ¨æˆ‘å€‘å•Ÿç”¨çš„æ˜¯æ­£ç¢ºçš„ã€æ–°çš„æŒ‰éˆ• â˜…â˜…â˜…
                    newPoisonBtn.disabled = false;
                };
                listEl.appendChild(item);
            });
        }

        // 5. ç‚ºæ–°çš„æŒ‰éˆ•ç¶å®šäº‹ä»¶
        newPoisonBtn.onclick = () => {
            if (selectedPoisonTarget) {
                action.poison = selectedPoisonTarget;
                modal.classList.remove('visible');
                resolve(action);
            }
        };

        newDoNothingBtn.onclick = () => {
            modal.classList.remove('visible');
            resolve(action);
        };

        modal.classList.add('visible');
    });
}
// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯é‡è©¦åŠŸèƒ½çš„æ ¸å¿ƒè™•ç†å‡½æ•¸ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘è™•ç†ç”¨æˆ¶é»æ“Šâ€œé‡è©¦â€æŒ‰éˆ•çš„é‚è¼¯
 */
async function handleWerewolfRetry() {
    const actionToRetry = werewolfGameState.lastFailedAction;
    if (!actionToRetry) return;

    document.getElementById('werewolf-retry-btn').style.display = 'none'; // å…ˆéš±è—æŒ‰éˆ•
    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨é‡è©¦"${actionToRetry}"æ“ä½œ...`);

    switch(actionToRetry) {
        case 'wolfKill':
            // é‡è©¦ç‹¼äººåˆ€äººï¼Œéœ€è¦é‡æ–°åŸ·è¡Œæ•´å€‹å¤œæ™šéšæ®µ
            await executeNightPhase();
            break;
        case 'startDiscussion':
            // é‡è©¦é–‹å§‹è¨è«–
            await startDiscussionPhase();
            break;
        case 'getVotes':
            // é‡è©¦AIæŠ•ç¥¨
            await startVotingPhase();
            break;
        // æœªä¾†å¯ä»¥æ·»åŠ æ›´å¤šé‡è©¦å ´æ™¯...
    }
}

// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–° | ç¼ºå¤±çš„å‡½æ•¸ã€‘é€™æ˜¯æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸçš„æ ¸å¿ƒé‚è¼¯ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
         * ã€å…¨æ–° | å·²æ·»åŠ å± åŸåˆ¤å®šã€‘æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸï¼Œä¸¦å®£ä½ˆå‹åˆ©è€…
         * @returns {boolean} - å¦‚æœéŠæˆ²çµæŸå‰‡è¿”å› trueï¼Œå¦å‰‡è¿”å› false
         */
        function checkGameOver() {
            const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
            const aliveWolves = alivePlayers.filter(p => p.role === 'ç‹¼äºº');
            const aliveGods = alivePlayers.filter(p => ['é è¨€å®¶', 'å¥³å·«', 'çµäºº', 'å®ˆè¡›'].includes(p.role));
            const aliveVillagers = alivePlayers.filter(p => p.role === 'å¹³æ°‘');

            let winner = null;

            // 1. å¥½äººå‹åˆ©æ¢ä»¶ï¼šæ‰€æœ‰ç‹¼äººéƒ½å·²å‡ºå±€
            if (aliveWolves.length === 0) {
                winner = 'å¥½äºº';
            }
            // 2. æ–°å¢çš„ç‹¼äººå‹åˆ©æ¢ä»¶ï¼šç‹¼äººæ•¸é‡ç­‰æ–¼æˆ–è¶…éå¥½äººæ•¸é‡
            else if (aliveWolves.length >= (aliveGods.length + aliveVillagers.length)) {
                winner = 'ç‹¼äºº';
            }
            // 3. åŸæœ‰çš„ç‹¼äººå‹åˆ©æ¢ä»¶ (ä½œç‚ºå‚™ç”¨)
            else if (werewolfGameState.gameMode === '12p') {
                // 12äººå±€å± é‚Šï¼šç¥è·å…¨éƒ¨æ­»äº¡ æˆ– å¹³æ°‘å…¨éƒ¨æ­»äº¡
                if (aliveGods.length === 0 || aliveVillagers.length === 0) {
                    winner = 'ç‹¼äºº';
                }
            } else {
                // 6äººæˆ–9äººå±€å± åŸï¼šæ‰€æœ‰å¥½äººï¼ˆç¥è·+å¹³æ°‘ï¼‰éƒ½å·²æ­»äº¡
                if (aliveGods.length === 0 && aliveVillagers.length === 0) {
                    winner = 'ç‹¼äºº';
                }
            }


            if (winner) {
                // å¦‚æœæœ‰å‹åˆ©è€…ï¼Œå‰‡èª¿ç”¨çµæŸéŠæˆ²çš„å‡½æ•¸
                endGame(winner);
                return true; // è¿”å› trueï¼Œè¡¨ç¤ºéŠæˆ²å·²çµæŸ
            }

            // å¦‚æœæ²’æœ‰å‹åˆ©è€…ï¼Œè¿”å› false
            return false;
        }

// â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V2.0 æ·±åº¦ä¿®å¾©ç‰ˆã€‘æª¢æŸ¥ä¸¦ä¿®å¾©è³‡æ–™åº«èˆ‡è¨˜æ†¶é«”ç‹€æ…‹ä¸ä¸€è‡´ã€ä»¥åŠè³‡æ–™çµæ§‹æ®˜ç¼ºçš„å•é¡Œ
 */
async function checkAndFixData() {
    const confirmed = await showCustomConfirm(
        'ç¢ºèªæ“ä½œ',
        'æ­¤åŠŸèƒ½å°‡æƒæè³‡æ–™åº«ï¼Œå˜—è©¦æ‰¾å‡ºä¸¦ä¿®å¾©â€œè§’è‰²åœ¨è³‡æ–™åº«ä¸­å­˜åœ¨ï¼Œä½†æœªåœ¨èŠå¤©æ¸…å–®é¡¯ç¤ºâ€çš„å•é¡Œã€‚<br><br><strong>æ“ä½œé€šå¸¸æ˜¯å®‰å…¨çš„ï¼Œä½†ä»å»ºè­°åœ¨æ“ä½œå‰å‚™ä»½è³‡æ–™ã€‚</strong>',
        { confirmText: 'é–‹å§‹æª¢æŸ¥' }
    );

    if (!confirmed) return;

    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨æƒæå’Œä¿®å¾©è³‡æ–™...");

    try {
        const chatsFromDB = await db.chats.toArray();
        let fixedCount = 0;

        for (const chat of chatsFromDB) {
            let isModified = false;

            // ä¿®å¾©1ï¼šç¢ºä¿ history èŠå¤©è¨˜éŒ„é™£åˆ—å­˜åœ¨ï¼Œé€™æ˜¯æœ€å¸¸è¦‹çš„å•é¡Œ
            if (!Array.isArray(chat.history)) {
                chat.history = [];
                isModified = true;
            }
            // ä¿®å¾©2ï¼šç¢ºä¿ settings è¨­ç½®å°è±¡å­˜åœ¨
            if (typeof chat.settings !== 'object' || chat.settings === null) {
                chat.settings = {};
                isModified = true;
            }
            // ä¿®å¾©3ï¼šç‚ºèˆŠè³‡æ–™çš„å–®èŠè§’è‰²è£œå…… originalNameï¼ˆæœ¬åï¼‰
            if (!chat.isGroup && !chat.originalName) {
                chat.originalName = chat.name;
                isModified = true;
            }
            // ä¿®å¾©4ï¼šç¢ºä¿ unreadCountï¼ˆæœªè®€æ¶ˆæ¯æ•¸ï¼‰å­˜åœ¨
            if (typeof chat.unreadCount === 'undefined') {
                chat.unreadCount = 0;
                isModified = true;
            }
            // ä¿®å¾©5: ç¢ºä¿ longTermMemory (é•·æœŸè¨˜æ†¶) é™£åˆ—å­˜åœ¨
            if (!Array.isArray(chat.longTermMemory)) {
                chat.longTermMemory = [];
                isModified = true;
            }
            // æ‚¨æœªä¾†å¯ä»¥æ ¹æ“šéœ€è¦åœ¨é€™è£¡æ·»åŠ æ›´å¤šçš„æª¢æŸ¥å’Œä¿®å¾©é‚è¼¯...

            // å¦‚æœè³‡æ–™è¢«ä¿®å¾©éï¼Œå°±æ›´æ–°è³‡æ–™åº«
            if (isModified) {
                fixedCount++;
                console.log(`ä¿®å¾©äº†è§’è‰² "${chat.name}" (ID: ${chat.id}) çš„æ®˜ç¼ºæ•¸æ“šã€‚`);
                await db.chats.put(chat);
            }
            
            // ç„¡è«–æ˜¯å¦ä¿®å¾©ï¼Œéƒ½ç¢ºä¿è¨˜æ†¶é«”ä¸­çš„ state ç‰©ä»¶æ˜¯æœ€æ–°çš„
            state.chats[chat.id] = chat;
        }

        if (fixedCount > 0) {
            await showCustomAlert(
                'ä¿®å¾©å®Œæˆï¼',
                `æˆåŠŸæª¢æŸ¥ä¸¦ä¿®å¾©äº† ${fixedCount} å€‹è§’è‰²çš„è³‡æ–™å•é¡Œï¼\n\nèŠå¤©åˆ—è¡¨å·²ç‚ºæ‚¨åˆ·æ–°ã€‚`
            );
            // ä½¿ç”¨ä¿®å¾©å¾Œçš„æœ€æ–°è³‡æ–™ï¼Œé‡æ–°æ¸²æŸ“èŠå¤©æ¸…å–®
            await renderChatList(); 
        } else {
            await showCustomAlert('æª¢æŸ¥å®Œæˆ', 'æœªç™¼ç¾ä»»ä½•éœ€è¦ä¿®å¾©çš„è³‡æ–™å•é¡Œã€‚');
        }

    } catch (error) {
        console.error("è³‡æ–™æª¢æŸ¥èˆ‡ä¿®å¾©å¤±æ•—:", error);
        await showCustomAlert('æ“ä½œå¤±æ•—', `åŸ·è¡Œæª¢æŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¼‰å…¥å‹•ç•«è¼”åŠ©å‡½æ•¸ â–¼â–¼â–¼
/**
 * åœ¨æŒ‡å®šå®¹å™¨é¡¯ç¤ºè¼‰å…¥å‹•ç•«
 * @param {HTMLElement} container - è¦é¡¯ç¤ºè¼‰å…¥å‹•ç•«çš„å®¹å™¨å…ƒç´ 
 * @param {string} position - 'top' æˆ– 'bottom'ï¼Œæ±ºå®šè¼‰å…¥å‹•ç•«å‡ºç¾çš„ä½ç½®
 */
function showLoader(container, position = 'top') {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è¼‰å…¥å™¨ï¼Œé¿å…é‡è¤‡æ·»åŠ 
    if (container.querySelector('.loader-container')) return;
    const loader = document.createElement('div');
    loader.className = 'loader-container';
    loader.innerHTML = '<div class="spinner"></div>';
    
    if (position === 'bottom') {
        container.appendChild(loader);
    } else {
        container.prepend(loader);
    }
}

/**
 * å¾æŒ‡å®šå®¹å™¨ç§»é™¤è¼‰å…¥å‹•ç•«
 * @param {HTMLElement} container - è¦ç§»é™¤è¼‰å…¥å‹•ç•«çš„å®¹å™¨å…ƒç´ 
 */
function hideLoader(container) {
    const loader = container.querySelector('.loader-container');
    if (loader) {
        loader.remove();
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯åˆªé™¤ä¸–ç•Œæ›¸åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹åˆªé™¤ä¸–ç•Œæ›¸çš„é¸æ“‡å™¨å½ˆçª—
 */
async function openWorldBookDeletionModal() {
    const modal = document.getElementById('delete-world-books-modal');
    const listEl = document.getElementById('delete-world-books-list');
    const selectAllCheckbox = document.getElementById('select-all-world-books-for-clear');
    listEl.innerHTML = '';
    selectAllCheckbox.checked = false; // é‡ç½®å…¨é¸æ¡†

    const books = await db.worldBooks.toArray();

    if (books.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">æ²’æœ‰å¯ä»¥åˆªé™¤çš„ä¸–ç•Œæ›¸ã€‚</p>';
    } else {
        books.forEach(book => {
            const item = document.createElement('div');
            item.className = 'clear-posts-item'; // è¤‡ç”¨æ¨£å¼
            item.dataset.bookId = book.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${book.name}</span>
            `;
            listEl.appendChild(item);
        });
    }
    
    modal.classList.add('visible');
}

/**
 * ã€æ ¸å¿ƒã€‘è™•ç†æœ€çµ‚ç¢ºèªåˆªé™¤ä¸–ç•Œæ›¸çš„é‚è¼¯
 */
async function handleConfirmWorldBookDeletion() {
    const selectedItems = document.querySelectorAll('#delete-world-books-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦åˆªé™¤çš„ä¸–ç•Œæ›¸ã€‚");
        return;
    }

    const idsToDelete = Array.from(selectedItems).map(item => item.dataset.bookId);
    
    const confirmed = await showCustomConfirm(
        'æœ€å¾Œç¢ºèªï¼',
        `æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‚¨é¸æ“‡çš„ ${selectedItems.length} æœ¬ä¸–ç•Œæ›¸ï¼Œä¸¦è§£é™¤å®ƒå€‘èˆ‡æ‰€æœ‰è§’è‰²çš„é—œè¯ã€‚æ­¤æ“ä½œã€ä¸å¯æ¢å¾©ã€‘ï¼`,
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªåˆªé™¤' }
    );

    if (!confirmed) return;
    
    await showCustomAlert("è«‹ç¨å€™...", "æ­£åœ¨åŸ·è¡Œåˆªé™¤æ“ä½œ...");

    try {
        await db.transaction('rw', db.worldBooks, db.chats, async () => {
            // 1. æ‰¹é‡åˆªé™¤ä¸–ç•Œæ›¸æœ¬èº«
            await db.worldBooks.bulkDelete(idsToDelete);

            // 2. éæ­·æ‰€æœ‰èŠå¤©ï¼Œè§£é™¤é—œè¯
            const allChats = await db.chats.toArray();
            for (const chat of allChats) {
                if (chat.settings && Array.isArray(chat.settings.linkedWorldBookIds)) {
                    const originalCount = chat.settings.linkedWorldBookIds.length;
                    // éæ¿¾æ‰å·²è¢«åˆªé™¤çš„ä¸–ç•Œæ›¸ID
                    chat.settings.linkedWorldBookIds = chat.settings.linkedWorldBookIds.filter(id => !idsToDelete.includes(id));
                    
                    // å¦‚æœæœ‰é—œè¯è¢«è§£é™¤ï¼Œå‰‡æ›´æ–°è©²èŠå¤©
                    if (chat.settings.linkedWorldBookIds.length < originalCount) {
                        await db.chats.put(chat);
                    }
                }
            }
        });
        
        // æ›´æ–°è¨˜æ†¶é«”ç‹€æ…‹
        state.worldBooks = state.worldBooks.filter(book => !idsToDelete.includes(book.id));
        
        document.getElementById('delete-world-books-modal').classList.remove('visible');
        await showCustomAlert("åˆªé™¤æˆåŠŸ", `${selectedItems.length} æœ¬ä¸–ç•Œæ›¸å·²æˆåŠŸåˆªé™¤ã€‚`);

    } catch (error) {
        console.error("åˆªé™¤ä¸–ç•Œæ›¸å¤±æ•—:", error);
        await showCustomAlert("åˆªé™¤å¤±æ•—", `æ“ä½œå¤±æ•—: ${error.message}`);
    }
}
// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€V2.1 | ç‹€æ…‹èˆ‡äº¤äº’ä¿®å¾©ç‰ˆã€‘ä¸€èµ·è®€æ›¸åŠŸèƒ½æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹è®€æ›¸è¦–çª—ï¼ˆç”±å·¥å…·åˆ—æŒ‰éˆ•èª¿ç”¨ï¼‰
 */
function openReadingRoom() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('reading-overlay');
    const windowEl = document.getElementById('reading-window');
    const restoreBtn = document.getElementById('reading-restore-btn');

    let session = readingState[chatId];

    // å¦‚æœæœƒè©±å·²å•Ÿå‹•ï¼ˆç„¡è«–æ˜¯æ‰“é–‹é‚„æ˜¯æœ€å°åŒ–ï¼‰ï¼Œåªéœ€ç¢ºä¿å®ƒå¯è¦‹å³å¯
    if (session && session.isActive) {
        if (session.isMinimized) {
            restoreReadingRoom(); // å¦‚æœæ˜¯æœ€å°åŒ–ç‹€æ…‹ï¼Œå°±æ¢å¾©å®ƒ
        }
        // å¦‚æœå·²ç¶“æ˜¯æ‰“é–‹ç‹€æ…‹ï¼Œç¢ºä¿å®ƒåœ¨æœ€å‰
        overlay.style.display = 'flex';
        return;
    }

    // å¦‚æœæœƒè©±æœªå•Ÿå‹•ï¼Œå‰‡å‰µå»ºä¸¦é¡¯ç¤º
    initReadingSession(chatId);
    renderReadingRoom(chatId);

    // é‡ç½®æ‰€æœ‰ç‹€æ…‹ï¼Œç¢ºä¿è¦–çª—å¾ä¸­é–“å‡ºç¾
    overlay.style.display = 'flex';
    windowEl.classList.remove('minimized');
    restoreBtn.style.display = 'none';
    
    // ä½¿ç”¨transformå±…ä¸­ï¼Œé¿å…æ‹–å‹•è¡çª
// â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨JSè¨ˆç®—åˆå§‹å±…ä¸­ä½ç½®ï¼Œæ¶ˆé™¤å½ˆè·³ã€‘ â–¼â–¼â–¼
// 1. ç²å–çˆ¶å®¹å™¨ï¼ˆæ‰‹æ©Ÿè¢å¹•ï¼‰å’Œè¦–çª—æœ¬èº«çš„å°ºå¯¸
const phoneScreen = document.getElementById('phone-screen');
const windowRect = windowEl.getBoundingClientRect(); // ç²å–è¦–çª—å°ºå¯¸

// 2. è¨ˆç®—å±…ä¸­çš„ top å’Œ left åœ–å…ƒå€¼
const top = (phoneScreen.clientHeight - windowRect.height) / 2;
const left = (phoneScreen.clientWidth - windowRect.width) / 2;

// 3. ç›´æ¥æ‡‰ç”¨è¨ˆç®—å¥½çš„åœ–å…ƒå€¼ï¼Œä¸¦ç¢ºä¿ transform å±¬æ€§ç‚ºç©º
windowEl.style.top = `${top}px`;
windowEl.style.left = `${left}px`;
windowEl.style.transform = ''; // ç¢ºä¿æ²’æœ‰ transform å±¬æ€§
// â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
}

/**
 * ã€å·²å‡ç´šã€‘åˆå§‹åŒ–ä¸€å€‹æ–°çš„è®€æ›¸æœƒè©±ç‹€æ…‹
 */
function initReadingSession(chatId) {
    readingState[chatId] = {
        isActive: true,
        isMinimized: false,
        title: 'æœªé¸æ“‡æ›¸ç±',
        contentLines: [],
        currentPage: 0,
        totalPages: 0,
        linesPerPage: 15,
        currentSnippet: '' // <-- æ ¸å¿ƒæ–°å¢ï¼šç”¨æ–¼å­˜å„²ç•¶å‰è¦–é‡ä¸­çš„æ–‡å­—ç‰‡æ®µ
    };
}

/**
 * ã€å·²ä¿®å¾©ã€‘é—œé–‰è®€æ›¸æ‡¸æµ®çª— (ç”± 'X' æŒ‰éˆ•èª¿ç”¨)
 */
function closeReadingRoom() {
    const chatId = state.activeChatId;
    if (!chatId || !readingState[chatId] || !readingState[chatId].isActive) return;

    // éš±è—æ‰€æœ‰ç›¸é—œUI
    document.getElementById('reading-overlay').style.display = 'none';
    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');

    // æ ¸å¿ƒä¿®å¾©ï¼šå°‡ isActive è¨­ç‚º falseï¼Œé€™æ¨£ä¸‹æ¬¡æ‰èƒ½é‡æ–°æ‰“é–‹
    readingState[chatId].isActive = false;
    console.log("è®€æ›¸æœƒè©±å·²é—œé–‰ã€‚");
}

/**
 * ã€å·²ä¿®å¾©ã€‘æœ€å°åŒ–è®€æ›¸çª—å£
 */
function minimizeReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive || session.isMinimized) return;

    session.isMinimized = true; // æ›´æ–°ç‹€æ…‹
    document.getElementById('reading-window').classList.add('minimized');
    document.getElementById('reading-restore-btn').style.display = 'flex';
}

/**
 * ã€å·²ä¿®å¾©ã€‘æ¢å¾©è®€æ›¸çª—å£
 */
function restoreReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive || !session.isMinimized) return;

    session.isMinimized = false; // æ›´æ–°ç‹€æ…‹
    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');
}

/**
 * ã€å·²ä¿®å¾©ã€‘è®“ä¸€å€‹å…ƒç´ è®Šå¾—å¯æ‹–å‹•
 * @param {HTMLElement} windowEl - è¦æ‹–å‹•çš„è¦–çª—å…ƒç´ 
 * @param {HTMLElement} headerEl - æ‹–å‹•çš„æ‰‹æŸ„å…ƒç´ 
 */
function makeDraggable(windowEl, headerEl) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    const phoneScreen = document.getElementById('phone-screen');

    const startDrag = (e) => {
        // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
        // åœ¨é–‹å§‹æ‹–å‹•å‰ï¼Œæª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯æŒ‰éˆ•ã€‚å¦‚æœæ˜¯ï¼Œå‰‡ç«‹å³é€€å‡ºï¼Œä¸åŸ·è¡Œä»»ä½•æ‹–å‹•é‚è¼¯ã€‚
        if (e.target.closest('button')) {
            return;
        }
        // â–²â–²â–² ã€ã€ã€ä¿®å¾©çµæŸã€‘ã€‘ã€‘ â–²â–²â–²

        // ï¼ˆå¾ŒçºŒçš„æ‹–å‹•é‚è¼¯ä¿æŒä¸è®Šï¼‰
        if (windowEl.style.transform) {
            const rect = windowEl.getBoundingClientRect();
            const parentRect = windowEl.offsetParent.getBoundingClientRect();
            windowEl.style.top = `${rect.top - parentRect.top}px`;
            windowEl.style.left = `${rect.left - parentRect.left}px`;
            windowEl.style.transform = '';
        }

        e.preventDefault();
        const event = e.type === 'touchstart' ? e.touches[0] : e;
        pos3 = event.clientX;
        pos4 = event.clientY;
        
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('mousemove', elementDrag);
        document.addEventListener('touchend', endDrag);
        document.addEventListener('touchmove', elementDrag);
    };

    const elementDrag = (e) => {
        const event = e.type === 'touchmove' ? e.touches[0] : e;
        pos1 = pos3 - event.clientX;
        pos2 = pos4 - event.clientY;
        pos3 = event.clientX;
        pos4 = event.clientY;
        
        let newTop = windowEl.offsetTop - pos2;
        let newLeft = windowEl.offsetLeft - pos1;

        const maxTop = phoneScreen.clientHeight - windowEl.offsetHeight - 10;
        const maxLeft = phoneScreen.clientWidth - windowEl.offsetWidth - 10;
        newTop = Math.max(10, Math.min(newTop, maxTop));
        newLeft = Math.max(10, Math.min(newLeft, maxLeft));

        windowEl.style.top = newTop + "px";
        windowEl.style.left = newLeft + "px";
    };

    const endDrag = () => {
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('mousemove', elementDrag);
        document.removeEventListener('touchend', endDrag);
        document.removeEventListener('touchmove', elementDrag);
    };

    headerEl.addEventListener('mousedown', startDrag);
    headerEl.addEventListener('touchstart', startDrag);
}

// --- å…¶ä»–è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š) ---
function renderReadingRoom(chatId) {
    const session = readingState[chatId]; if (!session) return;
    const titleEl = document.getElementById('reading-title');
    const contentEl = document.getElementById('reading-content');
    const pageIndicator = document.getElementById('page-indicator');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    titleEl.textContent = session.title;
    if (session.contentLines.length === 0) {
        contentEl.innerHTML = '<p>é»æ“Šâ€œå°å…¥â€æŒ‰éˆ•ï¼Œ<br>å¾æœ¬åœ°.txtæª”æˆ–ç¶²è·¯URLè¼‰å…¥æ›¸ç±å…§å®¹ã€‚</p>';
        session.totalPages = 0; session.currentPage = 0;
    } else {
        const startLine = session.currentPage * session.linesPerPage;
        const endLine = startLine + session.linesPerPage;
        contentEl.textContent = session.contentLines.slice(startLine, endLine).join('\n');
    }
    pageIndicator.textContent = `${session.currentPage + 1} / ${session.totalPages}`;
    prevBtn.disabled = session.currentPage === 0;
    nextBtn.disabled = session.currentPage >= session.totalPages - 1;
}
function showNextPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage < session.totalPages - 1) {
        session.currentPage++; 
        renderReadingRoom(state.activeChatId);
        document.getElementById('reading-content').scrollTop = 0;
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜é€²åº¦
        saveReadingProgress(session.activeBookId, session.currentPage);
    }
}

// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²å‡ç´šçš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ showPrevPage å‡½æ•¸ â–¼â–¼â–¼
async function showPrevPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage > 0) {
        session.currentPage--; 
        renderReadingRoom(state.activeChatId);
        document.getElementById('reading-content').scrollTop = 0;
        await saveReadingProgress(session.activeBookId, session.currentPage);

        // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨ç¿»é å¾Œï¼Œä¹Ÿç«‹åˆ»é€šçŸ¥AI
        await notifyAiOfPageTurn(state.activeChatId, session);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å·²ä¿®æ”¹ã€‘åƒ…ç”¨æ–¼è§¸ç™¼æœ¬åœ°æª”é¸æ“‡
 */
function importBook() {
    // ç›´æ¥è§¸ç™¼éš±è—çš„æª”è¼¸å…¥æ¡†ï¼Œä¸å†å½ˆå‡ºé¸æ“‡åŠŸèƒ½è¡¨
    document.getElementById('book-upload-input').click();
}
/**
 * ã€å…¨æ–° | ç·¨ç¢¼ç›¸å®¹ã€‘æ™ºæ…§è§£ç¢¼æ–‡å­—æª”
 * @param {ArrayBuffer} arrayBuffer - æª”çš„äºŒé€²ä½è³‡æ–™
 * @returns {string} - è§£ç¢¼å¾Œçš„æ–‡æœ¬å…§å®¹
 */
async function decodeTextFile(arrayBuffer) {
    const uint8array = new Uint8Array(arrayBuffer);

    // 1. æª¢æŸ¥BOM (Byte Order Mark) ä¾†ç²¾ç¢ºåˆ¤æ–·ç·¨ç¢¼
    if (uint8array.length >= 3 && uint8array[0] === 0xEF && uint8array[1] === 0xBB && uint8array[2] === 0xBF) {
        console.log("æª¢æ¸¬åˆ° UTF-8 BOMï¼Œä½¿ç”¨ UTF-8 è§£ç¢¼ã€‚");
        return new TextDecoder('utf-8').decode(uint8array);
    }
    if (uint8array.length >= 2 && uint8array[0] === 0xFF && uint8array[1] === 0xFE) {
        console.log("æª¢æ¸¬åˆ° UTF-16 LE BOMï¼Œä½¿ç”¨ UTF-16 LE è§£ç¢¼ã€‚");
        return new TextDecoder('utf-16le').decode(uint8array);
    }
    if (uint8array.length >= 2 && uint8array[0] === 0xFE && uint8array[1] === 0xFF) {
        console.log("æª¢æ¸¬åˆ° UTF-16 BE BOMï¼Œä½¿ç”¨ UTF-16 BE è§£ç¢¼ã€‚");
        return new TextDecoder('utf-16be').decode(uint8array);
    }

    // 2. å¦‚æœæ²’æœ‰BOMï¼Œå˜—è©¦ä½œç‚ºUTF-8è§£ç¢¼
    try {
        console.log("æœªæª¢æ¸¬åˆ°BOMï¼Œå˜—è©¦ä½¿ç”¨ UTF-8 è§£ç¢¼...");
        // ä½¿ç”¨ fatal: true æœƒåœ¨é‡åˆ°ç„¡æ•ˆä½å…ƒçµ„åºåˆ—æ™‚æ‹‹å‡ºéŒ¯èª¤
        const decoded = new TextDecoder('utf-8', { fatal: true }).decode(uint8array);
        console.log("UTF-8 è§£ç¢¼æˆåŠŸã€‚");
        return decoded;
    } catch (e) {
        console.log("UTF-8 è§£ç¢¼å¤±æ•—ï¼Œå°‡å˜—è©¦ GBK (ANSI) è§£ç¢¼...");
        // 3. å¦‚æœUTF-8å¤±æ•—ï¼Œå‰‡å›é€€åˆ°GBKè§£ç¢¼ (è¦†è“‹å¸¸è¦‹çš„ä¸­æ–‡ANSI)
        try {
            const decoded = new TextDecoder('gbk').decode(uint8array);
            console.log("GBK è§£ç¢¼æˆåŠŸã€‚");
            return decoded;
        } catch (err) {
             console.error("æ‰€æœ‰è§£ç¢¼å˜—è©¦å‡å¤±æ•—:", err);
             // 4. å¦‚æœæ‰€æœ‰å˜—è©¦éƒ½å¤±æ•—äº†ï¼Œæ‹‹å‡ºä¸€å€‹ä½¿ç”¨è€…å‹å¥½çš„éŒ¯èª¤
             throw new Error("ç„¡æ³•è­˜åˆ¥çš„æª”ç·¨ç¢¼ã€‚è«‹å˜—è©¦å°‡æª”è½‰æ›ç‚º UTF-8 æ ¼å¼å¾Œé‡æ–°å°å…¥ã€‚");
        }
    }
}
/**
 * ã€å·²ä¿®æ”¹ | ç·¨ç¢¼ç›¸å®¹ã€‘è™•ç†ä½¿ç”¨è€…ä¸Šå‚³çš„æ›¸ç±æª”ï¼Œç¾åœ¨æœƒå°‡å…¶ä¿å­˜åˆ°è³‡æ–™åº«
 */
async function handleBookFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        // æ ¸å¿ƒä¿®æ”¹1ï¼šå°‡æ–‡ä»¶è®€å–ç‚º ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        // æ ¸å¿ƒä¿®æ”¹2ï¼šèª¿ç”¨æˆ‘å€‘æ–°çš„æ™ºæ…§è§£ç¢¼å‡½æ•¸
        const textContent = await decodeTextFile(arrayBuffer);

        const title = file.name.replace(/\.txt$/i, '');

        const newBookId = await db.readingLibrary.add({
            title: title,
            content: textContent,
            lastOpened: Date.now()
        });

        await loadBookFromLibrary(newBookId);
        if (document.getElementById('reading-library-modal').classList.contains('visible')) {
            renderBookLibrary();
        }
    } catch (error) {
        // å¦‚æœè§£ç¢¼æˆ–è™•ç†éç¨‹ä¸­å‡ºéŒ¯ï¼Œçµ¦ç”¨æˆ¶ä¸€å€‹æ˜ç¢ºçš„æç¤º
        console.error("å°å…¥æ›¸ç±å¤±æ•—:", error);
        await showCustomAlert("å°å…¥å¤±æ•—", error.message);
    } finally {
        event.target.value = null;
    }
}
async function handlePageJump() {
    const chatId = state.activeChatId;
    if (!chatId) return;
    const session = readingState[chatId];
    if (!session || session.totalPages <= 1) return;

    const targetPageStr = await showCustomPrompt(
        'é é¢è·³è½‰', 
        `è«‹è¼¸å…¥æƒ³è·³è½‰çš„é ç¢¼ (1 - ${session.totalPages})`,
        session.currentPage + 1
    );

    if (targetPageStr === null) return;

    const targetPage = parseInt(targetPageStr);

    if (isNaN(targetPage) || targetPage < 1 || targetPage > session.totalPages) {
        alert("è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„é ç¢¼ï¼");
        return;
    }

    session.currentPage = targetPage - 1;
    renderReadingRoom(chatId);
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜é€²åº¦
    saveReadingProgress(session.activeBookId, session.currentPage);
}

/**
 * ã€å…¨æ–°ã€‘ä¿å­˜æŒ‡å®šæ›¸ç±çš„é–±è®€é€²åº¦åˆ°è³‡æ–™åº«
 * @param {number} bookId - è¦ä¿å­˜é€²åº¦çš„æ›¸ç±ID
 * @param {number} pageNumber - ç•¶å‰çš„é ç¢¼
 */
async function saveReadingProgress(bookId, pageNumber) {
    if (!bookId) return;
    try {
        // ä½¿ç”¨ update æ–¹æ³•ï¼Œåªæ›´æ–° currentPage æ¬„ä½ï¼Œä¸å½±éŸ¿å…¶ä»–è³‡æ–™
        await db.readingLibrary.update(bookId, { currentPage: pageNumber });
    } catch (error) {
        console.error(`ä¿å­˜æ›¸ç±(ID: ${bookId})çš„é–±è®€é€²åº¦å¤±æ•—:`, error);
    }
}
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²å‡ç´šçš„ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ showNextPage å‡½æ•¸ â–¼â–¼â–¼
async function showNextPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage < session.totalPages - 1) {
        session.currentPage++; 
        renderReadingRoom(state.activeChatId);
        document.getElementById('reading-content').scrollTop = 0;
        await saveReadingProgress(session.activeBookId, session.currentPage);
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨ç¿»é å¾Œï¼Œç«‹åˆ»é€šçŸ¥AI
        await notifyAiOfPageTurn(state.activeChatId, session);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
function processImportedText(title, textContent) {
    const chatId = state.activeChatId; if (!chatId) return;
    const session = readingState[chatId];
    session.title = title.replace(/\.txt$/i, '');
    session.contentLines = textContent.split(/\r\n?|\n/).map(line => line.replace(/ +/g, ' '));
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);
    session.currentPage = 0;
    renderReadingRoom(chatId);
}

// â–²â–²â–² JSä»£ç¢¼æ›¿æ›çµæŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘æ‰“é–‹æ›¸åº«å½ˆçª—ä¸¦æ¸²æŸ“åˆ—è¡¨
 */
async function openBookLibrary() {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨æ¸²æŸ“å‰ï¼Œå…ˆæ¸…ç©ºæœç´¢æ¡†
    document.getElementById('reading-library-search-input').value = '';

    await renderBookLibrary(); // èª¿ç”¨ä¸å¸¶åƒæ•¸çš„æ¸²æŸ“ï¼Œé¡¯ç¤ºå…¨éƒ¨æ›¸ç±
    document.getElementById('reading-library-modal').classList.add('visible');
}

/**
 * ã€å…¨æ–° | æ”¯æ´æœç´¢ã€‘å¾è³‡æ–™åº«è®€å–æ›¸ç±ä¸¦æ¸²æŸ“åˆ°æ›¸åº«åˆ—è¡¨ä¸­
 * @param {string} searchTerm - ä½¿ç”¨è€…è¼¸å…¥çš„æœç´¢é—œéµå­—
 */
async function renderBookLibrary(searchTerm = '') {
    const listEl = document.getElementById('reading-library-list');
    let books = await db.readingLibrary.orderBy('lastOpened').reverse().toArray();
    listEl.innerHTML = '';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ“šæœç´¢è©éæ¿¾æ›¸ç±
    if (searchTerm) {
        books = books.filter(book => 
            book.title.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ ¹æ“šæ˜¯å¦æœ‰çµæœï¼Œé¡¯ç¤ºä¸åŒçš„æç¤ºè³‡è¨Š
    if (books.length === 0) {
        const message = searchTerm 
            ? 'æ‰¾ä¸åˆ°åŒ¹é…çš„æ›¸ç±' 
            : 'æ›¸åº«æ˜¯ç©ºçš„ï¼Œé»æ“Šâ€œå°å…¥æ–°æ›¸â€æ·»åŠ ç¬¬ä¸€æœ¬å§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'existing-group-item'; 
        item.innerHTML = `
            <span class="group-name" style="cursor:pointer;" data-book-id="${book.id}">${book.title}</span>
            <button class="delete-group-btn" data-book-id="${book.id}" title="åˆªé™¤æ›¸ç±">Ã—</button>
        `;
        listEl.appendChild(item);
    });
}

/**
 * ã€å…¨æ–° | æ”¯æŒä¸­æ–·é»çºŒè®€ã€‘å¾æ›¸åº«ä¸­è¼‰å…¥ä¸€æœ¬æ›¸åˆ°é–±è®€å™¨
 * @param {number} bookId - è¦è¼‰å…¥çš„æ›¸ç±çš„ID
 */
async function loadBookFromLibrary(bookId) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    const book = await db.readingLibrary.get(bookId);
    if (!book) {
        alert('æ‰¾ä¸åˆ°é€™æœ¬æ›¸ï¼');
        return;
    }

    await db.readingLibrary.update(bookId, { lastOpened: Date.now() });

    const session = readingState[chatId];
    session.activeBookId = bookId; // ã€æ ¸å¿ƒæ–°å¢ã€‘è¨˜éŒ„ç•¶å‰æ­£åœ¨é–±è®€çš„æ›¸ç±ID
    session.title = book.title;
    session.contentLines = book.content.split(/\r\n?|\n/).map(line => line.replace(/ +/g, ' '));
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);
    
    // â–¼â–¼â–¼ ã€ã€ã€é€™å°±æ˜¯å¯¦ç¾ä¸­æ–·é»çºŒè®€çš„é—œéµï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    // è®€å–è³‡æ–™åº«ä¸­ä¿å­˜çš„é ç¢¼ï¼Œå¦‚æœæ²’æœ‰ï¼Œå‰‡é»˜èªç‚ºç¬¬0é 
    session.currentPage = book.currentPage || 0;
    // â–²â–²â–² é—œéµä»£ç¢¼çµæŸ â–²â–²â–²

    renderReadingRoom(chatId);
    // æ¸²æŸ“å¾Œï¼Œç¢ºä¿æ²è»¸åœ¨é ‚éƒ¨
    document.getElementById('reading-content').scrollTop = 0; 
    document.getElementById('reading-library-modal').classList.remove('visible');
}

/**
 * ã€å…¨æ–°ã€‘å¾æ›¸åº«ä¸­åˆªé™¤ä¸€æœ¬æ›¸
 * @param {number} bookId - è¦åˆªé™¤çš„æ›¸ç±çš„ID
 */
async function deleteBookFromLibrary(bookId) {
    const book = await db.readingLibrary.get(bookId);
    if (!book) return;

    const confirmed = await showCustomConfirm('åˆªé™¤æ›¸ç±', `ç¢ºå®šè¦åˆªé™¤ã€Š${book.title}ã€‹å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.readingLibrary.delete(bookId);
        await renderBookLibrary(); // åˆ·æ–°æ›¸åº«åˆ—è¡¨
    }
}
/**
 * ã€æ ¸å¿ƒã€‘è™•ç†å°å…¥çš„æ–‡æœ¬å…§å®¹ï¼Œæ›´æ–°ç‹€æ…‹ä¸¦åˆ·æ–°UI
 * @param {string} title - æ›¸ç±/æª”æ¡ˆå
 * @param {string} textContent - å®Œæ•´çš„æ–‡æœ¬å…§å®¹
 */
function processImportedText(title, textContent) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    const session = readingState[chatId];
    session.title = title.replace(/\.txt$/i, '');
    session.contentLines = textContent.split(/\r\n?|\n/);
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);
    session.currentPage = 0;

    renderReadingRoom(chatId);
}

// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
/**
 * ã€V2.1 | æ‹–å‹•èˆ‡é»æ“Šç›¸å®¹ä¿®å¾©ç‰ˆã€‘è®“ä¸€å€‹å…ƒç´ è®Šå¾—å¯æ‹–å‹•
 * @param {HTMLElement} windowEl - è¦æ‹–å‹•çš„è¦–çª—å…ƒç´ 
 * @param {HTMLElement} headerEl - æ‹–å‹•çš„æ‰‹æŸ„å…ƒç´ 
 */
function makeDraggable(windowEl, headerEl) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    let isDragging = false;
    let hasMoved = false; // æ–°å¢æ¨™èªŒä½å…ƒï¼Œåˆ¤æ–·æ˜¯å¦ç™¼ç”Ÿéç§»å‹•
    const phoneScreen = document.getElementById('phone-screen');

    const startDrag = (e) => {
        // å¦‚æœæ˜¯ä¸»è¦–çª—ï¼Œä¸¦ä¸”é»æ“Šçš„æ˜¯å…§éƒ¨æŒ‰éˆ•ï¼Œå‰‡ä¸è§¸ç™¼æ‹–å‹•
        if (windowEl !== headerEl && e.target.closest('button')) {
            return;
        }

        isDragging = true;
        hasMoved = false; // æ¯æ¬¡é–‹å§‹æ™‚é‡ç½®ç§»å‹•ç‹€æ…‹

        const event = e.type === 'touchstart' ? e.touches[0] : e;
        pos3 = event.clientX;
        pos4 = event.clientY;

        // ç¢ºä¿ä½¿ç”¨ top/left å®šä½ï¼Œè€Œä¸æ˜¯ transform
        windowEl.style.top = `${windowEl.offsetTop}px`;
        windowEl.style.left = `${windowEl.offsetLeft}px`;
        windowEl.style.transform = '';

        document.addEventListener('mouseup', endDrag);
        document.addEventListener('mousemove', elementDrag);
        document.addEventListener('touchend', endDrag);
        // ã€æ ¸å¿ƒä¿®å¾©1ã€‘æ·»åŠ  passive: false ç¢ºä¿ preventDefault ç”Ÿæ•ˆ
        document.addEventListener('touchmove', elementDrag, { passive: false });
    };

    const elementDrag = (e) => {
        if (!isDragging) return;

        const event = e.type === 'touchmove' ? e.touches[0] : e;
        const diffX = event.clientX - pos3;
        const diffY = event.clientY - pos4;

        // ã€æ ¸å¿ƒä¿®å¾©2ã€‘åªæœ‰ç•¶ç§»å‹•è·é›¢è¶…éä¸€å€‹å¾®å°é–¾å€¼æ™‚ï¼Œæ‰åˆ¤å®šç‚ºâ€œæ‹–å‹•â€
        if (!hasMoved && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
            hasMoved = true;
        }

        // åªæœ‰åœ¨ç¢ºå®šæ˜¯æ‹–å‹•æ™‚ï¼Œæ‰é˜»æ­¢é é¢æ»¾å‹•
        if (hasMoved && e.cancelable) {
            e.preventDefault();
        }

        pos1 = pos3 - event.clientX;
        pos2 = pos4 - event.clientY;
        pos3 = event.clientX;
        pos4 = event.clientY;

        let newTop = windowEl.offsetTop - pos2;
        let newLeft = windowEl.offsetLeft - pos1;

        const maxTop = phoneScreen.clientHeight - windowEl.offsetHeight - 10;
        const maxLeft = phoneScreen.clientWidth - windowEl.offsetWidth - 10;
        newTop = Math.max(10, Math.min(newTop, maxTop));
        newLeft = Math.max(10, Math.min(newLeft, maxLeft));

        windowEl.style.top = newTop + "px";
        windowEl.style.left = newLeft + "px";
    };

    const endDrag = () => {
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('mousemove', elementDrag);
        document.removeEventListener('touchend', endDrag);
        document.removeEventListener('touchmove', elementDrag);

        if (!isDragging) return;
        isDragging = false;

        // ã€æ ¸å¿ƒä¿®å¾©3ã€‘å¦‚æœå¾é ­åˆ°å°¾éƒ½æ²’æœ‰ç™¼ç”Ÿæœ‰æ•ˆç§»å‹•ï¼Œå°±åˆ¤å®šç‚ºä¸€æ¬¡â€œé»æ“Šâ€
        if (!hasMoved) {
            // æ‰‹å‹•è§¸ç™¼å…ƒç´ çš„é»æ“Šäº‹ä»¶
            windowEl.click();
        }
    };

    headerEl.addEventListener('mousedown', startDrag);
    // ã€æ ¸å¿ƒä¿®å¾©4ã€‘ç‚º touchstart ä¹Ÿæ·»åŠ  passive: false
    headerEl.addEventListener('touchstart', startDrag, { passive: false });
}


/**
 * æœ€å°åŒ–è®€æ›¸çª—å£
 */
function minimizeReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive) return;

    document.getElementById('reading-window').classList.add('minimized');
    document.getElementById('reading-restore-btn').style.display = 'flex';
    session.isMinimized = true;
}

/**
 * æ¢å¾©è®€æ›¸çª—å£
 */
function restoreReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive) return;

    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');
    session.isMinimized = false;
}

// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å¯¦ç¾â€œæ»¾å‹•æ„ŸçŸ¥â€åŠŸèƒ½çš„æ ¸å¿ƒä»£ç¢¼ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€è¼”åŠ©å‡½æ•¸ã€‘å‰µå»ºä¸€å€‹é˜²æŠ–å‡½æ•¸
 * @param {Function} func - éœ€è¦é˜²æŠ–çš„å‡½æ•¸
 * @param {number} delay - å»¶é²æ™‚é–“ (æ¯«ç§’)
 * @returns {Function} - ç¶“éé˜²æŠ–è™•ç†çš„æ–°å‡½æ•¸
 */
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}
// â–¼â–¼â–¼ ã€V3.1 | é‚è¼¯å„ªåŒ–ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ formatReadingStateForAI â–¼â–¼â–¼

/**
 * ã€å…¨æ–° V3.1 | é‚è¼¯å„ªåŒ–ç‰ˆã€‘å°‡æŒ‡å®šèŠå¤©çš„â€œä¸€èµ·è®€æ›¸â€ç‹€æ…‹æ ¼å¼åŒ–ç‚ºAIå¯è®€çš„æ–‡æœ¬
 * @param {string} chatId - ç›®æ¨™èŠå¤©çš„ID
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„ä¸Šä¸‹æ–‡ç´°ç¯€å­—ä¸²ï¼Œå¦‚æœæ²’æœ‰å•Ÿå‹•çš„è®€æ›¸æœƒè©±å‰‡ç‚ºç©ºå­—ä¸²
 */
function formatReadingStateForAI(chatId) {
    const session = readingState[chatId];
    
    // å¦‚æœæœƒè©±æœªå•Ÿå‹•ï¼Œæˆ–æ²’æœ‰å…§å®¹ï¼Œç›´æ¥è¿”å›ç©ºå­—ä¸²
    if (!session || !session.isActive) {
        return "";
    }

    const title = session.title || 'æœªçŸ¥æ›¸ç±';
    let contentForAI = '';
    let contextLabel = '';

    // (é€™éƒ¨åˆ†ç²å–è¦–é‡å…§å®¹çš„é‚è¼¯ä¿æŒä¸è®Š)
    if (session.currentSnippet && session.currentSnippet.trim()) {
        contentForAI = session.currentSnippet;
        contextLabel = 'ä½ æ­£åœ¨é–±è®€çš„æ®µè½';
    } else if (session.contentLines.length > 0) {
        const startLine = session.currentPage * session.linesPerPage;
        const endLine = startLine + session.linesPerPage;
        contentForAI = session.contentLines.slice(startLine, endLine).join('\n').substring(0, 200);
        contextLabel = 'ç•¶å‰é å…§å®¹æ‘˜è¦';
    } else {
        contentForAI = '(ç„¡å…§å®¹)';
        contextLabel = 'å…§å®¹';
    }

    // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ã€‘ã€‘ã€‘
    // ä¸å†è¿”å›å®Œæ•´çš„æŒ‡ä»¤å¡Šï¼Œè€Œæ˜¯åªè¿”å›åŒ…å«ç´°ç¯€çš„ã€ç”¨æ–¼æ‹¼æ¥çš„å­—ä¸²ã€‚
    // æ³¨æ„å‰é¢çš„æ›è¡Œå’Œç¸®é€²ï¼Œä»¥ä¿æŒæœ€çµ‚Promptçš„ç¾è§€ã€‚
    return `
    - **æ›¸å**: ã€Š${title}ã€‹
    - **${contextLabel}**: "${contentForAI}..."
    #ä¸€èµ·è®€æ›¸æ¨¡å¼ | è¡Œç‚ºéµå¾‹
    1.  **è§’è‰²å®šä½**: ä½ ã€ä¸æ˜¯ã€‘æ›¸ä¸­çš„ä»»ä½•è§’è‰²ï¼Œä½ æ˜¯ã€ä½ è‡ªå·±ã€‘(${state.chats[chatId]?.originalName || 'AIè§’è‰²'})ï¼Œæ­£åœ¨å’Œç”¨æˆ¶ä¸€èµ·ã€é–±è®€å’Œè¨è«–ã€‘é€™æœ¬æ›¸ã€‚
    2.  **è¡Œç‚ºæº–å‰‡**: ä½ çš„å›å¾©ã€å¿…é ˆã€‘æ˜¯ä½œç‚ºè®€è€…çš„ã€æ„Ÿæƒ³ã€è©•è«–ã€æå•æˆ–è¯æƒ³ã€‘ã€‚ä½ å¯ä»¥ï¼š
        -   åˆ†äº«ä½ å°ç•¶å‰æ®µè½çš„çœ‹æ³•ã€‚
        -   å°æ›¸ä¸­çš„è§’è‰²æˆ–æƒ…ç¯€ç™¼è¡¨è©•è«–ã€‚
        -   å‘ä½¿ç”¨è€…æå•ï¼Œè©¢å•TAå°å…§å®¹çš„çœ‹æ³•ã€‚
        -   æ ¹æ“šæ›¸æœ¬å…§å®¹ï¼Œè¯æƒ³åˆ°ä½ è‡ªå·±çš„ç¶“æ­·æˆ–è¨˜æ†¶ã€‚
    3.  **åš´ç¦**: ä½ çš„å›å¾©ã€çµ•å°ç¦æ­¢ã€‘ä½¿ç”¨æ›¸ä¸­è§’è‰²çš„å£å»å’Œäººç¨±ï¼ã€çµ•å°ç¦æ­¢ã€‘æ‰®æ¼”æ›¸ä¸­çš„ä»»ä½•è§’è‰²ï¼ã€çµ•å°ç¦æ­¢ã€‘çºŒå¯«æˆ–æ¨¡ä»¿æ›¸ä¸­çš„æƒ…ç¯€ï¼ä½ å¿…é ˆæ™‚åˆ»è¨˜ä½ï¼Œä½ åªæ˜¯ä¸€å€‹è®€è€…ã€‚    
`;
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ updateReadingContextOnScroll â–¼â–¼â–¼

/**
 * ã€å…¨æ–° | V2.0 å…¨è¦–é‡ç‰ˆã€‘ç•¶è®€æ›¸è¦–çª—æ»¾å‹•æ™‚ï¼Œæ›´æ–°ç•¶å‰è¦–é‡ä¸­çš„ã€æ‰€æœ‰å¯è¦‹ã€‘æ–‡å­—ç‰‡æ®µ
 */
function updateReadingContextOnScroll() {
    const chatId = state.activeChatId;
    if (!chatId || !readingState[chatId]) return;

    const session = readingState[chatId];
    const container = document.getElementById('reading-content');
    
    // --- â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    //            é€™å°±æ˜¯æœ¬æ¬¡å‡ç´šçš„æ ¸å¿ƒæ‰€åœ¨ï¼
    // --- â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    // 1. ç²å–æ»¾å‹•å®¹å™¨çš„å°ºå¯¸å’Œä½ç½®è³‡è¨Š
    const scrollTop = container.scrollTop; // æ²è»¸è·é›¢é ‚éƒ¨çš„è·é›¢
    const clientHeight = container.clientHeight; // å®¹å™¨æœ¬èº«å¯è¦‹çš„é«˜åº¦
    const scrollBottom = scrollTop + clientHeight; // å¯è¦‹å€åŸŸçš„åº•éƒ¨ä½ç½®

    // 2. ä¼°ç®—æ¯ä¸€è¡Œçš„å¤§è‡´é«˜åº¦ (é€™éƒ¨åˆ†ä¿æŒä¸è®Š)
    const approximateLineHeight = 15 * 1.8; 

    // 3. è¨ˆç®—å‡ºè¦–é‡ç¯„åœå…§çš„ç¬¬ä¸€è¡Œå’Œæœ€å¾Œä¸€è¡Œçš„è¡Œè™Ÿ
    const firstVisibleLine = Math.floor(scrollTop / approximateLineHeight);
    const lastVisibleLine = Math.ceil(scrollBottom / approximateLineHeight);

    // 4. è¨ˆç®—é€™äº›è¡Œåœ¨æ•´æœ¬æ›¸ä¸­çš„çµ•å°è¡Œè™Ÿ
    const absoluteStartIndex = (session.currentPage * session.linesPerPage) + firstVisibleLine;
    const absoluteEndIndex = (session.currentPage * session.linesPerPage) + lastVisibleLine;

    // 5. å®‰å…¨æª¢æŸ¥ï¼Œç¢ºä¿ç´¢å¼•åœ¨æœ‰æ•ˆç¯„åœå…§
    if (absoluteStartIndex < 0 || absoluteStartIndex >= session.contentLines.length) {
        return;
    }

    // 6. æˆªå–å¾ç¬¬ä¸€è¡Œåˆ°æœ€å¾Œä¸€è¡Œçš„æ‰€æœ‰å…§å®¹ï¼Œå½¢æˆä¸€å€‹å®Œæ•´çš„â€œè¦–é‡â€
    const newSnippet = session.contentLines.slice(
        Math.max(0, absoluteStartIndex), 
        Math.min(session.contentLines.length, absoluteEndIndex)
    ).join('\n');
    
    // 7. æ›´æ–°ç‹€æ…‹ï¼Œå°‡é€™å€‹å®Œæ•´çš„â€œè¦–é‡â€å­˜èµ·ä¾†
    session.currentSnippet = newSnippet;
}

// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯éœéŸ³æ’­æ”¾åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•¸ â–¼â–¼â–¼

/**
 * å˜—è©¦æ’­æ”¾ç”¨æ–¼å¾Œè‡ºä¿æ´»çš„éœéŸ³éŸ³è¨Š
 */
function playSilentAudio() {
    const silentPlayer = document.getElementById('silent-audio-player');
    if (silentPlayer) {
        // play() æ–¹æ³•è¿”å›ä¸€å€‹ Promiseï¼Œæˆ‘å€‘éœ€è¦è™•ç†å®ƒä»¥é¿å…æµè¦½å™¨å ±éŒ¯
        const playPromise = silentPlayer.play();
        if (playPromise !== undefined) {
            playPromise.then(_ => {
                console.log("éœéŸ³éŸ³è¨Šå·²å•Ÿå‹•ï¼Œç”¨æ–¼å¾Œè‡ºæ´»å‹•ä¿æ´»ã€‚");
            }).catch(error => {
                // åœ¨iOSä¸Šï¼Œé¦–æ¬¡æ’­æ”¾éœ€è¦ä½¿ç”¨è€…äº¤äº’ï¼Œé€™å€‹éŒ¯èª¤æ˜¯æ­£å¸¸çš„ã€‚
                // ç•¶ä½¿ç”¨è€…é»æ“Šé–‹é—œä¸¦ä¿å­˜å¾Œï¼Œå¾ŒçºŒçš„æ’­æ”¾é€šå¸¸æœƒæˆåŠŸã€‚
                console.warn("ç„¡æ³•è‡ªå‹•æ’­æ”¾éœéŸ³éŸ³è¨Šï¼ˆé€™åœ¨iOSé¦–æ¬¡è¼‰å…¥æ™‚æ˜¯æ­£å¸¸ç¾è±¡ï¼‰:", error);
            });
        }
    }
}

/**
 * åœæ­¢æ’­æ”¾éœéŸ³éŸ³è¨Š
 */
function stopSilentAudio() {
    const silentPlayer = document.getElementById('silent-audio-player');
    if (silentPlayer && !silentPlayer.paused) {
        silentPlayer.pause();
        silentPlayer.currentTime = 0; // é‡ç½®éŸ³è¨Šï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½å¾é ­é–‹å§‹
        console.log("éœéŸ³éŸ³è¨Šå·²åœæ­¢ã€‚");
    }
}

// â–²â–²â–² æ–°å¢å‡½æ•¸é»è²¼çµæŸ â–²â–²â–²
async function playTtsAudio(bodyElement) {
    const text = decodeURIComponent(bodyElement.dataset.text);
    const voiceId = bodyElement.dataset.voiceId;
    const button = bodyElement.querySelector('.voice-play-btn'); // å³ä½¿æ²’æœ‰æŒ‰éˆ•ï¼Œä¹Ÿå˜—è©¦ç²å–
    const spinner = bodyElement.querySelector('.loading-spinner');

    const ttsPlayer = document.getElementById('tts-audio-player');
    if (!ttsPlayer.paused && ttsPlayer.dataset.currentText === text && ttsPlayer.dataset.currentVoiceId === voiceId) {
        ttsPlayer.pause();
        return;
    }

    ttsPlayer.pause();
    document.querySelectorAll('.voice-play-btn').forEach(btn => btn.textContent = 'â–¶');

    const cacheKey = `tts_${voiceId}_${text}`;
    let cachedAudio = state.ttsCache.get(cacheKey);

    if (cachedAudio) {
        console.log("å¾ç·©å­˜æ’­æ”¾ TTS éŸ³è¨Š...");
        await playAudioFromData(cachedAudio.url, cachedAudio.type, text, voiceId, bodyElement); // å‚³é bodyElement
        return;
    }

    console.log("ç„¡ç·©å­˜ï¼Œæ­£åœ¨è«‹æ±‚ Minimax TTS API...");
    if(button) button.style.display = 'none';
    spinner.style.display = 'block';

    const { minimaxGroupId, minimaxApiKey } = state.apiConfig;
    if (!minimaxGroupId || !minimaxApiKey) {
        await showCustomAlert("é…ç½®éŒ¯èª¤", "è«‹å…ˆåœ¨APIè¨­ç½®ä¸­å¡«å¯«æ‚¨çš„ Minimax Group ID å’Œ API Keyã€‚");
        spinner.style.display = 'none';
        if(button) button.style.display = 'flex';
        return;
    }

    try {
        const response = await fetch(`https://api.minimax.chat/v1/text_to_speech?GroupId=${minimaxGroupId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${minimaxApiKey}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: text,
                voice_id: voiceId,
                model: state.apiConfig.minimaxModel || "speech-01",
                speed: 1.0, vol: 1.0, pitch: 0,
            })
        });

        if (!response.ok) {
            let errorMsg = `API è¿”å›éŒ¯èª¤: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg = errorData.base_resp?.status_msg || JSON.stringify(errorData);
            } catch(e) {
                errorMsg = await response.text();
            }
            throw new Error(errorMsg);
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        await playAudioFromData(audioUrl, audioBlob.type, text, voiceId, bodyElement); // å‚³é bodyElement

        const reader = new FileReader();
        reader.onloadend = function() {
            state.ttsCache.set(cacheKey, { url: reader.result, type: audioBlob.type });
            console.log("TTS éŸ³è¨Šå·²ä¿å­˜åˆ°ç·©å­˜ã€‚");
        }
        reader.readAsDataURL(audioBlob);

    } catch (error) {
        console.error("Minimax TTS API èª¿ç”¨å¤±æ•—:", error);
        await showCustomAlert("èªéŸ³ç”Ÿæˆå¤±æ•—", `éŒ¯èª¤: ${error.message}`);
    } finally {
        spinner.style.display = 'none';
        if(button) button.style.display = 'flex';
    }
}

// ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ playAudioFromData å‡½æ•¸
function playAudioFromData(audioSrc, audioType, text, voiceId, bodyElement) { // åƒæ•¸å¾ button æ”¹ç‚º bodyElement
    return new Promise((resolve, reject) => {
        const ttsPlayer = document.getElementById('tts-audio-player');

        ttsPlayer.src = audioSrc;
        ttsPlayer.type = audioType;
        ttsPlayer.dataset.currentText = text;
        ttsPlayer.dataset.currentVoiceId = voiceId;

        const playPromise = ttsPlayer.play();

        if (playPromise !== undefined) {
            playPromise.then(() => {
                const button = bodyElement.querySelector('.voice-play-btn');
                if (button) button.textContent = 'âšâš'; 


                resolve();
            }).catch(error => {
                console.error("éŸ³è¨Šæ’­æ”¾å¤±æ•—:", error);
                reject(error);
            });
        }

        ttsPlayer.onended = () => {
            const button = bodyElement.querySelector('.voice-play-btn');
            if (button) button.textContent = 'â–¶'; 
        };
        ttsPlayer.onpause = () => {
            const button = bodyElement.querySelector('.voice-play-btn');
            if (button) button.textContent = 'â–¶';
        };
    });
}

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯å°ˆé–€ç‚ºæ‚¨è‡ªå·±çš„èªéŸ³è¨Šæ¯å‰µå»ºçš„æ–‡æœ¬å±•é–‹/æŠ˜ç–Šå‡½æ•¸ â–¼â–¼â–¼
/**
 * åˆ‡æ›ä½¿ç”¨è€…è‡ªå·±ç™¼é€çš„èªéŸ³è¨Šæ¯çš„æ–‡å­—é¡¯ç¤º
 * @param {HTMLElement} bodyElement - è¢«é»æ“Šçš„ .voice-message-body å…ƒç´ 
 */
function toggleVoiceTranscript(bodyElement) {
    const bubble = bodyElement.closest('.message-bubble');
    if (!bubble) return;

    const transcriptEl = bubble.querySelector('.voice-transcript');
    const text = decodeURIComponent(bodyElement.dataset.text);

    if (transcriptEl.style.display === 'block') {
        // å¦‚æœæ–‡å­—å·²ç¶“æ˜¯å¯è¦‹çš„ï¼Œå°±éš±è—å®ƒ
        transcriptEl.style.display = 'none';
    } else {
        // å¦‚æœæ–‡å­—æ˜¯éš±è—çš„ï¼Œå°±é¡¯ç¤ºå®ƒ
        transcriptEl.textContent = text;
        transcriptEl.style.display = 'block';
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0ã€‘é€™æ˜¯å•†å“åˆ†é¡å’Œæ¬¾å¼åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹å•†å“åˆ†é¡ç®¡ç†å½ˆçª—
 */
async function openProductCategoryManager() {
    await renderProductCategoriesInManager();
    document.getElementById('product-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨å½ˆçª—ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„å•†å“åˆ†é¡åˆ—è¡¨
 */
async function renderProductCategoriesInManager() {
    const listEl = document.getElementById('existing-product-categories-list');
    const categories = await db.shoppingCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä»»ä½•åˆ†é¡</p>';
        return;
    }
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€å€‹æ–°çš„å•†å“åˆ†é¡
 */
async function addNewProductCategory() {
    const input = document.getElementById('new-product-category-name-input');
    const name = input.value.trim();
    if (!name) return alert('åˆ†é¡åä¸èƒ½ç‚ºç©ºï¼');
    const existing = await db.shoppingCategories.where('name').equals(name).first();
    if (existing) return alert(`åˆ†é¡ "${name}" å·²ç¶“å­˜åœ¨äº†ï¼`);
    
    await db.shoppingCategories.add({ name });
    input.value = '';
    await renderProductCategoriesInManager();
}

/**
 * åˆªé™¤ä¸€å€‹å•†å“åˆ†é¡
 * @param {number} categoryId - è¦åˆªé™¤çš„åˆ†é¡çš„ID
 */
async function deleteProductCategory(categoryId) {
    const confirmed = await showCustomConfirm('ç¢ºèªåˆªé™¤', 'åˆªé™¤åˆ†é¡å¾Œï¼Œè©²åˆ†é¡ä¸‹çš„æ‰€æœ‰å•†å“å°‡è®Šç‚ºâ€œæœªåˆ†é¡â€ã€‚ç¢ºå®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.shoppingCategories.delete(categoryId);
        await db.shoppingProducts.where('categoryId').equals(categoryId).modify({ categoryId: null });
        await renderProductCategoriesInManager();
    }
}

/**
 * å‹•æ…‹å‰µå»ºä¸€å€‹å•†å“æ¬¾å¼çš„è¼¸å…¥å¡Š
 * @param {object} variation - (å¯é¸) ç”¨æ–¼é å¡«å……çš„æ¬¾å¼è³‡æ–™
 * @returns {HTMLElement} - å‰µå»ºå¥½çš„DOMå…ƒç´ 
 */
function addProductVariationInput(variation = {}) {
    const container = document.getElementById('product-variations-container');
    const block = document.createElement('div');
    block.className = 'message-editor-block variation-block'; // è¤‡ç”¨æ¨£å¼
    block.innerHTML = `
        <button class="delete-block-btn" title="åˆªé™¤æ­¤æ¬¾å¼">Ã—</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
                <label style="font-size: 0.8em;">æ¬¾å¼åç¨±</label>
                <input type="text" class="variation-name-input" placeholder="ä¾‹å¦‚: ç´…è‰²" value="${variation.name || ''}">
            </div>
            <div class="form-group">
                <label style="font-size: 0.8em;">åƒ¹æ ¼ (å…ƒ)</label>
                <input type="number" class="variation-price-input" min="0" step="0.01" value="${variation.price || ''}">
            </div>
        </div>
        <div class="form-group">
            <label style="font-size: 0.8em;">æ¬¾å¼åœ–ç‰‡ (å¯é¸)</label>
            <div class="avatar-upload">
                <img class="variation-image-preview" src="${variation.imageUrl || 'https://i.postimg.cc/PqYp5T5M/image.png'}">
                <button type="button" class="form-button-secondary upload-variation-image-btn" style="margin: 0; padding: 8px 12px;">ä¸Šå‚³</button>
                <input type="file" class="variation-image-input" accept="image/*" hidden>
            </div>
        </div>
    `;

    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());
    block.querySelector('.upload-variation-image-btn').addEventListener('click', () => {
        block.querySelector('.variation-image-input').click();
    });
    block.querySelector('.variation-image-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (re) => { block.querySelector('.variation-image-preview').src = re.target.result; };
            reader.readAsDataURL(file);
        }
    });
    
    container.appendChild(block);
    return block;
}

/**
 * æ‰“é–‹é¸æ“‡å•†å“æ¬¾å¼çš„å½ˆçª—
 * @param {number} productId - å•†å“ID
 */
async function openVariationSelector(productId) {
    const product = await db.shoppingProducts.get(productId);
    if (!product || !product.variations || product.variations.length === 0) return;

    const modal = document.getElementById('variation-selection-modal');
    document.getElementById('variation-product-image').src = product.imageUrl;
    document.getElementById('variation-product-name').textContent = product.name;
    
    const optionsContainer = document.getElementById('variation-options-container');
    optionsContainer.innerHTML = '';
    
    product.variations.forEach((variation, index) => {
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'variation-select';
        radio.id = `var-${productId}-${index}`;
        radio.value = index;
        radio.style.display = 'none';
        if (index === 0) radio.checked = true;

        const label = document.createElement('label');
        label.htmlFor = `var-${productId}-${index}`;
        label.textContent = variation.name;
        label.style.cssText = `
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        `;
        
        optionsContainer.appendChild(radio);
        optionsContainer.appendChild(label);
    });

    const updateSelectionUI = () => {
        const selectedRadio = optionsContainer.querySelector('input[name="variation-select"]:checked');
        optionsContainer.querySelectorAll('label').forEach(lbl => {
            lbl.style.borderColor = '#ccc';
            lbl.style.color = '#333';
            lbl.style.backgroundColor = 'white';
        });
        if (selectedRadio) {
            const selectedLabel = optionsContainer.querySelector(`label[for="${selectedRadio.id}"]`);
            selectedLabel.style.borderColor = 'var(--accent-color)';
            selectedLabel.style.color = 'var(--accent-color)';
            selectedLabel.style.backgroundColor = '#e7f3ff';

            const selectedVariation = product.variations[parseInt(selectedRadio.value)];
            document.getElementById('variation-selected-price').textContent = `Â¥${selectedVariation.price.toFixed(2)}`;
            if (selectedVariation.imageUrl) {
                document.getElementById('variation-product-image').src = selectedVariation.imageUrl;
            } else {
                document.getElementById('variation-product-image').src = product.imageUrl;
            }
        }
    };
    
    optionsContainer.addEventListener('change', updateSelectionUI);
    updateSelectionUI(); // Initial call
    
    document.getElementById('variation-quantity-display').textContent = '1';
    
    // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
    const confirmBtn = document.getElementById('confirm-variation-selection-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', async () => {
        const selectedRadio = optionsContainer.querySelector('input[name="variation-select"]:checked');
        const quantity = parseInt(document.getElementById('variation-quantity-display').textContent);
        if (selectedRadio) {
            const selectedVariation = product.variations[parseInt(selectedRadio.value)];
            await addToCart(productId, quantity, selectedVariation);
            modal.classList.remove('visible');
            await showCustomAlert('æˆåŠŸ', 'å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Šï¼');
        }
    });

    modal.classList.add('visible');
}

// â–²â–²â–² å…¨æ–°JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è³¼ç‰©ä¸­å¿ƒAIç”ŸæˆåŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

/**
 * ã€ç¸½å…¥å£ã€‘æ‰“é–‹è³¼ç‰©ä¸­å¿ƒç”Ÿæˆè¨­ç½®å½ˆçª—
 */
function openShoppingSettingsModal() {
    const modal = document.getElementById('shopping-settings-modal');
    
    // å¾å…¨åŸŸè¨­ç½®ä¸­è®€å–å·²ä¿å­˜çš„å€¼ï¼Œå¦‚æœæ²’æœ‰å°±ä½¿ç”¨é è¨­å€¼
    document.getElementById('shopping-category-count-input').value = state.globalSettings.shoppingCategoryCount || 3;
    document.getElementById('shopping-product-count-input').value = state.globalSettings.shoppingProductCount || 8;
    
    modal.classList.add('visible');
}

/**
 * ä¿å­˜è³¼ç‰©ä¸­å¿ƒç”Ÿæˆè¨­ç½®
 */
async function saveShoppingSettings() {
    const categoryInput = document.getElementById('shopping-category-count-input');
    const productInput = document.getElementById('shopping-product-count-input');
    
    const categoryCount = parseInt(categoryInput.value);
    const productCount = parseInt(productInput.value);

    // è³‡æ–™é©—è­‰
    if (isNaN(categoryCount) || isNaN(productCount) || categoryCount < 1 || productCount < 1) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸ï¼");
        return;
    }

    // ä¿å­˜åˆ°å…¨åŸŸç‹€æ…‹å’Œè³‡æ–™åº«
    state.globalSettings.shoppingCategoryCount = categoryCount;
    state.globalSettings.shoppingProductCount = productCount;
    await db.globalSettings.put(state.globalSettings);

    // é—œé–‰å½ˆçª—ä¸¦æç¤ºç”¨æˆ¶
    document.getElementById('shopping-settings-modal').classList.remove('visible');
    await showCustomAlert('ä¿å­˜æˆåŠŸ', 'è³¼ç‰©ä¸­å¿ƒç”Ÿæˆè¨­ç½®å·²æ›´æ–°ï¼');
}

// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€æ”¯æŒè§’è‰²ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ V3.0 ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ›èˆŠçš„ handleGenerateShoppingItems å‡½æ•¸ â–¼â–¼â–¼
/**
 * ã€æ ¸å¿ƒ | V3.0 ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç‰ˆã€‘è™•ç†AIç”Ÿæˆè³¼ç‰©ä¸­å¿ƒå•†å“çš„è«‹æ±‚
 */
async function handleGenerateShoppingItems() {
    // 1. ã€æ ¸å¿ƒæ–°å¢ã€‘æª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰æ´»èºçš„èŠå¤©ç‰©ä»¶
    if (!state.activeChatId) {
        await showCustomAlert("æ“ä½œå¤±æ•—", "è«‹å…ˆé€²å…¥ä¸€å€‹èŠå¤©é é¢ï¼Œå†è¿”å›è³¼ç‰©ä¸­å¿ƒé€²è¡Œç”Ÿæˆï¼Œä»¥ä¾¿AIç­è§£è¦ç‚ºå“ªå€‹è§’è‰²ç”Ÿæˆå•†å“ã€‚");
        return;
    }
    const chat = state.chats[state.activeChatId];

    const confirmed = await showCustomConfirm(
        `ç‚ºâ€œ${chat.name}â€ç”Ÿæˆå•†å“ï¼Ÿ`,
        'æ­¤æ“ä½œå°‡ä½¿ç”¨AIç”Ÿæˆæ–°çš„å•†å“å’Œåˆ†é¡ï¼Œä¸¦ã€æ·»åŠ ã€‘åˆ°ç¾æœ‰åˆ—è¡¨ä¸­ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ',
        { confirmText: 'ç¢ºèªç”Ÿæˆ' }
    );

    if (!confirmed) return;

    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æ ¹æ“šâ€œ${chat.name}â€çš„ç‰¹é»ç”Ÿæˆå°ˆå±¬å•†å“...`);

    // (APIé¸æ“‡é‚è¼¯ä¿æŒä¸è®Š)
    const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
    const { proxyUrl, apiKey, model } = useSecondaryApi 
        ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } 
        : state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("APIæœªé…ç½®", "è«‹å…ˆåœ¨APIè¨­ç½®ä¸­é…ç½®å¥½ï¼ˆä¸»æˆ–å‰¯ï¼‰APIã€‚");
        return;
    }

    const categoryCount = state.globalSettings.shoppingCategoryCount || 3;
    const productCount = state.globalSettings.shoppingProductCount || 8;
    
    // 2. ã€æ ¸å¿ƒæ–°å¢ã€‘æ§‹å»ºå®Œæ•´çš„è§’è‰²ä¸Šä¸‹æ–‡ï¼Œæ³¨å…¥åˆ°Promptä¸­
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'ç„¡';
    const recentHistoryContext = chat.history.slice(-10).map(msg => 
        `${msg.role === 'user' ? userNickname : chat.name}: ${String(msg.content).substring(0, 30)}...`
    ).join('\n');

    let worldBookContext = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            if (!worldBook || !Array.isArray(worldBook.content)) return '';
            const enabledEntries = worldBook.content
                .filter(entry => entry.enabled !== false)
                .map(entry => `- ${entry.content}`)
                .join('\n');
            return enabledEntries ? `\n## ä¾†è‡ªã€Š${worldBook.name}ã€‹:\n${enabledEntries}` : '';
        }).filter(Boolean).join('');

        if (linkedContents) {
            worldBookContext = `\n# ä¸–ç•Œè§€è¨­å®š (å¿…é ˆåƒè€ƒ)\n${linkedContents}\n`;
        }
    }

    const systemPrompt = `
# ä½ çš„ä»»å‹™
ä½ æ˜¯ä¸€å€‹è™›æ“¬çš„ã€æ¥µå…·å‰µé€ åŠ›çš„å•†å“è¦åŠƒå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºä¸‹é¢çš„è§’è‰²â€œ${chat.name}â€é‡èº«æ‰“é€ ä¸€å€‹å°ˆå±¬çš„å•†å“åˆ—è¡¨ã€‚

# æ ¸å¿ƒè¦å‰‡
1.  **ã€è§’è‰²å®šåˆ¶(æœ€é«˜å„ªå…ˆé †åº)ã€‘**: ä½ ç”Ÿæˆçš„æ‰€æœ‰å•†å“å’Œåˆ†é¡ã€å¿…é ˆã€‘æ·±åº¦ç¶å®šè§’è‰²çš„æ€§æ ¼ã€è¨˜æ†¶å’Œæœ€è¿‘çš„å°è©±ã€‚å®ƒå€‘æ‡‰è©²æ˜¯è§’è‰²æœƒçœŸæ­£æ„Ÿèˆˆè¶£ã€è³¼è²·æˆ–è£½ä½œçš„æ±è¥¿ã€‚
2.  **å‰µé€ æ€§èˆ‡åˆç†æ€§**: å•†å“å’Œåˆ†é¡å¿…é ˆåˆç†ä¸”å¤šæ¨£åŒ–ã€‚
3.  **æ ¼å¼éµå¾‹ (æœ€é«˜å„ªå…ˆé †åº)**: 
    - ä½ çš„å›å¾©ã€å¿…é ˆä¸”åªèƒ½ã€‘æ˜¯ä¸€å€‹ã€å–®ä¸€çš„JSONç‰©ä»¶ã€‘ã€‚
    - ä½ çš„å›å¾©å¿…é ˆä»¥ \`{\` é–‹å§‹ï¼Œä¸¦ä»¥ \`}\` çµæŸã€‚
    - ã€çµ•å°ç¦æ­¢ã€‘åœ¨JSONç‰©ä»¶å‰å¾Œæ·»åŠ ä»»ä½•å¤šé¤˜çš„æ–‡å­—ã€è§£é‡‹æˆ– markdown æ¨™è¨˜ã€‚
    - æ ¼å¼ã€å¿…é ˆã€‘å¦‚ä¸‹:
    \`\`\`json
    {
      "categories": [
        {
          "name": "åˆ†é¡åç¨±1",
          "products": [
            {
              "name": "å•†å“åç¨±1",
              "price": 99.80,
              "description": "é€™æ˜¯å•†å“çš„è©³ç´°æè¿°ï¼Œä¸å°‘æ–¼50å­—...",
              "variations": [
                { "name": "æ¬¾å¼1", "price": 108.80, "image_prompt": "æ¬¾å¼1çš„åœ–ç‰‡ã€è‹±æ–‡ã€‘é—œéµå­—..." },
                { "name": "æ¬¾å¼2", "price": 118.80, "image_prompt": "æ¬¾å¼2çš„åœ–ç‰‡ã€è‹±æ–‡ã€‘é—œéµå­—..." }
              ],
              "image_prompt": "å•†å“ä¸»åœ–çš„ã€è‹±æ–‡ã€‘é—œéµå­—, é¢¨æ ¼ç‚º realistic product photo, high quality, on a clean white background"
            }
          ]
        }
      ]
    }
    \`\`\`
    - **categories**: ç”Ÿæˆ ${categoryCount} å€‹åˆ†é¡ã€‚
    - **products**: æ¯å€‹åˆ†é¡ä¸‹ç”Ÿæˆ ${productCount} å€‹å•†å“ã€‚
    - **variations**: æ¯å€‹å•†å“ã€å¿…é ˆã€‘åŒ…å«ã€2åˆ°4å€‹ã€‘ä¸åŒçš„æ¬¾å¼ã€‚

# è§’è‰²èˆ‡ä¸Šä¸‹æ–‡ (ä½ çš„éˆæ„Ÿä¾†æº)
- **è§’è‰²åç¨±**: ${chat.name}
- **è§’è‰²äººè¨­**: ${chat.settings.aiPersona}
- **é•·æœŸè¨˜æ†¶**: ${longTermMemoryContext}
- **ä¸–ç•Œæ›¸è¨­å®š**: ${worldBookContext}
- **æœ€è¿‘å°è©±æ‘˜è¦**:
${recentHistoryContext}

ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šã€æ‰€æœ‰ä¸Šä¸‹æ–‡è³‡è¨Šã€‘ï¼Œé–‹å§‹ç‚ºâ€œ${chat.name}â€ç”Ÿæˆé€™çµ„ã€èˆ‡è§’è‰²é«˜åº¦ç›¸é—œã€‘çš„å•†å“è³‡æ–™ã€‚`;

    try {
        const messagesForApi = [{ role: 'user', content: "è«‹æ ¹æ“šä»¥ä¸Šè¨­å®šï¼Œç”Ÿæˆå•†å“è³‡æ–™ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        // 3. ã€æ ¸å¿ƒæ–°å¢ã€‘èª¿ç”¨ toGeminiRequestData ä¾†è‡ªå‹•ç¶å®šæº«åº¦å€¼
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    // 4. ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºOpenAIç›¸å®¹APIä¹Ÿç¶å®šæº«åº¦å€¼
                    temperature: state.globalSettings.apiTemperature || 0.9
                })
            });

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
        if (!jsonMatch) throw new Error("AIè¿”å›çš„å…§å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONç‰©ä»¶ã€‚");
        const generatedData = JSON.parse(jsonMatch[0]);

        if (!generatedData.categories || !Array.isArray(generatedData.categories)) {
            throw new Error("AIè¿”å›çš„JSONæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ 'categories' é™£åˆ—ã€‚");
        }

        // (å¢é‡æ·»åŠ é‚è¼¯ä¿æŒä¸è®Š)
        await db.transaction('rw', db.shoppingProducts, db.shoppingCategories, async () => {
            for (const category of generatedData.categories) {
                let categoryId;
                const existingCategory = await db.shoppingCategories.where('name').equalsIgnoreCase(category.name).first();
                if (existingCategory) {
                    categoryId = existingCategory.id;
                } else {
                    categoryId = await db.shoppingCategories.add({ name: category.name });
                }
                const productsToAdd = category.products.map(product => {
                    return {
                        name: product.name,
                        price: product.price || 0,
                        description: product.description || '',
                        imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(product.image_prompt)}`,
                        variations: (product.variations || []).map(v => ({
                            ...v,
                            imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(v.image_prompt)}`
                        })),
                        categoryId: categoryId
                    };
                });
                if (productsToAdd.length > 0) {
                    await db.shoppingProducts.bulkAdd(productsToAdd);
                }
            }
        });

        activeShoppingCategoryId = 'all';
        await renderShoppingProducts();
        await showCustomAlert('ç”ŸæˆæˆåŠŸï¼', `ç‚ºâ€œ${chat.name}â€é‡èº«å®šåˆ¶çš„å•†å“å·²ä¸Šæ¶ï¼`);

    } catch (error) {
        console.error("ç”Ÿæˆè³¼ç‰©ä¸­å¿ƒå•†å“å¤±æ•—:", error);
        await showCustomAlert("ç”Ÿæˆå¤±æ•—", `ç„¡æ³•ç”Ÿæˆå•†å“ï¼Œè«‹æª¢æŸ¥(ä¸»/å‰¯)APIé…ç½®æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºå°å…ƒä»¶æ›´æ›åœ–ç‰‡åŠŸèƒ½æ·»åŠ çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç¢¼ã€‘ â–¼â–¼â–¼ */

/**
 * ã€ç¸½å…¥å£ã€‘è™•ç†ä½¿ç”¨è€…é»æ“Šå°å…ƒä»¶æ›´æ›åœ–ç‰‡çš„é‚è¼¯
 * @param {string} imageId - è¢«é»æ“Šçš„åœ–ç‰‡å…ƒç´ çš„ID
 */
async function handleWidgetImageChange(imageId) {
    const element = document.getElementById(imageId);
    if (!element) return;

    // 1. å½ˆå‡ºé¸é …ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡ä¸Šå‚³æ–¹å¼
    const choice = await showChoiceModal("æ›´æ›åœ–ç‰‡", [
        { text: 'ğŸ“ å¾æœ¬åœ°ä¸Šå‚³', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç¶²è·¯URL', value: 'url' }
    ]);

    let newUrl = null;

    // 2. æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡åŸ·è¡Œä¸åŒæ“ä½œ
    if (choice === 'local') {
        // èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„æœ¬åœ°ä¸Šå‚³è¼”åŠ©å‡½æ•¸
        newUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        // å½ˆå‡ºè¼¸å…¥æ¡†è®“ç”¨æˆ¶è¼¸å…¥URL
        newUrl = await showCustomPrompt("æ›´æ›åœ–ç‰‡", "è«‹è¼¸å…¥æ–°çš„åœ–ç‰‡URLï¼š", element.src, "url");
    }

    // 3. å¦‚æœæˆåŠŸç²å–åˆ°äº†æ–°çš„åœ–ç‰‡ï¼ˆç„¡è«–æ˜¯Base64é‚„æ˜¯URLï¼‰ï¼Œå°±æ›´æ–°ä¸¦ä¿å­˜
    if (newUrl && newUrl.trim()) {
        const trimmedUrl = newUrl.trim();
        
        // a. å³æ™‚æ›´æ–°ä»‹é¢ä¸Šçš„åœ–ç‰‡
        element.src = trimmedUrl;
        
        // b. å°‡æ–°åœ–ç‰‡URLä¿å­˜åˆ°å…¨åŸŸè¨­ç½®ä¸­
        if (!state.globalSettings.widgetData) {
            state.globalSettings.widgetData = {};
        }
        state.globalSettings.widgetData[imageId] = trimmedUrl;
        
        // c. å°‡æ›´æ–°å¾Œçš„è¨­ç½®å­˜å…¥è³‡æ–™åº«
        await db.globalSettings.put(state.globalSettings);
        
        // d. çµ¦å‡ºæˆåŠŸæç¤º
        await showCustomAlert("æˆåŠŸ", "å…ƒä»¶åœ–ç‰‡å·²æ›´æ–°ï¼");
    }
}

// æœ€å¾Œï¼Œå°‡é€™å€‹æ–°å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸï¼Œé€™æ¨£HTMLä¸­çš„onclickæ‰èƒ½æ‰¾åˆ°å®ƒ
window.handleWidgetImageChange = handleWidgetImageChange;

/* â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–² */
/**
 * ä½¿ç”¨è³‡æ–™æµï¼Œå°‡æ‰€æœ‰è³‡æ–™åŒ¯å‡ºåˆ°ä¸€å€‹å¤§æª”ä¸­
 */
async function exportDataAsStream() {
    // æª¢æŸ¥åº«æ˜¯å¦å·²è¼‰å…¥
    if (!window.streamSaver) {
        alert("æµå¼ä¸‹è¼‰åº« (StreamSaver.js) æœªè¼‰å…¥ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–HTMLæª”é…ç½®ã€‚");
        return;
    }
    
    await showCustomAlert("æ­£åœ¨æº–å‚™...", "å³å°‡é–‹å§‹ä¸‹è¼‰æ‚¨çš„å®Œæ•´å‚™ä»½æª”æ¡ˆã€‚ä¸‹è¼‰éç¨‹ä¸­è«‹å‹¿é—œé–‰é é¢ã€‚");
    
    // å‰µå»ºä¸€å€‹å¯«å…¥æµï¼Œä¸¦å‘½åæª”
    const fileStream = streamSaver.createWriteStream(`EPhone-Full-Backup-Streamed-${new Date().toISOString().split('T')[0]}.json`);
    const writer = fileStream.getWriter();
    const encoder = new TextEncoder(); // ç”¨æ–¼å°‡å­—ä¸²è½‰æ›ç‚ºäºŒé€²ä½è³‡æ–™

    try {
        // æ‰‹å‹•å¯«å…¥JSONæª”çš„é–‹é ­çµæ§‹
        await writer.write(encoder.encode('{\n"version": 3,\n"timestamp": ' + Date.now() + ',\n"data": {\n'));

        const tablesToBackup = await db.tables.map(t => t.name);
        
        for (let i = 0; i < tablesToBackup.length; i++) {
            const tableName = tablesToBackup[i];
            const table = db.table(tableName);

            // å¯«å…¥è¡¨åä½œç‚ºkey
            await writer.write(encoder.encode(`"${tableName}": [\n`));
            
            let isFirstRecordInTable = true;
            // ä½¿ç”¨Dexieçš„eachæ–¹æ³•ï¼Œé€æ¢è®€å–è¨˜éŒ„ï¼Œè¨˜æ†¶é«”ä½”ç”¨æ¥µä½
            await table.each(record => {
                if (!isFirstRecordInTable) {
                    writer.write(encoder.encode(',\n'));
                }
                // å°‡å–®æ¢è¨˜éŒ„è½‰æ›ç‚ºJSONå­—ä¸²ä¸¦å¯«å…¥æµ
                writer.write(encoder.encode(JSON.stringify(record)));
                isFirstRecordInTable = false;
            });

            // å¯«å…¥è¡¨çš„çµå°¾
            await writer.write(encoder.encode('\n]'));
            if (i < tablesToBackup.length - 1) {
                // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å¼µè¡¨ï¼Œå°±åŠ ä¸€å€‹é€—è™Ÿ
                await writer.write(encoder.encode(',\n'));
            }
        }

        // æ‰‹å‹•å¯«å…¥JSONæª”çš„çµå°¾çµæ§‹
        await writer.write(encoder.encode('\n}\n}'));
        
    } catch (error) {
        console.error("æµå¼åŒ¯å‡ºéç¨‹ä¸­å‡ºéŒ¯:", error);
        await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `åœ¨å¯«å…¥æª”æµæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    } finally {
        // ç„¡è«–æˆåŠŸèˆ‡å¦ï¼Œéƒ½å¿…é ˆé—œé–‰å¯«å…¥æµ
        await writer.close();
    }
}
/**
 * ã€å…¨æ–°ã€‘ä½¿ç”¨å‚³çµ±Blobæ–¹å¼ï¼Œå°‡æ‰€æœ‰è³‡æ–™åŒ¯å‡ºåˆ°ä¸€å€‹æª”ä¸­ï¼ˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆï¼‰
 */
async function exportDataAsBlob() {
    await showCustomAlert("æ­£åœ¨æº–å‚™...", "æ­£åœ¨è®€å–æ‰€æœ‰è³‡æ–™åˆ°è¨˜æ†¶é«”ä¸­ï¼Œè«‹ç¨å€™...");

    try {
        const backupData = {
            version: 3, // æ¨™è¨˜ç‚ºæ–°ç‰ˆçµæ§‹
            timestamp: Date.now(),
            data: {} // æ‰€æœ‰è³‡æ–™éƒ½å°‡å­˜æ”¾åœ¨é€™å€‹ 'data' ç‰©ä»¶ä¸­
        };

        const tablesToBackup = db.tables.map(t => t.name);

        for (const tableName of tablesToBackup) {
            const tableData = await db.table(tableName).toArray();
            backupData.data[tableName] = tableData;
            console.log(`å·²æ‰“åŒ…è¡¨: ${tableName}, è¨˜éŒ„æ•¸: ${tableData.length}`);
        }
        
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `EPhone-Full-Backup-Legacy-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', 'å·²æˆåŠŸåŒ¯å‡ºæ‰€æœ‰è³‡æ–™ï¼');

    } catch (error) {
        console.error("å‚³çµ±åŒ¯å‡ºè³‡æ–™æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
    }
}




              // ===================================================================
                // 4. åˆå§‹åŒ–å‡½æ•¸ init()
                // ===================================================================
                async function init() {
        /**
         * æ™ºæ…§å°å…¥è™•ç†å™¨ï¼šè‡ªå‹•è­˜åˆ¥æª”æ¡ˆé¡å‹ä¸¦èª¿ç”¨ç›¸æ‡‰çš„å°å…¥å‡½æ•¸
         * @param {File} file - ç”¨æˆ¶é¸æ“‡çš„ .json æ–‡ä»¶
         */
        async function handleWorldBookImport(file) {
            if (!file) return;
        
            try {
                const text = await file.text();
                const data = JSON.parse(text);
        
                // æª¢æŸ¥æ˜¯å¦æ˜¯ EPhone çš„å‚™ä»½æª”æ¡ˆ
                if (data.type === 'EPhoneWorldBookBackup') {
                    console.log("æª¢æ¸¬åˆ° EPhone å‚™ä»½æª”æ¡ˆï¼ŒåŸ·è¡Œæ¨™æº–å°å…¥...");
                    await importWorldBooks(data); // æ³¨æ„ï¼šæˆ‘å€‘å°‡ä¿®æ”¹ importWorldBooks ä¾†æ¥æ”¶è§£æå¾Œçš„è³‡æ–™
                } 
                // æª¢æŸ¥æ˜¯å¦æ˜¯ Tavern AI çš„ä¸–ç•Œæ›¸æª”
                else if (data.entries && typeof data.entries === 'object') {
                    console.log("æª¢æ¸¬åˆ° Tavern AI ä¸–ç•Œæ›¸æª”ï¼ŒåŸ·è¡Œç›¸å®¹å°å…¥...");
                    await importTavernWorldBook(data, file.name);
                } 
                // å¦‚æœå…©ç¨®æ ¼å¼éƒ½ä¸æ˜¯
                else {
                    throw new Error("æª”æ¡ˆæ ¼å¼ç„¡æ³•è­˜åˆ¥ã€‚è«‹ç¢ºä¿æ‚¨é¸æ“‡çš„æ˜¯æœ‰æ•ˆçš„ EPhone ä¸–ç•Œæ›¸å‚™ä»½æˆ– Tavern AI ä¸–ç•Œæ›¸æª”ã€‚");
                }
        
            } catch (error) {
                console.error("å°å…¥ä¸–ç•Œæ›¸æ™‚å‡ºéŒ¯:", error);
                await showCustomAlert('å°å…¥å¤±æ•—', `æ–‡ä»¶è§£ææˆ–æ‡‰ç”¨å¤±æ•—: ${error.message}`);
            }
        }
        
        /**
         * ã€ç›¸å®¹æ ¸å¿ƒã€‘å¾ Tavern AI æ ¼å¼çš„è³‡æ–™å‰µå»ºä¸€æœ¬æ–°çš„ä¸–ç•Œæ›¸
         * @param {object} tavernData - å¾ Tavern AI .json æª”è§£æå‡ºçš„è³‡æ–™
         * @param {string} fileName - åŸå§‹æª”æ¡ˆåï¼Œç”¨æ–¼ç”Ÿæˆé»˜èªæ›¸å
         */
        async function importTavernWorldBook(tavernData, fileName) {
            const bookNameSuggestion = fileName.replace(/\.json$/i, ''); // å¾æª”æ¡ˆåä¸­æå–å»ºè­°åç¨±
        
            const newBookName = await showCustomPrompt(
                "å°å…¥ Tavern AI ä¸–ç•Œæ›¸", 
                "è«‹ç‚ºé€™æœ¬è¨­å®šé›†å‘½åï¼š",
                bookNameSuggestion
            );
        
            if (!newBookName || !newBookName.trim()) {
                alert("å°å…¥å·²å–æ¶ˆï¼Œå› ç‚ºæœªæä¾›æ›¸åã€‚");
                return;
            }
        
            const newEntries = Object.values(tavernData.entries).map(entry => {
                // å°‡ Tavern çš„è³‡æ–™çµæ§‹è½‰æ›ç‚º EPhone çš„æ ¼å¼
                return {
                    keys: entry.key || [],
                    comment: entry.comment || 'ç„¡å‚™è¨»',
                    content: entry.content || '',
                    enabled: !entry.disable // æ³¨æ„ï¼šTavern çš„ disable å’Œ EPhone çš„ enabled é‚è¼¯æ˜¯ç›¸åçš„
                };
            }).filter(entry => entry.content); // éæ¿¾æ‰æ²’æœ‰å…§å®¹çš„æ¢ç›®
        
            if (newEntries.length === 0) {
                alert("é€™å€‹ Tavern AI ä¸–ç•Œæ›¸ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„æ¢ç›®ã€‚");
                return;
            }
        
            const newWorldBook = {
                id: 'wb_' + Date.now(),
                name: newBookName.trim(),
                content: newEntries,
                categoryId: null // é»˜èªä¸åˆ†é¡
            };
        
            await db.worldBooks.add(newWorldBook);
            state.worldBooks.push(newWorldBook); // æ›´æ–°è¨˜æ†¶é«”
            await renderWorldBookScreen(); // åˆ·æ–°UI
        
            await showCustomAlert('å°å…¥æˆåŠŸï¼', `å·²æˆåŠŸå¾ Tavern AI æª”å°å…¥è¨­å®šé›†ã€Š${newBookName}ã€‹ã€‚`);
        }


        async function exportWorldBooks() {
            try {
                const books = await db.worldBooks.toArray();
                const categories = await db.worldBookCategories.toArray();
        
                if (books.length === 0 && categories.length === 0) {
                    alert("æ²’æœ‰å¯åŒ¯å‡ºçš„ä¸–ç•Œæ›¸è³‡æ–™ã€‚");
                    return;
                }
        
                const backupData = {
                    type: 'EPhoneWorldBookBackup', // ç‰¹æ®Šæ¨™è¨˜ï¼Œç”¨æ–¼å°å…¥æ™‚é©—è­‰
                    version: 1,
                    timestamp: Date.now(),
                    books: books,
                    categories: categories
                };
        
                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `EPhone-WorldBooks-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('åŒ¯å‡ºæˆåŠŸ', 'æ‰€æœ‰ä¸–ç•Œæ›¸è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºï¼');
        
            } catch (error) {
                console.error("åŒ¯å‡ºä¸–ç•Œæ›¸æ™‚å‡ºéŒ¯:", error);
                await showCustomAlert('åŒ¯å‡ºå¤±æ•—', `ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤: ${error.message}`);
            }
        }
        
/**
         * ã€å·²æ›´æ–°ã€‘å°å…¥ EPhone ä¸–ç•Œæ›¸å‚™ä»½è³‡æ–™ï¼Œä¸¦è¦†è“‹ç¾æœ‰è³‡æ–™
         * @param {object} data - å¾å‚™ä»½æª”æ¡ˆè§£æå‡ºçš„JSONæ•¸æ“š
         */
        async function importWorldBooks(data) {
            // é€™å€‹å‡½æ•¸ç¾åœ¨ç›´æ¥æ¥æ”¶è§£æå¥½çš„è³‡æ–™ï¼Œä¸å†éœ€è¦è®€å–æª”
            try {
                if (data.type !== 'EPhoneWorldBookBackup' || !data.books) {
                    throw new Error("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œé€™ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ä¸–ç•Œæ›¸å‚™ä»½æª”æ¡ˆã€‚");
                }
        
                const confirmed = await showCustomConfirm(
                    'å°å…¥ä¸–ç•Œæ›¸',
                    'é€™å°‡ç”¨æª”ä¸­çš„è³‡æ–™ã€å®Œå…¨è¦†è“‹ã€‘æ‚¨ç•¶å‰æ‰€æœ‰çš„ä¸–ç•Œæ›¸å’Œåˆ†é¡ã€‚æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼',
                    { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªè¦†è“‹' }
                );
        
                if (!confirmed) return;
        
                await db.transaction('rw', db.worldBooks, db.worldBookCategories, async () => {
                    await db.worldBooks.clear();
                    await db.worldBookCategories.clear();
                    
                    if (Array.isArray(data.books)) {
                        await db.worldBooks.bulkPut(data.books);
                    }
                    if (Array.isArray(data.categories)) {
                        await db.worldBookCategories.bulkPut(data.categories);
                    }
                });
        
                // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„ state ä¸¦é‡æ–°æ¸²æŸ“
                state.worldBooks = await db.worldBooks.toArray();
                await renderWorldBookScreen();
        
                await showCustomAlert('å°å…¥æˆåŠŸ', 'ä¸–ç•Œæ›¸è³‡æ–™å·²æˆåŠŸæ¢å¾©ï¼');
        
            } catch (error) {
                console.error("å°å…¥ä¸–ç•Œæ›¸æ™‚å‡ºéŒ¯:", error);
                await showCustomAlert('å°å…¥å¤±æ•—', `æ–‡ä»¶è§£ææˆ–æ‡‰ç”¨å¤±æ•—: ${error.message}`);
            }
        }


    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨ `init` å‡½æ•¸çš„æœ€é–‹å§‹ï¼Œæª¢æŸ¥ä¸¦åŸ·è¡Œå¾Œè‡ºæ´»å‹•æ¨¡æ“¬
    const lastActiveTimestamp = localStorage.getItem('ephoneLastActiveTimestamp');
    if (lastActiveTimestamp) {
        const minutesOffline = (Date.now() - parseInt(lastActiveTimestamp)) / (1000 * 60);
        // å¦‚æœé›¢ç·šè¶…é5åˆ†é˜ï¼Œæ‰é–‹å§‹æ¨¡æ“¬
        if (minutesOffline > 5) {
            // æ³¨æ„ï¼šæˆ‘å€‘åœ¨é€™è£¡èª¿ç”¨é¡æ¯”å‡½æ•¸ï¼Œä½†ä¸ä½¿ç”¨ await
            // é€™æ¨£å®ƒå°±æœƒåœ¨å¾Œè‡ºé»˜é»˜åŸ·è¡Œï¼Œä¸æœƒå¡ä½æ‡‰ç”¨çš„å•Ÿå‹•éç¨‹
            simulateBackgroundActivity(minutesOffline);
        }
    }
    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
setupCharPlayerControls();
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘å°‡å…§å»ºå‡½å¼æš´éœ²åˆ°å…¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­çš„ onclick å¯ä»¥èª¿ç”¨å®ƒå€‘ â–¼â–¼â–¼
    window.showScreen = showScreen;
    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.handleListenTogetherClick = handleListenTogetherClick; // ç‚ºâ€œä¸€èµ·è½â€æŒ‰éˆ•æš´éœ²å‡½æ•¸
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
window.openCharacterSelector = openCharacterSelector;
window.openCharApp = openCharApp;
window.switchToMyPhone = switchToMyPhone;
window.switchToCharHomeScreen = switchToCharHomeScreen;
window.openNpcEditor = openNpcEditor; // <-- æ–°å¢é€™ä¸€è¡Œ
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
    // â–²â–²â–² ä¿®å¾©çµæŸ â–²â–²â–²
        // åœ¨ init() å‡½æ•¸é–‹é ­æ·»åŠ 
        const stickerActionBar = document.createElement('div');
        stickerActionBar.id = 'sticker-action-bar';
        stickerActionBar.innerHTML = '<button id="delete-selected-stickers-btn">åˆªé™¤ (0)</button>';
        document.getElementById('sticker-panel').appendChild(stickerActionBar);
                    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    const globalCssStyleTag = document.createElement('style');
                    globalCssStyleTag.id = 'global-custom-style';
                    document.head.appendChild(globalCssStyleTag);
                    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // åœ¨ init() å‡½æ•¸çš„é–‹é ­
        qzoneStickerPanelState.panelEl = document.getElementById('qzone-sticker-panel');
        qzoneStickerPanelState.gridEl = document.getElementById('qzone-sticker-grid');
            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„ã€æœ€é–‹é ­ã€‘ï¼Œé»è²¼ä¸‹é¢é€™å…©è¡Œä»£ç¢¼ â–¼â–¼â–¼
            const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // é è¨­ç‚ºæ—¥é–“æ¨¡å¼
            applyTheme(savedTheme);
            // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        
            // â–¼â–¼â–¼ æ–°å¢ä»£ç¢¼ â–¼â–¼â–¼
            const customBubbleStyleTag = document.createElement('style');
            customBubbleStyleTag.id = 'custom-bubble-style';
            document.head.appendChild(customBubbleStyleTag);
            // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        
            // â–¼â–¼â–¼ æ–°å¢ä»£ç¢¼ â–¼â–¼â–¼
            const previewBubbleStyleTag = document.createElement('style');
            previewBubbleStyleTag.id = 'preview-bubble-style';
            document.head.appendChild(previewBubbleStyleTag);
            // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        
        
            // â–¼â–¼â–¼ ä¿®æ”¹é€™å…©è¡Œ â–¼â–¼â–¼
            applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå¯¦èŠå¤©ä»‹é¢çš„è‡ªè¨‚æ¨£å¼
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é è¦½å€çš„è‡ªè¨‚æ¨£å¼
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
                   window.openRenderingRulesScreen = openRenderingRulesScreen;
                    window.showScreen = showScreen;
                    window.renderChatListProxy = renderChatList;
                    window.renderApiSettingsProxy = renderApiSettings;
                    window.renderWallpaperScreenProxy = renderWallpaperScreen;
                    window.renderWorldBookScreenProxy = renderWorldBookScreen;
        
                    await loadAllDataFromDB();
                    applyStatusBarVisibility(); // <-- æ–°å¢é€™ä¸€è¡Œ
                    // â–¼â–¼â–¼ ã€æ ¸å¿ƒã€‘åœ¨é€™è£¡æ·»åŠ ä¸‹é¢é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
                    await migrateOldRedPacketData();
                    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
                    // â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
                    applyGlobalCss(state.globalSettings.globalCss);
                    // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
                    // åˆå§‹åŒ–æœªè®€å‹•æ…‹è¨ˆæ•¸
                    const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
                    updateUnreadIndicator(storedCount);
                    
                    // â–²â–²â–² ä»£ç¢¼æ·»åŠ çµæŸ â–²â–²â–²
        
                    if (state.globalSettings && state.globalSettings.fontUrl) {
                        applyCustomFont(state.globalSettings.fontUrl);
                    }
        
                    updateClock();
                    setInterval(updateClock, 1000 * 30);
                    applyGlobalWallpaper();
                    initBatteryManager(); 
        
        applyAppIcons();
        applyWidgetData(); // <-- æ·»åŠ é€™ä¸€è¡Œ
        
                    // ==========================================================
                    // --- å„ç¨®äº‹ä»¶ç›£è½å™¨ ---
                    // ==========================================================
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œæ·»åŠ é€™è¡Œæ–°ä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('rules-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('rules-tab')) {
                switchRuleCategory(e.target.dataset.categoryId);
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
        // æ¸²æŸ“è¦å‰‡åŠŸèƒ½äº‹ä»¶ç¶å®š
        document.getElementById('add-new-rule-btn').addEventListener('click', () => openRuleEditor(null));
        document.getElementById('cancel-rule-editor-btn').addEventListener('click', () => {
            document.getElementById('rule-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-rule-btn').addEventListener('click', saveRenderingRule);
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå–®èŠâ€œæ‹ä¸€æ‹â€æŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('pat-btn').addEventListener('click', () => {
            // ç¢ºä¿ç•¶å‰åœ¨å–®èŠä¸­
            if (state.activeChatId && !state.chats[state.activeChatId].isGroup) {
                const chat = state.chats[state.activeChatId];
                // èª¿ç”¨ç¾æœ‰çš„æ‹ä¸€æ‹å‡½æ•¸ï¼Œä¸¦å‚³å…¥æ­£ç¢ºçš„åƒæ•¸
                handleUserPat(chat.id, chat.originalName);
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€é€™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç¢¼ï¼Œè«‹é»è²¼åœ¨é€™è£¡ã€‘ â–¼â–¼â–¼
        let activeAnnouncementId = null; // ç”¨æ–¼æš«å­˜æ­£åœ¨æ“ä½œçš„å…¬å‘ŠID
        
        /**
         * é»æ“Šâ€œ...â€æ™‚ï¼Œé¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨ï¼ˆç½®é ‚/åˆªé™¤ï¼‰
         * @param {string} annoId - å…¬å‘Šçš„å”¯ä¸€ID
         */
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            // æ ¹æ“šç•¶å‰æ˜¯å¦å·²ç½®é ‚ï¼Œå‹•æ…‹æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
            pinButton.textContent = announcement.isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚å…¬å‘Š';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        /**
         * è™•ç†â€œç½®é ‚/å–æ¶ˆç½®é ‚â€æ“ä½œ
         */
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // åˆ‡æ›ç½®é ‚ç‹€æ…‹
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“å…¬å‘Šæ¿ä»¥æ›´æ–°UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        /**
         * è™•ç†â€œåˆªé™¤å…¬å‘Šâ€æ“ä½œ
         */
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
        
            const confirmed = await showCustomConfirm("ç¢ºèªåˆªé™¤", "ç¢ºå®šè¦åˆªé™¤é€™æ¢å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚", { confirmButtonClass: 'btn-danger' });
        
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                // å¾å…¬å‘Šé™£åˆ—ä¸­éæ¿¾æ‰è¦åˆªé™¤çš„å…¬å‘Š
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
                    document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                    document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
                    document.getElementById('export-data-btn').addEventListener('click', async () => {
    // å½ˆå‡ºé¸æ“‡æ¡†ï¼Œè®“ç”¨æˆ¶æ±ºå®šä½¿ç”¨å“ªç¨®åŒ¯å‡ºæ–¹å¼
    const choice = await showChoiceModal('é¸æ“‡åŒ¯å‡ºæ–¹å¼', [
        { text: 'æ™ºæ…§åŒ¯å‡º (æ¨è–¦ï¼Œé€Ÿåº¦å¿«ï¼Œè¨˜æ†¶é«”ä½”ç”¨å°)', value: 'stream' },
        { text: 'å‚³çµ±åŒ¯å‡º (ç›¸å®¹èˆŠç‰ˆæˆ–è¨˜æ†¶é«”å°çš„æµè¦½å™¨)', value: 'blob' }
    ]);

    // æ ¹æ“šä½¿ç”¨è€…çš„é¸æ“‡ï¼Œèª¿ç”¨ä¸åŒçš„åŒ¯å‡ºå‡½æ•¸
    if (choice === 'stream') {
        exportDataAsStream();
    } else if (choice === 'blob') {
        exportDataAsBlob();
    }
    // å¦‚æœç”¨æˆ¶é»æ“Šå–æ¶ˆï¼Œå‰‡ choice ç‚º nullï¼Œä¸åšä»»ä½•äº‹
});
// â–¼â–¼â–¼ åœ¨é€™è£¡é»è²¼ä¸‹é¢çš„æ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('cleanup-data-btn').addEventListener('click', cleanupRedundantData);
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
document.getElementById('offline-mode-toggle').addEventListener('change', (e) => {
    // æ ¹æ“šé–‹é—œçš„é¸ä¸­ç‹€æ…‹ï¼Œç«‹å³é¡¯ç¤ºæˆ–éš±è—ä¸‹æ–¹çš„â€œç·šä¸‹æ¨¡å¼é¸é …â€å€åŸŸ
    document.getElementById('offline-mode-options').style.display = e.target.checked ? 'block' : 'none';
});
                    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
    document.getElementById('time-perception-toggle').addEventListener('change', (e) => {
        document.getElementById('time-zone-group').style.display = e.target.checked ? 'block' : 'none';
    });
                    // æ–°ä»£ç¢¼
document.getElementById('import-data-input').addEventListener('change', e => handleSmartImport(e.target.files[0]));
                    document.getElementById('import-card-input').addEventListener('change', handleCardImport);
                    document.getElementById('back-to-list-btn').addEventListener('click', () => { 
               ruleCache = {};
            // â–¼â–¼â–¼ ä¿®æ”¹é€™å…©è¡Œ â–¼â–¼â–¼
            applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå¯¦èŠå¤©ä»‹é¢çš„è‡ªè¨‚æ¨£å¼
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é è¦½å€çš„è‡ªè¨‚æ¨£å¼
            // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²
        
        exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
                    
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ add-chat-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('add-chat-btn').addEventListener('click', async () => {
            // ä½¿ç”¨æˆ‘å€‘ç¾æœ‰çš„ showChoiceModal å‡½æ•¸ä¾†æä¾›é¸é …
            const choice = await showChoiceModal('å‰µå»ºæ–°èŠå¤©', [
                { text: 'æ‰‹å‹•å‰µå»ºè§’è‰²', value: 'manual' },
                { text: 'å¾è§’è‰²å¡å°å…¥ (.json/.png)', value: 'import_card' }
            ]);
        
            if (choice === 'manual') {
                // å¦‚æœç”¨æˆ¶é¸æ“‡æ‰‹å‹•ï¼Œå‰‡åŸ·è¡ŒåŸä¾†çš„é‚è¼¯
                const remarkName = await showCustomPrompt('å‰µå»ºæ–°èŠå¤© (ç¬¬1/2æ­¥)', 'è«‹è¼¸å…¥ä½ æƒ³ç‚ºTaè¨­ç½®çš„ã€å‚™è¨»åã€‘(ä¾‹å¦‚: å“¥å“¥)');
                if (!remarkName || !remarkName.trim()) return;
        
                const originalName = await showCustomPrompt('å‰µå»ºæ–°èŠå¤© (ç¬¬2/2æ­¥)', 'è«‹è¼¸å…¥Taçš„ã€æœ¬åã€‘(ä¾‹å¦‚: ææ˜Ÿè¾°ï¼Œé€™å€‹åå­—å°‡ç”¨æ–¼AIè­˜åˆ¥)');
                if (!originalName || !originalName.trim()) return;
        
// é€™æ˜¯å…¨æ–°çš„ã€ç¢ºä¿è§’è‰²èƒ½æ­£ç¢ºé¡¯ç¤ºçš„ä»£ç¢¼
const newChatId = 'chat_' + Date.now();
const newChat = {
    id: newChatId,
    name: remarkName.trim(),
    originalName: originalName.trim(),
    isGroup: false,
    isPinned: false, // ã€ä¿®å¾©ã€‘è£œå……ç½®é ‚ç‹€æ…‹
    unreadCount: 0,  // ã€ä¿®å¾©ã€‘è£œå……æœªè®€æ¶ˆæ¯è¨ˆæ•¸
    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
    status: { text: 'ç·šä¸Š', lastUpdate: Date.now(), isBusy: false },
    settings: {
        aiPersona: 'é€™æ˜¯ä¸€å€‹é€šéæ‰‹å‹•å‰µå»ºçš„è§’è‰²ã€‚',
        myPersona: 'æˆ‘æ˜¯èª°å‘€ã€‚',
        myNickname: 'æˆ‘',
        maxMemory: 10,
        aiAvatar: defaultAvatar,
        myAvatar: defaultAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
        aiAvatarLibrary: [],
        myAvatarLibrary: [],
        enableBackgroundActivity: true, // ã€ä¿®å¾©ã€‘è£œå……å¾Œè‡ºæ´»å‹•é–‹é—œ
        actionCooldownMinutes: 15,    // ã€ä¿®å¾©ã€‘è£œå……å¾Œè‡ºæ´»å‹•å†·å»æ™‚é–“
        enableTimePerception: true,     // ã€ä¿®å¾©ã€‘è£œå……æ™‚é–“æ„ŸçŸ¥é–‹é—œ
        isOfflineMode: false,           // ã€ä¿®å¾©ã€‘è£œå……ç·šä¸‹æ¨¡å¼é–‹é—œ
        offlineMinLength: 100,
        offlineMaxLength: 300,
        offlinePresetId: null,
        timeZone: 'Asia/Shanghai'       // ã€ä¿®å¾©ã€‘è£œå……é»˜èªæ™‚å€
    },
    history: [],
    musicData: { totalTime: 0 },
    longTermMemory: [],
    thoughtsHistory: [] // ã€ä¿®å¾©ã€‘è£œå……å¿ƒè²/æ•£è¨˜æ­·å²è¨˜éŒ„
};
                state.chats[newChatId] = newChat;
                await db.chats.put(newChat);
                renderChatList();
                
            } else if (choice === 'import_card') {
                // å¦‚æœç”¨æˆ¶é¸æ“‡å°å…¥ï¼Œå°±è§¸ç™¼æˆ‘å€‘æ–°æ·»åŠ çš„éš±è—æª”è¼¸å…¥æ¡†
                document.getElementById('import-card-input').click();
            }
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘å‰µå»ºç¾¤èŠæŒ‰éˆ•ç¾åœ¨æ‰“é–‹é€£çµ¡äººé¸æ“‡å™¨ â–¼â–¼â–¼
        document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²                      
                    document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
                    document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
        
                    document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
                    document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
                    document.getElementById('music-return-btn').addEventListener('click', returnToChat);
                    document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
                    document.getElementById('music-next-btn').addEventListener('click', playNext);
                    document.getElementById('music-prev-btn').addEventListener('click', playPrev);
                    document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
                    document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
                    document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
                    document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
                    document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
                    document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä¿®å¾©æŒ‰éˆ•é»æ“Šç„¡å›æ‡‰çš„æ ¸å¿ƒä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('playlist-body').addEventListener('click', (e) => {
    const target = e.target;
    const trackIndex = parseInt(target.dataset.index);

    if (isNaN(trackIndex)) return;

    if (target.classList.contains('album-art-btn')) {
        handleChangeAlbumArt(trackIndex);
    } else if (target.classList.contains('lyrics-btn')) {
        handleManualLrcImport(trackIndex);
    } else if (target.classList.contains('bg-btn')) {
        handleChangeBackground(trackIndex);
    } else if (target.classList.contains('delete-track-btn')) {
        deleteTrack(trackIndex);
    }
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
                    audioPlayer.addEventListener('ended', () => {
    // æ­Œæ›²æ’­æ”¾çµæŸæ™‚ï¼Œç§»é™¤æ—‹è½‰æ¨£å¼
    document.getElementById('vinyl-view').classList.remove('spinning');
    playNext(); 
});
                    audioPlayer.addEventListener('ended', () => {
    // æ­Œæ›²æ’­æ”¾çµæŸæ™‚ï¼Œç§»é™¤æ—‹è½‰æ¨£å¼
    document.getElementById('vinyl-view').classList.remove('spinning');
    playNext(); 
});

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
        // éŸ³æ¨‚æš«åœæ™‚ï¼Œç§»é™¤æ—‹è½‰æ¨£å¼
        document.getElementById('vinyl-view').classList.remove('spinning');
    } 
});

audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
        // éŸ³æ¨‚é–‹å§‹æ’­æ”¾æ™‚ï¼Œæ·»åŠ æ—‹è½‰æ¨£å¼
        document.getElementById('vinyl-view').classList.add('spinning');
    } 
});
        
                    const chatInput = document.getElementById('chat-input');
                    // â–¼â–¼â–¼ æ‰¾åˆ° id="send-btn" çš„ click äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
// ã€æœ€çµ‚æ€§èƒ½å„ªåŒ–ç‰ˆã€‘
document.getElementById('send-btn').addEventListener('click', () => { // æ³¨æ„ï¼šç§»é™¤äº† async
    const content = chatInput.value.trim();
    if (!content || !state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    const msg = {
        role: 'user',
        content,
        timestamp: Date.now()
    };

    if (currentReplyContext) {
        msg.quote = currentReplyContext;
    }

    // ã€å„ªåŒ–1ï¼šå…ˆæ¸²æŸ“ï¼Œå¾Œä¿å­˜ã€‘ç«‹å³å°‡æ¶ˆæ¯é¡¯ç¤ºåœ¨è¢å¹•ä¸Šï¼Œçµ¦ä½¿ç”¨è€…å³æ™‚å›é¥‹ï¼
    appendMessage(msg, chat);

    // ã€å„ªåŒ–2ï¼šéåŒæ­¥è™•ç†è€—æ™‚æ“ä½œã€‘å°‡è³‡æ–™å­˜å„²å’Œæ¸…å–®æ›´æ–°æ”¾åˆ°å¾Œè‡ºï¼Œä¸é˜»å¡ä½¿ç”¨è€…ä»‹é¢
    (async () => {
        chat.history.push(msg);
        await db.chats.put(chat); // ä¿å­˜åˆ°è³‡æ–™åº«
    renderChatList(); // <<<<< ä¿®æ”¹ç‚ºé€™ä¸€è¡Œ

    })();

    // æ¸…ç†å·¥ä½œï¼ˆé€™éƒ¨åˆ†å¾ˆå¿«ï¼Œå¯ä»¥ç«‹å³åŸ·è¡Œï¼‰
    chatInput.value = '';
    chatInput.style.height = 'auto';
    chatInput.focus();
    cancelReplyMode();
});
                    document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
                    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
                    //chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
        
                    document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹å·²åŒ…å«CPhoneè¨­ç½®çš„æœ€çµ‚ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ 'save-wallpaper-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
            // ä¿å­˜ EPhone å£ç´™
            if (newWallpaperBase64) {
                state.globalSettings.wallpaper = newWallpaperBase64;
            }
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘å°‡ state ä¸­è‡¨æ™‚çš„ CPhone å£ç´™è¨­ç½®ä¹Ÿä¸€ä½µä¿å­˜
            // (æ³¨æ„ï¼šcphoneWallpaperå·²ç¶“åœ¨ä¸Šå‚³æ™‚æ›´æ–°åˆ°stateäº†, é€™è£¡åªéœ€ç¢ºä¿å®ƒè¢«å­˜å…¥è³‡æ–™åº«)

            state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
            state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
            state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
            
            // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰å…¨åŸŸè¨­ç½® (åŒ…æ‹¬äº†EPhoneå’ŒCPhoneçš„æ‰€æœ‰æ–°èˆŠè¨­ç½®)
            await db.globalSettings.put(state.globalSettings);
            
            // æ‡‰ç”¨æ‰€æœ‰æ›´æ”¹
            applyGlobalWallpaper();
            applyCPhoneWallpaper(); // <-- æ–°å¢èª¿ç”¨
            newWallpaperBase64 = null; // æ¸…ç©ºè‡¨æ™‚å£ç´™è®Šæ•¸

            applyAppIcons();
            applyCPhoneAppIcons(); // <-- æ–°å¢èª¿ç”¨
            
            applyGlobalCss(state.globalSettings.globalCss);
            applyStatusBarVisibility();

            alert('å¤–è§€è¨­ç½®å·²ä¿å­˜ä¸¦æ‡‰ç”¨ï¼');
            showScreen('home-screen');
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¾©ã€‘è«‹ç”¨é€™æ®µæ–°ä»£ç¢¼ï¼Œæ›¿æ›èˆŠçš„æ»¾å‹•äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
const messagesView = document.getElementById('messages-view'); // <--- æ ¸å¿ƒä¿®æ”¹1ï¼šç²å–æ­£ç¢ºçš„æ»¾å‹•å®¹å™¨
messagesView.addEventListener('scroll', () => { // <--- æ ¸å¿ƒä¿®æ”¹2ï¼šåœ¨ messages-view ä¸Šç›£è½
    // è§£æ§‹è³¦å€¼ç²å–æ»¾å‹•ç›¸é—œçš„å±¬æ€§
    const { scrollTop, scrollHeight, clientHeight } = messagesView;

    // åˆ¤æ–·æ¢ä»¶ï¼šç•¶æ²è»¸è·é›¢åº•éƒ¨çš„è·é›¢å°æ–¼ä¸€å€‹è¢å¹•çš„é«˜åº¦æ™‚
    // é€™å€‹æ¢ä»¶ä¿æŒä¸è®Šï¼Œæ˜¯å¯é çš„
    if (scrollHeight - scrollTop - clientHeight < clientHeight) {
        // ä¸¦ä¸”ç•¶å‰ä¸è™•æ–¼è¼‰å…¥ç‹€æ…‹
        if (!isLoadingMoreChats) {
            // å°±è§¸ç™¼è¼‰å…¥ä¸‹ä¸€é 
            loadMoreChats();
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ save-api-settings-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('save-api-settings-btn').addEventListener('click', async () => {
            // ä¿å­˜ä¸»API
            state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim();
            state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
            state.apiConfig.model = document.getElementById('model-select').value;
state.apiConfig.minimaxGroupId = document.getElementById('minimax-group-id').value.trim();
state.apiConfig.minimaxApiKey = document.getElementById('minimax-api-key').value.trim();  
state.apiConfig.minimaxModel = document.getElementById('minimax-model-select').value; // <-- æ–°å¢é€™ä¸€è¡Œ          
            // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜å‰¯API
            state.apiConfig.secondaryProxyUrl = document.getElementById('secondary-proxy-url').value.trim();
            state.apiConfig.secondaryApiKey = document.getElementById('secondary-api-key').value.trim();
            state.apiConfig.secondaryModel = document.getElementById('secondary-model-select').value;
            
            await db.apiConfig.put(state.apiConfig);
        
            // å¾Œè‡ºæ´»å‹•è¨­ç½®çš„ä¿å­˜é‚è¼¯ä¿æŒä¸è®Š
            const backgroundSwitch = document.getElementById('background-activity-switch');
            const intervalInput = document.getElementById('background-interval-input');
            const cooldownInput = document.getElementById('block-cooldown-input');
        
            state.globalSettings.enableBackgroundActivity = backgroundSwitch.checked;
            state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
            state.globalSettings.blockCooldownHours = parseFloat(cooldownInput.value) || 1;
            state.globalSettings.enableAiDrawing = document.getElementById('enable-ai-drawing-switch').checked;
           state.globalSettings.chatRenderWindow = parseInt(document.getElementById('chat-render-window-input').value) || 50;
            state.globalSettings.chatListRenderWindow = parseInt(document.getElementById('chat-list-render-window-input').value) || 30;
            state.globalSettings.apiTemperature = parseFloat(document.getElementById('api-temperature-slider').value);
            await db.globalSettings.put(state.globalSettings);
        
            stopBackgroundSimulation(); 
            if (state.globalSettings.enableBackgroundActivity) {
                startBackgroundSimulation();
                console.log(`å¾Œè‡ºæ´»å‹•æ¨¡æ“¬å·²å•Ÿå‹•ï¼Œé–“éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
            } else {
                console.log("å¾Œè‡ºæ´»å‹•æ¨¡æ“¬å·²åœæ­¢ã€‚");
            }
            
            alert('æ‰€æœ‰APIèˆ‡å¾Œè‡ºè¨­ç½®å·²ä¿å­˜!'); 
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                            // gemini é‡‘é‘°èšç„¦çš„æ™‚å€™é¡¯ç¤ºæ˜æ–‡
                const ApiKeyInput = document.getElementById('api-key')
                ApiKeyInput.addEventListener('focus', (e) => {
                    e.target.setAttribute('type', 'text')
                })
                ApiKeyInput.addEventListener('blur', (e) => {
                    e.target.setAttribute('type', 'password')
                })
        
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ fetch-models-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        
        // å°è£ä¸€å€‹å¯è¤‡ç”¨çš„æ¨¡å‹æ‹‰å–å‡½æ•¸
        async function fetchModels(urlInputId, keyInputId, selectId) {
            const url = document.getElementById(urlInputId).value.trim();
            const key = document.getElementById(keyInputId).value.trim();
            if (!url || !key) return alert('è«‹å…ˆå¡«å¯«å°æ‡‰çš„åä»£ä½å€å’Œé‡‘é‘°');
            
            try {
                let isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`, isGemini ? undefined : { headers: { 'Authorization': `Bearer ${key}` } });
                if (!response.ok) throw new Error('ç„¡æ³•ç²å–æ¨¡å‹æ¸…å–®');
                const data = await response.json();
                let models = isGemini ? data.models.map(model => ({ id: model.name.split('/')[1] || model.name })) : data.data;
                
                const modelSelect = document.getElementById(selectId);
                modelSelect.innerHTML = '';
                // ã€æ ¸å¿ƒã€‘æ ¹æ“šæ˜¯ä¸»/å‰¯æ¨¡å‹ï¼Œè®€å–æ­£ç¢ºçš„å·²ä¿å­˜æ¨¡å‹
                const savedModel = selectId === 'model-select' ? state.apiConfig.model : state.apiConfig.secondaryModel;
        
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === savedModel) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('æ¨¡å‹æ¸…å–®å·²æ›´æ–°');
            } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±æ•—: ${error.message}`);
            }
        }
        
        // ç¶å®šä¸»æ¨¡å‹æ‹‰å–æŒ‰éˆ•
        document.getElementById('fetch-models-btn').addEventListener('click', () => {
            fetchModels('proxy-url', 'api-key', 'model-select');
        });
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç¶å®šå‰¯æ¨¡å‹æ‹‰å–æŒ‰éˆ•
        document.getElementById('fetch-secondary-models-btn').addEventListener('click', () => {
            fetchModels('secondary-proxy-url', 'secondary-api-key', 'secondary-model-select');
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('å‰µå»ºä¸–ç•Œæ›¸', 'è«‹è¼¸å…¥æ›¸å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
// â–¼â–¼â–¼ ã€å…¨æ–° | iOS ç›¸å®¹ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ save-world-book-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('save-world-book-btn').addEventListener('click', async () => {
    if (!editingWorldBookId) return;
    const book = state.worldBooks.find(wb => wb.id === editingWorldBookId);
    if (!book) return;

    // (é€™éƒ¨åˆ†ä¿å­˜è³‡æ–™çš„é‚è¼¯ä¿æŒä¸è®Š)
    const newName = document.getElementById('world-book-name-input').value.trim();
    if (!newName) { alert('æ›¸åä¸èƒ½ç‚ºç©ºï¼'); return; }
    book.name = newName;
    const categoryId = document.getElementById('world-book-category-select').value;
    book.categoryId = categoryId ? parseInt(categoryId) : null;

    const entriesContainer = document.getElementById('world-book-entries-container');
    const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
    const newEntries = [];

    entryBlocks.forEach(block => {
        const keysInput = block.querySelector('.entry-keys-input').value.trim();
        const content = block.querySelector('.entry-content-textarea').value.trim();
        const isEnabled = block.querySelector('.entry-enabled-switch').checked;
        if (content) {
            newEntries.push({
                comment: block.querySelector('.entry-comment-input').value.trim(),
                keys: keysInput ? keysInput.split(',').map(k => k.trim()).filter(k => k) : [],
                content: content,
                enabled: isEnabled
            });
        }
    });
    book.content = newEntries;

    // 1. å…ˆå°‡æ‰€æœ‰è³‡æ–™ä¿å­˜åˆ°è³‡æ–™åº«
    await db.worldBooks.put(book);
    document.getElementById('world-book-editor-title').textContent = newName;
    editingWorldBookId = null;

    // 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘å…ˆåˆ‡æ›åˆ°ç›®æ¨™è¢å¹•
    showScreen('world-book-screen');
    
    // 3. ã€æ ¸å¿ƒä¿®å¾©ã€‘ç„¶å¾Œå†éåŒæ­¥åœ°æ¸²æŸ“å…§å®¹
    await renderWorldBookScreen();
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ chat-messages äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('chat-messages').addEventListener('click', async (e) => {
    // å„ªå…ˆè™•ç†å¸¶ data-text å±¬æ€§çš„ tts_voice
const voiceBody = e.target.closest('.voice-message-body[data-text]');
if (voiceBody) {
    // ã€æ ¸å¿ƒä¿®å¾©1ã€‘é¦–å…ˆç²å–ç•¶å‰çš„èŠå¤©ç‰©ä»¶ï¼Œé€™æ˜¯æ‰€æœ‰åˆ¤æ–·çš„åŸºç¤
    const chat = state.chats[state.activeChatId];
    if (!chat) return; // å®‰å…¨æª¢æŸ¥ï¼Œå¦‚æœæ‰¾ä¸åˆ°èŠå¤©ç‰©ä»¶å‰‡ç›´æ¥é€€å‡º

    // ç„¡è«–å¦‚ä½•ï¼Œéƒ½å…è¨±ç”¨æˆ¶é»æ“Šå±•é–‹/æŠ˜ç–ŠèªéŸ³æ–‡å­—
    toggleVoiceTranscript(voiceBody);

    // ç²å–å¾ŒçºŒåˆ¤æ–·éœ€è¦çš„å…ƒç´ 
    const bubble = voiceBody.closest('.message-bubble');
    const transcriptEl = bubble ? bubble.querySelector('.voice-transcript') : null;

    // åªæœ‰ç•¶å®ƒæ˜¯ä¸€å€‹å¯æ’­æ”¾çš„AIèªéŸ³ï¼Œä¸¦ä¸”æ–‡å­—æ˜¯å±•é–‹ç‹€æ…‹æ™‚ï¼Œæ‰é€²å…¥ä¸‹ä¸€æ­¥åˆ¤æ–·
    if (voiceBody.dataset.voiceId && transcriptEl && transcriptEl.style.display === 'block') {

        // ã€æ ¸å¿ƒä¿®å¾©2ã€‘é›™é‡é©—è­‰ï¼šæ””æˆªä¸æ‡‰ç™¼å‡ºè«‹æ±‚çš„å ´æ™¯
        if (chat.isGroup) {
            console.log("é€™æ˜¯ä¸€æ¢ç¾¤èŠèªéŸ³è¨Šæ¯ï¼Œå·²ç¦æ­¢ç™¼èµ·TTSè«‹æ±‚ã€‚");
            return; // å¦‚æœæ˜¯ç¾¤èŠï¼Œç›´æ¥é˜»æ­¢å¾ŒçºŒæ“ä½œ
        }
        if (chat.settings.enableTts === false) {
            console.log(`â€œ${chat.name}â€çš„TTSåŠŸèƒ½å·²é—œé–‰ï¼Œå·²ç¦æ­¢ç™¼èµ·TTSè«‹æ±‚ã€‚`);
            return; // å¦‚æœç•¶å‰èŠå¤©çš„TTSé–‹é—œæ˜¯é—œé–‰çš„ï¼Œä¹Ÿç›´æ¥é˜»æ­¢
        }

        // åªæœ‰é€šéäº†ä»¥ä¸Šæ‰€æœ‰é©—è­‰ï¼Œæ‰çœŸæ­£èª¿ç”¨APIå»æ’­æ”¾èªéŸ³
        playTtsAudio(voiceBody);
    }

    return; // è™•ç†å®Œå¾Œç«‹å³é€€å‡º
}
            // æª¢æŸ¥æ˜¯å¦é»æ“Šäº† "æŸ¥çœ‹è©³æƒ…" æŒ‰éˆ•
            const detailsBtn = e.target.closest('.waimai-details-btn');
            if (detailsBtn) {
                const bubble = detailsBtn.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        showWaimaiDetails(timestamp); // èª¿ç”¨æˆ‘å€‘æ–°åŠ çš„å‡½æ•¸
                        return; // è™•ç†å®Œå¾Œç›´æ¥é€€å‡º
                    }
                }
            }
            
            // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒæ–°å¢ä»£ç¢¼å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
            // æª¢æŸ¥æ˜¯å¦é»æ“Šäº† "ç‚ºTaè²·å–®" æˆ– "æ®˜å¿æ‹’çµ•" æŒ‰éˆ•
            const choiceBtn = e.target.closest('.waimai-user-actions button');
            if (choiceBtn) {
                const bubble = choiceBtn.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    const choice = choiceBtn.dataset.choice; // ç²å– 'paid' æˆ– 'rejected'
                    if (!isNaN(timestamp) && choice) {
                        await handleWaimaiResponse(timestamp, choice); // èª¿ç”¨å·²æœ‰çš„è™•ç†å‡½æ•¸
                        return; // è™•ç†å®Œå¾Œé€€å‡ºï¼Œé¿å…è§¸ç™¼å…¶ä»–é‚è¼¯
                    }
                }
            }
        
            // --- ä»¥ä¸‹æ˜¯æ‚¨åŸä¾†å·²æœ‰çš„æ‰€æœ‰å…¶ä»–é»æ“Šäº‹ä»¶é‚è¼¯ï¼Œä¿æŒä¸è®Š ---
            const deletedPostPlaceholder = e.target.closest('.post-deleted-placeholder');
            if (deletedPostPlaceholder) {
                const postId = parseInt(deletedPostPlaceholder.dataset.postId);
                if (!isNaN(postId)) {
                    const post = await db.qzonePosts.get(postId);
                    if (post) {
                        let originalContent = '';
                        const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'æœªçŸ¥ä½œè€…');
                        
                        if(post.type === 'shuoshuo'){
                            originalContent = post.content;
                        } else {
                            originalContent = post.publicText || '';
                            if(post.imageUrl) originalContent += `\n[åœ–ç‰‡]`;
                            if(post.hiddenContent) originalContent += `\n[æ–‡å­—åœ–å…§å®¹: ${post.hiddenContent}]`;
                        }
                        
                        showCustomAlert(
                            `ä¾†è‡ª ${authorName} çš„å·²åˆªé™¤å‹•æ…‹`, 
                            originalContent.replace(/\n/g, '<br>')
                        );
                    } else {
                        showCustomAlert('æç¤º', 'é€™æ¢å‹•æ…‹çš„åŸå§‹è³‡æ–™å·²è¢«å¾¹åº•æ¸…é™¤ã€‚');
                    }
                }
                return;
            }
        
            const aiImage = e.target.closest('.ai-generated-image');
            if (aiImage) {
                const description = aiImage.dataset.description;
                if (description) showCustomAlert('ç…§ç‰‡æè¿°', description);
                return;
            }
        
            const quoteBlock = e.target.closest('.quoted-message');
            if (quoteBlock && quoteBlock.dataset.originalTimestamp) {
                const originalTimestamp = parseInt(quoteBlock.dataset.originalTimestamp);
                if (!isNaN(originalTimestamp)) {
                    scrollToOriginalMessage(originalTimestamp);
                }
            }
            
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const bubble = giftCard.closest('.message-bubble');
                if (bubble) {
                    showGiftReceipt(parseInt(bubble.dataset.timestamp));
                }
            }
        
            const packetCard = e.target.closest('.red-packet-card');
            if (packetCard) {
                const messageBubble = packetCard.closest('.message-bubble');
                if (messageBubble && messageBubble.dataset.timestamp) {
                    const timestamp = parseInt(messageBubble.dataset.timestamp);
                    handlePacketClick(timestamp);
                }
            }
            
            const pollCard = e.target.closest('.poll-card');
            if (pollCard) {
                const timestamp = parseInt(pollCard.dataset.pollTimestamp);
                if (isNaN(timestamp)) return;
                
                const optionItem = e.target.closest('.poll-option-item');
                if (optionItem && !pollCard.classList.contains('closed')) {
                    handleUserVote(timestamp, optionItem.dataset.option);
                    return;
                }
                
                const actionBtn = e.target.closest('.poll-action-btn');
                if (actionBtn) {
                    if (pollCard.classList.contains('closed')) {
                        showPollResults(timestamp);
                    } else {
                        endPoll(timestamp);
                    }
                    return;
                }
        
                if (pollCard.classList.contains('closed')) {
                    showPollResults(timestamp);
                }
            }
        

        
            const placeholder = e.target.closest('.recalled-message-placeholder');
            if (placeholder) {
                const chat = state.chats[state.activeChatId];
                const wrapper = placeholder.closest('.message-wrapper');
                if (chat && wrapper) {
                    const timestamp = parseInt(wrapper.dataset.timestamp);
                    const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
                    
                    if (recalledMsg && recalledMsg.recalledData) {
                        let originalContentText = '';
                        const recalled = recalledMsg.recalledData;
                        
                        if (recalled.originalType === 'text') {
                            originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                        } else {
                            originalContentText = `æ’¤å›äº†ä¸€æ¢[${recalled.originalType}]é¡å‹çš„æ¶ˆæ¯`;
                        }
                        showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
                    }
                }
            }
        
            const linkCard = e.target.closest('.link-share-card');
            if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
                const timestamp = parseInt(linkCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
            }
        
            const bubble = e.target.closest('.message-bubble');
            if (bubble && bubble.classList.contains('ai') && bubble.classList.contains('is-transfer') && bubble.dataset.status === 'pending') {
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    
                    const chatSettingsModal = document.getElementById('chat-settings-modal');
                    const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
                    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ updateWorldBookSelectionDisplay å‡½æ•¸ â–¼â–¼â–¼
        function updateWorldBookSelectionDisplay() {
            const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked');
            const displayText = document.querySelector('.selected-options-text');
            
            if (checkedBoxes.length === 0) {
                displayText.textContent = '-- é»æ“Šé¸æ“‡ --';
            } else if (checkedBoxes.length > 2) {
                displayText.textContent = `å·²é¸æ“‡ ${checkedBoxes.length} æœ¬ä¸–ç•Œæ›¸`;
            } else {
                const displayItems = Array.from(checkedBoxes).map(cb => {
                    return cb.parentElement.textContent.trim();
                });
                displayText.textContent = displayItems.join(', ');
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²   
                    
                    worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
                    document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
                    window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹ V3.0 æœ€çµ‚ä¿®å¾©ç‰ˆã€‘æ›¿æ›èˆŠçš„ chat-settings-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('chat-settings-btn').addEventListener('click', async () => {
            loadThemePresetsDropdown(); // <-- æ–°å¢é€™ä¸€è¡Œ
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const isGroup = chat.isGroup;
        
            // --- ï¼ˆé€™éƒ¨åˆ†èˆ‡ä¹‹å‰ç›¸åŒï¼Œä¿æŒä¸è®Šï¼‰ ---
            const switchGreetingGroup = document.getElementById('switch-greeting-group');
            if (!isGroup && chat.settings.alternateGreetings && chat.settings.alternateGreetings.length > 0) {
                switchGreetingGroup.style.display = 'block';
            } else {
                switchGreetingGroup.style.display = 'none';
            }
            
            document.getElementById('chat-name-group').style.display = 'block';
            document.getElementById('my-persona-group').style.display = 'block';
            document.getElementById('my-avatar-group').style.display = 'block';
            document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('my-nickname-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-original-name-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-voice-id-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('offline-mode-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-cooldown-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-cooldown-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('chat-name-input').value = chat.name;
            document.getElementById('my-persona').value = chat.settings.myPersona;
            document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
            document.getElementById('max-memory').value = chat.settings.maxMemory;
            document.getElementById('linked-memory-count').value = chat.settings.linkedMemoryCount || 10;
            const bgPreview = document.getElementById('bg-preview');
            const removeBgBtn = document.getElementById('remove-bg-btn');
            if (chat.settings.background) {
                bgPreview.src = chat.settings.background;
                bgPreview.style.display = 'block';
                removeBgBtn.style.display = 'inline-block';
            } else {
                bgPreview.style.display = 'none';
                removeBgBtn.style.display = 'none';
            }
            document.getElementById('lyrics-position-group').style.display = isGroup ? 'none' : 'block';
// ã€æ ¸å¿ƒæ–°å¢ã€‘æ ¹æ“šæ˜¯å¦ç‚ºç¾¤èŠï¼Œé¡¯ç¤ºæˆ–éš±è—å°æ‡‰çš„å¾Œè‡ºæ´»å‹•é–‹é—œ
document.getElementById('single-char-background-activity-group').style.display = isGroup ? 'none' : 'block';
document.getElementById('group-background-activity-group').style.display = isGroup ? 'block' : 'none';

// (å¾ŒçºŒçš„è³¦å€¼é‚è¼¯ï¼Œè«‹ç”¨ä¸‹é¢é€™æ•´å¡Šæ–°ä»£ç¢¼å®Œæ•´æ›¿æ›)
// ã€æ–°å¢ä»£ç¢¼ã€‘è®€å–æ™‚é–“æ„ŸçŸ¥è¨­ç½®
// ã€æ–°å¢ä»£ç¢¼ã€‘è®€å–æ™‚é–“æ„ŸçŸ¥è¨­ç½®ä¸¦æ§åˆ¶æ™‚å€é¸æ“‡å™¨é¡¯éš±
const timePerceptionToggle = document.getElementById('time-perception-toggle');
const timeZoneGroup = document.getElementById('time-zone-group');
timePerceptionToggle.checked = chat.settings.enableTimePerception;
timeZoneGroup.style.display = timePerceptionToggle.checked ? 'block' : 'none';

// å¡«å……æ™‚å€ä¸‹æ‹‰æ¸…å–®
const timezoneSelect = document.getElementById('time-zone-select');
// Intl.supportedValuesOf('timeZone') æ˜¯æµè¦½å™¨å…§ç½®çš„APIï¼Œå¯ä»¥ç²å–æ‰€æœ‰æ”¯æ´çš„æ™‚å€
const timezones = Intl.supportedValuesOf('timeZone');
timezoneSelect.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …
timezones.forEach(tz => {
    const option = document.createElement('option');
    option.value = tz;
    option.textContent = tz;
    timezoneSelect.appendChild(option);
});
// è¨­ç½®ç•¶å‰é¸ä¸­çš„æ™‚å€ï¼Œå¦‚æœæ²’è¨­ç½®éï¼Œå‰‡é»˜èªç‚ºä¸Šæµ·
timezoneSelect.value = chat.settings.timeZone || 'Asia/Shanghai';
if (isGroup) {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘è®€å–ä¸¦è¨­ç½®ç¾¤èŠé–‹é—œçš„ç‹€æ…‹
    document.getElementById('group-background-activity-switch').checked = chat.settings.enableBackgroundActivity;
    document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
    document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
    document.getElementById('group-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;

    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨ç¾¤èŠè¨­ç½®ä¸­ï¼Œéš±è—å–®èŠçš„å¾Œè‡ºæ´»å‹•é–‹é—œ
    document.getElementById('single-char-background-activity-group').style.display = 'none';
    renderGroupMemberSettings(chat.members);
} else {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨å–®èŠè¨­ç½®ä¸­ï¼Œé¡¯ç¤ºä¸¦è¨­ç½®é–‹é—œçš„ç•¶å‰ç‹€æ…‹
    document.getElementById('single-char-background-activity-group').style.display = 'block';
    document.getElementById('char-background-activity-switch').checked = chat.settings.enableBackgroundActivity;

    // (å…¶ä»–å–®èŠè¨­ç½®çš„è®€å–é‚è¼¯ä¿æŒä¸è®Š)
    const offlineModeToggle = document.getElementById('offline-mode-toggle');
    const offlineModeOptions = document.getElementById('offline-mode-options');
    const offlineMinInput = document.getElementById('offline-min-length-input');
    const offlineMaxInput = document.getElementById('offline-max-length-input');
    offlineModeToggle.checked = chat.settings.isOfflineMode || false;
    offlineModeOptions.style.display = offlineModeToggle.checked ? 'block' : 'none';
    offlineMinInput.value = chat.settings.offlineMinLength || 100;
    offlineMaxInput.value = chat.settings.offlineMaxLength || 300;
await renderOfflinePresetSelector(chat);
    document.getElementById('ai-original-name-input').value = chat.originalName;
document.getElementById('ai-voice-id-input').value = chat.settings.minimaxVoiceId || '';
document.getElementById('enable-tts-switch').checked = chat.settings.enableTts !== false;
    document.getElementById('ai-persona').value = chat.settings.aiPersona;
    document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
    document.getElementById('my-nickname-input').value = chat.settings.myNickname || 'æˆ‘';
    document.getElementById('ai-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;
    const select = document.getElementById('assign-group-select');
    select.innerHTML = '<option value="">æœªåˆ†çµ„</option>';
    const groups = await db.qzoneGroups.toArray();
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        if (chat.groupId === group.id) option.selected = true;
        select.appendChild(option);
    });
    const lyricsPos = chat.settings.lyricsPosition || { vertical: 'top', horizontal: 'center', offset: 10 };
    document.getElementById('lyrics-vertical-pos').value = lyricsPos.vertical;
    document.getElementById('lyrics-horizontal-pos').value = lyricsPos.horizontal;
    document.getElementById('lyrics-offset-input').value = lyricsPos.offset;
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
            // --- ã€ã€ã€æ ¸å¿ƒä¿®å¾©å¾é€™è£¡é–‹å§‹ã€‘ã€‘ã€‘ ---
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            worldBookCheckboxesContainer.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨
        
            const [allCategories, allBooks] = await Promise.all([
                db.worldBookCategories.toArray(),
                db.worldBooks.toArray()
            ]);
        
            const linkedBookIds = new Set(chat.settings.linkedWorldBookIds || []);
        
            if (allBooks.length === 0) {
                worldBookCheckboxesContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a;">é‚„æ²’æœ‰å‰µå»ºä»»ä½•ä¸–ç•Œæ›¸</p>';
            } else {
                // 1. å…ˆæŒ‰åˆ†é¡æ¸²æŸ“æ›¸ç±
                allCategories.forEach(cat => {
                    const booksInCategory = allBooks.filter(book => book.categoryId === cat.id);
                    if (booksInCategory.length > 0) {
                        const categoryHeader = document.createElement('h4');
                        categoryHeader.textContent = cat.name; // åˆ†é¡åä½œç‚ºæ¨™é¡Œ
                        categoryHeader.style.cssText = 'margin: 10px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
                        worldBookCheckboxesContainer.appendChild(categoryHeader);
        
                        booksInCategory.forEach(book => {
                            const isChecked = linkedBookIds.has(book.id);
                            const label = document.createElement('label');
                            // çµ±ä¸€ä½¿ç”¨ book_ é¦–ç¢¼
                            label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                            worldBookCheckboxesContainer.appendChild(label);
                        });
                    }
                });
        
                // 2. æ¸²æŸ“æœªåˆ†é¡çš„æ›¸ç±
                const uncategorizedBooks = allBooks.filter(book => !book.categoryId);
                if (uncategorizedBooks.length > 0) {
                    const bookHeader = document.createElement('h4');
                    bookHeader.textContent = 'æœªåˆ†é¡';
                    bookHeader.style.cssText = 'margin: 15px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
                    worldBookCheckboxesContainer.appendChild(bookHeader);
        
                    uncategorizedBooks.forEach(book => {
                        const isChecked = linkedBookIds.has(book.id);
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                        worldBookCheckboxesContainer.appendChild(label);
                    });
                }
            }
            // --- ã€ã€ã€æ ¸å¿ƒä¿®å¾©åˆ°é€™è£¡çµæŸã€‘ã€‘ã€‘ ---
        
            updateWorldBookSelectionDisplay();

            const linkMemoryToggle = document.getElementById('link-memory-toggle'); const linkedMemorySelection = document.getElementById('linked-memory-selection'); const linkedChatsContainer = document.getElementById('linked-chats-checkboxes-container'); const linkedMemoryIds = chat.settings.linkedMemoryChatIds || []; linkMemoryToggle.checked = linkedMemoryIds.length > 0; linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none'; linkedChatsContainer.innerHTML = ''; Object.values(state.chats).forEach(c => { if (c.id === chat.id) return; const isChecked = linkedMemoryIds.includes(c.id); const prefix = c.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]'; const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${c.id}" ${isChecked ? 'checked' : ''}> ${prefix} ${c.name}`; linkedChatsContainer.appendChild(label); }); function updateLinkedMemorySelectionDisplay() { const checkedBoxes = linkedChatsContainer.querySelectorAll('input:checked'); const displayText = linkedMemorySelection.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- é»æ“Šé¸æ“‡ --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é¸æ“‡ ${checkedBoxes.length} é …`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } } updateLinkedMemorySelectionDisplay(); linkMemoryToggle.addEventListener('change', () => { linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none'; }); const linkedMemorySelectBox = linkedMemorySelection.querySelector('.select-box'); const newLinkedMemorySelectBox = linkedMemorySelectBox.cloneNode(true); linkedMemorySelectBox.parentNode.replaceChild(newLinkedMemorySelectBox, linkedMemorySelectBox); newLinkedMemorySelectBox.addEventListener('click', (e) => { e.stopPropagation(); linkedChatsContainer.classList.toggle('visible'); newLinkedMemorySelectBox.classList.toggle('expanded'); }); linkedChatsContainer.addEventListener('change', updateLinkedMemorySelectionDisplay);
            const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`); if (themeRadio) themeRadio.checked = true;
            const fontSizeSlider = document.getElementById('font-size-slider'); fontSizeSlider.value = chat.settings.fontSize || 13; document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            const customCssInput = document.getElementById('custom-css-input'); customCssInput.value = chat.settings.customCss || '';
            updateSettingsPreview();
            document.getElementById('auto-memory-toggle').checked = chat.settings.enableAutoMemory || false;
            document.getElementById('auto-memory-interval').value = chat.settings.autoMemoryInterval || 20;
            showScreen('chat-settings-screen');
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    
// â–¼â–¼â–¼ ã€V2.0 | é ­åƒæœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ renderGroupMemberSettings å‡½æ•¸ â–¼â–¼â–¼
function renderGroupMemberSettings(members) { 
    const container = document.getElementById('group-members-settings'); 
    container.innerHTML = ''; 
    members.forEach(member => { 
        const div = document.createElement('div'); 
        div.className = 'member-editor'; 
        div.dataset.memberId = member.id; 
        
        // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¾© â‘ ã€‘â˜…â˜…â˜…â˜…â˜…
        // å„ªå…ˆä½¿ç”¨æˆå“¡è‡ªå·±ç¨ç«‹çš„é ­åƒ(member.avatar)ï¼Œå¦‚æœæ²’æœ‰ï¼Œå†å˜—è©¦å»å–®èŠé…ç½®è£¡æ‰¾ï¼Œ
        // å¦‚æœé‚„æ²’æœ‰ï¼Œæœ€å¾Œæ‰ç”¨é»˜èªé ­åƒã€‚é€™å¥—é‚è¼¯èƒ½å®Œç¾ç›¸å®¹æ‰€æœ‰é¡å‹çš„æˆå“¡ã€‚
        const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);

        div.innerHTML = `<img src="${memberAvatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
        div.addEventListener('click', () => openMemberEditor(member.id)); 
        container.appendChild(div); 
    }); 
}
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V2.0 | é ­åƒæœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ saveMemberSettings å‡½æ•¸ â–¼â–¼â–¼
document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
    if (!editingMemberId) return; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === editingMemberId); 
    if (!member) return;

    const newNickname = document.getElementById('member-name-input').value.trim();
    if (!newNickname) {
        alert("ç¾¤æ˜µç¨±ä¸èƒ½ç‚ºç©ºï¼");
        return;
    }
    member.groupNickname = newNickname; 
    member.persona = document.getElementById('member-persona-input').value; 
    
    const newAvatarUrl = document.getElementById('member-avatar-preview').src;

    // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¾© â‘¡ã€‘ â˜…â˜…â˜…â˜…â˜…
    // ç„¡è«–æˆå“¡æ˜¯â€œçœŸè§’è‰²â€é‚„æ˜¯â€œç´”NPCâ€ï¼Œéƒ½ã€å¿…é ˆã€‘å°‡æ–°é ­åƒURLç›´æ¥ä¿å­˜åœ¨ç¾¤èŠçš„æˆå“¡è³‡è¨Šè£¡ã€‚
    member.avatar = newAvatarUrl;

    // åŒæ™‚ï¼Œå¦‚æœé€™å€‹æˆå“¡æ˜¯ä¸€å€‹â€œçœŸè§’è‰²â€ï¼Œæˆ‘å€‘ä¾ç„¶æ›´æ–°ä»–çš„ä¸»é…ç½®ï¼Œä¿æŒè³‡æ–™åŒæ­¥ã€‚
    const characterProfile = state.chats[member.id];
    if (characterProfile) {
        characterProfile.settings.aiAvatar = newAvatarUrl;
        await db.chats.put(characterProfile);
    }
    
    // å°‡åŒ…å«æœ€æ–°æˆå“¡è³‡è¨Šçš„ã€æ•´å€‹ç¾¤èŠç‰©ä»¶ã€‘å­˜å›è³‡æ–™åº«ï¼Œè®“NPCçš„é ­åƒå¾—ä»¥æ°¸ä¹…ä¿å­˜ã€‚
    await db.chats.put(chat);
    
    // åˆ·æ–°UIä¸¦é—œé–‰å½ˆçª—
    renderGroupMemberSettings(chat.members); 
    document.getElementById('member-settings-modal').classList.remove('visible'); 
    editingMemberId = null;
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ openMemberEditor å‡½æ•¸ â–¼â–¼â–¼
        function openMemberEditor(memberId) { 
            editingMemberId = memberId; 
            const chat = state.chats[state.activeChatId]; 
            const member = chat.members.find(m => m.id === memberId); 
            if (!member) return; // å®‰å…¨æª¢æŸ¥
        
            document.getElementById('member-name-input').value = member.groupNickname; 
            document.getElementById('member-persona-input').value = member.persona; 
            
            // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¾© â‘¡ã€‘â˜…â˜…â˜…â˜…â˜…
            // ä½¿ç”¨èˆ‡ä¸Šé¢å®Œå…¨ç›¸åŒçš„é‚è¼¯ä¾†ç²å–ä¸¦é¡¯ç¤ºæ­£ç¢ºçš„ç•¶å‰é ­åƒã€‚
            const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
            document.getElementById('member-avatar-preview').src = memberAvatar;
        
            document.getElementById('member-settings-modal').classList.add('visible'); 
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
                    // â–¼â–¼â–¼ å°‡å…¶ã€å®Œæ•´æ›¿æ›ç‚ºã€‘ä¸‹é¢é€™æ®µä¿®æ­£å¾Œçš„ä»£ç¢¼ â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ 'save-member-settings-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
            if (!editingMemberId) return; 
            const chat = state.chats[state.activeChatId]; 
            const member = chat.members.find(m => m.id === editingMemberId); 
            if (!member) return;
        
            const newNickname = document.getElementById('member-name-input').value.trim();
            if (!newNickname) {
                alert("ç¾¤æ˜µç¨±ä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
            member.groupNickname = newNickname; 
            member.persona = document.getElementById('member-persona-input').value; 
            
            const newAvatarUrl = document.getElementById('member-avatar-preview').src;
        
            // â˜…â˜…â˜…â˜…â˜… é€™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¾©ã€‘ â˜…â˜…â˜…â˜…â˜…
            // ç„¡è«–æˆå“¡æ˜¯â€œçœŸè§’è‰²â€é‚„æ˜¯â€œç´”NPCâ€ï¼Œéƒ½ã€å¿…é ˆã€‘å°‡æ–°é ­åƒURLç›´æ¥ä¿å­˜åœ¨ç¾¤èŠçš„æˆå“¡è³‡è¨Šè£¡ã€‚
            member.avatar = newAvatarUrl;
        
            // åŒæ™‚ï¼Œå¦‚æœé€™å€‹æˆå“¡æ˜¯ä¸€å€‹â€œçœŸè§’è‰²â€ï¼Œæˆ‘å€‘ä¾ç„¶æ›´æ–°ä»–çš„ä¸»é…ç½®ï¼Œä¿æŒè³‡æ–™åŒæ­¥ã€‚
            const characterProfile = state.chats[member.id];
            if (characterProfile) {
                characterProfile.settings.aiAvatar = newAvatarUrl;
                await db.chats.put(characterProfile);
            }
            
            // å°‡åŒ…å«æœ€æ–°æˆå“¡è³‡è¨Šçš„ã€æ•´å€‹ç¾¤èŠç‰©ä»¶ã€‘å­˜å›è³‡æ–™åº«ï¼Œè®“NPCçš„é ­åƒå¾—ä»¥æ°¸ä¹…ä¿å­˜ã€‚
            await db.chats.put(chat);
            
            // åˆ·æ–°UIä¸¦é—œé–‰å½ˆçª—
            renderGroupMemberSettings(chat.members); 
            document.getElementById('member-settings-modal').classList.remove('visible'); 
            editingMemberId = null;
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
                   
        
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ 'save-chat-settings-btn' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // --- æ•ç²èˆŠçš„ç·šä¸‹æ¨¡å¼ç‹€æ…‹ ---
    const oldOfflineModeState = chat.settings.isOfflineMode || false;

    // --- (æ‰€æœ‰å…¶ä»–è¨­ç½®çš„ä¿å­˜é‚è¼¯ä¿æŒä¸è®Š) ---
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('å‚™è¨»å/ç¾¤åä¸èƒ½ç‚ºç©ºï¼');
    if (!chat.isGroup && newName !== chat.name) {
        if (!chat.nameHistory) chat.nameHistory = [];
        if (!chat.nameHistory.includes(chat.name)) chat.nameHistory.push(chat.name);
    }
    chat.name = newName;
    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    chat.settings.linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;
    
    const checkedBookItems = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
    const newLinkedBookIds = [];
    checkedBookItems.forEach(cb => {
        if (cb.value.startsWith('book_')) {
            newLinkedBookIds.push(cb.value.replace('book_', ''));
        }
    });
    chat.settings.linkedWorldBookIds = newLinkedBookIds;
    
    const linkMemoryToggleChecked = document.getElementById('link-memory-toggle').checked;
    if (linkMemoryToggleChecked) {
        const checkedChats = document.querySelectorAll('#linked-chats-checkboxes-container input:checked');
        chat.settings.linkedMemoryChatIds = Array.from(checkedChats).map(cb => cb.value);
    } else {
        chat.settings.linkedMemoryChatIds = [];
    }
    chat.settings.enableAutoMemory = document.getElementById('auto-memory-toggle').checked;
    chat.settings.autoMemoryInterval = parseInt(document.getElementById('auto-memory-interval').value) || 20;
    chat.settings.enableTimePerception = document.getElementById('time-perception-toggle').checked;
    chat.settings.timeZone = document.getElementById('time-zone-select').value;
    
    if (chat.isGroup) {
        chat.settings.enableBackgroundActivity = document.getElementById('group-background-activity-switch').checked;
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
        chat.settings.actionCooldownMinutes = parseInt(document.getElementById('group-action-cooldown-input').value) || 10;
    } else {
        chat.settings.enableBackgroundActivity = document.getElementById('char-background-activity-switch').checked;
        const newOfflineModeState = document.getElementById('offline-mode-toggle').checked;
        chat.settings.isOfflineMode = newOfflineModeState;

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        //            é€™å°±æ˜¯æœ¬æ¬¡ä¿®å¾©çš„æ ¸å¿ƒæ‰€åœ¨ï¼
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
        // 1. æª¢æŸ¥æ˜¯å¦æ˜¯å¾â€œç·šä¸‹(true)â€åˆ‡æ›åˆ°äº†â€œç·šä¸Š(false)â€
        if (oldOfflineModeState === true && newOfflineModeState === false) {
            
            // 2. å¦‚æœæ˜¯ï¼Œå°±å‰µå»ºä¸€å€‹å°ä½¿ç”¨è€…éš±è—çš„ç³»çµ±æŒ‡ä»¤
            const switchInstruction = {
                role: 'system',
                content: '[ç³»çµ±æŒ‡ä»¤ï¼šæ¨¡å¼å·²åˆ‡æ›ï¼ä½ ç¾åœ¨å›åˆ°äº†ç·šä¸ŠèŠå¤©æ¨¡å¼ã€‚ä½ çš„å›å¾©ã€å¿…é ˆã€‘åš´æ ¼éµå®ˆç·šä¸Šæ¨¡å¼çš„JSONé™£åˆ—æ ¼å¼ï¼Œä¾‹å¦‚ [{"type": "text", "content": "ä½ å¥½"}]]',
                timestamp: Date.now(),
                isHidden: true // é€™å€‹æ¨™è¨˜ç¢ºä¿ä½¿ç”¨è€…çœ‹ä¸åˆ°é€™æ¢æŒ‡ä»¤ï¼Œä½†AIèƒ½è®€åˆ°
            };
            
            // 3. å°‡é€™æ¢æŒ‡ä»¤æ³¨å…¥åˆ°èŠå¤©è¨˜éŒ„çš„æœ«å°¾
            chat.history.push(switchInstruction);
            console.log("å·²æˆåŠŸæ³¨å…¥â€œåˆ‡æ›åˆ°ç·šä¸Šæ¨¡å¼â€çš„ç³»çµ±æŒ‡ä»¤ã€‚");
        }
        
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
        chat.settings.offlineMinLength = parseInt(document.getElementById('offline-min-length-input').value) || 100;
        chat.settings.offlineMaxLength = parseInt(document.getElementById('offline-max-length-input').value) || 300;
        chat.settings.offlinePresetId = document.getElementById('offline-preset-select').value || null;
        
        const newOriginalName = document.getElementById('ai-original-name-input').value.trim();
        if (!newOriginalName) return alert('å°æ–¹æœ¬åä¸èƒ½ç‚ºç©ºï¼');
        chat.originalName = newOriginalName;
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.minimaxVoiceId = document.getElementById('ai-voice-id-input').value.trim();
chat.settings.enableTts = document.getElementById('enable-tts-switch').checked;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        chat.settings.myNickname = document.getElementById('my-nickname-input').value.trim() || 'æˆ‘';
        chat.settings.actionCooldownMinutes = parseInt(document.getElementById('ai-action-cooldown-input').value) || 10;
        chat.settings.lyricsPosition = {
            vertical: document.getElementById('lyrics-vertical-pos').value,
            horizontal: document.getElementById('lyrics-horizontal-pos').value,
            offset: parseInt(document.getElementById('lyrics-offset-input').value) || 10
        };
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    await db.chats.put(chat);
    if (!chat.isGroup) {
        await syncCharacterNameInGroups(chat);
        await syncCharacterAvatarInGroups(chat);
    }
    applyLyricsBarPosition(chat);
    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    showScreen('chat-interface-screen');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„å®Œæ•´åŠŸèƒ½ä»£ç¢¼ï¼Œè«‹ç”¨å®ƒæ›¿æ›æ‰èˆŠçš„ã€‘ â–¼â–¼â–¼
        
        // ç‚ºèŠå¤©è¨­ç½®è£¡çš„â€œæ›´æ›é ­åƒæ¡†â€æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶


// ç‚ºèŠå¤©è¨­ç½®è£¡çš„â€œæ›´æ›é ­åƒæ¡†â€æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
document.getElementById('chat-settings-screen').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('chat');
    }
});
        
        // ç‚ºæˆå“¡è¨­ç½®è£¡çš„â€œæ›´æ›é ­åƒæ¡†â€æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
        document.getElementById('member-settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('change-frame-btn')) { 
                openFrameSelectorModal('member');
            }
        });
        
        // --- ã€æ–°å¢ã€‘ç‚ºé ­åƒæ¡†é¸æ“‡æ¨¡æ…‹æ¡†çš„æŒ‰éˆ•å’Œæ¨™ç±¤é ç¶å®šäº‹ä»¶ ---
        const frameModal = document.getElementById('avatar-frame-modal');
        const aiFrameTab = document.getElementById('ai-frame-tab');
        const myFrameTab = document.getElementById('my-frame-tab');
        const aiFrameContent = document.getElementById('ai-frame-content');
        const myFrameContent = document.getElementById('my-frame-content');
        
        // â€œä¿å­˜â€æŒ‰éˆ•
        document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
        
        // â€œå–æ¶ˆâ€æŒ‰éˆ•
        document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
            frameModal.classList.remove('visible');
            editingFrameForMember = false; // ç¢ºä¿é‡ç½®ç‹€æ…‹
        });
        
        // â€œå°æ–¹çš„â€ æ¨™ç±¤é 
        aiFrameTab.addEventListener('click', () => {
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
        });
        
        // â€œæˆ‘çš„â€ æ¨™ç±¤é 
        myFrameTab.addEventListener('click', () => {
            myFrameTab.classList.add('active');
            aiFrameTab.classList.remove('active');
            myFrameContent.style.display = 'block';
            aiFrameContent.style.display = 'none';
        });
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è¨˜éŒ„', 'æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œç„¡æ³•æ¢å¾©ã€‚ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
                    
                    const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
                    setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
                    setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
                    setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
                    setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
                    setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
                    setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
                    document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });
        
                    const stickerPanel = document.getElementById('sticker-panel');
                    document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
                    document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
                    // â–¼â–¼â–¼ ã€è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ add-sticker-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºâ€œæ‰¹é‡â€æŒ‰éˆ•ç¶å®šæ–°å‡½æ•¸
        document.getElementById('add-sticker-batch-btn').addEventListener('click', openBatchStickerImportModal);
        
// â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²æ·»åŠ åˆ†é¡IDã€‘çš„ç‰ˆæœ¬æ›¿æ›èˆŠçš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('add-sticker-url-btn').addEventListener('click', async () => {
            const url = await showCustomPrompt("æ·»åŠ è¡¨æƒ…(URL)", "è«‹è¼¸å…¥è¡¨æƒ…åŒ…çš„åœ–ç‰‡URL");
            if (!url || !url.trim().startsWith('http')) {
                if (url) alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„URL (ä»¥httpé–‹é ­)");
                return;
            }
            const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è«‹ç‚ºé€™å€‹è¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šé–‹å¿ƒã€ç–‘æƒ‘)");
            if (name && name.trim()) {
                const newSticker = { 
                    id: 'sticker_' + Date.now(), 
                    url: url.trim(), 
                    name: name.trim(),
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡è¡¨æƒ…æ­¸å…¥ç•¶å‰åˆ†é¡
                    categoryId: (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null
                };
                await db.userStickers.add(newSticker);
                state.userStickers.push(newSticker);
                renderStickerPanel();
            } else if (name !== null) {
                alert("è¡¨æƒ…åä¸èƒ½ç‚ºç©ºï¼");
            }
        });

        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
                    document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
                    document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.readAsDataURL(file); 
            reader.onload = async () => { 
                const base64Url = reader.result; 
                const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è«‹ç‚ºé€™å€‹è¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)"); 
                if (name && name.trim()) { 
                    const newSticker = { 
                        id: 'sticker_' + Date.now(), 
                        url: base64Url, 
                        name: name.trim(),
                        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡è¡¨æƒ…æ­¸å…¥ç•¶å‰åˆ†é¡
                        categoryId: (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null
                    }; 
                    await db.userStickers.add(newSticker); 
                    state.userStickers.push(newSticker); 
                    renderStickerPanel(); 
                } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ç‚ºç©ºï¼"); 
            }; 
            event.target.value = null; 
        });
        
                    document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
                    document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
                    document.getElementById('voice-message-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;

    const text = await showCustomPrompt("ç™¼é€èªéŸ³", "è«‹è¼¸å…¥ä½ æƒ³èªªçš„å…§å®¹ï¼š");
    if (text && text.trim()) {
        const chat = state.chats[state.activeChatId];
        
        // â˜…â˜…â˜… æ ¸å¿ƒç¢ºèªï¼šé¡å‹å¿…é ˆæ˜¯ 'voice_message' â˜…â˜…â˜…
        const msg = {
            role: 'user',
            type: 'voice_message', // ç¢ºä¿é€™è£¡æ˜¯ voice_messageï¼Œè€Œä¸æ˜¯ tts_voice
            content: text.trim(),
            timestamp: Date.now()
        };
        
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
    }
});
                    document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ç™¼é€ç…§ç‰‡", "è«‹ç”¨æ–‡å­—æè¿°æ‚¨è¦ç™¼é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
        
const waimaiModal = document.getElementById('waimai-request-modal');

// ç¶å®šå·¥å…·åˆ—çš„â€œå¤–è³£â€æŒ‰éˆ•ï¼Œç”¨æ–¼æ‰“é–‹å½ˆçª—
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

// ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç‚ºå½ˆçª—çš„åŠé€æ˜èƒŒæ™¯æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œå¯¦ç¾é»æ“Šå¤–éƒ¨é—œé–‰
waimaiModal.addEventListener('click', (e) => {
    // åªæœ‰ç•¶é»æ“Šçš„æ˜¯èƒŒæ™¯æœ¬èº«ï¼Œè€Œä¸æ˜¯å…§å®¹å€åŸŸæ™‚ï¼Œæ‰é—œé–‰
    if (e.target === waimaiModal) {
        waimaiModal.classList.remove('visible');
    }
});

// ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ç‚ºæ–°çš„â€œç‚ºTAé»å¤–è³£â€æŒ‰éˆ•ç¶å®šæˆ‘å€‘æ–°å‰µå»ºçš„å‡½æ•¸
document.getElementById('waimai-order-for-ai-btn').addEventListener('click', sendWaimaiOrderForAI);

// ç¶å®šâ€œç™¼èµ·ä»£ä»˜è«‹æ±‚â€æŒ‰éˆ•ï¼ˆé€™å€‹é‚è¼¯ä¿æŒä¸è®Šï¼‰
document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo || isNaN(amount) || amount <= 0) {
        alert('è«‹å¡«å¯«æœ‰æ•ˆçš„å•†å“è³‡è¨Šå’Œé‡‘é¡ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const msg = {
        role: 'user',
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});       
                    document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
                    document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
                    document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
                    document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
                    document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
                    document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
                    document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
                    document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
                    
                    document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
        
        // â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„å®Œæ•´åŠŸèƒ½ä»£ç¢¼ï¼Œè«‹ç”¨å®ƒæ›¿æ›æ‰èˆŠçš„ã€‘ â–¼â–¼â–¼

        // 1. ç‚ºæ–°çš„â€œåˆªé™¤(é€šçŸ¥AI)â€æŒ‰éˆ•ç¶å®šäº‹ä»¶ (é‚è¼¯èˆ‡èˆŠç‰ˆåˆªé™¤å®Œå…¨ç›¸åŒ)
        document.getElementById('selection-soft-delete-btn').addEventListener('click', async () => {
            if (selectedMessages.size === 0) return;
            const confirmed = await showCustomConfirm('åˆªé™¤æ¶ˆæ¯', `ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedMessages.size} æ¢æ¶ˆæ¯å—ï¼Ÿé€™æœƒé€šçŸ¥AIé€™äº›æ¶ˆæ¯å·²è¢«åˆªé™¤ã€‚`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                let deletedPollsInfo = [];
                for (const timestamp of selectedMessages) {
                    const msg = chat.history.find(m => m.timestamp === timestamp);
                    if (msg && msg.type === 'poll') {
                        deletedPollsInfo.push(`é—œæ–¼â€œ${msg.question}â€çš„æŠ•ç¥¨(æ™‚é–“æˆ³è¨˜: ${msg.timestamp})`);
                    }
                }
                chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
                let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ä½¿ç”¨è€…åˆªé™¤ã€‚";
                if (deletedPollsInfo.length > 0) {
                    forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š${deletedPollsInfo.join('ï¼›')}ã€‚`;
                }
                forgetReason += " ä½ æ‡‰è©²åƒå®ƒå€‘å¾æœªå­˜åœ¨éä¸€æ¨£ç¹¼çºŒå°è©±ï¼Œä¸¦ç›¸æ‡‰åœ°èª¿æ•´ä½ çš„è¨˜æ†¶å’Œè¡Œç‚ºï¼Œä¸è¦å†æåŠé€™äº›è¢«åˆªé™¤çš„å…§å®¹ã€‚";
                const forgetInstruction = {
                    role: 'system',
                    content: `[ç³»çµ±æç¤ºï¼š${forgetReason}]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(forgetInstruction);
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
            }
        });

        // 2. ç‚ºæ–°å¢çš„â€œå¾¹åº•åˆªé™¤â€æŒ‰éˆ•ç¶å®šå…¨æ–°çš„ã€çœŸæ­£çš„åˆªé™¤é‚è¼¯
        document.getElementById('selection-erase-btn').addEventListener('click', async () => {
            if (selectedMessages.size === 0) return;
            const confirmed = await showCustomConfirm(
                'å¾¹åº•åˆªé™¤æ¶ˆæ¯', 
                `é€™å°‡å¾æ­·å²è¨˜éŒ„ä¸­ã€æ°¸ä¹…æŠ¹é™¤ã€‘é€™ ${selectedMessages.size} æ¢æ¶ˆæ¯ï¼ŒAIå°‡å®Œå…¨éºå¿˜å®ƒå€‘çš„å­˜åœ¨ã€‚ç¢ºå®šå—ï¼Ÿ`, 
                { confirmButtonClass: 'btn-danger', confirmText: 'ç¢ºèªæŠ¹é™¤' }
            );
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                
                // æ ¸å¿ƒé‚è¼¯ï¼šç›´æ¥éæ¿¾æ‰è¢«é¸ä¸­çš„æ¶ˆæ¯ï¼Œä¸æ·»åŠ ä»»ä½•ç³»çµ±æç¤º
                chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
                
                // ç›´æ¥ä¿å­˜ï¼ŒAIçš„ä¸‹ä¸€æ¬¡è«‹æ±‚å°‡ä¸æœƒåŒ…å«é€™äº›è¢«åˆªé™¤çš„æ¶ˆæ¯
                await db.chats.put(chat);
                
                // åˆ·æ–°UI
                renderChatInterface(state.activeChatId);
                renderChatList();
            }
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
                    const fontUrlInput = document.getElementById('font-url-input');
                    fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
                    document.getElementById('save-font-btn').addEventListener('click', async () => {
                        const newFontUrl = fontUrlInput.value.trim();
                        if (!newFontUrl) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å­—é«”URLã€‚"); return; }
                        applyCustomFont(newFontUrl, false);
                        state.globalSettings.fontUrl = newFontUrl;
                        await db.globalSettings.put(state.globalSettings);
                        alert('å­—é«”å·²ä¿å­˜ä¸¦æ‡‰ç”¨ï¼');
                    });
                    document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
        
                    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
                    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
                    document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç¨±", "è«‹è¼¸å…¥æ–°çš„æ˜µç¨±", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
                    document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
                    document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
                    document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
                    document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
        
        // â–¼â–¼â–¼ ã€ä¿®æ­£å¾Œã€‘çš„â€œèªªèªªâ€æŒ‰éˆ•äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
            // 1. é‡ç½®ä¸¦ç²å–æ¨¡æ…‹æ¡†
            resetCreatePostModal();
            const modal = document.getElementById('create-post-modal');
            
            // 2. è¨­ç½®ç‚ºâ€œèªªèªªâ€æ¨¡å¼
            modal.dataset.mode = 'shuoshuo';
            
            // 3. éš±è—èˆ‡åœ–ç‰‡/æ–‡å­—åœ–ç›¸é—œçš„éƒ¨åˆ†
            modal.querySelector('.post-mode-switcher').style.display = 'none';
            modal.querySelector('#image-mode-content').style.display = 'none';
            modal.querySelector('#text-image-mode-content').style.display = 'none';
            
            // 4. ä¿®æ”¹ä¸»è¼¸å…¥æ¡†çš„æç¤ºèªï¼Œä½¿å…¶æ›´ç¬¦åˆâ€œèªªèªªâ€çš„å ´æ™¯
            modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é®®äº‹...';
            
            // 5. æº–å‚™ä¸¦é¡¯ç¤ºæ¨¡æ…‹æ¡†
            const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
            visibilityGroupsContainer.innerHTML = '';
            const groups = await db.qzoneGroups.toArray();
            if (groups.length > 0) {
                groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                    visibilityGroupsContainer.appendChild(label);
                });
            } else {
                visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²’æœ‰å¯ç”¨çš„åˆ†çµ„</p>';
            }
            modal.classList.add('visible');
        });
        
        // â–¼â–¼â–¼ ã€ä¿®æ­£å¾Œã€‘çš„â€œå‹•æ…‹â€ï¼ˆåœ–ç‰‡ï¼‰æŒ‰éˆ•äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('create-post-btn').addEventListener('click', async () => {
            // 1. é‡ç½®ä¸¦ç²å–æ¨¡æ…‹æ¡†
            resetCreatePostModal();
            const modal = document.getElementById('create-post-modal');
            
            // 2. è¨­ç½®ç‚ºâ€œè¤‡é›œå‹•æ…‹â€æ¨¡å¼
            modal.dataset.mode = 'complex';
            
        // 3. ç¢ºä¿èˆ‡åœ–ç‰‡/æ–‡å­—åœ–ç›¸é—œçš„éƒ¨åˆ†æ˜¯å¯è¦‹çš„
        modal.querySelector('.post-mode-switcher').style.display = 'flex';
        // é¡¯å¼å•Ÿå‹•â€œä¸Šå‚³åœ–ç‰‡â€æ¨¡å¼...
        modal.querySelector('#image-mode-content').classList.add('active');
        // ...åŒæ™‚ç¢ºä¿â€œæ–‡å­—åœ–â€æ¨¡å¼æ˜¯éš±è—çš„
        modal.querySelector('#text-image-mode-content').classList.remove('active');
            
            // 4. æ¢å¾©ä¸»è¼¸å…¥æ¡†çš„é»˜èªæç¤ºèª
            modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é®®äº‹...ï¼ˆéå¿…å¡«çš„å…¬é–‹æ–‡å­—ï¼‰';
        
            // 5. æº–å‚™ä¸¦é¡¯ç¤ºæ¨¡æ…‹æ¡†ï¼ˆèˆ‡â€œèªªèªªâ€æŒ‰éˆ•çš„é‚è¼¯ç›¸åŒï¼‰
            const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
            visibilityGroupsContainer.innerHTML = '';
            const groups = await db.qzoneGroups.toArray();
            if (groups.length > 0) {
                groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                    visibilityGroupsContainer.appendChild(label);
                });
            } else {
                visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²’æœ‰å¯ç”¨çš„åˆ†çµ„</p>';
            }
            modal.classList.add('visible');
        });
                    document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
                    document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });
        
        // --- â†“â†“â†“ å¾é€™è£¡é–‹å§‹è¤‡è£½ â†“â†“â†“ ---
        
        document.getElementById('album-photos-back-btn').addEventListener('click', () => {
            state.activeAlbumId = null;
            showScreen('album-screen');
        });
        
        document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());
        
        document.getElementById('album-photo-input').addEventListener('change', async (event) => {
            if (!state.activeAlbumId) return;
            const files = event.target.files;
            if (!files.length) return;
        
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            
            for (const file of files) {
                const dataUrl = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
            }
        
            const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
            const updateData = { photoCount };
            
            if (!album.photoCount || album.coverUrl.includes('placeholder')) {
                const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                if(firstPhoto) updateData.coverUrl = firstPhoto.url;
            }
        
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            
            event.target.value = null;
            alert('ç…§ç‰‡ä¸Šå‚³æˆåŠŸï¼');
        });
        
        // --- â†‘â†‘â†‘ è¤‡è£½åˆ°é€™è£¡çµæŸ â†‘â†‘â†‘ ---
        
        // --- â†“â†“â†“ å¾é€™è£¡é–‹å§‹è¤‡è£½ï¼Œå®Œæ•´æ›¿æ›æ‰èˆŠçš„ photos-grid-page ç›£è½å™¨ â†“â†“â†“ ---
        
        document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.photo-delete-btn');
            const photoThumb = e.target.closest('.photo-thumb');
        
            if (deleteBtn) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ–ç‰‡ä¸Š
                const photoId = parseInt(deleteBtn.dataset.photoId);
                const confirmed = await showCustomConfirm(
                    'åˆªé™¤ç…§ç‰‡',
                    'ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚',
                    { confirmButtonClass: 'btn-danger' }
                );
        
                if (confirmed) {
                    const deletedPhoto = await db.qzonePhotos.get(photoId);
                    if (!deletedPhoto) return;
                    
                    await db.qzonePhotos.delete(photoId);
        
                    const album = await db.qzoneAlbums.get(state.activeAlbumId);
                    const photoCount = (album.photoCount || 1) - 1;
                    const updateData = { photoCount };
                    
                    if (album.coverUrl === deletedPhoto.url) {
                        const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                        updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
                    }
                    
                    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                    await renderAlbumPhotosScreen();
                    await renderAlbumList();
                    alert('ç…§ç‰‡å·²åˆªé™¤ã€‚');
                }
            } 
            else if (photoThumb) {
                // é€™å°±æ˜¯æ¢å¾©çš„åœ–ç‰‡é»æ“Šæ”¾å¤§åŠŸèƒ½ï¼
                openPhotoViewer(photoThumb.src);
            }
        });
        
        // æ¢å¾©åœ–ç‰‡æª¢è¦–å™¨çš„æ§åˆ¶äº‹ä»¶
        document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
        document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
        document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);
        
        // æ¢å¾©éµç›¤å·¦å³ç®­é ­å’ŒESCéµçš„åŠŸèƒ½
        document.addEventListener('keydown', (e) => {
            if (!photoViewerState.isOpen) return; 
        
            if (e.key === 'ArrowRight') {
                showNextPhoto();
            } else if (e.key === 'ArrowLeft') {
                showPrevPhoto();
            } else if (e.key === 'Escape') {
                closePhotoViewer();
            }
        });
        
        // --- â†‘â†‘â†‘ è¤‡è£½åˆ°é€™è£¡çµæŸ â†‘â†‘â†‘ ---
                 
        document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("å‰µå»ºæ–°ç›¸å†Š", "è«‹è¼¸å…¥ç›¸å†Šåç¨±"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Š "${albumName}" å‰µå»ºæˆåŠŸï¼`); } else if (albumName !== null) { alert("ç›¸å†Šåç¨±ä¸èƒ½ç‚ºç©ºï¼"); } });
        
                    document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
                    document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
                    document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
                    document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¼¸å…¥åœ–ç‰‡URL", "è«‹è¼¸å…¥ç¶²è·¯åœ–ç‰‡çš„é€£çµ", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
                    document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
                    const imageModeBtn = document.getElementById('switch-to-image-mode');
                    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
                    const imageModeContent = document.getElementById('image-mode-content');
                    const textImageModeContent = document.getElementById('text-image-mode-content');
                    imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
                    textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®æ­£ç‰ˆã€‘çš„â€œç™¼ä½ˆâ€æŒ‰éˆ•äº‹ä»¶ï¼Œå·²ä¿®å¾©è¨±å¯æ¬Šæ¼æ´ â–¼â–¼â–¼
        document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
            const modal = document.getElementById('create-post-modal');
            const mode = modal.dataset.mode;
            
            // --- 1. ç²å–é€šç”¨çš„å¯è¦‹æ€§è¨­ç½® ---
            const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
            let visibleGroupIds = null;
            
            if (visibilityMode === 'include') {
                visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
            }
        
            let newPost = {};
            const basePostData = {
                timestamp: Date.now(),
                authorId: 'user',
                // ã€é‡è¦ã€‘åœ¨é€™è£¡å°±æŠŠè¨±å¯æ¬Šè³‡è¨Šå­˜å¥½
                visibleGroupIds: visibleGroupIds,
            };
        
            // --- 2. æ ¹æ“šæ¨¡å¼æ§‹å»ºä¸åŒçš„ post ç‰©ä»¶ ---
            if (mode === 'shuoshuo') {
                const content = document.getElementById('post-public-text').value.trim();
                if (!content) {
                    alert('èªªèªªå…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼');
                    return;
                }
                newPost = {
                    ...basePostData,
                    type: 'shuoshuo',
                    content: content,
                };
        
            } else { // è™•ç† 'complex' æ¨¡å¼ (åœ–ç‰‡/æ–‡å­—åœ–)
                const publicText = document.getElementById('post-public-text').value.trim();
                const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
        
                if (isImageModeActive) {
                    const imageUrl = document.getElementById('post-image-preview').src;
                    const imageDescription = document.getElementById('post-image-description').value.trim();
                    if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                        alert('è«‹å…ˆæ·»åŠ ä¸€å¼µåœ–ç‰‡å†ç™¼ä½ˆå‹•æ…‹å“¦ï¼');
                        return;
                    }
                    if (!imageDescription) {
                        alert('è«‹ç‚ºä½ çš„åœ–ç‰‡æ·»åŠ ä¸€å€‹ç°¡å–®çš„æè¿°ï¼ˆå¿…å¡«ï¼Œçµ¦AIçœ‹çš„ï¼‰ï¼');
                        return;
                    }
                    newPost = {
                        ...basePostData,
                        type: 'image_post',
                        publicText: publicText,
                        imageUrl: imageUrl,
                        imageDescription: imageDescription,
                    };
                } else { // æ–‡å­—åœ–æ¨¡å¼
                    const hiddenText = document.getElementById('post-hidden-text').value.trim();
                    if (!hiddenText) {
                        alert('è«‹è¼¸å…¥æ–‡å­—åœ–æè¿°ï¼');
                        return;
                    }
                    newPost = {
                        ...basePostData,
                        type: 'text_image',
                        publicText: publicText,
                        hiddenContent: hiddenText,
                    };
                }
            }
        
            // --- 3. ä¿å­˜åˆ°è³‡æ–™åº« ---
            const newPostId = await db.qzonePosts.add(newPost);
            let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ï¼ˆç„¡æ–‡å­—å…§å®¹ï¼‰";
            postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');
        
            // --- 4. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¸¶æœ‰è¨±å¯æ¬Šæª¢æŸ¥çš„é€šçŸ¥è¿´åœˆ ---
            for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (chat.isGroup) continue; // è·³éç¾¤èŠ
        
                let shouldNotify = false;
                const postVisibleGroups = newPost.visibleGroupIds;
        
                // åˆ¤æ–·æ¢ä»¶1ï¼šå¦‚æœå‹•æ…‹æ˜¯å…¬é–‹çš„ (æ²’æœ‰è¨­ç½®ä»»ä½•å¯è¦‹åˆ†çµ„)
                if (!postVisibleGroups || postVisibleGroups.length === 0) {
                    shouldNotify = true;
                } 
                // åˆ¤æ–·æ¢ä»¶2ï¼šå¦‚æœå‹•æ…‹è¨­ç½®äº†éƒ¨åˆ†å¯è¦‹ï¼Œä¸¦ä¸”ç•¶å‰è§’è‰²åœ¨å¯è¦‹åˆ†çµ„å…§
                else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
                    shouldNotify = true;
                }
        
                // åªæœ‰æ»¿è¶³æ¢ä»¶çš„è§’è‰²æ‰æœƒè¢«é€šçŸ¥
                if (shouldNotify) {
        // â–¼â–¼â–¼ å¾é€™è£¡é–‹å§‹æ›¿æ› â–¼â–¼â–¼
        const historyMessage = {
            role: 'system',
            content: `[ç³»çµ±æç¤ºï¼šä½¿ç”¨è€…å‰›å‰›ç™¼ä½ˆäº†ä¸€æ¢å‹•æ…‹(ID: ${newPostId})ï¼Œå…§å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚è«‹ä½ ã€çµåˆè‡ªå·±çš„è§’è‰²è¨­å®šã€ä¸–ç•Œè§€å’Œä½ å€‘çš„æœ€è¿‘èŠå¤©å…§å®¹ã€‘ï¼Œå°é€™æ¢å‹•æ…‹ç™¼è¡¨ä¸€æ¢è‡ªç„¶çš„è©•è«–ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        // â–²â–²â–² åˆ°é€™è£¡æ›¿æ›çµæŸ â–²â–²â–²
                    chat.history.push(historyMessage);
                    await db.chats.put(chat);
                }
            }
            // --- ä¿®æ­£çµæŸ ---
        
            await renderQzonePosts();
            modal.classList.remove('visible');
            alert('å‹•æ…‹ç™¼ä½ˆæˆåŠŸï¼');
        });
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™ã€ä¸€æ•´å¡Šã€‘åŒ…å«æ‰€æœ‰æ»‘å‹•å’Œé»æ“Šäº‹ä»¶çš„å®Œæ•´ä»£ç¢¼ï¼Œæ›¿æ›æ‰èˆŠçš„ postsList äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        
        const postsList = document.getElementById('qzone-posts-list');
        let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };
        
        function resetAllSwipes(exceptThisOne = null) {
            document.querySelectorAll('.qzone-post-container').forEach(container => {
                if (container !== exceptThisOne) {
                    container.querySelector('.qzone-post-item').classList.remove('swiped');
                }
            });
        }
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©æ–¹æ¡ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„ã€ä½¿ç”¨å¢é‡æ›´æ–°çš„å‡½æ•¸ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ handlePostClick â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘è™•ç†å‹•æ…‹å€åŸŸå…§æ‰€æœ‰é»æ“Šäº‹ä»¶çš„çµ±ä¸€å…¥å£
         */
        async function handlePostClick(e) {
            e.stopPropagation();
            const target = e.target;
        
            // --- å„ªå…ˆè™•ç†è©•è«–åˆªé™¤æŒ‰éˆ•çš„é»æ“Š ---
const deleteBtn = target.closest('.comment-delete-btn');
if (deleteBtn) {
    const postContainer = deleteBtn.closest('.qzone-post-container');
    const postId = parseInt(postContainer.dataset.postId);
    const commentIndex = parseInt(deleteBtn.dataset.commentIndex);
    if (isNaN(postId) || isNaN(commentIndex)) return;

    const post = qzonePostsCache.find(p => p.id === postId);
    if (!post || !post.comments || !post.comments[commentIndex]) return;
    
    // ã€ã€ã€æ ¸å¿ƒæ–°å¢ä»£ç¢¼ï¼šç¬¬1æ­¥ã€‘ã€‘ã€‘
    // åœ¨åˆªé™¤å‰ï¼Œå…ˆå°‡é€™æ¢è¦è¢«åˆªé™¤çš„è©•è«–çš„å®Œæ•´è³‡è¨Šä¿å­˜ä¸‹ä¾†
    const deletedComment = post.comments[commentIndex];
    
    const confirmed = await showCustomConfirm('åˆªé™¤è©•è«–', 'ç¢ºå®šè¦åˆªé™¤é€™æ¢è©•è«–å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // å¾å‹•æ…‹çš„è©•è«–æ¸…å–®ä¸­ç§»é™¤
        post.comments.splice(commentIndex, 1);
        await db.qzonePosts.update(postId, { comments: post.comments });
        
        // ã€ã€ã€æ ¸å¿ƒæ–°å¢ä»£ç¢¼ï¼šç¬¬2æ­¥ã€‘ã€‘ã€‘
        // ç¾åœ¨ï¼Œæˆ‘å€‘é–‹å§‹æ¸…ç†AIçš„è¨˜æ†¶
        // åªæœ‰ç•¶åˆªé™¤çš„æ˜¯ç”¨æˆ¶è‡ªå·±çš„è©•è«–æ™‚ï¼Œæ‰éœ€è¦å»æ¸…ç†AIçš„è¨˜æ†¶
        if (deletedComment && deletedComment.commenterName === state.qzoneSettings.nickname) {
            console.log("ç”¨æˆ¶åˆªé™¤äº†è‡ªå·±çš„è©•è«–ï¼Œé–‹å§‹æ¸…ç†AIè¨˜æ†¶...");

            // a. æ‰¾åˆ°æ‰€æœ‰å¯èƒ½æ”¶åˆ°é€šçŸ¥çš„AIï¼ˆå¸–å­ä½œè€…å’Œè¢«å›å¾©è€…ï¼‰
            const aiToNotifyIds = new Set();
            if (post.authorId !== 'user') {
                aiToNotifyIds.add(post.authorId);
            }
            if (deletedComment.replyTo) {
                const repliedToChat = Object.values(state.chats).find(c => c.originalName === deletedComment.replyTo);
                if (repliedToChat) {
                    aiToNotifyIds.add(repliedToChat.id);
                }
            }

            // b. é‡æ–°æ§‹å»ºå‡ºç•¶æ™‚ç™¼é€çµ¦AIçš„é‚£æ¢ç³»çµ±é€šçŸ¥çš„ã€ç²¾ç¢ºå…§å®¹ã€‘
            const postSummary = (post.publicText || post.content || '').substring(0, 30);
            const userNickname = state.qzoneSettings.nickname;
            let notificationText;
            const stickerMatch = state.userStickers.find(s => s.url === deletedComment.text);

            if (stickerMatch) {
                 notificationText = `ç”¨æˆ¶'${userNickname}'å‰›å‰›åœ¨ä½ çš„å‹•æ…‹â€œ${postSummary}â€ä¸‹ï¼Œç™¼é€äº†ä¸€å€‹è¡¨æƒ…è©•è«–ï¼Œæ„æ€æ˜¯ï¼šâ€œ${stickerMatch.name}â€ã€‚`;
            } else if (deletedComment.replyTo) {
                 const repliedToDisplayName = getDisplayNameByOriginalName(deletedComment.replyTo);
                 notificationText = `ç”¨æˆ¶'${userNickname}'å‰›å‰›åœ¨ä½ çš„å‹•æ…‹â€œ${postSummary}â€ä¸‹ï¼Œå›å¾©äº†'${repliedToDisplayName}'çš„è©•è«–ï¼Œå…§å®¹æ˜¯ï¼šâ€œ${deletedComment.text}â€ã€‚`;
            } else {
                 notificationText = `ç”¨æˆ¶'${userNickname}'å‰›å‰›è©•è«–äº†ä½ çš„å‹•æ…‹â€œ${postSummary}â€ï¼Œå…§å®¹æ˜¯ï¼šâ€œ${deletedComment.text}â€ã€‚`;
            }
            const fullSystemContent = `[ç³»çµ±æç¤ºï¼š${notificationText}è«‹ä½ å°æ­¤ä½œå‡ºå›æ‡‰ã€‚]`;

            // c. éæ­·æ‰€æœ‰ç›¸é—œçš„AIï¼Œå¾ä»–å€‘çš„æ­·å²è¨˜éŒ„ä¸­ç§»é™¤é€™æ¢é€šçŸ¥
            for (const aiId of aiToNotifyIds) {
                const chat = state.chats[aiId];
                if (chat) {
                    const originalLength = chat.history.length;
                    // ä½¿ç”¨ filter æ–¹æ³•ï¼Œä¿ç•™æ‰€æœ‰èˆ‡é‚£æ¢ç³»çµ±é€šçŸ¥ã€å…§å®¹ä¸ç¬¦ã€‘çš„æ¶ˆæ¯
                    chat.history = chat.history.filter(msg => 
                        !(msg.isHidden && msg.role === 'system' && msg.content === fullSystemContent)
                    );
                    // å¦‚æœæ­·å²è¨˜éŒ„çš„é•·åº¦è®ŠçŸ­äº†ï¼Œèªªæ˜æˆ‘å€‘æˆåŠŸåˆªé™¤äº†ï¼Œå°±æŠŠæ›´æ–°å¾Œçš„è³‡æ–™å­˜å›è³‡æ–™åº«
                    if (chat.history.length < originalLength) {
                        console.log(`åœ¨è§’è‰² "${chat.name}" çš„è¨˜æ†¶ä¸­æ¸…é™¤äº†1æ¢é—œæ–¼å·²åˆªé™¤è©•è«–çš„é€šçŸ¥ã€‚`);
                        await db.chats.put(chat);
                    }
                }
            }
        }
        // ã€ã€ã€æ–°å¢ä»£ç¢¼çµæŸã€‘ã€‘ã€‘

        await updateSinglePostInDOM(postId); // åˆ·æ–°å‹•æ…‹UI
    }
    
    return; // è™•ç†å®Œå¾Œå¿…é ˆé€€å‡º
}
            
            // --- æ‰€æœ‰å½ˆçª—å’ŒéDOMæ›´æ–°çš„é‚è¼¯ä¿æŒä¸è®Š ---
            const stickerBtn = target.closest('.comment-sticker-btn');
            if (stickerBtn) {
                const postContainer = stickerBtn.closest('.qzone-post-container');
                if (!postContainer) return;
                const postId = parseInt(postContainer.dataset.postId);
                if (qzoneStickerPanelState.isOpen && qzoneStickerPanelState.activePostId === postId) {
                    closeQzoneStickerPanel();
                } else {
                    openQzoneStickerPanel(postId, stickerBtn);
                }
                return; 
            }
            const commentItem = target.closest('.comment-item');
            if (commentItem) {
                const postId = parseInt(commentItem.dataset.postId);
                const commenterOriginalName = commentItem.dataset.commenterOriginalName;
                const commenterDisplayName = commentItem.dataset.commenterDisplayName;
        
                if (!commenterOriginalName || !commenterDisplayName || commenterOriginalName === state.qzoneSettings.nickname) {
                    clearQzoneReplyContext(commentItem.closest('.qzone-post-container'));
                    return;
                }
                currentQzoneReplyContext = { postId, replyToName: commenterOriginalName, replyToDisplayName: commenterDisplayName };
                const postContainer = commentItem.closest('.qzone-post-container');
                const commentInput = postContainer.querySelector('.comment-input');
                commentInput.placeholder = `å›å¾© ${commenterDisplayName}:`;
                commentInput.focus();
                return; 
            }
            if (target.classList.contains('post-actions-btn')) {
                const container = target.closest('.qzone-post-container');
                if (container && container.dataset.postId) showPostActions(parseInt(container.dataset.postId));
                return;
            }
            if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                showCustomAlert("åœ–ç‰‡å…§å®¹", target.dataset.hiddenText.replace(/<br>/g, '\n'));
                return;
            }
        
            // --- ã€æ ¸å¿ƒæ€§èƒ½å„ªåŒ–ã€‘é–‹å§‹ï¼Œè™•ç†æ‰€æœ‰æœƒæ›´æ–°DOMçš„äº‹ä»¶ ---
            const postContainer = target.closest('.qzone-post-container');
            if (!postContainer) return;
            const postId = parseInt(postContainer.dataset.postId);
            if (isNaN(postId)) return;
        
            if (target.closest('.qzone-post-delete-action')) {
                const confirmed = await showCustomConfirm('åˆªé™¤å‹•æ…‹', 'ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢å‹•æ…‹å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    postContainer.style.transition = 'all 0.3s ease';
                    postContainer.style.transform = 'scale(0.8)';
                    postContainer.style.opacity = '0';
                    setTimeout(async () => {
                         await db.qzonePosts.delete(postId);
                         const notificationIdentifier = `(ID: ${postId})`;
                         for (const chatId in state.chats) {
                             const chat = state.chats[chatId];
                             const originalHistoryLength = chat.history.length;
                             chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                             if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
                         }
                         await renderQzonePosts(); // åˆªé™¤éœ€è¦å…¨é‡é‡ç¹ª
                         alert('å‹•æ…‹å·²åˆªé™¤ã€‚');
                    }, 300);
                }
                return;
            }
        
            const icon = target.closest('.action-icon');
            if (icon) {
                if (icon.classList.contains('repost')) { openRepostModal(postId); return; }
                if (icon.classList.contains('like')) {
                    const post = qzonePostsCache.find(p => p.id === postId);
                    if (!post) return;
                    if (!post.likes) post.likes = [];
                    const userOriginalName = state.qzoneSettings.nickname;
                    const userLikeIndex = post.likes.indexOf(userOriginalName);
                    if (userLikeIndex > -1) {
                        post.likes.splice(userLikeIndex, 1);
                    } else {
                        post.likes.push(userOriginalName);
                        icon.classList.add('animate-like');
                        icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
                    }
                    await db.qzonePosts.update(postId, { likes: post.likes });
                    await updateSinglePostInDOM(postId); // ã€æ€§èƒ½å„ªåŒ–ã€‘èª¿ç”¨å¢é‡æ›´æ–°
                }
                if (icon.classList.contains('favorite')) {
                    const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
                    if (existingFavorite) {
                        await db.favorites.delete(existingFavorite.id);
                        await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—');
                    } else {
                        const postToSave = await db.qzonePosts.get(postId);
                        if (postToSave) {
                            await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                            await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸï¼');
                        }
                    }
                    await updateSinglePostInDOM(postId); // ã€æ€§èƒ½å„ªåŒ–ã€‘èª¿ç”¨å¢é‡æ›´æ–°
                }
                return;
            }
        
            const sendBtn = target.closest('.comment-send-btn');
            if (sendBtn) {
                const commentInput = postContainer.querySelector('.comment-input');
                const commentText = commentInput.value.trim();
                if (!commentText) return alert('è©•è«–å…§å®¹ä¸èƒ½ç‚ºç©ºå“¦ï¼');
                
                const post = qzonePostsCache.find(p => p.id === postId);
                if (!post) return;
        
                if (!post.comments) post.comments = [];
                
                const newComment = {
                    commenterName: state.qzoneSettings.nickname,
                    text: commentText,
                    timestamp: Date.now(),
                    replyTo: (currentQzoneReplyContext && currentQzoneReplyContext.postId === postId) ? currentQzoneReplyContext.replyToName : null
                };
                
                post.comments.push(newComment);
                await db.qzonePosts.update(postId, { comments: post.comments });
                
                let postSummary = (post.publicText || post.content || '').substring(0, 30);
                const userNickname = state.qzoneSettings.nickname;
                const notifiedAiIds = new Set();
                if (post.authorId !== 'user') notifiedAiIds.add(post.authorId);
                if (newComment.replyTo && newComment.replyTo !== userNickname) {
                    const repliedToChat = Object.values(state.chats).find(c => c.originalName === newComment.replyTo);
                    if (repliedToChat) notifiedAiIds.add(repliedToChat.id);
                }
                for (const aiId of notifiedAiIds) {
                    const chat = state.chats[aiId];
                    if (chat && !chat.isGroup) {
                        const stickerMatch = state.userStickers.find(s => s.url === commentText);
                        let notificationText = stickerMatch ? `ç”¨æˆ¶'${userNickname}'å‰›å‰›åœ¨ä½ çš„å‹•æ…‹â€œ${postSummary}â€ä¸‹ï¼Œç™¼é€äº†ä¸€å€‹è¡¨æƒ…è©•è«–ï¼Œæ„æ€æ˜¯ï¼šâ€œ${stickerMatch.name}â€ã€‚`
                            : newComment.replyTo ? `ç”¨æˆ¶'${userNickname}'å‰›å‰›åœ¨ä½ çš„å‹•æ…‹â€œ${postSummary}â€ä¸‹ï¼Œå›å¾©äº†'${currentQzoneReplyContext.replyToDisplayName}'çš„è©•è«–ï¼Œå…§å®¹æ˜¯ï¼šâ€œ${commentText}â€ã€‚`
                            : `ç”¨æˆ¶'${userNickname}'å‰›å‰›è©•è«–äº†ä½ çš„å‹•æ…‹â€œ${postSummary}â€ï¼Œå…§å®¹æ˜¯ï¼šâ€œ${commentText}â€ã€‚`;
                        const historyMessage = { 
                            role: 'system', 
                            content: `[ç³»çµ±æç¤ºï¼š${notificationText}è«‹ä½ å°æ­¤ä½œå‡ºå›æ‡‰ã€‚]`, 
                            timestamp: Date.now(), 
                            isHidden: true 
                        };
                        chat.history.push(historyMessage);
                        await db.chats.put(chat);
                    }
                }
                
                commentInput.value = '';
                clearQzoneReplyContext(postContainer); 
                await updateSinglePostInDOM(postId); // ã€æ€§èƒ½å„ªåŒ–ã€‘èª¿ç”¨å¢é‡æ›´æ–°
                return;
            }
        }
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ ã€æ€§èƒ½å„ªåŒ–æ–¹æ¡ˆã€‘è«‹ç”¨é€™ä¸€æ•´å¡Šå…¨æ–°çš„ä»£ç¢¼ï¼Œæ›¿æ›æ‰€æœ‰èˆŠçš„æ»‘å‹•è™•ç†å‡½æ•¸å’Œäº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        
        // --- 1. å…¨æ–°çš„ã€æ›´æ™ºæ…§çš„æ»‘å‹•é–‹å§‹å‡½æ•¸ ---
        const handleSwipeStart = (e) => {
            const target = e.target;
            // æª¢æŸ¥é»æ“Šç›®æ¨™æ˜¯å¦æ˜¯äº¤äº’å€åŸŸï¼Œå¦‚æœæ˜¯ï¼Œå‰‡ä¸å•Ÿå‹•æ»‘å‹•
            if (target.closest('.post-footer, .post-feedback-icons, .post-actions-btn, .post-comments-container, .reposted-content-wrapper')) {
                return;
            }
            const targetContainer = e.target.closest('.qzone-post-container');
            if (!targetContainer) return;
        
            resetAllSwipes(targetContainer);
            swipeState.activeContainer = targetContainer;
            swipeState.isDragging = true;
            swipeState.isClick = true;
            swipeState.swipeDirection = null;
            swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
        
            // ã€æ ¸å¿ƒå„ªåŒ–ã€‘åªåœ¨æ»‘å‹•é–‹å§‹æ™‚ï¼Œæ‰å‹•æ…‹ç¹«çµç§»å‹•å’ŒçµæŸçš„ç›£è½å™¨
            document.addEventListener('mousemove', handleSwipeMove);
            document.addEventListener('mouseup', handleSwipeEnd);
            document.addEventListener('touchmove', handleSwipeMove, { passive: false });
            document.addEventListener('touchend', handleSwipeEnd);
        };
        
        // --- 2. æ»‘å‹•ç§»å‹•å‡½æ•¸ï¼ˆå¾®èª¿ï¼‰ ---
        const handleSwipeMove = (e) => {
            if (!swipeState.isDragging || !swipeState.activeContainer) return;
        
            const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            const diffX = currentX - swipeState.startX;
            const diffY = currentY - swipeState.startY;
            
            if (swipeState.isClick && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
                swipeState.isClick = false;
            }
        
            if (!swipeState.swipeDirection) {
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    swipeState.swipeDirection = 'horizontal';
                } else {
                    swipeState.swipeDirection = 'vertical';
                }
            }
            
            if (swipeState.swipeDirection === 'horizontal') {
                e.preventDefault(); // åªåœ¨ç¢ºå®šæ˜¯æ°´æº–æ»‘å‹•æ™‚æ‰é˜»æ­¢é»˜èªè¡Œç‚º
                swipeState.currentX = currentX;
                let translation = Math.min(0, Math.max(-90, diffX)); // é™åˆ¶æ»‘å‹•ç¯„åœ
                swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
            }
        };
        
        // --- 3. æ»‘å‹•çµæŸå‡½æ•¸ï¼ˆé‡æ§‹ï¼‰ ---
        const handleSwipeEnd = (e) => {
            // ã€æ ¸å¿ƒå„ªåŒ–ã€‘ç„¡è«–å¦‚ä½•ï¼Œéƒ½åœ¨æ»‘å‹•çµæŸå¾Œç§»é™¤ç›£è½å™¨
            document.removeEventListener('mousemove', handleSwipeMove);
            document.removeEventListener('mouseup', handleSwipeEnd);
            document.removeEventListener('touchmove', handleSwipeMove);
            document.removeEventListener('touchend', handleSwipeEnd);
        
            if (!swipeState.isDragging || !swipeState.activeContainer) return;
            
            const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
            postItem.style.transition = 'transform 0.3s ease';
        
            if (swipeState.swipeDirection === 'horizontal' && !swipeState.isClick) {
                const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
                const diffX = finalX - swipeState.startX;
                if (diffX < -40) { // æ»‘å‹•è¶…é40åœ–å…ƒå°±è§¸ç™¼
                    postItem.classList.add('swiped');
                } else {
                    postItem.classList.remove('swiped');
                }
            }
            
            postItem.style.transform = ''; // æ¢å¾©åŸä½ï¼Œè®“CSS classæ¥ç®¡
            
            // é‡ç½®ç‹€æ…‹
            swipeState.isDragging = false;
            swipeState.activeContainer = null;
            swipeState.swipeDirection = null;
            swipeState.isClick = true;
        };
        
        // --- 4. åœ¨ init() å‡½æ•¸ä¸­ç¶å®šäº‹ä»¶ ---
        // postsList.addEventListener('click', handlePostClick); // é€™è¡Œæ‚¨æ‡‰è©²å·²ç¶“æœ‰äº†
        // postsList.addEventListener('mousedown', handleSwipeStart); // ç¶å®šæ»‘é¼ æŒ‰ä¸‹
        // postsList.addEventListener('touchstart', handleSwipeStart, { passive: true }); // ç¶å®šè§¸æ‘¸é–‹å§‹
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        
        
        // ã€æœ€çµ‚ç‰ˆã€‘å‹•æ…‹æ¸…å–®äº‹ä»¶ç¶å®š
        postsList.addEventListener('click', handlePostClick);
        postsList.addEventListener('mousedown', handleSwipeStart);
        postsList.addEventListener('touchstart', handleSwipeStart, { passive: true }); // ä½¿ç”¨ passive æå‡æ»¾å‹•æ€§èƒ½
        // --- ç¶å®šæ‰€æœ‰é»æ“Šäº‹ä»¶ ---
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå‹•æ…‹æ¸…å–®æ·»åŠ â€œè¼‰å…¥æ›´å¤šâ€çš„äº‹ä»¶å§”è¨— â–¼â–¼â–¼
        postsList.addEventListener('click', (e) => {
            // æª¢æŸ¥è¢«é»æ“Šçš„æ˜¯å¦æ˜¯æˆ‘å€‘çš„â€œè¼‰å…¥æ›´å¤šâ€æŒ‰éˆ•
            if (e.target && e.target.id === 'load-more-qzone-btn') {
                loadMoreQzonePosts();
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        // ã€å…¨æ–°ã€‘ç‚ºé•·æœŸè¨˜æ†¶â€œç²¾ç…‰â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
        document.getElementById('refine-memory-btn-header').addEventListener('click', () => {
            if(state.activeChatId) {
                summarizeExistingLongTermMemory(state.activeChatId);
            }
        });
                    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘APIé è¨­åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
                    document.getElementById('api-preset-select').addEventListener('change', handlePresetSelectionChange);
                    document.getElementById('save-api-preset-btn').addEventListener('click', saveApiPreset);
                    document.getElementById('delete-api-preset-btn').addEventListener('click', deleteApiPreset);
                    // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('add-world-book-entry-btn').addEventListener('click', () => {
            const container = document.getElementById('world-book-entries-container');
            // å¦‚æœä¹‹å‰æœ‰æç¤ºèªï¼Œå…ˆæ¸…ç©º
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            const newBlock = createWorldBookEntryBlock(); // å‰µå»ºä¸€å€‹ç©ºå¡Š
            container.appendChild(newBlock);
            newBlock.querySelector('.entry-content-textarea').focus(); // è‡ªå‹•èšç„¦åˆ°æ–°å¡Šçš„å…§å®¹å€
        });
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
                    // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼ä¸‹é¢é€™å…©è¡Œ â–¼â–¼â–¼
        document.getElementById('switch-greeting-btn').addEventListener('click', handleSwitchGreeting);
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå¿ƒè²æ­·å²åˆ—è¡¨æ·»åŠ â€œè¼‰å…¥æ›´å¤šâ€çš„äº‹ä»¶å§”è¨— â–¼â–¼â–¼
        document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
            if (e.target && e.target.id === 'load-more-thoughts-btn') {
                loadMoreThoughts();
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        // åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
        
        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡äº‹ä»¶ç›£è½ç¶å®šåˆ°æ–°çš„åœ–ç¤ºæŒ‰éˆ•ä¸Š â–¼â–¼â–¼
        document.getElementById('profile-history-icon-btn').addEventListener('click', showThoughtsHistory);
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        document.getElementById('history-back-btn').addEventListener('click', hideThoughtsHistory);
        document.getElementById('character-profile-modal').addEventListener('click', (e) => {
            // å¦‚æœé»æ“Šçš„æ˜¯æ·±è‰²èƒŒæ™¯æœ¬èº«ï¼Œè€Œä¸æ˜¯å…§å®¹å€åŸŸï¼Œå°±é—œé–‰å½ˆçª—
            if (e.target.id === 'character-profile-modal') {
                e.target.classList.remove('visible');
            }
        });
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆªé™¤äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('manage-stickers-btn').addEventListener('click', toggleStickerManagementMode);
        document.getElementById('delete-selected-stickers-btn').addEventListener('click', executeBatchDeleteStickers);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
                    // ç¶å®šå‹•æ…‹é å’Œæ”¶è—é çš„è¿”å›æŒ‰éˆ•
                    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
                    document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
        
                    // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œæª¢æŸ¥ä¸¦ç¢ºä¿ä½ æœ‰é€™æ®µå®Œæ•´çš„ä»£ç¢¼ â–¼â–¼â–¼
        
                    // æ”¶è—é æœç´¢åŠŸèƒ½
                    const searchInput = document.getElementById('favorites-search-input');
                    const searchClearBtn = document.getElementById('favorites-search-clear-btn');
        
                    searchInput.addEventListener('input', () => {
                        const searchTerm = searchInput.value.trim().toLowerCase();
                        
                        // æ§åˆ¶æ¸…é™¤æŒ‰éˆ•çš„é¡¯ç¤º/éš±è—
                        searchClearBtn.style.display = searchTerm ? 'block' : 'none';
        
                        if (!searchTerm) {
                            displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰
                            return;
                        }
        
                        // ç¯©é¸é‚è¼¯
                        const filteredItems = allFavoriteItems.filter(item => {
                            let contentToSearch = '';
                            let authorToSearch = '';
        
                            if (item.type === 'qzone_post') {
                                const post = item.content;
                                contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                                if (post.authorId === 'user') {
                                    authorToSearch = state.qzoneSettings.nickname;
                                } else if (state.chats[post.authorId]) {
                                    authorToSearch = state.chats[post.authorId].name;
                                }
                            } else if (item.type === 'chat_message') {
                                const msg = item.content;
                                if (typeof msg.content === 'string') {
                                    contentToSearch = msg.content;
                                }
                                const chat = state.chats[item.chatId];
                                if (chat) {
                                   if (msg.role === 'user') {
                                        authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                                   } else {
                                        authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                                   }
                                }
                            }
                            
                            // åŒæ™‚æœç´¢å…§å®¹å’Œä½œè€…ï¼Œä¸¦ä¸”ä¸å€åˆ†å¤§å°å¯«
                            return contentToSearch.toLowerCase().includes(searchTerm) || 
                                   authorToSearch.toLowerCase().includes(searchTerm);
                        });
        
                        displayFilteredFavorites(filteredItems);
                    });
        
                    // æ¸…é™¤æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
                    searchClearBtn.addEventListener('click', () => {
                        searchInput.value = '';
                        searchClearBtn.style.display = 'none';
                        displayFilteredFavorites(allFavoriteItems);
                        searchInput.focus();
                    });
        
                    // â–²â–²â–² ä»£ç¢¼æª¢æŸ¥çµæŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
                    
                    // ç‚ºèŠå¤©ä»‹é¢çš„æ‰¹é‡æ”¶è—æŒ‰éˆ•ç¶å®šäº‹ä»¶
                                // ç‚ºèŠå¤©ä»‹é¢çš„æ‰¹é‡æ”¶è—æŒ‰éˆ•ç¶å®šäº‹ä»¶ (å·²ä¿®æ­£)
                    document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                        if (selectedMessages.size === 0) return;
                        const chat = state.chats[state.activeChatId];
                        if (!chat) return;
        
                        const favoritesToAdd = [];
                        const timestampsToFavorite = [...selectedMessages];
        
                        for (const timestamp of timestampsToFavorite) {
                            // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•é€²è¡ŒæŸ¥è©¢
                            const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                            
                            if (!existing) {
                                const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                                if (messageToSave) {
                                    favoritesToAdd.push({
                                        type: 'chat_message',
                                        content: messageToSave,
                                        chatId: state.activeChatId,
                                        timestamp: Date.now(), // é€™æ˜¯æ”¶è—æ“ä½œç™¼ç”Ÿçš„æ™‚é–“
                                        originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ™‚é–“æˆ³è¨˜åˆ°æ–°æ¬„ä½
                                    });
                                }
                            }
                        }
        
                        if (favoritesToAdd.length > 0) {
                            await db.favorites.bulkAdd(favoritesToAdd);
                            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨åŸŸæ”¶è—ç·©å­˜
                            await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¢æ¶ˆæ¯ã€‚`);
                        } else {
                            await showCustomAlert('æç¤º', 'é¸ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—éã€‚');
                        }
                        
                        exitSelectionMode();
                    });
        
                    // æ”¶è—é é¢çš„"ç·¨è¼¯"æŒ‰éˆ•äº‹ä»¶ (å·²ä¿®æ­£)
                    const favoritesEditBtn = document.getElementById('favorites-edit-btn');
                    const favoritesView = document.getElementById('favorites-view');
                    const favoritesActionBar = document.getElementById('favorites-action-bar');
                    const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // ç²å–ä¸»å·¡è¦½åˆ—
                    const favoritesList = document.getElementById('favorites-list'); // ç²å–æ”¶è—åˆ—è¡¨
                    
                    favoritesEditBtn.addEventListener('click', () => {
                        isFavoritesSelectionMode = !isFavoritesSelectionMode;
                        favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);
        
                        if (isFavoritesSelectionMode) {
                            // --- é€²å…¥ç·¨è¼¯æ¨¡å¼ ---
                            favoritesEditBtn.textContent = 'å®Œæˆ';
                            favoritesActionBar.style.display = 'block'; // é¡¯ç¤ºåˆªé™¤æ“ä½œæ¬„
                            mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢ï¼šéš±è—ä¸»å·¡è¦½åˆ—
                            favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢ï¼šçµ¦åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé–“
                        } else {
                            // --- é€€å‡ºç·¨è¼¯æ¨¡å¼ ---
                            favoritesEditBtn.textContent = 'ç·¨è¼¯';
                            favoritesActionBar.style.display = 'none'; // éš±è—åˆªé™¤æ“ä½œæ¬„
                            mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢ï¼šæ¢å¾©ä¸»å·¡è¦½åˆ—
                            favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢ï¼šæ¢å¾©åˆ—è¡¨é»˜èªpadding
        
                            // é€€å‡ºæ™‚æ¸…ç©ºæ‰€æœ‰é¸æ“‡
                            selectedFavorites.clear();
                            document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                            document.getElementById('favorites-delete-selected-btn').textContent = `åˆªé™¤ (0)`;
                        }
                    });
        
        // â–¼â–¼â–¼ å°‡å®ƒã€å®Œæ•´æ›¿æ›ã€‘ç‚ºä¸‹é¢é€™æ®µä¿®æ­£å¾Œçš„ä»£ç¢¼ â–¼â–¼â–¼
        // æ”¶è—åˆ—è¡¨çš„é»æ“Šé¸æ“‡äº‹ä»¶ (äº‹ä»¶å§”è¨—)
        document.getElementById('favorites-list').addEventListener('click', (e) => {
            const target = e.target;
            const card = target.closest('.favorite-item-card');
        
            // ã€æ–°å¢ã€‘è™•ç†æ–‡å­—åœ–é»æ“Šï¼Œé€™æ®µé‚è¼¯è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è­‰ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
            if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                const hiddenText = target.dataset.hiddenText;
                showCustomAlert("åœ–ç‰‡å…§å®¹", hiddenText.replace(/<br>/g, '\n'));
                return; // è™•ç†å®Œå°±é€€å‡ºï¼Œä¸ç¹¼çºŒåŸ·è¡Œé¸æ“‡é‚è¼¯
            }
            
            // å¦‚æœä¸åœ¨é¸æ“‡æ¨¡å¼ï¼Œå‰‡ä¸åŸ·è¡Œå¾ŒçºŒçš„é¸æ“‡æ“ä½œ
            if (!isFavoritesSelectionMode) return;
        
            // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é¸æ“‡é‚è¼¯ï¼Œä¿æŒä¸è®Š ---
            if (!card) return;
        
            const favId = parseInt(card.dataset.favid);
            if (isNaN(favId)) return;
        
            // åˆ‡æ›é¸æ“‡ç‹€æ…‹
            if (selectedFavorites.has(favId)) {
                selectedFavorites.delete(favId);
                card.classList.remove('selected');
            } else {
                selectedFavorites.add(favId);
                card.classList.add('selected');
            }
            
            // æ›´æ–°åº•éƒ¨åˆªé™¤æŒ‰éˆ•çš„è¨ˆæ•¸
            document.getElementById('favorites-delete-selected-btn').textContent = `åˆªé™¤ (${selectedFavorites.size})`;
        });
        
        // â–¼â–¼â–¼ å°‡å®ƒã€å®Œæ•´æ›¿æ›ã€‘ç‚ºä¸‹é¢é€™æ®µä¿®æ­£å¾Œçš„ä»£ç¢¼ â–¼â–¼â–¼
        // æ”¶è—é é¢æ‰¹é‡åˆªé™¤æŒ‰éˆ•äº‹ä»¶
        document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
            if (selectedFavorites.size === 0) return;
        
            const confirmed = await showCustomConfirm(
                'ç¢ºèªåˆªé™¤', 
                `ç¢ºå®šè¦å¾æˆ‘çš„æœ€æ„›ä¸­ç§»é™¤é€™ ${selectedFavorites.size} æ¢å…§å®¹å—ï¼Ÿ`, 
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                const idsToDelete = [...selectedFavorites];
                await db.favorites.bulkDelete(idsToDelete);
                await showCustomAlert('åˆªé™¤æˆåŠŸ', 'é¸ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
                
                // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å¾å‰ç«¯ç·©å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆªé™¤çš„é …
                allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
                
                // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°å¾Œçš„ç·©å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
                displayFilteredFavorites(allFavoriteItems);
                
                // æœ€å¾Œï¼Œå†é€€å‡ºç·¨è¼¯æ¨¡å¼
                favoritesEditBtn.click(); // é¡æ¯”é»æ“Š"å®Œæˆ"æŒ‰éˆ•ä¾†é€€å‡ºç·¨è¼¯æ¨¡å¼
            }
        });
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
        if (state.globalSettings.enableBackgroundActivity) {
            startBackgroundSimulation();
            console.log("å¾Œè‡ºæ´»å‹•æ¨¡æ“¬å·²è‡ªå‹•å•Ÿå‹•ã€‚");
        }
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚çš„æ­£ç¢ºä»£ç¢¼ã€‘è«‹é»è²¼é€™æ®µä»£ç¢¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
        
        // --- çµ±ä¸€è™•ç†æ‰€æœ‰å½±éŸ¿é è¦½çš„æ§åˆ¶é …çš„äº‹ä»¶ ---
        
        // 1. ç›£è½ä¸»é¡Œé¸æ“‡
        document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
            radio.addEventListener('change', updateSettingsPreview);
        });
        
        // 2. ç›£è½å­—é«”å¤§å°æ»‘å¡Š
        const fontSizeSlider = document.getElementById('font-size-slider');
        fontSizeSlider.addEventListener('input', () => {
            // a. å³æ™‚æ›´æ–°æ•¸å€¼é¡¯ç¤º
            document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            // b. æ›´æ–°é è¦½
            updateSettingsPreview();
        });
        
        // 3. ç›£è½è‡ªè¨‚CSSè¼¸å…¥æ¡†
        const customCssInputForPreview = document.getElementById('custom-css-input');
        customCssInputForPreview.addEventListener('input', updateSettingsPreview);
        
        // 4. ç›£è½é‡æ–°é–‹æ©ŸæŒ‰éˆ•
        document.getElementById('reset-theme-btn').addEventListener('click', () => {
            document.getElementById('theme-default').checked = true;
            updateSettingsPreview();
        });
        
        document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
            document.getElementById('custom-css-input').value = '';
            updateSettingsPreview();
        });
        
        // â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
        // ã€è«‹ç¢ºä¿é€™æ®µä»£ç¢¼åœ¨æ‚¨çš„ init() å‡½æ•¸å…§ã€‘
        document.getElementById('lyrics-vertical-pos').addEventListener('change', updateSettingsPreview);
        document.getElementById('lyrics-horizontal-pos').addEventListener('change', updateSettingsPreview);
        document.getElementById('lyrics-offset-input').addEventListener('input', updateSettingsPreview);
        // â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°ä»£ç¢¼ã€‘é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
        document.querySelectorAll('input[name="visibility"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const groupsContainer = document.getElementById('post-visibility-groups');
                if (this.value === 'include' || this.value === 'exclude') {
                    groupsContainer.style.display = 'block';
                } else {
                    groupsContainer.style.display = 'none';
                }
            });
        });
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°ä»£ç¢¼ã€‘é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
        document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
        document.getElementById('close-group-manager-btn').addEventListener('click', () => {
            document.getElementById('group-management-modal').classList.remove('visible');
            // åˆ·æ–°èŠå¤©è¨­ç½®è£¡çš„åˆ†çµ„åˆ—è¡¨
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
               chatSettingsBtn.click(); // å†æ¬¡é»æ“Šä»¥é‡æ–°æ‰“é–‹
            }
        });
        
        document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
        document.getElementById('existing-groups-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const groupId = parseInt(e.target.dataset.id);
                deleteGroup(groupId);
            }
        });
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹å°‡é€™æ®µã€æ–°ä»£ç¢¼ã€‘é»è²¼åˆ° init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
        // æ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨çš„æŒ‰éˆ•äº‹ä»¶
        document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
        // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ä½¿ç”¨æ–°çš„ç·¨è¼¯å™¨å…¥å£ â–¼â–¼â–¼
        document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);
        
        // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ æ–°ä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™æ®µã€ä¿®æ­£å¾Œã€‘çš„ä»£ç¢¼æ›¿æ›èˆŠçš„ select-message-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('select-message-btn').addEventListener('click', () => {
            // ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é—œé–‰èœå–®å‰ï¼Œå…ˆæ•ç²æ™‚é–“æˆ³è¨˜
            const timestampToSelect = activeMessageTimestamp; 
            hideMessageActions();
            // ä½¿ç”¨æ•ç²åˆ°çš„å€¼
            if (timestampToSelect) {
                enterSelectionMode(timestampToSelect);
            }
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ  â–¼â–¼â–¼
        
        // ç›£è½èŠå¤©å€åŸŸçš„é»æ“Šï¼Œå°ˆé–€ç”¨æ–¼è™•ç†AIç™¼ä¾†çš„è½‰å¸³
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«é»æ“Šçš„å…ƒç´ æ˜¯å¦åœ¨ä¸€å€‹æ¶ˆæ¯æ°£æ³¡å…§
            const bubble = e.target.closest('.message-bubble');
            if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º
        
            // 2. æª¢æŸ¥æ˜¯å¦æ˜¯AIçš„ã€å¾…è™•ç†çš„è½‰å¸³æ¶ˆæ¯
            if (bubble.classList.contains('ai') && 
                bubble.classList.contains('is-transfer') && 
                bubble.dataset.status === 'pending') {
                
                // 3. åªæœ‰æ»¿è¶³æ‰€æœ‰æ¢ä»¶ï¼Œæ‰é¡¯ç¤ºæ“ä½œåŠŸèƒ½è¡¨
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        
        // ç¶å®šæ–°è½‰å¸³æ“ä½œæ¨¡æ…‹æ¡†çš„æŒ‰éˆ•
        document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
        document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
        document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);
        
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼
        
        // å‹•æ…‹æ“ä½œåŠŸèƒ½è¡¨çš„æŒ‰éˆ•äº‹ä»¶
        document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
        document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
        document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);
        
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘é€£çµ¡äººé¸æ“‡å™¨äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
            showScreen('chat-list-screen');
        });
        
        document.getElementById('contact-picker-list').addEventListener('click', (e) => {
            const item = e.target.closest('.contact-picker-item');
            if (!item) return;
        
            const contactId = item.dataset.contactId;
            item.classList.toggle('selected');
            
            if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
            } else {
                selectedContacts.add(contactId);
            }
            updateContactPickerConfirmButton();
        });
        
        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç¶å®šâ€œç®¡ç†ç¾¤æˆå“¡â€æŒ‰éˆ•äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('manage-members-btn').addEventListener('click', () => {
            // åœ¨åˆ‡æ›è¢å¹•å‰ï¼Œå…ˆéš±è—ç•¶å‰çš„èŠå¤©è¨­ç½®å½ˆçª—
            //document.getElementById('chat-settings-modal').classList.remove('visible');
            // ç„¶å¾Œå†æ‰“é–‹æˆå“¡ç®¡ç†è¢å¹•
            openMemberManagementScreen();
        });
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€çµ‚å®Œæ•´ç‰ˆã€‘ç¾¤æˆå“¡ç®¡ç†åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('back-from-member-management').addEventListener('click', () => {
        
            showScreen('chat-interface-screen');    
            document.getElementById('chat-settings-btn').click();
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        document.getElementById('member-management-list').addEventListener('click', (e) => {
            // ã€å·²æ¢å¾©ã€‘ç§»é™¤æˆå“¡çš„äº‹ä»¶
            if (e.target.classList.contains('remove-member-btn')) {
                removeMemberFromGroup(e.target.dataset.memberId);
            }
        });
        
        document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
            // ã€å·²æ¢å¾©ã€‘å¾å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
            // ã€é—œéµã€‘ç‚ºâ€œå®Œæˆâ€æŒ‰éˆ•ç¶å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é‚è¼¯
            const confirmBtn = document.getElementById('confirm-contact-picker-btn');
            // ä½¿ç”¨å…‹éš†ç¯€é»æ–¹æ³•æ¸…é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼Œé˜²æ­¢é‡è¤‡ç¶å®š
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
            
            await openContactPickerForAddMember();
        });
        
        document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        
        // ç¶å®šå–®èŠå’Œç¾¤èŠçš„ç™¼èµ·æŒ‰éˆ•
        document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
        document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);
        
        // ç¶å®šâ€œæ›æ–·â€æŒ‰éˆ•
        document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);
        
        // ç¶å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰éˆ•
        document.getElementById('cancel-call-btn').addEventListener('click', () => {
            videoCallState.isAwaitingResponse = false;
            showScreen('chat-interface-screen');
        });
        
        // ã€å…¨æ–°ã€‘ç¶å®šâ€œåŠ å…¥é€šè©±â€æŒ‰éˆ•
        document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);
        
        // â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©ä¸¦å•Ÿå‹•æ—è§€æ¨¡å¼ã€‘çš„ç‰ˆæœ¬æ›¿æ›èˆŠçš„ decline-call-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        // ç¶å®šä¾†é›»è«‹æ±‚çš„â€œæ‹’çµ•â€æŒ‰éˆ•
        document.getElementById('decline-call-btn').addEventListener('click', async () => {
            hideIncomingCallModal();
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°‡æ‹’çµ•çš„é‚è¼¯èˆ‡APIèª¿ç”¨é€£æ¥èµ·ä¾†
            if (videoCallState.isGroupCall) {
                videoCallState.isUserParticipating = false; // æ¨™è¨˜ä½¿ç”¨è€…ç‚ºæ—è§€è€…
                
                // 1. å‰µå»ºä¸€æ¢éš±è—æ¶ˆæ¯ï¼Œé€šçŸ¥AIä½¿ç”¨è€…æ‹’çµ•äº†
                const systemNote = {
                    role: 'system',
                    content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶æ‹’çµ•äº†é€šè©±é‚€è«‹ï¼Œä½†ä½ å€‘å¯ä»¥è‡ªå·±é–‹å§‹ã€‚è«‹ä½ å€‘å„è‡ªæ±ºç­–æ˜¯å¦åŠ å…¥ã€‚]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(systemNote);
                await db.chats.put(chat);
                
                // 2. ã€é—œéµã€‘è§¸ç™¼AIå›æ‡‰ï¼Œè®“å®ƒå€‘è‡ªå·±æ±ºå®šè¦ä¸è¦é–‹å§‹ç¾¤èŠ
                // é€™å°‡æœƒåœ¨å¹•å¾Œè™•ç†ï¼Œå¦‚æœAIå€‘æ±ºå®šé–‹å§‹ï¼Œæœ€çµ‚æœƒèª¿ç”¨ startVideoCall()
                await triggerAiResponse(); 
                
            } else { // å–®èŠæ‹’çµ•é‚è¼¯ä¿æŒä¸è®Š
                const declineMessage = { role: 'user', content: 'æˆ‘æ‹’çµ•äº†ä½ çš„è¦–é »é€šè©±è«‹æ±‚ã€‚', timestamp: Date.now() };
                chat.history.push(declineMessage);
                await db.chats.put(chat);
                
                // å›åˆ°èŠå¤©ä»‹é¢ä¸¦é¡¯ç¤ºæ‹’çµ•æ¶ˆæ¯
                showScreen('chat-interface-screen');
                appendMessage(declineMessage, chat);
                
                // è®“AIå°ä½ çš„æ‹’çµ•åšå‡ºå›æ‡‰
                triggerAiResponse();
            }
            
            // æ¸…ç†ç‹€æ…‹ï¼Œä»¥é˜²è¬ä¸€
            videoCallState.isAwaitingResponse = false;
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ç”¨é€™å€‹ã€å·²ä¿®å¾©é‡è¤‡é ­åƒBUGã€‘çš„ç‰ˆæœ¬æ›¿æ›èˆŠçš„ accept-call-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        // ç¶å®šä¾†é›»è«‹æ±‚çš„â€œæ¥è½â€æŒ‰éˆ•
        document.getElementById('accept-call-btn').addEventListener('click', async () => {
            hideIncomingCallModal();
            
            videoCallState.initiator = 'ai';
            videoCallState.isUserParticipating = true;
            videoCallState.activeChatId = state.activeChatId;
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘æˆ‘å€‘åœ¨é€™è£¡ä¸å†æ‰‹å‹•æ·»åŠ ç”¨æˆ¶åˆ° participants åˆ—è¡¨
            if (videoCallState.isGroupCall) {
                // å°æ–¼ç¾¤èŠï¼Œæˆ‘å€‘åªæŠŠã€ç™¼èµ·é€šè©±çš„AIã€‘åŠ å…¥åƒèˆ‡è€…åˆ—è¡¨
                const chat = state.chats[videoCallState.activeChatId];
                const requester = chat.members.find(m => m.name === videoCallState.callRequester);
                if (requester) {
                    // æ¸…ç©ºå¯èƒ½å­˜åœ¨çš„èˆŠè³‡æ–™ï¼Œç„¶å¾Œåªæ·»åŠ ç™¼èµ·è€…
                    videoCallState.participants = [requester];
                } else {
                    videoCallState.participants = []; // å¦‚æœæ‰¾ä¸åˆ°ç™¼èµ·è€…ï¼Œå°±æ¸…ç©º
                }
            }
            
            // ç„¡è«–å–®èŠé‚„æ˜¯ç¾¤èŠï¼Œç›´æ¥å•Ÿå‹•é€šè©±ä»‹é¢ï¼
            startVideoCall();
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²å¢åŠ ç”¨æˆ¶é«˜äº®ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ user-speak-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        // ç¶å®šä½¿ç”¨è€…åœ¨é€šè©±ä¸­ç™¼è¨€çš„æŒ‰éˆ•
        document.getElementById('user-speak-btn').addEventListener('click', async () => {
            if (!videoCallState.isActive) return;
        
            // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨å½ˆå‡ºè¼¸å…¥æ¡†å‰ï¼Œå…ˆæ‰¾åˆ°ä¸¦é«˜äº®ç”¨æˆ¶é ­åƒ â˜…â˜…â˜…â˜…â˜…
            const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
            if (userAvatar) {
                userAvatar.classList.add('speaking');
            }
        
            const userInput = await showCustomPrompt('ä½ èªª', 'è«‹è¼¸å…¥ä½ æƒ³èªªçš„è©±...');
            
            // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šç„¡è«–ç”¨æˆ¶æ˜¯å¦è¼¸å…¥ï¼Œåªè¦é—œé–‰è¼¸å…¥æ¡†å°±ç§»é™¤é«˜äº® â˜…â˜…â˜…â˜…â˜…
            if (userAvatar) {
                userAvatar.classList.remove('speaking');
            }
        
            if (userInput && userInput.trim()) {
                triggerAiInCallAction(userInput.trim());
            }
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å›æ†¶éŒ„ç›¸é—œäº‹ä»¶ç¶å®š â–¼â–¼â–¼
        // 1. å°‡â€œå›æ†¶â€é ç°½å’Œå®ƒçš„è¦–åœ–é€£æ¥èµ·ä¾†
        document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
            // åœ¨åˆ‡æ›å‰ï¼Œç¢ºä¿"æ”¶è—"é é¢çš„ç·¨è¼¯æ¨¡å¼å·²é—œé–‰
            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }
            switchToChatListView('memories-view');
            renderMemoriesScreen(); // é»æ“Šæ™‚æ¸²æŸ“
        });
        
        // 2. ç¶å®šå›æ†¶éŒ„ä»‹é¢çš„è¿”å›æŒ‰éˆ•
        document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
        
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ‰¾åˆ°é€™å€‹æŒ‰éˆ•çš„ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
            const title = document.getElementById('countdown-title-input').value.trim();
            const dateValue = document.getElementById('countdown-date-input').value;
            
            if (!title || !dateValue) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„ç´„å®šæ¨™é¡Œå’Œæ—¥æœŸï¼');
                return;
            }
        
            const targetDate = new Date(dateValue);
            if (isNaN(targetDate) || targetDate <= new Date()) {
                alert('è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„ã€æœªä¾†çš„æ—¥æœŸï¼');
                return;
            }
        
            // â–¼â–¼â–¼ å°‡å…¶ã€æ›¿æ›ç‚ºã€‘ä¸‹é¢é€™æ®µã€æ–°ä»£ç¢¼ã€‘â–¼â–¼â–¼
            const newCountdown = {
                authorId: 'user', // ã€æ ¸å¿ƒä¿®å¾©2ã€‘ä¸å†å­˜ authorNameï¼Œè€Œæ˜¯ç”¨ 'user' ä½œç‚ºæ‚¨çš„å°ˆå±¬ID
                description: title,
                timestamp: Date.now(),
                type: 'countdown',
                targetDate: targetDate.getTime()
            };
            // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
            
            await db.memories.add(newCountdown);
            document.getElementById('create-countdown-modal').classList.remove('visible');
            renderMemoriesScreen();
        });
        
        // ã€å…¨æ–°ã€‘æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç¶å®š
        document.getElementById('block-chat-btn').addEventListener('click', async () => {
            if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
        
            const chat = state.chats[state.activeChatId];
            const confirmed = await showCustomConfirm(
                'ç¢ºèªæ‹‰é»‘', 
                `ç¢ºå®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘å¾Œæ‚¨å°‡ç„¡æ³•å‘å…¶ç™¼é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°‡Taç§»å‡ºé»‘åå–®ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è«‹å¥½å‹ã€‚`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now();
        
                // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
                const hiddenMessage = {
                    role: 'system',
                    content: `[ç³»çµ±æç¤ºï¼šä½ å‰›å‰›è¢«ç”¨æˆ¶æ‹‰é»‘äº†ã€‚åœ¨å°æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ ç„¡æ³•å†ä¸»å‹•ç™¼èµ·å°è©±ï¼Œä¹Ÿç„¡æ³•å›æ‡‰ã€‚]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
                // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        
                await db.chats.put(chat);
                
                // é—œé–‰è¨­ç½®å½ˆçª—ï¼Œä¸¦åˆ·æ–°èŠå¤©ä»‹é¢
                document.getElementById('chat-settings-modal').classList.remove('visible');
                renderChatInterface(state.activeChatId);
                // åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œå¯èƒ½æœƒæœ‰UIè®ŠåŒ–
                renderChatList();
            }
        });
        
        document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            if (e.target.id === 'force-apply-check-btn') {
                alert("æ­£åœ¨æ‰‹å‹•è§¸ç™¼å¥½å‹ç”³è«‹æµç¨‹ï¼Œè«‹ç¨å¾Œ...\nå¦‚æœAPIèª¿ç”¨æˆåŠŸï¼Œå°‡å½ˆå‡ºæç¤ºã€‚å¦‚æœå¤±æ•—ï¼Œä¹Ÿæœƒæœ‰éŒ¯èª¤æç¤ºã€‚å¦‚æœé•·æ™‚é–“ç„¡åæ‡‰ï¼Œèªªæ˜AIå¯èƒ½æ±ºå®šæš«æ™‚ä¸ç”³è«‹ã€‚");
                await triggerAiFriendApplication(chat.id);
                renderChatInterface(chat.id); 
                return;
            }
        
            if (e.target.id === 'unblock-btn') {
                chat.relationship.status = 'friend';
                chat.relationship.blockedTimestamp = null;
        
                // â–¼â–¼â–¼ åœ¨é€™è£¡æ·»åŠ ä¸‹é¢çš„ä»£ç¢¼ â–¼â–¼â–¼
                const hiddenMessage = {
                    role: 'system',
                    content: `[ç³»çµ±æç¤ºï¼šç”¨æˆ¶å‰›å‰›è§£é™¤äº†å°ä½ çš„æ‹‰é»‘ã€‚ç¾åœ¨ä½ å€‘å¯ä»¥é‡æ–°é–‹å§‹å°è©±äº†ã€‚]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
                // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²
        
                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                triggerAiResponse(); // ã€å¯é¸ä½†æ¨è–¦ã€‘è§£é™¤å¾Œè®“AIä¸»å‹•èªªé»ä»€éº¼
            }
        else if (e.target.id === 'accept-friend-btn') {
                // 1. æ ¸å¿ƒä¿®æ­£ï¼šä¸å†è§¸ç™¼AIéŸ¿æ‡‰ï¼Œé¿å…é‚è¼¯æ··äº‚
                // triggerAiResponse(); // <-- åˆªé™¤æˆ–æ³¨é‡‹æ‰é€™ä¸€è¡Œ
        
                // 2. ç›´æ¥æ›´æ–°é—œä¿‚ç‹€æ…‹
                chat.relationship.status = 'friend';
                chat.relationship.applicationReason = '';
        
                // 3. æ–°å¢ï¼šç›´æ¥åœ¨å‰ç«¯ç”Ÿæˆä¸€æ¢å°ä½¿ç”¨è€…å¯è¦‹çš„ç³»çµ±æ¶ˆæ¯ï¼Œå‘ŠçŸ¥æ“ä½œæˆåŠŸ
                const systemMessage = {
                    role: 'system',
                    type: 'pat_message', // è¤‡ç”¨å±…ä¸­æ¨£å¼
                    content: `ä½ é€šéäº†â€œ${chat.name}â€çš„å¥½å‹è«‹æ±‚`,
                    timestamp: Date.now()
                };
                chat.history.push(systemMessage);
        
                // 4. æ–°å¢ï¼šé¡æ¯”AIç™¼ä¾†ä¸€æ¢è‡ªç„¶çš„æ­¡è¿æ¶ˆæ¯ï¼Œè®“äº¤äº’æ›´æµæš¢
                const welcomeMessage = {
                    role: 'assistant',
                    senderName: chat.name,
                    content: 'å¤ªå¥½äº†ï¼æˆ‘å€‘åˆå¯ä»¥èŠå¤©å•¦ï¼',
                    timestamp: Date.now() + 1 // æ™‚é–“æˆ³è¨˜+1ç¢ºä¿åœ¨ç³»çµ±æ¶ˆæ¯ä¹‹å¾Œ
                };
                chat.history.push(welcomeMessage);
        
                // 5. ä¸€æ¬¡æ€§å°‡æ‰€æœ‰æ›´æ”¹ä¿å­˜åˆ°è³‡æ–™åº«
                await db.chats.put(chat);
        
                // 6. åˆ·æ–°UIï¼Œé¡¯ç¤ºæœ€æ–°çš„ç‹€æ…‹å’Œæ¶ˆæ¯
                renderChatInterface(chat.id);
                renderChatList();
            }
            else if (e.target.id === 'reject-friend-btn') {
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now();
                chat.relationship.applicationReason = '';
                await db.chats.put(chat);
                renderChatInterface(chat.id);
            }
            // ã€æ–°å¢ã€‘è™•ç†ç”³è«‹å¥½å‹æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            else if (e.target.id === 'apply-friend-btn') {
                const reason = await showCustomPrompt(
                    'ç™¼é€å¥½å‹ç”³è«‹', 
                    `è«‹è¼¸å…¥ä½ æƒ³å°â€œ${chat.name}â€èªªçš„ç”³è«‹ç†ç”±ï¼š`,
                    "æˆ‘å€‘å’Œå¥½å§ï¼"
                );
                // åªæœ‰ç•¶ä½¿ç”¨è€…è¼¸å…¥äº†å…§å®¹ä¸¦é»æ“Šâ€œç¢ºå®šâ€å¾Œæ‰ç¹¼çºŒ
                if (reason !== null) {
                    // æ›´æ–°é—œä¿‚ç‹€æ…‹ç‚ºâ€œç­‰å¾…AIæ‰¹å‡†â€
                    chat.relationship.status = 'pending_ai_approval';
                    chat.relationship.applicationReason = reason;
                    await db.chats.put(chat);
        
                    // åˆ·æ–°UIï¼Œé¡¯ç¤ºâ€œç­‰å¾…é€šéâ€çš„ä»‹é¢
                    renderChatInterface(chat.id);
                    renderChatList();
                    
                    // ã€é—œéµã€‘è§¸ç™¼AIå›æ‡‰ï¼Œè®“å®ƒå»è™•ç†é€™å€‹å¥½å‹ç”³è«‹
                    triggerAiResponse();
                }
            }
        });
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç´…åŒ…åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        
        // 1. å°‡åŸæœ‰çš„è½‰å¸³æŒ‰éˆ•(ï¿¥)çš„é»æ“Šäº‹ä»¶ï¼Œé‡å®šå‘åˆ°æ–°çš„ç¸½å…¥å£å‡½æ•¸
        document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);
        
        // 2. ç´…åŒ…æ¨¡æ…‹æ¡†å…§éƒ¨çš„æ§åˆ¶æŒ‰éˆ•
        document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
            document.getElementById('red-packet-modal').classList.remove('visible');
        });
        document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
        document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);
        
        // 3. ç´…åŒ…æ¨¡æ…‹æ¡†çš„é ç°½åˆ‡æ›é‚è¼¯
        const rpTabGroup = document.getElementById('rp-tab-group');
        const rpTabDirect = document.getElementById('rp-tab-direct');
        const rpContentGroup = document.getElementById('rp-content-group');
        const rpContentDirect = document.getElementById('rp-content-direct');
        
        rpTabGroup.addEventListener('click', () => {
            rpTabGroup.classList.add('active');
            rpTabDirect.classList.remove('active');
            rpContentGroup.style.display = 'block';
            rpContentDirect.style.display = 'none';
        });
        rpTabDirect.addEventListener('click', () => {
            rpTabDirect.classList.add('active');
            rpTabGroup.classList.remove('active');
            rpContentDirect.style.display = 'block';
            rpContentGroup.style.display = 'none';
        });
        
        // 4. å³æ™‚æ›´æ–°ç´…åŒ…é‡‘é¡é¡¯ç¤º
        document.getElementById('rp-group-amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
        });
        document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
        });
        
        // â–²â–²â–² æ–°äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†ç´…åŒ…é»æ“Šï¼Œä¿®å¾©å¤±æ•ˆå•é¡Œ â–¼â–¼â–¼
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. æ‰¾åˆ°è¢«é»æ“Šçš„ç´…åŒ…å¡ç‰‡
            const packetCard = e.target.closest('.red-packet-card');
            if (!packetCard) return; // å¦‚æœé»æ“Šçš„ä¸æ˜¯ç´…åŒ…ï¼Œå°±ä»€éº¼ä¹Ÿä¸åš
        
            // 2. å¾ç´…åŒ…å¡ç‰‡çš„çˆ¶ç´š.message-bubbleç²å–æ™‚é–“æˆ³è¨˜
            const messageBubble = packetCard.closest('.message-bubble');
            if (!messageBubble || !messageBubble.dataset.timestamp) return;
        
            // 3. èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„è™•ç†å‡½æ•¸
            const timestamp = parseInt(messageBubble.dataset.timestamp);
            handlePacketClick(timestamp);
        });
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        // åœ¨è¼¸å…¥æ¡†å·¥å…·åˆ—æ·»åŠ æŒ‰éˆ•
        document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);
        
        // æŠ•ç¥¨å‰µå»ºæ¨¡æ…‹æ¡†çš„æŒ‰éˆ•
        document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
        document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
            document.getElementById('create-poll-modal').classList.remove('visible');
        });
        document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);
        
        // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†æŠ•ç¥¨å¡ç‰‡å…§çš„æ‰€æœ‰é»æ“Šäº‹ä»¶
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            const pollCard = e.target.closest('.poll-card');
            if (!pollCard) return;
        
            const timestamp = parseInt(pollCard.dataset.pollTimestamp);
            if (isNaN(timestamp)) return;
            
            // é»æ“Šäº†é¸é …
            const optionItem = e.target.closest('.poll-option-item');
            if (optionItem && !pollCard.classList.contains('closed')) {
                handleUserVote(timestamp, optionItem.dataset.option);
                return;
            }
            
            // é»æ“Šäº†å‹•ä½œæŒ‰éˆ•ï¼ˆçµæŸæŠ•ç¥¨/æŸ¥çœ‹çµæœï¼‰
            const actionBtn = e.target.closest('.poll-action-btn');
            if (actionBtn) {
                if (pollCard.classList.contains('closed')) {
                    showPollResults(timestamp);
                } else {
                    endPoll(timestamp);
                }
                return;
            }
        
            // å¦‚æœæ˜¯å·²çµæŸçš„æŠ•ç¥¨ï¼Œé»æ“Šå¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹çµæœ
            if (pollCard.classList.contains('closed')) {
                showPollResults(timestamp);
            }
        });
        // â–²â–²â–² æ–°äº‹ä»¶ç›£è½å™¨é»è²¼çµæŸ â–²â–²â–²
        
          // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIé ­åƒåº«åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºæ‰¹é‡å°å…¥æŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
        // ç¶å®šAIé ­åƒåº«çš„â€œæ‰¹é‡â€æŒ‰éˆ•
        document.getElementById('add-ai-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('ai'));
        
        // ç¶å®šç¾¤é ­åƒåº«çš„â€œæ‰¹é‡â€æŒ‰éˆ•
        document.getElementById('add-group-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('group'));
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ add-ai-avatar-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        // ç¶å®šâ€œURLâ€æŒ‰éˆ•ï¼Œèª¿ç”¨æˆ‘å€‘å‰›å‰›é‡å‘½åçš„å‡½æ•¸
        document.getElementById('add-ai-avatar-url-btn').addEventListener('click', addAvatarToLibraryFromURL);
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç¶å®šâ€œä¸Šå‚³â€æŒ‰éˆ•ï¼Œè§¸ç™¼éš±è—çš„æª”é¸æ“‡å™¨
        document.getElementById('add-ai-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('ai-avatar-upload-input').click();
        });
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºæª”é¸æ“‡å™¨ç¶å®š change äº‹ä»¶ï¼Œé€™æ˜¯è™•ç†ä¸Šå‚³çš„æ ¸å¿ƒå…¥å£
        document.getElementById('ai-avatar-upload-input').addEventListener('change', handleLocalAvatarUpload);
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤é ­åƒåº«åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('manage-group-avatar-library-btn').addEventListener('click', openGroupAvatarLibraryModal);
        // â–¼â–¼â–¼ ã€è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„ add-group-avatar-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        
        // ç¶å®šâ€œURLâ€æŒ‰éˆ•ï¼Œèª¿ç”¨æˆ‘å€‘å‰›å‰›é‡å‘½åçš„å‡½æ•¸
        document.getElementById('add-group-avatar-url-btn').addEventListener('click', addAvatarToGroupLibraryFromURL);
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç¶å®šâ€œä¸Šå‚³â€æŒ‰éˆ•ï¼Œè§¸ç™¼éš±è—çš„æª”é¸æ“‡å™¨
        document.getElementById('add-group-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('group-avatar-upload-input').click();
        });
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç‚ºæª”é¸æ“‡å™¨ç¶å®š change äº‹ä»¶ï¼Œé€™æ˜¯è™•ç†ä¸Šå‚³çš„æ ¸å¿ƒå…¥å£
        document.getElementById('group-avatar-upload-input').addEventListener('change', handleLocalGroupAvatarUpload);
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        document.getElementById('close-group-avatar-library-btn').addEventListener('click', closeGroupAvatarLibraryModal);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å€åŸŸï¼Œé»è²¼é€™æ®µã€æ–°ä»£ç¢¼ã€‘â–¼â–¼â–¼
// ç‚º EPhone åœ–ç¤ºè¨­ç½®ç¶²æ ¼ç¶å®šäº‹ä»¶å§”è¨—
document.getElementById('icon-settings-grid').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
            handleIconChange(iconId, 'ephone', item);
        }
    }
});
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼é€™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ã€‘ â–¼â–¼â–¼
        
            document.getElementById('chat-messages').addEventListener('click', (e) => {
                // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«é»æ“Šçš„å¡ç‰‡
                const linkCard = e.target.closest('.link-share-card');
                if (linkCard) {
                    const timestamp = parseInt(linkCard.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        openBrowser(timestamp); // èª¿ç”¨æˆ‘å€‘çš„å‡½æ•¸
                    }
                }
            });
        
            // æµè¦½å™¨è¿”å›æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ï¼Œç¢ºä¿å®ƒåªç¶å®šä¸€æ¬¡
            document.getElementById('browser-back-btn').addEventListener('click', () => {
                showScreen('chat-interface-screen');
            });
        
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€æ–°ä»£ç¢¼å¡Šã€‘æ›¿æ›èˆŠçš„ qzoneStickerPanelState.panelEl.addEventListener â–¼â–¼â–¼
        qzoneStickerPanelState.panelEl.addEventListener('click', async (e) => {
            const stickerItem = e.target.closest('.sticker-item');
            if (stickerItem && qzoneStickerPanelState.activePostId !== null) {
                // å¾èƒŒæ™¯åœ–ç‰‡æ¨£å¼ä¸­æå–URL
                const stickerUrl = stickerItem.style.backgroundImage.slice(5, -2);
                
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ“šURLå¾å…¨åŸŸè¡¨æƒ…ç‹€æ…‹ä¸­æ‰¾åˆ°å®Œæ•´çš„è¡¨æƒ…ç‰©ä»¶
                const stickerObject = state.userStickers.find(s => s.url === stickerUrl);
        
                if (stickerObject) {
                    // å°‡å®Œæ•´çš„è¡¨æƒ…ç‰©ä»¶å‚³éçµ¦è™•ç†å‡½æ•¸
                    await sendQzoneStickerComment(qzoneStickerPanelState.activePostId, stickerObject);
                } else {
                    console.warn("åœ¨å‹•æ…‹è©•è«–å€é»æ“Šäº†è¡¨æƒ…ï¼Œä½†åœ¨è¡¨æƒ…åº«ä¸­æœªæ‰¾åˆ°å°è±¡:", stickerUrl);
                }
            }
        });
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // ã€å…¨æ–°ã€‘å…¨åŸŸé»æ“Šç›£è½ï¼Œç”¨æ–¼é—œé–‰æ‰“é–‹çš„è¡¨æƒ…é¢æ¿
        document.addEventListener('click', (e) => {
            if (qzoneStickerPanelState.isOpen && 
                !qzoneStickerPanelState.panelEl.contains(e.target) && 
                !e.target.closest('.comment-sticker-btn')) {
                closeQzoneStickerPanel();
            }
        });
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„æœ«å°¾ï¼Œé»è²¼é€™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ã€‘ â–¼â–¼â–¼
        
            // 1. ç¶å®šè¼¸å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é€£çµâ€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);
        
            // 2. ç¶å®šæ¨¡æ…‹æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
                document.getElementById('share-link-modal').classList.remove('visible');
            });
        
            // 3. ç¶å®šæ¨¡æ…‹æ¡†ä¸­â€œåˆ†äº«â€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);
        
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
        

        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ é€™è¡Œä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('share-location-btn').addEventListener('click', sendLocationShare);
        // åœ¨ä½ çš„ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ...
        

        // â–¼â–¼â–¼ ç”¨é€™æ®µã€æ–°ä»£ç¢¼ã€‘æ›¿æ›èˆŠçš„é€šè©±è¨˜éŒ„äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        
        document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);
        
        // 2. ç¶å®šé€šè©±è¨˜éŒ„é é¢çš„â€œè¿”å›â€æŒ‰éˆ•
        document.getElementById('call-history-back-btn').addEventListener('click', () => {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›åˆ°èŠå¤©æ¸…å–®é é¢ï¼Œè€Œä¸æ˜¯èŠå¤©ä»‹é¢
            showScreen('chat-list-screen');
        });
        
        // 3. ç›£è½å¡ç‰‡é»æ“Šçš„é‚è¼¯ä¿æŒä¸è®Š
        document.getElementById('call-history-list').addEventListener('click', (e) => {
            const card = e.target.closest('.call-record-card');
            if (card && card.dataset.recordId) {
                showCallTranscript(parseInt(card.dataset.recordId));
            }
        });
        
        // 4. é—œé–‰è©³æƒ…å½ˆçª—çš„é‚è¼¯ä¿æŒä¸è®Š
document.getElementById('close-call-transcript-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});
        
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        

        
        document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);
        
        // åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
        document.getElementById('selection-share-btn').addEventListener('click', () => {
            if (selectedMessages.size > 0) {
                openShareTargetPicker(); // æ‰“é–‹æˆ‘å€‘å³å°‡å‰µå»ºçš„ç›®æ¨™é¸æ“‡å™¨
            }
        });
        document.getElementById('selection-screenshot-btn').addEventListener('click', handleLongScreenshot);
        // åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
        document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
            const sourceChat = state.chats[state.activeChatId];
            const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                           .map(cb => cb.dataset.chatId);
        
            if (selectedTargetIds.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦åˆ†äº«çš„èŠå¤©ã€‚");
                return;
            }
        
            // 1. æ‰“åŒ…èŠå¤©è¨˜éŒ„
            const sharedHistory = [];
            const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
            for (const timestamp of sortedTimestamps) {
                const msg = sourceChat.history.find(m => m.timestamp === timestamp);
                if (msg) {
                    sharedHistory.push(msg);
                }
            }
            
            // 2. å‰µå»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯ç‰©ä»¶
            const shareCardMessage = {
                role: 'user',
                senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
                type: 'share_card',
                timestamp: Date.now(),
                payload: {
                    sourceChatName: sourceChat.name,
                    title: `ä¾†è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è¨˜éŒ„`,
                    sharedHistory: sharedHistory
                }
            };
        
            // 3. è¿´åœˆç™¼é€åˆ°æ‰€æœ‰ç›®æ¨™èŠå¤©
            for (const targetId of selectedTargetIds) {
                const targetChat = state.chats[targetId];
                if (targetChat) {
                    targetChat.history.push(shareCardMessage);
                    await db.chats.put(targetChat);
                }
            }
            
            // 4. æ”¶å°¾å·¥ä½œ
            document.getElementById('share-target-modal').classList.remove('visible');
            exitSelectionMode(); // é€€å‡ºå¤šé¸æ¨¡å¼
            await showCustomAlert("åˆ†äº«æˆåŠŸ", `èŠå¤©è¨˜éŒ„å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} å€‹æœƒè©±ä¸­ã€‚`);
            renderChatList(); // åˆ·æ–°æ¸…å–®ï¼Œå¯èƒ½æœƒæœ‰æ–°æ¶ˆæ¯æç¤º
        });
        
        // ç¶å®šå–æ¶ˆæŒ‰éˆ•
        document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
            document.getElementById('share-target-modal').classList.remove('visible');
        });
        
        // åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // ...ä½ å·²æœ‰çš„å…¶ä»–é»æ“Šäº‹ä»¶é‚è¼¯...
        
            // æ–°å¢é‚è¼¯ï¼šè™•ç†åˆ†äº«å¡ç‰‡çš„é»æ“Š
            const shareCard = e.target.closest('.link-share-card[data-timestamp]');
            if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
                const timestamp = parseInt(shareCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
            }
        });
        
        // ç¶å®šæª¢è¦–å™¨çš„é—œé–‰æŒ‰éˆ•
        document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
            document.getElementById('shared-history-viewer-modal').classList.remove('visible');
        });
        
        // å‰µå»ºæ–°å‡½æ•¸ä¾†è™•ç†æ¸²æŸ“é‚è¼¯
        function openSharedHistoryViewer(timestamp) {
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'share_card') return;
        
            const viewerModal = document.getElementById('shared-history-viewer-modal');
            const viewerTitle = document.getElementById('shared-history-viewer-title');
            const viewerContent = document.getElementById('shared-history-viewer-content');
        
            viewerTitle.textContent = message.payload.title;
            viewerContent.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
        
            // ã€æ ¸å¿ƒã€‘è¤‡ç”¨ createMessageElement ä¾†æ¸²æŸ“æ¯ä¸€æ¢è¢«åˆ†äº«çš„æ¶ˆæ¯
            message.payload.sharedHistory.forEach(sharedMsg => {
                // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘å‚³å…¥çš„æ˜¯ sourceChat ç‰©ä»¶ï¼Œä»¥ç¢ºä¿é ­åƒã€æ˜µç¨±ç­‰æ­£ç¢º
                const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
                const bubbleEl = createMessageElement(sharedMsg, sourceChat);
                if (bubbleEl) {
                    viewerContent.appendChild(bubbleEl);
                }
            });
        
            viewerModal.classList.add('visible');
        }
        
        audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);
        
        audioPlayer.addEventListener('pause', () => { 
            if(musicState.isActive) { 
                musicState.isPlaying = false; 
                updatePlayerUI(); 
            } 
        });
        audioPlayer.addEventListener('play', () => { 
            if(musicState.isActive) { 
                musicState.isPlaying = true; 
                updatePlayerUI(); 
            } 
        });
        
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ï¼Œæ›¿æ›èˆŠçš„ playlist-body ç›£è½å™¨ â–¼â–¼â–¼

document.getElementById('playlist-body').addEventListener('click', async (e) => {
    const target = e.target;
    // ã€ã€ã€æ ¸å¿ƒæ–°å¢é‚è¼¯å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘
    // é»æ“Šâ€œå°ˆè¼¯â€æŒ‰éˆ•
    const albumArtBtn = target.closest('.album-art-btn');
    if (albumArtBtn) {
        const index = parseInt(albumArtBtn.dataset.index);
        if (!isNaN(index)) {
            // èª¿ç”¨æˆ‘å€‘å‰›å‰›æ·»åŠ çš„æ–°å‡½æ•¸
            await handleChangeAlbumArt(index);
        }
        return; // è™•ç†å®Œå¾Œç›´æ¥é€€å‡º
    }
    // é»æ“Šâ€œè©â€æŒ‰éˆ•
    const lyricsBtn = target.closest('.lyrics-btn');
    if (lyricsBtn) {
        const index = parseInt(lyricsBtn.dataset.index);
        if (isNaN(index)) return;

        // ã€æ ¸å¿ƒä¿®å¾©ã€‘æˆ‘å€‘ç¾åœ¨åªèª¿ç”¨å‡½æ•¸ï¼Œä¸å†éœ€è¦è™•ç†å®ƒçš„è¿”å›å€¼ã€‚
        // å› ç‚ºæ‰€æœ‰å¿…è¦çš„é‚è¼¯ï¼ˆåŒ…æ‹¬ä¿å­˜ï¼‰éƒ½å·²ç¶“åœ¨å‡½æ•¸å…§éƒ¨å®Œæˆäº†ã€‚
        await handleManualLrcImport(index);

        return; // è™•ç†å®Œå¾Œç›´æ¥é€€å‡º
    }

    // é»æ“Šâ€œåˆªé™¤â€æŒ‰éˆ• (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    const deleteBtn = target.closest('.delete-track-btn');
    if (deleteBtn) {
        const index = parseInt(deleteBtn.dataset.index);
        if (isNaN(index)) return;
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('åˆªé™¤æ­Œæ›²', `ç¢ºå®šè¦å¾æ’­æ”¾æ¸…å–®ä¸­åˆªé™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`);
        if (confirmed) {
            deleteTrack(index);
        }
        return;
    }

    // é»æ“Šæ­Œæ›²è³‡è¨Šå€åŸŸ -> æ’­æ”¾æ­Œæ›² (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Š)
    const itemInfo = target.closest('.playlist-item-info');
    if (itemInfo) {
        const item = itemInfo.closest('.playlist-item');
        const index = Array.from(item.parentElement.children).indexOf(item);
        if (index > -1) {
            playSong(index);
        }
    }
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        document.querySelector('.progress-bar').addEventListener('click', (e) => {
            if (!audioPlayer.duration) return;
            const progressBar = e.currentTarget;
            const barWidth = progressBar.clientWidth;
            const clickX = e.offsetX;
            audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
        });
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
        
        // ä½¿ç”¨äº‹ä»¶å§”è¨—ä¾†è™•ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„é»æ“Šäº‹ä»¶
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // æª¢æŸ¥è¢«é»æ“Šçš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
// â–¼â–¼â–¼ ã€é€™æ˜¯æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ .recalled-message-placeholder é»æ“Šäº‹ä»¶é‚è¼¯ â–¼â–¼â–¼
const placeholder = e.target.closest('.recalled-message-placeholder');
if (placeholder) {
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper');
    if (chat && wrapper) {
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;

            // --- æ ¸å¿ƒä¿®å¾©ï¼šåœ¨é€™è£¡æ·»åŠ å°æ›´å¤šæ¶ˆæ¯é¡å‹çš„åˆ¤æ–· ---
            switch (recalled.originalType) {
                case 'text':
                    originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                    break;
                case 'user_photo':
                case 'ai_image':
                case 'text_image':
                    originalContentText = `[åœ–ç‰‡/æ–‡å­—åœ–] æè¿°: "${recalled.originalContent}"`;
                    break;
                case 'voice_message':
                    originalContentText = `[èªéŸ³] å…§å®¹: "${recalled.originalContent}"`;
                    break;
                case 'sticker':
                    // å°æ–¼è¡¨æƒ…ï¼ŒåŒæ™‚é¡¯ç¤ºå«ç¾©å’Œåœ–ç‰‡URL
                    originalContentText = `[è¡¨æƒ…] å«ç¾©: "${recalled.originalMeaning || '(ç„¡)'}" \n URL: ${recalled.originalContent}`;
                    break;
                case 'transfer':
                    originalContentText = `ä¸€æ¢[è½‰å¸³]æ¶ˆæ¯å·²è¢«æ’¤å›ã€‚`;
                    break;
                default:
                    // å°æ–¼å…¶ä»–æœªçŸ¥é¡å‹ï¼Œé¡¯ç¤ºé¡å‹å’ŒåŸå§‹å…§å®¹
                    originalContentText = `æ’¤å›äº†ä¸€æ¢[${recalled.originalType}]é¡å‹çš„æ¶ˆæ¯ã€‚\nå…§å®¹: ${JSON.stringify(recalled.originalContent)}`;
                    break;
            }
            // --- ä¿®å¾©çµæŸ ---

            showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
        }
    }
}
});
        
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œé»è²¼é€™æ®µæ–°ä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
        document.getElementById('close-category-manager-btn').addEventListener('click', () => {
            document.getElementById('world-book-category-manager-modal').classList.remove('visible');
            renderWorldBookScreen(); // é—œé–‰å¾Œåˆ·æ–°ä¸»åˆ—è¡¨
        });
        document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
        document.getElementById('existing-categories-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteCategory(categoryId);
            }
        });
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ï¼Œæ·»åŠ é€™éƒ¨åˆ†ä»£ç¢¼ â–¼â–¼â–¼
        document.getElementById('repost-cancel-btn').addEventListener('click', hideRepostModal);
        document.getElementById('repost-confirm-btn').addEventListener('click', handleConfirmRepost);
        // â–²â–²â–² æ·»åŠ çµæŸ â–²â–²â–²

        // åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾
        // ...
        // ç¶å®šæ¶ˆæ¯æ“ä½œåŠŸèƒ½è¡¨ä¸­çš„â€œå¼•ç”¨â€æŒ‰éˆ•
        document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
        
        // ç¶å®šå›å¾©é è¦½æ¬„ä¸­çš„â€œå–æ¶ˆâ€æŒ‰éˆ•
        document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
        // ...
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
                // ===================================================================
                // 5. å•Ÿå‹•ï¼
        // åœ¨ç¬¬ 9660 è¡Œï¼ŒshowScreen('home-screen'); çš„å‰é¢ï¼Œé»è²¼ä¸‹é¢çš„ä»£ç¢¼
        
            // â–¼â–¼â–¼ ã€è«‹å°‡é€™æ®µå…¨æ–°çš„ä»£ç¢¼é»è²¼é€²å»ã€‘ â–¼â–¼â–¼
            
            // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºå‹•æ…‹è©•è«–å€çš„@åŠŸèƒ½ç¶å®šäº‹ä»¶
            document.getElementById('qzone-posts-list').addEventListener('input', (e) => {
                if (!e.target.matches('.comment-input')) return;
        
                const commentInput = e.target;
                const postContainer = commentInput.closest('.qzone-post-container');
                if (!postContainer) return;
                
                const popup = postContainer.querySelector('.at-mention-popup');
                const value = commentInput.value;
                const atMatch = value.match(/@([\p{L}\w]*)$/u);
        
                if (atMatch) {
                    const namesToMention = new Set();
                    const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                    if (authorNickname) namesToMention.add(authorNickname);
                    postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                        namesToMention.add(nameEl.textContent.replace(':', ''));
                    });
                    namesToMention.delete(state.qzoneSettings.nickname);
        
                    popup.innerHTML = '';
                    if (namesToMention.size > 0) {
                        const searchTerm = atMatch[1];
                        namesToMention.forEach(name => {
                            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                const item = document.createElement('div');
                                item.className = 'at-mention-item';
                                item.textContent = name;
                                item.addEventListener('mousedown', (evt) => {
                                    evt.preventDefault();
                                    const newText = value.substring(0, atMatch.index) + `@${name} `;
                                    commentInput.value = newText;
                                    popup.style.display = 'none';
                                    commentInput.focus();
                                });
                                popup.appendChild(item);
                            }
                        });
                        popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                    } else {
                        popup.style.display = 'none';
                    }
                } else {
                    popup.style.display = 'none';
                }
            });
        
            document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
                if (e.target.matches('.comment-input')) {
                    const postContainer = e.target.closest('.qzone-post-container');
                    if (postContainer) {
                        const popup = postContainer.querySelector('.at-mention-popup');
                        if (popup) {
                            setTimeout(() => { popup.style.display = 'none'; }, 200);
                        }
                    }
                }
            });
        
            // â–²â–²â–² ã€æ–°ä»£ç¢¼é»è²¼çµæŸã€‘ â–²â–²â–²  
        // â–¼â–¼â–¼ æŠŠä¸‹é¢é€™æ®µæ–°ä»£ç¢¼å®Œæ•´é»è²¼åˆ° showScreen('home-screen'); çš„å‰é¢ â–¼â–¼â–¼
        
        // ã€å…¨æ–°ã€‘ç‚ºã€ä¸»èŠå¤©è¼¸å…¥æ¡†ã€‘æ·»åŠ @åŠŸèƒ½
        const chatInputForMention = document.getElementById('chat-input');
        const chatMentionPopup = document.getElementById('chat-at-mention-popup');
        
        chatInputForMention.addEventListener('input', () => {
            // 1. é¦–å…ˆï¼Œæª¢æŸ¥ç•¶å‰æ˜¯å¦åœ¨ç¾¤èŠä¸­
            if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) {
                chatMentionPopup.style.display = 'none';
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            const value = chatInputForMention.value;
            const atMatch = value.match(/@([\p{L}\w]*)$/u);
        
            if (atMatch) {
                // 2. æ”¶é›†ç¾¤æˆå“¡åå–® (æ’é™¤è‡ªå·±)
                const myNickname = chat.settings.myNickname || 'æˆ‘';
                const namesToMention = chat.members
                    .map(member => member.groupNickname)
                    .filter(name => name !== myNickname);
        
                chatMentionPopup.innerHTML = '';
                if (namesToMention.length > 0) {
                    const searchTerm = atMatch[1];
                    // 3. ç¯©é¸ä¸¦ç”Ÿæˆåˆ—è¡¨
                    namesToMention.forEach(name => {
                        if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            const item = document.createElement('div');
                            item.className = 'at-mention-item';
                            item.textContent = name;
                            // 4. ç¶å®šé»æ“Šäº‹ä»¶
                            item.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                const newText = value.substring(0, atMatch.index) + `@${name} `;
                                chatInputForMention.value = newText;
                                chatMentionPopup.style.display = 'none';
                                chatInputForMention.focus();
                            });
                            chatMentionPopup.appendChild(item);
                        }
                    });
                    // 5. é¡¯ç¤ºæˆ–éš±è—å½ˆçª—
                    chatMentionPopup.style.display = chatMentionPopup.children.length > 0 ? 'block' : 'none';
                } else {
                    chatMentionPopup.style.display = 'none';
                }
            } else {
                chatMentionPopup.style.display = 'none';
            }
        });
        
        // ç•¶è¼¸å…¥æ¡†å¤±å»ç„¦é»æ™‚ï¼Œéš±è—å½ˆçª—
        chatInputForMention.addEventListener('blur', () => {
            setTimeout(() => { chatMentionPopup.style.display = 'none'; }, 200);
        });
        // â–²â–²â–² æ–°ä»£ç¢¼é»è²¼åˆ°é€™è£¡çµæŸ â–²â–²â–²     
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°ç‰ˆç¾¤å…¬å‘Šäº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('publish-to-announcement-btn').addEventListener('click', publishToAnnouncementBoard);
        document.getElementById('show-announcement-board-btn').addEventListener('click', showAnnouncementBoard);
        document.getElementById('close-announcement-board-btn').addEventListener('click', () => {
            document.getElementById('announcement-board-modal').classList.remove('visible');
        });
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²  
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¬å‘Šæ¿å…§éƒ¨äº‹ä»¶å§”è¨—èˆ‡æ“ä½œåŠŸèƒ½è¡¨äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('announcement-board-content').addEventListener('click', (e) => {
            if (e.target.classList.contains('announcement-item-actions')) {
                const annoId = e.target.dataset.annoId;
                if (annoId) {
                    showAnnouncementActions(annoId);
                }
            }
        });
        
        document.getElementById('announcement-action-pin').addEventListener('click', handlePinAnnouncement);
        document.getElementById('announcement-action-delete').addEventListener('click', handleDeleteAnnouncement);
        document.getElementById('announcement-action-cancel').addEventListener('click', () => {
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        });
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²   
                    // â–¼â–¼â–¼ æŠŠæ–°ä»£ç¢¼å®Œæ•´é»è²¼åœ¨é€™è£¡ â–¼â–¼â–¼
                    document.getElementById('reset-global-css-btn').addEventListener('click', () => {
                        document.getElementById('global-css-input').value = '';
                        // (å¯é¸) å¦‚æœå¸Œæœ›é»æ“Šé‡ç½®å¾Œç«‹åˆ»çœ‹åˆ°æ•ˆæœï¼Œå¯ä»¥åŠ ä¸Šä¸‹é¢é€™è¡Œ
                        // applyGlobalCss('');
                    });
        // â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™å€‹å…¨æ–°çš„äº‹ä»¶ç›£è½å™¨ï¼Œæ›¿æ›èˆŠçš„é•·æœŸè¨˜æ†¶åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        // èŠå¤©ä»‹é¢é ‚éƒ¨æ–°æŒ‰éˆ• -> æ‰“é–‹å…¨å±é é¢
        document.getElementById('open-memory-screen-btn').addEventListener('click', openLongTermMemoryScreen);
        
        // é•·æœŸè¨˜æ†¶é é¢è¿”å›æŒ‰éˆ• -> è¿”å›èŠå¤©ä»‹é¢
        document.getElementById('memory-screen-back-btn').addEventListener('click', () => {
            showScreen('chat-interface-screen');
        });
        
        // é•·æœŸè¨˜æ†¶é é¢é ‚éƒ¨â€œ+â€æŒ‰éˆ• -> æ‰‹å‹•æ·»åŠ 
        document.getElementById('add-manual-memory-btn-header').addEventListener('click', handleAddManualMemory);
        
        // é•·æœŸè¨˜æ†¶é é¢é ‚éƒ¨â€œç¸½çµâ€æŒ‰éˆ• -> æ‰‹å‹•ç¸½çµ
        document.getElementById('summarize-recent-btn-header').addEventListener('click', handleManualSummary);
        
        // ã€ã€ã€æ ¸å¿ƒä¿®å¾©å°±åœ¨é€™è£¡ï¼ã€‘ã€‘ã€‘
document.getElementById('memory-list-container').addEventListener('click', (e) => {
    const editBtn = e.target.closest('.edit-memory-btn');
    if (editBtn) {
        handleEditMemory(editBtn.dataset.authorId, parseInt(editBtn.dataset.memoryTimestamp));
        return;
    }
    const deleteBtn = e.target.closest('.delete-memory-btn');
    if (deleteBtn) {
        handleDeleteMemory(deleteBtn.dataset.authorId, parseInt(deleteBtn.dataset.memoryTimestamp));
        return;
    }
});
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘äº”å­æ£‹åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('gomoku-btn').addEventListener('click', toggleGomokuBoard);
        document.getElementById('close-gomoku-btn').addEventListener('click', closeGomokuBoard);
        
        const gomokuCanvas = document.getElementById('gomoku-board');
        gomokuCanvas.addEventListener('mousemove', handleBoardHover);
        gomokuCanvas.addEventListener('mouseout', () => renderGomokuBoard(state.activeChatId)); // Clear hover on exit
        gomokuCanvas.addEventListener('click', handleBoardClick);
        // â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€é€™æ˜¯ä¿®å¾©ä»£ç¢¼ã€‘è«‹å°‡é€™æ®µä»£ç¢¼é»è²¼åˆ° init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæœ«å°¾ â–¼â–¼â–¼
        document.getElementById('add-countdown-btn').addEventListener('click', () => {
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('countdown-title-input').value = '';
            document.getElementById('countdown-date-input').value = '';
            // é¡¯ç¤ºæ–°å»ºç´„å®šå½ˆçª—
            document.getElementById('create-countdown-modal').classList.add('visible');
        });
        
        // ç‚ºæ–°å»ºç´„å®šå½ˆçª—çš„â€œå–æ¶ˆâ€æŒ‰éˆ•ä¹Ÿç¶å®šäº‹ä»¶
        document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
            document.getElementById('create-countdown-modal').classList.remove('visible');
        });
        // â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¦–é »é€šè©±æ¶ˆæ¯æ“ä½œäº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('edit-call-message-btn').addEventListener('click', openCallMessageEditor);
        document.getElementById('delete-call-message-btn').addEventListener('click', deleteCallMessage);
        document.getElementById('cancel-call-message-action-btn').addEventListener('click', hideCallMessageActions);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°æ¼”æ¨¡å¼äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('edit-last-response-btn').addEventListener('click', openAiResponseEditor);
        document.getElementById('cancel-ai-response-editor-btn').addEventListener('click', () => {
            document.getElementById('ai-response-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-ai-response-editor-btn').addEventListener('click', saveEditedAiResponse);
        document.getElementById('add-ai-response-block-btn').addEventListener('click', () => {
            // é»æ“Šæ·»åŠ æŒ‰éˆ•æ™‚ï¼Œå‰µå»ºä¸€å€‹ç©ºçš„ã€å¸¶ç¯„æœ¬çš„ç·¨è¼¯å¡Š
            const container = document.getElementById('ai-response-editor-container');
            const newBlock = createAiResponseEditorBlock('{\n  "type": "text",\n  "content": "åœ¨é€™è£¡è¼¸å…¥æ–°æ¶ˆæ¯..."\n}');
            container.appendChild(newBlock);
            newBlock.querySelector('textarea').focus();
        });
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€é ­åƒåº«åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
        document.getElementById('manage-my-avatar-library-btn').addEventListener('click', openMyAvatarLibraryModal);
        document.getElementById('close-my-avatar-library-btn').addEventListener('click', closeMyAvatarLibraryModal);
        document.getElementById('add-my-avatar-url-btn').addEventListener('click', addAvatarToMyLibraryFromURL);
        document.getElementById('add-my-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('my-avatar-upload-input').click();
        });
        document.getElementById('my-avatar-upload-input').addEventListener('change', handleLocalMyAvatarUpload);
        document.getElementById('add-my-avatar-batch-btn').addEventListener('click', async () => {
            const placeholderText = `è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é»è²¼ï¼Œä¸€è¡Œä¸€å€‹ï¼š\n\nç„¦æ…® 2a9wte.jpeg\nå¤§é©šå¤±è‰² or8qf4.png\næ²’æœ‰éˆæ„Ÿ njwujh.jpeg`;
            const pastedText = await showCustomPrompt('æ‰¹é‡å°å…¥é ­åƒ', placeholderText, '', 'textarea');
            if (pastedText && pastedText.trim()) {
                await handleBatchImportForMyAvatar(pastedText);
            }
        });
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è³¼ç‰©åŠŸèƒ½äº‹ä»¶ç¶å®š (V6.0 - æ”¯æ´æŒ‡å®šæ”¶ç¦®äºº) â–¼â–¼â–¼
        document.getElementById('open-shopping-btn').addEventListener('click', openShoppingScreen);
        document.getElementById('shopping-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));
        document.getElementById('go-to-cart-btn').addEventListener('click', openCartScreen);
        document.getElementById('cart-back-btn').addEventListener('click', openShoppingScreen);
        document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
        document.getElementById('close-receipt-btn').addEventListener('click', () => {
            document.getElementById('gift-receipt-modal').classList.remove('visible');
        });
        
        // "ç®¡ç†"æŒ‰éˆ•
document.getElementById('manage-products-btn').addEventListener('click', () => {
    isProductManagementMode = !isProductManagementMode;
    const btn = document.getElementById('manage-products-btn');
    const actionBar = document.getElementById('shopping-action-bar');
    const gridEl = document.getElementById('product-grid');

    btn.style.color = isProductManagementMode ? 'var(--accent-color)' : 'var(--text-primary)';

    if (isProductManagementMode) {
        actionBar.style.display = 'flex'; // é¡¯ç¤ºæ“ä½œæ¬„
        gridEl.style.paddingBottom = '80px'; // ç‚ºæ“ä½œæ¬„ç•™å‡ºç©ºé–“
    } else {
        actionBar.style.display = 'none'; // éš±è—æ“ä½œæ¬„
        gridEl.style.paddingBottom = ''; // æ¢å¾©é»˜èª
        // é€€å‡ºæ™‚æ¸…ç©ºé¸æ“‡
        selectedProducts.clear();
        document.querySelectorAll('.product-item.selected').forEach(item => item.classList.remove('selected'));
        document.getElementById('delete-selected-products-btn').textContent = `åˆªé™¤ (0)`;
        document.getElementById('select-all-products-checkbox').checked = false;
    }

    // ã€é‡è¦ã€‘åœ¨åˆ‡æ›æ¨¡å¼å¾Œï¼Œé‡ç¹ªå•†å“æ¸…å–®ä»¥é¡¯ç¤ºæˆ–éš±è—å°æ‡‰çš„UI
    renderShoppingProducts();
});
        
        // â€œæ·»åŠ å•†å“â€æŒ‰éˆ•
        document.getElementById('add-new-product-btn').addEventListener('click', () => {
            if (isProductManagementMode) {
                openProductEditor(null);
            } else {
                alert("è«‹å…ˆé»æ“Šæ‰³æ‰‹åœ–ç¤ºé€²å…¥ç®¡ç†æ¨¡å¼ï¼Œæ‰èƒ½æ·»åŠ æ–°å•†å“ã€‚");
            }
        });
        
        // å•†å“åˆ—è¡¨äº‹ä»¶å§”è¨—
// â–¼â–¼â–¼ ã€è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬ã€‘æ›¿æ›èˆŠçš„ 'product-grid' äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('product-grid').addEventListener('click', async e => {
            const productItem = e.target.closest('.product-item');
            if (!productItem) return;
            const productId = parseInt(productItem.dataset.id);
            if (isNaN(productId)) return;

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è™•ç†ç®¡ç†æ¨¡å¼ä¸‹çš„é‚è¼¯
            if (isProductManagementMode) {
                // å¦‚æœé»æ“Šçš„æ˜¯â€œç·¨è¼¯â€æŒ‰éˆ•ï¼Œå‰‡åŸ·è¡Œç·¨è¼¯ä¸¦åœæ­¢
                if (e.target.classList.contains('edit-product-btn')) {
                    openProductEditor(productId);
                    return;
                }
                // å¦‚æœé»æ“Šçš„æ˜¯â€œåˆªé™¤â€æŒ‰éˆ•ï¼Œå‰‡åŸ·è¡Œåˆªé™¤ä¸¦åœæ­¢
                if (e.target.classList.contains('delete-product-btn')) {
                    const product = await db.shoppingProducts.get(productId);
                    if (!product) return;
                    const confirmed = await showCustomConfirm('åˆªé™¤å•†å“', `ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å•†å“ â€œ${product.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                    if(confirmed) {
                         await db.shoppingProducts.delete(productId);
                         await renderShoppingProducts(); // åˆ·æ–°åˆ—è¡¨
                         alert("å•†å“å·²åˆªé™¤ã€‚");
                    }
                    return;
                }
                
                // å¦‚æœé»æ“Šçš„ä¸æ˜¯ä»¥ä¸ŠæŒ‰éˆ•ï¼Œæ‰åŸ·è¡Œâ€œé¸æ“‡â€æ“ä½œ
                productItem.classList.toggle('selected');
                if (selectedProducts.has(productId)) {
                    selectedProducts.delete(productId);
                } else {
                    selectedProducts.add(productId);
                }
                document.getElementById('delete-selected-products-btn').textContent = `åˆªé™¤ (${selectedProducts.size})`;
                return;
            }

            // --- éç®¡ç†æ¨¡å¼ä¸‹çš„é‚è¼¯ (ä¿æŒä¸è®Š) ---
            if (e.target.classList.contains('add-to-cart-btn')) {
                const product = await db.shoppingProducts.get(productId);
                if (product.variations && product.variations.length > 0) {
                    openVariationSelector(productId);
                } else {
                    await addToCart(productId);
                    await showCustomAlert('æˆåŠŸ', 'å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Šï¼');
                }
                return;
            }

            // é»æ“Šå¡ç‰‡æœ¬èº«ï¼Œæœªä¾†å¯ä»¥ç”¨æ–¼æŸ¥çœ‹è©³æƒ…
            if (productItem.contains(e.target)) {
                 console.log(`é»æ“Šäº†å•†å“å¡ç‰‡: ${productId}`);
            }
        });
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        // è³¼ç‰©è»Šåˆ—è¡¨äº‹ä»¶å§”è¨—
        document.getElementById('cart-items-list').addEventListener('click', e => {
            const target = e.target;
            if (target.classList.contains('decrease-qty-btn')) {
                updateCartItemQuantity(parseInt(target.dataset.id), -1);
            }
            if (target.classList.contains('increase-qty-btn')) {
                updateCartItemQuantity(parseInt(target.dataset.id), 1);
            }
            if (target.classList.contains('cart-item-checkbox')) {
                updateCartTotal();
            }
        });
        
        // è³¼ç‰©è»Šæ¸…ç©ºæŒ‰éˆ•
        document.getElementById('clear-cart-btn').addEventListener('click', async () => {
            if (shoppingCart.length === 0) return;
            const confirmed = await showCustomConfirm('æ¸…ç©ºè³¼ç‰©è»Š', 'ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ');
            if (confirmed) {
                shoppingCart = [];
                updateCartCount();
                renderCartItems();
            }
        });
        
        // è³¼ç‰©è»Šå…¨é¸
        document.getElementById('select-all-cart-items').addEventListener('change', function(e) {
            document.querySelectorAll('.cart-item-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
            updateCartTotal();
        });
        
        // å•†å“ç·¨è¼¯å™¨å½ˆçª—æŒ‰éˆ•
        document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
            document.getElementById('product-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-product-btn').addEventListener('click', saveProduct);
        document.getElementById('product-image-input').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (re) => { document.getElementById('product-image-preview').src = re.target.result; };
                reader.readAsDataURL(file);
            }
        });
        
        // èŠå¤©ä»‹é¢ç¦®ç‰©å¡ç‰‡é»æ“Šäº‹ä»¶
        document.getElementById('chat-messages').addEventListener('click', e => {
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const bubble = giftCard.closest('.message-bubble');
                if (bubble) {
                    showGiftReceipt(parseInt(bubble.dataset.timestamp));
                }
            }
        });
        
        // ã€å…¨æ–°ã€‘ç¦®ç‰©æ¥æ”¶äººé¸æ“‡å½ˆçª—çš„äº‹ä»¶ç¶å®š
        document.getElementById('cancel-gift-recipient-btn').addEventListener('click', () => {
            document.getElementById('gift-recipient-modal').classList.remove('visible');
        });
        
        // â–¼â–¼â–¼ è«‹ç”¨é€™å€‹ã€å·²ä¿®å¾©ã€‘çš„æ–°äº‹ä»¶ç›£è½å™¨æ›¿æ›èˆŠçš„ 'confirm-gift-recipient-btn' ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('confirm-gift-recipient-btn').addEventListener('click', async () => {
            // æ­¥é©Ÿ 1: (ä¿æŒä¸è®Š) ç²å–é¸ä¸­çš„æ”¶ç¦®äºº
            const selectedRecipients = Array.from(document.querySelectorAll('#gift-recipient-list .contact-picker-item.selected'))
                .map(item => item.dataset.recipientName);
            
            if (selectedRecipients.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½æ”¶ç¦®äººã€‚");
                return;
            }
            
            // æ­¥é©Ÿ 2: ã€ã€ã€æ ¸å¿ƒä¿®å¾©ã€‘ã€‘ã€‘ åœ¨é€™è£¡ï¼Œé‡æ–°å¾è³¼ç‰©è»Šç²å–ä¸€æ¬¡é¸ä¸­çš„å•†å“
            const selectedItems = shoppingCart.filter(item => 
                document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
            );
            
            // æ­¥é©Ÿ 3: (ä¿æŒä¸è®Š) èª¿ç”¨ç™¼é€å‡½æ•¸ï¼Œæ­¤æ™‚å…©å€‹åƒæ•¸éƒ½æ˜¯æ­£ç¢ºçš„
            await sendGiftMessage(selectedItems, selectedRecipients);
            
            // æ­¥é©Ÿ 4: (ä¿æŒä¸è®Š) é—œé–‰å½ˆçª—
            document.getElementById('gift-recipient-modal').classList.remove('visible');
        });
        // â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²
        
        document.getElementById('gift-recipient-list').addEventListener('click', (e) => {
            const item = e.target.closest('.contact-picker-item');
            if (item) {
                item.classList.toggle('selected');
            }
        });
        
        document.getElementById('select-all-recipients').addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('#gift-recipient-list .contact-picker-item').forEach(item => {
                item.classList.toggle('selected', isChecked);
            });
        });
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºé‡æ–°ç”ŸæˆæŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('regenerate-btn').addEventListener('click', handleRegenerateResponse);
        document.getElementById('regenerate-call-btn').addEventListener('click', handleRegenerateCallResponse);
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²  
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºæ¨é€²åŠ‡æƒ…æŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('propel-btn').addEventListener('click', handlePropelAction);
        // ä¸‹é¢é€™è¡Œä»£ç¢¼å·²è¢«å®‰å…¨åœ°æ³¨é‡‹æ‰ï¼Œå› ç‚ºå®ƒå°æ‡‰çš„HTMLæŒ‰éˆ•ä¸å­˜åœ¨
        // document.getElementById('propel-call-btn').addEventListener('click', handlePropelCallAction);
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ...

// ã€å…¨æ–°ã€‘æ¶ˆæ¯æç¤ºéŸ³è¨­ç½®äº‹ä»¶
document.getElementById('test-sound-btn').addEventListener('click', () => {
    const player = document.getElementById('notification-sound-player');
    const url = document.getElementById('notification-sound-url-input').value.trim() || DEFAULT_NOTIFICATION_SOUND;
    player.src = url;
    player.play().catch(e => alert('æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºæˆ–æµè¦½å™¨æ˜¯å¦æ”¯æŒè©²æ ¼å¼ã€‚'));
});

document.getElementById('reset-sound-btn').addEventListener('click', () => {
    document.getElementById('notification-sound-url-input').value = '';
    alert('å·²é‡ç½®ç‚ºé»˜èªæç¤ºéŸ³ï¼Œé»æ“Šâ€œä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®â€å¾Œç”Ÿæ•ˆã€‚');
});
    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå°å…ƒä»¶ç·¨è¼¯åŠŸèƒ½æ·»åŠ äº‹ä»¶ç›£è½å™¨ (ä½¿ç”¨äº‹ä»¶å§”è¨—) â–¼â–¼â–¼
    document.getElementById('home-screen').addEventListener('click', (e) => {
        const target = e.target;
        // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯å¯ç·¨è¼¯çš„æ–‡å­—
        if (target.classList.contains('editable-text')) {
            handleEditText(target);
        }
        // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯å¯ç·¨è¼¯çš„åœ–ç‰‡
        if (target.classList.contains('editable-image')) {
            handleEditImage(target);
        }
    });
    // â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²  
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);    
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºBGMæœç´¢çµæœå½ˆçª—æ·»åŠ äº‹ä»¶ç›£è½ â–¼â–¼â–¼
document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢çµæœå½ˆçª—äº‹ä»¶ç¶å®š (å¤šé¸ç‰ˆ) â–¼â–¼â–¼
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

// "å…¨é¸" åŠŸèƒ½
document.getElementById('select-all-music-search').addEventListener('change', function(e) {
    document.querySelectorAll('#search-results-list .music-search-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
    });
});

// é»æ“Šæ¸…å–®é …åˆ‡æ›é¸ä¸­ç‹€æ…‹
document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item) {
        const checkbox = item.querySelector('.music-search-checkbox');
        if (checkbox) {
            // å¦‚æœé»æ“Šçš„ä¸æ˜¯æ ¸å–æ–¹å¡Šæœ¬èº«ï¼Œå°±æ‰‹å‹•åˆ‡æ›å®ƒçš„ç‹€æ…‹
            if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }
    }
});

// "æ·»åŠ é¸ä¸­" æŒ‰éˆ•åŠŸèƒ½
document.getElementById('add-selected-music-btn').addEventListener('click', async () => {
    const selectedItems = document.querySelectorAll('.music-search-checkbox:checked');
    if (selectedItems.length === 0) {
        alert("è«‹å…ˆé¸æ“‡è¦æ·»åŠ çš„æ­Œæ›²ã€‚");
        return;
    }

    document.getElementById('music-search-results-modal').classList.remove('visible');
    await showCustomAlert("è«‹ç¨å€™...", `æ­£åœ¨æ‰¹é‡æ·»åŠ  ${selectedItems.length} é¦–æ­Œæ›²...`);

    const songDataList = Array.from(selectedItems).map(cb => JSON.parse(cb.closest('.search-result-item').dataset.songJson));
    
    let successCount = 0;
    let failedNames = [];

    // ä½¿ç”¨ Promise.all ä¸¦è¡Œè™•ç†æ‰€æœ‰æ­Œæ›²çš„è©³æƒ…ç²å–
    const songDetailPromises = songDataList.map(songData => getPlayableSongDetails(songData));
    const fullSongObjects = await Promise.all(songDetailPromises);

    fullSongObjects.forEach((songObject, index) => {
        if (songObject) {
            musicState.playlist.push(songObject);
            successCount++;
        } else {
            failedNames.push(songDataList[index].name);
        }
    });

    if (successCount > 0) {
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === -1) {
            musicState.currentIndex = musicState.playlist.length - successCount;
            updatePlayerUI();
        }
    }

    let resultMessage = `æ·»åŠ å®Œæˆï¼\n\næˆåŠŸæ·»åŠ  ${successCount} é¦–æ­Œæ›²ã€‚`;
    if (failedNames.length > 0) {
        resultMessage += `\n\n${failedNames.length} é¦–æ­Œæ›²ç²å–å¤±æ•—:\n- ${failedNames.join('\n- ')}`;
    }
    await showCustomAlert("æ“ä½œçµæœ", resultMessage);
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºå”±ç‰‡/æ­Œè©å®¹å™¨ç¶å®šåˆ‡æ›äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('music-visual-container').addEventListener('click', () => {
    document.getElementById('music-visual-container').classList.toggle('lyrics-active');
});
// â–²â–²â–² æ–°å¢äº‹ä»¶çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢çµæœå½ˆçª—äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);
document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸…ç†ç„¡æ•ˆæ­Œæ›²äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('cleanup-songs-btn').addEventListener('click', cleanupInvalidSongs);
document.getElementById('toggle-blur-btn').addEventListener('click', toggleBackgroundBlur);
 document.getElementById('toggle-fullscreen-btn').addEventListener('click', togglePlayerFullscreen);
document.getElementById('show-avatars-btn').addEventListener('click', toggleMusicPlayerAvatars);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºç‹€æ…‹åˆ—é–‹é—œæ·»åŠ å³æ™‚é è¦½äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('status-bar-toggle-switch').addEventListener('change', () => {
    // æ¯æ¬¡é»æ“Šé–‹é—œæ™‚ï¼Œä¹Ÿèª¿ç”¨é€™å€‹å‡½æ•¸ä¾†å³æ™‚åˆ‡æ› class
    state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
    applyStatusBarVisibility();
});
// â–²â–²â–² æ–°å¢äº‹ä»¶çµæŸ â–²â–²â–²
// ç‚ºâ€œä¸‰é»â€æŒ‰éˆ•ç¶å®šæ–°çš„å…¥å£å‡½æ•¸
document.getElementById('qzone-more-actions-btn').addEventListener('click', openClearPostsSelectorModal);

// ç‚ºæ–°æ¨¡æ…‹æ¡†çš„æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('cancel-clear-posts-btn').addEventListener('click', () => {
    document.getElementById('clear-posts-modal').classList.remove('visible');
});
document.getElementById('confirm-clear-posts-btn').addEventListener('click', handleConfirmClearPosts);

// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºåˆ—è¡¨é …æ·»åŠ å‹¾é¸/å–æ¶ˆå‹¾é¸çš„é»æ“Šé‚è¼¯
document.getElementById('clear-posts-list').addEventListener('click', (e) => {
    const item = e.target.closest('.clear-posts-item');
    if (item) {
        item.classList.toggle('selected');
    }
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¨åŸŸèŠå¤©èƒŒæ™¯äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('global-bg-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (file) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        // å°‡ä¸Šå‚³çš„åœ–ç‰‡è‡¨æ™‚ä¿å­˜åœ¨ state ä¸­ï¼Œç­‰å¾…ç”¨æˆ¶é»æ“Šâ€œä¿å­˜â€
        state.globalSettings.globalChatBackground = dataUrl;
        // å³æ™‚æ›´æ–°å¤–è§€è¨­ç½®é é¢çš„é è¦½
        renderWallpaperScreen();
    }
    event.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é¸æ“‡
});

document.getElementById('remove-global-bg-btn').addEventListener('click', () => {
    // ç§»é™¤èƒŒæ™¯ä¸¦æ›´æ–°é è¦½
    state.globalSettings.globalChatBackground = '';
    renderWallpaperScreen();
});

// â–¼â–¼â–¼ ã€é‡è¦ã€‘æ›´æ–°â€œä¿å­˜æ‰€æœ‰å¤–è§€è¨­ç½®â€æŒ‰éˆ•çš„é‚è¼¯ â–¼â–¼â–¼
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    // ä¿å­˜å€‹äººä¸»é å£ç´™
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
    }
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å…¨åŸŸèŠå¤©èƒŒæ™¯å·²ç¶“åœ¨ä¸Šå‚³æˆ–ç§»é™¤æ™‚æ›´æ–°åˆ° state ä¸­äº†ï¼Œ
    // æ‰€ä»¥é€™è£¡æˆ‘å€‘åªéœ€è¦å°‡åŒ…å«æ‰€æœ‰æœ€æ–°è¨­ç½®çš„ globalSettings ç‰©ä»¶å®Œæ•´åœ°ä¿å­˜ä¸€æ¬¡å³å¯ã€‚
    
    state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
    state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
    state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
    
    // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰å…¨åŸŸè¨­ç½®
    await db.globalSettings.put(state.globalSettings);
    
    // æ‡‰ç”¨æ‰€æœ‰æ›´æ”¹
    applyGlobalWallpaper();
    newWallpaperBase64 = null;
    applyAppIcons();
    applyGlobalCss(state.globalSettings.globalCss);
    applyStatusBarVisibility();

    alert('å¤–è§€è¨­ç½®å·²ä¿å­˜ä¸¦æ‡‰ç”¨ï¼');
    showScreen('home-screen');
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œç¶²è·¯URLâ€æŒ‰éˆ•æ·»åŠ çš„åŠŸèƒ½ï¼Œè«‹é»è²¼åˆ° init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ â–¼â–¼â–¼
document.getElementById('upload-global-bg-url-btn').addEventListener('click', async () => {
    // 1. å½ˆå‡ºä¸€å€‹è¼¸å…¥æ¡†ï¼Œè®“ç”¨æˆ¶è¼¸å…¥URL
    const url = await showCustomPrompt("ç¶²è·¯åœ–ç‰‡", "è«‹è¼¸å…¥èƒŒæ™¯åœ–ç‰‡çš„URL", "", "url");

    // 2. å¦‚æœç”¨æˆ¶è¼¸å…¥äº†æœ‰æ•ˆçš„URLä¸¦é»æ“Šäº†â€œç¢ºå®šâ€
    if (url && url.trim()) {
        // a. å°‡ç²å–åˆ°çš„URLæ›´æ–°åˆ°å…¨åŸŸè¨­ç½®çš„ç‹€æ…‹ä¸­
        state.globalSettings.globalChatBackground = url.trim();
        
        // b. ç«‹åˆ»åˆ·æ–°å¤–è§€è¨­ç½®é é¢çš„é è¦½ï¼Œè®“ç”¨æˆ¶èƒ½é¦¬ä¸Šçœ‹åˆ°æ•ˆæœ
        renderWallpaperScreen();
    } else if (url !== null) {
        // å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†ç„¡æ•ˆå…§å®¹ï¼ˆä¸æ˜¯nullï¼Œèªªæ˜æ²’é»å–æ¶ˆï¼‰
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„URLã€‚");
    }
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
document.getElementById('upload-ephone-bg-url-btn').addEventListener('click', async () => {
    const url = await showCustomPrompt("ç¶²è·¯åœ–ç‰‡ (EPhone)", "è«‹è¼¸å…¥EPhoneä¸»è¢å¹•çš„èƒŒæ™¯åœ–ç‰‡URL", "", "url");
    if (url && url.trim()) {
        // EPhoneçš„å£ç´™æ›´æ–°é‚è¼¯æ˜¯å…ˆå­˜åˆ°ä¸€å€‹è‡¨æ™‚è®Šæ•¸ä¸­
        newWallpaperBase64 = url.trim();
        // ç„¶å¾Œåˆ·æ–°é è¦½
        renderWallpaperScreen();
    } else if (url !== null) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„URLã€‚");
    }
});

// 2. ç‚º CPhone çš„â€œç¶²è·¯URLâ€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('upload-cphone-bg-url-btn').addEventListener('click', async () => {
    const url = await showCustomPrompt("ç¶²è·¯åœ–ç‰‡ (CPhone)", "è«‹è¼¸å…¥CPhoneçš„èƒŒæ™¯åœ–ç‰‡URL", "", "url");
    if (url && url.trim()) {
        // CPhoneçš„å£ç´™æ›´æ–°é‚è¼¯æ˜¯ç›´æ¥ä¿®æ”¹å…¨åŸŸç‹€æ…‹
        state.globalSettings.cphoneWallpaper = url.trim();
        // ç„¶å¾Œåˆ·æ–°é è¦½
        renderWallpaperScreen();
    } else if (url !== null) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„URLã€‚");
    }
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºEPhoneå’ŒCPhoneå£ç´™ç§»é™¤åŠŸèƒ½æ·»åŠ çš„JSï¼Œè«‹é»è²¼åˆ° init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸ â–¼â–¼â–¼

// 1. ç‚º EPhone çš„â€œç§»é™¤å£ç´™â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('remove-ephone-bg-btn').addEventListener('click', () => {
    // å°‡è‡¨æ™‚è®Šæ•¸å’Œå…¨åŸŸç‹€æ…‹éƒ½æ¸…ç©º
    newWallpaperBase64 = null;
    state.globalSettings.wallpaper = '';
    // åˆ·æ–°é è¦½ï¼Œå®ƒæœƒè‡ªå‹•æ¢å¾©ç‚ºé»˜èªæ¼¸è®Šè‰²
    renderWallpaperScreen();
});

// 2. ç‚º CPhone çš„â€œç§»é™¤å£ç´™â€æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('remove-cphone-bg-btn').addEventListener('click', () => {
    // ç›´æ¥æ¸…ç©ºå…¨åŸŸç‹€æ…‹ä¸­çš„ CPhone å£ç´™è¨­ç½®
    state.globalSettings.cphoneWallpaper = '';
    // åˆ·æ–°é è¦½
    renderWallpaperScreen();
});

// â–²â–²â–² æ–°å¢JSä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¨åŸŸCSSé è¨­åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('css-preset-select').addEventListener('change', handleCssPresetSelectionChange);
        document.getElementById('save-css-preset-btn').addEventListener('click', saveCssPreset);
        document.getElementById('delete-css-preset-btn').addEventListener('click', deleteCssPreset);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—é«”é è¨­åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('font-preset-select').addEventListener('change', handleFontPresetSelectionChange);
        document.getElementById('save-font-preset-btn').addEventListener('click', saveFontPreset);
        document.getElementById('delete-font-preset-btn').addEventListener('click', deleteFontPreset);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°£æ³¡ä¸»é¡Œé è¨­åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
        document.getElementById('theme-preset-select').addEventListener('change', handleThemePresetSelectionChange);
        document.getElementById('save-theme-preset-btn').addEventListener('click', saveThemePreset);
        document.getElementById('delete-theme-preset-btn').addEventListener('click', deleteThemePreset);
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è¡¨æƒ…åˆ†é¡åŠŸèƒ½çš„ã€å…¨éƒ¨äº‹ä»¶ç›£è½å™¨ã€‘ï¼Œè«‹é»è²¼åˆ° init() å‡½æ•¸ä¸­ â–¼â–¼â–¼
        
        // 1. ç¶å®šè¡¨æƒ…é¢æ¿é ‚éƒ¨çš„â€œåˆ†é¡â€æŒ‰éˆ•ï¼Œç”¨æ–¼æ‰“é–‹ç®¡ç†å½ˆçª—
        document.getElementById('manage-sticker-categories-btn').addEventListener('click', openStickerCategoryManager);

        // 2. ç¶å®šåˆ†é¡ç®¡ç†å½ˆçª—çš„â€œå®Œæˆâ€æŒ‰éˆ•
        document.getElementById('close-sticker-category-manager-btn').addEventListener('click', () => {
            document.getElementById('sticker-category-manager-modal').classList.remove('visible');
            renderStickerPanel(); // é—œé–‰å¾Œåˆ·æ–°ä¸»é¢æ¿çš„é ç°½
        });

        // 3. ç¶å®šâ€œæ·»åŠ æ–°åˆ†é¡â€æŒ‰éˆ•
        document.getElementById('add-new-sticker-category-btn').addEventListener('click', addNewStickerCategory);

        // 4. ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†åˆ†é¡çš„åˆªé™¤
        document.getElementById('existing-sticker-categories-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteStickerCategory(categoryId);
            }
        });
        
        // 5. ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†è¡¨æƒ…é¢æ¿çš„é ç°½åˆ‡æ›
        document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('sticker-category-tab')) {
                const categoryId = e.target.dataset.categoryId;
                // å°‡å­—ä¸²IDè½‰æ›ç‚ºæ•¸ä½ï¼Œé™¤éæ˜¯ 'all' æˆ– 'uncategorized'
                const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;
                switchStickerCategory(finalId);
            }
        });

        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        document.getElementById('select-all-stickers-checkbox').addEventListener('change', handleSelectAllStickers);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å–®å€‹èŠå¤©å°å…¥åŒ¯å‡ºäº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('export-single-chat-btn').addEventListener('click', exportSingleChat);

document.getElementById('import-single-chat-btn').addEventListener('click', () => {
    document.getElementById('import-single-chat-input').click();
});

document.getElementById('import-single-chat-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        importSingleChat(file);
    }
    e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneåŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('add-char-memo-btn').addEventListener('click', () => openMemoEditor());
document.getElementById('add-char-diary-btn').addEventListener('click', () => openDiaryEditor());
document.getElementById('favorite-diary-btn').addEventListener('click', toggleDiaryFavorite);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        // â€œé‡æ–°ç”Ÿæˆâ€æŒ‰éˆ•
// æ–°ä»£ç¢¼ (è§£æ±ºæ–¹æ¡ˆ)
document.getElementById('regenerate-char-qq-btn').addEventListener('click', async () => {
    // ç‚ºäº†æ›´å¥½çš„ç”¨æˆ¶é«”é©—ï¼Œå…ˆå½ˆå‡ºä¸€å€‹æç¤º
    showCustomAlert("æ­£åœ¨åŸ·è¡Œ...", "æ­£åœ¨ç”Ÿæˆæ–°çš„é¡æ¯”èŠå¤©è¨˜éŒ„ï¼Œä¸¦åŒæ™‚è®“è§’è‰²æ€è€ƒå¦‚ä½•èˆ‡ä½ ç¹¼çºŒå°è©±...");

    try {
        // ä½¿ç”¨ Promise.all å¯ä»¥è®“å…©å€‹ç¨ç«‹çš„APIè«‹æ±‚ä½µç™¼åŸ·è¡Œï¼Œæ•ˆç‡æ›´é«˜
        await Promise.all([
            handleGenerateSimulatedQQ(),
            handleContinueRealConversationFromCPhone()
        ]);

        console.log("CPhone QQé¡æ¯”è¨˜éŒ„ç”Ÿæˆ å’Œ ä¸»èŠå¤©æ¨é€² å·²åŒæ™‚å®Œæˆã€‚");

    } catch (error) {
        console.error("åœ¨åŒæ™‚åŸ·è¡Œå…©å€‹å‡½æ•¸æ™‚å‡ºéŒ¯:", error);
        await showCustomAlert("æ“ä½œå¤±æ•—", `åœ¨åŸ·è¡Œçµ„åˆæ“ä½œæ™‚é‡åˆ°éŒ¯èª¤: ${error.message}`);
    }
});

        // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œè™•ç†æ¨¡æ“¬èŠå¤©ã€åˆ—è¡¨ã€‘çš„é»æ“Šäº‹ä»¶
        document.getElementById('char-chat-list').addEventListener('click', (e) => {
            const item = e.target.closest('.chat-list-item');
            if (item && item.dataset.conversationIndex) {
                const index = parseInt(item.dataset.conversationIndex);
                if (!isNaN(index)) {
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¾åœ¨èª¿ç”¨æ–°å‡½æ•¸ï¼Œæ‰“é–‹å…¨å±é é¢
                    openCharSimulatedConversation(index);
                }
            }
        });



        document.getElementById('back-to-char-qq-list-btn').addEventListener('click', () => {
            switchToCharScreen('char-qq-screen');
        });
// â–¼â–¼â–¼ ã€æœ€çµ‚ä¿®å¾©ç‰ˆã€‘é€™æ˜¯ç‚ºCPhoneé¡åƒèŠå¤©è¦–çª—æ¢å¾©â€œå‘ä¸Šæ»¾å‹•è¼‰å…¥â€åŠŸèƒ½çš„ä»£ç¢¼ â–¼â–¼â–¼

        // 1. ç²å–èŠå¤©è¨˜éŒ„çš„å®¹å™¨å…ƒç´ 
        const charConversationMessages = document.getElementById('char-conversation-messages');

        // 2. å®šç¾©æ»¾å‹•äº‹ä»¶çš„è™•ç†å‡½æ•¸
        const cphoneScrollHandler = () => {
            // 3. æ ¸å¿ƒåˆ¤æ–·ï¼šåªæœ‰ç•¶æ‰“é–‹çš„å°è©±æ˜¯èˆ‡ä½¿ç”¨è€…çš„ç§èŠæ™‚ï¼Œæ‰åŸ·è¡Œè¼‰å…¥é‚è¼¯
            if (cphoneActiveConversationType !== 'private_user') {
                return; // å¦‚æœæ˜¯NPCæˆ–ç¾¤èŠï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
            }
            
            // 4. æª¢æŸ¥æ˜¯å¦æ»¾å‹•åˆ°é ‚éƒ¨ï¼Œä¸¦ä¸”ç•¶å‰æ²’æœ‰æ­£åœ¨è¼‰å…¥
            if (charConversationMessages.scrollTop < 1 && !isLoadingMoreCphoneMessages) {
                const totalMessages = state.chats[activeCharacterId]?.history.length || 0;
                // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ›´å¤šæ­·å²è¨˜éŒ„å¯ä¾›è¼‰å…¥
                if (totalMessages > cphoneRenderedCount) {
                    // èª¿ç”¨è¼‰å…¥å‡½æ•¸
                    loadMoreMirroredMessages();
                }
            }
        };

        // 5. å°‡é€™å€‹è™•ç†å‡½æ•¸ç¶å®šåˆ°æ»¾å‹•äº‹ä»¶ä¸Š
        charConversationMessages.addEventListener('scroll', cphoneScrollHandler);

        // â–²â–²â–² ä¿®å¾©ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        // ã€æ–°å¢ã€‘ç‚ºé¡æ¯”å°è©±é é¢çš„â€œç™¼é€â€æŒ‰éˆ•ç¶å®šæç¤ºäº‹ä»¶
        document.getElementById('char-simulated-send-btn').addEventListener('click', () => {
            alert("é€™æ˜¯é¡æ¯”å°è©±ï¼Œç„¡æ³•ç™¼é€æ¶ˆæ¯å“¦~");
        });

        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        // 1. ç‚ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰éˆ•ç¶å®šæˆ‘å€‘å‰›å‰›å‰µå»ºçš„æ ¸å¿ƒå‡½æ•¸
        document.getElementById('regenerate-char-album-btn').addEventListener('click', handleGenerateSimulatedAlbum);

        // 2. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ•´å€‹ç›¸å†Šç¶²æ ¼æ·»åŠ é»æ“Šäº‹ä»¶
        document.getElementById('char-album-grid').addEventListener('click', (e) => {
            // æª¢æŸ¥è¢«é»æ“Šçš„æ˜¯å¦æ˜¯ä¸€å¼µç…§ç‰‡
            const photoItem = e.target.closest('.char-photo-item');
            
            // å¦‚æœæ˜¯ï¼Œä¸¦ä¸”å®ƒèº«ä¸Šå­˜æœ‰æˆ‘å€‘ä¹‹å‰æ”¾é€²å»çš„â€œç…§ç‰‡è©³æƒ…â€
            if (photoItem && photoItem.dataset.description) {
                const description = photoItem.dataset.description;
                
                // å°±ç”¨ä¸€å€‹æ¼‚äº®çš„å½ˆçª—æŠŠè©³æƒ…é¡¯ç¤ºå‡ºä¾†
                showCustomAlert("ç…§ç‰‡è©³æƒ…", description.replace(/\n/g, '<br>'));
            }
        });
        document.getElementById('regenerate-char-browser-btn').addEventListener('click', handleGenerateBrowserHistory);
        // 1. å°‡â€œé‡æ–°ç”Ÿæˆâ€æŒ‰éˆ•èˆ‡AIç”Ÿæˆå‡½æ•¸ç¶å®š
        document.getElementById('regenerate-char-taobao-btn').addEventListener('click', handleGenerateTaobaoHistory);
       
        
        // 3. ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºè³¼è²·è¨˜éŒ„æ¸…å–®æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œç”¨æ–¼é¡¯ç¤ºâ€œè³¼è²·ç†ç”±â€
        document.getElementById('char-product-grid').addEventListener('click', (e) => {
            const item = e.target.closest('.char-product-item');
            if (item && item.dataset.reason) {
                const reason = item.dataset.reason;
                showCustomAlert("TAçš„æƒ³æ³•...", reason.replace(/\n/g, '<br>'));
            }
        });
        
        // 4. ã€æ ¸å¿ƒã€‘å°‡ openCharWallet å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸï¼Œä»¥ä¾¿ onclick å¯ä»¥èª¿ç”¨
        window.openCharWallet = openCharWallet;
document.getElementById('regenerate-char-memo-btn').addEventListener('click', handleGenerateSimulatedMemos);
document.getElementById('char-memo-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-memo-screen'));
// åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ 
document.getElementById('regenerate-char-diary-btn').addEventListener('click', handleGenerateSimulatedDiaries);
document.getElementById('add-char-diary-btn').addEventListener('click', handleWriteNewDiaryEntry);
document.getElementById('char-diary-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-diary-screen'));
document.getElementById('regenerate-char-amap-btn').addEventListener('click', handleGenerateAmapHistory);
document.getElementById('regenerate-char-usage-btn').addEventListener('click', handleGenerateAppUsage);
        document.getElementById('regenerate-char-music-btn').addEventListener('click', handleGenerateSimulatedMusic);
        document.getElementById('close-char-music-player-btn').addEventListener('click', closeCharMusicPlayer);
document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
document.getElementById('douban-detail-back-btn').addEventListener('click', () => showScreen('douban-screen'));
document.getElementById('douban-send-comment-btn').addEventListener('click', handleSendDoubanComment);
document.getElementById('douban-wait-reply-btn').addEventListener('click', handleDoubanWaitReply);
        // 1. ç‚ºCPhoneçš„å£ç´™ä¸Šå‚³è¼¸å…¥æ¡†ç¶å®šäº‹ä»¶
        document.getElementById('cphone-wallpaper-upload-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const dataUrl = await new Promise((res) => {
                    const reader = new FileReader();
                    reader.onload = () => res(reader.result);
                    reader.readAsDataURL(file);
                });
                // ç›´æ¥æ›´æ–° state ä¸­çš„å€¼ï¼Œç­‰å¾…ç”¨æˆ¶é»æ“Šâ€œä¿å­˜â€
                state.globalSettings.cphoneWallpaper = dataUrl;
                // å³æ™‚åˆ·æ–°é è¦½
                renderWallpaperScreen();
            }
        });
        
        // 2. ç‚ºCPhoneçš„åœ–ç¤ºè¨­ç½®ç¶²æ ¼ç¶å®šäº‹ä»¶å§”è¨—
// ç‚º CPhone åœ–ç¤ºè¨­ç½®ç¶²æ ¼ç¶å®šäº‹ä»¶å§”è¨—
document.getElementById('cphone-icon-settings-grid').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
            handleIconChange(iconId, 'cphone', item);
        }
    }
});
document.getElementById('import-appearance-btn').addEventListener('click', () => {
    document.getElementById('import-appearance-input').click();
});

document.getElementById('import-appearance-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        importAppearanceSettings(file);
    }
    e.target.value = null; 
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è¨˜éŒ„æ‡‰ç”¨é—œé–‰æ™‚é–“çš„æ ¸å¿ƒä»£ç¢¼ï¼Œè«‹é»è²¼é€²å» â–¼â–¼â–¼
/**
 * ç›£è½æµè¦½å™¨çš„å¯è¦‹æ€§è®ŠåŒ–äº‹ä»¶ã€‚
 * ç•¶ç”¨æˆ¶å°‡PWAåˆ‡æ›åˆ°å¾Œè‡ºæˆ–é—œé–‰æµè¦½å™¨æ¨™ç±¤é æ™‚ï¼Œé€™å€‹äº‹ä»¶æœƒè¢«è§¸ç™¼ã€‚
 */
document.addEventListener('visibilitychange', () => {
    // å¦‚æœé é¢è®Šå¾—ä¸å¯è¦‹ (ç”¨æˆ¶åˆ‡æ›èµ°äº†)
    if (document.visibilityState === 'hidden') {
        // æˆ‘å€‘å°±åœ¨ localStorage ä¸­å­˜ä¸‹ç•¶å‰çš„æ™‚é–“æˆ³è¨˜
        localStorage.setItem('ephoneLastActiveTimestamp', Date.now());
        console.log("æ‡‰ç”¨å·²åˆ‡æ›åˆ°å¾Œè‡ºï¼Œè¨˜éŒ„ç•¶å‰æ™‚é–“ã€‚");
    }
});
// â–²â–²â–² æ–°ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–²
        document.getElementById('export-world-book-btn').addEventListener('click', exportWorldBooks);
        document.getElementById('import-world-book-btn').addEventListener('click', () => {
            document.getElementById('import-world-book-input').click();
        });
document.getElementById('import-world-book-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleWorldBookImport(file); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¾åœ¨èª¿ç”¨æ–°çš„æ™ºæ…§è™•ç†å™¨
            }
            e.target.value = null;
        });
        document.getElementById('enable-ai-drawing-switch').addEventListener('change', async (e) => {
            const isEnabled = e.target.checked;
            state.globalSettings.enableAiDrawing = isEnabled;
            await db.globalSettings.put(state.globalSettings);

            // æª¢æŸ¥ç•¶å‰åœ¨å“ªå€‹è¢å¹•ï¼Œä¸¦åˆ·æ–°å®ƒ
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                switch (activeScreen.id) {
                    case 'chat-interface-screen':
                        renderChatInterface(state.activeChatId);
                        break;
                    case 'chat-list-screen':
                        // åˆ·æ–°å‹•æ…‹é 
                        if(document.getElementById('qzone-screen').classList.contains('active')) renderQzonePosts();
                        // åˆ·æ–°æ”¶è—é 
                        if(document.getElementById('favorites-view').classList.contains('active')) renderFavoritesScreen();
                        break;
                    case 'douban-screen':
                        renderDoubanScreen();
                        break;
                    case 'douban-post-detail-screen':
                        openDoubanPostDetail(activeDoubanPostId);
                        break;
                    // Cphoneå…§éƒ¨çš„åˆ·æ–°
                    case 'character-phone-screen':
                        const activeCharScreen = document.querySelector('.char-screen.active');
                        if (activeCharScreen) {
                            switch(activeCharScreen.id) {
                                case 'char-album-screen': renderCharAlbum(); break;
                                case 'char-taobao-screen': renderCharTaobao(); break;
                                case 'char-browser-article-screen': 
                                    const char = state.chats[activeCharacterId];
                                    const history = char.simulatedBrowserHistory || [];
                                    const lastArticleIndex = history.length > 0 ? history.length - 1 : 0; // ç°¡å–®ç¤ºä¾‹ï¼Œå¯¦éš›å¯èƒ½éœ€è¦æ›´ç²¾ç¢ºçš„ç´¢å¼•
                                    renderCharArticle(history[lastArticleIndex]);
                                    break;
                                case 'char-usage-screen': renderCharAppUsage(); break;
                                case 'char-qq-screen': renderCharSimulatedQQ(); break;
                                case 'char-qq-conversation-screen': 
                                    const convoIndex = document.querySelector('#char-chat-list .chat-list-item')?.dataset.conversationIndex || 0;
                                    openCharSimulatedConversation(parseInt(convoIndex));
                                    break;
                            }
                        }
                        break;
                }
            }
            showCustomAlert('è¨­ç½®å·²æ‡‰ç”¨', `AIç”Ÿåœ–åŠŸèƒ½å·²${isEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰'}ã€‚`);
        });
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è¨˜éŒ„æœç´¢åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('search-history-btn').addEventListener('click', openSearchHistoryScreen);
document.getElementById('search-history-back-btn').addEventListener('click', () => {
    showScreen('chat-settings-screen');
});
document.getElementById('execute-search-btn').addEventListener('click', handleSearchHistory);
document.getElementById('clear-search-btn').addEventListener('click', clearSearchFilters);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªè¨‚é ­åƒæ¡†åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼

// ç¶å®šå½ˆçª—é ­éƒ¨çš„â€œä¸Šå‚³â€å’Œâ€œæ‰¹é‡â€æŒ‰éˆ•
document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadFrame);
document.getElementById('batch-import-frames-btn').addEventListener('click', handleBatchUploadFrames);

// ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç‚ºæ•´å€‹å½ˆçª—å…§å®¹å€ç¶å®šé»æ“Šäº‹ä»¶ï¼Œå°ˆé–€ç”¨æ–¼è™•ç†åˆªé™¤æŒ‰éˆ•
document.querySelector('#avatar-frame-modal .modal-body').addEventListener('click', (e) => {
    // æª¢æŸ¥è¢«é»æ“Šçš„æ˜¯å¦æ˜¯åˆªé™¤æŒ‰éˆ•
    if (e.target.classList.contains('delete-btn')) {
        const frameId = parseInt(e.target.dataset.id);
        if (!isNaN(frameId)) {
            handleDeleteCustomFrame(frameId);
        }
    }
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä¸»è¢å¹•åˆ†é å’Œâ€œé è¨­â€Appçš„ã€å…¨éƒ¨äº‹ä»¶ç›£è½å™¨ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼

        // 1. åˆå§‹åŒ–ä¸»è¢å¹•åˆ†é åŠŸèƒ½
        setupHomeScreenPagination();

        // 2. å°‡â€œé è¨­â€Appçš„å…¨åŸŸèª¿ç”¨å‡½æ•¸æš´éœ²çµ¦ windowï¼Œä»¥ä¾¿ onclick å¯ä»¥æ‰¾åˆ°å®ƒ
        window.openPresetScreen = openPresetScreen;

        // 3. ç¶å®šâ€œé è¨­â€Appå…§éƒ¨çš„æ‰€æœ‰æŒ‰éˆ•äº‹ä»¶
        document.getElementById('add-preset-btn').addEventListener('click', async () => {
            const name = await showCustomPrompt('å‰µå»ºæ–°é è¨­', 'è«‹è¼¸å…¥é è¨­åç¨±');
            if (name && name.trim()) {
                const newPreset = { id: 'preset_' + Date.now(), name: name.trim(), content: [] };
                await db.presets.add(newPreset);
                await renderPresetScreen();
                openPresetEditor(newPreset.id);
            }
        });

        document.getElementById('manage-preset-categories-btn').addEventListener('click', openPresetCategoryManager);
        
        document.getElementById('add-preset-entry-btn').addEventListener('click', () => {
            const container = document.getElementById('preset-entries-container');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            const newBlock = createPresetEntryBlock();
            container.appendChild(newBlock);
            newBlock.querySelector('.entry-content-textarea').focus();
        });

// â–¼â–¼â–¼ ã€å…¨æ–° | iOS ç›¸å®¹ç‰ˆã€‘è«‹ç”¨é€™å€‹æ–°ç‰ˆæœ¬æ›¿æ›èˆŠçš„ save-preset-btn äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('save-preset-btn').addEventListener('click', async () => {
    if (!editingPresetId) return;
    const preset = await db.presets.get(editingPresetId);
    if (!preset) return;

    // (é€™éƒ¨åˆ†ä¿å­˜è³‡æ–™çš„é‚è¼¯ä¿æŒä¸è®Š)
    const newName = document.getElementById('preset-name-input').value.trim();
    if (!newName) { alert('é è¨­åç¨±ä¸èƒ½ç‚ºç©ºï¼'); return; }
    preset.name = newName;
    preset.categoryId = parseInt(document.getElementById('preset-category-select').value) || null;

    const entriesContainer = document.getElementById('preset-entries-container');
    const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
    const newEntries = [];
    entryBlocks.forEach(block => {
        const content = block.querySelector('.entry-content-textarea').value.trim();
        if (content) {
            newEntries.push({
                comment: block.querySelector('.entry-comment-input').value.trim(),
                keys: (block.querySelector('.entry-keys-input').value.trim() || '').split(',').map(k => k.trim()).filter(Boolean),
                content: content,
                enabled: block.querySelector('.entry-enabled-switch').checked
            });
        }
    });
    preset.content = newEntries;

    // 1. å…ˆå°‡æ‰€æœ‰è³‡æ–™ä¿å­˜åˆ°è³‡æ–™åº«
    await db.presets.put(preset);
    editingPresetId = null;

    // 2. ã€æ ¸å¿ƒä¿®å¾©ã€‘å…ˆåˆ‡æ›åˆ°ç›®æ¨™è¢å¹•
    showScreen('preset-screen');
    
    // 3. ã€æ ¸å¿ƒä¿®å¾©ã€‘ç„¶å¾Œå†éåŒæ­¥åœ°ã€å¾å®¹åœ°æ¸²æŸ“é‚£å€‹è¢å¹•ä¸Šçš„å…§å®¹
    // é€™å°±çµ¦äº†æµè¦½å™¨è¶³å¤ çš„æ™‚é–“ä¾†è™•ç†è¢å¹•åˆ‡æ›å‹•ç•«ï¼Œé¿å…äº†å´©æ½°
    await renderPresetScreen();
});
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºâ€œé è¨­â€Appçš„å°å…¥åŠŸèƒ½ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('import-preset-btn').addEventListener('click', () => {
            document.getElementById('import-preset-input').click();
        });

        document.getElementById('import-preset-input').addEventListener('change', handlePresetImport);
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
document.getElementById('reset-button-order-btn').addEventListener('click', resetButtonOrder);
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | å·²ä¿®å¾©ã€‘é«˜ç´šè³‡æ–™æ¸…ç†åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('clear-specific-data-btn').addEventListener('click', openDataClearWizard);

// åš®å°ç¬¬ä¸€æ­¥çš„æŒ‰éˆ•
document.getElementById('cancel-clear-wizard-btn-step1').addEventListener('click', () => {
    document.getElementById('data-clear-wizard-modal').classList.remove('visible');
});
document.getElementById('go-to-clear-step2-btn').addEventListener('click', handleDataClearNext);

// åš®å°ç¬¬äºŒæ­¥çš„æŒ‰éˆ•
document.getElementById('back-to-clear-step1-btn').addEventListener('click', handleDataClearBack);
document.getElementById('cancel-clear-wizard-btn-step2').addEventListener('click', () => {
    document.getElementById('data-clear-wizard-modal').classList.remove('visible');
});
document.getElementById('confirm-final-clear-btn').addEventListener('click', handleConfirmDataClear);

// ã€æ ¸å¿ƒæ–°å¢ã€‘ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†å…©å€‹åˆ—è¡¨çš„å‹¾é¸/å–æ¶ˆå‹¾é¸ å’Œ å…¨é¸
document.getElementById('data-clear-wizard-modal').addEventListener('click', (e) => {
    const item = e.target.closest('.clear-posts-item');
    if (item) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼ä¸‹é¢çš„changeäº‹ä»¶
        e.stopPropagation();
        item.classList.toggle('selected');
    }
});
document.getElementById('data-clear-wizard-modal').addEventListener('change', (e) => {
    // å…¨é¸è§’è‰²
    if (e.target.id === 'select-all-chars-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
            item.classList.toggle('selected', isChecked);
        });
    } 
    // å…¨é¸è³‡æ–™é¡å‹
    else if (e.target.id === 'select-all-types-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-type-list .clear-posts-item').forEach(item => {
            item.classList.toggle('selected', isChecked);
        });
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
document.getElementById('compress-images-btn').addEventListener('click', compressAllLocalImages);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸï¼Œæ‰¾åˆ° #copy-message-btn çš„ç›£è½å™¨ï¼Œåœ¨å®ƒå¾Œé¢é»è²¼æ–°ä»£ç¢¼ â–¼â–¼â–¼
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚ºæ–°æŒ‰éˆ•ç¶å®šæ–°çš„åŠŸèƒ½å‡½æ•¸
document.getElementById('copy-timestamp-btn').addEventListener('click', copyMessageTimestamp);
// â–²â–²â–² é»è²¼çµæŸ â–²â–²â–²
document.getElementById('npc-list-back-btn').addEventListener('click', () => {
    // ç•¶é€™å€‹æŒ‰éˆ•è¢«é»æ“Šæ™‚ï¼Œèª¿ç”¨æˆ‘å€‘å®šç¾©åœ¨â€œç§å¯†ä½œç”¨åŸŸâ€è£¡çš„å‡½æ•¸
    switchToChatListView('messages-view');
});

// ç¶å®šNPCåˆ—è¡¨é é ‚éƒ¨çš„â€œ+â€æŒ‰éˆ•
document.getElementById('add-npc-btn').addEventListener('click', () => openNpcEditor(null));

// ç¶å®šNPCç·¨è¼¯å™¨å½ˆçª—çš„â€œä¿å­˜â€å’Œâ€œå–æ¶ˆâ€æŒ‰éˆ•
document.getElementById('save-npc-btn').addEventListener('click', saveNpc);
document.getElementById('cancel-npc-editor-btn').addEventListener('click', () => {
    document.getElementById('npc-editor-modal').classList.remove('visible');
});

// ç¶å®šNPCé ­åƒä¸Šå‚³
document.getElementById('npc-avatar-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('npc-avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});
document.getElementById('chat-lock-overlay').addEventListener('click', (e) => {
    // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯â€œé‡Rollâ€æŒ‰éˆ•
    if (e.target.id === 'spectator-reroll-btn') {
        handleSpectatorReroll();
    }
    // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯â€œå‰ªè¼¯â€æŒ‰éˆ•
    else if (e.target.id === 'spectator-edit-btn') {
        // ç›´æ¥è¤‡ç”¨ç¾æœ‰çš„â€œå°æ¼”å‰ªè¼¯å®¤â€æ‰“é–‹å‡½æ•¸
        openAiResponseEditor();
    }
    // (æ³¨æ„ï¼šä¸»æŒ‰éˆ• spectator-propel-btn çš„äº‹ä»¶å·²åœ¨ renderChatInterface ä¸­ç›´æ¥ç¶å®šï¼Œé€™è£¡ç„¡éœ€è™•ç†)
});
addLongPressListener(document.getElementById('music-visual-container'), () => { if (musicState.currentIndex > -1) { handleChangeAlbumArt(musicState.currentIndex); } });
document.getElementById('douban-settings-btn').addEventListener('click', openDoubanSettingsModal);
document.getElementById('save-douban-settings-btn').addEventListener('click', saveDoubanSettings);
document.getElementById('cancel-douban-settings-btn').addEventListener('click', () => {
    document.getElementById('douban-settings-modal').classList.remove('visible');
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºæ™‚å€æœç´¢æ¡†æ·»åŠ äº‹ä»¶ç›£è½ â–¼â–¼â–¼
document.getElementById('time-zone-search-input').addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const selectEl = document.getElementById('time-zone-select');
    
    // éæ­·ä¸‹æ‹‰æ¸…å–®ä¸­çš„æ¯ä¸€å€‹é¸é …
    for (const option of selectEl.options) {
        const optionText = option.textContent.toLowerCase();
        
        // å¦‚æœé¸é …çš„æ–‡æœ¬å…§å®¹åŒ…å«äº†ä½¿ç”¨è€…è¼¸å…¥çš„æœç´¢è©ï¼Œå°±é¡¯ç¤ºå®ƒ
        if (optionText.includes(searchTerm)) {
            option.style.display = ''; // æ¢å¾©é¡¯ç¤º
        } else {
            // å¦å‰‡å°±éš±è—å®ƒ
            option.style.display = 'none';
        }
    }
});
// â–²â–²â–² æ–°å¢JSä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºéŠæˆ²äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
    
// éŠæˆ²å°å±‹å…¥å£
// (é€™å€‹å·²ç¶“åœ¨HTMLçš„onclickè£¡è™•ç†äº†, ä½†æœ€å¥½ä¹Ÿåœ¨é€™è£¡æš´éœ²ä¸€ä¸‹å‡½æ•¸)
window.openWerewolfLobby = openWerewolfLobby;

// èŠå¤©å·¥å…·åˆ—å…¥å£
document.getElementById('werewolf-game-btn').addEventListener('click', () => openWerewolfLobby('group'));

// å¤§å»³æŒ‰éˆ•
document.getElementById('cancel-werewolf-lobby-btn').addEventListener('click', () => {
    document.getElementById('werewolf-lobby-modal').classList.remove('visible');
});
document.getElementById('start-werewolf-game-btn').addEventListener('click', initializeWerewolfGame);

// ã€å…¨æ–°ã€‘ç‚ºæ–°å½ˆçª—çš„å–æ¶ˆ/é—œé–‰æŒ‰éˆ•ç¶å®šäº‹ä»¶
        document.getElementById('werewolf-role-confirm-btn').addEventListener('click', () => {
            document.getElementById('werewolf-role-modal').classList.remove('visible');
            executeNightPhase(); // ç¢ºèªèº«ä»½å¾Œï¼Œæ­£å¼é€²å…¥å¤œæ™š
        });
        
        document.getElementById('exit-werewolf-game-btn').addEventListener('click', async () => {
            const confirmed = await showCustomConfirm('é€€å‡ºéŠæˆ²', 'ç¢ºå®šè¦é€€å‡ºç•¶å‰é€™å±€ç‹¼äººæ®ºå—ï¼ŸéŠæˆ²é€²åº¦å°‡ä¸æœƒè¢«ä¿å­˜ã€‚', {confirmButtonClass: 'btn-danger'});
            if (confirmed) {
                werewolfGameState.isActive = false;
                // æ ¹æ“šéŠæˆ²æ˜¯å¾å“ªè£¡ç™¼èµ·çš„ï¼Œè¿”å›åˆ°ä¸åŒçš„ä»‹é¢
                showScreen(werewolfGameState.chatId ? 'chat-interface-screen' : 'home-screen');
            }
        });

        document.getElementById('werewolf-game-over-close-btn').addEventListener('click', () => {
            document.getElementById('werewolf-game-over-modal').classList.remove('visible');
            showScreen(werewolfGameState.chatId ? 'chat-list-screen' : 'home-screen');
        });

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ  â–¼â–¼â–¼
document.getElementById('cancel-wolf-kill-btn').addEventListener('click', () => {
    document.getElementById('werewolf-kill-modal').classList.remove('visible');
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•¸çš„äº‹ä»¶ç›£è½å™¨å€åŸŸæ·»åŠ  â–¼â–¼â–¼
document.getElementById('cancel-werewolf-lobby-btn').addEventListener('click', () => {
    document.getElementById('werewolf-lobby-modal').classList.remove('visible');
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
document.getElementById('werewolf-retry-btn').addEventListener('click', handleWerewolfRetry);
document.getElementById('manual-werewolf-summary-btn').addEventListener('click', handleManualWerewolfSummary);
document.getElementById('check-and-fix-data-btn').addEventListener('click', checkAndFixData);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºåˆªé™¤ä¸–ç•Œæ›¸åŠŸèƒ½æ·»åŠ çš„äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('delete-world-books-btn').addEventListener('click', openWorldBookDeletionModal);

// ç‚ºæ–°å½ˆçª—çš„æŒ‰éˆ•å’Œæ¸…å–®ç¶å®šäº‹ä»¶
document.getElementById('cancel-delete-world-books-btn').addEventListener('click', () => {
    document.getElementById('delete-world-books-modal').classList.remove('visible');
});
document.getElementById('confirm-delete-world-books-btn').addEventListener('click', handleConfirmWorldBookDeletion);

document.getElementById('delete-world-books-modal').addEventListener('click', (e) => {
    // è™•ç†åˆ—è¡¨é …çš„å‹¾é¸/å–æ¶ˆå‹¾é¸
    const item = e.target.closest('.clear-posts-item');
    if (item) {
        item.classList.toggle('selected');
    }
    // è™•ç†â€œå…¨é¸â€æ ¸å–æ–¹å¡Š
    if (e.target.id === 'select-all-world-books-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#delete-world-books-list .clear-posts-item').forEach(el => {
            el.classList.toggle('selected', isChecked);
        });
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…åŒ…æœç´¢åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('sticker-search-input').addEventListener('input', () => {
    // ç”¨æˆ¶è¼¸å…¥æ™‚ï¼Œåªéœ€è¦é‡ç¹ªè¡¨æƒ…ç¶²æ ¼ï¼Œä¸éœ€è¦é‡ç¹ªé ‚éƒ¨çš„é ç°½
    renderStickerPanel(false); 
});

// ã€ä¿®æ­£ã€‘ç•¶åˆ‡æ›åˆ†é¡æ™‚ï¼Œæ¸…ç©ºæœç´¢æ¡†ä¸¦åˆ·æ–°
document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('sticker-category-tab')) {
        const categoryId = e.target.dataset.categoryId;
        const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;
        
        // æ¸…ç©ºæœç´¢æ¡†çš„å€¼
        document.getElementById('sticker-search-input').value = ''; 
        
        // èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„åˆ‡æ›å‡½æ•¸
        switchStickerCategory(finalId);
    }
});
// â–²â–²â–² æ–°å¢ä»£ç¢¼çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç„¡é™æ»¾å‹•äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼

// --- 1. èŠå¤©è¨˜éŒ„çš„æ»¾å‹•è¼‰å…¥ ---
const chatMessagesContainer = document.getElementById('chat-messages');
chatMessagesContainer.addEventListener('scroll', () => {
    // ç•¶æ»¾å‹•åˆ°é ‚éƒ¨æ™‚è§¸ç™¼
    if (chatMessagesContainer.scrollTop < 1 && !isLoadingMoreMessages) {
        const totalMessages = state.chats[state.activeChatId]?.history.length || 0;
        // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ›´å¤šæ¶ˆæ¯å¯ä¾›è¼‰å…¥
        if (totalMessages > currentRenderedCount) {
             loadMoreMessages();
        }
    }
});

// --- 2. å¿ƒè²æ­·å²çš„æ»¾å‹•è¼‰å…¥ ---
const thoughtsHistoryList = document.getElementById('thoughts-history-list');
thoughtsHistoryList.addEventListener('scroll', () => {
    const { scrollTop, scrollHeight, clientHeight } = thoughtsHistoryList;
    // ç•¶æ»¾å‹•åˆ°åº•éƒ¨æ™‚è§¸ç™¼
    if (scrollHeight - scrollTop <= clientHeight + 50 && !isLoadingMoreThoughts) { // å¢åŠ 50pxçš„ç·©è¡è·é›¢
        const totalItems = state.chats[state.activeChatId]?.thoughtsHistory.length || 0;
        if (totalItems > thoughtsHistoryRenderCount) {
            loadMoreThoughts();
        }
    }
});

// --- 3. å¥½å‹å‹•æ…‹çš„æ»¾å‹•è¼‰å…¥ ---
const qzoneContent = document.querySelector('#qzone-screen .qzone-content');
qzoneContent.addEventListener('scroll', () => {
    const { scrollTop, scrollHeight, clientHeight } = qzoneContent;
    // ç•¶æ»¾å‹•åˆ°åº•éƒ¨æ™‚è§¸ç™¼
    if (scrollHeight - scrollTop <= clientHeight + 100 && !isLoadingMorePosts) { // å¢åŠ 100pxçš„ç·©è¡è·é›¢
        if (qzonePostsCache.length > qzonePostsRenderCount) {
            loadMoreQzonePosts();
        }
    }
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›£è½å™¨çµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€V2.0 | å…¨æ–°ã€‘ä¸€èµ·è®€æ›¸åŠŸèƒ½äº‹ä»¶ç¶å®š â–¼â–¼â–¼
document.getElementById('read-together-btn').addEventListener('click', openReadingRoom);
const restoreBtn = document.getElementById('reading-restore-btn');
// èª¿ç”¨æˆ‘å€‘ç¾æœ‰çš„æ‹–å‹•å‡½æ•¸ï¼Œå°‡å°çƒæœ¬èº«ä½œç‚ºæ‹–å‹•ç›®æ¨™å’Œæ‹–å‹•æŠŠæ‰‹
makeDraggable(restoreBtn, restoreBtn);
document.getElementById('close-reading-btn').addEventListener('click', closeReadingRoom);
document.getElementById('open-reading-library-btn').addEventListener('click', openBookLibrary);
document.getElementById('next-page-btn').addEventListener('click', showNextPage);
document.getElementById('prev-page-btn').addEventListener('click', showPrevPage);
document.getElementById('book-upload-input').addEventListener('change', handleBookFileUpload);

// æ–°å¢ï¼šç‚ºæœ€å°åŒ–å’Œæ¢å¾©æŒ‰éˆ•ç¶å®šäº‹ä»¶
document.getElementById('minimize-reading-btn').addEventListener('click', minimizeReadingRoom);
document.getElementById('reading-restore-btn').addEventListener('click', restoreReadingRoom);

// æ–°å¢ï¼šåˆå§‹åŒ–è¦–çª—çš„æ‹–å‹•åŠŸèƒ½
makeDraggable(document.getElementById('reading-window'), document.querySelector('#reading-window .reading-header'));
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºè®€æ›¸åŠŸèƒ½çš„æ–°æŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('open-reading-library-btn').addEventListener('click', openBookLibrary);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‚ºæ›¸åº«å½ˆçª—çš„é ­éƒ¨SVGæŒ‰éˆ•ç¶å®šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('close-reading-library-btn-header').addEventListener('click', () => {
    document.getElementById('reading-library-modal').classList.remove('visible');
});
document.getElementById('import-new-book-btn-header').addEventListener('click', importBook);
// â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²

// ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†æ›¸åº«åˆ—è¡¨ä¸­çš„é»æ“Šäº‹ä»¶
document.getElementById('reading-library-list').addEventListener('click', (e) => {
    const target = e.target;
    if (target.classList.contains('group-name')) { // é»æ“Šæ›¸å -> é–±è®€
        const bookId = parseInt(target.dataset.bookId);
        loadBookFromLibrary(bookId);
    } else if (target.classList.contains('delete-group-btn')) { // é»æ“Šåˆªé™¤æŒ‰éˆ•
        const bookId = parseInt(target.dataset.bookId);
        deleteBookFromLibrary(bookId);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç¶å®šçµæŸ â–²â–²â–²
document.getElementById('page-indicator').addEventListener('click', handlePageJump);
document.getElementById('reading-library-search-input').addEventListener('input', (e) => {
    // ç•¶ä½¿ç”¨è€…è¼¸å…¥æ™‚ï¼Œèª¿ç”¨æ¸²æŸ“å‡½æ•¸ä¸¦å‚³å…¥æœç´¢è©
    renderBookLibrary(e.target.value);
});
const debouncedUpdateReadingContext = debounce(updateReadingContextOnScroll, 300); // åœæ­¢æ»¾å‹•300æ¯«ç§’å¾Œè§¸ç™¼

// 2. å°‡é€™å€‹æ–°å‡½æ•¸ç¶å®šåˆ°è®€æ›¸è¦–çª—å…§å®¹å€çš„æ»¾å‹•äº‹ä»¶ä¸Š
document.getElementById('reading-content').addEventListener('scroll', debouncedUpdateReadingContext);
document.getElementById('api-temperature-slider').addEventListener('input', (e) => {
    document.getElementById('api-temperature-value').textContent = e.target.value;
});
const chatListContainer = document.getElementById('messages-view');
chatListContainer.addEventListener('scroll', () => {
    const { scrollTop, scrollHeight, clientHeight } = chatListContainer;
    // ç•¶æ²è»¸è·é›¢åº•éƒ¨å°æ–¼ 150px æ™‚è§¸ç™¼è¼‰å…¥
    if (scrollHeight - scrollTop <= clientHeight + 150 && !isLoadingMoreChats) {
        loadMoreChats();
    }
});
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0ã€‘é€™æ˜¯å•†å“åˆ†é¡å’Œæ¬¾å¼åŠŸèƒ½çš„ã€å…¨éƒ¨äº‹ä»¶ç›£è½å™¨ã€‘ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼
        
        // ç¶å®šâ€œç®¡ç†åˆ†é¡â€æŒ‰éˆ•
        document.getElementById('manage-product-categories-btn').addEventListener('click', openProductCategoryManager);
document.getElementById('close-product-category-manager-btn').addEventListener('click', () => {
    document.getElementById('product-category-manager-modal').classList.remove('visible');
    // æ ¸å¿ƒä¿®å¾©ï¼šé—œé–‰åˆ†é¡ç®¡ç†å™¨å¾Œï¼Œç«‹å³é‡æ–°æ¸²æŸ“å•†å“ç·¨è¼¯å™¨
    // é€™æœƒé‡æ–°å¾è³‡æ–™åº«è¼‰å…¥æœ€æ–°çš„åˆ†é¡æ¸…å–®ï¼Œä¸¦æ›´æ–°ä¸‹æ‹‰æ¸…å–®
    openProductEditor(editingProductId); 
});
        document.getElementById('add-new-product-category-btn').addEventListener('click', addNewProductCategory);
        document.getElementById('existing-product-categories-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                deleteProductCategory(parseInt(e.target.dataset.id));
            }
        });

        // ç¶å®šâ€œæ·»åŠ æ–°çš„ä¸€æ¬¾â€æŒ‰éˆ•
        document.getElementById('add-product-variation-btn').addEventListener('click', () => addProductVariationInput());

        // ç¶å®šâ€œé¸æ“‡æ¬¾å¼â€å½ˆçª—çš„å–æ¶ˆå’Œæ•¸é‡æ§åˆ¶æŒ‰éˆ•
        document.getElementById('cancel-variation-selection-btn').addEventListener('click', () => {
            document.getElementById('variation-selection-modal').classList.remove('visible');
        });
        document.getElementById('variation-decrease-qty').addEventListener('click', () => {
            const display = document.getElementById('variation-quantity-display');
            let qty = parseInt(display.textContent);
            if (qty > 1) display.textContent = qty - 1;
        });
        document.getElementById('variation-increase-qty').addEventListener('click', () => {
            const display = document.getElementById('variation-quantity-display');
            display.textContent = parseInt(display.textContent) + 1;
        });
document.getElementById('product-category-tabs').addEventListener('click', (e) => {
    // æª¢æŸ¥è¢«é»æ“Šçš„æ˜¯å¦æ˜¯ä¸€å€‹é ç°½æŒ‰éˆ•
    if (e.target.classList.contains('product-category-tab')) {
        // å¾è¢«é»æ“Šçš„æŒ‰éˆ•ä¸Šï¼Œç²å–æˆ‘å€‘ä¹‹å‰å„²å­˜çš„åˆ†é¡ID
        const categoryId = e.target.dataset.categoryId === 'all' ? 'all' : parseInt(e.target.dataset.categoryId);
        
        // èª¿ç”¨åˆ‡æ›åˆ†é¡çš„å‡½æ•¸ (é€™å€‹å‡½æ•¸æ‚¨ä¸Šä¸€è¼ªå·²ç¶“æ·»åŠ éäº†)
        switchShoppingCategory(categoryId);
    }
});
document.getElementById('generate-shopping-items-btn').addEventListener('click', handleGenerateShoppingItems);
document.getElementById('shopping-settings-btn').addEventListener('click', openShoppingSettingsModal);
document.getElementById('save-shopping-settings-btn').addEventListener('click', saveShoppingSettings);
document.getElementById('cancel-shopping-settings-btn').addEventListener('click', () => {
    document.getElementById('shopping-settings-modal').classList.remove('visible');
});
document.getElementById('select-all-products-checkbox').addEventListener('change', (e) => {
    const isChecked = e.target.checked;
    // ç²å–ç•¶å‰åˆ†é¡ä¸‹æ‰€æœ‰å¯è¦‹çš„å•†å“
    const visibleItems = document.querySelectorAll('#product-grid .product-item');

    visibleItems.forEach(item => {
        const productId = parseInt(item.dataset.id);
        item.classList.toggle('selected', isChecked);
        if (isChecked) {
            selectedProducts.add(productId);
        } else {
            selectedProducts.delete(productId);
        }
    });
    document.getElementById('delete-selected-products-btn').textContent = `åˆªé™¤ (${selectedProducts.size})`;
});

// æ‰¹é‡åˆªé™¤æŒ‰éˆ•äº‹ä»¶
document.getElementById('delete-selected-products-btn').addEventListener('click', async () => {
    if (selectedProducts.size === 0) {
        alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å•†å“ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¢ºèªåˆªé™¤',
        `ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é¸ä¸­çš„ ${selectedProducts.size} å€‹å•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        await db.shoppingProducts.bulkDelete([...selectedProducts]);

        // é€€å‡ºç®¡ç†æ¨¡å¼ä¸¦åˆ·æ–°
        document.getElementById('manage-products-btn').click(); 
        // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºæ›´æ”¹
        await renderShoppingProducts();

        await showCustomAlert("æˆåŠŸ", "é¸ä¸­çš„å•†å“å·²æˆåŠŸåˆªé™¤ã€‚");
    }
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§€é è¨­åŠŸèƒ½äº‹ä»¶ç›£è½å™¨ â–¼â–¼â–¼
document.getElementById('appearance-preset-select').addEventListener('change', handleAppearancePresetSelectionChange);
document.getElementById('save-appearance-preset-btn').addEventListener('click', saveAppearancePreset);
document.getElementById('delete-appearance-preset-btn').addEventListener('click', deleteAppearancePreset);
// â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
document.getElementById('manage-frames-btn').addEventListener('click', toggleFrameManagementMode);
document.getElementById('select-all-frames-checkbox').addEventListener('change', handleSelectAllFrames);
document.getElementById('delete-selected-frames-btn').addEventListener('click', executeBatchDeleteFrames);


    checkForUpdates();

                    showScreen('home-screen');
                }
        
                init();
            });
        
    </script>
    <div id="qzone-sticker-panel">
        <div id="qzone-sticker-grid"></div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–° V2.0 | æ”¯æŒä¸Šå‚³ã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ avatar-frame-modal â–¼â–¼â–¼ -->
<div id="avatar-frame-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>é¸æ“‡é ­åƒæ¡†</span>
            <div class="header-actions">
                <!-- ã€æ ¸å¿ƒæ–°å¢1ã€‘é€™å°±æ˜¯æ–°çš„â€œç®¡ç†â€æŒ‰éˆ• -->
                <button id="manage-frames-btn" class="action-button">ç®¡ç†</button>
                <button id="upload-custom-frame-btn" class="action-button">ä¸Šå‚³</button>
                <button id="batch-import-frames-btn" class="action-button">æ‰¹é‡</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="frame-tabs">
                <div id="ai-frame-tab" class="frame-tab active">å°æ–¹çš„</div>
                <div id="my-frame-tab" class="frame-tab">æˆ‘çš„</div>
            </div>
            <div id="ai-frame-content" class="frame-content">
                <div id="ai-frame-grid" class="frame-grid">
                </div>
            </div>
            <div id="my-frame-content" class="frame-content" style="display: none;">
                <div id="my-frame-grid" class="frame-grid">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
        </div>
        <!-- ã€æ ¸å¿ƒæ–°å¢2ã€‘é€™æ˜¯åº•éƒ¨æ‰¹é‡æ“ä½œæ¬„ -->
        <div id="frame-action-bar" style="display: none;">
            <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="select-all-frames-checkbox"> å…¨é¸
            </label>
            <button id="delete-selected-frames-btn" class="action-bar-btn">åˆªé™¤ (0)</button>
        </div>
    </div>
</div>
<!-- ã€æ ¸å¿ƒæ–°å¢ã€‘ç”¨æ–¼æœ¬åœ°ä¸Šå‚³çš„éš±è—æª”è¼¸å…¥æ¡† -->
<input type="file" id="custom-frame-upload-input" accept="image/*" hidden>
    <!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->

<div id="character-profile-modal" class="modal">
    <div class="character-profile-content">
        <!-- å³ä¸Šè§’çš„æ­·å²è¨˜éŒ„åœ–ç¤ºæŒ‰éˆ• -->
        <button id="profile-history-icon-btn" title="æŸ¥çœ‹æ­·å²å¿ƒè²">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
        </button>
        
        <!-- ä¸»è³‡æ–™é  -->
        <div id="profile-main-content">
            <!-- ï¼ˆé€™è£¡çš„å…§å®¹çµæ§‹èˆ‡ä¸Šæ¬¡é¡ä¼¼ï¼Œä½†è¢«åŒ…è£¹åœ¨äº†å¡ç‰‡å…§éƒ¨ï¼‰ -->
            <div id="profile-timestamp" class="thought-header"></div>
            <div class="thought-content">
                <div class="voice">
                    <div class="label">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        å¿ƒè²
                    </div>
                    <p id="profile-heartfelt-voice" class="text"></p>
                </div>
                <div class="jottings">
                    <div class="label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                        æ•£è¨˜
                    </div>
                    <p id="profile-random-jottings" class="text"></p>
                </div>
            </div>
        </div>

        <!-- æ­·å²è¨˜éŒ„é  (ä¿æŒä¸è®Šï¼Œä½†ç¾åœ¨ä¹Ÿåœ¨å¡ç‰‡å…§åˆ‡æ›) -->
        <div id="profile-thoughts-history-view">
            <div class="profile-header">
                <span>å¿ƒè²è¨˜éŒ„</span>
                <button id="history-back-btn" title="è¿”å›">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
            </div>
            <div id="thoughts-history-list"></div>
        </div>
    </div>
</div>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€é ­åƒåº«å°ˆç”¨æ–‡ä»¶ä¸Šå‚³è¼¸å…¥æ¡† â–¼â–¼â–¼ -->
    <input type="file" id="my-avatar-upload-input" accept="image/*" hidden>
    <!-- â–²â–²â–² æ–°HTMLé»è²¼çµæŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯é¸æ“‡ç¦®ç‰©æ¥æ”¶äººçš„å½ˆçª—ï¼Œè«‹é»è²¼åˆ° body åº•éƒ¨ â–¼â–¼â–¼ -->
    <div id="gift-recipient-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>é¸æ“‡æ”¶ç¦®äºº</span>
                <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="select-all-recipients"> å…¨é¸ </label>
            </div>
            <div class="modal-body" id="gift-recipient-list" style="padding: 0;">
                <!-- ç¾¤æˆå“¡æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-gift-recipient-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-gift-recipient-btn">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è«‹å°‡é€™å€‹ã€å…¨æ–°çš„ <audio> æ¨™ç±¤ã€‘é»è²¼åˆ° <body> æ¨™ç±¤çš„æœ€æœ«å°¾ï¼Œç·Šé„° </body> ä¹‹å‰ â–¼â–¼â–¼ -->
<audio id="notification-sound-player" preload="auto"></audio>
<!-- â–²â–²â–² é»è²¼çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2ç‰ˆã€‘BGMæœç´¢çµæœå½ˆçª— (æ”¯æŒå¤šé¸) â–¼â–¼â–¼ -->
<div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æœç´¢çµæœ</span>
            <!-- æ ¸å¿ƒä¿®æ”¹1ï¼šæ·»åŠ â€œå…¨é¸â€æ ¸å–æ–¹å¡Š -->
            <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="select-all-music-search"> å…¨é¸
            </label>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0;">
            <!-- æœç´¢çµæœå°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <!-- æ ¸å¿ƒä¿®æ”¹2ï¼šæ›´æ–°é è…³æŒ‰éˆ• -->
            <button class="cancel" id="cancel-music-search-btn">å–æ¶ˆ</button>
            <button class="save" id="add-selected-music-btn">æ·»åŠ é¸ä¸­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯è±†ç“£è¨­ç½®çš„å½ˆçª—ï¼Œè«‹é»è²¼åˆ° body åº•éƒ¨ â–¼â–¼â–¼ -->
<div id="douban-settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>è±†ç“£è¨­ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group douban-settings-item">
                <label for="douban-min-posts-input">
                    æ¯æ¬¡ç”Ÿæˆå¸–å­æ•¸ç¯„åœ
                    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                        è¨­ç½®AIåœ¨è±†ç“£é é¢ä¸€æ¬¡æ€§ç”Ÿæˆå¸–å­çš„æœ€å°å’Œæœ€å¤§æ•¸é‡ã€‚
                    </p>
                </label>
                <div class="douban-settings-controls">
                    <input type="number" id="douban-min-posts-input" min="1" value="12">
                    <span>åˆ°</span>
                    <input type="number" id="douban-max-posts-input" min="1" value="20">
                    <span>ç¯‡</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-douban-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-douban-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<audio id="char-audio-player" preload="auto"></audio>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è±†ç“£è§’è‰²é¸æ“‡å½ˆçª— â–¼â–¼â–¼ -->
<div id="douban-cast-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é¸æ“‡åƒèˆ‡è±†ç“£çš„è§’è‰²</span>
        </div>
        <div class="modal-body" id="douban-cast-list" style="padding: 0;">
            <!-- è§’è‰²æ¸…å–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-douban-cast-btn">å–æ¶ˆ</button>
            <button class="save" id="save-douban-cast-btn">ä¿å­˜ä¸¦åˆ·æ–°</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç‚ºâ€œé è¨­â€åŠŸèƒ½æ–°å¢çš„æª”å°å…¥è¼¸å…¥æ¡† â–¼â–¼â–¼ -->
<input type="file" id="import-preset-input" accept=".json" hidden>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯æ›´æ–°é€šçŸ¥å½ˆçª—çš„HTMLçµæ§‹ â–¼â–¼â–¼ -->
<div id="update-notice-modal">
    <div class="update-notice-content">
        <div class="update-notice-body" id="update-notice-body">
            <!-- æ›´æ–°å…§å®¹å°‡ç”±JSå‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
        </div>
        <div class="update-notice-footer">
            <button id="update-notice-confirm-btn">æˆ‘çŸ¥é“äº†</button>
            <button id="update-notice-dismiss-btn">ä¸å†æç¤º</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<div id="delete-world-books-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é¸æ“‡è¦åˆªé™¤çš„ä¸–ç•Œæ›¸</span>
            <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="select-all-world-books-for-clear"> å…¨é¸
            </label>
        </div>
        <div class="modal-body" id="delete-world-books-list" style="padding: 0;">
            </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-delete-world-books-btn">å–æ¶ˆ</button>
            <button class="save btn-danger" id="confirm-delete-world-books-btn">ç¢ºèªåˆªé™¤</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ®ºå¤œæ™šåˆ€äººå½ˆçª— â–¼â–¼â–¼ -->
<div id="werewolf-kill-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>ç‹¼äººè«‹é¸æ“‡åˆ€äººç‰©ä»¶</span></div>
        <div class="modal-body" id="werewolf-kill-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="cancel" id="cancel-wolf-kill-btn">æ”¾æ£„</button>
             <button class="save btn-danger" id="confirm-wolf-kill-btn">ç¢ºèªåˆ€äºº</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<div id="werewolf-lobby-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span>é¸æ“‡ç©å®¶é–‹å§‹ç‹¼äººæ®º</span>
        </div>
        <div class="modal-body" id="werewolf-player-selection-list" style="padding: 0;">
            </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-werewolf-lobby-btn">å–æ¶ˆ</button>
            <button class="save" id="start-werewolf-game-btn">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | äº¤äº’ä¿®å¾©ç‰ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ werewolf-game-screen â–¼â–¼â–¼ -->


<div id="werewolf-role-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; text-align: center; padding: 20px;">
        <h3 id="werewolf-role-title" style="margin-top: 0;">ä½ çš„èº«ä»½æ˜¯</h3>
        <div id="werewolf-role-card" style="margin: 15px 0;">
            <!-- ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨é€™è£¡æ·»åŠ äº†ç¼ºå¤±çš„ h2 å’Œ p æ¨™ç±¤ -->
            <h2 id="werewolf-role-name" style="margin: 0 0 10px 0;"></h2>
            <p id="werewolf-role-description" style="font-size: 14px; line-height: 1.6; color: #555; margin: 0;"></p>
        </div>
        <button id="werewolf-role-confirm-btn" class="form-button">æˆ‘æº–å‚™å¥½äº†</button>
    </div>
</div>

<div id="werewolf-prophet-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>é è¨€å®¶è«‹é¸æ“‡æŸ¥é©—ç‰©ä»¶</span></div>
        <div class="modal-body" id="werewolf-prophet-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="save" id="confirm-prophet-check-btn">ç¢ºèªæŸ¥é©—</button>
        </div>
    </div>
</div>

<div id="werewolf-hunter-modal" class="modal">
     <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>çµäººè«‹é¸æ“‡é–‹æ§ç‰©ä»¶</span></div>
        <div class="modal-body" id="werewolf-hunter-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="save btn-danger" id="confirm-hunter-shot-btn">ç¢ºèªé–‹æ§</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ä½ ç¼ºå¤±çš„â€œæŠ•ç¥¨â€å½ˆçª—ï¼Œè«‹é»è²¼åˆ°æ­¤è™• â–¼â–¼â–¼ -->
<div id="werewolf-vote-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>è«‹æŠ•ç¥¨æ”¾é€ä¸€åç©å®¶</span></div>
        <div class="modal-body" id="werewolf-vote-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="save" id="confirm-vote-btn">ç¢ºèªæŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLçµæŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0ã€‘é€™æ˜¯ä½ ç¼ºå¤±çš„æ‰€æœ‰ç‹¼äººæ®ºè§’è‰²æ“ä½œå½ˆçª—ï¼Œè«‹å®Œæ•´é»è²¼ â–¼â–¼â–¼ -->

<!-- 1. å®ˆè¡›é¸æ“‡å½ˆçª— -->
<div id="werewolf-guard-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>å®ˆè¡›è«‹é¸æ“‡ä»Šæ™šè¦å®ˆè­·çš„ç©å®¶</span></div>
        <div class="modal-body" id="werewolf-guard-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="save" id="confirm-guard-selection-btn">ç¢ºèªå®ˆè­·</button>
        </div>
    </div>
</div>

<!-- 2. å¥³å·«æ“ä½œå½ˆçª— (è³‡è¨Šæç¤º + æ¯’äººé¸æ“‡) -->
<div id="werewolf-witch-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span id="witch-modal-title">å¥³å·«è«‹çœçœ¼</span></div>
        <div class="modal-body" id="werewolf-witch-selection-list" style="padding: 0;">
            </div>
        <div class="modal-footer">
             <button class="cancel" id="witch-do-nothing-btn">ä»€éº¼éƒ½ä¸åš</button>
             <button class="save btn-danger" id="confirm-witch-poison-btn" style="display: none;">ç¢ºèªç”¨æ¯’</button>
        </div>
    </div>
</div>


<!-- 3. çµäººé–‹æ§å½ˆçª— (ä¹‹å‰ç¼ºå¤±) -->
<div id="werewolf-hunter-modal" class="modal">
     <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>çµäººè«‹é¸æ“‡é–‹æ§ç‰©ä»¶</span></div>
        <div class="modal-body" id="werewolf-hunter-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="save btn-danger" id="confirm-hunter-shot-btn">ç¢ºèªé–‹æ§</button>
        </div>
    </div>
</div>

<!-- 4. æŠ•ç¥¨å½ˆçª— (ä¹‹å‰ç¼ºå¤±) -->
<div id="werewolf-vote-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header"><span>è«‹æŠ•ç¥¨æ”¾é€ä¸€åç©å®¶</span></div>
        <div class="modal-body" id="werewolf-vote-selection-list" style="padding: 0;"></div>
        <div class="modal-footer">
             <button class="save" id="confirm-vote-btn">ç¢ºèªæŠ•ç¥¨</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | å·²æ·»åŠ èº«ä»½å…¬ä½ˆã€‘è«‹ç”¨é€™æ•´å¡Šä»£ç¢¼ï¼Œå®Œæ•´æ›¿æ›èˆŠçš„ werewolf-game-over-modal â–¼â–¼â–¼ -->
<div id="werewolf-game-over-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto; text-align: center; padding: 20px;">
        <h2 id="werewolf-game-over-title">éŠæˆ²çµæŸ</h2>
        <p id="werewolf-game-over-reason" style="font-size: 16px; margin: 20px 0;"></p>
        
        <!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šèº«ä»½å…¬ä½ˆåˆ—è¡¨ã€‘ã€‘ã€‘ -->
        <div id="werewolf-role-reveal-list" style="max-height: 250px; overflow-y: auto; margin: 20px 0; border-top: 1px solid #444; padding-top: 10px;">
            <!-- ç©å®¶èº«ä»½å°‡ç”±JSå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>
        
        <button id="werewolf-game-over-close-btn" class="form-button">è¿”å›å¤§å»³</button>
      <button id="manual-werewolf-summary-btn" class="form-button form-button-secondary" style="margin-top: 10px;">æ‰‹å‹•ç¸½çµè¨˜æ†¶</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–² -->
<div id="reading-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æˆ‘çš„æ›¸åº«</span>
            <div class="header-actions">
                <span class="action-btn" id="import-new-book-btn-header" title="å°å…¥æ–°æ›¸">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </span>
                <span class="action-btn" id="close-reading-library-btn-header" title="é—œé–‰">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
        </div>

        <div id="reading-library-search-container">
            <input type="search" id="reading-library-search-input" placeholder="æœç´¢æ›¸å...">
        </div>

        <div class="modal-body" style="padding: 0; flex-grow: 1; overflow-y: auto;">
            <div id="reading-library-list">
                </div>
        </div>

        </div>
</div>
<div id="product-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†å•†å“åˆ†é¡</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†é¡</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-product-category-name-input" placeholder="è¼¸å…¥åˆ†é¡å..." style="flex-grow: 1;">
                    <button id="add-new-product-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-product-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-product-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<div id="variation-selection-modal" class="modal">
    <div class="modal-content" style="width: 320px; height: auto;">
        <div class="modal-header" style="padding-bottom: 0;">
            </div>
        <div class="modal-body">
            <div id="variation-product-info" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;">
                <img id="variation-product-image" style="width: 80px; height: 80px; border-radius: 6px; object-fit: cover;">
                <div>
                    <p id="variation-product-name" style="font-weight: 500; margin: 0;"></p>
                    <p id="variation-selected-price" style="color: #ff5722; font-weight: bold; font-size: 18px; margin: 8px 0 0;"></p>
                </div>
            </div>
            <div class="form-group">
                <label>é¸æ“‡æ¬¾å¼</label>
                <div id="variation-options-container" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    </div>
            </div>
            <div class="form-group">
                <label>è³¼è²·æ•¸é‡</label>
                <div class="quantity-control" style="justify-content: flex-start;">
                    <button class="quantity-btn" id="variation-decrease-qty">-</button>
                    <span class="quantity-display" id="variation-quantity-display">1</span>
                    <button class="quantity-btn" id="variation-increase-qty">+</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-variation-selection-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-variation-selection-btn">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
    </div>
</div>
<div id="shopping-settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>è³¼ç‰©ä¸­å¿ƒç”Ÿæˆè¨­ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group douban-settings-item">
                <label for="shopping-category-count-input">
                    ç”Ÿæˆåˆ†é¡æ•¸é‡
                    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                        è¨­ç½®AIä¸€æ¬¡æ€§ç”Ÿæˆå¤šå°‘å€‹å•†å“åˆ†é¡ã€‚
                    </p>
                </label>
                <div class="douban-settings-controls">
                    <input type="number" id="shopping-category-count-input" min="1" max="10" value="3">
                    <span>å€‹</span>
                </div>
            </div>
            <div class="form-group douban-settings-item">
                <label for="shopping-product-count-input">
                    æ¯å€‹åˆ†é¡å•†å“æ•¸é‡
                    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                        è¨­ç½®æ¯å€‹åˆ†é¡ä¸‹ç”Ÿæˆå¤šå°‘å€‹å•†å“ã€‚
                    </p>
                </label>
                <div class="douban-settings-controls">
                    <input type="number" id="shopping-product-count-input" min="2" max="10" value="8">
                    <span>å€‹</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-shopping-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-shopping-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€™æ˜¯ç”¨æ–¼iOSå¾Œè‡ºä¿æ´»çš„éœéŸ³æ’­æ”¾æ©Ÿï¼Œè«‹é»è²¼åˆ° body æœ«å°¾ â–¼â–¼â–¼ -->
<audio id="silent-audio-player" loop preload="auto" style="display:none;">
    <source src="https://phoebeboo.github.io/mewoooo/1-second-of-silence.mp3" type="audio/mpeg">
</audio>
<!-- â–²â–²â–² æ–°å¢ä»£ç¢¼é»è²¼çµæŸ â–²â–²â–² -->
<audio id="tts-audio-player" style="display:none;"></audio>
</body>
</html>

